/**
 * @license
 * PlayCanvas Engine v1.54.0 revision 8577cfea7
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
function t(t,e,s){t.prototype[e]||Object.defineProperty(t.prototype,e,{value:s,configurable:!0,enumerable:!1,writable:!0})}t(Array,"fill",(function(t){if(null==this)throw new TypeError("this is null or not defined");for(var e=Object(this),s=e.length>>>0,i=arguments[1],n=i>>0,a=n<0?Math.max(s+n,0):Math.min(n,s),r=arguments[2],o=void 0===r?s:r>>0,h=o<0?Math.max(s+o,0):Math.min(o,s);a<h;)e[a]=t,a++;return e})),t(Array,"find",(function(t){if(null==this)throw TypeError('"this" is null or not defined');var e=Object(this),s=e.length>>>0;if("function"!=typeof t)throw TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=e[n];if(t.call(i,a,n,e))return a;n++}})),t(Array,"findIndex",(function(t){if(null==this)throw new TypeError('"this" is null or not defined');var e=Object(this),s=e.length>>>0;if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=e[n];if(t.call(i,a,n,e))return n;n++}return-1})),Math.log2=Math.log2||function(t){return Math.log(t)*Math.LOG2E},Math.sign||(Math.sign=function(t){return(t>0)-(t<0)||+t}),void 0===Number.isFinite&&(Number.isFinite=function(t){return"number"==typeof t&&isFinite(t)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var s=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(s[a]=n[a])}return s},writable:!0,configurable:!0}),function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var t=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(t)},e=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(t)};document.addEventListener("webkitpointerlockchange",t,!1),document.addEventListener("webkitpointerlocklost",t,!1),document.addEventListener("mozpointerlockchange",t,!1),document.addEventListener("mozpointerlocklost",t,!1),document.addEventListener("webkitpointerlockerror",e,!1),document.addEventListener("mozpointerlockerror",e,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,t,e)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){if("undefined"!=typeof window){for(var t=0,e=["ms","moz","webkit","o"],s=0;s<e.length&&!window.requestAnimationFrame;++s)window.requestAnimationFrame=window[e[s]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[s]+"CancelAnimationFrame"]||window[e[s]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,s){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),a=window.setTimeout((function(){e(i+n)}),n);return t=i+n,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}}(),t(String,"endsWith",(function(t,e){return(void 0===e||e>this.length)&&(e=this.length),this.substring(e-t.length,e)===t})),t(String,"includes",(function(t,e){return"number"!=typeof e&&(e=0),!(e+t.length>this.length)&&-1!==this.indexOf(t,e)})),t(String,"startsWith",(function(t,e){var s=e>0?0|e:0;return this.substring(s,s+t.length)===t})),t(String,"trimEnd",(function(){return this.replace(new RegExp(/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+/.source+"$","g"),"")}));const e=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array];for(const s of e)t(s,"fill",Array.prototype.fill),t(s,"join",Array.prototype.join);var s={};function i(t,e){var i;s[t]=!0,void 0!==e&&(i=e,window.console&&window.console.error&&window.console.error(i))}var n=function t(e){var s=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var n=new t.VertexAttrib(s);this.attribs[i]=n}this.maxAttrib=0};(n.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=t.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function(t){var e=this;this.gl=t,function(t){var e=t.getError;t.getError=function(){do{(i=e.apply(t))!=t.NO_ERROR&&(s[i]=!0)}while(i!=t.NO_ERROR);for(var i in s)if(s[i])return delete s[i],parseInt(i);return t.NO_ERROR}}(t);var i=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(t){return t==e.VERTEX_ARRAY_BINDING_OES?e.currentVertexArrayObject==e.defaultVertexArrayObject?null:e.currentVertexArrayObject:i.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(t){var s=e.currentVertexArrayObject;s.maxAttrib=Math.max(s.maxAttrib,t);var n=s.attribs[t];return n.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(t){var s=e.currentVertexArrayObject;s.maxAttrib=Math.max(s.maxAttrib,t);var n=s.attribs[t];return n.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(s,n){switch(s){case t.ARRAY_BUFFER:e.currentArrayBuffer=n;break;case t.ELEMENT_ARRAY_BUFFER:e.currentVertexArrayObject.elementArrayBuffer=n}return i.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(s,n){var a=e.currentVertexArrayObject,r=a.attribs[s];switch(n){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return r.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return r.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return r.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return r.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return r.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return r.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(t,s,n,a,r,o){var h=e.currentVertexArrayObject;h.maxAttrib=Math.max(h.maxAttrib,t);var l=h.attribs[t];return l.buffer=e.currentArrayBuffer,l.size=s,l.type=n,l.normalized=a,l.stride=r,l.offset=o,l.recache(),i.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var t;t="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(t),e.reset_()}),!0),this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229,a.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;var e=this.gl;this.maxVertexAttribs=e.getParameter(e.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new n(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},a.prototype.createVertexArrayOES=function(){var t=new n(this);return this.vertexArrayObjects.push(t),t},a.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject==t&&this.bindVertexArrayOES(null)},a.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof n&&t.hasBeenBound&&t.ext==this)},a.prototype.bindVertexArrayOES=function(t){var e=this.gl;if(!t||t.isAlive){var s=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var a=this.currentVertexArrayObject;if(n!=a){n&&a.elementArrayBuffer==n.elementArrayBuffer||s.bindBuffer.call(e,e.ELEMENT_ARRAY_BUFFER,a.elementArrayBuffer);for(var r=this.currentArrayBuffer,o=Math.max(n?n.maxAttrib:0,a.maxAttrib),h=0;h<=o;h++){var l=a.attribs[h],c=n?n.attribs[h]:null;if(n&&l.enabled==c.enabled||(l.enabled?s.enableVertexAttribArray.call(e,h):s.disableVertexAttribArray.call(e,h)),l.enabled){var d=!1;n&&l.buffer==c.buffer||(r!=l.buffer&&(s.bindBuffer.call(e,e.ARRAY_BUFFER,l.buffer),r=l.buffer),d=!0),(d||l.cached!=c.cached)&&s.vertexAttribPointer.call(e,h,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!=r&&s.bindBuffer.call(e,e.ARRAY_BUFFER,this.currentArrayBuffer)}}else i(e.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")};const r="1.54.0",o="8577cfea7",h={},l={},c={},d={},u=function(){const t={},e=["Array","Object","Function","Date","RegExp","Float32Array"];for(let s=0;s<e.length;s++)t["[object "+e[s]+"]"]=e[s].toLowerCase();return t}();function p(t){if(null===t)return"null";const e=typeof t;return"undefined"===e||"number"===e||"string"===e||"boolean"===e?e:u[Object.prototype.toString.call(t)]}function m(t,e){for(const s in e){const i=e[s];"object"===p(i)?t[s]=m({},i):"array"===p(i)?t[s]=m([],i):t[s]=i}return t}function f(t){return undefined!==t}class _{constructor(){this._callbacks={},this._callbackActive={}}initEventHandler(){this._callbacks={},this._callbackActive={}}_addCallback(t,e,s,i=!1){t&&"string"==typeof t&&e&&(this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:s||this,once:i}))}on(t,e,s){return this._addCallback(t,e,s,!1),this}off(t,e,s){if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(const t in this._callbackActive)this._callbacks[t]&&this._callbacks[t]===this._callbackActive[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());if(t)if(e){const i=this._callbacks[t];if(!i)return this;let n=i.length;for(let t=0;t<n;t++)i[t].callback===e&&(s&&i[t].scope!==s||(i[t--]=i[--n]));i.length=n}else this._callbacks[t]&&(this._callbacks[t]=[]);else this._callbacks={};return this}fire(t,e,s,i,n,a,r,o,h){if(!t||!this._callbacks[t])return this;let l;this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),l=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(let c=0;(l||this._callbackActive[t])&&c<(l||this._callbackActive[t]).length;c++){const d=(l||this._callbackActive[t])[c];if(d.callback.call(d.scope,e,s,i,n,a,r,o,h),d.once){const e=this._callbacks[t],s=e?e.indexOf(d):-1;-1!==s&&(this._callbackActive[t]===e&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(s,1))}}return l||(this._callbackActive[t]=null),this}once(t,e,s){return this._addCallback(t,e,s,!0),this}hasEvent(t){return this._callbacks[t]&&0!==this._callbacks[t].length||!1}}const g={attach:function(t){const e=g;return t._addCallback=e._addCallback,t.on=e.on,t.off=e.off,t.fire=e.fire,t.once=e.once,t.hasEvent=e.hasEvent,t._callbacks={},t._callbackActive={},t},_addCallback:_.prototype._addCallback,on:_.prototype.on,off:_.prototype.off,fire:_.prototype.fire,once:_.prototype.once,hasEvent:_.prototype.hasEvent},y={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}},v={delimiter:"/",join:function(){const t=arguments.length;let e=arguments[0];for(let s=0;s<t-1;++s){const t=arguments[s],i=arguments[s+1];if(!f(t)||!f(i))throw new Error("undefined argument to pc.path.join");i[0]!==v.delimiter?t&&i&&t[t.length-1]!==v.delimiter&&i[0]!==v.delimiter?e+=v.delimiter+i:e+=i:e=i}return e},normalize:function(t){const e=t.startsWith(v.delimiter),s=t.endsWith(v.delimiter),i=t.split("/");let n="",a=[];for(let t=0;t<i.length;t++)""!==i[t]&&"."!==i[t]&&(".."===i[t]&&a.length>0?a=a.slice(0,a.length-2):(t>0&&a.push(v.delimiter),a.push(i[t])));return n=a.join(""),e||n[0]!==v.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==v.delimiter&&(n+=v.delimiter),n},split:function(t){const e=t.split(v.delimiter),s=e.slice(e.length-1)[0];return[e.slice(0,e.length-1).join(v.delimiter),s]},getBasename:function(t){return v.split(t)[1]},getDirectory:function(t){const e=t.split(v.delimiter);return e.slice(0,e.length-1).join(v.delimiter)},getExtension:function(t){const e=t.split("?")[0].split(".").pop();return e!==t?"."+e:""},isRelativePath:function(t){return"/"!==t.charAt(0)&&null===t.match(/:\/\//)},extractPath:function(t){let e="";const s=t.split("/");let i=0;if(s.length>1)if(v.isRelativePath(t))if("."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else for(e=".",i=0;i<s.length-1;++i)e+="/"+s[i];else for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];return e}};let x=!1,b=!1,S=!1,w=!1,T=!1,M=!1,C=!1,A=!1,P=!1,E=!1;if("undefined"!=typeof navigator){const t=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(t)&&(x=!0),/xbox/i.test(t)&&(w=!0),/(windows phone|iemobile|wpdesktop)/i.test(t)?(x=!1,b=!0,S=!0):/android/i.test(t)?(x=!1,b=!0,T=!0):/ip([ao]d|hone)/i.test(t)&&(x=!1,b=!0,M=!0),"undefined"!=typeof window&&(C="ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),A="getGamepads"in navigator,P="undefined"!=typeof Worker;try{const t=Object.defineProperty({},"passive",{get:function(){return E=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t)}catch(t){}}const R="undefined"!=typeof window?"browser":"node",L={environment:R,global:"browser"===R?window:global,browser:"browser"===R,desktop:x,mobile:b,ios:M,android:T,windows:S,xbox:w,gamepads:A,touch:C,workers:P,passiveEvents:E};function I(t,e=0){const s=t.length;if(e<0||e>=s)return null;const i=t.charCodeAt(e);if(s>1&&i>=55296&&i<=56319){const s=t.charCodeAt(e+1);if(s>=56320&&s<=57343)return{code:1024*(i-55296)+s-56320+65536,long:!0}}return{code:i,long:!1}}function D(t,e,s){if(!t)return!1;const i=I(t);if(i){const t=i.code;return t>=e&&t<=s}return!1}function O(t,e){if(e===t.length-1)return 1;if(D(t[e],55296,56319)){const s=t.substring(e,e+2),i=t.substring(e+2,e+4);return D(i,127995,127999)||D(s,127462,127487)&&D(i,127462,127487)?4:D(i,65024,65039)?3:2}return D(t[e+1],65024,65039)?2:1}const F={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(t){for(let e=1;e<arguments.length;e++)t=t.replace("{"+(e-1)+"}",arguments[e]);return t},toBool:function(t,e=!1){if("true"===t)return!0;if(e){if("false"===t)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(t,e){const s=I(t,e);return s&&s.code},getCodePoints:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const s=[];let i;for(;i=I(t,e);)s.push(i.code),e+=i.long?2:1;return s},getSymbols:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const s=t.length,i=[];let n,a=0;for(;e<s;){if(a+=O(t,e+a),n=t[e+a],D(n,8400,8447)&&(n=t[e+a++]),D(n,65024,65039)&&(n=t[e+a++]),n&&8205===n.charCodeAt(0)){n=t[e+a++];continue}const s=t.substring(e,e+a);i.push(s),e+=a,a=0}return i},fromCodePoint:function(){const t=[];let e,s,i;for(let n=0;n<arguments.length;++n)e=Number(arguments[n]),s=e-65536,i=e>65535?[55296+(s>>10),s%1024+56320]:[e],t.push(String.fromCharCode.apply(null,i));return t.join("")}};class k{constructor(){this._list=[],this._index={}}push(t,e){if(this._index[t])throw Error("Key already in index "+t);const s=this._list.push(e)-1;this._index[t]=s}has(t){return void 0!==this._index[t]}get(t){const e=this._index[t];return void 0!==e?this._list[e]:null}remove(t){const e=this._index[t];if(void 0!==e){for(t in this._list.splice(e,1),delete this._index[t],this._index){const s=this._index[t];s>e&&(this._index[t]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const t in this._index)delete this._index[t]}}class B{constructor(t){this.arraybuffer=t,this.dataView=new DataView(t),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(t=0){this.offset=t}skip(t){this.offset+=t}align(t){this.offset=this.offset+t-1&~(t-1)}_inc(t){return this.offset+=t,this.offset-t}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(t){let e="";for(let s=0;s<t;++s)e+=this.readChar();return e}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(t){for(let e=0;e<t.length;++e)t[e]=this.readU8()}readLine(){const t=this.dataView;let e="";for(;!(this.offset>=t.byteLength);){const t=String.fromCharCode(this.readU8());if("\n"===t)break;e+=t}return e}}class z{constructor(t){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=t.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(t){let e=0,s=this.items.length-1;const i=t[this._sortBy];let n,a;for(;e<=s;)n=Math.floor((e+s)/2),a=this.items[n][this._sortBy],a<=i?e=n+1:a>i&&(s=n-1);return e}_doSort(t,e){const s=this._sortBy;return t[s]-e[s]}insert(t){const e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++}append(t){this.items.push(t),this.length++}remove(t){const e=this.items.indexOf(t);e<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)}sort(){const t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==t&&(this.loopIndex=this.items.indexOf(t))}}class U extends _{constructor(t){super(),this._index={},this._list=[],this._parent=t}add(){let t=!1;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]||(t=!0,this._index[e[s]]=!0,this._list.push(e[s]),this.fire("add",e[s],this._parent));return t&&this.fire("change",this._parent),t}remove(){let t=!1;if(!this._list.length)return t;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]&&(t=!0,delete this._index[e[s]],this._list.splice(this._list.indexOf(e[s]),1),this.fire("remove",e[s],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;const t=this._list.slice(0);this._list=[],this._index={};for(let e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}has(){return!!this._list.length&&this._has(this._processArguments(arguments))}_has(t){if(!this._list.length||!t.length)return!1;for(let e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{let s=!0;for(let i=0;i<t[e].length;i++)if(!this._index[t[e][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(t,e){const s=[];let i=[];if(!t||!t.length)return s;for(let n=0;n<t.length;n++)if(t[n]instanceof Array){e||(i=[]);for(let a=0;a<t[n].length;a++)"string"==typeof t[n][a]&&(e?s.push(t[n][a]):i.push(t[n][a]));!e&&i.length&&s.push(i)}else"string"==typeof t[n]&&(e?s.push(t[n]):s.push([t[n]]));return s}get size(){return this._list.length}}const V="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?performance.now.bind(performance):Date.now;class N{constructor(){this._isRunning=!1,this._a=0,this._b=0}start(){this._isRunning=!0,this._a=V()}stop(){this._isRunning=!1,this._b=V()}getMilliseconds(){return this._b-this._a}}function W(t){let e="";if((t.authority||t.scheme)&&(t.host||t.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(t.host&&t.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(t.path&&t.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");return t.scheme&&(e+=t.scheme+":"),t.authority&&(e+="//"+t.authority),t.host&&(e+=t.host),t.path&&(e+=t.path),t.hostpath&&(e+=t.hostpath),t.query&&(e+="?"+t.query),t.fragment&&(e+="#"+t.fragment),e}const G=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class H{constructor(t){const e=t.match(G);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9]}toString(){let t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t}getQuery(){const t={};if(this.query){const e=decodeURIComponent(this.query).split("&");for(const s of e){const e=s.split("=");t[e[0]]=e[1]}}return t}setQuery(t){let e="";for(const s in t)t.hasOwnProperty(s)&&(""!==e&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));this.query=e}}class X{static setTrace(t,e=!0){}static deprecated(t){X._loggedMessages.has(t)||(X._loggedMessages.add(t),console.warn("DEPRECATED: "+t))}static assert(t,...e){t||console.error("ASSERT FAILED: ",...e)}static log(...t){console.log(...t)}static logOnce(t){X._loggedMessages.has(t)||(X._loggedMessages.add(t),console.log(t))}static warn(...t){console.warn(...t)}static warnOnce(t){X._loggedMessages.has(t)||(X._loggedMessages.add(t),console.warn(t))}static error(...t){console.error(...t)}static errorOnce(t){X._loggedMessages.has(t)||(X._loggedMessages.add(t),console.error(t))}static trace(t,...e){X._traceChannels.has(t)&&console.log(`[${t}] `,...e)}}X._loggedMessages=new Set,X._traceChannels=new Set;const q={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(t,e,s){return t>=s?s:t<=e?e:t},intToBytes24:function(t){return[t>>16&255,t>>8&255,255&t]},intToBytes32:function(t){return[t>>24&255,t>>16&255,t>>8&255,255&t]},bytesToInt24:function(t,e,s){return t.length&&(s=t[2],e=t[1],t=t[0]),t<<16|e<<8|s},bytesToInt32:function(t,e,s,i){return t.length&&(i=t[3],s=t[2],e=t[1],t=t[0]),(t<<24|e<<16|s<<8|i)>>>0},lerp:function(t,e,s){return t+(e-t)*q.clamp(s,0,1)},lerpAngle:function(t,e,s){return e-t>180&&(e-=360),e-t<-180&&(e+=360),q.lerp(t,e,q.clamp(s,0,1))},powerOfTwo:function(t){return 0!==t&&!(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},random:function(t,e){const s=e-t;return Math.random()*s+t},smoothstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*(3-2*s)},smootherstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*s*(s*(6*s-15)+10)},roundUp:function(t,e){return 0===e?t:Math.ceil(t/e)*e},between:function(t,e,s,i){const n=Math.min(e,s),a=Math.max(e,s);return i?t>=n&&t<=a:t>n&&t<a}};class j{get(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("GET",t,e,s)}post(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("POST",t,s,i)}put(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("PUT",t,s,i)}del(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("DELETE",t,e,s)}request(t,e,s,i){let n,a,r,o=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)r=s.postdata;else if(s.postdata instanceof FormData)r=s.postdata;else if(s.postdata instanceof Object){let t=s.headers["Content-Type"];switch(void 0===t&&(s.headers["Content-Type"]=j.ContentType.FORM_URLENCODED,t=s.headers["Content-Type"]),t){case j.ContentType.FORM_URLENCODED:{r="";let t=!0;for(const e in s.postdata)if(s.postdata.hasOwnProperty(e)){t?t=!1:r+="&";r+=`${encodeURIComponent(e)}=${encodeURIComponent(s.postdata[e])}`}break}default:case j.ContentType.JSON:null==t&&(s.headers["Content-Type"]=j.ContentType.JSON),r=JSON.stringify(s.postdata)}}else r=s.postdata;if(!1===s.cache){const t=V();n=new H(e),n.query?n.query=n.query+"&ts="+t:n.query="ts="+t,e=n.toString()}s.query&&(n=new H(e),a=m(n.getQuery(),s.query),n.setQuery(a),e=n.toString());const h=new XMLHttpRequest;h.open(t,e,s.async),h.withCredentials=void 0!==s.withCredentials&&s.withCredentials,h.responseType=s.responseType||this._guessResponseType(e);for(const t in s.headers)s.headers.hasOwnProperty(t)&&h.setRequestHeader(t,s.headers[t]);h.onreadystatechange=()=>{this._onReadyStateChange(t,e,s,h)},h.onerror=()=>{this._onError(t,e,s,h),o=!0};try{h.send(r)}catch(t){o||s.error(h.status,h,t)}return h}_guessResponseType(t){const e=new H(t),s=v.getExtension(e.path);return j.binaryExtensions.indexOf(s)>=0?j.ResponseType.ARRAY_BUFFER:".xml"===s?j.ResponseType.DOCUMENT:j.ResponseType.TEXT}_isBinaryContentType(t){return[j.ContentType.MP4,j.ContentType.WAV,j.ContentType.OGG,j.ContentType.MP3,j.ContentType.BIN,j.ContentType.DDS,j.ContentType.BASIS,j.ContentType.GLB,j.ContentType.OPUS].indexOf(t)>=0}_onReadyStateChange(t,e,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(t,e,s,i):this._onError(t,e,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,s,i);break;default:this._onError(t,e,s,i)}}_onSuccess(t,e,s,i){let n,a;const r=i.getResponseHeader("Content-Type");if(r){a=r.split(";")[0].trim()}try{n=a===j.ContentType.JSON||e.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):this._isBinaryContentType(a)||i.responseType===j.ResponseType.ARRAY_BUFFER||i.responseType===j.ResponseType.BLOB||i.responseType===j.ResponseType.JSON?i.response:i.responseType===j.ResponseType.DOCUMENT||a===j.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(t){s.callback(t)}}_onError(t,e,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=q.clamp(Math.pow(2,s.retries)*j.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${t}: ${e} - Error ${i.status}. Retrying in ${n} ms`),setTimeout((()=>{s.retrying=!1,this.request(t,e,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}j.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary",OPUS:'audio/ogg; codecs="opus"'},j.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},j.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],j.retryDelay=100;const Y=new j,K=0,$=1,Z=2,Q=3,J=4,tt=5;class et{constructor(t=0,e=0,s=0,i=1){const n=t.length;3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=void 0!==t[3]?t[3]:1):(this.r=t,this.g=e,this.b=s,this.a=i)}clone(){return new et(this.r,this.g,this.b,this.a)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}set(t,e,s,i=1){return this.r=t,this.g=e,this.b=s,this.a=i,this}lerp(t,e,s){return this.r=t.r+s*(e.r-t.r),this.g=t.g+s*(e.g-t.g),this.b=t.b+s*(e.b-t.b),this.a=t.a+s*(e.a-t.a),this}fromString(t){const e=parseInt(t.replace("#","0x"),16);let s;return t.length>7?s=q.intToBytes32(e):(s=q.intToBytes24(e),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(t){let e="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===t){const t=Math.round(255*this.a).toString(16);this.a<16/255?e+="0"+t:e+=t}return e}}et.BLACK=Object.freeze(new et(0,0,0,1)),et.BLUE=Object.freeze(new et(0,0,1,1)),et.CYAN=Object.freeze(new et(0,1,1,1)),et.GRAY=Object.freeze(new et(.5,.5,.5,1)),et.GREEN=Object.freeze(new et(0,1,0,1)),et.MAGENTA=Object.freeze(new et(1,0,1,1)),et.RED=Object.freeze(new et(1,0,0,1)),et.WHITE=Object.freeze(new et(1,1,1,1)),et.YELLOW=Object.freeze(new et(1,1,0,1));class st{constructor(t,e=0){this._curve=t,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._reset(e)}evaluate(t,e=!1){let s;(e||t<this._left||t>=this._right)&&this._reset(t);const i=this._curve.type;if(5===i)s=this._p0;else{const e=0===this._recip?0:(t-this._left)*this._recip;s=0===i?q.lerp(this._p0,this._p1,e):1===i?q.lerp(this._p0,this._p1,e*e*(3-2*e)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,e)}return s}_reset(t){const e=this._curve.keys,s=e.length;if(s)if(t<e[0][0])this._left=-1/0,this._right=e[0][0],this._recip=0,this._p0=this._p1=e[0][1],this._m0=this._m1=0;else if(t>=e[s-1][0])this._left=e[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=e[s-1][1],this._m0=this._m1=0;else{let s=0;for(;t>=e[s+1][0];)s++;this._left=e[s][0],this._right=e[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=e[s][1],this._p1=e[s+1][1],this._isHermite()&&this._calcTangents(e,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_isHermite(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type}_calcTangents(t,e){let s;const i=t[e],n=t[e+1];let a;if(s=0===e?[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])]:t[e-1],a=e===t.length-2?[t[e+1][0]+(t[e+1][0]-t[e][0]),t[e+1][1]+(t[e+1][1]-t[e][1])]:t[e+2],4===this._curve.type){const t=2*(n[0]-i[0])/(n[0]-s[0]),e=2*(n[0]-i[0])/(a[0]-i[0]);this._m0=this._curve.tension*(isFinite(t)?t:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(e)?e:0)*(a[1]-i[1])}else{const t=(n[0]-i[0])/(i[0]-s[0]),e=(n[0]-i[0])/(a[0]-n[0]),r=i[1]+(s[1]-i[1])*(isFinite(t)?t:0),o=n[1]+(a[1]-n[1])*(isFinite(e)?e:0),h=2===this._curve.type?.5:this._curve.tension;this._m0=h*(n[1]-r),this._m1=h*(o-i[1])}}_evaluateHermite(t,e,s,i,n){const a=n*n,r=n+n,o=1-n,h=o*o;return t*((1+r)*h)+s*(n*h)+e*(a*(3-r))+i*(a*(n-1))}}class it{constructor(t){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new st(this),t)for(let e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}get length(){return this.keys.length}add(t,e){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>t);n++);const a=[t,e];return this.keys.splice(n,0,a),a}get(t){return this.keys[t]}sort(){this.keys.sort((function(t,e){return t[0]-e[0]}))}value(t){return this._eval.evaluate(t,!0)}closest(t){const e=this.keys,s=e.length;let i=2,n=null;for(let a=0;a<s;a++){const s=Math.abs(t-e[a][0]);if(!(i>=s))break;i=s,n=e[a]}return n}clone(){const t=new it;return t.keys=m(t.keys,this.keys),t.type=this.type,t.tension=this.tension,t}quantize(t){t=Math.max(t,2);const e=new Float32Array(t),s=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(let i=1;i<t;i++)e[i]=this._eval.evaluate(s*i);return e}quantizeClamped(t,e,s){const i=this.quantize(t);for(let t=0;t<i.length;++t)i[t]=Math.min(s,Math.max(e,i[t]));return i}}class nt{constructor(){if(this.curves=[],this._type=1,arguments.length>1)for(let t=0;t<arguments.length;t++)this.curves.push(new it(arguments[t]));else if(0===arguments.length)this.curves.push(new it);else{const t=arguments[0];if("number"==typeof t)for(let e=0;e<t;e++)this.curves.push(new it);else for(let e=0;e<t.length;e++)this.curves.push(new it(t[e]))}}get length(){return this.curves.length}set type(t){this._type=t;for(let e=0;e<this.curves.length;e++)this.curves[e].type=t}get type(){return this._type}get(t){return this.curves[t]}value(t,e=[]){const s=this.curves.length;e.length=s;for(let i=0;i<s;i++)e[i]=this.curves[i].value(t);return e}clone(){const t=new nt;t.curves=[];for(let e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t}quantize(t){t=Math.max(t,2);const e=this.curves.length,s=new Float32Array(t*e),i=1/(t-1);for(let n=0;n<e;n++){const a=new st(this.curves[n]);for(let r=0;r<t;r++)s[r*e+n]=a.evaluate(i*r)}return s}quantizeClamped(t,e,s){const i=this.quantize(t);for(let t=0;t<i.length;++t)i[t]=Math.min(s,Math.max(e,i[t]));return i}}class at{constructor(t=0,e=0,s=0){3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=s)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}clone(){return new at(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}cross(t,e){const s=t.x,i=t.y,n=t.z,a=e.x,r=e.y,o=e.z;return this.x=i*o-r*n,this.y=n*a-o*s,this.z=s*r-a*i,this}distance(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+s*s+i*i)}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this}project(t){const e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}at.ZERO=Object.freeze(new at(0,0,0)),at.ONE=Object.freeze(new at(1,1,1)),at.UP=Object.freeze(new at(0,1,0)),at.DOWN=Object.freeze(new at(0,-1,0)),at.RIGHT=Object.freeze(new at(1,0,0)),at.LEFT=Object.freeze(new at(-1,0,0)),at.FORWARD=Object.freeze(new at(0,0,-1)),at.BACK=Object.freeze(new at(0,0,1));class rt{constructor(){const t=new Float32Array(9);t[0]=t[4]=t[8]=1,this.data=t}clone(){return(new rt).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(){const t=this.data;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}setFromMat4(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],this}transformVector(t,e=new at){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[3]+a*s[6],e.y=i*s[1]+n*s[4]+a*s[7],e.z=i*s[2]+n*s[5]+a*s[8],e}}rt.IDENTITY=Object.freeze(new rt),rt.ZERO=Object.freeze((new rt).set([0,0,0,0,0,0,0,0,0]));class ot{constructor(t=0,e=0){2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t,this.y=e)}add(t){return this.x+=t.x,this.y+=t.y,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScalar(t){return this.x+=t,this.y+=t,this}clone(){return new ot(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}cross(t){return this.x*t.y-this.y*t.x}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}div(t){return this.x/=t.x,this.y/=t.y,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}divScalar(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this}mul(t){return this.x*=t.x,this.y*=t.y,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}normalize(){const t=this.x*this.x+this.y*this.y;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),this}set(t,e){return this.x=t,this.y=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}subScalar(t){return this.x-=t,this.y-=t,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}}ot.ZERO=Object.freeze(new ot(0,0)),ot.ONE=Object.freeze(new ot(1,1)),ot.UP=Object.freeze(new ot(0,1)),ot.DOWN=Object.freeze(new ot(0,-1)),ot.RIGHT=Object.freeze(new ot(1,0)),ot.LEFT=Object.freeze(new ot(-1,0));class ht{constructor(t=0,e=0,s=0,i=0){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}clone(){return new ht(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this.w=t.w/e.w,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this.w=t.w+s*(e.w-t.w),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e,this.w*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}ht.ZERO=Object.freeze(new ht(0,0,0,0)),ht.ONE=Object.freeze(new ht(1,1,1,1));const lt=new ot,ct=new at,dt=new at,ut=new at,pt=new at;class mt{constructor(){const t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t}static _getPerspectiveHalfSize(t,e,s,i,n){n?(t.x=i*Math.tan(e*Math.PI/360),t.y=t.x/s):(t.y=i*Math.tan(e*Math.PI/360),t.x=t.y*s)}add2(t,e){const s=t.data,i=e.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(t){return this.add2(this,t)}clone(){return(new mt).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]}mul2(t,e){const s=t.data,i=e.data,n=this.data,a=s[0],r=s[1],o=s[2],h=s[3],l=s[4],c=s[5],d=s[6],u=s[7],p=s[8],m=s[9],f=s[10],_=s[11],g=s[12],y=s[13],v=s[14],x=s[15];let b,S,w,T;return b=i[0],S=i[1],w=i[2],T=i[3],n[0]=a*b+l*S+p*w+g*T,n[1]=r*b+c*S+m*w+y*T,n[2]=o*b+d*S+f*w+v*T,n[3]=h*b+u*S+_*w+x*T,b=i[4],S=i[5],w=i[6],T=i[7],n[4]=a*b+l*S+p*w+g*T,n[5]=r*b+c*S+m*w+y*T,n[6]=o*b+d*S+f*w+v*T,n[7]=h*b+u*S+_*w+x*T,b=i[8],S=i[9],w=i[10],T=i[11],n[8]=a*b+l*S+p*w+g*T,n[9]=r*b+c*S+m*w+y*T,n[10]=o*b+d*S+f*w+v*T,n[11]=h*b+u*S+_*w+x*T,b=i[12],S=i[13],w=i[14],T=i[15],n[12]=a*b+l*S+p*w+g*T,n[13]=r*b+c*S+m*w+y*T,n[14]=o*b+d*S+f*w+v*T,n[15]=h*b+u*S+_*w+x*T,this}mulAffine2(t,e){const s=t.data,i=e.data,n=this.data,a=s[0],r=s[1],o=s[2],h=s[4],l=s[5],c=s[6],d=s[8],u=s[9],p=s[10],m=s[12],f=s[13],_=s[14];let g,y,v;return g=i[0],y=i[1],v=i[2],n[0]=a*g+h*y+d*v,n[1]=r*g+l*y+u*v,n[2]=o*g+c*y+p*v,n[3]=0,g=i[4],y=i[5],v=i[6],n[4]=a*g+h*y+d*v,n[5]=r*g+l*y+u*v,n[6]=o*g+c*y+p*v,n[7]=0,g=i[8],y=i[9],v=i[10],n[8]=a*g+h*y+d*v,n[9]=r*g+l*y+u*v,n[10]=o*g+c*y+p*v,n[11]=0,g=i[12],y=i[13],v=i[14],n[12]=a*g+h*y+d*v+m,n[13]=r*g+l*y+u*v+f,n[14]=o*g+c*y+p*v+_,n[15]=1,this}mul(t){return this.mul2(this,t)}transformPoint(t,e=new at){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[4]+a*s[8]+s[12],e.y=i*s[1]+n*s[5]+a*s[9]+s[13],e.z=i*s[2]+n*s[6]+a*s[10]+s[14],e}transformVector(t,e=new at){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[4]+a*s[8],e.y=i*s[1]+n*s[5]+a*s[9],e.z=i*s[2]+n*s[6]+a*s[10],e}transformVec4(t,e=new ht){const s=this.data,i=t.x,n=t.y,a=t.z,r=t.w;return e.x=i*s[0]+n*s[4]+a*s[8]+r*s[12],e.y=i*s[1]+n*s[5]+a*s[9]+r*s[13],e.z=i*s[2]+n*s[6]+a*s[10]+r*s[14],e.w=i*s[3]+n*s[7]+a*s[11]+r*s[15],e}setLookAt(t,e,s){ut.sub2(t,e).normalize(),dt.copy(s).normalize(),ct.cross(dt,ut).normalize(),dt.cross(ut,ct);const i=this.data;return i[0]=ct.x,i[1]=ct.y,i[2]=ct.z,i[3]=0,i[4]=dt.x,i[5]=dt.y,i[6]=dt.z,i[7]=0,i[8]=ut.x,i[9]=ut.y,i[10]=ut.z,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}setFrustum(t,e,s,i,n,a){const r=2*n,o=e-t,h=i-s,l=a-n,c=this.data;return c[0]=r/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=r/h,c[6]=0,c[7]=0,c[8]=(e+t)/o,c[9]=(i+s)/h,c[10]=(-a-n)/l,c[11]=-1,c[12]=0,c[13]=0,c[14]=-r*a/l,c[15]=0,this}setPerspective(t,e,s,i,n){return mt._getPerspectiveHalfSize(lt,t,e,s,n),this.setFrustum(-lt.x,lt.x,-lt.y,lt.y,s,i)}setOrtho(t,e,s,i,n,a){const r=this.data;return r[0]=2/(e-t),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(i-s),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(a-n),r[11]=0,r[12]=-(e+t)/(e-t),r[13]=-(i+s)/(i-s),r[14]=-(a+n)/(a-n),r[15]=1,this}setFromAxisAngle(t,e){e*=q.DEG_TO_RAD;const s=t.x,i=t.y,n=t.z,a=Math.cos(e),r=Math.sin(e),o=1-a,h=o*s,l=o*i,c=this.data;return c[0]=h*s+a,c[1]=h*i+r*n,c[2]=h*n-r*i,c[3]=0,c[4]=h*i-r*n,c[5]=l*i+a,c[6]=l*n+r*s,c[7]=0,c[8]=h*n+r*i,c[9]=l*n-s*r,c[10]=o*n*n+a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(t,e,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,this}setScale(t,e,s){const i=this.data;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(t,e,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=t+.5*s,n[13]=e+.5*i,n[14]=.5,n[15]=1,this}invert(){const t=this.data,e=t[0],s=t[1],i=t[2],n=t[3],a=t[4],r=t[5],o=t[6],h=t[7],l=t[8],c=t[9],d=t[10],u=t[11],p=t[12],m=t[13],f=t[14],_=t[15],g=e*r-s*a,y=e*o-i*a,v=e*h-n*a,x=s*o-i*r,b=s*h-n*r,S=i*h-n*o,w=l*m-c*p,T=l*f-d*p,M=l*_-u*p,C=c*f-d*m,A=c*_-u*m,P=d*_-u*f,E=g*P-y*A+v*C+x*M-b*T+S*w;if(0===E)this.setIdentity();else{const R=1/E;t[0]=(r*P-o*A+h*C)*R,t[1]=(-s*P+i*A-n*C)*R,t[2]=(m*S-f*b+_*x)*R,t[3]=(-c*S+d*b-u*x)*R,t[4]=(-a*P+o*M-h*T)*R,t[5]=(e*P-i*M+n*T)*R,t[6]=(-p*S+f*v-_*y)*R,t[7]=(l*S-d*v+u*y)*R,t[8]=(a*A-r*M+h*w)*R,t[9]=(-e*A+s*M-n*w)*R,t[10]=(p*b-m*v+_*g)*R,t[11]=(-l*b+c*v-u*g)*R,t[12]=(-a*C+r*T-o*w)*R,t[13]=(e*C-s*T+i*w)*R,t[14]=(-p*x+m*y-f*g)*R,t[15]=(l*x-c*y+d*g)*R}return this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}setTRS(t,e,s){const i=e.x,n=e.y,a=e.z,r=e.w,o=s.x,h=s.y,l=s.z,c=i+i,d=n+n,u=a+a,p=i*c,m=i*d,f=i*u,_=n*d,g=n*u,y=a*u,v=r*c,x=r*d,b=r*u,S=this.data;return S[0]=(1-(_+y))*o,S[1]=(m+b)*o,S[2]=(f-x)*o,S[3]=0,S[4]=(m-b)*h,S[5]=(1-(p+y))*h,S[6]=(g+v)*h,S[7]=0,S[8]=(f+x)*l,S[9]=(g-v)*l,S[10]=(1-(p+_))*l,S[11]=0,S[12]=t.x,S[13]=t.y,S[14]=t.z,S[15]=1,this}transpose(){let t;const e=this.data;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invertTo3x3(t){const e=this.data,s=t.data,i=e[0],n=e[1],a=e[2],r=e[4],o=e[5],h=e[6],l=e[8],c=e[9],d=e[10],u=d*o-h*c,p=-d*n+a*c,m=h*n-a*o,f=-d*r+h*l,_=d*i-a*l,g=-h*i+a*r,y=c*r-o*l,v=-c*i+n*l,x=o*i-n*r,b=i*u+n*f+a*y;if(0===b)return this;const S=1/b;return s[0]=S*u,s[1]=S*p,s[2]=S*m,s[3]=S*f,s[4]=S*_,s[5]=S*g,s[6]=S*y,s[7]=S*v,s[8]=S*x,this}getTranslation(t=new at){return t.set(this.data[12],this.data[13],this.data[14])}getX(t=new at){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new at){return t.set(this.data[4],this.data[5],this.data[6])}getZ(t=new at){return t.set(this.data[8],this.data[9],this.data[10])}getScale(t=new at){return this.getX(ct),this.getY(dt),this.getZ(ut),t.set(ct.length(),dt.length(),ut.length()),t}setFromEulerAngles(t,e,s){t*=q.DEG_TO_RAD,e*=q.DEG_TO_RAD,s*=q.DEG_TO_RAD;const i=Math.sin(-t),n=Math.cos(-t),a=Math.sin(-e),r=Math.cos(-e),o=Math.sin(-s),h=Math.cos(-s),l=this.data;return l[0]=r*h,l[1]=-r*o,l[2]=a,l[3]=0,l[4]=n*o+h*i*a,l[5]=n*h-i*a*o,l[6]=-r*i,l[7]=0,l[8]=i*o-n*h*a,l[9]=h*i+n*a*o,l[10]=n*r,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,this}getEulerAngles(t=new at){this.getScale(pt);const e=pt.x,s=pt.y,i=pt.z;if(0===e||0===s||0===i)return t.set(0,0,0);const n=this.data,a=Math.asin(-n[2]/e),r=.5*Math.PI;let o,h;return a<r?a>-r?(o=Math.atan2(n[6]/s,n[10]/i),h=Math.atan2(n[1]/e,n[0]/e)):(h=0,o=-Math.atan2(n[4]/s,n[5]/s)):(h=0,o=Math.atan2(n[4]/s,n[5]/s)),t.set(o,a,h).mulScalar(q.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}}mt.IDENTITY=Object.freeze(new mt),mt.ZERO=Object.freeze((new mt).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class ft{constructor(t=0,e=0,s=0,i=1){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}clone(){return new ft(this.x,this.y,this.z,this.w)}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getAxisAngle(t){let e=2*Math.acos(this.w);const s=Math.sin(e/2);return 0!==s?(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*q.RAD_TO_DEG}getEulerAngles(t=new at){let e,s,i;const n=this.x,a=this.y,r=this.z,o=this.w,h=2*(o*a-n*r);return h<=-.99999?(e=2*Math.atan2(n,o),s=-Math.PI/2,i=0):h>=.99999?(e=2*Math.atan2(n,o),s=Math.PI/2,i=0):(e=Math.atan2(2*(o*n+a*r),1-2*(n*n+a*a)),s=Math.asin(h),i=Math.atan2(2*(o*r+n*a),1-2*(a*a+r*r))),t.set(e,s,i).mulScalar(q.RAD_TO_DEG)}invert(){return this.conjugate().normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(t){const e=this.x,s=this.y,i=this.z,n=this.w,a=t.x,r=t.y,o=t.z,h=t.w;return this.x=n*a+e*h+s*o-i*r,this.y=n*r+s*h+i*a-e*o,this.z=n*o+i*h+e*r-s*a,this.w=n*h-e*a-s*r-i*o,this}mul2(t,e){const s=t.x,i=t.y,n=t.z,a=t.w,r=e.x,o=e.y,h=e.z,l=e.w;return this.x=a*r+s*l+i*h-n*o,this.y=a*o+i*l+n*r-s*h,this.z=a*h+n*l+s*o-i*r,this.w=a*l-s*r-i*o-n*h,this}normalize(){let t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setFromAxisAngle(t,e){e*=.5*q.DEG_TO_RAD;const s=Math.sin(e),i=Math.cos(e);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=i,this}setFromEulerAngles(t,e,s){if(t instanceof at){const i=t;t=i.x,e=i.y,s=i.z}const i=.5*q.DEG_TO_RAD;t*=i,e*=i,s*=i;const n=Math.sin(t),a=Math.cos(t),r=Math.sin(e),o=Math.cos(e),h=Math.sin(s),l=Math.cos(s);return this.x=n*o*l-a*r*h,this.y=a*r*l+n*o*h,this.z=a*o*h-n*r*l,this.w=a*o*l+n*r*h,this}setFromMat4(t){let e,s,i,n,a,r,o,h,l,c,d,u,p,m;if(e=(t=t.data)[0],s=t[1],i=t[2],n=t[4],a=t[5],r=t[6],o=t[8],h=t[9],l=t[10],u=e*e+s*s+i*i,0===u)return this;if(u=1/Math.sqrt(u),p=n*n+a*a+r*r,0===p)return this;if(p=1/Math.sqrt(p),m=o*o+h*h+l*l,0===m)return this;m=1/Math.sqrt(m),e*=u,s*=u,i*=u,n*=p,a*=p,r*=p,o*=m,h*=m,l*=m;const f=e+a+l;return f>=0?(c=Math.sqrt(f+1),this.w=.5*c,c=.5/c,this.x=(r-h)*c,this.y=(o-i)*c,this.z=(s-n)*c):e>a?e>l?(d=e-(a+l)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(r-h)*d,this.y=(s+n)*d,this.z=(i+o)*d):(d=l-(e+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(h+r)*d):a>l?(d=a-(l+e)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(o-i)*d,this.z=(r+h)*d,this.x=(n+s)*d):(d=l-(e+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(h+r)*d),this}slerp(t,e,s){const i=t.x,n=t.y,a=t.z,r=t.w;let o=e.x,h=e.y,l=e.z,c=e.w,d=r*c+i*o+n*h+a*l;if(d<0&&(c=-c,o=-o,h=-h,l=-l,d=-d),Math.abs(d)>=1)return this.w=r,this.x=i,this.y=n,this.z=a,this;const u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*r+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*h,this.z=.5*a+.5*l,this;const m=Math.sin((1-s)*u)/p,f=Math.sin(s*u)/p;return this.w=r*m+c*f,this.x=i*m+o*f,this.y=n*m+h*f,this.z=a*m+l*f,this}transformVector(t,e=new at){const s=t.x,i=t.y,n=t.z,a=this.x,r=this.y,o=this.z,h=this.w,l=h*s+r*n-o*i,c=h*i+o*s-a*n,d=h*n+a*i-r*s,u=-a*s-r*i-o*n;return e.x=l*h+u*-a+c*-o-d*-r,e.y=c*h+u*-r+d*-a-l*-o,e.z=d*h+u*-o+l*-r-c*-a,e}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}ft.IDENTITY=Object.freeze(new ft(0,0,0,1)),ft.ZERO=Object.freeze(new ft(0,0,0,0));const _t=new at,gt=new at,yt=new at,vt=new at,xt=new at;class bt{constructor(t=new at,e=new at(.5,.5,.5)){this.center=t,this.halfExtents=e,this._min=new at,this._max=new at}add(t){const e=this.center,s=e.x,i=e.y,n=e.z,a=this.halfExtents,r=a.x,o=a.y,h=a.z;let l=s-r,c=s+r,d=i-o,u=i+o,p=n-h,m=n+h;const f=t.center,_=f.x,g=f.y,y=f.z,v=t.halfExtents,x=v.x,b=v.y,S=v.z,w=_-x,T=_+x,M=g-b,C=g+b,A=y-S,P=y+S;w<l&&(l=w),T>c&&(c=T),M<d&&(d=M),C>u&&(u=C),A<p&&(p=A),P>m&&(m=P),e.x=.5*(l+c),e.y=.5*(d+u),e.z=.5*(p+m),a.x=.5*(c-l),a.y=.5*(u-d),a.z=.5*(m-p)}copy(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents)}clone(){return new bt(this.center.clone(),this.halfExtents.clone())}intersects(t){const e=this.getMax(),s=this.getMin(),i=t.getMax(),n=t.getMin();return s.x<=i.x&&e.x>=n.x&&s.y<=i.y&&e.y>=n.y&&s.z<=i.z&&e.z>=n.z}_intersectsRay(t,e){const s=_t.copy(this.getMin()).sub(t.origin),i=gt.copy(this.getMax()).sub(t.origin),n=t.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const a=yt.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),r=vt.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(r.x,r.y),r.z),h=Math.max(Math.max(a.x,a.y),a.z),l=o>=h&&h>=0;return l&&e.copy(t.direction).mulScalar(h).add(t.origin),l}_fastIntersectsRay(t){const e=_t,s=gt,i=yt,n=vt,a=xt,r=t.direction;return e.sub2(t.origin,this.center),n.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),i.mul2(e,r),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(a.set(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),s.cross(r,e),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)&&(!(s.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x)&&!(s.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)))))}intersectsRay(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)}setMinMax(t,e){this.center.add2(e,t).mulScalar(.5),this.halfExtents.sub2(e,t).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(t){const e=this.getMin(),s=this.getMax();return!(t.x<e.x||t.x>s.x||t.y<e.y||t.y>s.y||t.z<e.z||t.z>s.z)}setFromTransformedAabb(t,e,s=!1){const i=t.center,n=t.halfExtents,a=e.data;let r=a[0],o=a[4],h=a[8],l=a[1],c=a[5],d=a[9],u=a[2],p=a[6],m=a[10];if(s){let t=r*r+o*o+h*h;if(t>0){const e=1/Math.sqrt(t);r*=e,o*=e,h*=e}if(t=l*l+c*c+d*d,t>0){const e=1/Math.sqrt(t);l*=e,c*=e,d*=e}if(t=u*u+p*p+m*m,t>0){const e=1/Math.sqrt(t);u*=e,p*=e,m*=e}}this.center.set(a[12]+r*i.x+o*i.y+h*i.z,a[13]+l*i.x+c*i.y+d*i.z,a[14]+u*i.x+p*i.y+m*i.z),this.halfExtents.set(Math.abs(r)*n.x+Math.abs(o)*n.y+Math.abs(h)*n.z,Math.abs(l)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(m)*n.z)}compute(t,e){if((e=void 0===e?t.length/3:e)>0){const s=_t.set(t[0],t[1],t[2]),i=gt.set(t[0],t[1],t[2]);for(let n=1;n<e;n++){const e=t[3*n+0],a=t[3*n+1],r=t[3*n+2];e<s.x&&(s.x=e),a<s.y&&(s.y=a),r<s.z&&(s.z=r),e>i.x&&(i.x=e),a>i.y&&(i.y=a),r>i.z&&(i.z=r)}this.setMinMax(s,i)}}intersectsBoundingSphere(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius}_distanceToBoundingSphereSq(t){const e=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let a=0;a<3;++a){let r=0;const o=t.center[n[a]],h=e[n[a]],l=s[n[a]];let c=0;o<h&&(c=h-o,r+=c*c),o>l&&(c=o-l,r+=c*c),i+=r}return i}_expand(t,e){_t.add2(this.getMin(),t),gt.add2(this.getMax(),e),this.setMinMax(_t,gt)}}const St=new at,wt=new at;class Tt{constructor(t=new at,e=.5){this.center=t,this.radius=e}containsPoint(t){const e=St.sub2(t,this.center).lengthSq(),s=this.radius;return e<s*s}intersectsRay(t,e){const s=St.copy(t.origin).sub(this.center),i=s.dot(wt.copy(t.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const a=i*i-n;if(a<0)return!1;const r=Math.abs(-i-Math.sqrt(a));return e&&e.copy(t.direction).mulScalar(r).add(t.origin),!0}intersectsBoundingSphere(t){St.sub2(t.center,this.center);const e=t.radius+this.radius;return St.lengthSq()<=e*e}}const Mt=0,Ct=1,At=2,Pt=3,Et=4,Rt=5,Lt=6,It=7,Dt=8,Ot=9,Ft=10,kt="none",Bt="linear",zt="exp",Ut="exp2",Vt=0,Nt=2,Wt=0,Gt=1,Ht=2,Xt=15,qt=0,jt=1,Yt=2,Kt=3,$t=4,Zt=0,Qt=1,Jt=1,te=2,ee=0,se=1,ie=2,ne=3,ae=0,re=1,oe=0,he=0,le=1,ce=2,de=3,ue=4,pe=5,me=6,fe={0:"PCF3",1:"VSM8",2:"VSM16",3:"VSM32",4:"PCF5",5:"PCF1"},_e=0,ge=1,ye=0,ve=1,xe=2,be=3,Se=0,we=1,Te=0,Me=1,Ce=0,Ae=1,Pe=2,Ee=0,Re=1,Le=0,Ie=1,De=2,Oe=0,Fe=1,ke=0,Be=1,ze="mul",Ue="add",Ve="screen",Ne="overlay",We="min",Ge="max",He=0,Xe=1,qe=2,je=3,Ye=0,Ke=1,$e=2,Ze=3,Qe=4,Je=0,ts=1,es=2,ss=1,is=2,ns=4,as=8,rs=16,os=32,hs=64,ls=128,cs=256,ds=512,us=1024,ps=2048,ms=4096,fs=8192,_s=0,gs=1,ys=2,vs=0,xs=1,bs=2,Ss=0,ws=1,Ts=1,Ms=2,Cs=4,As=0,Ps=1,Es=2,Rs=3,Ls=18,Is=0,Ds=1,Os=2,Fs=0,ks=1,Bs=0,zs=1,Us=2,Vs=0,Ns=1,Ws=2,Gs=3,Hs=4,Xs=5,qs=1,js=2,Ys=4,Ks=8,$s=0,Zs=1,Qs=0,Js=1,ti=[new at,new at,new at,new at,new at,new at,new at,new at];class ei{constructor(){this.planes=[];for(let t=0;t<6;t++)this.planes[t]=[]}setFromMat4(t){const e=t.data;let s;const i=this.planes;s=i[0],s[0]=e[3]-e[0],s[1]=e[7]-e[4],s[2]=e[11]-e[8],s[3]=e[15]-e[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=e[3]+e[0],s[1]=e[7]+e[4],s[2]=e[11]+e[8],s[3]=e[15]+e[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=e[3]+e[1],s[1]=e[7]+e[5],s[2]=e[11]+e[9],s[3]=e[15]+e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=e[3]-e[1],s[1]=e[7]-e[5],s[2]=e[11]-e[9],s[3]=e[15]-e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=e[3]-e[2],s[1]=e[7]-e[6],s[2]=e[11]-e[10],s[3]=e[15]-e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=e[3]+e[2],s[1]=e[7]+e[6],s[2]=e[11]+e[10],s[3]=e[15]+e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(t){let e,s;for(e=0;e<6;e++)if(s=this.planes[e],s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3]<=0)return!1;return!0}containsSphere(t){let e,s,i=0;const n=t.radius,a=t.center,r=a.x,o=a.y,h=a.z,l=this.planes;let c;for(s=0;s<6;s++){if(c=l[s],e=c[0]*r+c[1]*o+c[2]*h+c[3],e<=-n)return 0;e>n&&i++}return 6===i?2:1}static getPoints(t,e,s){e=e||t._nearClip,s=s||t._farClip;const i=t._fov*Math.PI/180;let n=0===t._projection?Math.tan(i/2)*e:t._orthoHeight,a=n*t._aspectRatio;const r=ti;return r[0].x=a,r[0].y=-n,r[0].z=-e,r[1].x=a,r[1].y=n,r[1].z=-e,r[2].x=-a,r[2].y=n,r[2].z=-e,r[3].x=-a,r[3].y=-n,r[3].z=-e,0===t._projection&&(n=Math.tan(i/2)*s,a=n*t._aspectRatio),r[4].x=a,r[4].y=-n,r[4].z=-s,r[5].x=a,r[5].y=n,r[5].z=-s,r[6].x=-a,r[6].y=n,r[6].z=-s,r[7].x=-a,r[7].y=-n,r[7].z=-s,r}}class si{constructor(t=new at,e=new at(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}}const ii=new si,ni=new at,ai=new Tt,ri=new mt;class oi{constructor(t=new mt,e=new at(.5,.5,.5)){this.halfExtents=e,this._modelTransform=t.clone().invert(),this._worldTransform=t.clone(),this._aabb=new bt(new at,this.halfExtents)}set worldTransform(t){this._worldTransform.copy(t),this._modelTransform.copy(t).invert()}get worldTransform(){return this._worldTransform}intersectsRay(t,e){if(this._modelTransform.transformPoint(t.origin,ii.origin),this._modelTransform.transformVector(t.direction,ii.direction),e){const t=this._aabb._intersectsRay(ii,e);return ri.copy(this._modelTransform).invert().transformPoint(e,e),t}return this._aabb._fastIntersectsRay(ii)}containsPoint(t){return this._modelTransform.transformPoint(t,ni),this._aabb.containsPoint(ni)}intersectsBoundingSphere(t){return this._modelTransform.transformPoint(t.center,ai.center),ai.radius=t.radius,!!this._aabb.intersectsBoundingSphere(ai)}}const hi=new at;class li{constructor(t=new at,e=new at(0,0,1)){this.normal=e,this.point=t}intersectsLine(t,e,s){const i=-this.normal.dot(this.point),n=this.normal.dot(t)+i,a=n/(n-(this.normal.dot(e)+i)),r=a>=0&&a<=1;return r&&s&&s.lerp(t,e,a),r}intersectsRay(t,e){const s=hi.sub2(this.point,t.origin),i=this.normal.dot(s)/this.normal.dot(t.direction),n=i>=0;return n&&e&&e.copy(t.direction).mulScalar(i).add(t.origin),n}}const ci=0,di=1,ui=2,pi=0,mi=1,fi=2,_i=3,gi=4,yi=5,vi=6,xi=7,bi=8,Si=9,wi=10,Ti=11,Mi=12,Ci=13,Ai=14,Pi=0,Ei=1,Ri=2,Li=3,Ii=4,Di=0,Oi=1,Fi=2,ki=3,Bi=1,zi=2,Ui=4,Vi=0,Ni=1,Wi=2,Gi=3,Hi=4,Xi=5,qi=0,ji=1,Yi=2,Ki=3,$i=0,Zi=1,Qi=2,Ji=3,tn=4,en=5,sn=0,nn=1,an=2,rn=3,on=4,hn=5,ln=6,cn=7,dn=0,un=1,pn=2,mn=0,fn=1,_n=2,gn=3,yn=4,vn=5,xn=6,bn=7,Sn=8,wn=9,Tn=10,Mn=11,Cn=12,An=13,Pn=14,En=15,Rn=16,Ln=17,In=18,Dn=19,On=20,Fn=21,kn=22,Bn=23,zn=24,Un=25,Vn=26,Nn=27,Wn=28,Gn=29,Hn=30,Xn=0,qn=1,jn=2,Yn=3,Kn=4,$n=5,Zn=6,Qn="POSITION",Jn="NORMAL",ta="TANGENT",ea="BLENDWEIGHT",sa="BLENDINDICES",ia="COLOR",na="TEXCOORD",aa="TEXCOORD0",ra="TEXCOORD1",oa="TEXCOORD2",ha="TEXCOORD3",la="TEXCOORD4",ca="TEXCOORD5",da="TEXCOORD6",ua="TEXCOORD7",pa="ATTR",ma="ATTR0",fa="ATTR1",_a="ATTR2",ga="ATTR3",ya="ATTR4",va="ATTR5",xa="ATTR6",ba="ATTR7",Sa="ATTR8",wa="ATTR9",Ta="ATTR10",Ma="ATTR11",Ca="ATTR12",Aa="ATTR13",Pa="ATTR14",Ea="ATTR15",Ra=1,La=0,Ia=1,Da=2,Oa=3,Fa=4,ka=5,Ba=6,za=7,Ua=1,Va=2,Na="default",Wa="rgbm",Ga="rgbe",Ha="swizzleGGGR",Xa=0,qa=1,ja=2,Ya=3,Ka="none",$a="cube",Za="equirect",Qa="octahedral",Ja=0,tr=1,er=2,sr=3,ir=4,nr=5,ar=6,rr=0,or=1,hr=2,lr=3,cr=4,dr=5,ur=6,pr=7,mr=8,fr=9,_r=10,gr=11,yr=12,vr=13,xr=14,br=15,Sr=16,wr=17,Tr=18,Mr=19,Cr=20,Ar=21,Pr=22,Er=23,Rr=1,Lr=2,Ir=4,Dr=0,Or=1,Fr=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],kr=[1,1,2,2,4,4,4],Br={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},zr=[Uint8Array,Uint16Array,Uint32Array],Ur=[1,2,4],Vr={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15};let Nr=0;class Wr{constructor(t,e,s,i=0,n){this.device=t,this.format=e,this.numVertices=s,this.usage=i,this.id=Nr++,this.impl=t.createVertexBufferImpl(this,e),this.instancing=!1,this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*s,t._vram.vb+=this.numBytes,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.impl.destroy(t),t._vram.vb-=this.storage.byteLength}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}}function Gr(t){let e=0;for(let s=0,i=t.length;s<i;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}class Hr{constructor(t,e,s){this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.size=e.reduce(((t,e)=>t+4*Math.ceil(e.components*kr[e.type]/4)),0);let i,n=0;for(let t=0,a=e.length;t<a;t++){const a=e[t];i=a.components*kr[a.type],s&&(n=q.roundUp(n,i));const r={name:a.semantic,offset:s?n:a.hasOwnProperty("offset")?a.offset:n,stride:s?i:a.hasOwnProperty("stride")?a.stride:this.size,dataType:a.type,numComponents:a.components,normalize:void 0!==a.normalize&&a.normalize,size:i};this._elements.push(r),n+=s?i*s:4*Math.ceil(i/4),"TEXCOORD0"===a.semantic?this.hasUv0=!0:"TEXCOORD1"===a.semantic?this.hasUv1=!0:"COLOR"===a.semantic?this.hasColor=!0:"TANGENT"===a.semantic&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this._evaluateHash()}get elements(){return this._elements}static get defaultInstancingFormat(){return Hr._defaultInstancingFormat||(Hr._defaultInstancingFormat=new Hr(null,[{semantic:"ATTR12",components:4,type:6},{semantic:"ATTR13",components:4,type:6},{semantic:"ATTR14",components:4,type:6},{semantic:"ATTR15",components:4,type:6}])),Hr._defaultInstancingFormat}_evaluateHash(){let t;const e=[];let s;const i=[],n=this._elements.length;for(let a=0;a<n;a++){const n=this._elements[a];t=n.name,t+=n.dataType,t+=n.numComponents,t+=n.normalize,e.push(t),s=t,s+=n.offset,s+=n.stride,s+=n.size,i.push(s)}e.sort(),this.batchingHash=Gr(e.join()),this.renderingingHashString=i.join("_"),this.renderingingHash=Gr(this.renderingingHashString)}}Hr._defaultInstancingFormat=null;class Xr{constructor(){this._cache=new Map}get(t,e){return this._cache.has(t)||(this._cache.set(t,e()),t.on("destroy",(()=>{this.remove(t)}))),this._cache.get(t)}remove(t){var e;null==(e=this._cache.get(t))||e.destroy(),this._cache.delete(t)}}const qr={type:5,base:0,count:4,indexed:!1},jr=new Xr;function Yr(t,e,s,i,n,a=!1){const r=t.renderTarget;let o,h,l,c,d,u,p,m;t.setRenderTarget(e),t.updateBegin(),i?(o=i.x,h=i.y,l=i.z,c=i.w):(l=e?e.width:t.width,c=e?e.height:t.height,o=0,h=0),n?(d=n.x,u=n.y,p=n.z,m=n.w):(d=o,u=h,p=l,m=c);const f=t.vx,_=t.vy,g=t.vw,y=t.vh;t.setViewport(o,h,l,c);const v=t.sx,x=t.sy,b=t.sw,S=t.sh;t.setScissor(d,u,p,m);const w=t.getDepthTest(),T=t.getDepthWrite(),M=t.getCullMode(),C=t.writeRed,A=t.writeGreen,P=t.writeBlue,E=t.writeAlpha;t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(0),t.setColorWrite(!0,!0,!0,!0),a||t.setBlending(!1),t.setVertexBuffer(function(t){return jr.get(t,(()=>{const e=new Hr(t,[{semantic:"POSITION",components:2,type:6}]),s=new Float32Array(8);return s.set([-1,-1,1,-1,-1,1,1,1]),new Wr(t,e,4,0,s)}))}(t),0),t.setShader(s),t.draw(qr),t.setDepthTest(w),t.setDepthWrite(T),t.setCullMode(M),t.setColorWrite(C,A,P,E),t.updateEnd(),t.setRenderTarget(r),t.updateBegin(),t.setViewport(f,_,g,y),t.setScissor(v,x,b,S)}function Kr(t,e,s,i,n,a,r=!1){i=i||t.getCopyShader(),t.constantTexSource.setValue(e),Yr(t,s,i,n,a,r)}class $r{constructor(t,e){this.device=t,this.definition=e,this.init(),this.impl=t.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}destroy(){this.impl.destroy(this)}loseContext(){this.init()}restoreContext(){this.impl.restoreContext(this.device,this)}}const Zr={alphaTestPS:"\nuniform float alpha_ref;\n\nvoid alphaTest(float a) {\n\t\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"\nvoid addAmbient() {\n\t\tdDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\n\nvoid addAmbient() {\n\t\tvec3 dir = normalize(cubeMapRotate(dNormalW) * vec3(-1.0, 1.0, 1.0));\n\t\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\n\t\tvec4 raw = texture2D(texture_envAtlas, uv);\n\t\tvec3 linear = $DECODE(raw);\n\t\tdDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"\nuniform vec3 ambientSH[9];\n\nvoid addAmbient() {\n\t\tvec3 n = cubeMapRotate(dNormalW);\n\n\t\tvec3 color =\n\t\t\t\tambientSH[0] +\n\t\t\t\tambientSH[1] * n.x +\n\t\t\t\tambientSH[2] * n.y +\n\t\t\t\tambientSH[3] * n.z +\n\t\t\t\tambientSH[4] * n.x * n.z +\n\t\t\t\tambientSH[5] * n.z * n.y +\n\t\t\t\tambientSH[6] * n.y * n.x +\n\t\t\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\t\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\n\t\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\n\nvoid getAO() {\n\t\tdAo = 1.0;\n\n\t\t#ifdef MAPTEXTURE\n\t\tdAo *= texture2D(texture_aoMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdAo *= saturate(vVertexColor.$VC);\n\t\t#endif\n}\n",aoDiffuseOccPS:"\nvoid occludeDiffuse() {\n\t\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"\nuniform float material_occludeSpecularIntensity;\n\nvoid occludeSpecular() {\n\t\t// approximated specular occlusion from AO\n\t\tfloat specPow = exp2(dGlossiness * 11.0);\n\t\t// http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n\t\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\t\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"\nvoid occludeSpecular() {\n\t\t// approximated specular occlusion from AO\n\t\tfloat specPow = exp2(dGlossiness * 11.0);\n\t\t// http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n\t\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"\nvoid occludeSpecular() {\n\t\tdSpecularLight *= dAo;\n\t\tdReflection *= dAo;\n}\n",aoSpecOccSimplePS:"\nuniform float material_occludeSpecularIntensity;\n\nvoid occludeSpecular() {\n\t\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\n\t\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\n\t\tif (bakeDir > 0.5) {\n\t\t\t\tif (dAtten > 0.00001) {\n\t\t\t\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\t\t\t\tdAtten = saturate(dAtten);\n\t\t\t\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\t\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\t\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t\t\t} else {\n\t\t\t\t\t\tgl_FragColor = dirLm;\n\t\t\t\t}\n\t\t} else {\n\t\t\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\t\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t\t}\n",bakeLmEndPS:"\n\t\tgl_FragColor.rgb = dDiffuseLight;\n\t\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\t\tgl_FragColor.rgb /= 8.0;\n\t\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\t\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\t\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nfloat square(float x) {\n\t\treturn x*x;\n}\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 x) {\n\t\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"\n#define NINESLICED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"\n#define NINESLICED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",biasConstPS:"\n#define SHADOWBIAS\n\nfloat getShadowBias(float resolution, float maxBias) {\n\t\treturn maxBias;\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\t\treturn rg.y*(1.0/255.0) + rg.x;\n}\n\nvec2 encodeFloatRG( float v ) {\n\t\tvec2 enc = vec2(1.0, 255.0) * v;\n\t\tenc = fract(enc);\n\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\t\treturn enc;\n}\n#endif\n\nvoid main(void) {\n\t\tvec3 moments = vec3(0.0);\n\t\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\t\tfor (int i=0; i<SAMPLES; i++) {\n\t\t\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\n\t\t\t\t#ifdef PACKED\n\t\t\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t\t\t#endif\n\n\t\t\t\t#ifdef GAUSS\n\t\t\t\tmoments += c.xyz * weight[i];\n\t\t\t\t#else\n\t\t\t\tmoments += c.xyz;\n\t\t\t\t#endif\n\t\t}\n\n\t\t#ifndef GAUSS\n\t\tmoments /= float(SAMPLES);\n\t\t#endif\n\n\t\t#ifdef PACKED\n\t\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t\t#else\n\t\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t\t#endif\n}\n",clearCoatPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\n\nvoid getClearCoat() {\n\t\tccSpecularity = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tccSpecularity *= material_clearCoat;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tccSpecularity *= texture2D(texture_clearCoatMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tccSpecularity *= saturate(vVertexColor.$VC);\n\t\t#endif\n}\n",clearCoatGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\n\nvoid getClearCoatGlossiness() {\n\t\tccGlossiness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tccGlossiness *= material_clearCoatGlossiness;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tccGlossiness *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\n\nvoid getClearCoatNormal() {\n\t\t#ifdef MAPTEXTURE\n\t\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV, textureBias));\n\t\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\t\tccNormalW = dTBN * normalMap;\n\t\t#else\n\t\tccNormalW = normalize(dVertexNormalW);\n\t\t#endif\n\n\t\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(sampler2D tex, vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n\t\tvec4 pixel = mix(vec4(1.0), texture2D(tex, uv), intensity);\n\t\treturn isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\n\n// getCookie2D for clustered lighting including channel selector\nvec3 getCookie2DClustered(sampler2D tex, mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n\t\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\t\treturn _getCookieClustered(tex, projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\n\n// getCookie for clustered omni light with the cookie texture being stored in the cookie atlas\nvec3 getCookieCubeClustered(sampler2D tex, vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\treturn _getCookieClustered(tex, uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"\n// Clustered Omni Sampling using atlas\n\n#ifdef GL2\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowOmniClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n\t\t\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\t\t\treturn texture(shadowMap, vec3(uv, shadowZ));\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowOmniClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n\t\t\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\t\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF3x3(shadowMap, shadowParams.xyz);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\tfloat getShadowOmniClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n\t\t\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\t\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF5x5(shadowMap, shadowParams.xyz);\n\t\t}\n\n\t\t#endif\n\n#else\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n\t\t\t\t// no filter shadow sampling\n\t\t\t\tfloat depth = unpackFloat(texture2D(shadowMap, uv));\n\t\t\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\t\t\treturn depth > shadowZ ? 1.0 : 0.0;\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n\t\t\t\t// pcf3\n\t\t\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\t\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF3x3(shadowMap, shadowParams.xyz);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\t// we don't have PCF5 implementation for webgl1, use PCF3\n\t\tfloat getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\n\t\t\t\t// pcf3\n\t\t\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\t\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF3x3(shadowMap, shadowParams.xyz);\n\t\t}\n\n\t\t#endif\n\n#endif\n\n\n// Clustered Spot Sampling using atlas\n\n#ifdef GL2\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowSpotClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\t\t\treturn texture(shadowMap, dShadowCoord);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowSpotClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\t\t\treturn getShadowSpotPCF3x3(shadowMap, shadowParams);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\tfloat getShadowSpotClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\t\t\treturn getShadowPCF5x5(shadowMap, shadowParams.xyz);\n\t\t}\n\t\t#endif\n\n#else\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowSpotClusteredPCF1(sampler2D shadowMap, vec4 shadowParams) {\n\n\t\t\t\tfloat depth = unpackFloat(texture2D(shadowMap, dShadowCoord.xy));\n\n\t\t\t\treturn depth > dShadowCoord.z ? 1.0 : 0.0;\n\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowSpotClusteredPCF3(sampler2D shadowMap, vec4 shadowParams) {\n\t\t\t\treturn getShadowSpotPCF3x3(shadowMap, shadowParams);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\t// we don't have PCF5 implementation for webgl1, use PCF3\n\t\tfloat getShadowSpotClusteredPCF5(sampler2D shadowMap, vec4 shadowParams) {\n\t\t\t\treturn getShadowSpotPCF3x3(shadowMap, shadowParams);\n\t\t}\n\n\t\t#endif\n\n#endif\n",clusteredLightUtilsPS:"\n// Converts unnormalized direction vector to a cubemap face index [0..5] and uv coordinates within the face in [0..1] range.\n// Additionally offset to a tile in atlas within 3x3 subdivision is provided\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\t\tvec3 vAbs = abs(dir);\n\t\tfloat ma;\n\t\tvec2 uv;\n\t\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\t // front / back\n\n\t\t\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\t\t\tma = 0.5 / vAbs.z;\n\t\t\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\n\t\t\t\ttileOffset.x = 2.0;\n\t\t\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\n\t\t} else if(vAbs.y >= vAbs.x) {\t// top index 2, bottom index 3\n\n\t\t\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\t\t\tma = 0.5 / vAbs.y;\n\t\t\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\n\t\t\t\ttileOffset.x = 1.0;\n\t\t\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\n\t\t} else {\t\t// left / right\n\n\t\t\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\t\t\tma = 0.5 / vAbs.x;\n\t\t\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\n\t\t\t\ttileOffset.x = 0.0;\n\t\t\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\n\t\t}\n\t\treturn uv * ma + 0.5;\n}\n\n// converts unnormalized direction vector to a texture coordinate for a cubemap face stored within texture atlas described by the viewport\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\n\t\tfloat faceIndex;\n\t\tvec2 tileOffset;\n\t\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\n\t\t// move uv coordinates inwards inside to compensate for larger fov when rendering shadow into atlas\n\t\tfloat atlasFaceSize = omniAtlasViewport.z;\n\t\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\t\tfloat offset = shadowEdgePixels / tileSize;\n\t\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\n\t\t// scale uv coordinates to cube face area within the viewport\n\t\tuv *= atlasFaceSize;\n\n\t\t// offset into face of the atlas (3x3 grid)\n\t\tuv += tileOffset * atlasFaceSize;\n\n\t\t// offset into the atlas viewport\n\t\tuv += omniAtlasViewport.xy;\n\n\t\treturn uv;\n}\n",clusteredLightPS:"\nuniform sampler2D clusterWorldTexture;\nuniform sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n\n// complex ifdef expression are not supported, handle it here\n// defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n#if defined(CLUSTER_COOKIES)\n\t\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#if defined(CLUSTER_SHADOWS)\n\t\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n\n#ifdef CLUSTER_SHADOWS\n\t\t#ifdef GL2\n\t\t\t\t// TODO: when VSM shadow is supported, it needs to use sampler2D in webgl2\n\t\t\t\tuniform sampler2DShadow shadowAtlasTexture;\n\t\t#else\n\t\t\t\tuniform sampler2D shadowAtlasTexture;\n\t\t#endif\n#endif\n\n#ifdef CLUSTER_COOKIES\n\t\tuniform sampler2D cookieAtlasTexture;\n#endif\n\nuniform float clusterPixelsPerCell;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec4 lightsTextureInvSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\n\n// global variable to limit shared area light values to be evaluated only one time\nfloat LTCLightValuesEvaluated = 0.0;\n\n// structure storing light properties of a clustered light\nstruct ClusterLightData {\n\n\t\t// v coordinate to look up the light textures\n\t\tfloat lightV;\n\n\t\t// type of the light (spot or omni)\n\t\tfloat type;\n\n\t\t// area light shape\n\t\tfloat shape;\n\n\t\t// area light sizes / orientation\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\n\t\t// light follow mode\n\t\tfloat falloffMode;\n\n\t\t// 1.0 if the light is shadow casting\n\t\tfloat castShadows;\n\n\t\t// shadow bias values\n\t\tfloat shadowBias;\n\t\tfloat shadowNormalBias;\n\n\t\t// world space position\n\t\tvec3 position;\n\n\t\t// world space direction (spot light only)\n\t\tvec3 direction;\n\n\t\t// range of the light\n\t\tfloat range;\n\n\t\t// spot light inner and outer angle cosine\n\t\tfloat innerConeAngleCos;\n\t\tfloat outerConeAngleCos;\n\n\t\t// color\n\t\tvec3 color;\n\n\t\t// atlas viewport for omni light shadow and cookie (.xy is offset to the viewport slot, .z is size of the face in the atlas)\n\t\tvec3 omniAtlasViewport;\n\n\t\t// 1.0 if the light has a cookie texture\n\t\tfloat cookie;\n\n\t\t// 1.0 if cookie texture is rgb, otherwise it is using a single channel selectable by cookieChannelMask\n\t\tfloat cookieRgb;\n\n\t\t// intensity of the cookie\n\t\tfloat cookieIntensity;\n\n\t\t// channel mask - one of the channels has 1, the others are 0\n\t\tvec4 cookieChannelMask;\n\n\t\t// light mask\n\t\tfloat mask;\n};\n\n// Note: on some devices (tested on Pixel 3A XL), this matrix when stored inside the light struct has lower precision compared to\n// when stored outside, so we store it outside to avoid spot shadow flickering. This might need to be done to other / all members\n// of the structure if further similar issues are observed.\n\n// shadow (spot light only) / cookie projection matrix\nmat4 lightProjectionMatrix;\n\n// macros for light properties\n#define isClusteredLightCastShadow(light) ( light.castShadows > 0.5 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.type > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n\n// macros to test light shape\n// Note: Following functions need to be called serially in listed order as they do not test both '>' and '<'\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\n\n// macro to test light mask (mesh accepts dynamic vs lightmapped lights)\n#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t\t// accept lights marked as dynamic or both dynamic and lightmapped\n\t\t#define acceptLightMask(light) ( light.mask < 0.75)\n#else\n\t\t// accept lights marked as lightmapped or both dynamic and lightmapped\n\t\t#define acceptLightMask(light) ( light.mask > 0.25)\n#endif\n\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n\t\treturn vec4(\n\t\t\t\tbytes2floatRange4(d0, -2.0, 2.0),\n\t\t\t\tbytes2floatRange4(d1, -2.0, 2.0),\n\t\t\t\tbytes2floatRange4(d2, -2.0, 2.0),\n\t\t\t\tbytes2floatRange4(d3, -2.0, 2.0)\n\t\t);\n}\n\n// use LOD sampling if supported to sample data textures as it has better chance of getting skipped inside dynamic branches\n#ifdef SUPPORTS_TEXLOD\n\t\t#define textureData(texture, uv) texture2DLodEXT(texture, uv, 0.0)\n#else\n\t\t#define textureData(texture, uv) texture2D(texture, uv)\n#endif\n\nvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {\n\t\treturn textureData(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV));\n}\n\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {\n\t\treturn textureData(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV));\n}\n\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\n\t\t// read omni light properties\n\t\tclusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\n\t\t// shared data from 8bit texture\n\t\tvec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n\t\tclusterLightData.type = lightInfo.x;\n\t\tclusterLightData.shape = lightInfo.y;\n\t\tclusterLightData.falloffMode = lightInfo.z;\n\t\tclusterLightData.castShadows = lightInfo.w;\n\n\t\t// color\n\t\tvec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n\t\tvec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n\t\tclusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\n\t\t// cookie\n\t\tclusterLightData.cookie = colorB.z;\n\n\t\t// light mask\n\t\tclusterLightData.mask = colorB.w;\n\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\n\t\t\t\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n\t\t\t\tclusterLightData.position = lightPosRange.xyz;\n\t\t\t\tclusterLightData.range = lightPosRange.w;\n\n\t\t\t\t// spot light direction\n\t\t\t\tvec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n\t\t\t\tclusterLightData.direction = lightDir_Unused.xyz;\n\n\t\t#else\t // 8bit\n\n\t\t\t\tvec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);\n\t\t\t\tvec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);\n\t\t\t\tvec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);\n\t\t\t\tclusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;\n\n\t\t\t\tvec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);\n\t\t\t\tclusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;\n\n\t\t\t\t// spot light direction\n\t\t\t\tvec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);\n\t\t\t\tvec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);\n\t\t\t\tvec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);\n\t\t\t\tclusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;\n\n\t\t#endif\n}\n\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\n\t\t// spot light cos angles\n\t\tvec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n\t\tclusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n\t\tclusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\n\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\t\t\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n\t\t#else\n\t\t\t\tvec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);\n\t\t\t\tvec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);\n\t\t\t\tclusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));\n\t\t#endif\n}\n\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\t\t\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n\t\t\t\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n\t\t#else\n\t\t\t\tvec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);\n\t\t\t\tvec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);\n\t\t\t\tvec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);\n\t\t\t\tclusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));\n\n\t\t\t\tvec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);\n\t\t\t\tvec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);\n\t\t\t\tvec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);\n\t\t\t\tclusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));\n\t\t#endif\n}\n\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\t\n\t\t// shadow matrix\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\t\t\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n\t\t\t\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n\t\t\t\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n\t\t\t\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n\t\t#else\n\t\t\t\tvec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);\n\t\t\t\tvec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);\n\t\t\t\tvec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);\n\t\t\t\tvec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);\n\t\t\t\tvec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);\n\n\t\t\t\tvec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);\n\t\t\t\tvec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);\n\t\t\t\tvec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);\n\t\t\t\tvec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);\n\t\t\t\tvec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);\n\n\t\t\t\tvec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);\n\t\t\t\tvec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);\n\t\t\t\tvec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);\n\t\t\t\tvec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);\n\t\t\t\tvec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);\n\n\t\t\t\tvec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);\n\t\t\t\tvec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);\n\t\t\t\tvec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);\n\t\t\t\tvec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);\n\t\t\t\tvec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));\n\t\t#endif\n\t\t\n\t\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\n\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\t\n\t\t// shadow biases\n\t\tvec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n\t\tclusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n\t\tclusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\n\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\n\t\tvec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n\t\tclusterLightData.cookieIntensity = cookieA.x;\n\t\tclusterLightData.cookieRgb = cookieA.y;\n\n\t\tclusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\n\nvoid evaluateLight(ClusterLightData light) {\n\n\t\tdAtten3 = vec3(1.0);\n\n\t\t// evaluate omni part of the light\n\t\tgetLightDirPoint(light.position);\n\n\t\t#ifdef CLUSTER_AREALIGHTS\n\n\t\t// distance attenuation\n\t\tif (isClusteredLightArea(light)) { // area light\n\n\t\t\t\t// area lights\n\t\t\t\tdecodeClusterLightAreaData(light);\n\n\t\t\t\t// evaluate material based area lights data, shared by all area lights\n\t\t\t\tif (LTCLightValuesEvaluated < 0.5) {\n\t\t\t\t\t\tLTCLightValuesEvaluated = 1.0;\n\t\t\t\t\t\tcalcLTCLightValues();\n\t\t\t\t}\n\n\t\t\t\t// handle light shape\n\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t\t\t} else { // sphere\n\t\t\t\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t\t\t}\n\n\t\t\t\tdAtten = getFalloffWindow(light.range);\n\n\t\t} else\n\n\t\t#endif\n\n\t\t{\t // punctual light\n\n\t\t\t\tif (isClusteredLightFalloffLinear(light))\n\t\t\t\t\t\tdAtten = getFalloffLinear(light.range);\n\t\t\t\telse\n\t\t\t\t\t\tdAtten = getFalloffInvSquared(light.range);\n\t\t}\n\n\t\tif (dAtten > 0.00001) {\n\n\t\t\t\t#ifdef CLUSTER_AREALIGHTS\n\n\t\t\t\tif (isClusteredLightArea(light)) { // area light\n\n\t\t\t\t\t\t// handle light shape\n\t\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\t\t\tdAttenD = getRectLightDiffuse() * 16.0;\n\t\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\t\t\tdAttenD = getDiskLightDiffuse() * 16.0;\n\t\t\t\t\t\t} else { // sphere\n\t\t\t\t\t\t\t\tdAttenD = getSphereLightDiffuse() * 16.0;\n\t\t\t\t\t\t}\n\n\t\t\t\t} else\n\n\t\t\t\t#endif\n\n\t\t\t\t{\n\t\t\t\t\t\tdAtten *= getLightDiffuse();\n\t\t\t\t}\n\n\t\t\t\t// spot light falloff\n\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tdecodeClusterLightSpot(light);\n\t\t\t\t\t\tdAtten *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos);\n\t\t\t\t}\n\n\t\t\t\t#if defined(CLUSTER_COOKIES_OR_SHADOWS)\n\n\t\t\t\tif (dAtten > 0.00001) {\n\n\t\t\t\t\t\t// shadow / cookie\n\t\t\t\t\t\tif (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\n\t\t\t\t\t\t\t\t// shared shadow / cookie data depends on light type\n\t\t\t\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\t\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\n\t\t\t\t\t\t\t\t#ifdef CLUSTER_COOKIES\n\n\t\t\t\t\t\t\t\t// cookie\n\t\t\t\t\t\t\t\tif (isClusteredLightCookie(light)) {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightCookieData(light);\n\n\t\t\t\t\t\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\t\t\t\t\t\t\tdAtten3 = getCookie2DClustered(cookieAtlasTexture, lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\tdAtten3 = getCookieCubeClustered(cookieAtlasTexture, dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t#ifdef CLUSTER_SHADOWS\n\n\t\t\t\t\t\t\t\t// shadow\n\t\t\t\t\t\t\t\tif (isClusteredLightCastShadow(light)) {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightShadowData(light);\n\n\t\t\t\t\t\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\n\t\t\t\t\t\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\n\t\t\t\t\t\t\t\t\t\t\t\t// spot shadow\n\t\t\t\t\t\t\t\t\t\t\t\tgetShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\t\t\t\t\t\t// omni shadow\n\t\t\t\t\t\t\t\t\t\t\t\tnormalOffsetPointShadow(shadowParams);\t// normalBias adjusted for distance\n\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t\t// diffuse / specular / clearcoat\n\t\t\t\t#ifdef CLUSTER_AREALIGHTS\n\n\t\t\t\tif (isClusteredLightArea(light)) { // area light\n\n\t\t\t\t\t\t// area light diffuse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvec3 areaDiffuse = (dAttenD * dAtten) * light.color * dAtten3;\n\n\t\t\t\t\t\t\t\t#if defined(CLUSTER_SPECULAR)\n\t\t\t\t\t\t\t\t\t\t#if defined(CLUSTER_CONSERVE_ENERGY)\n\t\t\t\t\t\t\t\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t// area light diffuse - it does not mix diffuse lighting into specular attenuation\n\t\t\t\t\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// specular and clear coat are material settings and get included by a define based on the material\n\t\t\t\t\t\t#ifdef CLUSTER_SPECULAR\n\n\t\t\t\t\t\t\t\t// area light specular\n\t\t\t\t\t\t\t\tfloat areaLightSpecular;\n\n\t\t\t\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\t\t\t\t\tareaLightSpecular = getRectLightSpecular();\n\t\t\t\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\t\t\t\t\tareaLightSpecular = getDiskLightSpecular();\n\t\t\t\t\t\t\t\t} else { // sphere\n\t\t\t\t\t\t\t\t\t\tareaLightSpecular = getSphereLightSpecular();\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * dAtten * light.color * dAtten3;\n\n\t\t\t\t\t\t\t\t#ifdef CLUSTER_CLEAR_COAT\n\n\t\t\t\t\t\t\t\t\t\t// area light specular clear coat\n\t\t\t\t\t\t\t\t\t\tfloat areaLightSpecularCC;\n\n\t\t\t\t\t\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\t\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecularCC();\n\t\t\t\t\t\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\t\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecularCC();\n\t\t\t\t\t\t\t\t\t\t} else { // sphere\n\t\t\t\t\t\t\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecularCC();\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * dAtten * light.color\t* dAtten3;\n\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t} else\n\n\t\t\t\t#endif\n\n\t\t\t\t{\t\t// punctual light\n\n\t\t\t\t\t\t// punctual light diffuse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvec3 punctualDiffuse = dAtten * light.color * dAtten3;\n\n\t\t\t\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\t\t\t#if defined(CLUSTER_SPECULAR)\n\t\t\t\t\t\t\t\t#if defined(CLUSTER_CONSERVE_ENERGY)\n\t\t\t\t\t\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), dSpecularity);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t\t\t\t}\n\t \n\t\t\t\t\t\t// specular and clear coat are material settings and get included by a define based on the material\n\t\t\t\t\t\t#ifdef CLUSTER_SPECULAR\n\n\t\t\t\t\t\t\t\t// specular\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tvec3 punctualSpecular = getLightSpecular() * dAtten * light.color * dAtten3;\n\n\t\t\t\t\t\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\t\t\t\t\t\t\tpunctualSpecular *= dSpecularity;\n\t\t\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t\t\tdSpecularLight += punctualSpecular;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t#ifdef CLUSTER_CLEAR_COAT\n\n\t\t\t\t\t\t\t\t\t\tvec3 punctualCC = getLightSpecularCC() * dAtten * light.color * dAtten3;\n\n\t\t\t\t\t\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\t\t\t\t\t\t\tpunctualCC *= ccSpecularity;\n\t\t\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t\t\tccSpecularLight += punctualCC;\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t}\n}\n\nvoid evaluateClusterLight(float lightIndex) {\n\n\t\t// decode core light data from textures\n\t\tClusterLightData clusterLightData;\n\t\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\n\t\t// evaluate light if it uses accepted light mask\n\t\tif (acceptLightMask(clusterLightData))\n\t\t\t\tevaluateLight(clusterLightData);\n}\n\nvoid addClusteredLights() {\n\t\t// world space position to 3d integer cell cordinates in the cluster structure\n\t\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\n\t\t// no lighting when cell coordinate is out of range\n\t\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\n\t\t\t\t// cell index (mapping from 3d cell coordinates to linear memory)\n\t\t\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\n\t\t\t\t// convert cell index to uv coordinates\n\t\t\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\t\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\t\t\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\n\t\t\t\t// loop over maximum possible number of supported light cells\n\t\t\t\tconst float maxLightCells = 256.0 / 4.0;\t// 8 bit index, each stores 4 lights\n\t\t\t\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\n\t\t\t\t\t\tvec4 lightIndices = textureData(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));\n\t\t\t\t\t\tvec4 indices = lightIndices * 255.0;\n\n\t\t\t\t\t\t// evaluate up to 4 lights. This is written using a loop instead of manually unrolling to keep shader compile time smaller\n\t\t\t\t\t\tfor (int i = 0; i < 4; i++) {\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tif (indices.x <= 0.0)\n\t\t\t\t\t\t\t\t\t\treturn;\n\n\t\t\t\t\t\t\t\tevaluateClusterLight(indices.x); \n\t\t\t\t\t\t\t\tindices = indices.yzwx;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// end of the cell array\n\t\t\t\t\t\tif (lightCellIndex > clusterPixelsPerCell) {\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n}\n",combineClearCoatPS:"\nvec3 combineColorCC() {\n\t\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"\nvec3 combineColor() {\n\t\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"\nvec3 combineColor() {\n\t\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"\nvec3 combineColor() {\n\t\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"\nvec3 combineColor() {\n\t\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"\nuniform vec3 material_ambient;\n\nvec3 combineColor() {\n\t\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"\nvec3 combineColor() {\n\t\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",cookiePS:"\n// light cookie functionality for non-clustered lights\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\t\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\tprojPos.xy += cookieOffset;\n\t\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\t\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\tprojPos.xy += cookieOffset;\n\t\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\t\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\t\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\t\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"\nuniform vec3 envBoxMin, envBoxMax;\n\nvec3 cubeMapProject(vec3 nrdir) {\n\t\tnrdir = cubeMapRotate(nrdir);\n\n\t\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\t\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\n\t\tvec3 rbminmax;\n\t\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\t\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\t\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\n\t\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\n\t\tvec3 posonbox = vPositionW + nrdir * fa;\n\t\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\t\treturn normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"\nvec3 cubeMapProject(vec3 dir) {\n\t\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\n\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\t\treturn refDir * cubeMapRotationMatrix;\n#else\n\t\treturn refDir;\n#endif\n}\n",detailModesPS:"\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\t\treturn c1 * c2;\n}\n\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\t\treturn c1 + c2;\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Screen\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\t\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Overlay\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\t\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\n\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\t\treturn min(c1, c2);\n}\n\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\t\treturn max(c1, c2);\n}\n",diffusePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\n\nvoid getAlbedo() {\n\t\tdAlbedo = vec3(1.0);\n\n\t\t#ifdef MAPCOLOR\n\t\tdAlbedo *= material_diffuse.rgb;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV, textureBias).$CH));\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t\t#endif\n}\n",diffuseDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\n\nvec3 addAlbedoDetail(vec3 albedo) {\n\t\t#ifdef MAPTEXTURE\n\t\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV, textureBias).$CH);\n\t\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t\t#else\n\t\treturn albedo;\n\t\t#endif\n}\n",dilatePS:"\n#define SHADER_NAME Dilate\n\nvarying vec2 vUv0;\n\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\nvoid main(void) {\n\t\tvec4 c = texture2D(source, vUv0);\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\t\tgl_FragColor = c;\n}\n",bilateralDeNoisePS:"\n// bilateral filter, based on https://www.shadertoy.com/view/4dfGDH# and\n// http://people.csail.mit.edu/sparis/bf_course/course_notes.pdf\n\n// A bilateral filter is a non-linear, edge-preserving, and noise-reducing smoothing filter for images.\n// It replaces the intensity of each pixel with a weighted average of intensity values from nearby pixels.\n// This weight can be based on a Gaussian distribution. Crucially, the weights depend not only on\n// Euclidean distance of pixels, but also on the radiometric differences (e.g., range differences, such\n// as color intensity, depth distance, etc.). This preserves sharp edges.\n\n#define SHADER_NAME BilateralDeNoise\n\nfloat normpdf3(in vec3 v, in float sigma) {\n\t\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\n\nvec3 decodeRGBM(vec4 rgbm) {\n\t\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\t\treturn color * color;\n}\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n\t\tvec4 encoded;\n\t\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\t\tencoded.rgb *= 1.0 / 8.0;\n\n\t\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\t\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\n\t\tencoded.rgb /= encoded.a;\n\t\treturn encoded;\n}\n\n// filter size\n#define MSIZE 15\n\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\n\nvoid main(void) {\n\t\t\n\t\tvec4 pixelRgbm = texture2D(source, vUv0);\n\n\t\t// lightmap specific optimization - skip pixels that were not baked\n\t\t// this also allows dilate filter that work on the output of this to work correctly, as it depends on .a being zero\n\t\t// to dilate, which the following blur filter would otherwise modify\n\t\tif (pixelRgbm.a <= 0.0) {\n\t\t\t\tgl_FragColor = pixelRgbm;\n\t\t\t\treturn ;\n\t\t}\n\n\t\t// range sigma - controls blurriness based on a pixel distance\n\t\tfloat sigma = sigmas.x;\n\n\t\t// domain sigma - controls blurriness based on a pixel similarity (to preserve edges)\n\t\tfloat bSigma = sigmas.y;\n\n\t\tvec3 pixelHdr = decodeRGBM(pixelRgbm);\n\t\tvec3 accumulatedHdr = vec3(0.0);\n\t\tfloat accumulatedFactor = 0.0;\n\n\t\t// read out the texels\n\t\tconst int kSize = (MSIZE-1)/2;\n\t\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\t\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\t\t\t\t\n\t\t\t\t\t\t// sample the pixel with offset\n\t\t\t\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\t\t\t\tvec4 rgbm = texture2D(source, coord);\n\n\t\t\t\t\t\t// lightmap - only use baked pixels\n\t\t\t\t\t\tif (rgbm.a > 0.0) {\n\t\t\t\t\t\t\t\tvec3 hdr = decodeRGBM(rgbm);\n\n\t\t\t\t\t\t\t\t// bilateral factors\n\t\t\t\t\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\t\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\n\t\t\t\t\t\t\t\t// accumulate\n\t\t\t\t\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\t\t\t\t\taccumulatedFactor += factor;\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\n\t\tgl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);\n}\n",decodePS:"\nvec3 decodeLinear(vec4 raw) {\n\t\treturn raw.rgb;\n}\n\nvec3 decodeGamma(vec4 raw) {\n\t\treturn pow(raw.xyz, vec3(2.2));\n}\n\nvec3 decodeRGBM(vec4 raw) {\n\t\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\t\treturn color * color;\n}\n\nvec3 decodeRGBE(vec4 raw) {\n\t\tif (raw.a == 0.0) {\n\t\t\t\treturn vec3(0.0, 0.0, 0.0);\n\t\t} else {\n\t\t\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t\t}\n}\n\nconst float PI = 3.141592653589793;\n\nvec2 toSpherical(vec3 dir) {\n\t\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\n\nvec2 toSphericalUv(vec3 dir) {\n\t\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn vec2(uv.x, 1.0 - uv.y);\n}\n\n// equirectangular helper functions\n\n// envAtlas is fixed at 512 pixels. every equirect is generated with 1 pixel boundary.\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\n\n// map a normalized equirect UV to the given rectangle (taking 1 pixel seam into account).\nvec2 mapUv(vec2 uv, vec4 rect) {\n\t\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\t\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\n\n// map a normalized equirect UV and roughness level to the correct atlas rect.\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\t\tfloat t = 1.0 / exp2(level);\n\t\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\n\n// \nvec2 mapMip(vec2 uv, float level) {\n\t\tfloat t = 1.0 / exp2(level);\n\t\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",emissivePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\n\nvec3 getEmission() {\n\t\tvec3 emission = vec3(1.0);\n\n\t\t#ifdef MAPFLOAT\n\t\temission *= material_emissiveIntensity;\n\t\t#endif\n\n\t\t#ifdef MAPCOLOR\n\t\temission *= material_emissive;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t\t#endif\n\n\t\treturn emission;\n}\n",endPS:"\n\t\t#ifdef CLEARCOAT\n\t\tgl_FragColor.rgb = combineColorCC();\n\t\t#else\n\t\tgl_FragColor.rgb = combineColor();\n\t\t#endif \n\n\t\tgl_FragColor.rgb += getEmission();\n\t\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\n\t\t#ifndef HDR\n\t\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\t\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t\t#endif\n",endVS:"\n",envConstPS:"\nvec3 processEnvironment(vec3 color) {\n\t\treturn color;\n}\n",envMultiplyPS:"\nuniform float skyboxIntensity;\n\nvec3 processEnvironment(vec3 color) {\n\t\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius) {\n\t\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\t\tfloat invRadius = 1.0 / lightRadius;\n\t\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\n\nfloat getFalloffInvSquared(float lightRadius) {\n\t\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\t\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\t\tfloat invRadius = 1.0 / lightRadius;\n\n\t\tfalloff *= 16.0;\n\t\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n\t\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius) {\n\t\tfloat d = length(dLightDirW);\n\t\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n\t\treturn vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n\t\treturn vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\t\treturn vec;\n}\n\nvec3 calcSeam(vec3 vec) {\n\t\treturn vec3(0);\n}\n\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\t\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\t\tfloat M = max(max(avec.x, avec.y), avec.z);\n\t\tif (avec.x != M) vec.x *= scale;\n\t\tif (avec.y != M) vec.y *= scale;\n\t\tif (avec.z != M) vec.z *= scale;\n\t\treturn vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat scale = 1.0 - 1.0 / 128.0;\n\t\tfloat M = max(max(avec.x, avec.y), avec.z);\n\t\tif (avec.x != M) vec.x *= scale;\n\t\tif (avec.y != M) vec.y *= scale;\n\t\tif (avec.z != M) vec.z *= scale;\n\t\treturn vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat scale = invRecMipSize;\n\t\tfloat M = max(max(avec.x, avec.y), avec.z);\n\t\tif (avec.x != M) vec.x *= scale;\n\t\tif (avec.y != M) vec.y *= scale;\n\t\tif (avec.z != M) vec.z *= scale;\n\t\treturn vec;\n}\n\nvec3 calcSeam(vec3 vec) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat M = max(avec.x, max(avec.y, avec.z));\n\t\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\t\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\t\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\n\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\t\treturn vec * (seam * -scale + vec3(1.0));\n}\n",floatUnpackingPS:"\n// float unpacking functionality, complimentary to float-packing.js\nfloat bytes2float2(vec2 data) {\n\t\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\n\nfloat bytes2float3(vec3 data) {\n\t\treturn dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\n\nfloat bytes2float4(vec4 data) {\n\t\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n\t\treturn mix(min, max, bytes2float2(data));\n}\n\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n\t\treturn mix(min, max, bytes2float3(data));\n}\n\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n\t\treturn mix(min, max, bytes2float4(data));\n}\n\nfloat mantissaExponent2Float(vec4 pack)\n{\n\t\tfloat value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n\t\tfloat exponent = floor(pack.w * 255.0 - 127.0);\n\t\treturn value * exp2(exponent);\n}\n",fogExpPS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t\tfloat fogFactor = exp(-depth * fog_density);\n\t\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\t\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"\nuniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\t\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\treturn color;\n}\n",fresnelSchlickPS:"\n// Schlick's approximation\nuniform float material_fresnelFactor; // unused\n\nvoid getFresnel() {\n\t\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\t\tfloat fresnel2 = fresnel * fresnel;\n\t\tfresnel *= fresnel2 * fresnel2;\n\t\tfresnel *= dGlossiness * dGlossiness;\n\t\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\n\t\t#ifdef CLEARCOAT\n\t\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\t\tfresnel2 = fresnel * fresnel;\n\t\tfresnel *= fresnel2 * fresnel2;\n\t\tfresnel *= ccGlossiness * ccGlossiness;\n\t\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t\t#endif\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n\t\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\t\treturn texture2D(tex, uv);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\t\treturn texture2D(tex, uv, bias);\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\t\treturn textureCube(tex, uvw);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n\t\treturn color;\n}\n\nfloat gammaCorrectInput(float color) {\n\t\treturn color;\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n\t\treturn color;\n}\n",gamma2_2PS:"\nvec3 gammaCorrectInput(vec3 color) {\n\t\treturn pow(color, vec3(2.2));\n}\n\nfloat gammaCorrectInput(float color) {\n\t\treturn pow(color, 2.2);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n\t\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\t\tvec4 rgba = texture2D(tex, uv);\n\t\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\t\treturn rgba;\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\t\tvec4 rgba = texture2D(tex, uv, bias);\n\t\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\t\treturn rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\t\tvec4 rgba = textureCube(tex, uvw);\n\t\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\t\treturn rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n\t\t#ifdef HDR\n\t\treturn color;\n\t\t#else\n\t\tcolor += vec3(0.0000001);\n\t\treturn pow(color, vec3(0.45));\n\t\t#endif\n}\n",gles3PS:"\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n#define SUPPORTS_TEXLOD\n",gles3VS:"\n#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"\n#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n\t\tdGlossiness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tdGlossiness *= material_shininess;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdGlossiness *= texture2D(texture_glossMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdGlossiness *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tdGlossiness += 0.0000001;\n}\n",instancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse() {\n\t\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"\nvoid getLightDirPoint(vec3 lightPosW) {\n\t\tdLightDirW = vPositionW - lightPosW;\n\t\tdLightDirNormW = normalize(dLightDirW);\n\t\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"\nuniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\n\nvoid addLightMap() {\n\t\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV, textureBias).$CH;\n\t\tvec3 dir = texture2D(texture_dirLightMap, $UV, textureBias).xyz;\n\t\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\t\t\tdDiffuseLight += color;\n\t\t} else {\n\t\t\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\n\t\t\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\t\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\t\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\n\t\t\t\tdDiffuseLight += color * nlight * 2.0;\n\t\t}\n\n\t\tdSpecularLight += color * getLightSpecular();\n}\n",lightmapSinglePS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\n\nvoid addLightMap() {\n\t\tvec3 lm = vec3(1.0);\n\n\t\t#ifdef MAPTEXTURE\n\t\tlm *= $texture2DSAMPLE(texture_lightMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tlm *= saturate(vVertexColor.$VC);\n\t\t#endif\n\t\t\n\t\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"\nvoid addLightMap() {\n\t\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\n// Anisotropic GGX\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\t\tfloat PI = 3.141592653589793;\n\t\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\t\tfloat anisotropy = material_anisotropy * roughness;\n \n\t\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\t\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\n\t\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\n\t\tfloat NoH = dot(tNormalW, h);\n\t\tfloat ToH = dot(dTBN[0], h);\n\t\tfloat BoH = dot(dTBN[1], h);\n\n\t\tfloat a2 = at * ab;\n\t\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\t\tfloat v2 = dot(v, v);\n\t\tfloat w2 = a2 / v2;\n\t\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\n\t\tfloat ToV = dot(dTBN[0], dViewDirW);\n\t\tfloat BoV = dot(dTBN[1], dViewDirW);\n\t\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\t\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\t\tfloat NoV = dot(tNormalW, dViewDirW);\n\t\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\n\t\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\t\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\t\tfloat G = 0.5 / (lambdaV + lambdaL);\n\n\t\treturn D * G;\n}\n\nfloat getLightSpecular() {\n\t\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\n\nfloat getLightSpecularCC() {\n\t\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"\n// Energy-conserving (hopefully) Blinn-Phong\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\t\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\t\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\n\t\tfloat specPow = exp2(tGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n\t\tspecPow = antiAliasGlossiness(specPow);\n\n\t\t// Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n\t\tspecPow = max(specPow, 0.0001);\n\n\t\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\nfloat getLightSpecular() {\n\t\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\n\nfloat getLightSpecularCC() {\n\t\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\t\tfloat specPow = tGlossiness;\n\n\t\tspecPow = antiAliasGlossiness(specPow);\n\n\t\t// Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n\t\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n\nfloat getLightSpecular() {\n\t\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\n\nfloat getLightSpecularCC() {\n\t\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:'\n// Real-Time Polygonal-Light Shading with Linearly Transformed Cosines\n// by Eric Heitz, Jonathan Dupuy, Stephen Hill and David Neubelt\n// code: https://github.com/selfshadow/ltc_code/\n\nmat3 transposeMat3( const in mat3 m ) {\n\t\tmat3 tmp;\n\t\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\t\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\t\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\t\treturn tmp;\n}\n\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\t\tconst float LUT_SIZE = 64.0;\n\t\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\t\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\t\tfloat dotNV = saturate( dot( N, V ) );\n\t\t// texture parameterized by sqrt( GGX alpha ) and sqrt( 1 - cos( theta ) )\n\t\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\t\tuv = uv * LUT_SCALE + LUT_BIAS;\n\t\treturn uv;\n}\n\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\t\t// Real-Time Area Lighting: a Journey from Research to Production (p.102)\n\t\t// An approximation of the form factor of a horizon-clipped rectangle.\n\t\tfloat l = length( f );\n\t\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\n\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\t\tfloat x = dot( v1, v2 );\n\t\tfloat y = abs( x );\n\t\t// rational polynomial approximation to theta / sin( theta ) / 2PI\n\t\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\t\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\t\tfloat v = a / b;\n\t\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\t\treturn cross( v1, v2 ) * theta_sintheta;\n}\n\nstruct Coords {\n\t\tvec3 coord0;\n\t\tvec3 coord1;\n\t\tvec3 coord2;\n\t\tvec3 coord3;\n};\n\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\t\t// bail if point is on back side of plane of light\n\t\t// assumes ccw winding order of light vertices\n\t\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\t\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\t\n\t\tvec3 lightNormal = cross( v1, v2 );\n\t\t// if( dot( lightNormal, P - rectCoords.coord0 ) < 0.0 ) return 0.0;\n\t\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\n\t\t// construct orthonormal basis around N\n\t\tvec3 T1, T2;\n\t\tT1 = normalize( V - N * dot( V, N ) );\n\t\tT2 =\tfactor * cross( N, T1 ); // negated from paper; possibly due to a different handedness of world coordinate system\n\t\t// compute transform\n\t\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\t\t// transform rect\n\t\tvec3 coords[ 4 ];\n\t\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\t\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\t\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\t\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\t\t// project rect onto sphere\n\t\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\t\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\t\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\t\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\t\t// calculate vector form factor\n\t\tvec3 vectorFormFactor = vec3( 0.0 );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\t\t// adjust for horizon clipping\n\t\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\n\t\treturn result;\n}\n\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\t\tCoords coords;\n\t\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\t\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\t\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\t\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\t\treturn coords;\n}\n\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\t\t// used for simple sphere light falloff\n\t\t// also, the code only handles a spherical light, it cannot be non-uniformly scaled in world space, and so we enforce it here\n\t\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\n\t\t// Billboard the 2d light quad to reflection vector, as it\'s used for specular. This allows us to use disk math for the sphere.\n\t\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\t\tvec3 w = normalize(cross(f, halfHeight));\n\t\tvec3 h = normalize(cross(f, w));\n\n\t\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\n\n// used for LTC LUT texture lookup\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\t\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\t\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\n\n//used for energy conservation and to modulate specular\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\t\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\n\t\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\t\tt2 *= vec4(0.693103,1,1,1);\n\t\tt2 += vec4(0.306897,0,0,0);\n\t\t#endif\n\n\t\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\n\nvoid calcLTCLightValues()\n{\n\t\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\t\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres); \n\n#ifdef CLEARCOAT\n\t\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\t\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularityNoFres));\n#endif\n}\n\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\t\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\t\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\t\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\n\n// An extended version of the implementation from\n// "How to solve a cubic equation, revisited"\n// http://momentsingraphics.de/?p=105\nvec3 SolveCubic(vec4 Coefficient)\n{\n\t\tfloat pi = 3.14159;\n\t\t// Normalize the polynomial\n\t\tCoefficient.xyz /= Coefficient.w;\n\t\t// Divide middle coefficients by three\n\t\tCoefficient.yz /= 3.0;\n\n\t\tfloat A = Coefficient.w;\n\t\tfloat B = Coefficient.z;\n\t\tfloat C = Coefficient.y;\n\t\tfloat D = Coefficient.x;\n\n\t\t// Compute the Hessian and the discriminant\n\t\tvec3 Delta = vec3(\n\t\t\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\t\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t\t);\n\n\t\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\n\t\tvec3 RootsA, RootsD;\n\n\t\tvec2 xlc, xsc;\n\n\t\t// Algorithm A\n\t\t{\n\t\t\t\tfloat A_a = 1.0;\n\t\t\t\tfloat C_a = Delta.x;\n\t\t\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\n\t\t\t\t// Take the cubic root of a normalized complex number\n\t\t\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\n\t\t\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\t\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\n\t\t\t\tfloat xl;\n\t\t\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\t\t\t\txl = x_1a;\n\t\t\t\telse\n\t\t\t\t\t\txl = x_3a;\n\n\t\t\t\txlc = vec2(xl - B, A);\n\t\t}\n\n\t\t// Algorithm D\n\t\t{\n\t\t\t\tfloat A_d = D;\n\t\t\t\tfloat C_d = Delta.z;\n\t\t\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\n\t\t\t\t// Take the cubic root of a normalized complex number\n\t\t\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\n\t\t\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\t\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\n\t\t\t\tfloat xs;\n\t\t\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\t\t\t\txs = x_1d;\n\t\t\t\telse\n\t\t\t\t\t\txs = x_3d;\n\n\t\t\t\txsc = vec2(-D, xs + C);\n\t\t}\n\n\t\tfloat E =\txlc.y * xsc.y;\n\t\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\t\tfloat G =\txlc.x * xsc.x;\n\n\t\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\n\t\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\n\t\tif (Root.x < Root.y && Root.x < Root.z)\n\t\t\t\tRoot.xyz = Root.yxz;\n\t\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\t\t\tRoot.xyz = Root.xzy;\n\n\t\treturn Root;\n}\n\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\t\t// construct orthonormal basis around N\n\t\tvec3 T1, T2;\n\t\tT1 = normalize(V - N * dot(V, N));\n\t\tT2 = cross(N, T1);\n\n\t\t// rotate area light in (T1, T2, N) basis\n\t\t//mat3 R = transpose(mat3(T1, T2, N));\n\t\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\t\t// polygon (allocate 5 vertices for clipping)\n\t\tvec3 L_[ 3 ];\n\t\tL_[ 0 ] = R * ( points.coord0 - P );\n\t\tL_[ 1 ] = R * ( points.coord1 - P );\n\t\tL_[ 2 ] = R * ( points.coord2 - P );\n\n\t\tvec3 Lo_i = vec3(0);\n\n\t\t// init ellipse\n\t\tvec3 C\t= 0.5 * (L_[0] + L_[2]);\n\t\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\t\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\n\t\tC\t= Minv * C;\n\t\tV1 = Minv * V1;\n\t\tV2 = Minv * V2;\n\n\t\t//if(dot(cross(V1, V2), C) > 0.0)\n\t\t//\t\treturn 0.0;\n\n\t\t// compute eigenvectors of ellipse\n\t\tfloat a, b;\n\t\tfloat d11 = dot(V1, V1);\n\t\tfloat d22 = dot(V2, V2);\n\t\tfloat d12 = dot(V1, V2);\n\t\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t\t{\n\t\t\t\tfloat tr = d11 + d22;\n\t\t\t\tfloat det = -d12 * d12 + d11 * d22;\n\n\t\t\t\t// use sqrt matrix to solve for eigenvalues\n\t\t\t\tdet = sqrt(det);\n\t\t\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\t\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\t\t\tfloat e_max = (u + v) * (u + v);\n\t\t\t\tfloat e_min = (u - v) * (u - v);\n\n\t\t\t\tvec3 V1_, V2_;\n\n\t\t\t\tif (d11 > d22)\n\t\t\t\t{\n\t\t\t\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\t\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\t\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t\t\t}\n\n\t\t\t\ta = 1.0 / e_max;\n\t\t\t\tb = 1.0 / e_min;\n\t\t\t\tV1 = normalize(V1_);\n\t\t\t\tV2 = normalize(V2_);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t\ta = 1.0 / dot(V1, V1);\n\t\t\t\tb = 1.0 / dot(V2, V2);\n\t\t\t\tV1 *= sqrt(a);\n\t\t\t\tV2 *= sqrt(b);\n\t\t}\n\n\t\tvec3 V3 = cross(V1, V2);\n\t\tif (dot(C, V3) < 0.0)\n\t\t\t\tV3 *= -1.0;\n\n\t\tfloat L\t= dot(V3, C);\n\t\tfloat x0 = dot(V1, C) / L;\n\t\tfloat y0 = dot(V2, C) / L;\n\n\t\tfloat E1 = inversesqrt(a);\n\t\tfloat E2 = inversesqrt(b);\n\n\t\ta *= L * L;\n\t\tb *= L * L;\n\n\t\tfloat c0 = a * b;\n\t\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\t\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\t\tfloat c3 = 1.0;\n\n\t\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\t\tfloat e1 = roots.x;\n\t\tfloat e2 = roots.y;\n\t\tfloat e3 = roots.z;\n\n\t\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\n\t\tmat3 rotate = mat3(V1, V2, V3);\n\n\t\tavgDir = rotate * avgDir;\n\t\tavgDir = normalize(avgDir);\n\n\t\tfloat L1 = sqrt(-e2 / e3);\n\t\tfloat L2 = sqrt(-e2 / e1);\n\n\t\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\t\t\n\t\tconst float LUT_SIZE = 64.0;\n\t\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\t\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\n\t\t// use tabulated horizon-clipped sphere\n\t\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\t\tuv = uv*LUT_SCALE + LUT_BIAS;\n\n\t\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\n\t\treturn formFactor*scale;\n}\n\nfloat getRectLightDiffuse() {\n\t\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\n\nfloat getDiskLightDiffuse() {\n\t\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\n\nfloat getSphereLightDiffuse() {\n\t\t// NB: this could be improved further with distance based wrap lighting\n\t\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\t\treturn getLightDiffuse()*falloff;\n}\n\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\t\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\n\t\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\t\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\t\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t\t#endif\n\n\t\treturn mat3(\n\t\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\t\tvec3(\t\t0, 1,\t\t0 ),\n\t\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n}\n\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\t\tmat3 mInv = getLTCLightInvMat(uv);\n\t\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\n\nfloat getRectLightSpecular() {\n\t\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\t\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\t\tmat3 mInv = getLTCLightInvMat(uv);\n\t\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\n\nfloat getDiskLightSpecular() {\n\t\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\t\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n\nfloat getSphereLightSpecular() {\n\t\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\t\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n',metalnessPS:"\nvoid processMetalness(float metalness) {\n\t\tconst float dielectricF0 = 0.04;\n\t\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\t\tdAlbedo *= 1.0 - metalness;\n}\n\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\n\nvoid getSpecularity() {\n\t\tfloat metalness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tmetalness *= material_metalness;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tmetalness *= texture2D(texture_metalnessMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tmetalness *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tprocessMetalness(metalness);\n}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\n\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n\n#ifdef GL2\n#define USE_FWIDTH\n#endif\n\nfloat median(float r, float g, float b) {\n\t\treturn max(min(r, g), min(max(r, g), b));\n}\n\nfloat map (float min, float max, float v) {\n\t\treturn (v - min) / (max - min);\n}\n\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;\t\t\t// the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\n\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n\nvec4 applyMsdf(vec4 color) {\n\t\t// sample the field\n\t\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\t\tvec2 uvShdw = vUv0 - shadow_offset;\n\t\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\t\t// get the signed distance value\n\t\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\t\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\n\t\t// smoothing limit - smaller value makes for sharper but more aliased text, especially on angles\n\t\t// too large value (0.5) creates a dark glow around the letters\n\t\tfloat smoothingMax = 0.2;\n\n\t\t#ifdef USE_FWIDTH\n\t\t// smoothing depends on size of texture on screen\n\t\tvec2 w = fwidth(vUv0);\n\t\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\t\t#else\n\t\tfloat font_size = 16.0; // TODO fix this\n\t\t// smoothing gets smaller as the font size gets bigger\n\t\t// don't have fwidth we can approximate from font size, this doesn't account for scaling\n\t\t// so a big font scaled down will be wrong...\n\t\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);\n\t\t#endif\n\n\t\tfloat mapMin = 0.05;\n\t\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\n\t\t// remap to a smaller range (used on smaller font sizes)\n\t\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\t\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\t\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\n\t\tfloat center = 0.5;\n\t\t// calculate smoothing and use to generate opacity\n\t\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\t\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\t\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\n\t\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\t\ttcolor = mix(tcolor, color, inside);\n\n\t\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\t\ttcolor = mix(scolor, tcolor, outline);\n\t\t\n\t\treturn tcolor;\n}\n",normalVS:"\n#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\n\nvec3 getNormal() {\n\t\t#ifdef SKIN\n\t\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t\t#elif defined(INSTANCING)\n\t\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t\t#else\n\t\tdNormalMatrix = matrix_normal;\n\t\t#endif\n\n\t\tvec3 tempNormal = vertex_normal;\n\n\t\t#ifdef MORPHING\n\t\t#ifdef MORPHING_NRM03\n\t\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\t\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\t\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\t\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t\t#endif\n\t\t#ifdef MORPHING_NRM47\n\t\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\t\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\t\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\t\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t\t#endif\n\t\t#endif\n\n\t\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\t\t// apply morph offset from texture\n\t\tvec2 morphUV = getTextureMorphCoords();\n\t\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\t\ttempNormal += morphNormal;\n\t\t#endif\n\n\t\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\n\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\t\t// https://blog.selfshadow.com/publications/blending-in-detail/#detail-oriented\n\t\tn1 += vec3(0, 0, 1);\n\t\tn2 *= vec3(-1, -1, 1);\n\t\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\n\nvec3 addNormalDetail(vec3 normalMap) {\n\t\t#ifdef MAPTEXTURE\n\t\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV, textureBias));\n\t\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\t\treturn blendNormals(normalMap, normalDetailMap);\n\t\t#else\n\t\treturn normalMap;\n\t\t#endif\n}\n",normalInstancedVS:"\nvec3 getNormal() {\n\t\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"\nuniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\n\nvoid getNormal() {\n\t\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV, textureBias));\n\t\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\t\tdNormalMap = addNormalDetail(normalMap);\n\t\tdNormalW = dTBN * dNormalMap;\n}\n",normalMapFastPS:"\nuniform sampler2D texture_normalMap;\n\nvoid getNormal() {\n\t\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV, textureBias));\n\t\tdNormalMap = addNormalDetail(normalMap);\n\t\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"\nvec3 getNormal() {\n\t\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"\nvoid getNormal() {\n\t\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"\nvec3 unpackNormal(vec4 nmap) {\n\t\tvec3 normal;\n\t\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\t\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\t\treturn normal;\n}\n",normalXYZPS:"\nvec3 unpackNormal(vec4 nmap) {\n\t\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"\n#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\n\nvoid getOpacity() {\n\t\tdAlpha = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tdAlpha *= material_opacity;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdAlpha *= texture2D(texture_opacityMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t\t#endif\n}\n",outputAlphaPS:"\ngl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"\ngl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"\ngl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputTex2DPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n\t\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\n// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n\t\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\t\tconst vec4 bit_mask\t= vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n\t\t// combination of mod and multiplication and division works better\n\t\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\t\tres -= res.xxyz * bit_mask;\n\t\treturn res;\n}\n",parallaxPS:"\nuniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\n\nvoid getParallax() {\n\t\tfloat parallaxScale = material_heightMapFactor;\n\n\t\tfloat height = texture2D(texture_heightMap, $UV, textureBias).$CH;\n\t\theight = height * parallaxScale - parallaxScale*0.5;\n\t\tvec3 viewDirT = dViewDirW * dTBN;\n\n\t\tviewDirT.z += 0.42;\n\t\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\tfloat depth = dot(rgbaDepth, bitShift);\n\t\treturn depth;\n}\n#endif\n\nvoid main(void) {\n\t\tvec4 tex\t= texture2DSRGB(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n\t\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\t\tramp.rgb *= colorMult;\n\n\t\tramp.a += texCoordsAlphaLife.z;\n\n\t\tvec3 rgb = tex.rgb * ramp.rgb;\n\t\tfloat a\t= tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n\t\tfloat r = fract(src);\n\t\tfloat g = fract(src * 256.0);\n\t\tfloat b = fract(src * 65536.0);\n\t\treturn vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\t\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\t\tvec4 a = texture2D(tex,tc);\n\t\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\t\tfloat c = fract(tc.x*graphNumSamples);\n\n\t\tvec3 unpackedA = unpack3NFloats(a.w);\n\t\tvec3 unpackedB = unpack3NFloats(b.w);\n\t\tw = mix(unpackedA, unpackedB, c);\n\n\t\treturn mix(a, b, c);\n}\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\t\tfloat c = cos(pRotation);\n\t\tfloat s = sin(pRotation);\n\n\t\tmat2 m = mat2(c, -s, s, c);\n\t\trotMatrix = m;\n\n\t\treturn m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t\t#ifdef SCREEN_SPACE\n\t\t\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t\t#else\n\t\t\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t\t#endif\n\n\t\treturn pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\t\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\t\treturn pos;\n}\n\nvec2 safeNormalize(vec2 v) {\n\t\tfloat l = length(v);\n\t\treturn (l > 1e-06) ? v / l : v;\n}\n\nvoid main(void) {\n\t\tvec3 meshLocalPos = particle_vertexData.xyz;\n\t\tfloat id = floor(particle_vertexData.w);\n\n\t\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\t\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n\t\tfloat uv = id / numParticlesPot;\n\t\treadInput(uv);\n\n#ifdef LOCAL_SPACE\n\t\tinVel = mat3(matrix_model) * inVel;\n#endif\n\t\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n\t\tfloat particleLifetime = lifetime;\n\n\t\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\t\tvec2 quadXY = meshLocalPos.xy;\n\t\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\n\t\tvec3 paramDiv;\n\t\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\t\tfloat scale = params.y;\n\t\tfloat scaleDiv = paramDiv.x;\n\t\tfloat alphaDiv = paramDiv.z;\n\n\t\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n#ifndef USE_MESH\n\t\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\t\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\n\t\tvec3 particlePos = inPos;\n\t\tvec3 particlePosMoved = vec3(0.0);\n\n\t\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\n\t\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n\t\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n\t\tfloat animationIndex;\n\n\t\tif (animTexIndexParams.y == 1.0) {\n\t\t\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t\t} else {\n\t\t\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t\t}\n\n\t\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\t\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\t\tatlasX = fract(atlasX);\n\n\t\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\t\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n\t\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\t\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\n\t\tinPos = tex.xyz;\n\t\tinVel = tex2.xyz;\n\t\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\t\tinShow = tex.w >= 0.0;\n\t\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n\n#define PI2 6.283185307179586\n\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\n\nuniform float maxVel;\n\nfloat decodeFloatRG(vec2 rg) {\n\t\treturn rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat decodeFloatRGBA( vec4 rgba ) {\n\treturn dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\n\nvoid readInput(float uv) {\n\t\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\t\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\t\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\t\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\n\t\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\t\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\n\t\tinVel = tex2.xyz;\n\t\tinVel = (inVel - vec3(0.5)) * maxVel;\n\n\t\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\t\tinShow = tex2.a > 0.5;\n\n\t\tinLife = decodeFloatRGBA(tex3);\n\t\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\t\tfloat maxPosLife = lifetime+1.0;\n\t\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n\t\tif (gl_FragCoord.y<1.0) {\n\t\t\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t\t} else {\n\t\t\t\tgl_FragColor = vec4(outVel, outLife);\n\t\t}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\n\nvec2 encodeFloatRG( float v ) {\n\t\tvec2 enc = vec2(1.0, 255.0) * v;\n\t\tenc = fract(enc);\n\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\t\treturn enc;\n}\n\nvec4 encodeFloatRGBA( float v ) {\n\t\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\t\tenc = fract(enc);\n\t\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t\treturn enc;\n}\n\nvoid writeOutput() {\n\t\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\t\toutAngle = fract(outAngle / PI2);\n\n\t\toutVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n\n\t\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\t\tfloat maxPosLife = lifetime+1.0;\n\t\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\n\t\tif (gl_FragCoord.y < 1.0) {\n\t\t\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t\t} else if (gl_FragCoord.y < 2.0) {\n\t\t\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t\t} else if (gl_FragCoord.y < 3.0) {\n\t\t\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t\t} else {\n\t\t\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t\t}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\n\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\t\tvec3 pos = inBounds - vec3(0.5);\n\n\t\tvec3 posAbs = abs(pos);\n\t\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\n\t\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\n\t\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\t\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\t\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n\n#ifndef LOCAL_SPACE\n\t\treturn emitterPos + spawnBounds * pos;\n#else\n\t\treturn spawnBounds * pos;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\t\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n\t\twriteOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\n\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\n\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\n\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\n\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n\t\tif (outLife >= lifetime) {\n\t\t\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\t\t\tvisMode = -1.0;\n\t\t}\n",particleUpdaterOnStopPS:"\n\t\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n\t\tif (outLife >= lifetime) {\n\t\t\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\t\t\tvisMode = 1.0;\n\t\t}\n\t\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\n\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\t\tfloat rnd4 = fract(rndFactor * 1000.0);\n\t\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\t\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\t\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\t\treturn norm * r * spawnBoundsSphere;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\t\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n\t\tfloat r = fract(src);\n\t\tfloat g = fract(src * 256.0);\n\t\tfloat b = fract(src * 65536.0);\n\t\treturn vec3(r, g, b);\n}\n\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\t\tvec4 a = texture2D(tex, tc);\n\t\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\t\tfloat c = fract(tc.x * graphNumSamples);\n\n\t\tvec3 unpackedA = unpack3NFloats(a.w);\n\t\tvec3 unpackedB = unpack3NFloats(b.w);\n\t\tw = mix(unpackedA, unpackedB, c);\n\n\t\treturn mix(a.xyz, b.xyz, c);\n}\n\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\t\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\t\tp4 += dot(p4, p4.wzxy+19.19);\n\t\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\n\nvoid main(void) {\n\t\tif (gl_FragCoord.x > numParticles) discard;\n\n\t\treadInput(vUv0.x);\n\t\tvisMode = inShow? 1.0 : -1.0;\n\n\t\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\n\t\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\n\t\toutLife = inLife + delta;\n\t\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\n\t\tvec3 localVelocityDiv;\n\t\tvec3 velocityDiv;\n\t\tvec3 paramDiv;\n\t\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\t\tvec3 velocity =\t\t\ttex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\t\tvec3 params =\t\t\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\t\tfloat rotSpeed = params.x;\n\t\tfloat rotSpeedDiv = paramDiv.y;\n\n\t\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\t\tfloat radialSpeed = radialParams.x;\n\t\tfloat radialSpeedDiv = radialParams.y;\n\n\t\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\t\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\t\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n\n#ifndef LOCAL_SPACE\n\t\tvec3 radialVel = inPos - emitterPos;\n#else\n\t\tvec3 radialVel = inPos;\n#endif\n\t\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\t\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\n\t\tlocalVelocity +=\t\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\t\tvelocity +=\t\t\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\t\trotSpeed +=\t\t\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\n\t\taddInitialVelocity(localVelocity, rndFactor.xyz);\n\n#ifndef LOCAL_SPACE\n\t\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\t\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\n\t\toutPos = inPos + outVel * delta;\n\t\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n\t\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\t\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n\t\tdBlendModeFogFactor = 0.0;\n\t\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\t\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n\t\trgb = mix(vec3(1.0), rgb, vec3(a));\n\t\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n\t\tif (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;\t // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;\t// X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;\t// XYZ = particle local pos, W = velocity.y\nattribute float particle_vertexData4; // particle id\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5; // VDATA4TYPE depends on useMesh property. Start with X = velocity.z, Y = particle ID and for mesh particles proceeds with Z = mesh UV.x, W = mesh UV.y\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\n\nvarying vec4 texCoordsAlphaLife;\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\t\tfloat c = cos(pRotation);\n\t\tfloat s = sin(pRotation);\n\t\t//vec4 rotationMatrix = vec4(c, -s, s, c);\n\n\t\tmat2 m = mat2(c, -s, s, c);\n\t\trotMatrix = m;\n\n\t\treturn m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t\treturn pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\t\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\t\treturn pos;\n}\n\nvoid main(void)\n{\n\t\tvec3 particlePos = particle_vertexData.xyz;\n\t\tvec3 inPos = particlePos;\n\t\tvec3 vertPos = particle_vertexData3.xyz;\n\t\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\n\t\tfloat id = floor(particle_vertexData4);\n\t\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\t\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n#ifdef LOCAL_SPACE\n\t\tinVel = mat3(matrix_model) * inVel;\n#endif\n\t\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n\t\tvec2 quadXY = vertPos.xy;\n\n#ifdef USE_MESH\n\t\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\t\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\t\tmat2 rotMatrix;\n\n\t\tfloat inAngle = particle_vertexData2.x;\n\t\tvec3 particlePosMoved = vec3(0.0);\n\t\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n\t\tlocalPos *= particle_vertexData2.y * emitterScale;\n\t\tlocalPos += particlePos;\n\n\t\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n\t\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\t\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n\t\trgb = addFog(rgb);\n\t\trgb = toneMap(rgb);\n\t\trgb = gammaCorrectOutput(rgb);\n\t\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n\t\tlocalPos *= scale * emitterScale;\n\t\tlocalPos += particlePos;\n\n\t\t#ifdef SCREEN_SPACE\n\t\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t\t#else\n\t\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t\t#endif\n",particle_halflambertPS:"\n\t\tvec3 negNormal = normal*0.5+0.5;\n\t\tvec3 posNormal = -normal*0.5+0.5;\n\t\tnegNormal *= negNormal;\n\t\tposNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n#ifdef USE_MESH\nattribute vec2 particle_uv;\t\t\t\t // mesh UV\n#endif\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n\t\tvec3 negNormal = max(normal, vec3(0.0));\n\t\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n\t\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\t\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\t\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\t\trgb *= light;\n",particle_localShiftVS:"\n\t\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n\t\tvec3 localPos = meshLocalPos;\n\t\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\t\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\n\t\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\n\t\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n\t\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\t\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n\t\tinAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n",particle_softPS:"\n\t\tfloat depth = getLinearScreenDepth();\n\t\tfloat particleDepth = vDepth;\n\t\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\t\ta *= depthDiff;\n",particle_softVS:"\n\t\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n\t\tvec3 moveDir = inVel * stretch;\n\t\tvec3 posPrev = particlePos - moveDir;\n\t\tposPrev += particlePosMoved;\n\n\t\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n\t\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n\t\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n\t\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\t\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n\t\tvec3 origParticlePos = particlePos;\n\t\tparticlePos -= matrix_model[3].xyz;\n\t\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\t\tparticlePos += matrix_model[3].xyz;\n\t\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"\nvoid main(void) {\n\t\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"\nuniform sampler2D source;\n\nvec4 packFloat(float depth) {\n\t\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\t\tconst vec4 bit_mask\t= vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n\t\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\t\tres -= res.xxyz * bit_mask;\n\t\treturn res;\n}\n\nvoid main(void) {\n\t\tfloat c = texture2D(source, vec2(0.0)).r;\n\t\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\t\tgl_FragColor = packFloat(diff);\n}\n",reflDirPS:"\nvoid getReflDir() {\n\t\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"\nvoid getReflDir() {\n\t\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\t\tfloat anisotropy = material_anisotropy * roughness;\n\t\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\t\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\t\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\t\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\t\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\n\nvoid addReflectionCC() {\n\t\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\t\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n\t\tlookupVec.x *= -1.0;\n\t\treturn $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\n\nvoid addReflection() {\t \n\t\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\n\n// calculate mip level for shiny reflection given equirect coords uv.\nfloat shinyMipLevel(vec2 uv) {\n\t\tvec2 dx = dFdx(uv);\n\t\tvec2 dy = dFdy(uv);\n\n\t\t// calculate second dF at 180 degrees\n\t\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\t\tvec2 dx2 = dFdx(uv2);\n\t\tvec2 dy2 = dFdy(uv2);\n\n\t\t// calculate min of both sets of dF to handle discontinuity at the azim edge\n\t\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\n\t\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\t\tvec3 dir = cubeMapProject(tReflDirW) * vec3(-1.0, 1.0, 1.0);\n\t\tvec2 uv = toSphericalUv(dir);\n\n\t\t// calculate roughness level\n\t\tfloat level = saturate(1.0 - tGlossiness) * 5.0;\n\t\tfloat ilevel = floor(level);\n\n\t\t// accessing the shiny (top level) reflection - perform manual mipmap lookup\n\t\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\t\tfloat ilevel2 = floor(level2);\n\n\t\tvec2 uv0, uv1;\n\t\tfloat weight;\n\t\tif (ilevel == 0.0) {\n\t\t\t\tuv0 = mapMip(uv, ilevel2);\n\t\t\t\tuv1 = mapMip(uv, ilevel2 + 1.0);\n\t\t\t\tweight = level2 - ilevel2;\n\t\t} else {\n\t\t\t\t// accessing rough reflection - just sample the same part twice\n\t\t\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\t\t\tweight = 0.0;\n\t\t}\n\n\t\tvec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n\t\tvec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n\t\tvec3 linear0 = mix(linearA, linearB, weight);\n\t\tvec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\n\t\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\n\nvoid addReflection() {\t \n\t\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\t\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\n\t\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\t\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n\t\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\n\nvoid addReflection() {\t \n\t\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\t\tvec3 reflDirV = vNormalV;\n\n\t\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\t\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\n\nvoid addReflection() {\t \n\t\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"\nuniform float material_refraction, material_refractionIndex;\n\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\t\tfloat vn = dot(viewVec, Normal);\n\t\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\t\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\t\treturn refrVec;\n}\n\nvoid addRefraction() {\n\t\t// use same reflection code with refraction vector\n\t\tvec3 tmp = dReflDirW;\n\t\tvec4 tmp2 = dReflection;\n\t\tdReflection = vec4(0.0);\n\t\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\n\t\taddReflection();\n\n\t\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\t\tdReflDirW = tmp;\n\t\tdReflection = tmp2;\n}\n",reprojectPS:'\n// This shader requires the following #DEFINEs:\n//\n// PROCESS_FUNC - must be one of reproject, prefilter\n// DECODE_FUNC - must be one of decodeRGBM, decodeRGBE, decodeGamma or decodeLinear\n// ENCODE_FUNC - must be one of encodeRGBM, encodeRGBE, encideGamma or encodeLinear\n// SOURCE_FUNC - must be one of sampleCubemap, sampleEquirect, sampleOctahedral\n// TARGET_FUNC - must be one of getDirectionCubemap, getDirectionEquirect, getDirectionOctahedral\n//\n// When filtering:\n// NUM_SAMPLES - number of samples\n// NUM_SAMPLES_SQRT - sqrt of number of samples\n//\n// SUPPORTS_TEXLOD - whether supports texlod is supported\n\nvarying vec2 vUv0;\n\n// source\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\n\n// samples\nuniform sampler2D samplesTex;\nuniform vec2 samplesTexInverseSize;\n\n// params:\n// x - target cubemap face 0..6\n// y - specular power (when prefiltering)\n// z - source cubemap seam scale (0 to disable)\n// w - target cubemap size for seam calc (0 to disable)\nuniform vec4 params;\n\n// params2:\n// x - target image total pixels\n// y - source cubemap size\nuniform vec2 params2;\n\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\n\nfloat targetTotalPixels() { return params2.x; }\nfloat sourceTotalPixels() { return params2.y; }\n\nfloat PI = 3.141592653589793;\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\n//-- supported codings\n\nvec3 decodeLinear(vec4 source) {\n\t\treturn source.rgb;\n}\n\nvec4 encodeLinear(vec3 source) {\n\t\treturn vec4(source, 1.0);\n}\n\nvec3 decodeGamma(vec4 source) {\n\t\treturn pow(source.xyz, vec3(2.2));\n}\n\nvec4 encodeGamma(vec3 source) {\n\t\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\n\nvec3 decodeRGBM(vec4 rgbm) {\n\t\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\t\treturn color * color;\n}\n\nvec4 encodeRGBM(vec3 source) { // modified RGBM\n\t\tvec4 result;\n\t\tresult.rgb = pow(source.rgb, vec3(0.5));\n\t\tresult.rgb *= 1.0 / 8.0;\n\n\t\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\t\tresult.a = ceil(result.a * 255.0) / 255.0;\n\n\t\tresult.rgb /= result.a;\n\t\treturn result;\n}\n\nvec3 decodeRGBE(vec4 source) {\n\t\tif (source.a == 0.0) {\n\t\t\t\treturn vec3(0.0, 0.0, 0.0);\n\t\t} else {\n\t\t\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t\t}\n}\n\nvec4 encodeRGBE(vec3 source) {\n\t\tfloat maxVal = max(source.x, max(source.y, source.z));\n\t\tif (maxVal < 1e-32) {\n\t\t\t\treturn vec4(0, 0, 0, 0);\n\t\t} else {\n\t\t\t\tfloat e = ceil(log2(maxVal));\n\t\t\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t\t}\n}\n\n//-- supported projections\n\nvec3 modifySeams(vec3 dir, float scale) {\n\t\tvec3 adir = abs(dir);\n\t\tfloat M = max(max(adir.x, adir.y), adir.z);\n\t\treturn dir / M * vec3(\n\t\t\t\tadir.x == M ? 1.0 : scale,\n\t\t\t\tadir.y == M ? 1.0 : scale,\n\t\t\t\tadir.z == M ? 1.0 : scale\n\t\t);\n}\n\nvec2 toSpherical(vec3 dir) {\n\t\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\n\nvec3 fromSpherical(vec2 uv) {\n\t\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\t\t\t\t\tsin(uv.y),\n\t\t\t\t\t\t\t\tcos(uv.y) * cos(uv.x));\n}\n\nvec3 getDirectionEquirect() {\n\t\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\n\nvec4 sampleEquirect(vec2 sph) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\n\nvec4 sampleEquirect(vec3 dir) {\n\t\treturn sampleEquirect(toSpherical(dir));\n}\n\nvec4 sampleCubemap(vec3 dir) {\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));\n}\n\nvec4 sampleCubemap(vec2 sph) {\n\t\treturn sampleCubemap(fromSpherical(sph));\n}\n\nvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n#ifdef SUPPORTS_TEXLOD\n\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\n\nvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n}\n\nvec4 sampleCubemap(vec3 dir, float mipLevel) {\n#ifdef SUPPORTS_TEXLOD\n\t\treturn textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);\n#else\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()));\n#endif\n}\n\nvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n}\n\n// octahedral code, based on http://jcgt.org/published/0003/02/01\n// "Survey of Efficient Representations for Independent Unit Vectors" by Cigolle, Donow, Evangelakos, Mara, McGuire, Meyer\n\nfloat signNotZero(float k){\n\t\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\n\nvec2 signNotZero(vec2 v) {\n\t\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\n\n// Returns a unit vector. Argument o is an octahedral vector packed via octEncode, on the [-1, +1] square\nvec3 octDecode(vec2 o) {\n\t\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\t\tif (v.y < 0.0) {\n\t\t\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t\t}\n\t\treturn normalize(v);\n}\n\nvec3 getDirectionOctahedral() {\n\t\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\n\n// Assumes that v is a unit vector. The result is an octahedral vector on the [-1, +1] square\nvec2 octEncode(in vec3 v) {\n\t\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\t\tvec2 result = v.xz * (1.0 / l1norm);\n\t\tif (v.y < 0.0) {\n\t\t\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t\t}\n\t\treturn result;\n}\n\nvec4 sampleOctahedral(vec3 dir) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\n\nvec4 sampleOctahedral(vec2 sph) {\n\t\treturn sampleOctahedral(fromSpherical(sph));\n}\n\nvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n#ifdef SUPPORTS_TEXLOD\n\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\n\nvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n}\n\n/////////////////////////////////////////////////////////////////////\n\nvec3 getDirectionCubemap() {\n\t\tvec2 st = vUv0 * 2.0 - 1.0;\n\t\tfloat face = targetFace();\n\n\t\tvec3 vec;\n\t\tif (face == 0.0) {\n\t\t\t\tvec = vec3(1, -st.y, -st.x);\n\t\t} else if (face == 1.0) {\n\t\t\t\tvec = vec3(-1, -st.y, st.x);\n\t\t} else if (face == 2.0) {\n\t\t\t\tvec = vec3(st.x, 1, st.y);\n\t\t} else if (face == 3.0) {\n\t\t\t\tvec = vec3(st.x, -1, -st.y);\n\t\t} else if (face == 4.0) {\n\t\t\t\tvec = vec3(st.x, -st.y, 1);\n\t\t} else {\n\t\t\t\tvec = vec3(-st.x, -st.y, -1);\n\t\t}\n\n\t\treturn normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n\t\tfloat a = 1.0 / (1.0 + n.z);\n\t\tfloat b = -n.x * n.y * a;\n\t\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\t\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\t\treturn mat3(b1, b2, n);\n}\n\nmat3 matrixFromVectorSlow(vec3 n) {\n\t\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\t\tvec3 x = normalize(cross(up, n));\n\t\tvec3 y = cross(n, x);\n\t\treturn mat3(x, y, n);\n}\n\nvec4 reproject() {\n\t\tif (NUM_SAMPLES <= 1) {\n\t\t\t\t// single sample\n\t\t\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t\t} else {\n\t\t\t\t// multi sample\n\t\t\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\t\t\tvec2 sphu = dFdx(sph);\n\t\t\t\tvec2 sphv = dFdy(sph);\n\t\t\t\tvec3 result = vec3(0.0);\n\t\t\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\t\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\t\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsphu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsphv * (v / NUM_SAMPLES_SQRT - 0.5)));\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t\t}\n}\n\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n\nvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\n\t\tvec4 raw;\n\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\n\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\tmipLevel = raw.w * 8.0;\n}\n\n// convolve an environment given pre-generated samples\nvec4 prefilterSamples() {\n\t\t// construct vector space given target direction\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\t\tunpackSample(i, L, mipLevel);\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n\t\t\t\ttotalWeight += L.z;\n\t\t}\n\n\t\treturn ENCODE_FUNC(result / totalWeight);\n}\n\n// unweighted version of prefilterSamples\nvec4 prefilterSamplesUnweighted() {\n\t\t// construct vector space given target direction\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\t\tunpackSample(i, L, mipLevel);\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n\t\t}\n\n\t\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\n\nvoid main(void) {\n\t\tgl_FragColor = PROCESS_FUNC();\n}\n',rgbmPS:"\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\t\treturn decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv, float bias) {\n\t\treturn decodeRGBM(texture2D(tex, uv, bias));\n}\n\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\t\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // 1 / camera_far,\t\t\tcamera_far,\t\t (1 - f / n) / 2,\t\t\t\t(1 + f / n) / 2\n#endif\n\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\t\tz = z * 2.0 - 1.0;\n\t\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\n\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n\t\t#ifdef GL2\n\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r) * camera_params.y;\n\t\t#else\n\t\treturn unpackFloat(texture2D(uSceneDepthMap, uv)) * camera_params.y;\n\t\t#endif\n}\n\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n\t\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\t\treturn getLinearScreenDepth(uv);\n}\n#endif\n\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n\t\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nconst float maxCascades = 4.0;\n\n// shadow matrix for selected cascade\nmat4 cascadeShadowMat;\n\n// function which selects a shadow projection matrix based on cascade distances \nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\n\t\t// depth in 0 .. far plane range\n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\n\t\t// find cascade index based on the depth (loop as there is no per component vec compare operator in webgl)\n\t\tfloat cascadeIndex = 0.0;\n\t\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\t\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\t\t\t\tcascadeIndex = i;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t}\n\n\t\t// limit to actual number of used cascades\n\t\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\n\t\t// pick shadow matrix\n\t\t#ifdef GL2\n\t\t\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t\t#else\n\t\t\t\t// webgl 1 does not allow non-cost index array lookup\n\t\t\t\tif (cascadeIndex == 0.0) {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t\t\t}\n\t\t\t\telse if (cascadeIndex == 1.0) {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t\t\t}\n\t\t\t\telse if (cascadeIndex == 2.0) {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t\t\t}\n\t\t#endif\n}\n\nvoid fadeShadow(float shadowCascadeDistances[4]) {\t\t\t\t\t\t\t\t\t\n\n\t\t// if the pixel is past the shadow distance, remove shadow\n\t\t// this enforces straight line instead of corner of shadow which moves when camera rotates\t\n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\t\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\t\t\tdShadowCoord.z = -9999999.0;\n\t\t}\n}\n",shadowCommonPS:"\nvoid normalOffsetPointShadow(vec4 shadowParams) {\n\t\tfloat distScale = length(dLightDirW);\n\t\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n\t\tvec3 dir = wPos - dLightPosW;\n\t\tdLightDirW = dir;\n}\n",shadowCoordPS:"\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\t\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\t\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\n\t\t#ifdef SHADOWBIAS\n\t\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t\t#endif\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\t\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\tdShadowCoord.xy = projPos.xy;\n\t\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\n\t\t#ifdef SHADOWBIAS\n\t\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t\t#endif\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\t\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n\t\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n\t\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\t\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n\t\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"\nvoid _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\t\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\t\tprojPos.xyz /= projPos.w;\n\t\tdShadowCoord = projPos.xyz;\n\t\t// depth bias is already applied on render\n}\n\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\t\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n\t\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"\nfloat VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t\tvec3 moments = texture2D(tex, texCoords).xyz;\n\t\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\t\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\t\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"\nfloat VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t\tfloat pixelSize = 1.0 / resolution;\n\t\ttexCoords -= vec2(pixelSize);\n\t\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\t\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\t\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\t\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\t\tvec2 fr = fract(texCoords * resolution);\n\t\tvec3 h0 = mix(s00, s10, fr.x);\n\t\tvec3 h1 = mix(s01, s11, fr.x);\n\t\tvec3 moments = mix(h0, h1, fr.y);\n\t\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\t\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\t\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"\nvec3 lessThan2(vec3 a, vec3 b) {\n\t\treturn clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n\n// ----- Direct/Spot Sampling -----\n\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\t\tfloat z = dShadowCoord.z;\n\t\tvec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n\t\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\t\tvec2 base_uv = floor(uv + 0.5);\n\t\tfloat s = (uv.x + 0.5 - base_uv.x);\n\t\tfloat t = (uv.y + 0.5 - base_uv.y);\n\t\tbase_uv -= vec2(0.5);\n\t\tbase_uv *= shadowMapSizeInv;\n\n\t\tfloat sum = 0.0;\n\n\t\tfloat uw0 = (3.0 - 2.0 * s);\n\t\tfloat uw1 = (1.0 + 2.0 * s);\n\n\t\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\t\tfloat u1 = s / uw1 + 1.0;\n\n\t\tfloat vw0 = (3.0 - 2.0 * t);\n\t\tfloat vw1 = (1.0 + 2.0 * t);\n\n\t\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\t\tfloat v1 = t / vw1 + 1.0;\n\n\t\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\t\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\n\t\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\t\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\n\t\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\t\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\t\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\t\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\n\t\tsum *= 1.0f / 16.0;\n\t\treturn sum;\n}\n\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\t\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\t\tmat3 shadowKernel;\n\t\tvec3 shadowCoord = dShadowCoord;\n\t\tvec3 shadowZ = vec3(shadowCoord.z);\n\t\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\t\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\t\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n\t\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n\t\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\t\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n\t\tvec4 shadowValues;\n\t\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\t\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\t\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\t\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n\t\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\t\tvec3 shadowCoord = dShadowCoord;\n\n\t\tfloat xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n\t\tfloat dx0 = -xoffset;\n\t\tfloat dx1 = xoffset;\n\n\t\tmat3 depthKernel;\n\t\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\t\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\t\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\t\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\t\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\t\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\t\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\t\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\t\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n\t\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\n\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\t\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\t\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\n\n\n// ----- Omni Sampling -----\n\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n\t\tvec3 tc = normalize(dir);\n\t\tvec3 tcAbs = abs(tc);\n\n\t\tvec4 dirX = vec4(1,0,0, tc.x);\n\t\tvec4 dirY = vec4(0,1,0, tc.y);\n\t\tfloat majorAxisLength = tc.z;\n\t\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\t\t\tdirX = vec4(0,0,1, tc.z);\n\t\t\t\tdirY = vec4(0,1,0, tc.y);\n\t\t\t\tmajorAxisLength = tc.x;\n\t\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\t\t\tdirX = vec4(1,0,0, tc.x);\n\t\t\t\tdirY = vec4(0,0,1, tc.z);\n\t\t\t\tmajorAxisLength = tc.y;\n\t\t}\n\n\t\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n\t\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\t\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\t\tvec3 dx0 = -xoffset;\n\t\tvec3 dy0 = -yoffset;\n\t\tvec3 dx1 = xoffset;\n\t\tvec3 dy1 = yoffset;\n\n\t\tmat3 shadowKernel;\n\t\tmat3 depthKernel;\n\n\t\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\t\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\t\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\t\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\t\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\t\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\t\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\t\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\t\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n\t\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\n\t\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\t\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\t\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n\t\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n\t\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\n\t\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\t\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n\t\tvec4 shadowValues;\n\t\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\t\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\t\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\t\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n\t\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\t\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"\nfloat _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\t\t// http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n\n\t\tfloat z = dShadowCoord.z;\n\t\tvec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n\t\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\t\tvec2 base_uv = floor(uv + 0.5);\n\t\tfloat s = (uv.x + 0.5 - base_uv.x);\n\t\tfloat t = (uv.y + 0.5 - base_uv.y);\n\t\tbase_uv -= vec2(0.5);\n\t\tbase_uv *= shadowMapSizeInv;\n\n\n\t\tfloat uw0 = (4.0 - 3.0 * s);\n\t\tfloat uw1 = 7.0;\n\t\tfloat uw2 = (1.0 + 3.0 * s);\n\n\t\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\t\tfloat u1 = (3.0 + s) / uw1;\n\t\tfloat u2 = s / uw2 + 2.0;\n\n\t\tfloat vw0 = (4.0 - 3.0 * t);\n\t\tfloat vw1 = 7.0;\n\t\tfloat vw2 = (1.0 + 3.0 * t);\n\n\t\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\t\tfloat v1 = (3.0 + t) / vw1;\n\t\tfloat v2 = t / vw2 + 2.0;\n\n\t\tfloat sum = 0.0;\n\n\t\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\t\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\n\t\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\t\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\n\t\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\t\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\n\t\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\t\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\t\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\n\t\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\t\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\t\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\n\t\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\t\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\t\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\n\t\tsum *= 1.0f / 144.0;\n\n\t\tsum = gammaCorrectInput(sum); // gives softer gradient\n\t\tsum = saturate(sum);\n\n\t\treturn sum;\n}\n\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\t\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowVSM8PS:"\nfloat calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\t\tfloat VSMBias = vsmBias;//0.01 * 0.25;\n\t\tfloat depthScale = VSMBias * Z;\n\t\tfloat minVariance1 = depthScale * depthScale;\n\t\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\n\nfloat decodeFloatRG(vec2 rg) {\n\t\treturn rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t\tvec4 c = texture2D(tex, texCoords);\n\t\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\t\treturn calculateVSM8(moments, Z, vsmBias);\n}\n\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\t\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\n\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\t\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"\nfloat linstep(float a, float b, float v) {\n\t\treturn saturate((v - a) / (b - a));\n}\n\nfloat reduceLightBleeding(float pMax, float amount) {\n\t // Remove the [0, amount] tail and linearly rescale (amount, 1].\n\t return linstep(amount, 1.0, pMax);\n}\n\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\t\t// Compute variance\n\t\tfloat variance = moments.y - (moments.x * moments.x);\n\t\tvariance = max(variance, minVariance);\n\n\t\t// Compute probabilistic upper bound\n\t\tfloat d = mean - moments.x;\n\t\tfloat pMax = variance / (variance + (d * d));\n\n\t\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\n\t\t// One-tailed Chebyshev\n\t\treturn (mean <= moments.x ? 1.0 : pMax);\n}\n\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\t\tZ = 2.0 * Z - 1.0;\n\t\tfloat warpedDepth = exp(exponent * Z);\n\n\t\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\n\t\tfloat VSMBias = vsmBias;//0.01 * 0.25;\n\t\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\t\tfloat minVariance1 = depthScale * depthScale;\n\t\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"\nattribute float vertex_boneIndices;\n\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\n\nmat4 getBoneMatrix(const in float i) {\n\t\t// read 4x3 matrix\n\t\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\t\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\t\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, 1\n\t\t);\n}\n",skinBatchTexVS:"\nattribute float vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i) {\n\t\tfloat j = i * 3.0;\n\t\tfloat dx = texture_poseMapSize.z;\n\t\tfloat dy = texture_poseMapSize.w;\n\n\t\tfloat y = floor(j * dx);\n\t\tfloat x = j - (y * texture_poseMapSize.x);\n\t\ty = dy * (y + 0.5);\n\n\t\t// read elements of 4x3 matrix\n\t\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\t\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\t\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, 1\n\t\t);\n}\n",skinConstVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\n\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\t\t// read 4x3 matrix\n\t\tv1 = matrix_pose[int(3.0 * i)];\n\t\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\t\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\n\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\t\t// get 4 bone matrices\n\t\tvec4 a1, a2, a3;\n\t\tgetBoneMatrix(indices.x, a1, a2, a3);\n\n\t\tvec4 b1, b2, b3;\n\t\tgetBoneMatrix(indices.y, b1, b2, b3);\n\n\t\tvec4 c1, c2, c3;\n\t\tgetBoneMatrix(indices.z, c1, c2, c3);\n\n\t\tvec4 d1, d2, d3;\n\t\tgetBoneMatrix(indices.w, d1, d2, d3);\n\n\t\t// multiply them by weights and add up to get final 4x3 matrix\n\t\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\t\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\t\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\n\t\t// add up weights\n\t\tfloat one = dot(weights, vec4(1.0));\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, one\n\t\t);\n}\n",skinTexVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\n\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\t\tfloat j = i * 3.0;\n\t\tfloat dx = texture_poseMapSize.z;\n\t\tfloat dy = texture_poseMapSize.w;\n\t\t\n\t\tfloat y = floor(j * dx);\n\t\tfloat x = j - (y * texture_poseMapSize.x);\n\t\ty = dy * (y + 0.5);\n\n\t\t// read elements of 4x3 matrix\n\t\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\t\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\t\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\n\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\t\t// get 4 bone matrices\n\t\tvec4 a1, a2, a3;\n\t\tgetBoneMatrix(indices.x, a1, a2, a3);\n\n\t\tvec4 b1, b2, b3;\n\t\tgetBoneMatrix(indices.y, b1, b2, b3);\n\n\t\tvec4 c1, c2, c3;\n\t\tgetBoneMatrix(indices.z, c1, c2, c3);\n\n\t\tvec4 d1, d2, d3;\n\t\tgetBoneMatrix(indices.w, d1, d2, d3);\n\n\t\t// multiply them by weights and add up to get final 4x3 matrix\n\t\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\t\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\t\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\n\t\t// add up weights\n\t\tfloat one = dot(weights, vec4(1.0));\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, one\n\t\t);\n}\n",skyboxEnvPS:"\nvarying vec3 vViewDir;\n\nuniform sampler2D texture_envAtlas;\nuniform float mipLevel;\n\nvoid main(void) {\n\t\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\t\tvec2 uv = toSphericalUv(normalize(dir));\n\n\t\tvec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\n\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxHDRPS:"\nvarying vec3 vViewDir;\n\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n\t\tvec3 dir=vViewDir;\n\t\tdir.x *= -1.0;\n\t\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\t\tcolor = toneMap(color);\n\t\tcolor = gammaCorrectOutput(color);\n\t\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxVS:"\nattribute vec3 aPosition;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\n\nvarying vec3 vViewDir;\n\nvoid main(void) {\n\t\tmat4 view = matrix_view;\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\n\t\t// Force skybox to far Z, regardless of the clip planes on the camera\n\t\t// Subtract a tiny fudge factor to ensure floating point errors don't\n\t\t// still push pixels beyond far Z. See:\n\t\t// http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n\n\t\tgl_Position.z = gl_Position.w - 0.00001;\n\t\tvViewDir = aPosition * cubeMapRotationMatrix;\n}\n",specularPS:"\n#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n\t\tdSpecularity = vec3(1.0);\n\n\t\t#ifdef MAPCOLOR\n\t\tdSpecularity *= material_specular;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdSpecularity *= texture2D(texture_specularMap, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdSpecularity *= saturate(vVertexColor.$VC);\n\t\t#endif\n}\n",specularAaNonePS:"\nfloat antiAliasGlossiness(float power) {\n\t\treturn power;\n}\n",specularAaToksvigPS:"\nfloat antiAliasGlossiness(float power) {\n\t\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\t\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\t\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"\nfloat antiAliasGlossiness(float power) {\n\t\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\t\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\t\treturn power * toksvig;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\t\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\t\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"\nvoid main(void) {\n\t\tdDiffuseLight = vec3(0);\n\t\tdSpecularLight = vec3(0);\n\t\tdReflection = vec4(0);\n\t\tdSpecularity = vec3(0);\n\n\t\t#ifdef CLEARCOAT\n\t\tccSpecularLight = vec3(0);\n\t\tccReflection = vec4(0);\n\t\t#endif\n",startVS:"\nvoid main(void) {\n\t\tgl_Position = getPosition();\n",startNineSlicedPS:"\n\t\tnineSlicedUv = vUv0;\n\t\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\n",startNineSlicedTiledPS:"\n\t\tvec2 tileMask = step(vMask, vec2(0.99999));\n\t\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\t\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\t\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\t\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\t\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\t\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\t\n",storeEVSMPS:"\nfloat exponent = VSM_EXPONENT;\n\ndepth = 2.0 * depth - 1.0;\ndepth =\texp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"\nvec3 getTangent() {\n\t\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal() {\n\t\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\nvec3 getObjectSpaceUp() {\n\t\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"\nvoid getTBN() {\n\t\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"\nuniform float tbnBasis;\n\n// http://www.thetenthplanet.de/archives/1180\nvoid getTBN() {\n\t\tvec2 uv = $UV;\n\n\t\t// get edge vectors of the pixel triangle\n\t\tvec3 dp1 = dFdx( vPositionW );\n\t\tvec3 dp2 = dFdy( vPositionW );\n\t\tvec2 duv1 = dFdx( uv );\n\t\tvec2 duv2 = dFdy( uv );\n\n\t\t// solve the linear system\n\t\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\t\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\t\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n\t\t// construct a scale-invariant frame\n\t\tfloat denom = max( dot(T,T), dot(B,B) );\n\t\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\t\tdTBN = mat3(T * invmax, -B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"\nvoid getTBN() {\n\t\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"\nvoid getTBN() {\n\n\t\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\t\tvec3 T = cross(dVertexNormalW, B);\n\n\t\tif (dot(B,B)==0.0) // deal with case when vObjectSpaceUpW dVertexNormalW are parallel\n\t\t{\n\t\t\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\n\t\t\t\tif (dVertexNormalW.x==major)\n\t\t\t\t{\n\t\t\t\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\t\t\t\tT=cross(dVertexNormalW, B);\n\t\t\t\t}\n\t\t\t\telse if (dVertexNormalW.y==major)\n\t\t\t\t{\n\t\t\t\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\t\t\t\tT=cross(dVertexNormalW, B);\n\t\t\t\t}\n\t\t\t\telse if (dVertexNormalW.z==major)\n\t\t\t\t{\n\t\t\t\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\t\t\t\tT=cross(dVertexNormalW, B);\n\t\t\t\t}\n\t\t}\n\n\t\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n\t\tfloat tA = 2.51;\n\t\tfloat tB = 0.03;\n\t\tfloat tC = 2.43;\n\t\tfloat tD = 0.59;\n\t\tfloat tE = 0.14;\n\t\tvec3 x = color * exposure;\n\t\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\n\n// ACES approximation by Stephen Hill\n\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n\t\t0.59719, 0.35458, 0.04823,\n\t\t0.07600, 0.90834, 0.01566,\n\t\t0.02840, 0.13383, 0.83777\n);\n\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n\t\t 1.60475, -0.53108, -0.07367,\n\t\t-0.10208,\t1.10813, -0.00605,\n\t\t-0.00327, -0.07276,\t1.07602\n);\n\nvec3 RRTAndODTFit(vec3 v) {\n\t\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\t\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\t\treturn a / b;\n}\n\nvec3 toneMap(vec3 color) {\n\t\tcolor *= exposure;\n\t\tcolor = color * ACESInputMat;\n\n\t\t// Apply RRT and ODT\n\t\tcolor = RRTAndODTFit(color);\n\t\tcolor = color * ACESOutputMat;\n\n\t\t// Clamp to [0, 1]\n\t\tcolor = clamp(color, 0.0, 1.0);\n\n\t\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =\t0.15;\nconst float B =\t0.50;\nconst float C =\t0.10;\nconst float D =\t0.20;\nconst float E =\t0.02;\nconst float F =\t0.30;\nconst float W =\t11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n\t return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n\t\tcolor = uncharted2Tonemap(color * exposure);\n\t\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\t\tcolor = color * whiteScale;\n\n\t\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n\t\tcolor *= exposure;\n\t\tconst float\tA = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\t\tconst float Scl = 1.25;\n\n\t\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\t\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n\t\treturn color * exposure;\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\t\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\n\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\n\nvec2 getTextureMorphCoords() {\n\t\tfloat vertexId = morph_vertex_id;\n\t\tvec2 textureSize = morph_tex_params.xy;\n\t\tvec2 invTextureSize = morph_tex_params.zw;\n\n\t\t// turn vertexId into int grid coordinates\n\t\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\t\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\n\t\t// convert grid coordinates to uv coordinates with half pixel offset\n\t\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\n\nmat4 getModelMatrix() {\n\t\t#ifdef DYNAMICBATCH\n\t\treturn getBoneMatrix(vertex_boneIndices);\n\t\t#elif defined(SKIN)\n\t\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t\t#elif defined(INSTANCING)\n\t\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t\t#else\n\t\treturn matrix_model;\n\t\t#endif\n}\n\nvec4 getPosition() {\n\t\tdModelMatrix = getModelMatrix();\n\t\tvec3 localPos = vertex_position;\n\n\t\t#ifdef NINESLICED\n\t\t// outer and inner vertices are at the same position, scale both\n\t\tlocalPos.xz *= outerScale;\n\n\t\t// offset inner vertices inside\n\t\t// (original vertices must be in [-1;1] range)\n\t\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n\t\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n\n\t\tlocalPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n\t\tlocalPos = localPos.xzy;\n\t\t#endif\n\n\t\t#ifdef MORPHING\n\t\t#ifdef MORPHING_POS03\n\t\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\t\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\t\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\t\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t\t#endif // MORPHING_POS03\n\t\t#ifdef MORPHING_POS47\n\t\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\t\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\t\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\t\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t\t#endif // MORPHING_POS47\n\t\t#endif // MORPHING\n\n\t\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\t\t// apply morph offset from texture\n\t\tvec2 morphUV = getTextureMorphCoords();\n\t\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\t\tlocalPos += morphPos;\n\t\t#endif\n\n\t\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t\t#ifdef SCREENSPACE\n\t\tposW.zw = vec2(0.0, 1.0);\n\t\t#endif\n\t\tdPositionW = posW.xyz;\n\n\t\tvec4 screenPos;\n\t\t#ifdef UV1LAYOUT\n\t\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#else\n\t\t#ifdef SCREENSPACE\n\t\tscreenPos = posW;\n\t\tscreenPos.y *= projectionFlipY;\n\t\t#else\n\t\tscreenPos = matrix_viewProjection * posW;\n\t\t#endif\n\n\t\t#ifdef PIXELSNAP\n\t\t// snap vertex to a pixel boundary\n\t\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\t\tscreenPos.xy *= uScreenSize.xy;\n\t\tscreenPos.xy = floor(screenPos.xy);\n\t\tscreenPos.xy *= uScreenSize.zw;\n\t\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t\t#endif\n\t\t#endif\n\n\t\treturn screenPos;\n}\n\nvec3 getWorldPosition() {\n\t\treturn dPositionW;\n}\n",transformDeclVS:"\nattribute vec3 vertex_position;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"\n#ifdef NINESLICED\nvec2 getUv0() {\n\t\tvec2 uv = vertex_position.xz;\n\n\t\t// offset inner vertices inside\n\t\t// (original vertices must be in [-1;1] range)\n\t\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n\t\tuv = uv * -0.5 + 0.5;\n\t\tuv = uv * atlasRect.zw + atlasRect.xy;\n\n\t\tvMask = vertex_texCoord0.xy;\n\n\t\treturn uv;\n}\n#else\nvec2 getUv0() {\n\t\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\t\treturn vertex_texCoord1;\n}\n",viewDirPS:"\nvoid getViewDir() {\n\t\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nvec3 getViewNormal() {\n\t\treturn mat3(matrix_view) * vNormalW;\n}\n"};function Qr(t,e){return e||(e=Zr),1===t||2===t?e.gamma2_2PS?e.gamma2_2PS:Zr.gamma2_2PS:3===t?"#define HDR\n"+(e.gamma2_2PS?e.gamma2_2PS:Zr.gamma2_2PS):e.gamma1_0PS?e.gamma1_0PS:Zr.gamma1_0PS}function Jr(t,e){return e||(e=Zr),1===t?e.tonemappingFilmicPS?e.tonemappingFilmicPS:Zr.tonemappingFilmicPS:0===t?e.tonemappingLinearPS?e.tonemappingLinearPS:Zr.tonemappingLinearPS:2===t?e.tonemappingHejlPS?e.tonemappingHejlPS:Zr.tonemappingHejlPS:3===t?e.tonemappingAcesPS?e.tonemappingAcesPS:Zr.tonemappingAcesPS:4===t?e.tonemappingAces2PS?e.tonemappingAces2PS:Zr.tonemappingAces2PS:e.tonemapingNonePS?e.tonemapingNonePS:Zr.tonemappingNonePS}function to(t,e){return e||(e=Zr),"linear"===t?e.fogLinearPS?e.fogLinearPS:Zr.fogLinearPS:"exp"===t?e.fogExpPS?e.fogExpPS:Zr.fogExpPS:"exp2"===t?e.fogExp2PS?e.fogExp2PS:Zr.fogExp2PS:e.fogNonePS?e.fogNonePS:Zr.fogNonePS}function eo(t,e){return e||(e=Zr),t.supportsBoneTextures?e.skinTexVS:"#define BONE_LIMIT "+t.getBoneLimit()+"\n"+e.skinConstVS}function so(t){let e="precision "+t.precision+" float;\n";return t.webgl2&&(e+="#ifdef GL2\nprecision "+t.precision+" sampler2DShadow;\n#endif\n"),e}function io(t){return t.webgl2?"#version 300 es\n":""}function no(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function ao(){return"void main(void)\n{\n"}function ro(){return"}\n"}const oo={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};function ho(t){const e={};let s=0,i=t.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===t[i-1]);){const n=t.indexOf(";",i),a=t.lastIndexOf(" ",n),r=t.substring(a+1,n),o=oo[r];void 0!==o?e[r]=o:(e[r]="ATTR"+s,s++),i=t.indexOf("attribute",i+1)}return e}function lo(t,e,s,i=!1){let n=Zr[e],a=so(t)+"\n"+Zr[s];const r=ho(n);return t.webgl2&&(n=io(t)+Zr.gles3VS+n,a=io(t)+Zr.gles3PS+a),new $r(t,{attributes:r,vshader:n,fshader:a,useTransformFeedback:i})}function co(t,e,s,i,n=!1,a=""){const r=t.programLib._cache,o=r[i];if(void 0!==o)return o;s=so(t)+"\n"+(s||"void main(void) {gl_FragColor = vec4(0.0);}");const h=ho(e);return t.webgl2&&(e=io(t)+Zr.gles3VS+e,s=io(t)+Zr.gles3PS+s),r[i]=new $r(t,{attributes:h,vshader:e,fshader:a+s,useTransformFeedback:n}),r[i]}Zr.collectAttribs=ho,Zr.createShader=lo,Zr.createShaderFromCode=co;class uo{constructor(){this.globalId=0,this.revision=0}equals(t){return this.globalId===t.globalId&&this.revision===t.revision}copy(t){this.globalId=t.globalId,this.revision=t.revision}reset(){this.globalId=0,this.revision=0}}let po=0;class mo{constructor(){po++,this.version=new uo,this.version.globalId=po}increment(){this.version.revision++}}class fo{constructor(t){this.name=t,this.value=null,this.versionObject=new mo}setValue(t){this.value=t,this.versionObject.increment()}getValue(){return this.value}}class _o{constructor(t){this.name=t,this.variables=new Map}resolve(t){return this.variables.has(t)||this.variables.set(t,new fo(t)),this.variables.get(t)}removeValue(t){for(const e in this.variables){const s=this.variables[e];s.value===t&&(s.value=null)}}}const go={generateKey:function(t){let e="basic";return t.fog&&(e+="_fog"),t.alphaTest&&(e+="_atst"),t.vertexColors&&(e+="_vcol"),t.diffuseMap&&(e+="_diff"),t.skin&&(e+="_skin"),t.screenSpace&&(e+="_ss"),t.useInstancing&&(e+="_inst"),t.useMorphPosition&&(e+="_morphp"),t.useMorphNormal&&(e+="_morphn"),t.useMorphTextureBased&&(e+="_morpht"),e+="_"+t.pass,e},createShaderDefinition:function(t,e){const s={vertex_position:"POSITION"};e.skin&&(s.vertex_boneWeights="BLENDWEIGHT",s.vertex_boneIndices="BLENDINDICES"),e.vertexColors&&(s.vertex_color="COLOR"),e.diffuseMap&&(s.vertex_texCoord0="TEXCOORD0");let i="";i+=Zr.transformDeclVS,e.skin?(i+=eo(t),i+=Zr.transformSkinnedVS):i+=Zr.transformVS,e.vertexColors&&(i+="attribute vec4 vertex_color;\n",i+="varying vec4 vColor;\n"),e.diffuseMap&&(i+="attribute vec2 vertex_texCoord0;\n",i+="varying vec2 vUv0;\n"),2===e.pass&&(i+="varying float vDepth;\n",i+="#ifndef VIEWMATRIX\n",i+="#define VIEWMATRIX\n",i+="uniform mat4 matrix_view;\n",i+="#endif\n",i+="#ifndef CAMERAPLANES\n",i+="#define CAMERAPLANES\n",i+="uniform vec4 camera_params;\n\n",i+="#endif\n"),i+="void main(void)\n{\n",i+="\t gl_Position = getPosition();\n",2===e.pass&&(i+="\t\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),e.vertexColors&&(i+="\t\tvColor = vertex_color;\n"),e.diffuseMap&&(i+="\t\tvUv0 = vertex_texCoord0;\n"),i+="}\n";const n=i;i=so(t),e.vertexColors?i+="varying vec4 vColor;\n":i+="uniform vec4 uColor;\n",e.diffuseMap&&(i+="varying vec2 vUv0;\n",i+="uniform sampler2D texture_diffuseMap;\n"),e.fog&&(i+=to(e.fog)),e.alphatest&&(i+=Zr.alphaTestPS),2===e.pass&&(i+="varying float vDepth;\n",i+=Zr.packDepthPS),i+="void main(void)\n{\n",e.vertexColors?i+="\t\tgl_FragColor = vColor;\n":i+="\t\tgl_FragColor = uColor;\n",e.diffuseMap&&(i+="\t\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),e.alphatest&&(i+="\t alphaTest(gl_FragColor.a);\n"),18!==e.pass&&(2===e.pass?i+="\t\tgl_FragColor = packFloat(vDepth);\n":e.fog&&(i+="\t glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),i+="}\n";return{attributes:s,vshader:n,fshader:i}}},yo={generateKey:function(t){let e="particle";for(const s in t)t.hasOwnProperty(s)&&(e+=t[s]);return e},_animTex:function(t){let e="";return e+=t.animTexLoop?Zr.particleAnimFrameLoopVS:Zr.particleAnimFrameClampVS,e+=Zr.particleAnimTexVS,e},createShaderDefinition:function(t,e){let s="",i=so(t)+"\n";i+="#define PARTICLE\n",t.webgl2&&(s+="#define GL2\n",i+="#define GL2\n"),s+="#define VERTEXSHADER\n",e.mesh&&(s+="#define USE_MESH\n"),e.localSpace&&(s+="#define LOCAL_SPACE\n"),e.screenSpace&&(s+="#define SCREEN_SPACE\n"),e.animTex&&(s+="\nuniform vec2 animTexTilesParams;\n"),e.animTex&&(s+="\nuniform vec4 animTexParams;\n"),e.animTex&&(s+="\nuniform vec2 animTexIndexParams;\n"),2===e.normal&&(s+="\nvarying mat3 ParticleMat;\n"),1===e.normal&&(s+="\nvarying vec3 Normal;\n"),e.soft&&(s+="\nvarying float vDepth;\n");const n=e.customFace?Zr.particle_customFaceVS:Zr.particle_billboardVS;e.useCpu?(e.soft>0&&(s+=Zr.screenDepthPS),s+=Zr.particle_cpuVS,e.localSpace&&(s+=Zr.particle_localShiftVS),e.animTex&&(s+=this._animTex(e)),e.alignToMotion&&(s+=Zr.particle_pointAlongVS),s+=e.mesh?Zr.particle_meshVS:n,1===e.normal&&(s+=Zr.particle_normalVS),2===e.normal&&(s+=Zr.particle_TBNVS),e.stretch>0&&(s+=Zr.particle_stretchVS),s+=Zr.particle_cpu_endVS,e.soft>0&&(s+=Zr.particle_softVS)):(s+=Zr.particle_initVS,s+=e.pack8?Zr.particleInputRgba8PS:Zr.particleInputFloatPS,e.soft>0&&(s+=Zr.screenDepthPS),s+=Zr.particleVS,e.localSpace&&(s+=Zr.particle_localShiftVS),e.animTex&&(s+=this._animTex(e)),e.wrap&&(s+=Zr.particle_wrapVS),e.alignToMotion&&(s+=Zr.particle_pointAlongVS),s+=e.mesh?Zr.particle_meshVS:n,1===e.normal&&(s+=Zr.particle_normalVS),2===e.normal&&(s+=Zr.particle_TBNVS),e.stretch>0&&(s+=Zr.particle_stretchVS),s+=Zr.particle_endVS,e.soft>0&&(s+=Zr.particle_softVS)),s+="}\n",e.normal>0&&(1===e.normal?i+="\nvarying vec3 Normal;\n":2===e.normal&&(i+="\nvarying mat3 ParticleMat;\n"),i+="\nuniform vec3 lightCube[6];\n"),e.soft&&(i+="\nvarying float vDepth;\n"),0===e.normal&&"none"===e.fog&&(e.srgb=!1),i+=Qr(e.gamma),i+=Jr(e.toneMap),"linear"===e.fog?i+=Zr.fogLinearPS:"exp"===e.fog?i+=Zr.fogExpPS:"exp2"===e.fog?i+=Zr.fogExp2PS:i+=Zr.fogNonePS,2===e.normal&&(i+="\nuniform sampler2D normalMap;\n"),e.soft>0&&(i+=Zr.screenDepthPS),i+=Zr.particlePS,e.soft>0&&(i+=Zr.particle_softPS),1===e.normal&&(i+="\nvec3 normal = Normal;\n"),2===e.normal&&(i+=Zr.particle_normalMapPS),e.normal>0&&(i+=e.halflambert?Zr.particle_halflambertPS:Zr.particle_lambertPS),e.normal>0&&(i+=Zr.particle_lightingPS),2===e.blend?i+=Zr.particle_blendNormalPS:1===e.blend?i+=Zr.particle_blendAddPS:5===e.blend&&(i+=Zr.particle_blendMultiplyPS),i+=Zr.particle_endPS;return{attributes:ho(s),vshader:s,fshader:i}}},vo={generateKey:function(t){return"cubemap"===t.type?`skybox-${t.type}-${t.rgbm}-${t.hdr}-${t.fixSeams}-${t.toneMapping}-${t.gamma}-${t.useIntensity}-${t.mip}`:`skybox-${t.type}-${t.encoding}-${t.useIntensity}-${t.gamma}-${t.toneMapping}`},createShaderDefinition:function(t,e){let s;if("cubemap"===e.type){const i=[128,64,16,8,4,2];s=so(t),s+=e.mip?Zr.fixCubemapSeamsStretchPS:Zr.fixCubemapSeamsNonePS,s+=e.useIntensity?Zr.envMultiplyPS:Zr.envConstPS,s+=Qr(e.gamma),s+=Jr(e.toneMapping),s+=Zr.decodePS,s+=Zr.rgbmPS,s+=Zr.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,e.rgbm?"textureCubeRGBM":e.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/i[e.mip]+"")}else{const i={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"};s=so(t),s+=e.useIntensity?Zr.envMultiplyPS:Zr.envConstPS,s+=Qr(e.gamma),s+=Jr(e.toneMapping),s+=Zr.decodePS,s+=Zr.skyboxEnvPS.replace(/\$DECODE/g,i[e.encoding]||"decodeGamma")}return{attributes:{aPosition:"POSITION"},vshader:Zr.skyboxVS,fshader:s}}},xo=new Float32Array(1),bo=new Int32Array(xo.buffer);class So{static float2Half(t){xo[0]=t;const e=bo[0];let s=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&e,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2Bytes(t,e,s,i){const n=255*t%1;if(e[s+0]=Math.round(255*(t%1-.00392156862745098*n)),i>1){const a=65025*t%1;if(e[s+1]=Math.round(255*(n-.00392156862745098*a)),i>2){const n=16581375*t%1;e[s+2]=Math.round(255*(a-.00392156862745098*n)),i>3&&(e[s+3]=Math.round(255*n))}}}static float2BytesRange(t,e,s,i,n,a){t=q.clamp((t-i)/(n-i),0,1),So.float2Bytes(t,e,s,a)}static float2MantissaExponent(t,e,s,i){const n=Math.floor(Math.log2(Math.abs(t)))+1;t/=Math.pow(2,n),So.float2BytesRange(t,e,s,-1,1,i-1),e[s+i-1]=Math.round(n+127)}}let wo=null,To=null;class Mo{constructor(t,e){this.device=t,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=7,this.type="default",this.projection="none",this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!1,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=5,this._magFilter=1,this._anisotropy=1,this._addressU=0,this._addressV=0,this._addressW=0,this._compareOnRead=!1,this._compareFunc=1,void 0!==e&&(void 0!==e.name&&(this.name=e.name),this._width=void 0!==e.width?e.width:this._width,this._height=void 0!==e.height?e.height:this._height,this._format=void 0!==e.format?e.format:this._format,e.hasOwnProperty("type")?this.type=e.type:e.hasOwnProperty("rgbm")?this.type=e.rgbm?"rgbm":"default":e.hasOwnProperty("swizzleGGGR")&&(this.type=e.swizzleGGGR?"swizzleGGGR":"default"),void 0!==e.mipmaps?this._mipmaps=e.mipmaps:this._mipmaps=void 0!==e.autoMipmap?e.autoMipmap:this._mipmaps,this._levels=e.levels,this._cubemap=void 0!==e.cubemap?e.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==e.fixCubemapSeams?e.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection="cube":e.projection&&"cube"!==e.projection&&(this.projection=e.projection),this._minFilter=void 0!==e.minFilter?e.minFilter:this._minFilter,this._magFilter=void 0!==e.magFilter?e.magFilter:this._magFilter,this._anisotropy=void 0!==e.anisotropy?e.anisotropy:this._anisotropy,this._addressU=void 0!==e.addressU?e.addressU:this._addressU,this._addressV=void 0!==e.addressV?e.addressV:this._addressV,this._compareOnRead=void 0!==e.compareOnRead?e.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==e._compareFunc?e._compareFunc:this._compareFunc,this._flipY=void 0!==e.flipY?e.flipY:this._flipY,this._premultiplyAlpha=void 0!==e.premultiplyAlpha?e.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=void 0!==e.depth?e.depth:this._depth,this._volume=void 0!==e.volume?e.volume:this._volume,this._addressW=void 0!==e.addressW?e.addressW:this._addressW)),this._compressed=8===this._format||9===this._format||10===this._format||this._format>=21,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0,this.impl=t.createTextureImpl(),t.textures.push(this)}destroy(){if(this.device){const t=this.device,e=t.textures.indexOf(this);-1!==e&&t.textures.splice(e,1),t.scope.removeValue(this),this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this._gpuSize),this._levels=null,this.device=null}}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(t,e){t.tex+=e}set minFilter(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}get minFilter(){return this._minFilter}set magFilter(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}get magFilter(){return this._magFilter}set addressU(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}get addressU(){return this._addressU}set addressV(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}get addressV(){return this._addressV}set addressW(t){this.device.webgl2&&this._volume&&t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16)}get addressW(){return this._addressW}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}get compareOnRead(){return this._compareOnRead}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}get compareFunc(){return this._compareFunc}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}get anisotropy(){return this._anisotropy}set autoMipmap(t){this._mipmaps=t}get autoMipmap(){return this._mipmaps}set mipmaps(t){this._mipmaps!==t&&(this._mipmaps=t,t&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return Mo.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get volume(){return this._volume}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return q.powerOfTwo(this._width)&&q.powerOfTwo(this._height)}get encoding(){return"rgbm"===this.type?"rgbm":"rgbe"===this.type?"rgbe":12===this.format||14===this.format?"linear":"srgb"}static calcGpuSize(t,e,s,i,n,a){wo||(wo=[],wo[0]=1,wo[1]=1,wo[2]=2,wo[3]=2,wo[4]=2,wo[5]=2,wo[6]=4,wo[7]=4,wo[11]=8,wo[12]=8,wo[13]=16,wo[14]=16,wo[15]=4,wo[16]=4,wo[17]=4,wo[18]=4,wo[19]=4,wo[20]=4),To||(To=[],To[21]=8,To[22]=8,To[24]=8,To[25]=8,To[26]=8,To[27]=8,To[8]=8,To[29]=8,To[23]=16,To[9]=16,To[10]=16,To[28]=16,To[30]=16);const r=wo.hasOwnProperty(i)?wo[i]:0,o=To.hasOwnProperty(i)?To[i]:0;let h=0;for(;;){if(r>0)h+=t*e*s*r;else{let n=Math.floor((t+3)/4);const a=Math.floor((e+3)/4),r=Math.floor((s+3)/4);24!==i&&25!==i||(n=Math.max(Math.floor(n/2),1)),h+=n*a*r*o}if(!n||1===t&&1===e&&1===s)break;t=Math.max(Math.floor(t/2),1),e=Math.max(Math.floor(e/2),1),s=Math.max(Math.floor(s/2),1)}return h*(a?6:1)}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255}lock(t={}){if(void 0===t.level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=2),this._lockedLevel=t.level,null===this._levels[t.level])switch(this._format){case 0:case 1:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case 12:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[t.level]}setSource(t,e=0){let s,i,n=!1;if(this._cubemap){if(t[0]){s=t[0].width||0,i=t[0].height||0;for(let e=0;e<6;e++){const a=t[e];if(!a||a.width!==s||a.height!==i||!this.device._isBrowserInterface(a)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[e][s]!==t[s]&&(this._levelsUpdated[e][s]=!0)}else this.device._isBrowserInterface(t)||(n=!0),n||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),s=t.width,i=t.height);if(n)if(this._width=4,this._height=4,this._cubemap)for(let t=0;t<6;t++)this._levels[e][t]=null,this._levelsUpdated[e][t]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=s,this._height=i),this._levels[e]=t;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(t=0){return this._levels[t]}unlock(){this._lockedLevel,this.upload(),this._lockedLevel=-1}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps}getDds(){let t=128,e=0;for(;this._levels[e];){if(this.cubemap)for(let s=0;s<6;s++){if(!this._levels[e][s])return;const i=this._levels[e][s].length;if(!i)return;t+=i}else{const s=this._levels[e].length;if(!s)return;t+=s}t+=this._levels[e].length,e++}const s=new ArrayBuffer(t),i=new Uint32Array(s,0,32);let n=528391;this._levels.length>1&&(n|=131072);let a=4096;this._levels.length>1&&(a|=4194304),(this._levels.length>1||this.cubemap)&&(a|=8);const r=this.cubemap?65024:0;i[0]=542327876,i[1]=124,i[2]=n,i[3]=this.height,i[4]=this.width,i[5]=this.width*this.height*4,i[6]=0,i[7]=this._levels.length;for(let t=0;t<11;t++)i[8+t]=0;i[19]=32,i[20]=65,i[21]=0,i[22]=32,i[23]=16711680,i[24]=65280,i[25]=255,i[26]=4278190080,i[27]=a,i[28]=r,i[29]=0,i[30]=0,i[31]=0;let o=128;if(this.cubemap)for(let t=0;t<6;t++)for(let e=0;e<this._levels.length;e++){const i=this._levels[e][t],n=new Uint8Array(s,o,i.length);for(let t=0;t<i.length;t++)n[t]=i[t];o+=i.length}else for(let t=0;t<this._levels.length;t++){const e=this._levels[t],i=new Uint8Array(s,o,e.length);for(let t=0;t<e.length;t++)i[t]=e[t];o+=e.length}return s}}const Co=new at,Ao=new at,Po=new at,Eo=new mt;class Ro{constructor(){this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new et(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new ht(0,0,1,1),this._renderTarget=null,this._scissorRect=new ht(0,0,1,1),this._scissorRectClear=!1,this._projMat=new mt,this._projMatDirty=!0,this._projMatSkybox=new mt,this._viewMat=new mt,this._viewMatDirty=!0,this._viewProjMat=new mt,this._viewProjMatDirty=!0,this.frustum=new ei}set aspectRatio(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}get aspectRatio(){return this._aspectRatio}set aspectRatioMode(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(t){this._calculateProjection=t,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(t){this._calculateTransform=t}get calculateTransform(){return this._calculateTransform}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(t){this._clearDepth=t}get clearDepth(){return this._clearDepth}set clearDepthBuffer(t){this._clearDepthBuffer=t}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(t){this._clearStencil=t}get clearStencil(){return this._clearStencil}set clearStencilBuffer(t){this._clearStencilBuffer=t}get clearStencilBuffer(){return this._clearStencilBuffer}set cullingMask(t){this._cullingMask=t}get cullingMask(){return this._cullingMask}set cullFaces(t){this._cullFaces=t}get cullFaces(){return this._cullFaces}set farClip(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}get farClip(){return this._farClip}set flipFaces(t){this._flipFaces=t}get flipFaces(){return this._flipFaces}set fov(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}get fov(){return this._fov}set frustumCulling(t){this._frustumCulling=t}get frustumCulling(){return this._frustumCulling}set horizontalFov(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}get horizontalFov(){return this._horizontalFov}set layers(t){this._layers=t.slice(0)}get layers(){return this._layers}set nearClip(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}get nearClip(){return this._nearClip}set node(t){this._node=t}get node(){return this._node}set orthoHeight(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(t){this._rect.copy(t)}get rect(){return this._rect}set renderTarget(t){this._renderTarget=t}get renderTarget(){return this._renderTarget}set scissorRect(t){this._scissorRect.copy(t)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}clone(){return(new Ro).copy(this)}copy(t){return this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.cullingMask=t.cullingMask,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(t,e,s,i=new at){this._updateViewProjMat(),this._viewProjMat.transformPoint(t,i);const n=this._viewProjMat.data,a=t.x*n[3]+t.y*n[7]+t.z*n[11]+1*n[15];return i.x=.5*(i.x/a+1)*e,i.y=.5*(1-i.y/a)*s,i}screenToWorld(t,e,s,i,n,a=new at){const r=this._farClip-this._nearClip;if(Co.set(t/i,(n-e)/n,s/r),Co.mulScalar(2),Co.sub(at.ONE),0===this._projection){mt._getPerspectiveHalfSize(Ao,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),Ao.x*=Co.x,Ao.y*=Co.y;const t=this._node.getWorldTransform();Ao.z=-this._nearClip,t.transformPoint(Ao,Po);const e=this._node.getPosition();a.sub2(Po,e),a.normalize(),a.mulScalar(s),a.add(e)}else this._updateViewProjMat(),Eo.copy(this._viewProjMat).invert(),Eo.transformPoint(Co,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{const t=this._orthoHeight,e=t*this._aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getScreenSize(t){if(0===this._projection){const e=this._node.getPosition().distance(t.center);if(e<t.radius)return 1;const s=Math.asin(t.radius/e),i=Math.tan(s),n=Math.tan(this._fov/2*q.DEG_TO_RAD);return Math.min(i/n,1)}return q.clamp(t.radius/this._orthoHeight,0,1)}}const Lo=new mt,Io=new at,Do=new ft,Oo=new ft,Fo=new at,ko=new at,Bo=new mt,zo=new ft,Uo=new at,Vo=new mt,No=new ft,Wo=new ft,Go=new mt,Ho=new at,Xo=new at;class qo extends _{constructor(t="Untitled"){super(),this.name=t,this.tags=new U(this),this._labels={},this.localPosition=new at,this.localRotation=new ft,this.localScale=new at(1,1,1),this.localEulerAngles=new at,this.position=new at,this.rotation=new ft,this.eulerAngles=new at,this._scale=null,this.localTransform=new mt,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new mt,this._dirtyWorld=!1,this.normalMatrix=new rt,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1}get right(){return this._right||(this._right=new at),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new at),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new at),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}set enabled(t){var e;this._enabled!==t&&(this._enabled=t,(t&&null!=(e=this._parent)&&e.enabled||!t)&&this._notifyHierarchyStateChanged(this,t))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let e=this.name;for(;t&&t._parent;)e=`${t.name}/${e}`,t=t._parent;return e}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const s=t._children;for(let t=0,i=s.length;t<i;t++)s[t]._enabled&&this._notifyHierarchyStateChanged(s[t],e)}_onHierarchyStateChanged(t){this._enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const e=this.tags._list;t.tags.clear();for(let s=0;s<e.length;s++)t.tags.add(e[s]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1}clone(){const t=new qo;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}find(t,e){let s,i=[];const n=this._children.length;if(t instanceof Function){const e=t;s=e(this),s&&i.push(this);for(let t=0;t<n;t++){const s=this._children[t].find(e);s.length&&(i=i.concat(s))}}else{let s;this[t]&&(s=this[t]instanceof Function?this[t]():this[t],s===e&&i.push(this));for(let s=0;s<n;++s){const n=this._children[s].find(t,e);n.length&&(i=i.concat(n))}}return i}findOne(t,e){const s=this._children.length;let i=null;if(t instanceof Function){const e=t;if(i=e(this),i)return this;for(let t=0;t<s;t++)if(i=this._children[t].findOne(e),i)return i}else{let n;if(this[t]&&(n=this[t]instanceof Function?this[t]():this[t],n===e))return this;for(let n=0;n<s;n++)if(i=this._children[n].findOne(t,e),null!==i)return i}return null}findByTag(){const t=arguments,e=[],s=(i,n)=>{n&&i.tags.has(...t)&&e.push(i);for(let t=0;t<i._children.length;t++)s(i._children[t],!0)};return s(this,!1),e}findByName(t){if(this.name===t)return this;for(let e=0;e<this._children.length;e++){const s=this._children[e].findByName(t);if(null!==s)return s}return null}findByPath(t){const e=Array.isArray(t)?t:t.split("/");let s=this;for(let t=0,i=e.length;t<i;++t)if(s=s.children.find((s=>s.name===e[t])),!s)return null;return s}forEach(t,e){t.call(e,this);const s=this._children;for(let i=0;i<s.length;i++)s[i].forEach(t,e)}isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new at),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}reparent(t,e){const s=this._parent;s&&s.removeChild(this),t&&(e>=0?t.insertChild(this,e):t.addChild(this))}setLocalEulerAngles(t,e,s){this.localRotation.setFromEulerAngles(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,e,s){t instanceof at?this.localPosition.copy(t):this.localPosition.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,e,s,i){t instanceof ft?this.localRotation.copy(t):this.localRotation.set(t,e,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,e,s){t instanceof at?this.localScale.copy(t):this.localScale.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++}setPosition(t,e,s){t instanceof at?Uo.copy(t):Uo.set(t,e,s),null===this._parent?this.localPosition.copy(Uo):(Vo.copy(this._parent.getWorldTransform()).invert(),Vo.transformPoint(Uo,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,e,s,i){if(t instanceof ft?No.copy(t):No.set(t,e,s,i),null===this._parent)this.localRotation.copy(No);else{const t=this._parent.getRotation();Wo.copy(t).invert(),this.localRotation.copy(Wo).mul(No)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,e,s){if(this.localRotation.setFromEulerAngles(t,e,s),null!==this._parent){const t=this._parent.getRotation();Wo.copy(t).invert(),this.localRotation.mul2(Wo,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const e=t.getPosition(),s=t.getRotation(),i=t._parent;i&&i.removeChild(t),t.setPosition(Bo.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(zo.copy(this.getRotation()).invert().mul(s)),this._children.push(t),this._onInsertChild(t)}insertChild(t,e){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.splice(e,0,t),this._onInsertChild(t)}_fireOnHierarchy(t,e,s){this.fire(t,s);for(let t=0;t<this._children.length;t++)this._children[t]._fireOnHierarchy(e,e,s)}_onInsertChild(t){t._parent=this;const e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()}removeChild(t){const e=this._children.indexOf(t);-1!==e&&(this._children.splice(e,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const e=this._parent;let s=this.localScale,i=e;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(t=i.worldTransform.getScale(),Fo.mul2(t,this.localScale),s=Fo))}Oo.setFromMat4(e.worldTransform),Do.mul2(Oo,this.localRotation);let n=e.worldTransform;e.scaleCompensation&&(ko.mul2(t,e.getLocalScale()),Lo.setTRS(e.worldTransform.getTranslation(Io),Oo,ko),n=Lo),n.transformPoint(this.localPosition,Io),this.worldTransform.setTRS(Io,Do,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let e=0,s=t.length;e<s;e++)t[e].syncHierarchy()}lookAt(t,e,s,i=0,n=1,a=0){if(t instanceof at)Ho.copy(t),e instanceof at?Xo.copy(e):Xo.copy(at.UP);else{if(void 0===s)return;Ho.set(t,e,s),Xo.set(i,n,a)}Go.setLookAt(this.getPosition(),Ho,Xo),No.setFromMat4(Go),this.setRotation(No)}translate(t,e,s){t instanceof at?Uo.copy(t):Uo.set(t,e,s),Uo.add(this.getPosition()),this.setPosition(Uo)}translateLocal(t,e,s){t instanceof at?Uo.copy(t):Uo.set(t,e,s),this.localRotation.transformVector(Uo,Uo),this.localPosition.add(Uo),this._dirtyLocal||this._dirtifyLocal()}rotate(t,e,s){if(No.setFromEulerAngles(t,e,s),null===this._parent)this.localRotation.mul2(No,this.localRotation);else{const t=this.getRotation(),e=this._parent.getRotation();Wo.copy(e).invert(),No.mul2(Wo,No),this.localRotation.mul2(No,t)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,e,s){No.setFromEulerAngles(t,e,s),this.localRotation.mul(No),this._dirtyLocal||this._dirtifyLocal()}}const jo=new mt,Yo=new mt,Ko=new mt;class $o{static create(t,e,s){const i=new Ro;switch(i.node=new qo(t),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,e){case 1:i.node.setRotation($o.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static evalSpotCookieMatrix(t){let e=$o._spotCookieCamera;e||(e=$o.create("SpotCookieCamera",2),$o._spotCookieCamera=e),e.fov=2*t._outerConeAngle;const s=e._node;s.setPosition(t._node.getPosition()),s.setRotation(t._node.getRotation()),s.rotateLocal(-90,0,0),jo.setTRS(s.getPosition(),s.getRotation(),at.ONE).invert(),Yo.mul2(e.projectionMatrix,jo);const i=t.cookieMatrix,n=t.atlasViewport;return Ko.setViewport(n.x,n.y,n.z,n.w),i.mul2(Ko,Yo),i}}$o.pointLightRotations=[(new ft).setFromEulerAngles(0,90,180),(new ft).setFromEulerAngles(0,-90,180),(new ft).setFromEulerAngles(90,0,0),(new ft).setFromEulerAngles(-90,0,0),(new ft).setFromEulerAngles(0,180,180),(new ft).setFromEulerAngles(0,0,180)],$o._spotCookieCamera=null;const Zo=new at,Qo=new Float32Array(6),Jo=new at(-.5,0,0),th=new at(0,0,.5),eh={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},sh={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};class ih{static initShaderDefines(){const t=ih.lightTextureFormat===ih.FORMAT_FLOAT?"FLOAT":"8BIT";ih.shaderDefines=`\n\t\t\t\t\t\t\n#define CLUSTER_TEXTURE_${t}\n\t\t\t\t\t\t${ih.buildShaderDefines(eh,"CLUSTER_TEXTURE_8_")}\n\t\t\t\t\t\t${ih.buildShaderDefines(sh,"CLUSTER_TEXTURE_F_")}\n\t\t\t\t`}static buildShaderDefines(t,e){let s="";return Object.keys(t).forEach((i=>{s+=`\n#define ${e}${i} ${t[i]}.5`})),s}static init(t){ih.lightTextureFormat=t.extTextureFloat&&t.maxTextures>8?ih.FORMAT_FLOAT:ih.FORMAT_8BIT,ih.initShaderDefines()}static createTexture(t,e,s,i,n){return new Mo(t,{name:n,width:e,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:"default",magFilter:0,minFilter:0,anisotropy:1})}constructor(t){this.device=t,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let e=eh.COUNT_ALWAYS,s=0;ih.lightTextureFormat===ih.FORMAT_FLOAT?s=sh.COUNT:e=eh.COUNT,this.lights8=new Uint8ClampedArray(4*e*this.maxLights),this.lightsTexture8=ih.createTexture(this.device,e,this.maxLights,7,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=ih.createTexture(this.device,s,this.maxLights,14,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new at,this.boundsDelta=new at}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}setCompressionRanges(t,e){this.invMaxColorValue=1/e,this.invMaxAttenuation=1/t}setBounds(t,e){this.boundsMin.copy(t),this.boundsDelta.copy(e)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),ih.lightTextureFormat===ih.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(t,e){e._node.getWorldTransform().getY(t).mulScalar(-1),t.normalize()}getLightAreaSizes(t){const e=t._node.getWorldTransform();return e.transformVector(Jo,Zo),Qo[0]=Zo.x,Qo[1]=Zo.y,Qo[2]=Zo.z,e.transformVector(th,Zo),Qo[3]=Zo.x,Qo[4]=Zo.y,Qo[5]=Zo.z,Qo}addLightDataFlags(t,e,s,i,n){t[e+0]=i?255:0,t[e+1]=64*s._shape,t[e+2]=255*s._falloffMode,t[e+3]=n?255:0}addLightDataColor(t,e,s,i,n){const a=this.invMaxColorValue,r=i?s._linearFinalColor:s._finalColor;So.float2Bytes(r[0]*a,t,e+0,2),So.float2Bytes(r[1]*a,t,e+2,2),So.float2Bytes(r[2]*a,t,e+4,2),t[e+6]=n?255:0;const o=!!(1&s.mask),h=!!(2&s.mask);t[e+7]=o&&h?127:h?255:0}addLightDataSpotAngles(t,e,s){So.float2Bytes(.499999*s._innerConeAngleCos+.5,t,e+0,2),So.float2Bytes(.499999*s._outerConeAngleCos+.5,t,e+2,2)}addLightDataShadowBias(t,e,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);So.float2BytesRange(n.bias,t,e,-1,20,2),So.float2Bytes(n.normalBias,t,e+2,2)}addLightDataPositionRange(t,e,s,i){const n=Zo.sub2(i,this.boundsMin).div(this.boundsDelta);So.float2Bytes(n.x,t,e+0,4),So.float2Bytes(n.y,t,e+4,4),So.float2Bytes(n.z,t,e+8,4),So.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,t,e+12,4)}addLightDataSpotDirection(t,e,s){this.getSpotDirection(Zo,s),So.float2Bytes(.499999*Zo.x+.5,t,e+0,4),So.float2Bytes(.499999*Zo.y+.5,t,e+4,4),So.float2Bytes(.499999*Zo.z+.5,t,e+8,4)}addLightDataLightProjMatrix(t,e,s){const i=s.data;for(let s=0;s<12;s++)So.float2BytesRange(i[s],t,e+4*s,-2,2,4);for(let s=12;s<16;s++)So.float2MantissaExponent(i[s],t,e+4*s,4)}addLightDataCookies(t,e,s){const i="rgb"===s._cookieChannel;if(t[e+0]=Math.floor(255*s.cookieIntensity),t[e+1]=i?255:0,!i){const i=s._cookieChannel;t[e+4]="rrr"===i?255:0,t[e+5]="ggg"===i?255:0,t[e+6]="bbb"===i?255:0,t[e+7]="aaa"===i?255:0}}addLightAtlasViewport(t,e,s){So.float2Bytes(s.x,t,e+0,2),So.float2Bytes(s.y,t,e+2,2),So.float2Bytes(s.z/3,t,e+4,2)}addLightAreaSizes(t,e,s){const i=this.getLightAreaSizes(s);for(let s=0;s<6;s++)So.float2MantissaExponent(i[s],t,e+4*s,4)}addLightData(t,e,s){const i=2===t._type,n=t.atlasViewportAllocated,a=this.cookiesEnabled&&!!t._cookie&&n,r=this.areaLightsEnabled&&0!==t.shape,o=this.shadowsEnabled&&t.castShadows&&n,h=t._node.getPosition();let l=null,c=null;if(i)if(o){l=t.getRenderData(null,0).shadowMatrix}else a&&(l=$o.evalSpotCookieMatrix(t));else(o||a)&&(c=t.atlasViewport);const d=this.lights8,u=e*this.lightsTexture8.width*4;if(this.addLightDataFlags(d,u+4*eh.FLAGS,t,i,o),this.addLightDataColor(d,u+4*eh.COLOR_A,t,s,a),i&&this.addLightDataSpotAngles(d,u+4*eh.SPOT_ANGLES,t),t.castShadows&&this.addLightDataShadowBias(d,u+4*eh.SHADOW_BIAS,t),a&&this.addLightDataCookies(d,u+4*eh.COOKIE_A,t),ih.lightTextureFormat===ih.FORMAT_FLOAT){const s=this.lightsFloat,n=e*this.lightsTextureFloat.width*4;if(s[n+4*sh.POSITION_RANGE+0]=h.x,s[n+4*sh.POSITION_RANGE+1]=h.y,s[n+4*sh.POSITION_RANGE+2]=h.z,s[n+4*sh.POSITION_RANGE+3]=t.attenuationEnd,i&&(this.getSpotDirection(Zo,t),s[n+4*sh.SPOT_DIRECTION+0]=Zo.x,s[n+4*sh.SPOT_DIRECTION+1]=Zo.y,s[n+4*sh.SPOT_DIRECTION+2]=Zo.z),l){const t=l.data;for(let e=0;e<16;e++)s[n+4*sh.PROJ_MAT_0+e]=t[e]}if(c&&(s[n+4*sh.ATLAS_VIEWPORT+0]=c.x,s[n+4*sh.ATLAS_VIEWPORT+1]=c.y,s[n+4*sh.ATLAS_VIEWPORT+2]=c.z/3),r){const e=this.getLightAreaSizes(t);s[n+4*sh.AREA_DATA_WIDTH+0]=e[0],s[n+4*sh.AREA_DATA_WIDTH+1]=e[1],s[n+4*sh.AREA_DATA_WIDTH+2]=e[2],s[n+4*sh.AREA_DATA_HEIGHT+0]=e[3],s[n+4*sh.AREA_DATA_HEIGHT+1]=e[4],s[n+4*sh.AREA_DATA_HEIGHT+2]=e[5]}}else this.addLightDataPositionRange(d,u+4*eh.POSITION_X,t,h),i&&this.addLightDataSpotDirection(d,u+4*eh.SPOT_DIRECTION_X,t),l&&this.addLightDataLightProjMatrix(d,u+4*eh.PROJ_MAT_00,l),c&&this.addLightAtlasViewport(d,u+4*eh.ATLAS_VIEWPORT_A,c),r&&this.addLightAreaSizes(d,u+4*eh.AREA_DATA_WIDTH_X,t)}}ih.FORMAT_FLOAT=0,ih.FORMAT_8BIT=1,ih.lightTextureFormat=ih.FORMAT_8BIT,ih.shaderDefines="";const nh=[],ah={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"},rh={optionsContext:{},optionsContextMin:{},generateKey:function(t){const e=function(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&"chunks"!==s&&"lights"!==s&&e.push(s);return e.sort()};let s;t===this.optionsContextMin?(this.propsMin||(this.propsMin=e(t)),s=this.propsMin):t===this.optionsContext?(this.props||(this.props=e(t)),s=this.props):s=e(t);let i="standard";for(let e=0;e<s.length;e++)t[s[e]]&&(i+=s[e]+t[s[e]]);if(t.chunks){const e=[];for(const s in t.chunks)t.chunks.hasOwnProperty(s)&&e.push(s+t.chunks[s]);e.sort(),i+=e}if(t.lights){const e=t.clusteredLightingEnabled;for(let s=0;s<t.lights.length;s++){const n=t.lights[s];e&&0!==n._type||(i+=n.key)}}return Gr(i)},_correctChannel:function(t,e){if(nh[t]>0){if(nh[t]<e.length)return e.substring(0,nh[t]);if(nh[t]>e.length){let s=e;const i=s.charAt(s.length-1),n=nh[t]-s.length;for(let t=0;t<n;t++)s+=i;return s}return e}},_setMapTransform:function(t,e,s,i){const n=`texture_${e}MapTransform`,a=s+100*i;return t[0]+=`uniform vec3 ${n}0;\n`,t[0]+=`uniform vec3 ${n}1;\n`,t[3][a]||(t[1]+=`varying vec2 vUV${i}_${s};\n`,t[2]+=`\t vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${n}0), dot(vec3(uv${i}, 1), ${n}1));\n`,t[3][a]=!0),t},_getUvSourceExpression:function(t,e,s){const i=s[t],n=s[e],a=0===s.pass||1===s.pass;let r;return a&&1===s.nineSlicedMode||a&&2===s.nineSlicedMode?r="nineSlicedUv":(r=0===i?"vUv"+n:"vUV"+n+"_"+i,s.heightMap&&"heightMapTransform"!==t&&(r+=" + dUvOffset")),r},_addMapDef:function(t,e){let s="\n#undef "+t+"\n";return e&&(s+=" #define "+t+"\n"),s},_addMapDefs:function(t,e,s,i){let n="";return n+=this._addMapDef("MAPFLOAT",t),n+=this._addMapDef("MAPCOLOR",e),n+=this._addMapDef("MAPVERTEX",s),n+=this._addMapDef("MAPTEXTURE",i),n},_addMap:function(t,e,s,i,n){const a=t+"Map",r=a+"Uv",o=a+"Transform",h=a+"Channel",l=t+"VertexColorChannel",c=t+"VertexColor",d=t+"Mode",u=s[t+"Tint"],p=s[c],m=s[a],f=s[d];let _=i[e];if(m){const t=this._getUvSourceExpression(o,r,s);if(_=_.replace(/\$UV/g,t).replace(/\$CH/g,s[h]),void 0!==n){const t=0===n?"texture2DSRGB":1===n?"texture2DRGBM":"texture2D";_=_.replace(/\$texture2DSAMPLE/g,t)}}p&&(_=_.replace(/\$VC/g,s[l])),f&&(_=_.replace(/\$DETAILMODE/g,f));const g=!!(1&u),y=!!(2&u);return _=this._addMapDefs(g,y,p,m)+_,_.replace(/\$/g,"")},_directionalShadowMapProjection:function(t,e,s,i,n){let a="";return t.numCascades>1&&(a+=`getShadowCascadeMatrix(light${i}_shadowMatrixPalette, light${i}_shadowCascadeDistances, light${i}_shadowCascadeCount);\n`,e=`(cascadeShadowMat, ${s});\n`),a+=n+e,a+=`fadeShadow(light${i}_shadowCascadeDistances);\n`,a},_nonPointShadowMapProjection:function(t,e,s,i,n){const a=`(${s}, ${i});\n`;return!e._normalOffsetBias||e._isVsm?2===e._type?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbuffer"+a:"\t\t\t getShadowCoordPersp"+a:this._directionalShadowMapProjection(e,a,i,n,"getShadowCoordOrtho"):2===e._type?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbufferNormalOffset"+a:"\t\t\t getShadowCoordPerspNormalOffset"+a:this._directionalShadowMapProjection(e,a,i,n,"getShadowCoordOrthoNormalOffset")},_addVaryingIfNeeded:function(t,e,s){return t.indexOf(s)>=0?"varying "+e+" "+s+";\n":""},_getLightSourceShapeString:function(t){switch(t){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}},_getPassDefineString:function(t){return 18===t?"#define PICK_PASS\n":2===t?"#define DEPTH_PASS\n":t>=3&&t<=17?"#define SHADOW_PASS\n":""},_vsAddTransformCode:function(t,e,s,i){return t+=s.transformVS},_vsAddBaseCode:function(t,e,s,i){return t+=s.baseVS,1!==i.nineSlicedMode&&2!==i.nineSlicedMode||(t+=s.baseNineSlicedVS),t},_fsAddBaseCode:function(t,e,s,i){return t+=s.basePS,1===i.nineSlicedMode?t+=s.baseNineSlicedPS:2===i.nineSlicedMode&&(t+=s.baseNineSlicedTiledPS),2===i.nineSlicedMode?t+="const float textureBias = -1000.0;\n":t+="uniform float textureBias;\n",t},_decodeFunc:function(t){return ah[t]||"decodeGamma"},_fsAddStartCode:function(t,e,s,i){return t+=s.startPS,1===i.nineSlicedMode?t+=s.startNineSlicedPS:2===i.nineSlicedMode&&(t+=s.startNineSlicedTiledPS),t},_buildShadowPassFragmentCode:function(t,e,s,i,n){const a=i.pass-3,r=Math.floor(a/6),o=a-6*r;e.extStandardDerivatives&&!e.webgl2&&(t+="uniform vec2 polygonOffset;\n"),3===o?e.textureFloatHighPrecision?t+="#define VSM_EXPONENT 15.0\n\n":t+="#define VSM_EXPONENT 5.54\n\n":2===o&&(t+="#define VSM_EXPONENT 5.54\n\n"),0!==r&&(t+="uniform vec3 view_position;\n",t+="uniform float light_radius;\n"),t+=n,i.alphaTest&&(t+="uniform float textureBias;",t+="float dAlpha;\n",t+=this._addMap("opacity","opacityPS",i,s),t+=s.alphaTestPS),0!==o||e.webgl2&&1!==r?1===o&&(t+="vec2 encodeFloatRG( float v ) {\n",t+="\t\tvec2 enc = vec2(1.0, 255.0) * v;\n",t+="\t\tenc = fract(enc);\n",t+="\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",t+="\t\treturn enc;\n",t+="}\n\n"):t+=s.packDepthPS,t+="void main(void)\n{\n",i.alphaTest&&(t+="\t getOpacity();\n",t+="\t alphaTest(dAlpha);\n");return t+=1===r||(1===o||2===o||3===o)&&0!==r?"\t float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":"\t float depth = gl_FragCoord.z;\n",0!==o||e.webgl2&&(1!==r||i.clusteredLightingEnabled)?0===o||4===o?(t+="\t gl_FragColor = vec4(1.0);\n",i.clusteredLightingEnabled&&1===r&&e.webgl2&&(t+="\t gl_FragDepth = depth;\n")):t+=1===o?"\t gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":s.storeEVSMPS:e.extStandardDerivatives&&!e.webgl2?(t+="\t float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",t+="\t depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n",t+="\t gl_FragColor = packFloat(depth);\n"):t+="\t gl_FragColor = packFloat(depth);\n",t+="}\n"},createShaderDefinition:function(t,e){let s=e.lights.length>0;e.dirLightMap&&(s=!0),e.clusteredLightingEnabled&&(s=!0),0===e.shadingModel?(e.fresnelModel=0,e.specularAntialias=!1,e.ambientSH=!1):e.fresnelModel=0===e.fresnelModel?2:e.fresnelModel;const i=!!e.reflectionSource;e.useSpecular||(e.specularMap=e.glossMap=null);const n=e.pass>=3&&e.pass<=17,a=s||i||e.ambientSH||e.heightMap||e.enableGGXSpecular||e.clusteredLightingEnabled&&!n||e.clearCoatNormalMap;this.options=e;let r,o,h="",l="",c="",d=Zr;const u={vertex_position:"POSITION"};if(e.chunks){const t={};for(const s in d)d.hasOwnProperty(s)&&(e.chunks[s]?(o=e.chunks[s],o.indexOf("vertex_normal")>=0&&(u.vertex_normal="NORMAL"),o.indexOf("vertex_tangent")>=0&&(u.vertex_tangent="TANGENT"),o.indexOf("vertex_texCoord0")>=0&&(u.vertex_texCoord0="TEXCOORD0"),o.indexOf("vertex_texCoord1")>=0&&(u.vertex_texCoord1="TEXCOORD1"),o.indexOf("vertex_color")>=0&&(u.vertex_color="COLOR"),o.indexOf("vertex_boneWeights")>=0&&(u.vertex_boneWeights="BLENDWEIGHT"),o.indexOf("vertex_boneIndices")>=0&&(u.vertex_boneIndices="BLENDINDICES"),t[s]=o):t[s]=d[s]);d=t}h+=this._getPassDefineString(e.pass),h=this._vsAddBaseCode(h,t,d,e),l+="\t vPositionW\t\t= getWorldPosition();\n",2===e.pass&&(h+="varying float vDepth;\n",h+="#ifndef VIEWMATRIX\n",h+="#define VIEWMATRIX\n",h+="uniform mat4 matrix_view;\n",h+="#endif\n",h+="#ifndef CAMERAPLANES\n",h+="#define CAMERAPLANES\n",h+="uniform vec4 camera_params;\n\n",h+="#endif\n",l+="\t\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),e.useInstancing&&(u.instance_line1="ATTR12",u.instance_line2="ATTR13",u.instance_line3="ATTR14",u.instance_line4="ATTR15",h+=d.instancingVS),a&&(u.vertex_normal="NORMAL",l+="\t vNormalW = getNormal();\n","sphereMap"===e.reflectionSource&&t.fragmentUniformsCount<=16&&(h+=d.viewNormalVS,l+="\t vNormalV\t\t= getViewNormal();\n"),(e.heightMap||e.normalMap||e.enableGGXSpecular)&&e.hasTangents?(u.vertex_tangent="TANGENT",h+=d.tangentBinormalVS,l+="\t vTangentW\t = getTangent();\n",l+="\t vBinormalW\t= getBinormal();\n"):e.enableGGXSpecular&&(h+=d.tangentBinormalVS,l+="\t vObjectSpaceUpW\t= getObjectSpaceUp();\n"));const p=[],m=[];for(const t in nh){const s=t+"Map";if(e[t+"VertexColor"]){const s=t+"VertexColorChannel";e[s]=this._correctChannel(t,e[s])}if(e[s]){const i=s+"Channel",n=s+"Transform",a=s+"Uv";e[a]=Math.min(e[a],1),e[i]=this._correctChannel(t,e[i]);const r=e[a];p[r]=!0,m[r]=m[r]||e[s]&&!e[n]}}e.forceUv1&&(p[1]=!0,m[1]=void 0===m[1]||m[1]);for(let t=0;t<2;t++)p[t]&&(u["vertex_texCoord"+t]="TEXCOORD"+t,h+=d["uv"+t+"VS"],l+="\t vec2 uv"+t+" = getUv"+t+"();\n"),m[t]&&(l+="\t vUv"+t+" = uv"+t+";\n");const f=[h,c,l,[]];for(const t in nh){const s=t+"Map";if(e[s]){const i=s+"Transform";if(e[i]){const n=s+"Uv";this._setMapTransform(f,t,e[i],e[n])}}}h=f[0],c=f[1],l=f[2],e.vertexColors&&(u.vertex_color="COLOR",l+="\t vVertexColor = vertex_color;\n"),(e.useMorphPosition||e.useMorphNormal)&&(e.useMorphTextureBased?(h+="#define MORPHING_TEXTURE_BASED\n",e.useMorphPosition&&(h+="#define MORPHING_TEXTURE_BASED_POSITION\n"),e.useMorphNormal&&(h+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),u.morph_vertex_id="ATTR15",h+="attribute float morph_vertex_id;\n"):(h+="#define MORPHING\n",e.useMorphPosition?(u.morph_pos0="ATTR8",u.morph_pos1="ATTR9",u.morph_pos2="ATTR10",u.morph_pos3="ATTR11",h+="#define MORPHING_POS03\n",h+="attribute vec3 morph_pos0;\n",h+="attribute vec3 morph_pos1;\n",h+="attribute vec3 morph_pos2;\n",h+="attribute vec3 morph_pos3;\n"):e.useMorphNormal&&(u.morph_nrm0="ATTR8",u.morph_nrm1="ATTR9",u.morph_nrm2="ATTR10",u.morph_nrm3="ATTR11",h+="#define MORPHING_NRM03\n",h+="attribute vec3 morph_nrm0;\n",h+="attribute vec3 morph_nrm1;\n",h+="attribute vec3 morph_nrm2;\n",h+="attribute vec3 morph_nrm3;\n"),e.useMorphNormal?(u.morph_nrm4="ATTR12",u.morph_nrm5="ATTR13",u.morph_nrm6="ATTR14",u.morph_nrm7="ATTR15",h+="#define MORPHING_NRM47\n",h+="attribute vec3 morph_nrm4;\n",h+="attribute vec3 morph_nrm5;\n",h+="attribute vec3 morph_nrm6;\n",h+="attribute vec3 morph_nrm7;\n"):(u.morph_pos4="ATTR12",u.morph_pos5="ATTR13",u.morph_pos6="ATTR14",u.morph_pos7="ATTR15",h+="#define MORPHING_POS47\n",h+="attribute vec3 morph_pos4;\n",h+="attribute vec3 morph_pos5;\n",h+="attribute vec3 morph_pos6;\n",h+="attribute vec3 morph_pos7;\n"))),e.skin?(u.vertex_boneWeights="BLENDWEIGHT",u.vertex_boneIndices="BLENDINDICES",h+=eo(t,d),h+="#define SKIN\n"):e.useInstancing&&(h+="#define INSTANCING\n"),e.screenSpace&&(h+="#define SCREENSPACE\n"),e.pixelSnap&&(h+="#define PIXELSNAP\n"),h=this._vsAddTransformCode(h,t,d,e),a&&(h+=d.normalVS),h+="\n",h+=d.startVS,h+=l,h+=d.endVS,h+="}";let _=h;const g=c;c="",c+=this._addVaryingIfNeeded(h,"vec4","vVertexColor"),c+=this._addVaryingIfNeeded(h,"vec3","vPositionW"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalV"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vTangentW"),c+=this._addVaryingIfNeeded(h,"vec3","vBinormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW"),c+=this._addVaryingIfNeeded(h,"vec2","vUv0"),c+=this._addVaryingIfNeeded(h,"vec2","vUv1"),c+=g,_=c+_;let y,v="";if(t.webgl2?(v=io(t),d.extensionVS&&(v+=d.extensionVS+"\n"),_=v+d.gles3VS+_):(d.extensionVS&&(v=d.extensionVS+"\n"),_=v+_),e.forceFragmentPrecision&&"highp"!==e.forceFragmentPrecision&&"mediump"!==e.forceFragmentPrecision&&"lowp"!==e.forceFragmentPrecision&&(e.forceFragmentPrecision=null),e.forceFragmentPrecision&&("highp"===e.forceFragmentPrecision&&"highp"!==t.maxPrecision&&(e.forceFragmentPrecision="mediump"),"mediump"===e.forceFragmentPrecision&&"lowp"===t.maxPrecision&&(e.forceFragmentPrecision="lowp")),h="",t.webgl2&&(h+=io(t)),t.webgl2||(t.extStandardDerivatives&&(h+="#extension GL_OES_standard_derivatives : enable\n"),t.extTextureLod&&(h+="#extension GL_EXT_shader_texture_lod : enable\n",h+="#define SUPPORTS_TEXLOD\n")),d.extensionPS&&(h+=d.extensionPS+"\n"),t.webgl2&&(h+=d.gles3PS),h+=e.forceFragmentPrecision?"precision "+e.forceFragmentPrecision+" float;\n\n":so(t),h+=this._getPassDefineString(e.pass),18===e.pass)return h+="uniform vec4 uColor;\n",h+=c,e.alphaTest&&(h+="uniform float textureBias;",h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",e,d),h+=d.alphaTestPS),h+="void main(void)\n{\n",e.alphaTest&&(h+="\t getOpacity();\n",h+="\t alphaTest(dAlpha);\n"),h+="\t\tgl_FragColor = uColor;\n",h+="}\n",{attributes:u,vshader:_,fshader:h};if(2===e.pass)return h+="varying float vDepth;\n",h+=c,h+=d.packDepthPS,e.alphaTest&&(h+="uniform float textureBias;",h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",e,d),h+=d.alphaTestPS),h+="void main(void)\n{\n",e.alphaTest&&(h+="\t getOpacity();\n",h+="\t alphaTest(dAlpha);\n"),h+="\t\tgl_FragColor = packFloat(vDepth);\n",h+="}\n",{attributes:u,vshader:_,fshader:h};if(n)return{attributes:u,vshader:_,fshader:this._buildShadowPassFragmentCode(h,t,d,e,c)};if(e.customFragmentShader)return y=h+e.customFragmentShader,{attributes:u,vshader:_,fshader:y,tag:1};h+=c,h=this._fsAddBaseCode(h,t,d,e),e.detailModes&&(h+=d.detailModesPS);const x=h;h="",e.clearCoat>0&&(h+="#define CLEARCOAT\n",h+="#define CLUSTER_CLEAR_COAT\n"),!1===e.opacityFadesSpecular&&(h+="uniform float material_alphaFade;\n");let b=0;const S=[];let w,T=!1,M=!1,C=!1,A=e.lights.some((function(t){return t._shape&&0!==t._shape}));e.clusteredLightingEnabled&&e.clusteredLightingAreaLightsEnabled&&(A=!0),7===t.areaLightLutFormat?(h+="#define AREA_R8_G8_B8_A8_LUTS\n",h+="#define AREA_LUTS_PRECISION lowp\n"):h+="#define AREA_LUTS_PRECISION highp\n",(A||e.clusteredLightingEnabled)&&(h+="#define AREA_LIGHTS\n",h+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;\n",h+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;\n");for(let s=0;s<e.lights.length;s++){const i=e.lights[s],n=i._type;if(e.clusteredLightingEnabled&&0!==n)continue;h+="uniform vec3 light"+s+"_color;\n",0===n?h+="uniform vec3 light"+s+"_direction;\n":(h+="uniform vec3 light"+s+"_position;\n",h+="uniform float light"+s+"_radius;\n",2===n&&(h+="uniform vec3 light"+s+"_direction;\n",h+="uniform float light"+s+"_innerConeAngle;\n",h+="uniform float light"+s+"_outerConeAngle;\n")),0!==(A&&i._shape?i._shape:0)&&(0===n&&(h+="uniform vec3 light"+s+"_position;\n"),h+="uniform vec3 light"+s+"_halfWidth;\n",h+="uniform vec3 light"+s+"_halfHeight;\n"),i.castShadows&&!e.noShadow&&(h+="uniform mat4 light"+s+"_shadowMatrix;\n",0===n&&(h+="uniform mat4 light"+s+"_shadowMatrixPalette[4];\n",h+="uniform float light"+s+"_shadowCascadeDistances[4];\n",h+="uniform float light"+s+"_shadowCascadeCount;\n"),0!==n?h+="uniform vec4 light"+s+"_shadowParams;\n":(T=!0,h+="uniform vec3 light"+s+"_shadowParams;\n"),1===n?h+="uniform samplerCube light"+s+"_shadowMap;\n":i._isPcf&&t.webgl2?h+="uniform sampler2DShadow light"+s+"_shadowMap;\n":h+="uniform sampler2D light"+s+"_shadowMap;\n",b++,S[i._shadowType]=!0,i._isVsm&&(M=!0),i._isPcf&&(t.webgl2||t.extStandardDerivatives)&&2===n&&(C=!0)),i._cookie&&(i._cookie._cubemap?1===n&&(h+="uniform samplerCube light"+s+"_cookie;\n",h+="uniform float light"+s+"_cookieIntensity;\n",i.castShadows&&!e.noShadow||(h+="uniform mat4 light"+s+"_shadowMatrix;\n")):2===n&&(h+="uniform sampler2D light"+s+"_cookie;\n",h+="uniform float light"+s+"_cookieIntensity;\n",i.castShadows&&!e.noShadow||(h+="uniform mat4 light"+s+"_shadowMatrix;\n"),i._cookieTransform&&(h+="uniform vec4 light"+s+"_cookieMatrix;\n",h+="uniform vec2 light"+s+"_cookieOffset;\n")))}if(h+="\n",w=!e.hasTangents&&t.extStandardDerivatives?d.TBNderivativePS:e.fastTbn?d.TBNfastPS:d.TBNPS,a)if(e.normalMap||e.clearCoatNormalMap){if(h+=e.packedNormal?d.normalXYPS:d.normalXYZPS,!e.hasTangents){const t=e.normalMap?"normalMap":"clearCoatNormalMap",s=this._getUvSourceExpression(`${t}Transform`,`${t}Uv`,e);w=w.replace(/\$UV/g,s)}h+=w}else e.enableGGXSpecular&&!e.heightMap&&(h+=d.normalVertexPS,h+=d.TBNObjectSpacePS);if(a)if(e.normalMap){e.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",e,d));const t=this._getUvSourceExpression("normalMapTransform","normalMapUv",e);e.normalizeNormalMap?h+=d.normalMapPS.replace(/\$UV/g,t):h+=d.normalMapFastPS.replace(/\$UV/g,t)}else e.enableGGXSpecular&&!e.heightMap||(h+=d.normalVertexPS);if(h+=Qr(e.gamma,d),h+=Jr(e.toneMap,d),h+=to(e.fog,d),h+=d.decodePS,e.useRgbm&&(h+=d.rgbmPS),e.useCubeMapRotation&&(h+="#define CUBEMAP_ROTATION\n"),a&&(h+=d.cubeMapRotatePS,h+=e.cubeMapProjection>0?d.cubeMapProjectBoxPS:d.cubeMapProjectNonePS,h+=e.skyboxIntensity?d.envMultiplyPS:d.envConstPS),e.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",e,d)),h+=this._addMap("diffuse","diffusePS",e,d),(3!==e.blendType||e.alphaTest||e.alphaToCoverage)&&(h+=this._addMap("opacity","opacityPS",e,d)),h+=this._addMap("emissive","emissivePS",e,d,e.emissiveFormat),s&&e.useSpecular||i){e.specularAntialias&&e.normalMap?e.normalizeNormalMap&&a?h+=d.specularAaToksvigPS:h+=d.specularAaToksvigFastPS:h+=d.specularAaNonePS;const t=e.useMetalness?"metalness":"specular";h+=this._addMap(t,t+"PS",e,d),h+=this._addMap("gloss","glossPS",e,d),2===e.fresnelModel&&(h+=d.fresnelSchlickPS)}if(e.clearCoat>0&&(h+=this._addMap("clearCoat","clearCoatPS",e,d),h+=this._addMap("clearCoatGloss","clearCoatGlossPS",e,d),h+=this._addMap("clearCoatNormal","clearCoatNormalPS",e,d)),e.heightMap){if(!e.normalMap){const t=this._getUvSourceExpression("heightMapTransform","heightMapUv",e);e.hasTangents||(w=w.replace(/\$UV/g,t)),h+=w}h+=this._addMap("height","parallaxPS",e,d)}const P=e.aoMap||e.aoVertexColor;if(P&&(h+=this._addMap("ao","aoPS",e,d),h+=d.aoDiffuseOccPS,e.occludeSpecular&&(1===e.occludeSpecular?h+=e.occludeSpecularFloat?d.aoSpecOccSimplePS:d.aoSpecOccConstSimplePS:h+=e.occludeSpecularFloat?d.aoSpecOccPS:d.aoSpecOccConstPS)),"envAtlas"===e.reflectionSource)h+=d.reflectionEnvPS.replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding));else if("cubeMap"===e.reflectionSource)h+=e.fixSeams?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS,h+=d.reflectionCubePS.replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding));else if("sphereMap"===e.reflectionSource){h+=(t.fragmentUniformsCount>16?d.reflectionSpherePS:d.reflectionSphereLowPS).replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding))}i&&(e.clearCoat>0&&(h+=d.reflectionCCPS),e.refraction&&(h+=d.refractionPS)),e.clusteredLightingEnabled&&(h+=d.clusteredLightUtilsPS,h+=d.clusteredLightCookiesPS,S[0]=!0,S[4]=!0,C=!0),(b>0||e.clusteredLightingEnabled)&&(T&&(h+=d.shadowCascadesPS),S[0]&&(h+=d.shadowStandardPS),S[4]&&t.webgl2&&(h+=d.shadowStandardGL2PS),M&&(h+=d.shadowVSM_commonPS,S[1]&&(h+=d.shadowVSM8PS),S[2]&&(h+=t.extTextureHalfFloatLinear?d.shadowEVSMPS.replace(/\$/g,"16"):d.shadowEVSMnPS.replace(/\$/g,"16")),S[3]&&(h+=t.extTextureFloatLinear?d.shadowEVSMPS.replace(/\$/g,"32"):d.shadowEVSMnPS.replace(/\$/g,"32"))),t.webgl2||t.extStandardDerivatives||(h+=d.biasConstPS),h+=d.shadowCoordPS+d.shadowCommonPS,C&&(h+=d.shadowCoordPerspZbufferPS)),e.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n"),s&&(h+=d.lightDiffuseLambertPS,(A||e.clusteredLightingEnabled)&&(h+=d.ltc)),h+="\n";let E=!1;e.useSpecular?(h+="#define CLUSTER_SPECULAR\n",e.conserveEnergy&&(h+="#define CLUSTER_CONSERVE_ENERGY\n"),s&&(h+=0===e.shadingModel?d.lightSpecularPhongPS:e.enableGGXSpecular?d.lightSpecularAnisoGGXPS:d.lightSpecularBlinnPS),e.fresnelModel>0?e.conserveEnergy&&!A?h+=d.combineDiffuseSpecularPS:h+=d.combineDiffuseSpecularNoConservePS:i?h+=d.combineDiffuseSpecularOldPS:e.diffuseMap?h+=d.combineDiffuseSpecularNoReflPS:(h+=d.combineDiffuseSpecularNoReflSeparateAmbientPS,E=!0)):h+=d.combineDiffusePS,e.clearCoat>0&&(h+=d.combineClearCoatPS);let R=!0;if(e.lightMap||e.lightVertexColor){const t=e.dirLightMap&&e.useSpecular?"lightmapDirPS":"lightmapSinglePS";h+=this._addMap("light",t,e,d,e.lightMapFormat),R=e.lightMapWithoutAmbient}R&&("ambientSH"===e.ambientSource?h+=d.ambientSHPS:"envAtlas"===e.ambientSource?h+=d.ambientEnvPS.replace(/\$DECODE/g,this._decodeFunc(e.ambientEncoding)):h+=d.ambientConstantPS),e.ambientTint&&!E&&(h+="uniform vec3 material_ambient;\n"),e.alphaTest&&(h+=d.alphaTestPS),e.msdf&&(h+=d.msdfPS),a&&(h+=d.viewDirPS,e.useSpecular&&(h+=e.enableGGXSpecular?d.reflDirAnisoPS:d.reflDirPS));let L,I=!1,D=!1,O=!1,F=!1,k=!1;e.clusteredLightingEnabled&&s&&(F=!0,I=!0,D=!0,k=!0,h+=d.floatUnpackingPS,e.lightMaskDynamic&&(h+="\n#define CLUSTER_MESH_DYNAMIC_LIGHTS"),e.clusteredLightingCookiesEnabled&&(h+="\n#define CLUSTER_COOKIES"),e.clusteredLightingShadowsEnabled&&!e.noShadow&&(h+="\n#define CLUSTER_SHADOWS",h+="\n#define CLUSTER_SHADOW_TYPE_"+fe[e.clusteredLightingShadowType]),e.clusteredLightingAreaLightsEnabled&&(h+="\n#define CLUSTER_AREALIGHTS"),h+=ih.shaderDefines,h+=d.clusteredLightShadowsPS,h+=d.clusteredLightPS),e.twoSidedLighting&&(h+="uniform float twoSidedLightingNegScaleFactor;\n"),h=this._fsAddStartCode(h,t,d,e),a&&(e.hasTangents||!t.extStandardDerivatives||e.fastTbn?e.twoSidedLighting?h+="\t dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n":h+="\t dVertexNormalW = vNormalW;\n":e.twoSidedLighting?h+="\t dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":h+="\t dVertexNormalW = normalize(vNormalW);\n",(e.heightMap||e.normalMap)&&e.hasTangents&&(e.twoSidedLighting?(h+="\t dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",h+="\t dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(h+="\t dTangentW = vTangentW;\n",h+="\t dBinormalW = vBinormalW;\n")));let B=!1;3!==e.blendType||e.alphaTest||e.alphaToCoverage?e.heightMap&&e.opacityMap?B=!0:(h+="\t getOpacity();\n",e.alphaTest&&(h+="\t alphaTest(dAlpha);\n")):h+="\t dAlpha = 1.0;\n";let z=!1;if(a&&(h+="\t getViewDir();\n",(e.heightMap||e.normalMap||e.clearCoatNormalMap||e.enableGGXSpecular)&&(h+="\t getTBN();\n"),e.heightMap&&(h+="\t getParallax();\n"),B&&(h+="\t getOpacity();\n",e.alphaTest&&(h+="\t alphaTest(dAlpha);\n")),h+="\t getNormal();\n",e.useSpecular&&(s&&e.enableGGXSpecular&&(h+="\t getGlossiness();\n",z=!0),h+="\t getReflDir();\n")),h+="\t getAlbedo();\n",e.clearCoat>0&&(h+="\t getClearCoat();\n",h+="\t getClearCoatGlossiness();\n",h+="\t getClearCoatNormal();\n"),(s&&e.useSpecular||i)&&(h+="\t getSpecularity();\n",z||(h+="\t getGlossiness();\n"),A&&(h+="\t #ifdef AREA_LIGHTS\n",h+="\t dSpecularityNoFres = dSpecularity;\n",h+="\t #ifdef CLEARCOAT\n",h+="\t ccSpecularityNoFres = ccSpecularity;\n",h+="\t #endif\n",h+="\t #endif\n"),e.fresnelModel>0&&(h+="\t getFresnel();\n")),P&&(h+="\tgetAO();\n"),R&&(h+="\t addAmbient();\n",e.separateAmbient&&(h+="\n\t\t\t\t\t\t\t\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = vec3(0);\n\t\t\t\t\t\t\t\t")),e.ambientTint&&!E&&(h+="\t dDiffuseLight *= material_ambient;\n"),P&&!e.occludeDirect&&(h+="\t\toccludeDiffuse();\n"),(e.lightMap||e.lightVertexColor)&&(h+="\t addLightMap();\n"),s||i){i&&(e.clearCoat>0&&(h+="\t addReflectionCC();\n"),h+="\t addReflection();\n"),A&&(h+="\t ccReflection.rgb *= ccSpecularity;\n",h+="\t dReflection.rgb *= dSpecularity;\n",h+="\t dSpecularLight *= dSpecularity;\n",h+="\t float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n",h+="\t calcLTCLightValues();\n");for(let s=0;s<e.lights.length;s++){const i=e.lights[s],n=i._type;if(e.clusteredLightingEnabled&&0!==n)continue;L=!1;const a=A&&i._shape?i.shape:0,o=A&&i._shape?this._getLightSourceShapeString(a):"";if(0!==a&&(h+="\t calc"+o+"LightValues(light"+s+"_position, light"+s+"_halfWidth, light"+s+"_halfHeight);\n"),0===n?(h+="\t dLightDirNormW = light"+s+"_direction;\n",h+="\t dAtten = 1.0;\n"):(i._cookie&&(2!==n||i._cookie._cubemap?1===n&&i._cookie._cubemap&&(k=!0,L=!0):(k=!0,L=!0)),h+="\t getLightDirPoint(light"+s+"_position);\n",I=!0,L&&(h+=2===n?"\t dAtten3 = getCookie2D"+(i._cookieFalloff?"":"Clip")+(i._cookieTransform?"Xform":"")+"(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity"+(i._cookieTransform?", light"+s+"_cookieMatrix, light"+s+"_cookieOffset":"")+")."+i._cookieChannel+";\n":"\t dAtten3 = getCookieCube(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity)."+i._cookieChannel+";\n"),0===a?0===i._falloffMode?(h+="\t dAtten = getFalloffLinear(light"+s+"_radius);\n",D=!0):(h+="\t dAtten = getFalloffInvSquared(light"+s+"_radius);\n",O=!0):(h+="\t dAtten = getFalloffWindow(light"+s+"_radius);\n",O=!0),h+="\t if (dAtten > 0.00001) {\n",2===n&&(L&&!i._cookieFalloff||(h+="\t\t\t dAtten *= getSpotEffect(light"+s+"_direction, light"+s+"_innerConeAngle, light"+s+"_outerConeAngle);\n",F=!0))),h+=0!==a?0===n?"\t\t\t dAttenD = getLightDiffuse();\n":"\t\t\t dAttenD = get"+o+"LightDiffuse() * 16.0;\n":"\t\t\t dAtten *= getLightDiffuse();\n",i.castShadows&&!e.noShadow){let a,o=null;if(1===i._shadowType?(o="VSM8",a="0.0"):2===i._shadowType?(o="VSM16",a="5.54"):3===i._shadowType?(o="VSM32",a=t.textureFloatHighPrecision?"15.0":"5.54"):o=4===i._shadowType?"PCF5x5":"PCF3x3",null!==o)if(1===n)r="(light"+s+"_shadowMap, light"+s+"_shadowParams);\n",i._normalOffsetBias&&(h+="\t\t\t normalOffsetPointShadow(light"+s+"_shadowParams);\n"),h+="\t\t\t dAtten *= getShadowPoint"+o+r;else{const r=`light${s}_shadowMatrix`,l=`light${s}_shadowParams`;h+=this._nonPointShadowMapProjection(t,e.lights[s],r,l,s),2===n&&(o="Spot"+o),h+="\t\t\t dAtten *= getShadow"+o+"(light"+s+"_shadowMap, light"+s+"_shadowParams"+(i._isVsm?", "+a:"")+");\n"}}0!==a?e.conserveEnergy&&e.useSpecular?h+="\t\t\t dDiffuseLight += mix((dAttenD * dAtten) * light"+s+"_color"+(L?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n":h+="\t\t\t dDiffuseLight += (dAttenD * dAtten) * light"+s+"_color"+(L?" * dAtten3":"")+";\n":A&&e.conserveEnergy&&e.useSpecular?h+="\t\t\t dDiffuseLight += mix(dAtten * light"+s+"_color"+(L?" * dAtten3":"")+", vec3(0), dSpecularity);\n":h+="\t\t\t dDiffuseLight += dAtten * light"+s+"_color"+(L?" * dAtten3":"")+";\n",0!==a?(e.clearCoat>0&&(h+="\t\t\t ccSpecularLight += ccLTCSpecFres * get"+o+"LightSpecularCC() * dAtten * light"+s+"_color"+(L?" * dAtten3":"")+";\n"),e.useSpecular&&(h+="\t\t\t dSpecularLight += dLTCSpecFres * get"+o+"LightSpecular() * dAtten * light"+s+"_color"+(L?" * dAtten3":"")+";\n")):A?(e.clearCoat>0&&(h+="\t\t\t ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+s+"_color"+(L?" * dAtten3":"")+";\n"),e.useSpecular&&(h+="\t\t\t dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+s+"_color"+(L?" * dAtten3":"")+";\n")):(e.clearCoat>0&&(h+="\t\t\t ccSpecularLight += getLightSpecularCC() * dAtten * light"+s+"_color"+(L?" * dAtten3":"")+";\n"),e.useSpecular&&(h+="\t\t\t dSpecularLight += getLightSpecular() * dAtten * light"+s+"_color"+(L?" * dAtten3":"")+";\n")),0!==n&&(h+="\t }\n"),h+="\n"}e.clusteredLightingEnabled&&s&&(D=!0,O=!0,I=!0,h+="\t addClusteredLights();\n"),A&&(e.clearCoat>0&&(h+="\t ccSpecularity = 1.0;\n"),e.useSpecular&&(h+="\t dSpecularity = vec3(1);\n")),i&&e.refraction&&(h+="\t addRefraction();\n")}h+="\n",P&&(e.occludeDirect&&(h+="\t\toccludeDiffuse();\n"),e.occludeSpecular&&(h+="\t\toccludeSpecular();\n")),!1===e.opacityFadesSpecular&&(2!==e.blendType&&4!==e.blendType||(h+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n",h+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",h+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"),h+="dAlpha *= material_alphaFade;\n"),h+=d.endPS,2===e.blendType||6===e.blendType||e.alphaToCoverage?h+=d.outputAlphaPS:4===e.blendType?h+=d.outputAlphaPremulPS:h+=d.outputAlphaOpaquePS,e.msdf&&(h+="\t gl_FragColor = applyMsdf(gl_FragColor);\n"),h+="\n",h+="}\n",I&&(h=d.lightDirPointPS+h),D&&(h=d.falloffLinearPS+h),O&&(h=d.falloffInvSquaredPS+h),F&&(h=d.spotPS+h),k&&(h=d.cookiePS+h);let U="";return h.includes("dReflection")&&(U+="vec4 dReflection;\n"),h.includes("dTBN")&&(U+="mat3 dTBN;\n"),h.includes("dAlbedo")&&(U+="vec3 dAlbedo;\n"),h.includes("dEmission")&&(U+="vec3 dEmission;\n"),h.includes("dNormalW")&&(U+="vec3 dNormalW;\n"),h.includes("dVertexNormalW")&&(U+="vec3 dVertexNormalW;\n"),h.includes("dTangentW")&&(U+="vec3 dTangentW;\n"),h.includes("dBinormalW")&&(U+="vec3 dBinormalW;\n"),h.includes("dViewDirW")&&(U+="vec3 dViewDirW;\n"),h.includes("dReflDirW")&&(U+="vec3 dReflDirW;\n"),h.includes("dDiffuseLight")&&(U+="vec3 dDiffuseLight;\n"),h.includes("dSpecularLight")&&(U+="vec3 dSpecularLight;\n"),h.includes("dLightDirNormW")&&(U+="vec3 dLightDirNormW;\n"),h.includes("dLightDirW")&&(U+="vec3 dLightDirW;\n"),h.includes("dLightPosW")&&(U+="vec3 dLightPosW;\n"),h.includes("dShadowCoord")&&(U+="vec3 dShadowCoord;\n"),h.includes("dNormalMap")&&(U+="vec3 dNormalMap;\n"),h.includes("dSpecularity")&&(U+="vec3 dSpecularity;\n"),h.includes("dSpecularityNoFres")&&(U+="vec3 dSpecularityNoFres;\n"),h.includes("dUvOffset")&&(U+="vec2 dUvOffset;\n"),h.includes("dGlossiness")&&(U+="float dGlossiness;\n"),h.includes("dAlpha")&&(U+="float dAlpha;\n"),h.includes("dAtten")&&(U+="float dAtten;\n"),h.includes("dAttenD")&&(U+="float dAttenD;\n"),h.includes("dAtten3")&&(U+="vec3 dAtten3;\n"),h.includes("dAo")&&(U+="float dAo;\n"),h.includes("dMsdf")&&(U+="vec4 dMsdf;\n"),h.includes("ccReflection")&&(U+="vec4 ccReflection;\n"),h.includes("ccNormalW")&&(U+="vec3 ccNormalW;\n"),h.includes("ccReflDirW")&&(U+="vec3 ccReflDirW;\n"),h.includes("ccSpecularLight")&&(U+="vec3 ccSpecularLight;\n"),h.includes("ccSpecularity")&&(U+="float ccSpecularity;\n"),h.includes("ccSpecularityNoFres")&&(U+="float ccSpecularityNoFres;\n"),h.includes("ccGlossiness")&&(U+="float ccGlossiness;\n"),h=x+U+h,y=h,{attributes:u,vshader:_,fshader:y,tag:1}}},oh={begin:ao,dummyFragmentCode:no,end:ro,fogCode:to,gammaCode:Qr,precisionCode:so,skinCode:eo,tonemapCode:Jr,versionCode:io,basic:go,particle:yo,skybox:vo,standard:rh},hh=function(t,e,s){const i=2.399963229728653*e,n=Math.sqrt(e)/Math.sqrt(s);t.x=n*Math.cos(i),t.y=n*Math.sin(i)},lh=function(t,e,s,i=0,n=1){i=1-2*i,n=1-2*n;const a=q.lerp(i,n,e/s),r=Math.sqrt(1-a*a),o=2.399963229728653*e;t.x=Math.cos(o)*r,t.y=a,t.z=Math.sin(o)*r},ch=function(t){let e=(t<<16|t>>>16)>>>0;return e=((1431655765&e)<<1|(2863311530&e)>>>1)>>>0,e=((858993459&e)<<2|(3435973836&e)>>>2)>>>0,e=((252645135&e)<<4|(4042322160&e)>>>4)>>>0,e=((16711935&e)<<8|(4278255360&e)>>>8)>>>0,2.3283064365386963e-10*e},dh=t=>{switch(t.type){case"rgbm":return"RGBM";case"rgbe":return"RGBE";default:switch(t.format){case 11:case 13:case 12:case 14:return"Linear";default:return"Gamma"}}},uh=t=>{switch(t){case"cube":return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},ph=(t,e,s)=>{if(t<=0)e[s+0]=0,e[s+1]=0,e[s+2]=0,e[s+3]=0;else if(t>=1)e[s+0]=255,e[s+1]=0,e[s+2]=0,e[s+3]=0;else{let i=1*t%1,n=255*t%1,a=65025*t%1;const r=16581375*t%1;i-=n/255,n-=a/255,a-=r/255,e[s+0]=Math.min(255,Math.floor(256*i)),e[s+1]=Math.min(255,Math.floor(256*n)),e[s+2]=Math.min(255,Math.floor(256*a)),e[s+3]=Math.min(255,Math.floor(256*r))}},mh=(t,e,s,i)=>{const n=2*s*Math.PI,a=Math.pow(1-e,1/(i+1)),r=Math.sqrt(1-a*a);t.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},fh=(t,e,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-e),a=Math.sqrt(e);t.set(Math.cos(i)*a,Math.sin(i)*a,n).normalize()},_h=(t,e,s,i)=>{const n=2*s*Math.PI,a=Math.sqrt((1-e)/(1+(i*i-1)*e)),r=Math.sqrt(1-a*a);t.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},gh=(t,e)=>{const s=t*e,i=e/(1-t*t+s*s);return i*i*(1/Math.PI)},yh={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},vh=(t,e,s)=>{const i=s/t,n=1-Math.log2(e)/11,a=n*n,r=new at,o=new at,h=new at(0,0,1),l=[],c=((t,e)=>{const s=yh[t];return s&&s[e]||t})(t,e);for(let t=0;t<c;++t){_h(r,t/c,ch(t),a);const e=r.z;if(o.set(r.x,r.y,r.z).mulScalar(2*e).sub(h),o.z>0){const t=gh(Math.min(1,e),a)/4+.001,s=.5*Math.log2(i/t);l.push(o.x,o.y,o.z,s)}}for(;l.length<4*t;)l.push(0,0,0,0);return l},xh=(t,e,s)=>{const i=(t=>{const e=t.length,s=Math.min(e,512),i=Math.ceil(e/s),n=new Uint8Array(s*i*4);let a=0;for(let s=0;s<e;++s)ph(.5*t[4*s+0]+.5,n,a+0),ph(.5*t[4*s+1]+.5,n,a+4),ph(.5*t[4*s+2]+.5,n,a+8),ph(t[4*s+3]/8,n,a+12),a+=16;return{width:s,height:i,data:n}})(s);return new Mo(t,{name:e,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class bh{constructor(t=!0){this.map=new Map,this.destroyContent=t}destroy(){this.destroyContent&&this.map.forEach(((t,e)=>{t.destroy()}))}get(t,e){if(!this.map.has(t)){const s=e();return this.map.set(t,s),s}return this.map.get(t)}}const Sh=new bh(!1),wh=new Xr,Th=(t,e,s)=>wh.get(t,(()=>new bh)).get(e,(()=>xh(t,e,Sh.get(e,s)))),Mh=(t,e,s)=>Th(t,`lambert-samples-${e}-${s}`,(()=>((t,e)=>{const s=e/t,i=new at,n=[];for(let e=0;e<t;++e){fh(i,e/t,ch(e));const a=i.z/Math.PI,r=.5*Math.log2(s/a);n.push(i.x,i.y,i.z,r)}return n})(e,s))),Ch=(t,e,s)=>Th(t,`phong-samples-${e}-${s}`,(()=>((t,e)=>{const s=new at,i=[];for(let n=0;n<t;++n)mh(s,n/t,ch(n),e),i.push(s.x,s.y,s.z,0);return i})(e,s))),Ah=(t,e,s,i)=>Th(t,`ggx-samples-${e}-${s}-${i}`,(()=>vh(e,s,i))),Ph="\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = (vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw;\n}\n";function Eh(t,e,s={}){var i;t instanceof il&&(t=arguments[1],e=arguments[2],s={},void 0!==arguments[3]&&(s.specularPower=arguments[3]),void 0!==arguments[4]&&(s.numSamples=arguments[4]));const n={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},a=s.hasOwnProperty("specularPower")?s.specularPower:1,r=s.hasOwnProperty("face")?s.face:null,o=s.hasOwnProperty("distribution")?s.distribution:1===a?"none":"phong",h=n[o]||"reproject",l=`decode${dh(t)}`,c=`encode${dh(e)}`,d=`sample${uh(t.projection)}`,u=`getDirection${uh(e.projection)}`,p=s.hasOwnProperty("numSamples")?s.numSamples:1024,m=`${h}_${l}_${c}_${d}_${u}_${p}`,f=t.device;let _=f.programLib._cache[m];if(!_){const t=`#define PROCESS_FUNC ${h}\n#define DECODE_FUNC ${l}\n#define ENCODE_FUNC ${c}\n#define SOURCE_FUNC ${d}\n#define TARGET_FUNC ${u}\n#define NUM_SAMPLES ${p}\n#define NUM_SAMPLES_SQRT ${Math.round(Math.sqrt(p)).toFixed(1)}\n`+(f.extTextureLod?"#define SUPPORTS_TEXLOD\n":"");let e="";f.webgl2||(e="#extension GL_OES_standard_derivatives: enable\n",f.extTextureLod&&(e+="#extension GL_EXT_shader_texture_lod: enable\n\n")),_=co(f,Ph,`${t}\n${Zr.reprojectPS}`,m,!1,e)}const g=f.scope.resolve(t.cubemap?"sourceCube":"sourceTex");g.setValue(t);const y=f.scope.resolve("params"),v=f.scope.resolve("params2"),x=f.scope.resolve("uvMod");if(null!=(i=s)&&i.seamPixels){const t=s.seamPixels,i=(s.rect?s.rect.z:e.width)-2*t,n=(s.rect?s.rect.w:e.height)-2*t;x.setValue([(i+2*t)/i,(n+2*t)/n,-t/i,-t/n])}else x.setValue([1,1,0,0]);const b=[0,a,t.fixCubemapSeams?1/t.width:0,e.fixCubemapSeams?1/e.width:0],S=[e.width*e.height*(e.cubemap?6:1),t.width*t.height*(t.cubemap?6:1)];if(h.startsWith("prefilterSamples")){const e=t.width*t.height*(t.cubemap?6:1),s="ggx"===o?Ah(f,p,a,e):"lambert"===o?Mh(f,p,e):Ch(f,p,a);f.scope.resolve("samplesTex").setValue(s),f.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let t=0;t<(e.cubemap?6:1);t++)if(null===r||t===r){var w;const i=new al({colorBuffer:e,face:t,depth:!1});b[0]=t,y.setValue(b),v.setValue(S),Yr(f,i,_,null==(w=s)?void 0:w.rect),i.destroy()}}const Rh=(t,e=0)=>1+Math.floor(Math.log2(Math.max(t,e)));class Lh{static generateSkyboxCubemap(t,e){const s=((t,e,s,i)=>new Mo(t,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:s,type:7===s?"rgbm":"default",addressU:1,addressV:1,fixCubemapSeams:!0,mipmaps:!!i}))(t.device,e||(t.cubemap?t.width:t.width/4),7,!1);return Eh(t,s,{numSamples:1024}),s}static generateLightingSource(t,e=null){const s=t.device,i=(t=>(t=>t.extTextureHalfFloat&&t.textureHalfFloatRenderable)(t)?12:(t=>t.extTextureFloat&&t.textureFloatRenderable)(t)?14:7)(s),n=(null==e?void 0:e.target)||new Mo(s,{name:"lighting-source",cubemap:!0,width:(null==e?void 0:e.size)||128,height:(null==e?void 0:e.size)||128,format:i,type:7===i?"rgbm":"default",addressU:1,addressV:1,fixCubemapSeams:!1,mipmaps:!0});return Eh(t,n,{numSamples:t.mipmaps?1:1024}),n}static generateAtlas(t,e=null){const s=t.device,i=(null==e?void 0:e.target)||new Mo(s,{name:"envAtlas",width:(null==e?void 0:e.size)||512,height:(null==e?void 0:e.size)||512,format:7,type:"rgbm",projection:"equirect",addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,a=new ht(0,0,512*n,256*n),r=Rh(256)-Rh(4);for(let e=0;e<r;++e)Eh(t,i,{numSamples:1,rect:a,seamPixels:n}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256*n,256*n,128*n);for(let s=1;s<7;++s)Eh(t,i,{numSamples:(null==e?void 0:e.numReflectionSamples)||1024,distribution:(null==e?void 0:e.distribution)||"ggx",specularPower:Math.max(1,2048>>2*s),rect:a,seamPixels:n}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128*n,384*n,64*n,32*n),Eh(t,i,{numSamples:(null==e?void 0:e.numAmbientSamples)||2048,distribution:"lambert",rect:a,seamPixels:n}),i}static generatePrefilteredAtlas(t,e=null){const s=t[0].device,i=(null==e?void 0:e.target)||new Mo(s,{name:"envPrefilteredAtlas",width:(null==e?void 0:e.size)||512,height:(null==e?void 0:e.size)||512,format:7,type:"rgbm",projection:"equirect",addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,a=new ht(0,0,512*n,256*n),r=Rh(512);for(let e=0;e<r;++e)Eh(t[0],i,{numSamples:1,rect:a,seamPixels:n}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256*n,256*n,128*n);for(let e=1;e<t.length;++e)Eh(t[e],i,{numSamples:1,rect:a,seamPixels:n}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128*n,384*n,64*n,32*n),null!=e&&e.legacyAmbient?Eh(t[5],i,{numSamples:1,rect:a,seamPixels:n}):Eh(t[0],i,{numSamples:(null==e?void 0:e.numSamples)||2048,distribution:"lambert",rect:a,seamPixels:n}),i}}const Ih=new Xr;function Dh(t){return Ih.get(t)}let Oh=0;class Fh{constructor(){this.name="Untitled",this.id=Oh++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0,this.separateAlphaBlend=!1,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.blendAlphaEquation=0,this.cull=1,this.depthTest=!0,this.depthFunc=3,this.depthWrite=!0,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}set shader(t){this._shader=t}get shader(){return this._shader}get transparent(){return this.blend||1!==this.blendSrc||0!==this.blendDst||0!==this.blendEquation}set blendType(t){const e=this.blend;switch(t){case 3:this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0;break;case 2:this.blend=!0,this.blendSrc=6,this.blendDst=8,this.blendEquation=0;break;case 4:this.blend=!0,this.blendSrc=1,this.blendDst=8,this.blendEquation=0;break;case 1:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=0;break;case 6:this.blend=!0,this.blendSrc=6,this.blendDst=1,this.blendEquation=0;break;case 7:this.blend=!0,this.blendSrc=4,this.blendDst=2,this.blendEquation=0;break;case 8:this.blend=!0,this.blendSrc=5,this.blendDst=1,this.blendEquation=0;break;case 5:this.blend=!0,this.blendSrc=4,this.blendDst=0,this.blendEquation=0;break;case 9:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=3;break;case 10:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=4}e!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}get blendType(){return this.transparent?this.blend&&6===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?2:this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?1:this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?6:this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation?7:this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?8:this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation?9:this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation?10:this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation?5:this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?4:2:3}copy(t){return this.name=t.name,this.shader=t.shader,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this.blend=t.blend,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.separateAlphaBlend=t.separateAlphaBlend,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendAlphaEquation=t.blendAlphaEquation,this.cull=t.cull,this.depthTest=t.depthTest,this.depthFunc=t.depthFunc,this.depthWrite=t.depthWrite,this.depthBias=t.depthBias,this.slopeDepthBias=t.slopeDepthBias,t.stencilFront&&(this.stencilFront=t.stencilFront.clone()),t.stencilBack&&(t.stencilFront===t.stencilBack?this.stencilBack=this.stencilFront:this.stencilBack=t.stencilBack.clone()),this.redWrite=t.redWrite,this.greenWrite=t.greenWrite,this.blueWrite=t.blueWrite,this.alphaWrite=t.alphaWrite,this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].updateKey()}updateUniforms(t,e){}updateShader(t,e,s,i,n,a){}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants={};for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let t=0;t<e._shader.length;t++)e._shader[t]=null}}getParameter(t){return this.parameters[t]}setParameter(t,e){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const s=this.parameters[t];s?s.data=e:this.parameters[t]={scopeId:null,data:e}}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;void 0===e&&(e=s);for(const i in e){const e=s[i];e&&(e.scopeId||(e.scopeId=t.scope.resolve(i)),e.scopeId.setValue(e.data))}}destroy(){this.variants={},this.shader=null;for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let t=0;t<e._shader.length;t++)e._shader[t]=null;if(e._material=null,e.mesh){const t=Dh(e.mesh.device);this!==t&&(e.material=t)}}}addMeshInstanceRef(t){this.meshInstances.push(t)}removeMeshInstanceRef(t){const e=this.meshInstances,s=e.indexOf(t);-1!==s&&e.splice(s,1)}}const kh=(t,e)=>{if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0},Bh=t=>1!==t.r||1!==t.g||1!==t.b;class zh{constructor(){this._mapXForms=null}updateMinRef(t,e,s,i,n,a,r,o){this._updateSharedOptions(t,s,i,n,r),this._updateMinOptions(t,i),this._updateUVOptions(t,i,n,!0)}updateRef(t,e,s,i,n,a,r,o){this._updateSharedOptions(t,s,i,n,r),this._updateEnvOptions(t,e,i,s),this._updateMaterialOptions(t,i),1===r&&(t.gamma&&(t.gamma=3),t.toneMap=0),t.hasTangents=n&&i.normalMap&&0!=(512&n),this._updateLightOptions(t,i,n,o,a),this._updateUVOptions(t,i,n,!1)}_updateSharedOptions(t,e,s,i,n){t.pass=n,t.alphaTest=s.alphaTest>0,t.forceFragmentPrecision=s.forceFragmentPrecision||"",t.chunks=s.chunks||"",t.blendType=s.blendType,t.forceUv1=s.forceUv1,t.separateAmbient=!1,t.screenSpace=i&&0!=(256&i),t.skin=i&&0!=(2&i),t.useInstancing=i&&0!=(32&i),t.useMorphPosition=i&&0!=(1024&i),t.useMorphNormal=i&&0!=(2048&i),t.useMorphTextureBased=i&&0!=(4096&i),t.nineSlicedMode=s.nineSlicedMode||0,e.clusteredLightingEnabled&&(t.clusteredLightingEnabled=!0,t.clusteredLightingCookiesEnabled=e.lighting.cookiesEnabled,t.clusteredLightingShadowsEnabled=e.lighting.shadowsEnabled,t.clusteredLightingShadowType=e.lighting.shadowType,t.clusteredLightingAreaLightsEnabled=e.lighting.areaLightsEnabled)}_updateUVOptions(t,e,s,i){let n=!1,a=!1,r=!1;s&&(n=0!=(4&s),a=0!=(8&s),r=0!=(16&s)),t.vertexColors=!1,this._mapXForms=[];for(const s in nh)this._updateTexOptions(t,e,s,n,a,r,i);this._mapXForms=null}_updateMinOptions(t,e){t.opacityTint=1!==e.opacity&&3!==e.blendType,t.lights=[]}_updateMaterialOptions(t,e){const s=(e.diffuseTint||!e.diffuseMap&&!e.diffuseVertexColor)&&Bh(e.diffuse),i=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||(n=e.specular,0!==n.r||0!==n.g||0!==n.b)||e.enableGGXSpecular||e.clearCoat>0);var n;const a=i&&!e.useMetalness&&(e.specularTint||!e.specularMap&&!e.specularVertexColor)&&Bh(e.specular),r=!e.emissiveMap||Bh(e.emissive)&&e.emissiveTint,o=1!==e.emissiveIntensity,h=!!e.normalMap&&(10===e.normalMap.format||"swizzleGGGR"===e.normalMap.type);t.opacityTint=1!==e.opacity&&3!==e.blendType?1:0,t.blendMapsWithColors=!0,t.ambientTint=e.ambientTint,t.diffuseTint=s?2:0,t.specularTint=a?2:0,t.metalnessTint=e.useMetalness&&e.metalness<1?1:0,t.glossTint=1,t.emissiveTint=(r?2:0)+(o?1:0),t.alphaToCoverage=e.alphaToCoverage,t.normalizeNormalMap=e.normalizeNormalMap,t.ambientSH=!!e.ambientSH,t.useSpecular=i,t.emissiveFormat=e.emissiveMap?"rgbm"===e.emissiveMap.type?1:14===e.emissiveMap.format?2:0:null,t.lightMapFormat=e.lightMap?"rgbm"===e.lightMap.type?1:14===e.lightMap.format?2:0:null,t.specularAntialias=e.specularAntialias&&!!e.normalMap&&!!e.normalMap.mipmaps&&!h,t.conserveEnergy=e.conserveEnergy,t.opacityFadesSpecular=e.opacityFadesSpecular,t.alphaFade=e.alphaFade,t.occludeSpecular=e.occludeSpecular,t.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.occludeDirect=e.occludeDirect,t.shadingModel=e.shadingModel,t.fresnelModel=e.fresnelModel,t.packedNormal=h,t.fastTbn=e.fastTbn,t.cubeMapProjection=e.cubeMapProjection,t.customFragmentShader=e.customFragmentShader,t.refraction=!!e.refraction,t.useMetalness=e.useMetalness,t.enableGGXSpecular=e.enableGGXSpecular,t.msdf=!!e.msdfMap,t.twoSidedLighting=e.twoSidedLighting,t.pixelSnap=e.pixelSnap,t.aoMapUv=e.aoUvSet,t.diffuseDetail=!!e.diffuseMap,t.normalDetail=!!e.normalMap,t.diffuseDetailMode=e.diffuseDetailMode,t.detailModes=!!t.diffuseDetail,t.clearCoat=!!e.clearCoat,t.clearCoatTint=1!==e.clearCoat?1:0,t.clearCoatGlossiness=!!e.clearCoatGlossiness,t.clearCoatGlossTint=1!==e.clearCoatGlossiness?1:0}_updateEnvOptions(t,e,s,i){t.fog=s.useFog?i.fog:"none",t.gamma=s.useGammaTonemap?i.gammaCorrection:0,t.toneMap=s.useGammaTonemap?i.toneMapping:-1,t.useRgbm=s.emissiveMap&&"rgbm"===s.emissiveMap.type||s.lightMap&&"rgbm"===s.lightMap.type,t.fixSeams=!!s.cubeMap&&s.cubeMap.fixCubemapSeams;const n=0===s.shadingModel;let a=!1;if(s.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=s.envAtlas.encoding):s.cubeMap?(t.reflectionSource="cubeMap",t.reflectionEncoding=s.cubeMap.encoding):s.sphereMap?(t.reflectionSource="sphereMap",t.reflectionEncoding=s.sphereMap.encoding):s.useSkybox&&i.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=i.envAtlas.encoding,a=!0):(t.reflectionSource=null,t.reflectionEncoding=null),s.ambientSH&&!n)t.ambientSource="ambientSH",t.ambientEncoding=null;else{const e=s.envAtlas||(s.useSkybox&&i.envAtlas?i.envAtlas:null);e&&!n?(t.ambientSource="envAtlas",t.ambientEncoding=e.encoding):(t.ambientSource="constant",t.ambientEncoding=null)}t.skyboxIntensity=a&&1!==i.skyboxIntensity,t.useCubeMapRotation=a&&i.skyboxRotation&&!i.skyboxRotation.equals(ft.IDENTITY)}_updateLightOptions(t,e,s,i,n){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.lightMapWithoutAmbient=!1,t.dirLightMap=!1,s&&(t.noShadow=0!=(1&s),0!=(64&s)&&(t.lightMapFormat=1,t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.lightMapWithoutAmbient=!e.lightMap,t.useRgbm=!0,0!=(128&s)&&(t.dirLightMap=!0),0!=(8192&s)&&(t.lightMapWithoutAmbient=!1))),e.useLighting){const e=[],a=s?s>>16:1;t.lightMaskDynamic=!!(1&a),i&&(this._collectLights(0,i[0],e,a),this._collectLights(1,i[1],e,a,n),this._collectLights(2,i[2],e,a,n)),t.lights=e}else t.lights=[];0===t.lights.length&&(t.noShadow=!0)}_updateTexOptions(t,e,s,i,n,a,r){const o=s+"Map",h=s+"VertexColor",l=s+"VertexColorChannel",c=o+"Channel",d=o+"Transform",u=o+"Uv";"light"!==s&&(t[o]=!1,t[c]="",t[d]=0,t[u]=0),t[h]=!1,t[l]="";const p="opacity"===s;if((!p||3!==e.blendType||0!==e.alphaTest||e.alphaToCoverage)&&(!r||p)&&("height"!==s&&e[h]&&a&&(t[h]=e[h],t[l]=e[l],t.vertexColors=!0),e[o])){let s=!0;0!==e[u]||i||(s=!1),1!==e[u]||n||(s=!1),s&&(t[o]=!!e[o],t[d]=this._getMapTransformID(e.getUniform(d),e[u]),t[c]=e[c],t[u]=e[u])}}_collectLights(t,e,s,i,n){for(let n=0;n<e.length;n++){const a=e[n];if(a.enabled&&a.mask&i){if(0!==t&&a.isStatic)continue;s.push(a)}}if(n)for(let e=0;e<n.length;e++){const i=n[e];i._type===t&&s.push(i)}}_getMapTransformID(t,e){if(!t)return 0;let s=this._mapXForms[e];s||(s=[],this._mapXForms[e]=s);for(let e=0;e<s.length;e++)if(kh(s[e][0].value,t[0].value)&&kh(s[e][1].value,t[1].value))return e+1;return s.push(t)}}const Uh={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",aoMapRotation:"number",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapRotation:"number",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMapRotation:"number",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapRotation:"number",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",netalnessMapRotation:"number",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",glossMapRotation:"number",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatMapRotation:"number",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatGlossMapRotation:"number",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",clearCoatNormalMapRotation:"number",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveMapMapRotation:"number",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapRotation:"number",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapRotation:"number",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapRotation:"number",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityMapRotation:"number",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",lightMapRotation:"number",depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture"},Vh=[];for(const t in Uh){"texture"===Uh[t]&&Vh.push(t)}const Nh=[];for(const t in Uh){"cubemap"===Uh[t]&&Nh.push(t)}const Wh={},Gh={};let Hh=new Set;class Xh extends Fh{constructor(){super(),this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new zh,this.reset()}reset(){Object.keys(Wh).forEach((t=>{this[`_${t}`]=Wh[t].value()})),this._chunks={},this._uniformCache={}}set chunks(t){this._dirtyShader=!0,this._chunks=t}get chunks(){return this._dirtyShader=!0,this._chunks}copy(t){super.copy(t),Object.keys(Wh).forEach((e=>{this[e]=t[e]}));for(const e in t._chunks)t._chunks.hasOwnProperty(e)&&(this._chunks[e]=t._chunks[e]);return this}_setParameter(t,e){Hh.add(t),this.setParameter(t,e)}_setParameters(t){t.forEach((t=>{this._setParameter(t.name,t.value)}))}_processParameters(t){const e=this[t];e.forEach((t=>{Hh.has(t)||delete this.parameters[t]})),this[t]=Hh,Hh=e,Hh.clear()}_updateMap(t){const e=t+"Map",s=this[e];if(s){this._setParameter("texture_"+e,s);const t=e+"Transform",i=this.getUniform(t);i&&this._setParameters(i)}}_allocUniform(t,e){let s=this._uniformCache[t];return s||(s=e(),this._uniformCache[t]=s),s}getUniform(t,e,s){return Gh[t](this,e,s)}updateUniforms(t,e){const s=s=>this.getUniform(s,t,e);this._setParameter("material_ambient",s("ambient")),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",s("diffuse")),this.useMetalness?(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_shininess",s("shininess")),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",s("emissive")),1!==this.emissiveIntensity&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const t in nh)this._updateMap(t);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&(this.shader=null,this.clearVariants())}updateEnvUniforms(t,e){const s=this.envAtlas||(this.useSkybox?e.envAtlas:null);s&&(this._setParameter("texture_envAtlas",s),this.useSkybox&&!e.skyboxRotation.equals(ft.IDENTITY)&&e._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",e._skyboxRotationMat3.data)),this._processParameters("_activeLightingParams")}updateShader(t,e,s,i,n,a){this.updateEnvUniforms(t,e);const r=n>1&&n<=18;let o=r?rh.optionsContextMin:rh.optionsContext;r?this.shaderOptBuilder.updateMinRef(o,t,e,this,s,i,n,a):this.shaderOptBuilder.updateRef(o,t,e,this,s,i,n,a),this.onUpdateShader&&(o=this.onUpdateShader(o));const h=t.getProgramLibrary();this.shader=h.getProgram("standard",o),s||(this.clearVariants(),this.variants[0]=this.shader),this._dirtyShader=!1}destroy(){for(const t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,super.destroy()}}Xh.TEXTURE_PARAMETERS=Vh,Xh.CUBEMAP_PARAMETERS=Nh;const qh=(t,e)=>{Gh[t]=e},jh=(t,e,s,i)=>{Object.defineProperty(Xh.prototype,t,{get:i||function(){return this[`_${t}`]},set:s}),Wh[t]={value:e}},Yh=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);jh(t.name,(()=>t.defaultValue),(function(t){const i=this[e];i!==t&&(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=t)}),t.getterFunc)},Kh=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);jh(t.name,(()=>t.defaultValue.clone()),(function(t){const i=this[e];i.equals(t)||(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=i.copy(t))}),t.getterFunc)},$h=t=>t.defaultValue&&t.defaultValue.clone?Kh(t):Yh(t);function Zh(t,e,s,i,n,a){nh[t]=s,$h({name:`${t}Map`,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t!=!!e||t&&(t.type!==e.type||t.fixCubemapSeams!==e.fixCubemapSeams||t.format!==e.format)}),$h({name:`${t}MapTiling`,defaultValue:new ot(1,1)}),$h({name:`${t}MapOffset`,defaultValue:new ot(0,0)}),$h({name:`${t}MapRotation`,defaultValue:0}),$h({name:`${t}MapUv`,defaultValue:e}),s>0&&$h({name:`${t}MapChannel`,defaultValue:i||(s>1?"rgb":"g")}),n&&($h({name:`${t}VertexColor`,defaultValue:!1}),s>0&&$h({name:`${t}VertexColorChannel`,defaultValue:i||(s>1?"rgb":"g")})),a&&$h({name:`${t}Mode`,defaultValue:"mul"});const r=`${t}MapTiling`,o=`${t}MapOffset`,h=`${t}MapRotation`,l=`${t}MapTransform`;qh(l,((t,e,s)=>{const i=t[r],n=t[o],a=t[h];if(1===i.x&&1===i.y&&0===n.x&&0===n.y&&0===a)return null;const c=t._allocUniform(l,(()=>[{name:`texture_${l}0`,value:new Float32Array(3)},{name:`texture_${l}1`,value:new Float32Array(3)}])),d=Math.cos(a*q.DEG_TO_RAD),u=Math.sin(a*q.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=n.x;const m=c[1].value;return m[0]=u*i.x,m[1]=d*i.y,m[2]=1-i.y-n.y,c}))}function Qh(t,e){$h({name:t,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${t}`]}}),qh(t,((e,s,i)=>{const n=e._allocUniform(t,(()=>new Float32Array(3))),a=e[t];return e.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(a.r,2.2),n[1]=Math.pow(a.g,2.2),n[2]=Math.pow(a.b,2.2)):(n[0]=a.r,n[1]=a.g,n[2]=a.b),n}))}function Jh(t,e,s){$h({name:t,defaultValue:e,dirtyShaderFunc:(t,e)=>(0===t||1===t)!=(0===e||1===e)}),qh(t,s)}function tl(t,e){$h({name:t,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t==!!e}),qh(t,e)}function el(t,e){$h({name:t,defaultValue:e})}!function(){Qh("ambient",new et(.7,.7,.7)),Qh("diffuse",new et(1,1,1)),Qh("specular",new et(0,0,0)),Qh("emissive",new et(0,0,0)),Jh("emissiveIntensity",1),Jh("shininess",25,((t,e,s)=>0===t.shadingModel?Math.pow(2,.01*t.shininess*11):.01*t.shininess)),Jh("heightMapFactor",1,((t,e,s)=>.025*t.heightMapFactor)),Jh("opacity",1),Jh("alphaFade",1),Jh("alphaTest",0),Jh("bumpiness",1),Jh("normalDetailMapBumpiness",1),Jh("reflectivity",1),Jh("occludeSpecularIntensity",1),Jh("refraction",0),Jh("refractionIndex",1/1.5),Jh("metalness",1),Jh("anisotropy",0),Jh("clearCoat",0),Jh("clearCoatGlossiness",1),Jh("clearCoatBumpiness",1),Jh("aoUvSet",0,null),tl("ambientSH"),tl("cubeMapProjectionBox",((t,e,s)=>{const i=t._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=t.cubeMapProjectionBox.getMin(),a=i[0].value;a[0]=n.x,a[1]=n.y,a[2]=n.z;const r=t.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=r.x,o[1]=r.y,o[2]=r.z,i})),el("ambientTint",!1),el("diffuseTint",!1),el("specularTint",!1),el("emissiveTint",!1),el("fastTbn",!1),el("specularAntialias",!1),el("useMetalness",!1),el("enableGGXSpecular",!1),el("occludeDirect",!1),el("normalizeNormalMap",!0),el("conserveEnergy",!0),el("opacityFadesSpecular",!0),el("occludeSpecular",1),el("shadingModel",1),el("fresnelModel",2),el("cubeMapProjection",0),el("customFragmentShader",null),el("forceFragmentPrecision",null),el("useFog",!0),el("useLighting",!0),el("useGammaTonemap",!0),el("useSkybox",!0),el("forceUv1",!1),el("pixelSnap",!1),el("twoSidedLighting",!1),el("nineSlicedMode",void 0),Zh("diffuse",0,3,"",!0),Zh("specular",0,3,"",!0),Zh("emissive",0,3,"",!0),Zh("normal",0,-1,"",!1),Zh("metalness",0,1,"",!0),Zh("gloss",0,1,"",!0),Zh("opacity",0,1,"a",!0),Zh("height",0,1,"",!1),Zh("ao",0,1,"",!0),Zh("light",1,3,"",!0),Zh("msdf",0,3,"",!1),Zh("diffuseDetail",0,3,"",!1,!0),Zh("normalDetail",0,-1,"",!1),Zh("clearCoat",0,1,"",!0),Zh("clearCoatGloss",0,1,"",!0),Zh("clearCoatNormal",0,-1,"",!1),tl("cubeMap"),tl("sphereMap"),tl("envAtlas");const t=[null,null,null,null,null,null];jh("prefilteredCubemaps",(()=>t.slice()),(function(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=t[n]||null;e[n]!==a&&(e[n]=a,s=!0),i=i&&!!e[n]}s&&(i?this.envAtlas=Lh.generatePrefilteredAtlas(e,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();class sl{constructor(t){this._device=t,this._cache={},this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};const e=new Xh;e.shaderOptBuilder.updateRef(this._defaultStdMatOption,t,{},e,null,[],0,null,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,t,{},e,null,[],3,null,null)}register(t,e){this.isRegistered(t)||(this._generators[t]=e)}unregister(t){this.isRegistered(t)&&delete this._generators[t]}isRegistered(t){return void 0!==this._generators[t]}getProgram(t,e){const s=this._generators[t];if(void 0===s)return null;const i=this._device,n=s.generateKey(e);let a=this._cache[n];if(!a){let r;e.lights&&(r=e.lights,e.lights=r.map((function(t){const e=t.clone?t.clone():t;return e.key=t.key,e}))),this.storeNewProgram(t,e),e.lights&&(e.lights=r),this._precached&&console.warn(`ProgramLibrary#getProgram: Cache miss for shader ${t} key ${n} after shaders precaching`);const o=s.createShaderDefinition(i,e);a=this._cache[n]=new $r(i,o)}return a}storeNewProgram(t,e){let s={};if("standard"===t){const t=this._getDefaultStdMatOptions(e.pass);for(const i in e)(e.hasOwnProperty(i)&&t[i]!==e[i]||"pass"===i)&&(s[i]=e[i])}else s=e;this._programsCollection.push(JSON.stringify({name:t,options:s}))}dumpPrograms(){let t="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";t+="let shaders = [",this._programsCollection[0]&&(t+="\n\t"+this._programsCollection[0]);for(let e=1;e<this._programsCollection.length;++e)t+=",\n\t"+this._programsCollection[e];t+="\n];\n",t+="device.programLib.precompile(shaders);\n",t+='if (pc.version != "1.54.0" || pc.revision != "8577cfea7")\n',t+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}clearCache(){const t=this._cache;this._isClearingCache=!0;for(const e in t)t.hasOwnProperty(e)&&t[e].destroy();this._cache={},this._isClearingCache=!1}removeFromCache(t){if(this._isClearingCache)return;const e=this._cache;for(const s in e)if(e.hasOwnProperty(s)&&e[s]===t){delete e[s];break}}_getDefaultStdMatOptions(t){return t>1&&t<=18?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(t){if(t){const e=new Array(t.length);for(let s=0;s<t.length;s++){if("standard"===t[s].name){const e=t[s].options,i=this._getDefaultStdMatOptions(e.pass);for(const t in i)i.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=i[t])}e[s]=this.getProgram(t[s].name,t[s].options)}}this._precached=!0}}class il extends _{constructor(t){super(),this.canvas=void 0,this.scope=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.precision=void 0,this.supportsInstancing=void 0,this.supportsUniformBuffers=!1,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.canvas=t,this._width=0,this._height=0,this._maxPixelRatio=1,this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this._vram={tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let t=0;t<=6;t++)this._primsPerFrame[t]=0;this._renderTargetCreationTime=0,this.scope=new _o("Device"),this.programLib=new sl(this);for(const t in oh)this.programLib.register(t,oh[t])}destroy(){this.fire("destroy")}postDestroy(){this.scope=null,this.canvas=null}toJSON(t){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null}getProgramLibrary(){return this.programLib}setProgramLibrary(t){this.programLib=t}setRenderTarget(t){this.renderTarget=t}getRenderTarget(){return this.renderTarget}_isBrowserInterface(t){return"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap}resizeCanvas(t,e){this._width=t,this._height=e;const s=Math.min(this._maxPixelRatio,L.browser?window.devicePixelRatio:1);t=Math.floor(t*s),e=Math.floor(e*s),this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e))}setResolution(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e)}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(t){}get fullscreen(){return!1}set maxPixelRatio(t){this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height)}get maxPixelRatio(){return this._maxPixelRatio}}const nl={depth:!0,face:0};class al{constructor(t){var e,s;const i=arguments[1],n=arguments[2];if(t instanceof il?(this._colorBuffer=i,t=n):this._colorBuffer=t.colorBuffer,this._colorBuffer&&(this._colorBuffer._isRenderTarget=!0),t=void 0!==t?t:nl,this._depthBuffer=t.depthBuffer,this._face=void 0!==t.face?t.face:0,this._depthBuffer){const t=this._depthBuffer._format;16===t?(this._depth=!0,this._stencil=!1):17===t?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else this._depth=void 0===t.depth||t.depth,this._stencil=void 0!==t.stencil&&t.stencil;var a,r;(this._device=(null==(e=this._colorBuffer)?void 0:e.device)||(null==(s=this._depthBuffer)?void 0:s.device)||t.graphicsDevice,this._samples=void 0!==t.samples?Math.min(t.samples,this._device.maxSamples):1,this.autoResolve=void 0===t.autoResolve||t.autoResolve,this.name=t.name,this.name)||(this.name=null==(a=this._colorBuffer)?void 0:a.name);this.name||(this.name=null==(r=this._depthBuffer)?void 0:r.name);this.name||(this.name="Untitled"),this.flipY=!!t.flipY,this.impl=this._device.createRenderTargetImpl(this)}destroy(){const t=this._device;if(t){const e=t.targets.indexOf(this);-1!==e&&t.targets.splice(e,1),this.destroyFrameBuffers()}}destroyFrameBuffers(){const t=this._device;t&&this.impl.destroy(t)}destroyTextureBuffers(){this._depthBuffer&&(this._depthBuffer.destroy(),this._depthBuffer=null),this._colorBuffer&&(this._colorBuffer.destroy(),this._colorBuffer=null)}init(){this.impl.init(this._device,this)}loseContext(){this.impl.loseContext()}resolve(t=!0,e=!!this._depthBuffer){this._device&&this.impl.resolve(this._device,this,t,e)}copy(t,e,s){if(!this._device){if(!t._device)return!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,s)}get colorBuffer(){return this._colorBuffer}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){var t,e;return(null==(t=this._colorBuffer)?void 0:t.width)||(null==(e=this._depthBuffer)?void 0:e.width)||this._device.width}get height(){var t,e;return(null==(t=this._colorBuffer)?void 0:t.height)||(null==(e=this._depthBuffer)?void 0:e.height)||this._device.height}}function rl(t,e){return Math.atan2(t*e,Math.sqrt(t*t+e*e+1))}function ol(t,e,s){let i=2*(t+.5)/s-1,n=2*(e+.5)/s-1;i*=1-1/s,n*=1-1/s;const a=1/s,r=i-a,o=n-a,h=i+a,l=n+a;let c=rl(r,o)-rl(r,l)-rl(h,o)+rl(h,l);return 0===t&&0===e||t===s-1&&0===e||0===t&&e===s-1||t===s-1&&e===s-1?c/=3:0!==t&&0!==e&&t!==s-1&&e!==s-1||(c*=.5),c}function hl(t,e,s){if(7!==e.format)return null;if(!e._levels[0]||!e._levels[0][0])return null;const i=e.width;if(!e._levels[0][0].length){if(!(e._levels[0][0]instanceof HTMLImageElement))return null;{const s=co(t,Zr.fullscreenQuadVS,Zr.fullscreenQuadPS,"fsQuadSimple"),n=t.scope.resolve("source");for(let a=0;a<6;a++){const r=e._levels[0][a],o=new Mo(t,{name:"prefiltered-cube",cubemap:!1,type:"default",format:e.format,width:i,height:i,mipmaps:!1});o._levels[0]=r,o.upload();const h=new Mo(t,{name:"prefiltered-cube",cubemap:!1,type:"default",format:e.format,width:i,height:i,mipmaps:!1}),l=new al({colorBuffer:h,depth:!1});n.setValue(o),Yr(t,l,s);const c=t.gl;c.bindFramebuffer(c.FRAMEBUFFER,l.impl._glFrameBuffer);const d=new Uint8Array(i*i*4);c.readPixels(0,0,o.width,o.height,c.RGBA,c.UNSIGNED_BYTE,d),e._levels[0][a]=d}}}const n=[];for(let t=0;t<i;t++)for(let e=0;e<i;e++){const s=e/(i-1)*2-1,a=t/(i-1)*2-1;n[t*i+e]=new at(s,a,1).normalize()}const a=new Float32Array(27);let r=0;for(let t=0;t<6;t++)for(let o=0;o<i;o++)for(let h=0;h<i;h++){const l=o*i+h,c=ol(h,o,i),d=4*c/17,u=8*c/17,p=15*c/17,m=5*c/68,f=15*c/68,_=n[l];let g,y,v;0===t?(g=_.z,y=-_.y,v=-_.x):1===t?(g=-_.z,y=-_.y,v=_.x):2===t?(g=_.x,y=_.z,v=_.y):3===t?(g=_.x,y=-_.z,v=-_.y):4===t?(g=_.x,y=-_.y,v=_.z):5===t&&(g=-_.x,y=-_.y,v=-_.z),s||(g=-g);const x=e._levels[0][t][4*l+3]/255;for(let s=0;s<3;s++){let i=e._levels[0][t][4*l+s]/255;"rgbm"===e.type?(i*=8*x,i*=i):i=Math.pow(i,2.2),a[0+s]+=i*d,a[3+s]+=i*u*g,a[6+s]+=i*u*y,a[9+s]+=i*u*v,a[12+s]+=i*p*g*v,a[15+s]+=i*p*v*y,a[18+s]+=i*p*y*g,a[21+s]+=i*m*(3*v*v-1),a[24+s]+=i*f*(g*g-y*y),r+=c}}for(let t=0;t<a.length;t++)a[t]*=4*Math.PI/r;return a}class ll{constructor(t,e,s,i=0,n){this.device=t,this.format=e,this.numIndices=s,this.usage=i,this.impl=t.createIndexBufferImpl(this);const a=Ur[e];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),t._vram.ib+=this.numBytes,this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.destroy(t),this.device._vram.ib-=this.storage.byteLength}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}_lockTypedArray(){const t=this.lock();return 2===this.format?new Uint32Array(t):1===this.format?new Uint16Array(t):new Uint8Array(t)}writeData(t,e){const s=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),s.set(t);else for(let i=0;i<e;i++)s[i]=t[i];else s.set(t);this.unlock()}readData(t){const e=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(e);else{t.length=0;for(let i=0;i<s;i++)t[i]=e[i]}return s}}function cl(t){this.array[this.index]=t}function dl(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function ul(t,e,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s}function pl(t,e,s,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s,this.array[this.index+3]=i}function ml(t,e,s){this.array[t]=e[s]}function fl(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1]}function _l(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2]}function gl(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2],this.array[t+3]=e[s+3]}function yl(t,e,s){e[s]=this.array[t]}function vl(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1]}function xl(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2]}function bl(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2],e[s+3]=this.array[t+3]}class Sl{constructor(t,e,s){switch(this.index=0,this.numComponents=e.numComponents,s.interleaved?this.array=new Fr[e.dataType](t,e.offset):this.array=new Fr[e.dataType](t,e.offset,s.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=cl,this.getToArray=yl,this.setFromArray=ml;break;case 2:this.set=dl,this.getToArray=vl,this.setFromArray=fl;break;case 3:this.set=ul,this.getToArray=xl,this.setFromArray=_l;break;case 4:this.set=pl,this.getToArray=bl,this.setFromArray=gl}}get(t){return this.array[this.index+t]}set(t,e,s,i){}getToArray(t,e,s){}setFromArray(t,e,s){}}class wl{constructor(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let t=0;t<e.elements.length;t++){const s=e.elements[t];this.accessors[t]=new Sl(this.buffer,s,e),this.element[s.name]=this.accessors[t]}}next(t=1){let e=0;const s=this.accessors,i=this.accessors.length;for(;e<i;){const i=s[e++];i.index+=t*i.stride}}end(){this.vertexBuffer.unlock()}writeData(t,e,s){const i=this.element[t];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const t=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let a=0;a<s;a++)i.setFromArray(n,e,a*t),n+=i.stride}else if(e.length>s*t){const n=s*t;if(ArrayBuffer.isView(e))e=e.subarray(0,n),i.array.set(e);else for(let t=0;t<n;t++)i.array[t]=e[t]}else i.array.set(e)}}readData(t,e){const s=this.element[t];let i=0;if(s){let t;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0),s.index=0;let a=0;for(t=0;t<i;t++)s.getToArray(a,e,t*n),a+=s.stride}else if(ArrayBuffer.isView(e))e.set(s.array);else{e.length=0;const a=i*n;for(t=0;t<a;t++)e[t]=s.array[t]}}return i}}const Tl={type:5,base:0,count:4,indexed:!1};class Ml{constructor(t){this.device=t,this.shader=null,this.vertexBuffer=Cl(t),this.needsDepthBuffer=!1,this.depthMap=null}render(t,e,s){}}function Cl(t){const e=new Hr(t,[{semantic:"POSITION",components:2,type:6}]),s=new Wr(t,e,4),i=new wl(s);return i.element.POSITION.set(-1,-1),i.next(),i.element.POSITION.set(1,-1),i.next(),i.element.POSITION.set(-1,1),i.next(),i.element.POSITION.set(1,1),i.end(),s}function Al(t,e,s,i,n){const a=t.getRenderTarget();t.setRenderTarget(e),t.updateBegin();let r=e?e.width:t.width,o=e?e.height:t.height,h=0,l=0;n&&(h=n.x*r,l=n.y*o,r*=n.z,o*=n.w);const c=t.vx,d=t.vy,u=t.vw,p=t.vh;t.setViewport(h,l,r,o);const m=t.sx,f=t.sy,_=t.sw,g=t.sh;t.setScissor(h,l,r,o);const y=t.getBlending(),v=t.getDepthTest(),x=t.getDepthWrite(),b=t.getCullMode(),S=t.writeRed,w=t.writeGreen,T=t.writeBlue,M=t.writeAlpha;t.setBlending(!1),t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(0),t.setColorWrite(!0,!0,!0,!0),t.setVertexBuffer(s,0),t.setShader(i),t.draw(Tl),t.setBlending(y),t.setDepthTest(v),t.setDepthWrite(x),t.setCullMode(b),t.setColorWrite(S,w,T,M),t.updateEnd(),t.setRenderTarget(a),t.updateBegin(),t.setViewport(c,d,u,p),t.setScissor(m,f,_,g)}class Pl{constructor(t,e=3){this.device=t.device;const s=this.device.gl;this._inputBuffer=t,3===e&&t.usage!==e&&(s.bindBuffer(s.ARRAY_BUFFER,t.impl.bufferId),s.bufferData(s.ARRAY_BUFFER,t.storage,s.DYNAMIC_COPY)),this._outputBuffer=new Wr(t.device,t.format,t.numVertices,e,t.storage)}static createShader(t,e,s){return co(t,e,null,s,!0)}destroy(){this._outputBuffer.destroy()}process(t,e=!0){const s=this.device,i=s.getRenderTarget();if(s.setRenderTarget(null),s.updateBegin(),s.setVertexBuffer(this._inputBuffer,0),s.setRaster(!1),s.setTransformFeedbackBuffer(this._outputBuffer),s.setShader(t),s.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1}),s.setTransformFeedbackBuffer(null),s.setRaster(!0),s.updateEnd(),s.setRenderTarget(i),e){let t=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=t,t=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=t}}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}}class El{constructor(){this.bufferId=null}destroy(t){this.bufferId&&(t.gl.deleteBuffer(this.bufferId),this.bufferId=null)}loseContext(){this.bufferId=null}unlock(t,e,s,i){const n=t.gl;let a;switch(this.bufferId||(this.bufferId=n.createBuffer()),e){case 0:a=n.STATIC_DRAW;break;case 1:a=n.DYNAMIC_DRAW;break;case 2:a=n.STREAM_DRAW;break;case 3:a=t.webgl2?n.DYNAMIC_COPY:n.STATIC_DRAW}n.bindBuffer(s,this.bufferId),n.bufferData(s,i,a)}}class Rl extends El{constructor(...t){super(...t),this.vao=null}destroy(t){super.destroy(t),t.boundVao=null,t.gl.bindVertexArray(null)}loseContext(){super.loseContext(),this.vao=null}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ARRAY_BUFFER,t.storage)}}class Ll extends El{constructor(t){super();const e=t.device.gl,s=t.format;0===s?this.glFormat=e.UNSIGNED_BYTE:1===s?this.glFormat=e.UNSIGNED_SHORT:2===s&&(this.glFormat=e.UNSIGNED_INT)}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ELEMENT_ARRAY_BUFFER,t.storage)}}const Il=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef)/g,Dl=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,Ol=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,Fl=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,kl=/(endif|else|elif)([ \t]+[^\r\n]+)?\r?(?:\n|$)/g,Bl=/([\w-]+)/,zl=/(!|\s)?defined\(([\w-]+)\)/,Ul=/[><=|&+-]/g;class Vl{static run(t){return t=(t=t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")).split(/\r?\n/).map((t=>t.trimEnd())).join("\n"),null!==(t=this._preprocess(t))&&(t=(t=t.split(/\r?\n/).map((t=>""===t.trim()?"":t)).join("\n")).replace(/(\n\n){3,}/gm,"\n\n")),t}static _preprocess(t){const e=t,s=[];let i=!1;const n=new Map;let a;for(;null!==(a=Il.exec(t));){const e=a[1];switch(e){case"define":{Dl.lastIndex=a.index;const e=Dl.exec(t);i||(i=null===e);const r=e[1];Bl.lastIndex=e.index;const o=Bl.exec(r)[1];let h=r.substring(o.length).trim();""===h&&(h="true");Vl._keep(s)&&n.set(o,h),Il.lastIndex=e.index+e[0].length;break}case"undef":{Ol.lastIndex=a.index;const e=Ol.exec(t),i=e[1].trim();Vl._keep(s)&&n.delete(i),Il.lastIndex=e.index+e[0].length;break}case"ifdef":case"ifndef":case"if":{Fl.lastIndex=a.index;const r=Fl.exec(t),o=r[2],h=Vl.evaluate(o,n);i||(i=h.error);let l=h.result;"ifndef"===e&&(l=!l),s.push({anyKeep:l,keep:l,start:a.index,end:Fl.lastIndex}),Il.lastIndex=r.index+r[0].length;break}case"endif":case"else":case"elif":{kl.lastIndex=a.index;const e=kl.exec(t),r=s.pop(),o=r.keep?t.substring(r.end,a.index):"";t=t.substring(0,r.start)+o+t.substring(kl.lastIndex),Il.lastIndex=r.start+o.length;const h=e[1];if("else"===h||"elif"===h){let t=!1;if(!r.anyKeep)if("else"===h)t=!r.keep;else{const s=Vl.evaluate(e[2],n);t=s.result,i||(i=s.error)}s.push({anyKeep:r.anyKeep||t,keep:t,start:Il.lastIndex,end:Il.lastIndex})}break}}}return i?(console.warn("Failed to preprocess shader: ",{source:e}),e):t}static _keep(t){for(let e=0;e<t.length;e++)if(!t[e].keep)return!1;return!0}static evaluate(t,e){const s=null===Ul.exec(t);let i=!1;const n=zl.exec(t);n&&(i="!"===n[1],t=n[2]),t=t.trim();let a=e.has(t);return i&&(a=!a),{result:a,error:!s}}}class Nl{constructor(t,e,s,i){if(this.locationId=i,this.scopeId=t.scope.resolve(e),this.version=new uo,"[0]"===e.substring(e.length-3))switch(s){case 2:s=17;break;case 3:s=21;break;case 4:s=22;break;case 5:s=23}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}class Wl{constructor(t){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null,this.compileAndLink(t.device,t),t.device.shaders.push(t)}destroy(t){const e=t.device,s=e.shaders.indexOf(t);-1!==s&&e.shaders.splice(s,1),this.glProgram&&(e.gl.deleteProgram(this.glProgram),this.glProgram=null,e.removeShaderFromCache(t))}restoreContext(t,e){this.compileAndLink(t,e)}compileAndLink(t,e){const s=e.definition;s.vshader=Vl.run(s.vshader),s.fshader=Vl.run(s.fshader);const i=this._compileShaderSource(t,s.vshader,!0),n=this._compileShaderSource(t,s.fshader,!1),a=t.gl,r=a.createProgram();a.attachShader(r,i),a.attachShader(r,n);const o=s.attributes;if(t.webgl2&&s.useTransformFeedback){const t=[];for(const e in o)o.hasOwnProperty(e)&&t.push("out_"+e);a.transformFeedbackVaryings(r,t,a.INTERLEAVED_ATTRIBS)}for(const t in o)if(o.hasOwnProperty(t)){const e=o[t],s=Vr[e];a.bindAttribLocation(r,s,t)}a.linkProgram(r),this.glVertexShader=i,this.glFragmentShader=n,this.glProgram=r}_compileShaderSource(t,e,s){const i=t.gl,n=s?t.vertexShaderCache:t.fragmentShaderCache;let a=n[e];return a||(a=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(a,e),i.compileShader(a),n[e]=a),a}postLink(t,e){const s=t.gl,i=this.glProgram,n=e.definition;if(!this._isCompiled(t,e,this.glVertexShader,n.vshader,"vertex"))return!1;if(!this._isCompiled(t,e,this.glFragmentShader,n.fshader,"fragment"))return!1;if(!s.getProgramParameter(i,s.LINK_STATUS)){const t="Failed to link shader program. Error: "+s.getProgramInfoLog(i);return console.error(t),!1}let a,r,o,h;a=0;const l=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);for(;a<l;)r=s.getActiveAttrib(i,a++),o=s.getAttribLocation(i,r.name),void 0===n.attributes[r.name]&&console.error(`Vertex shader attribute "${r.name}" is not mapped to a semantic in shader definition.`),h=new Nl(t,n.attributes[r.name],t.pcUniformType[r.type],o),this.attributes.push(h);a=0;const c=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(;a<c;)r=s.getActiveUniform(i,a++),o=s.getUniformLocation(i,r.name),h=new Nl(t,r.name,t.pcUniformType[r.type],o),r.type===s.SAMPLER_2D||r.type===s.SAMPLER_CUBE||t.webgl2&&(r.type===s.SAMPLER_2D_SHADOW||r.type===s.SAMPLER_CUBE_SHADOW||r.type===s.SAMPLER_3D)?this.samplers.push(h):this.uniforms.push(h);return e.ready=!0,!0}_isCompiled(t,e,s,i,n){const a=t.gl;if(!a.getShaderParameter(s,a.COMPILE_STATUS)){const t=a.getShaderInfoLog(s),[e,r]=this._processError(i,t),o=`Failed to compile ${n} shader:\n\n${t}\n${e}`;return console.error(o),!1}return!0}_processError(t,e){const s={};let i="";if(t){const n=t.split("\n");let a=0,r=n.length;if(e&&e.startsWith("ERROR:")){const t=e.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);t&&(s.message=t[3],s.line=parseInt(t[2],10),a=Math.max(0,s.line-6),r=Math.min(n.length,s.line+5))}for(let t=a;t<r;t++)i+=t+1+":\t"+n[t]+"\n";s.source=t}return[i,s]}}function Gl(t,e){const s=t.width,i=t.height;if(s>e||i>e){const n=e/Math.max(s,i),a=Math.floor(s*n),r=Math.floor(i*n),o=document.createElement("canvas");o.width=a,o.height=r;return o.getContext("2d").drawImage(t,0,0,s,i,0,0,a,r),o}return t}class Hl{constructor(){this._glTexture=null,this._glTarget=void 0,this._glFormat=void 0,this._glInternalFormat=void 0,this._glPixelType=void 0}destroy(t){if(this._glTexture){for(let e=0;e<t.textureUnits.length;e++){const s=t.textureUnits[e];for(let t=0;t<s.length;t++)s[t]===this._glTexture&&(s[t]=null)}t.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}initialize(t,e){const s=t.gl;switch(this._glTexture=s.createTexture(),this._glTarget=e._cubemap?s.TEXTURE_CUBE_MAP:e._volume?s.TEXTURE_3D:s.TEXTURE_2D,e._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=t.webgl2?s.RGB8:s.RGB,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=t.webgl2?s.RGBA8:s.RGBA,this._glPixelType=s.UNSIGNED_BYTE;break;case 8:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:this._glFormat=s.RGB,t.webgl2?(this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGB,this._glPixelType=t.extTextureHalfFloat.HALF_FLOAT_OES);break;case 12:this._glFormat=s.RGBA,t.webgl2?(this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGBA,this._glPixelType=t.extTextureHalfFloat.HALF_FLOAT_OES);break;case 13:this._glFormat=s.RGB,t.webgl2?this._glInternalFormat=s.RGB32F:this._glInternalFormat=s.RGB,this._glPixelType=s.FLOAT;break;case 14:this._glFormat=s.RGBA,t.webgl2?this._glInternalFormat=s.RGBA32F:this._glInternalFormat=s.RGBA,this._glPixelType=s.FLOAT;break;case 15:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case 16:t.webgl2?(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT):(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT,this._glPixelType=s.UNSIGNED_SHORT);break;case 17:this._glFormat=s.DEPTH_STENCIL,t.webgl2?(this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8):(this._glInternalFormat=s.DEPTH_STENCIL,this._glPixelType=t.extDepthTexture.UNSIGNED_INT_24_8_WEBGL);break;case 18:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 20:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE}}upload(t,e){const s=t.gl;if(!e._needsUpload&&(e._needsMipmapsUpload&&e._mipmapsUploaded||!e.pot))return;let i,n,a=0;const r=Math.log2(Math.max(e._width,e._height))+1;for(;e._levels[a]||0===a;)if(e._needsUpload||0!==a){if(a&&(!e._needsMipmapsUpload||!e._mipmaps))break;if(i=e._levels[a],1===a&&!e._compressed&&e._levels.length<r&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._cubemap){let r;if(t._isBrowserInterface(i[0]))for(r=0;r<6;r++){if(!e._levelsUpdated[0][r])continue;let n=i[r];n instanceof HTMLImageElement&&(n.width>t.maxCubeMapSize||n.height>t.maxCubeMapSize)&&(n=Gl(n,t.maxCubeMapSize),0===a&&(e._width=n.width,e._height=n.height)),t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,this._glInternalFormat,this._glFormat,this._glPixelType,n)}else for(n=1/Math.pow(2,a),r=0;r<6;r++){if(!e._levelsUpdated[0][r])continue;const o=i[r];e._compressed?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,o):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,this._glFormat,this._glPixelType,o))}}else e._volume?(n=1/Math.pow(2,a),e._compressed?s.compressedTexImage3D(s.TEXTURE_3D,a,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,i):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,a,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,this._glFormat,this._glPixelType,i))):(t._isBrowserInterface(i)?(i instanceof HTMLImageElement&&(i.width>t.maxTextureSize||i.height>t.maxTextureSize)&&(i=Gl(i,t.maxTextureSize),0===a&&(e._width=i.width,e._height=i.height)),t.setUnpackFlipY(e._flipY),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,a,this._glInternalFormat,this._glFormat,this._glPixelType,i)):(n=1/Math.pow(2,a),e._compressed?s.compressedTexImage2D(s.TEXTURE_2D,a,this._glInternalFormat,Math.max(Math.floor(e._width*n),1),Math.max(Math.floor(e._height*n),1),0,i):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,a,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,this._glFormat,this._glPixelType,i))),e._mipmapsUploaded=0!==a);a++}else a++;if(e._needsUpload)if(e._cubemap)for(let t=0;t<6;t++)e._levelsUpdated[0][t]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&e._mipmaps&&e._needsMipmapsUpload&&(e.pot||t.webgl2)&&1===e._levels.length&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&e.adjustVramSizeTracking(t._vram,-e._gpuSize),e._gpuSize=e.gpuSize,e.adjustVramSizeTracking(t._vram,e._gpuSize)}}class Xl{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}destroy(t){const e=t.gl;this._glFrameBuffer&&(e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(e.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(e.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}init(t,e){const s=t.gl;this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const i=e._colorBuffer;i&&(i.impl._glTexture||(i._width=Math.min(i.width,t.maxRenderBufferSize),i._height=Math.min(i.height,t.maxRenderBufferSize),t.setTexture(i,0)),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,i._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,i.impl._glTexture,0));const n=e._depthBuffer;if(n)n.impl._glTexture||(n._width=Math.min(n.width,t.maxRenderBufferSize),n._height=Math.min(n.height,t.maxRenderBufferSize),t.setTexture(n,0)),e._stencil?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,e._depthBuffer.impl._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,e._depthBuffer.impl._glTexture,0);else if(e._depth){if(!(e._samples>1&&t.webgl2)){if(this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),e._stencil)s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer);else{const i=t.webgl2?s.DEPTH_COMPONENT32F:s.DEPTH_COMPONENT16;s.renderbufferStorage(s.RENDERBUFFER,i,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer)}s.bindRenderbuffer(s.RENDERBUFFER,null)}}t.webgl2&&e._samples>1&&(this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer),i&&(this._glMsaaColorBuffer||(this._glMsaaColorBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaColorBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,i.impl._glInternalFormat,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,this._glMsaaColorBuffer)),e._depth&&(this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),e._stencil?(s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,s.DEPTH24_STENCIL8,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer)):(s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,s.DEPTH_COMPONENT32F,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer))))}_checkFbo(t){const e=t.gl;switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case e.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");case e.FRAMEBUFFER_COMPLETE:}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}resolve(t,e,s,i){if(t.webgl2){const n=t.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,this._glFrameBuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}}}function ql(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);const n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(s=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(n),s}class jl extends il{constructor(t,e={}){super(t),this.gl=void 0,this.webgl2=void 0,this.defaultFramebuffer=null,this.defaultFramebufferAlpha=e.alpha,this.updateClientRect(),this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")},e.stencil=!0,e.powerPreference||(e.powerPreference="high-performance");const s="undefined"!=typeof navigator&&navigator.userAgent;this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(e.antialias=!1);const i=void 0===e.preferWebGl2||e.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];let n=null;for(let s=0;s<i.length;s++)if(n=t.getContext(i[s],e),n){this.webgl2="webgl2"===i[s];break}if(!n)throw new Error("WebGL not supported");const r=L.browser&&!!window.chrome,o=L.browser&&-1!==navigator.appVersion.indexOf("Mac");let h,l,c,d,u;this.gl=n,this._tempEnableSafariTextureUnitWorkaround=L.browser&&!!window.safari,this._tempMacChromeBlitFramebufferWorkaround=o&&r&&!e.alpha,this.webgl2||function(t){if(t.getSupportedExtensions){if(-1!=t.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(t.getExtension&&t.getExtension("OES_vertex_array_object"))return;if(t.getSupportedExtensions){var e=t.getSupportedExtensions;t.getSupportedExtensions=function(){var t=e.call(this)||[];return t.push("OES_vertex_array_object"),t}}var s=t.getExtension;t.getExtension=function(e){return"OES_vertex_array_object"==e?(t.__OESVertexArrayObject||(t.__OESVertexArrayObject=new a(t)),t.__OESVertexArrayObject):s?s.call(this,e):null}}(n),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,this.webgl2?n.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:n.FUNC_ADD,this.webgl2?n.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:n.FUNC_ADD],this.glBlendFunction=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_COLOR,n.ONE_MINUS_CONSTANT_COLOR,n.CONSTANT_ALPHA,n.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=0,this.pcUniformType[n.INT]=1,this.pcUniformType[n.FLOAT]=2,this.pcUniformType[n.FLOAT_VEC2]=3,this.pcUniformType[n.FLOAT_VEC3]=4,this.pcUniformType[n.FLOAT_VEC4]=5,this.pcUniformType[n.INT_VEC2]=6,this.pcUniformType[n.INT_VEC3]=7,this.pcUniformType[n.INT_VEC4]=8,this.pcUniformType[n.BOOL_VEC2]=9,this.pcUniformType[n.BOOL_VEC3]=10,this.pcUniformType[n.BOOL_VEC4]=11,this.pcUniformType[n.FLOAT_MAT2]=12,this.pcUniformType[n.FLOAT_MAT3]=13,this.pcUniformType[n.FLOAT_MAT4]=14,this.pcUniformType[n.SAMPLER_2D]=15,this.pcUniformType[n.SAMPLER_CUBE]=16,this.webgl2&&(this.pcUniformType[n.SAMPLER_2D_SHADOW]=18,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[n.SAMPLER_3D]=20),this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(t,e){t.value!==e&&(n.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(t,e){t.value!==e&&(n.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[3]=function(t,e){u=t.value,h=e[0],l=e[1],u[0]===h&&u[1]===l||(n.uniform2fv(t.locationId,e),u[0]=h,u[1]=l)},this.commitFunction[4]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],u[0]===h&&u[1]===l&&u[2]===c||(n.uniform3fv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c)},this.commitFunction[5]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],d=e[3],u[0]===h&&u[1]===l&&u[2]===c&&u[3]===d||(n.uniform4fv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c,u[3]=d)},this.commitFunction[6]=function(t,e){u=t.value,h=e[0],l=e[1],u[0]===h&&u[1]===l||(n.uniform2iv(t.locationId,e),u[0]=h,u[1]=l)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],u[0]===h&&u[1]===l&&u[2]===c||(n.uniform3iv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],d=e[3],u[0]===h&&u[1]===l&&u[2]===c&&u[3]===d||(n.uniform4iv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c,u[3]=d)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(t,e){n.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[13]=function(t,e){n.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[14]=function(t,e){n.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[17]=function(t,e){n.uniform1fv(t.locationId,e)},this.commitFunction[21]=function(t,e){n.uniform2fv(t.locationId,e)},this.commitFunction[22]=function(t,e){n.uniform3fv(t.locationId,e)},this.commitFunction[23]=function(t,e){n.uniform4fv(t.locationId,e)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let p=this.vertexUniformsCount;p-=16,p-=8,p-=1,p-=16,this.boneLimit=Math.floor(p/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=ql(n,n.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=ql(n,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&this.maxVertexTextures>=2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.areaLightLutFormat=7,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=12:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=14)}destroy(){super.destroy();const t=this.gl;this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createVertexBufferImpl(t,e){return new Rl}createIndexBufferImpl(t){return new Ll(t)}createShaderImpl(t){return new Wl(t)}createTextureImpl(){return new Hl}createRenderTargetImpl(t){return new Xl}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),r=s.precision>0&&n.precision>0,o=i.precision>0&&a.precision>0;r||(e=o?"mediump":"lowp")}return e}initializeExtensions(){const t=this.gl,e=t.getSupportedExtensions(),s=function(){for(let s=0;s<arguments.length;s++)if(-1!==e.indexOf(arguments[s]))return t.getExtension(arguments[s]);return null};if(this.webgl2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=s("EXT_color_buffer_float"),this.extDisjointTimerQuery=s("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query"),this.extDepthTexture=!0;else{if(this.extBlendMinmax=s("EXT_blend_minmax"),this.extDrawBuffers=s("EXT_draw_buffers"),this.extInstancing=s("ANGLE_instanced_arrays"),this.extInstancing){const e=this.extInstancing;t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)}if(this.extStandardDerivatives=s("OES_standard_derivatives"),this.extTextureFloat=s("OES_texture_float"),this.extTextureHalfFloat=s("OES_texture_half_float"),this.extTextureLod=s("EXT_shader_texture_lod"),this.extUintElement=s("OES_element_index_uint"),this.extVertexArrayObject=s("OES_vertex_array_object"),this.extVertexArrayObject){const e=this.extVertexArrayObject;t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)}this.extColorBufferFloat=null,this.extDisjointTimerQuery=null,this.extDepthTexture=t.getExtension("WEBGL_depth_texture")}this.extDebugRendererInfo=s("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=s("OES_texture_float_linear"),this.extTextureHalfFloatLinear=s("OES_texture_half_float_linear"),this.extFloatBlend=s("EXT_float_blend"),this.extTextureFilterAnisotropic=s("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=s("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=s("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=s("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=s("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=s("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=s("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=s("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=s("EXT_color_buffer_half_float")}initializeCapabilities(){const t=this.gl;let e;const s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const i=t.getContextAttributes();this.supportsMsaa=i.antialias,this.supportsStencil=i.stencil,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(e=this.extDrawBuffers,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+\)/)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2&&!this.forceDisableMultisampling?t.getParameter(t.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!L.android,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){const t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=1,this.blendDst=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.separateAlphaBlend=!1,this.blendEquation=0,this.blendAlphaEquation=0,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.blendColor=new et(0,0,0,0),t.blendColor(0,0,0,0),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=1,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=3,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new et(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initializeContextCaches(){super.initializeContextCaches(),this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])}loseContext(){for(const t of this.shaders)t.loseContext();for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)t.restoreContext();for(const t of this.buffers)t.unlock()}setViewport(t,e,s,i){this.vx===t&&this.vy===e&&this.vw===s&&this.vh===i||(this.gl.viewport(t,e,s,i),this.vx=t,this.vy=e,this.vw=s,this.vh=i)}setScissor(t,e,s,i){this.sx===t&&this.sy===e&&this.sw===s&&this.sh===i||(this.gl.scissor(t,e,s,i),this.sx=t,this.sy=e,this.sw=s,this.sh=i)}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}copyRenderTarget(t,e,s,i){const n=this.gl;if(!this.webgl2&&i)return!1;if(s)if(e){if(t){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}}else if(!t._colorBuffer)return!1;if(i&&t&&!t._depth){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}if(this.webgl2&&e){const a=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t.impl._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e.impl._glFrameBuffer);const r=t?t.width:e.width,o=t?t.height:e.height;n.blitFramebuffer(0,0,r,o,0,0,r,o,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=a,n.bindFramebuffer(n.FRAMEBUFFER,a?a.impl._glFrameBuffer:null)}else{const s=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer),Yr(this,e,s)}return!0}initRenderTarget(t){t.impl._glFrameBuffer||(t.init(),this.targets.push(t))}getCopyShader(){if(!this._copyShader){const t=Zr.fullscreenQuadVS,e=Zr.outputTex2DPS;this._copyShader=co(this,t,e,"outputTex2D")}return this._copyShader}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let t=0;t<this.textureUnits.length;++t)for(let e=0;e<3;++e)this.textureUnits[t][e]=null;const t=this.renderTarget;t?t.impl._glFrameBuffer?this.setFramebuffer(t.impl._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){const t=this.gl;this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null));const e=this.renderTarget;if(e){const s=e._colorBuffer;s&&s.impl._glTexture&&s.mipmaps&&(s.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(s),t.generateMipmap(s.impl._glTarget)),this.webgl2&&e._samples>1&&e.autoResolve&&e.resolve()}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t.impl,s=e._glTarget,i=e._glTexture,n=this.textureUnit,a=this.targetToSlot[s];this.textureUnits[n][a]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][a]=i)}bindTextureOnUnit(t,e){const s=t.impl,i=s._glTarget,n=s._glTexture,a=this.targetToSlot[i];this.textureUnits[e][a]!==n&&(this.activeTexture(e),this.gl.bindTexture(i,n),this.textureUnits[e][a]=n)}setTextureParameters(t){const e=this.gl,s=t._parameterFlags,i=t.impl._glTarget;if(1&s){let s=t._minFilter;(!t.pot&&!this.webgl2||!t._mipmaps||t._compressed&&1===t._levels.length)&&(2===s||3===s?s=0:4!==s&&5!==s||(s=1)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&e.texParameteri(i,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:1])),8&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:1])),16&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&e.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}}setTexture(t,e){t.impl._glTexture||t.impl.initialize(this,t),t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(t.impl.upload(this,t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,s;const i=t.length>1;if(i){e="";for(let s=0;s<t.length;s++){const i=t[s];e+=i.id+i.format.renderingingHash}s=this._vaoMap.get(e)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const s=t[e];n.bindBuffer(n.ARRAY_BUFFER,s.impl.bufferId);const i=s.format.elements;for(let t=0;t<i.length;t++){const e=i[t],a=Vr[e.name];n.vertexAttribPointer(a,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),n.enableVertexAttribArray(a),s.instancing&&n.vertexAttribDivisor(a,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(e,s)}return s}setBuffers(){const t=this.gl;let e;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t.impl.vao||(t.impl.vao=this.createVertexArray(this.vertexBuffers)),e=t.impl.vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s)}draw(t,e,s){const i=this.gl;let n,a,r,o,h,l,c,d;const u=this.shader;if(!u)return;const p=u.impl.samplers,m=u.impl.uniforms;s||this.setBuffers();let f=0;for(let t=0,e=p.length;t<e;t++)if(n=p[t],a=n.scopeId.value,a)if(a instanceof Mo)r=a,this.setTexture(r,f),n.slot!==f&&(i.uniform1i(n.locationId,f),n.slot=f),f++;else{n.array.length=0,o=a.length;for(let t=0;t<o;t++)r=a[t],this.setTexture(r,f),n.array[t]=f,f++;i.uniform1iv(n.locationId,n.array)}for(let t=0,e=m.length;t<e;t++)h=m[t],l=h.scopeId,c=h.version,d=l.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==l.value&&this.commitFunction[h.dataType](h,l.value));this.webgl2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const _=this.glPrimitive[t.type],g=t.count;if(t.indexed){const s=this.indexBuffer,n=s.impl.glFormat,a=t.base*s.bytesPerIndex;e>0?i.drawElementsInstanced(_,g,n,a,e):i.drawElements(_,g,n,a)}else{const s=t.base;e>0?i.drawArraysInstanced(_,s,g,e):i.drawArrays(_,s,g)}this.webgl2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(t){const e=this.defaultClearOptions,s=null==(t=t||e).flags?e.flags:t.flags;if(0!==s){const i=this.gl;if(1&s){const s=null==t.color?e.color:t.color;this.setClearColor(s[0],s[1],s[2],s[3])}if(2&s){const s=null==t.depth?e.depth:t.depth;this.setClearDepth(s),this.depthWrite||i.depthMask(!0)}if(4&s){const s=null==t.stencil?e.stencil:t.stencil;this.setClearStencil(s)}i.clear(this.glClearFlag[s]),2&s&&(this.depthWrite||i.depthMask(!1))}}readPixels(t,e,s,i,n){const a=this.gl;a.readPixels(t,e,s,i,a.RGBA,a.UNSIGNED_BYTE,n)}setClearDepth(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)}setClearColor(t,e,s,i){const n=this.clearColor;t===n.r&&e===n.g&&s===n.b&&i===n.a||(this.gl.clearColor(t,e,s,i),this.clearColor.set(t,e,s,i))}setClearStencil(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)}getDepthTest(){return this.depthTest}setDepthTest(t){if(this.depthTest!==t){const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}}setDepthFunc(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)}getDepthWrite(){return this.depthWrite}setDepthWrite(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)}setColorWrite(t,e,s,i){this.writeRed===t&&this.writeGreen===e&&this.writeBlue===s&&this.writeAlpha===i||(this.gl.colorMask(t,e,s,i),this.writeRed=t,this.writeGreen=e,this.writeBlue=s,this.writeAlpha=i)}setAlphaToCoverage(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(t,e){this.gl.polygonOffset(e,t)}getBlending(){return this.blending}setBlending(t){if(this.blending!==t){const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s||this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){this.gl.stencilFunc(this.glComparison[t],e,s),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=s}}setStencilFuncFront(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[t],e,s),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=s}}setStencilFuncBack(t,e,s){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[t],e,s),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=s}}setStencilOperation(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(t,e,s,i){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendFunction(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)}setBlendFunctionSeparate(t,e,s,i){this.blendSrc===t&&this.blendDst===e&&this.blendSrcAlpha===s&&this.blendDstAlpha===i&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[s],this.glBlendFunction[i]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=s,this.blendDstAlpha=i,this.separateAlphaBlend=!0)}setBlendEquation(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)}setBlendEquationSeparate(t,e){this.blendEquation===t&&this.blendAlphaEquation===e&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)}setBlendColor(t,e,s,i){const n=this.blendColor;t===n.r&&e===n.g&&s===n.b&&i===n.a||(this.gl.blendColor(t,e,s,i),n.set(t,e,s,i))}setCullMode(t){if(this.cullMode!==t){if(0===t)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}getCullMode(){return this.cullMode}setIndexBuffer(t){this.indexBuffer=t}setVertexBuffer(t){t&&this.vertexBuffers.push(t)}setShader(t){if(t!==this.shader){if(t.failed)return!1;if(!t.ready&&!t.impl.postLink(this,t))return t.failed=!0,!1;this.shader=t,this.gl.useProgram(t.impl.glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(){return this.textureHalfFloatRenderable?12:this.textureFloatRenderable?14:7}getBoneLimit(){return this.boneLimit}setBoneLimit(t){this.boneLimit=t}clearShaderCache(){const t=this.gl;for(const e in this.fragmentShaderCache)t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e];for(const e in this.vertexShaderCache)t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e];this.programLib.clearCache()}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach(((e,s,i)=>{t.deleteVertexArray(e)})),this._vaoMap.clear()}removeShaderFromCache(t){this.programLib.removeFromCache(t)}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;const e=co(t,Zr.fullscreenQuadVS,Zr.precisionTestPS,"ptest1"),s=co(t,Zr.fullscreenQuadVS,Zr.precisionTest2PS,"ptest2"),i={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0,name:"testFHP"},n=new Mo(t,i),a=new al({colorBuffer:n,depth:!1});Yr(t,a,e),i.format=7;const r=new Mo(t,i),o=new al({colorBuffer:r,depth:!1});t.constantTexSource.setValue(n),Yr(t,o,s);const h=t.activeFramebuffer;t.setFramebuffer(o.impl._glFrameBuffer);const l=new Uint8Array(4);t.readPixels(0,0,1,1,l),t.setFramebuffer(h);const c=l[0]/255/16777216+l[1]/255/65536+l[2]/255/256+l[3]/255;return n.destroy(),a.destroy(),r.destroy(),o.destroy(),0===c}(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const n=new Uint16Array(16);return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,n),t.getError()!==t.NO_ERROR&&(s=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),s}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}class Yl{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}let Kl;function $l(){return Kl}function Zl(t){Kl=t}let Ql=0;class Jl{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(t,e){this.vertexCount||(this.vertexCount=t)}}Jl.DEFAULT_COMPONENTS_POSITION=3,Jl.DEFAULT_COMPONENTS_NORMAL=3,Jl.DEFAULT_COMPONENTS_UV=2,Jl.DEFAULT_COMPONENTS_COLORS=4;class tc{constructor(t,e,s,i){this.data=t,this.componentCount=e,this.dataType=s,this.dataTypeNormalize=i}}class ec extends Yl{constructor(t){super(),this.id=Ql++,this.device=t||$l().graphicsDevice,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this._aabb=new bt,this.boneAabb=null}set morph(t){t!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=t,t&&t.incRefCount())}get morph(){return this._morph}set aabb(t){this._aabb=t}get aabb(){return this._aabb}destroy(){const t=this.morph;t&&(this.morph=null,t.refCount<1&&t.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(t){this.indexBuffer[t]&&(this.indexBuffer[t].destroy(),this.indexBuffer[t]=null)}_initBoneAabbs(t){let e,s,i,n,a;this.boneAabb=[],this.boneUsed=[];const r=[],o=[],h=this.boneUsed,l=this.skin.boneNames.length;let c,d,u;for(let t=0;t<l;t++)r[t]=new at(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[t]=new at(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new wl(this.vertexBuffer),m=p.element.POSITION,f=p.element.BLENDWEIGHT,_=p.element.BLENDINDICES,g=this.vertexBuffer.numVertices;for(let l=0;l<g;l++){for(let p=0;p<4;p++){if(f.array[f.index+p]>0){const f=_.array[_.index+p];if(h[f]=!0,e=m.array[m.index],s=m.array[m.index+1],i=m.array[m.index+2],n=o[f],a=r[f],a.x>e&&(a.x=e),a.y>s&&(a.y=s),a.z>i&&(a.z=i),n.x<e&&(n.x=e),n.y<s&&(n.y=s),n.z<i&&(n.z=i),t){let r=c=e,o=d=s,h=u=i;for(let e=0;e<t.length;e++){const s=t[e],i=s.deltaPositions[3*l],n=s.deltaPositions[3*l+1],a=s.deltaPositions[3*l+2];i<0?r+=i:c+=i,n<0?o+=n:d+=n,a<0?h+=a:u+=a}a.x>r&&(a.x=r),a.y>o&&(a.y=o),a.z>h&&(a.z=h),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}p.next()}const y=this.vertexBuffer.getFormat().elements.find((t=>"POSITION"===t.name));if(y&&y.normalize){const t=(()=>{switch(y.dataType){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})();for(let e=0;e<l;e++)if(h[e]){const s=r[e],i=o[e];s.set(t(s.x),t(s.y),t(s.z)),i.set(t(i.x),t(i.y),t(i.z))}}for(let t=0;t<l;t++){const e=new bt;e.setMinMax(r[t],o[t]),this.boneAabb.push(e)}}_initGeometryData(){this._geometryData||(this._geometryData=new Jl,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(t,e,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=t?0:1,this._geometryData.indicesUsage=e?0:1}setVertexStream(t,e,s,i,n=6,a=!1){this._initGeometryData();const r=i||e.length/s;this._geometryData._changeVertexCount(r,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new tc(e,s,n,a)}getVertexStream(t,e){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[t];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(n.data):(e.length=0,e.push(n.data)))}if(!i&&this.vertexBuffer){s=new wl(this.vertexBuffer).readData(t,e)}return s}setPositions(t,e=Jl.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream("POSITION",t,e,s,6,!1)}setNormals(t,e=Jl.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream("NORMAL",t,e,s,6,!1)}setUvs(t,e,s=Jl.DEFAULT_COMPONENTS_UV,i){this.setVertexStream("TEXCOORD"+t,e,s,i,6,!1)}setColors(t,e=Jl.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream("COLOR",t,e,s,6,!1)}setColors32(t,e){this.setVertexStream("COLOR",t,Jl.DEFAULT_COMPONENTS_COLORS,e,1,!0)}setIndices(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length}getPositions(t){return this.getVertexStream("POSITION",t)}getNormals(t){return this.getVertexStream("NORMAL",t)}getUvs(t,e){return this.getVertexStream("TEXCOORD"+t,e)}getColors(t){return this.getVertexStream("COLOR",t)}getIndices(t){let e=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;e=this._geometryData.indexCount,ArrayBuffer.isView(t)?t.set(s):(t.length=0,t.push(s))}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){e=this.indexBuffer[0].readData(t)}return e}update(t=4,e=!0){if(this._geometryData){if(e){const t=this._geometryData.vertexStreamDictionary.POSITION;t&&3===t.componentCount&&this._aabb.compute(t.data,this._geometryData.vertexCount)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=t,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(t){const e=[];for(const t in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[t];e.push({semantic:t,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize})}return new Hr(this.device,e,t)}_updateVertexBuffer(){if(!this.vertexBuffer){const t=this._geometryData.maxVertices,e=this._buildVertexFormat(t);this.vertexBuffer=new Wr(this.device,e,t,this._geometryData.verticesUsage)}const t=new wl(this.vertexBuffer),e=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.writeData(s,i.data,e),delete this._geometryData.vertexStreamDictionary[s]}t.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices>65535?2:1;this.indexBuffer[0]=new ll(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const t=this._geometryData.indices;if(t){this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(t){1===t?this.generateWireframe():2===t&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const t=[];let e;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const s=[[0,1],[1,2],[2,0]],i=this.primitive[0].base,n=this.primitive[0].count,a=this.indexBuffer[0],r=new zr[a.format](a.storage),o={};for(let e=i;e<i+n;e+=3)for(let i=0;i<3;i++){const n=r[e+s[i][0]],a=r[e+s[i][1]],h=n>a?a<<16|n:n<<16|a;void 0===o[h]&&(o[h]=0,t.push(n,a))}e=a.format}else{for(let e=0;e<this.vertexBuffer.numVertices;e+=3)t.push(e,e+1,e+1,e+2,e+2,e);e=t.length>65535?2:1}const s=new ll(this.vertexBuffer.device,e,t.length);new zr[s.format](s.storage).set(t),s.unlock(),this.primitive[1]={type:1,base:0,count:t.length,indexed:!0},this.indexBuffer[1]=s}}const sc=[];function ic(t,e){const s=e.length/3,i=t.length/3,n=new at,a=new at,r=new at,o=new at,h=new at,l=new at,c=[];for(let e=0;e<t.length;e++)c[e]=0;for(let i=0;i<s;i++){const s=e[3*i],d=e[3*i+1],u=e[3*i+2];n.set(t[3*s],t[3*s+1],t[3*s+2]),a.set(t[3*d],t[3*d+1],t[3*d+2]),r.set(t[3*u],t[3*u+1],t[3*u+2]),o.sub2(a,n),h.sub2(r,n),l.cross(o,h).normalize(),c[3*s]+=l.x,c[3*s+1]+=l.y,c[3*s+2]+=l.z,c[3*d]+=l.x,c[3*d+1]+=l.y,c[3*d+2]+=l.z,c[3*u]+=l.x,c[3*u+1]+=l.y,c[3*u+2]+=l.z}for(let t=0;t<i;t++){const e=c[3*t],s=c[3*t+1],i=c[3*t+2],n=1/Math.sqrt(e*e+s*s+i*i);c[3*t]*=n,c[3*t+1]*=n,c[3*t+2]*=n}return c}function nc(t,e,s,i){const n=i.length/3,a=t.length/3,r=new at,o=new at,h=new at,l=new ot,c=new ot,d=new ot,u=new at,p=new at,m=new Float32Array(3*a),f=new Float32Array(3*a),_=[];for(let e=0;e<n;e++){const n=i[3*e],a=i[3*e+1],_=i[3*e+2];r.set(t[3*n],t[3*n+1],t[3*n+2]),o.set(t[3*a],t[3*a+1],t[3*a+2]),h.set(t[3*_],t[3*_+1],t[3*_+2]),l.set(s[2*n],s[2*n+1]),c.set(s[2*a],s[2*a+1]),d.set(s[2*_],s[2*_+1]);const g=o.x-r.x,y=h.x-r.x,v=o.y-r.y,x=h.y-r.y,b=o.z-r.z,S=h.z-r.z,w=c.x-l.x,T=d.x-l.x,M=c.y-l.y,C=d.y-l.y,A=w*C-T*M;if(0===A)u.set(0,1,0),p.set(1,0,0);else{const t=1/A;u.set((C*g-M*y)*t,(C*v-M*x)*t,(C*b-M*S)*t),p.set((w*y-T*g)*t,(w*x-T*v)*t,(w*S-T*b)*t)}m[3*n+0]+=u.x,m[3*n+1]+=u.y,m[3*n+2]+=u.z,m[3*a+0]+=u.x,m[3*a+1]+=u.y,m[3*a+2]+=u.z,m[3*_+0]+=u.x,m[3*_+1]+=u.y,m[3*_+2]+=u.z,f[3*n+0]+=p.x,f[3*n+1]+=p.y,f[3*n+2]+=p.z,f[3*a+0]+=p.x,f[3*a+1]+=p.y,f[3*a+2]+=p.z,f[3*_+0]+=p.x,f[3*_+1]+=p.y,f[3*_+2]+=p.z}const g=new at,y=new at,v=new at,x=new at;for(let t=0;t<a;t++){v.set(e[3*t],e[3*t+1],e[3*t+2]),g.set(m[3*t],m[3*t+1],m[3*t+2]),y.set(f[3*t],f[3*t+1],f[3*t+2]);const s=v.dot(g);x.copy(v).mulScalar(s),x.sub2(g,x).normalize(),_[4*t]=x.x,_[4*t+1]=x.y,_[4*t+2]=x.z,x.cross(v,g),_[4*t+3]=x.dot(y)<0?-1:1}return _}function ac(t,e,s){const i=new ec(t);return i.setPositions(e),s&&(s.normals&&i.setNormals(s.normals),s.tangents&&i.setVertexStream("TANGENT",s.tangents,4),s.colors&&i.setColors32(s.colors),s.uvs&&i.setUvs(0,s.uvs),s.uvs1&&i.setUvs(1,s.uvs1),s.blendIndices&&i.setVertexStream("BLENDINDICES",s.blendIndices,4,s.blendIndices.length/4,1),s.blendWeights&&i.setVertexStream("BLENDWEIGHT",s.blendWeights,4),s.indices&&i.setIndices(s.indices)),i.update(),i}function rc(t,e){const s=e&&void 0!==e.tubeRadius?e.tubeRadius:.2,i=e&&void 0!==e.ringRadius?e.ringRadius:.3,n=e&&void 0!==e.segments?e.segments:30,a=e&&void 0!==e.sides?e.sides:20,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=[],h=[],l=[],c=[];for(let t=0;t<=a;t++)for(let e=0;e<=n;e++){const r=Math.cos(2*Math.PI*e/n)*(i+s*Math.cos(2*Math.PI*t/a)),d=Math.sin(2*Math.PI*t/a)*s,u=Math.sin(2*Math.PI*e/n)*(i+s*Math.cos(2*Math.PI*t/a)),p=Math.cos(2*Math.PI*e/n)*Math.cos(2*Math.PI*t/a),m=Math.sin(2*Math.PI*t/a),f=Math.sin(2*Math.PI*e/n)*Math.cos(2*Math.PI*t/a),_=t/a,g=1-e/n;if(o.push(r,d,u),h.push(p,m,f),l.push(_,1-g),t<a&&e<n){const s=t*(n+1)+e,i=(t+1)*(n+1)+e,a=t*(n+1)+(e+1),r=(t+1)*(n+1)+(e+1);c.push(s,i,a),c.push(i,r,a)}}const d={normals:h,uvs:l,uvs1:l,indices:c};return r&&(d.tangents=nc(o,h,l,c)),ac(t,o,d)}function oc(t,e,s,i,n,a){const r=new at,o=new at,h=new at,l=new at,c=new at,d=new at,u=[],p=[],m=[],f=[],_=[];let g;if(s>0)for(let a=0;a<=i;a++)for(let g=0;g<=n;g++){const y=g/n*2*Math.PI-Math.PI,v=Math.sin(y),x=Math.cos(y);c.set(v*t,-s/2,x*t),l.set(v*e,s/2,x*e),r.lerp(c,l,a/i),o.sub2(l,c).normalize(),d.set(x,0,-v),h.cross(d,o).normalize(),u.push(r.x,r.y,r.z),p.push(h.x,h.y,h.z);let b=g/n,S=a/i;m.push(b,1-S);const w=S;if(S=b,b=w,b=.875*b+.0625,S=.875*S+.0625,b/=3,f.push(b,1-S),a<i&&g<n){const t=a*(n+1)+g,e=a*(n+1)+(g+1),s=(a+1)*(n+1)+g,i=(a+1)*(n+1)+(g+1);_.push(t,e,s),_.push(e,i,s)}}if(a){const t=Math.floor(n/2),a=n,r=s/2;for(let s=0;s<=t;s++){const i=s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=a;i++){const h=2*i*Math.PI/a-Math.PI/2,l=Math.sin(h),c=Math.cos(h)*n,d=o,_=l*n;let g=1-i/a,y=1-s/t;u.push(c*e,d*e+r,_*e),p.push(c,d,_),m.push(g,1-y),g=.875*g+.0625,y=.875*y+.0625,g/=3,y/=3,g+=1/3,f.push(g,1-y)}}g=(i+1)*(n+1);for(let e=0;e<t;++e)for(let t=0;t<a;++t){const s=e*(a+1)+t,i=s+a+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}for(let s=0;s<=t;s++){const i=.5*Math.PI+s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=a;i++){const h=2*i*Math.PI/a-Math.PI/2,l=Math.sin(h),c=Math.cos(h)*n,d=o,_=l*n;let g=1-i/a,y=1-s/t;u.push(c*e,d*e-r,_*e),p.push(c,d,_),m.push(g,1-y),g=.875*g+.0625,y=.875*y+.0625,g/=3,y/=3,g+=2/3,f.push(g,1-y)}}g=(i+1)*(n+1)+(a+1)*(t+1);for(let e=0;e<t;++e)for(let t=0;t<a;++t){const s=e*(a+1)+t,i=s+a+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}}else{if(g=(i+1)*(n+1),t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,a=Math.sin(i),r=-s/2,o=Math.cos(i);let h=1-(a+1)/2,l=(o+1)/2;u.push(a*t,r,o*t),p.push(0,-1,0),m.push(h,1-l),h=.875*h+.0625,l=.875*l+.0625,h/=3,l/=3,h+=1/3,f.push(h,1-l),e>1&&_.push(g,g+e,g+e-1)}if(g+=n,e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,a=Math.sin(i),r=s/2,o=Math.cos(i);let h=1-(a+1)/2,l=(o+1)/2;u.push(a*e,r,o*e),p.push(0,1,0),m.push(h,1-l),h=.875*h+.0625,l=.875*l+.0625,h/=3,l/=3,h+=2/3,f.push(h,1-l),t>1&&_.push(g,g+t-1,g+t)}}return{positions:u,normals:p,uvs:m,uvs1:f,indices:_}}function hc(t,e){let s=e&&(e.radius||e.baseRadius);s=void 0!==s?s:.5;const i=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:5,a=e&&void 0!==e.capSegments?e.capSegments:20,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=oc(s,s,i,n,a,!1);return r&&(o.tangents=nc(o.positions,o.normals,o.uvs,o.indices)),ac(t,o.positions,o)}function lc(t,e){const s=e&&void 0!==e.radius?e.radius:.3,i=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:1,a=e&&void 0!==e.sides?e.sides:20,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=oc(s,s,i-2*s,n,a,!0);return r&&(o.tangents=nc(o.positions,o.normals,o.uvs,o.indices)),ac(t,o.positions,o)}function cc(t,e){const s=e&&void 0!==e.baseRadius?e.baseRadius:.5,i=e&&void 0!==e.peakRadius?e.peakRadius:0,n=e&&void 0!==e.height?e.height:1,a=e&&void 0!==e.heightSegments?e.heightSegments:5,r=e&&void 0!==e.capSegments?e.capSegments:18,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,h=oc(s,i,n,a,r,!1);return o&&(h.tangents=nc(h.positions,h.normals,h.uvs,h.indices)),ac(t,h.positions,h)}function dc(t,e){const s=e&&void 0!==e.radius?e.radius:.5,i=e&&void 0!==e.latitudeBands?e.latitudeBands:16,n=e&&void 0!==e.longitudeBands?e.longitudeBands:16,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,r=[],o=[],h=[],l=[];for(let t=0;t<=i;t++){const e=t*Math.PI/i,a=Math.sin(e),l=Math.cos(e);for(let e=0;e<=n;e++){const c=2*e*Math.PI/n-Math.PI/2,d=Math.sin(c),u=Math.cos(c)*a,p=l,m=d*a,f=1-e/n,_=1-t/i;r.push(u*s,p*s,m*s),o.push(u,p,m),h.push(f,1-_)}}for(let t=0;t<i;++t)for(let e=0;e<n;++e){const s=t*(n+1)+e,i=s+n+1;l.push(s+1,i,s),l.push(s+1,i+1,i)}const c={normals:o,uvs:h,uvs1:h,indices:l};return a&&(c.tangents=nc(r,o,h,l)),ac(t,r,c)}function uc(t,e){const s=e&&void 0!==e.halfExtents?e.halfExtents:new ot(.5,.5),i=e&&void 0!==e.widthSegments?e.widthSegments:5,n=e&&void 0!==e.lengthSegments?e.lengthSegments:5,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,r=[],o=[],h=[],l=[];let c=0;for(let t=0;t<=i;t++)for(let e=0;e<=n;e++){const a=-s.x+2*s.x*t/i,d=0,u=-(-s.y+2*s.y*e/n),p=t/i,m=e/n;r.push(a,d,u),o.push(0,1,0),h.push(p,1-m),t<i&&e<n&&(l.push(c+n+1,c+1,c),l.push(c+n+1,c+n+2,c+1)),c++}const d={normals:o,uvs:h,uvs1:h,indices:l};return a&&(d.tangents=nc(r,o,h,l)),ac(t,r,d)}function mc(t,e){const s=e&&void 0!==e.halfExtents?e.halfExtents:new at(.5,.5,.5),i=e&&void 0!==e.widthSegments?e.widthSegments:1,n=e&&void 0!==e.lengthSegments?e.lengthSegments:1,a=e&&void 0!==e.heightSegments?e.heightSegments:1,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=[new at(-s.x,-s.y,s.z),new at(s.x,-s.y,s.z),new at(s.x,s.y,s.z),new at(-s.x,s.y,s.z),new at(s.x,-s.y,-s.z),new at(-s.x,-s.y,-s.z),new at(-s.x,s.y,-s.z),new at(s.x,s.y,-s.z)],h=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c=1,d=2,u=3,p=4,m=5,f=[],_=[],g=[],y=[],v=[];let x=0;const b=(t,e,s)=>{const i=new at,n=new at,a=new at,r=new at;for(let c=0;c<=e;c++)for(let d=0;d<=s;d++){i.lerp(o[h[t][0]],o[h[t][1]],c/e),n.lerp(o[h[t][0]],o[h[t][2]],d/s),a.sub2(n,o[h[t][0]]),r.add2(i,a);let u=c/e,p=d/s;f.push(r.x,r.y,r.z),_.push(l[t][0],l[t][1],l[t][2]),g.push(u,1-p),u=.875*u+.0625,p=.875*p+.0625,u/=3,p/=3,u+=t%3/3,p+=Math.floor(t/3)/3,y.push(u,1-p),c<e&&d<s&&(v.push(x+s+1,x+1,x),v.push(x+s+1,x+s+2,x+1)),x++}};b(0,i,a),b(c,i,a),b(d,i,n),b(u,i,n),b(p,n,a),b(m,n,a);const S={normals:_,uvs:g,uvs1:y,indices:v};return r&&(S.tangents=nc(f,_,g,v)),ac(t,f,S)}function fc(t,e){let s=null;for(let i=0;i<sc.length;i++)sc[i].type===e&&sc[i].device===t&&(s=sc[i].primData);if(!s){let i,n;switch(e){case"box":i=mc(t,{halfExtents:new at(.5,.5,.5)}),n={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=lc(t,{radius:.5,height:2}),n={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=cc(t,{baseRadius:.5,peakRadius:0,height:1}),n={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=hc(t,{radius:.5,height:1}),n={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=uc(t,{halfExtents:new ot(.5,.5),widthSegments:1,lengthSegments:1}),n={x:0,y:1,z:0,uv:1};break;case"sphere":i=dc(t,{radius:.5}),n={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=rc(t,{tubeRadius:.2,ringRadius:.3}),n={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+e)}i.incRefCount(),s={mesh:i,area:n},sc.push({type:e,device:t,primData:s})}return s}class _c extends Fh{constructor(){super(),this.color=new et(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(t){return super.copy(t),this.color.copy(t.color),this.colorMap=t.colorMap,this.vertexColors=t.vertexColors,this}updateUniforms(t,e){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}updateShader(t,e,s,i,n,a){const r={skin:s&&0!=(2&s),screenSpace:s&&0!=(256&s),useInstancing:s&&0!=(32&s),useMorphPosition:s&&0!=(1024&s),useMorphNormal:s&&0!=(2048&s),useMorphTextureBased:s&&0!=(4096&s),vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},o=t.getProgramLibrary();this.shader=o.getProgram("basic",r)}}class gc{constructor(t,e,s){this.origMeshInstances=t,this._aabb=new bt,this.meshInstance=null,this.dynamic=e,this.batchGroupId=s}destroy(t,e){this.meshInstance&&(this.removeFromLayers(t,e),this.meshInstance.destroy())}addToLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let t=1;t<this.origMeshInstances.length;t++)this._aabb.add(this.origMeshInstances[t].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}}class yc{constructor(t,e,s,i,n=[0]){this.dynamic=s,this.maxAabbSize=i,this.id=t,this.name=e,this.layers=n,this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]}}}yc.MODEL="model",yc.ELEMENT="element",yc.SPRITE="sprite",yc.RENDER="render";const vc=new mt;class xc{constructor(t){this.bones=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}set rootBone(t){this._rootBone=t}get rootBone(){return this._rootBone}init(t,e){if(t.supportsBoneTextures){const s=3*e;let i=Math.ceil(Math.sqrt(s));i=q.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new Mo(t,{width:i,height:n,format:14,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*e)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(t,e){this.rootBone=t;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const a=s.boneNames[n];let r=t.findByName(a);r||(r=e),i.push(r)}this.bones=i}initSkin(t){this.skin=t,this.bones=[];const e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(let t=0;t<e;t++)this.matrices[t]=new mt}uploadBones(t){t.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,vc.copy(t.getWorldTransform()).invert();for(let t=this.bones.length-1;t>=0;t--)this.matrices[t].mulAffine2(vc,this.bones[t].getWorldTransform()),this.matrices[t].mulAffine2(this.matrices[t],this.skin.inverseBindPose[t])}}updateMatrices(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)}updateMatrixPalette(t,e){this._updateMatrices(t,e);const s=this.matrixPalette,i=this.bones.length;for(let t=0;t<i;t++){const e=this.matrices[t].data,i=12*t;s[i]=e[0],s[i+1]=e[4],s[i+2]=e[8],s[i+3]=e[12],s[i+4]=e[1],s[i+5]=e[5],s[i+6]=e[9],s[i+7]=e[13],s[i+8]=e[2],s[i+9]=e[6],s[i+10]=e[10],s[i+11]=e[14]}this.uploadBones(this.skin.device)}}class bc extends xc{constructor(t,e,s){super();const i=e.length;this.init(t,i),this.device=t,this.rootNode=s,this.bones=e}updateMatrices(t,e){}updateMatrixPalette(t,e){const s=this.matrixPalette,i=this.bones.length;for(let t=0;t<i;t++){const e=this.bones[t].getWorldTransform().data,i=12*t;s[i]=e[0],s[i+1]=e[4],s[i+2]=e[8],s[i+3]=e[12],s[i+4]=e[1],s[i+5]=e[5],s[i+6]=e[9],s[i+7]=e[13],s[i+8]=e[2],s[i+9]=e[6],s[i+10]=e[10],s[i+11]=e[14]}this.uploadBones(this.device)}}class Sc{static incRef(t){this.cache.incRef(t)}static decRef(t){this.cache.decRef(t)}static destroy(){this.cache.destroy()}}Sc.cache=new class{constructor(){this.cache=new Map}destroy(){this.cache.forEach(((t,e)=>{e.destroy()})),this.cache.clear()}incRef(t){const e=(this.cache.get(t)||0)+1;this.cache.set(t,e)}decRef(t){if(t){let e=this.cache.get(t);e&&(e--,0===e?(this.cache.delete(t),t.destroy()):this.cache.set(t,e))}}};const wc=new bt,Tc=new bt,Mc=new Tt,Cc=new Set;class Ac{constructor(t){this.vertexBuffer=null,this.count=t}}class Pc{constructor(t,e,s){this._key=[],this._key[0]=Rc(t,e,!0,0),this.command=s}set key(t){this._key[0]=t}get key(){return this._key[0]}}class Ec{constructor(t,e,s=null){if(this._material=void 0,t instanceof qo){const i=t;t=e,e=s,s=i}this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=s,this._mesh=t,t.incRefCount(),this.material=e,this._shaderDefs=65536,this._shaderDefs|=t.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=t.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=t.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=t.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.visible=!0,this.layer=15,this._renderStyle=0,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new bt,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}get renderStyle(){return this._renderStyle}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get mesh(){return this._mesh}set aabb(t){this._aabb=t}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=wc,this.skinInstance){if(!this.mesh.boneAabb){const t=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(t)}const s=this.mesh.boneUsed;let i=!0;for(let e=0;e<this.mesh.boneAabb.length;e++)s[e]&&(Tc.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),i?(i=!1,t.center.copy(Tc.center),t.halfExtents.copy(Tc.halfExtents)):t.add(Tc));e=!0}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&t._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),e=!0,this._aabbVer=this.node._aabbVer);return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}set material(t){for(let t=0;t<this._shader.length;t++)this._shader[t]=null;const e=this._material;if(e&&e.removeMeshInstanceRef(this),this._material=t,this._material){this._material.addMeshInstanceRef(this),this.updateKey();if((e&&3!==e.blendType)!==(3!==this._material.blendType)){let t=this._material._scene;!t&&e&&e._scene&&(t=e._scene),t?t.layers._dirtyBlend=!0:this._material._dirtyBlend=!0}}}get material(){return this._material}set layer(t){this._layer=t,this.updateKey()}get layer(){return this._layer}set calculateSortDistance(t){this._calculateSortDistance=t}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(t){this._receiveShadow=t,this._shaderDefs=t?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}get receiveShadow(){return this._receiveShadow}set skinInstance(t){this._skinInstance=t,this._shaderDefs=t?2|this._shaderDefs:-3&this._shaderDefs;for(let t=0;t<this._shader.length;t++)this._shader[t]=null;this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(t){this._morphInstance=t,this._morphInstance&&(this._morphInstance.meshInstance=this),this._shaderDefs=t&&t.morph.useTextureMorph?4096|this._shaderDefs:-4097&this._shaderDefs,this._shaderDefs=t&&t.morph.morphPositions?1024|this._shaderDefs:-1025&this._shaderDefs,this._shaderDefs=t&&t.morph.morphNormals?2048|this._shaderDefs:-2049&this._shaderDefs;for(let t=0;t<this._shader.length;t++)this._shader[t]=null}get morphInstance(){return this._morphInstance}set screenSpace(t){this._screenSpace=t,this._shaderDefs=t?256|this._shaderDefs:-257&this._shaderDefs,this._shader[0]=null}get screenSpace(){return this._screenSpace}set key(t){this._key[0]=t}get key(){return this._key[0]}set mask(t){const e=65535&this._shaderDefs;this._shaderDefs=e|t<<16,this._shader[0]=null,this._shader[1]=null}get mask(){return this._shaderDefs>>16}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){const t=this.mesh;t&&(this.mesh=null,t.refCount<1&&t.destroy()),this.setRealtimeLightmap(Ec.lightmapParamNames[0],null),this.setRealtimeLightmap(Ec.lightmapParamNames[1],null),this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null),this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null),this.material=null}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const i=t[s].mesh;Cc.has(i)||(Cc.add(i),i.prepareRenderState(e))}Cc.clear()}}_isVisible(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(Mc.center=this.aabb.center,Mc.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(Mc)))}updateKey(){const t=this.material;this._key[0]=Rc(this.layer,t.alphaToCoverage||t.alphaTest?2:t.blendType,!1,t.id)}setInstancing(t){t?(this.instancingData=new Ac(t.numVertices),this.instancingData.vertexBuffer=t,t.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=-262141){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const i=this.parameters[t];i?(i.data=e,i.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&Sc.decRef(s.data),e?(Sc.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&e&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(t){t?this.mask=-6&(2|this.mask):(this.setRealtimeLightmap(Ec.lightmapParamNames[0],null),this.setRealtimeLightmap(Ec.lightmapParamNames[1],null),this._shaderDefs&=-8385,this.mask=-7&(1|this.mask))}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}function Rc(t,e,s,i){return(15&t)<<27|(3===e?1:0)<<26|(s?1:0)<<25|(33554431&i)<<0}function Lc(t,e){if(t&&!e)return!1;if(!t&&e)return!1;if((t=t.data)===(e=e.data))return!0;if(t instanceof Float32Array&&e instanceof Float32Array){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}return!1}function Ic(t,e){for(const s in t)if(t.hasOwnProperty(s)&&!Lc(t[s],e[s]))return!1;for(const s in e)if(e.hasOwnProperty(s)&&!Lc(e[s],t[s]))return!1;return!0}function Dc(t,e){for(let s=0;s<t.length;s++)if(e.indexOf(t[s])<0)return!1;for(let s=0;s<e.length;s++)if(t.indexOf(e[s])<0)return!1;return!0}Ec.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];const Oc=new rt,Fc=new at,kc=new at,Bc=new at;function zc(t){const e=t.node.worldTransform;return e.getX(Fc),e.getY(kc),e.getZ(Bc),Fc.cross(Fc,kc),Fc.dot(Bc)>=0?1:-1}class Uc{constructor(t,e,s){this.device=t,this.rootNode=e,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(t,e,s,i,n){if(void 0===i&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const a=new yc(i,t,e,s,n);return this._batchGroups[i]=a,a}removeGroup(t){if(!this._batchGroups[t])return;const e=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===t?this.destroyBatch(this._batchList[s]):e.push(this._batchList[s]);this._batchList=e,this._removeModelsFromBatchGroup(this.rootNode,t),delete this._batchGroups[t]}markGroupDirty(t){this._dirtyGroups.indexOf(t)<0&&this._dirtyGroups.push(t)}getGroupByName(t){const e=this._batchGroups;for(const s in e)if(e.hasOwnProperty(s)&&e[s].name===t)return e[s];return null}getBatches(t){const e=[],s=this._batchList.length;for(let i=0;i<s;i++){const s=this._batchList[i];s.batchGroupId===t&&e.push(s)}return e}_removeModelsFromBatchGroup(t,e){if(t.enabled){t.model&&t.model.batchGroupId===e&&(t.model.batchGroupId=-1),t.render&&t.render.batchGroupId===e&&(t.render.batchGroupId=-1),t.element&&t.element.batchGroupId===e&&(t.element.batchGroupId=-1),t.sprite&&t.sprite.batchGroupId===e&&(t.sprite.batchGroupId=-1);for(let s=0;s<t._children.length;s++)this._removeModelsFromBatchGroup(t._children[s],e)}}insert(t,e,s){const i=this._batchGroups[e];i&&i._obj[t].indexOf(s)<0&&(i._obj[t].push(s),this.markGroupDirty(e))}remove(t,e,s){const i=this._batchGroups[e];if(i){const n=i._obj[t].indexOf(s);n>=0&&(i._obj[t].splice(n,1),this.markGroupDirty(e))}}_extractRender(t,e,s,i){if(t.render){if(t.render.isStatic){const s=this.scene.drawCalls,i=t.render.meshInstances;for(let t=0;t<s.length;t++)s[t]._staticSource&&(i.indexOf(s[t]._staticSource)<0||e.push(s[t]));for(let t=0;t<i.length;t++)s.indexOf(i[t])>=0&&e.push(i[t])}else e=i[t.render.batchGroupId]=e.concat(t.render.meshInstances);t.render.removeFromLayers()}return e}_extractModel(t,e,s,i){if(t.model&&t.model.model){if(t.model.isStatic){const s=this.scene.drawCalls,i=t.model.meshInstances;for(let t=0;t<s.length;t++)s[t]._staticSource&&(i.indexOf(s[t]._staticSource)<0||e.push(s[t]));for(let t=0;t<i.length;t++)s.indexOf(i[t])>=0&&e.push(i[t])}else e=i[t.model.batchGroupId]=e.concat(t.model.meshInstances);t.model.removeModelFromLayers()}return e}_extractElement(t,e,s){if(!t.element)return;let i=!1;t.element._text&&t.element._text._model.meshInstances.length>0?(e.push(t.element._text._model.meshInstances[0]),t.element.removeModelFromLayers(t.element._text._model),i=!0):t.element._image&&(e.push(t.element._image._renderable.meshInstance),t.element.removeModelFromLayers(t.element._image._renderable.model),t.element._image._renderable.unmaskMeshInstance&&(e.push(t.element._image._renderable.unmaskMeshInstance),t.element._image._renderable.unmaskMeshInstance.stencilFront&&t.element._image._renderable.unmaskMeshInstance.stencilBack||(t.element._dirtifyMask(),t.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(t,e){for(let s=0;s<e.length;s++){const i=e[s],n=this._batchGroups[i];if(!n)continue;let a=t[i];a||(a=t[i]=[]);for(let e=0;e<n._obj.model.length;e++)a=this._extractModel(n._obj.model[e],a,n,t);for(let e=0;e<n._obj.render.length;e++)a=this._extractRender(n._obj.render[e],a,n,t);for(let t=0;t<n._obj.element.length;t++)this._extractElement(n._obj.element[t],a,n);for(let t=0;t<n._obj.sprite.length;t++){const e=n._obj.sprite[t];e.sprite&&e.sprite._meshInstance&&(n.dynamic||0===e.sprite.sprite._renderMode)&&(a.push(e.sprite._meshInstance),e.sprite.removeModelFromLayers(),n._sprite=!0,e.sprite._batchGroup=n)}}}generate(t){const e={};t||(t=Object.keys(this._batchGroups));const s=[];for(let e=0;e<this._batchList.length;e++)t.indexOf(this._batchList[e].batchGroupId)<0?s.push(this._batchList[e]):this.destroyBatch(this._batchList[e]);if(this._batchList=s,this._collectAndRemoveMeshInstances(e,t),t===this._dirtyGroups)this._dirtyGroups.length=0;else{const e=[];for(let s=0;s<this._dirtyGroups.length;s++)t.indexOf(this._dirtyGroups[s])<0&&e.push(this._dirtyGroups[s]);this._dirtyGroups=e}let i,n,a,r;for(const t in e)if(e.hasOwnProperty(t)&&(i=e[t],a=this._batchGroups[t],a)){n=this.prepare(i,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(let e=0;e<n.length;e++)r=this.create(n[e],a.dynamic,parseInt(t,10)),r&&r.addToLayers(this.scene,a.layers)}}prepare(t,e,s=Number.POSITIVE_INFINITY,i){if(0===t.length)return[];const n=.5*s,a=this.device.supportsBoneTextures?1024:this.device.boneLimit,r=this.device.extUintElement?4294967295:65535,o=new bt,h=new bt;let l,c=null;const d=[];let u=0;i&&t.sort((function(t,e){return t.drawOrder-e.drawOrder}));let p,m=t;const f=i?function(t){c?c.add(t.aabb):c=t.aabb.clone(),p.push(t)}:function(t){p.push(t)};for(;m.length>0;){d[u]=[m[0]],p=[];const t=m[0].material,s=m[0].layer,_=m[0]._shaderDefs,g=m[0].parameters,y=m[0].stencilFront,v=m[0]._staticLightList;let x=m[0].mesh.vertexBuffer.getNumVertices();const b=m[0].drawOrder;o.copy(m[0].aabb);const S=zc(m[0]),w=m[0].mesh.vertexBuffer.format.batchingHash,T=m[0].mesh.primitive[0].indexed;c=null;for(let M=1;M<m.length;M++){const C=m[M];if(e&&d[u].length>=a){p=p.concat(m.slice(M));break}if(t!==C.material||s!==C.layer||w!==C.mesh.vertexBuffer.format.batchingHash||T!==C.mesh.primitive[0].indexed||_!==C._shaderDefs||x+C.mesh.vertexBuffer.getNumVertices()>r){f(C);continue}if(h.copy(o),h.add(C.aabb),h.halfExtents.x>n||h.halfExtents.y>n||h.halfExtents.z>n){f(C);continue}if(y&&(!(l=C.stencilFront)||y.func!==l.func||y.zpass!==l.zpass)){f(C);continue}if(S!==zc(C)){f(C);continue}if(!Ic(g,C.parameters)){f(C);continue}const A=C._staticLightList;if(v&&A){if(!Dc(v,A)){f(C);continue}}else if(v||A){f(C);continue}i&&c&&c.intersects(C.aabb)&&C.drawOrder!==b?f(C):(o.add(C.aabb),x+=C.mesh.vertexBuffer.getNumVertices(),d[u].push(C))}u++,m=p}return d}collectBatchedMeshData(t,e){let s=null,i=0,n=0,a=null;for(let r=0;r<t.length;r++)if(t[r].visible){const o=t[r].mesh;if(i+=o.vertexBuffer.numVertices,n+=o.primitive[0].indexed?o.primitive[0].count:6===o.primitive[0].type&&4===o.primitive[0].count?6:0,!s){a=t[r].material,s={};const i=o.vertexBuffer.format.elements;for(let t=0;t<i.length;t++){s[i[t].name]={numComponents:i[t].numComponents,dataType:i[t].dataType,normalize:i[t].normalize,count:0}}e&&(s.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:n,material:a}}create(t,e,s){if(!this._init){const t="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n";this.transformVS=t+"#define DYNAMICBATCH\n"+Zr.transformVS,this.skinTexVS=Zr.skinBatchTexVS,this.skinConstVS=Zr.skinBatchConstVS,this.vertexFormats={},this._init=!0}let i,n,a,r=null,o=null;const h=this.collectBatchedMeshData(t,e);if(h.streams){const l=h.streams;let c=h.material;const d=h.batchNumVerts,u=h.batchNumIndices;let p,m,f;o=new gc(t,e,s),this._batchList.push(o);let _,g=0,y=0;const v=new at,x=new(d<=65535?Uint16Array:Uint32Array)(u);for(i in l)r=l[i],r.typeArrayType=Fr[r.dataType],r.elementByteSize=kr[r.dataType],r.buffer=new r.typeArrayType(d*r.numComponents);for(let s=0;s<t.length;s++)if(t[s].visible){for(i in n=t[s].mesh,a=n.vertexBuffer.numVertices,e||(_=t[s].node.getWorldTransform()),l)if("BLENDINDICES"!==i){r=l[i];const t=new r.typeArrayType(r.buffer.buffer,r.elementByteSize*r.count),s=n.getVertexStream(i,t)*r.numComponents;if(r.count+=s,!e&&r.numComponents>=3)if("POSITION"===i)for(let e=0;e<s;e+=r.numComponents)v.set(t[e],t[e+1],t[e+2]),_.transformPoint(v,v),t[e]=v.x,t[e+1]=v.y,t[e+2]=v.z;else if("NORMAL"===i||"TANGENT"===i){_.invertTo3x3(Oc),Oc.transpose();for(let e=0;e<s;e+=r.numComponents)v.set(t[e],t[e+1],t[e+2]),Oc.transformVector(v,v),t[e]=v.x,t[e+1]=v.y,t[e+2]=v.z}}if(e){r=l.BLENDINDICES;for(let t=0;t<a;t++)r.buffer[r.count++]=s}if(n.primitive[0].indexed){p=n.primitive[0].base,m=n.primitive[0].count;const t=n.indexBuffer[0].getFormat();f=new zr[t](n.indexBuffer[0].storage)}else{if(6!==n.primitive[0].type||4!==n.primitive[0].count){m=0;continue}p=0,m=6,f=[0,1,3,2,3,1]}for(let t=0;t<m;t++)x[t+y]=f[p+t]+g;y+=m,g+=a}for(i in n=new ec(this.device),l)r=l[i],n.setVertexStream(i,r.buffer,r.numComponents,void 0,r.dataType,r.normalize);x.length>0&&n.setIndices(x),n.update(4,!1),e&&(c=c.clone(),c.chunks.transformVS=this.transformVS,c.chunks.skinTexVS=this.skinTexVS,c.chunks.skinConstVS=this.skinConstVS,c.update());const b=new Ec(n,c,this.rootNode);b.castShadow=o.origMeshInstances[0].castShadow,b.parameters=o.origMeshInstances[0].parameters,b.isStatic=o.origMeshInstances[0].isStatic,b.layer=o.origMeshInstances[0].layer,b._staticLightList=o.origMeshInstances[0]._staticLightList,b._shaderDefs=o.origMeshInstances[0]._shaderDefs,b.cull=o.origMeshInstances[0].cull;const S=this._batchGroups[s];if(S&&S._ui&&(b.cull=!1),e){const t=[];for(let e=0;e<o.origMeshInstances.length;e++)t.push(o.origMeshInstances[e].node);b.skinInstance=new bc(this.device,t,this.rootNode)}b._updateAabb=!1,b.drawOrder=o.origMeshInstances[0].drawOrder,b.stencilFront=o.origMeshInstances[0].stencilFront,b.stencilBack=o.origMeshInstances[0].stencilBack,b.flipFaces=zc(o.origMeshInstances[0])<0,b.castShadow=o.origMeshInstances[0].castShadow,o.meshInstance=b,o.updateBoundingBox()}return o}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let t=0;t<this._batchList.length;t++)this._batchList[t].dynamic&&this._batchList[t].updateBoundingBox()}clone(t,e){const s=new gc(e,t.dynamic,t.batchGroupId);this._batchList.push(s);const i=[];for(let t=0;t<e.length;t++)i.push(e[t].node);return s.meshInstance=new Ec(t.meshInstance.mesh,t.meshInstance.material,t.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=e[0].parameters,s.meshInstance.isStatic=e[0].isStatic,s.meshInstance.cull=e[0].cull,s.meshInstance.layer=e[0].layer,s.meshInstance._staticLightList=e[0]._staticLightList,t.dynamic&&(s.meshInstance.skinInstance=new bc(this.device,i,this.rootNode)),s.meshInstance.castShadow=t.meshInstance.castShadow,s.meshInstance._shader=t.meshInstance._shader,s.meshInstance.castShadow=t.meshInstance.castShadow,s}destroyBatch(t){t.destroy(this.scene,this._batchGroups[t.batchGroupId].layers)}}const Vc=new at,Nc=new at,Wc=new at,Gc=new bt;class Hc{constructor(){this.light=null,this.min=new at,this.max=new at}}class Xc{constructor(t){this.device=t,this.name="Untitled",this.reportCount=0,this.boundsMin=new at,this.boundsMax=new at,this.boundsDelta=new at,this._cells=new at(1,1,1),this._cellsLimit=new at,this.cells=this._cells,this._maxCellLightCount=0,this._pixelsPerCellCount=0,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new Hc),this.lightsBuffer=new ih(t),this.registerUniforms(t)}set maxCellLightCount(t){const e=q.roundUp(t,4);e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._pixelsPerCellCount=this._maxCellLightCount/4,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(t){Vc.copy(t).floor(),this._cells.equals(Vc)||(this._cells.copy(Vc),this._cellsLimit.copy(Vc).sub(at.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(t){this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterPixelsPerCellId=t.scope.resolve("clusterPixelsPerCell"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=t.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const t=this._cells.x,e=this._cells.y,s=this._cells.z,i=t*e*s,n=this._pixelsPerCellCount*i;let a=Math.ceil(Math.sqrt(n));a=q.roundUp(a,this._pixelsPerCellCount);const r=Math.ceil(n/a);this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this._pixelsPerCellCount,this._clusterCellsDotData[1]=t*s*this._pixelsPerCellCount,this._clusterCellsDotData[2]=t*this._pixelsPerCellCount,this.clusters=new Uint8ClampedArray(4*n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=a,this._clusterTextureSizeData[1]=1/a,this._clusterTextureSizeData[2]=1/r,this.releaseClusterTexture(),this.clusterTexture=ih.createTexture(this.device,a,r,7,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture);const t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterPixelsPerCellId.setValue(this._pixelsPerCellCount),this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(t,e,s){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),s.copy(t.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),e.max(at.ZERO),s.min(this._cellsLimit)}collectLights(t){const e=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;for(let n=0;n<t.length;n++){const a=t[n],r=!!(3&a.mask);if(a.enabled&&0!==a.type&&a.visibleThisFrame&&a.intensity>0&&r){if(!(i<e)){console.warn(`Clustered lighting: more than ${e-1} lights in the frame, ignoring some.`);break}{let t;i<s.length?t=s[i]:(t=new Hc,s.push(t)),t.light=a,a.getBoundingBox(Gc),t.min.copy(Gc.getMin()),t.max.copy(Gc.getMax()),i++}}}s.length=i}evaluateBounds(){const t=this._usedLights,e=this.boundsMin,s=this.boundsMax;if(t.length>1){e.copy(t[1].min),s.copy(t[1].max);for(let i=2;i<t.length;i++)e.min(t[i].min),s.max(t[i].max)}else e.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,e),this.lightsBuffer.setBounds(e,this.boundsDelta)}evaluateCompressionLimits(t){let e=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const a=i[n].light;e=Math.max(a.attenuationEnd,e);const r=t?a._linearFinalColor:a._finalColor;s=Math.max(r[0],s),s=Math.max(r[1],s),s=Math.max(r[2],s)}this._maxAttenuation=e+1e-6,this._maxColorValue=s+1e-6,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(t){this.counts.fill(0),this.clusters.fill(0);const e=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,a=this.clusters,r=this._pixelsPerCellCount,o=this._usedLights;for(let h=1;h<o.length;h++){const l=o[h],c=l.light;this.lightsBuffer.addLightData(c,h,t),this.evalLightCellMinMax(l,Nc,Wc);const d=Nc.x,u=Wc.x,p=Nc.y,m=Wc.y,f=Nc.z,_=Wc.z;for(let t=d;t<=u;t++)for(let o=f;o<=_;o++)for(let l=p;l<=m;l++){const c=t+e*(o+l*s),d=i[c];d<n&&(a[r*c*4+d]=h,i[c]=d+1)}}}update(t,e,s){this.updateParams(s),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.evaluateCompressionLimits(e),this.updateClusters(e),this.uploadTextures()}activate(){this.updateUniforms()}}class qc{constructor(t,e){this.device=t,this.format=e,this.impl=t.createUniformBufferImpl(this),this.storage=new ArrayBuffer(e.byteSize),this.storageFloat32=new Float32Array(this.storage)}destroy(){const t=this.device;this.impl.destroy(t)}loseContext(){this.impl.loseContext()}set(t,e){const s=this.format.map.get(t);if(s){const t=s.offset;this.storageFloat32.set(e,t)}}update(){this.impl.unlock(this)}}const jc=[];jc[2]=4,jc[3]=8,jc[4]=12,jc[5]=16,jc[1]=4,jc[6]=8,jc[7]=12,jc[8]=16,jc[0]=4,jc[9]=8,jc[10]=12,jc[11]=16,jc[14]=64;class Yc{constructor(t,e){this.name=void 0,this.type=void 0,this.byteSize=void 0,this.offset=void 0,this.name=t,this.type=e,this.byteSize=jc[e]}}class Kc{constructor(t){this.byteSize=0,this.map=new Map,this.uniforms=t;let e=0;for(let s=0;s<t.length;s++){const i=t[s];i.offset=e/4,e+=i.byteSize,this.map.set(i.name,i)}this.byteSize=e}}class $c{constructor(t,e){this.name=t,this.visibility=e}}class Zc{constructor(t,e,s){this.device=t,this.bufferFormats=e,this.bufferFormatsMap=new Map,e.forEach(((t,e)=>this.bufferFormatsMap.set(t.name,e))),this.textureFormats=s,this.textureFormatsMap=new Map,s.forEach(((t,e)=>this.textureFormatsMap.set(t.name,e))),this.impl=t.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}loseContext(){}}class Qc{constructor(t,e){this.device=t,this.format=e,this.dirty=!0,this.impl=t.createBindGroupImpl(this),this.textures=[],this.uniformBuffers=[]}setUniformBuffer(t,e){const s=this.format.bufferFormatsMap.get(t);this.uniformBuffers[s]!==e&&(this.uniformBuffers[s]=e,this.dirty=!0)}setTexture(t,e){const s=this.format.textureFormatsMap.get(t);this.textures[s]!==e&&(this.textures[s]=e,this.dirty=!0)}destroy(){this.impl.destroy()}update(){this.dirty&&(this.dirty=!1,this.impl.update(this))}}const Jc=new ht;class td{constructor(t,e){this.device=t,this.lightTextureAtlas=e,this.blitShader2d=null,this.blitShaderCube=null,this.blitTextureId=null,this.invViewProjId=null}destroy(){}getShader(t,e){return this[t]||(this[t]=co(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}",e,`cookie_renderer_${t}`)),this.blitTextureId||(this.blitTextureId=this.device.scope.resolve("blitTexture")),this.invViewProjId||(this.invViewProjId=this.device.scope.resolve("invViewProj")),this[t]}get shader2d(){return this.getShader("blitShader2d","\n\t\tvarying vec2 uv0;\n\t\tuniform sampler2D blitTexture;\n\t\tvoid main(void) {\n\t\t\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t\t}")}get shaderCube(){return this.getShader("blitShaderCube","\n\t\tvarying vec2 uv0;\n\t\tuniform samplerCube blitTexture;\n\t\tuniform mat4 invViewProj;\n\t\tvoid main(void) {\n\t\t\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\t\t\tvec4 worldPos = invViewProj * projPos;\n\t\t\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t\t}")}static createTexture(t,e){return new Mo(t,{name:"CookieAtlas",width:e,height:e,format:7,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}initInvViewProjMatrices(){if(!td._invViewProjMatrices){td._invViewProjMatrices=[];for(let t=0;t<6;t++){const e=$o.create(null,1,t),s=e.projectionMatrix,i=e.node.getLocalTransform().clone().invert();td._invViewProjMatrices[t]=(new mt).mul2(s,i).invert()}}}render(t,e){if(t.enabled&&t.cookie&&t.visibleThisFrame){const s=t.numShadowFaces,i=s>1?this.shaderCube:this.shader2d,n=this.device;s>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(t.cookie);for(let a=0;a<s;a++){if(Jc.copy(t.atlasViewport),s>1){const t=Jc.z/3,e=this.lightTextureAtlas.cubeSlotsOffsets[a];Jc.x+=t*e.x,Jc.y+=t*e.y,Jc.z=t,Jc.w=t,this.invViewProjId.setValue(td._invViewProjMatrices[a].data)}Jc.mulScalar(e.colorBuffer.width),Yr(n,e,i,Jc)}}}}td._invViewProjMatrices=null;class ed{constructor(t,e){this.texture=t,this.cached=!1,this.renderTargets=e}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const t=this.renderTargets;for(let e=0;e<t.length;e++)t[e].destroy();this.renderTargets.length=0}static getShadowFormat(t,e){return 3===e?14:2===e?12:4===e||0===e&&t.webgl2?16:7}static getShadowFiltering(t,e){return 0!==e||t.webgl2?3===e?t.extTextureFloatLinear?1:0:2===e?t.extTextureHalfFloatLinear?1:0:1:0}static create(t,e){let s=null;return s=1===e._type?this.createCubemap(t,e._shadowResolution):this.create2dMap(t,e._shadowResolution,e._shadowType),s}static createAtlas(t,e,s){const i=this.create2dMap(t,e,s),n=i.renderTargets,a=n[0];for(let t=0;t<5;t++)n.push(a);return i}static create2dMap(t,e,s){const i=this.getShadowFormat(t,s),n=this.getShadowFiltering(t,s),a=new Mo(t,{format:i,width:e,height:e,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1,name:"ShadowMap2D"});let r=null;return 4===s||0===s&&t.webgl2?(a.compareOnRead=!0,a.compareFunc=1,r=new al({depthBuffer:a})):r=new al({colorBuffer:a,depth:!0}),new ed(a,[r])}static createCubemap(t,e){const s=new Mo(t,{format:7,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"ShadowMapCube"}),i=[];for(let t=0;t<6;t++){const e=new al({colorBuffer:s,face:t,depth:!0});i.push(e)}return new ed(s,i)}}const sd=[],id=[],nd=new ht,ad=new ht;class rd{constructor(t){this.size=Math.floor(1024*t.w),this.used=!1,this.lightId=-1,this.rect=t}}class od{constructor(t){this.device=t,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=2048,this.cookieAtlas=null,this.cookieRenderTarget=null,this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new ot(0,0),new ot(0,1),new ot(1,0),new ot(1,1),new ot(2,0),new ot(2,1)],this.scissorVec=new ht,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas&&(this.shadowAtlas.destroy(),this.shadowAtlas=null)}destroyCookieAtlas(){this.cookieAtlas&&(this.cookieAtlas.destroy(),this.cookieAtlas=null),this.cookieRenderTarget&&(this.cookieRenderTarget.destroy(),this.cookieRenderTarget=null)}allocateShadowAtlas(t){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==t){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=ed.createAtlas(this.device,t,0),this.shadowAtlas.cached=!0;const e=4/this.shadowAtlasResolution;this.scissorVec.set(e,e,-2*e,-2*e)}}allocateCookieAtlas(t){this.cookieAtlas&&this.cookieAtlas.width===t||(this.version++,this.destroyCookieAtlas(),this.cookieAtlas=td.createTexture(this.device,t),this.cookieRenderTarget=new al({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}))}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0],e=this.device.webgl2?t.depthBuffer:t.colorBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(t,e){let s=e.atlasSplit;if(!s){const e=Math.ceil(Math.sqrt(t));s=id,s[0]=e,s.length=1}if(i=s,n=this.atlasSplit,i.length!==n.length||!i.every(((t,e)=>t===n[e]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const t=this.atlasSplit[0];if(t>1){const e=1/t;for(let s=0;s<t;s++)for(let i=0;i<t;i++){const n=new ht(s*e,i*e,e,e),a=this.atlasSplit[1+s*t+i];if(a>1)for(let t=0;t<a;t++)for(let s=0;s<a;s++){const i=e/a,r=new ht(n.x+t*i,n.y+s*i,i,i);this.slots.push(new rd(r))}else this.slots.push(new rd(n))}}else this.slots.push(new rd(new ht(0,0,1,1)));this.slots.sort(((t,e)=>e.size-t.size))}var i,n}collectLights(t,e,s){const i=s.cookiesEnabled,n=s.shadowsEnabled;let a=!1,r=!1;const o=sd;o.length=0;const h=t=>{for(let e=0;e<t.length;e++){const s=t[e];if(s.visibleThisFrame){const t=n&&s.castShadows,e=i&&!!s.cookie;a||(a=t),r||(r=e),(t||e)&&o.push(s)}}};return(i||n)&&(h(t),h(e)),o.sort(((t,e)=>e.maxScreenSize-t.maxScreenSize)),a&&this.allocateShadowAtlas(this.shadowAtlasResolution),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(a||r)&&this.subdivide(o.length,s),o}setupSlot(t,e){t.atlasViewport.copy(e);const s=t.numShadowFaces;for(let i=0;i<s;i++)if(t.castShadows||t._cookie){if(nd.copy(e),ad.copy(e),2===t._type&&nd.add(this.scissorVec),1===t._type){const t=nd.z/3,e=this.cubeSlotsOffsets[i];nd.x+=t*e.x,nd.y+=t*e.y,nd.z=t,nd.w=t,ad.copy(nd)}if(t.castShadows){const e=t.getRenderData(null,i);e.shadowViewport.copy(nd),e.shadowScissor.copy(ad)}}}assignSlot(t,e,s){t.atlasViewportAllocated=!0;const i=this.slots[e];i.lightId=t.id,i.used=!0,s&&(t.atlasSlotUpdated=!0,t.atlasVersion=this.version,t.atlasSlotIndex=e)}update(t,e,s){this.shadowAtlasResolution=s.shadowAtlasResolution,this.cookieAtlasResolution=s.cookieAtlasResolution;const i=this.collectLights(t,e,s);if(i.length>0){const t=this.slots;for(let e=0;e<t.length;e++)t[e].used=!1;const e=Math.min(i.length,t.length);for(let s=0;s<e;s++){const e=i[s];e.castShadows&&(e._shadowMap=this.shadowAtlas);const n=t[e.atlasSlotIndex];if(e.atlasVersion===this.version&&e.id===(null==n?void 0:n.lightId)){const i=t[e.atlasSlotIndex];i.size!==t[s].size||i.used||this.assignSlot(e,e.atlasSlotIndex,!1)}}let s=0;for(let n=0;n<e;n++){for(;s<t.length&&t[s].used;)s++;const e=i[n];e.atlasViewportAllocated||this.assignSlot(e,s,!0);const a=t[e.atlasSlotIndex];this.setupSlot(e,a.rect)}}this.updateUniforms()}}class hd{constructor(){this.shadowMapCache=new Map}destroy(){this.clear(),this.shadowMapCache=null}clear(){this.shadowMapCache.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.shadowMapCache.clear()}getKey(t){return`${1===t._type}-${t._shadowType}-${t._shadowResolution}`}get(t,e){const s=this.getKey(e),i=this.shadowMapCache.get(s);if(i&&i.length)return i.pop();const n=ed.create(t,e);return n.cached=!0,n}add(t,e){const s=this.getKey(t),i=this.shadowMapCache.get(s);i?i.push(e):this.shadowMapCache.set(s,[e])}}const ld=[new at,new at,new at,new at,new at,new at,new at,new at],cd={min:0,max:0};function dd(t,e,s){ld[0].x=ld[1].x=ld[2].x=ld[3].x=e.x,ld[1].y=ld[3].y=ld[7].y=ld[5].y=e.y,ld[2].z=ld[3].z=ld[6].z=ld[7].z=e.z,ld[4].x=ld[5].x=ld[6].x=ld[7].x=s.x,ld[0].y=ld[2].y=ld[4].y=ld[6].y=s.y,ld[0].z=ld[1].z=ld[4].z=ld[5].z=s.z;let i=9999999999,n=-9999999999;for(let e=0;e<8;++e){t.transformPoint(ld[e],ld[e]);const s=ld[e].z;s<i&&(i=s),s>n&&(n=s)}return cd.min=i,cd.max=n,cd}function ud(t,e){return Math.exp(-t*t/(2*e*e))}const pd=new bt,md=new mt,fd=new mt,_d=new Float32Array(2),gd=new ht(1,1,0,0),yd={r:1,g:2,b:3,a:4},vd=new at,xd=new mt;function bd(t){const e=t.material,s=t.skinInstance?10:0;let i=0;if(e.opacityMap){const t=e.opacityMapChannel;t&&(i=yd[t])}return s+i}class Sd{constructor(t,e){this.device=t.device,this.forwardRenderer=t,this.lightTextureAtlas=e;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[Zr.blurVSMPS,"#define GAUSS\n"+Zr.blurVSMPS];const i="#define PACKED\n";this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.shadowMapCache=new hd}destroy(){this.shadowMapCache.destroy(),this.shadowMapCache=null}static createShadowCamera(t,e,s,i){const n=$o.create("ShadowCamera",s,i);return n.clearColor=e>=1&&e<=3?new et(0,0,0,0):new et(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(t,e,s,i,n){let a=4===s||0===s&&e.webgl2;1!==i||n||(a=!1),t.clearColorBuffer=!a}cullShadowCasters(t,e,s){let i=0;const n=t.length;for(let a=0;a<n;a++){const n=t[a];n.cull&&!n._isVisible(s)||(n.visibleThisFrame=!0,e[i]=n,i++)}e.length=i,e.sort(this.forwardRenderer.depthSortCompare)}cullLocal(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.visibleThisFrame=!0,s||t._shadowMap||(t._shadowMap=ed.create(this.device,t));const i=t._type,n=2===i?1:6;for(let a=0;a<n;a++){const n=t.getRenderData(null,a),r=n.shadowCamera;r.nearClip=t.attenuationEnd/1e3,r.farClip=t.attenuationEnd;const o=r._node,h=t._node;if(o.setPosition(h.getPosition()),2===i)r.fov=2*t._outerConeAngle,o.setRotation(h.getRotation()),o.rotateLocal(-90,0,0);else if(1===i)if(s){const e=2/(this.lightTextureAtlas.shadowAtlasResolution*t.atlasViewport.z/3)*this.lightTextureAtlas.shadowEdgePixels;r.fov=Math.atan(1+e)*q.RAD_TO_DEG*2}else r.fov=90;this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(e,n.visibleCasters,r)}}generateSplitDistances(t,e,s){t._shadowCascadeDistances.fill(s);for(let i=1;i<t.numCascades;i++){const n=i/t.numCascades,a=e+(s-e)*n,r=e*(s/e)**n,o=q.lerp(a,r,t.cascadeDistribution);t._shadowCascadeDistances[i-1]=o}}cullDirectional(t,e,s){t.visibleThisFrame=!0,t._shadowMap||(t._shadowMap=ed.create(this.device,t));const i=s._nearClip;this.generateSplitDistances(t,i,t.shadowDistance);for(let n=0;n<t.numCascades;n++){const a=t.getRenderData(s,n),r=a.shadowCamera;r.renderTarget=t._shadowMap.renderTargets[0],a.shadowViewport.copy(t.cascades[n]),a.shadowScissor.copy(t.cascades[n]);const o=r._node,h=t._node;o.setPosition(h.getPosition()),o.setRotation(h.getRotation()),o.rotateLocal(-90,0,0);const l=0===n?i:t._shadowCascadeDistances[n-1],c=t._shadowCascadeDistances[n],d=ei.getPoints(s,l,c);vd.set(0,0,0);const u=s.node.getWorldTransform();for(let t=0;t<8;t++)u.transformPoint(d[t],d[t]),vd.add(d[t]);vd.mulScalar(1/8);let p=0;for(let t=0;t<8;t++){const e=d[t].sub(vd).length();e>p&&(p=e)}const m=o.right,f=o.up,_=o.forward,g=.25*t._shadowResolution/p,y=Math.ceil(vd.dot(f)*g)/g,v=Math.ceil(vd.dot(m)*g)/g,x=f.mulScalar(y),b=m.mulScalar(v),S=vd.dot(_),w=_.mulScalar(S);vd.add2(x,b).add(w),o.setPosition(vd),o.translateLocal(0,0,1e6),r.nearClip=0,r.farClip=2e6,r.orthoHeight=p,this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(e,a.visibleCasters,r);let T=!0;const M=a.visibleCasters;for(let t=0;t<M.length;t++){const e=M[t];T?(T=!1,pd.copy(e.aabb)):pd.add(e.aabb)}md.copy(o.getWorldTransform()).invert();const C=dd(md,pd.getMin(),pd.getMax());o.translateLocal(0,0,C.max+.1),r.farClip=C.max-C.min+.2}}setupRenderState(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.webgl2?1!==e._type||s?(t.setDepthBias(!0),t.setDepthBiasValues(-1e3*e.shadowBias,-1e3*e.shadowBias)):t.setDepthBias(!1):t.extStandardDerivatives&&(1===e._type?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=-1e3*e.shadowBias,this.polygonOffset[1]=-1e3*e.shadowBias,this.polygonOffsetId.setValue(this.polygonOffset))),t.setBlending(!1),t.setDepthWrite(!0),t.setDepthTest(!0),t.setDepthFunc(3);(s?e._isPcf&&t.webgl2:e._isPcf&&t.webgl2&&1!==e._type)?t.setColorWrite(!1,!1,!1,!1):t.setColorWrite(!0,!0,!0,!0)}restoreRenderState(t){t.webgl2?t.setDepthBias(!1):t.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))}dispatchUniforms(t,e,s,i){const n=e._node;0!==t._type&&(this.forwardRenderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(t.attenuationEnd)),md.setTRS(n.getPosition(),n.getRotation(),at.ONE).invert(),fd.mul2(e.projectionMatrix,md);const a=s.shadowViewport;e.rect=a,e.scissorRect=s.shadowScissor,xd.setViewport(a.x,a.y,a.z,a.w),s.shadowMatrix.mul2(xd,fd),0===t._type&&t._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}submitCasters(t,e){const s=this.device,i=this.forwardRenderer,n=e._shadowType+6*e._type,a=t.length;for(let e=0;e<a;e++){const a=t[e],r=a.mesh,o=a.material;i.setBaseConstants(s,o),i.setSkinning(s,a,o),o.dirty&&(o.updateUniforms(s,i.scene),o.dirty=!1),o.chunks&&(i.setCullMode(!0,!1,a),o.setParameters(s),a.setParameters(s,8));let h=a._shader[3+n];h||(i.updateShader(a,a._shaderDefs,null,3+n),h=a._shader[3+n],a._key[1]=bd(a)),s.setShader(h),i.setVertexBuffers(s,r),i.setMorphing(s,a.morphInstance);const l=a.renderStyle;s.setIndexBuffer(r.indexBuffer[l]),i.drawInstance(s,a,r,l),i._shadowDrawCalls++}}render(t,e){if(t.enabled&&t.castShadows&&0!==t.shadowUpdateMode&&t.visibleThisFrame){const s=this.device;1===t.shadowUpdateMode&&(t.shadowUpdateMode=0);const i=t._type,n=t._shadowType,a=t.numShadowFaces,r=this.forwardRenderer;r._shadowMapUpdates+=a;const o=r.scene.clusteredLightingEnabled;this.setupRenderState(s,t);for(let h=0;h<a;h++){const a=t.getRenderData(0===i?e:null,h),l=a.shadowCamera;Sd.setShadowCameraSettings(l,s,n,i,o);const c=0===i?0:h;l.renderTarget=t._shadowMap.renderTargets[c],this.dispatchUniforms(t,l,a,h),r.setCamera(l,l.renderTarget,!0),this.submitCasters(a.visibleCasters,t)}if(t._isVsm&&t._vsmBlurSize>1){this.forwardRenderer.scene.clusteredLightingEnabled&&0!==i||this.applyVsmBlur(t,e)}this.restoreRenderState(s)}}getVsmBlurShader(t,e,s){let i=(t?this.blurPackedVsmShader:this.blurVsmShader)[e][s];if(!i){this.blurVsmWeights[s]=function(t){t>25&&(t=25);const e=(t-1)/6,s=.5*(t-1),i=new Array(t);let n=0;for(let a=0;a<t;++a)i[a]=ud(a-s,e),n+=i[a];for(let e=0;e<t;++e)i[e]/=n;return i}(s);const n=Zr.fullscreenQuadVS;let a="#define SAMPLES "+s+"\n";a+=t?this.blurPackedVsmShaderCode[e]:this.blurVsmShaderCode[e];const r="blurVsm"+e+s+t;i=co(this.device,n,a,r),t?this.blurPackedVsmShader[e][s]=i:this.blurVsmShader[e][s]=i}return i}applyVsmBlur(t,e){const s=this.device,i=t.getRenderData(0===t._type?e:null,0).shadowCamera.renderTarget,n=this.shadowMapCache.get(s,t),a=n.renderTargets[0],r=1===t._shadowType,o=t.vsmBlurMode,h=t._vsmBlurSize,l=this.getVsmBlurShader(r,o,h);gd.z=t._shadowResolution-2,gd.w=gd.z,this.sourceId.setValue(i.colorBuffer),_d[0]=1/t._shadowResolution,_d[1]=0,this.pixelOffsetId.setValue(_d),1===o&&this.weightId.setValue(this.blurVsmWeights[h]),Yr(s,a,l,null,gd),this.sourceId.setValue(a.colorBuffer),_d[1]=_d[0],_d[0]=0,this.pixelOffsetId.setValue(_d),Yr(s,i,l,null,gd),this.shadowMapCache.add(t,n)}}const wd=new Tt;class Td{static lightCompare(t,e){return t.key-e.key}static prepare(t,e,s,i){const n=s,a=n.length,r=[],o=new at,h=new at,l=new bt,c=new mt,d=[],u=[],p=[],m=[];for(let e=0;e<a;e++){const s=n[e];if(s.isStatic){const e=s.aabb;m.length=0;for(let t=1;t<=2;t++)for(let n=0;n<i.length;n++){const a=i[n];if(a._type===t&&(a.enabled&&a.mask&s.mask&&a.isStatic)){if(u[n]||(u[n]=new bt,a._node.getWorldTransform(),a.getBoundingSphere(wd),u[n].center.copy(wd.center),u[n].halfExtents.set(wd.radius,wd.radius,wd.radius)),!u[n].intersects(e))continue;m.push(n)}}if(0===m.length){r.push(s);continue}const n=s.mesh,a=n.vertexBuffer,f=n.indexBuffer[s.renderStyle],_=2===f.bytesPerIndex?new Uint16Array(f.lock()):new Uint32Array(f.lock()),g=n.primitive[s.renderStyle].count/3,y=n.primitive[s.renderStyle].base,v=a.format.elements,x=a.format.size/4,b=new Float32Array(a.storage);let S;for(let t=0;t<v.length;t++)"POSITION"===v[t].name&&(S=v[t].offset/4);d.length=g;for(let t=0;t<g;t++)d[t]=0;let w=!1;p.length=6*g;for(let t=0;t<g;t++){let e=Number.MAX_VALUE,s=Number.MAX_VALUE,i=Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let o=0;o<3;o++){let h=_[3*t+o+y];h=h*x+S;const l=b[h],c=b[h+1],d=b[h+2];l<e&&(e=l),c<s&&(s=c),d<i&&(i=d),l>n&&(n=l),c>a&&(a=c),d>r&&(r=d)}const o=6*t;p[o]=e,p[o+1]=s,p[o+2]=i,p[o+3]=n,p[o+4]=a,p[o+5]=r}for(let t=0;t<m.length;t++){const e=m[t];c.copy(s.node.worldTransform).invert(),l.setFromTransformedAabb(u[e],c);const i=l.getMin(),n=l.getMax(),a=1<<t;for(let t=0;t<g;t++){const e=6*t;p[e]<=n.x&&p[e+3]>=i.x&&p[e+1]<=n.y&&p[e+4]>=i.y&&p[e+2]<=n.z&&p[e+5]>=i.z&&(d[t]|=a,w=!0)}}if(w){const e={};for(let t=0;t<g;t++){const s=3*t+y,i=d[t];e[i]||(e[i]=[]);const n=e[i];n.push(_[s]),n.push(_[s+1]),n.push(_[s+2])}for(const n in e){const l=e[n],c=new ll(t,f.format,l.length,f.usage);(2===c.bytesPerIndex?new Uint16Array(c.lock()):new Uint32Array(c.lock())).set(l),c.unlock();let d=Number.MAX_VALUE,u=Number.MAX_VALUE,p=Number.MAX_VALUE,_=-Number.MAX_VALUE,g=-Number.MAX_VALUE,y=-Number.MAX_VALUE;for(let t=0;t<l.length;t++){const e=l[t],s=b[e*x+S],i=b[e*x+S+1],n=b[e*x+S+2];s<d&&(d=s),i<u&&(u=i),n<p&&(p=n),s>_&&(_=s),i>g&&(g=i),n>y&&(y=n)}o.set(d,u,p),h.set(_,g,y);const v=new bt;v.setMinMax(o,h);const w=new ec(t);w.vertexBuffer=a,w.indexBuffer[0]=c,w.primitive[0].type=4,w.primitive[0].base=0,w.primitive[0].count=l.length,w.primitive[0].indexed=!0,w.aabb=v;const T=new Ec(w,s.material,s.node);T.isStatic=s.isStatic,T.visible=s.visible,T.layer=s.layer,T.castShadow=s.castShadow,T._receiveShadow=s._receiveShadow,T.cull=s.cull,T.pick=s.pick,T.mask=s.mask,T.parameters=s.parameters,T._shaderDefs=s._shaderDefs,T._staticSource=s,s._staticLightList?T._staticLightList=s._staticLightList:T._staticLightList=[];for(let t=0;t<m.length;t++){if(n&1<<t){const e=i[m[t]];T._staticLightList.indexOf(e)<0&&T._staticLightList.push(e)}}T._staticLightList.sort(Td.lightCompare),r.push(T)}}else r.push(s)}else r.push(s)}s.length=r.length;for(let t=0;t<r.length;t++)s[t]=r[t]}static revert(t){const e=t,s=e.length,i=[];let n;for(let t=0;t<s;t++){const s=e[t];s._staticSource?s._staticSource!==n&&(i.push(s._staticSource),n=s._staticSource):i.push(s)}t.length=i.length;for(let e=0;e<i.length;e++)t[e]=i[e]}}new at(1,1,1),new at(40,0,0);class Md{constructor(t,e){this.name=void 0,this.renderTarget=t,this.execute=e}}const Cd=new mt,Ad=new mt,Pd=new rt,Ed=new mt;let Rd;const Ld=(new mt).setScale(1,-1,1),Id=new mt,Dd=new mt,Od=new at,Fd=new at,kd=new at,Bd=new Tt,zd=[0,0,0,0];let Ud,Vd,Nd,Wd,Gd,Hd,Xd=0;const qd={drawCalls:[],isNewMaterial:[],lightMaskChanged:[]},jd=new Set;class Yd{constructor(t){this.clustersDebugRendered=!1,this.device=t,this.scene=null,this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._numDrawCallsCulled=0,this._instancedDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._layerCompositionUpdateTime=0,this._lightClustersTime=0,this._lightClusters=0;const e=this.device;this.library=e.getProgramLibrary(),this.lightTextureAtlas=new od(e),this._shadowRenderer=new Sd(this,this.lightTextureAtlas),this._cookieRenderer=new td(e,this.lightTextureAtlas);const s=e.scope;this.projId=s.resolve("matrix_projection"),this.projSkyboxId=s.resolve("matrix_projectionSkybox"),this.viewId=s.resolve("matrix_view"),this.viewId3=s.resolve("matrix_view3"),this.viewInvId=s.resolve("matrix_viewInverse"),this.viewProjId=s.resolve("matrix_viewProjection"),this.flipYId=s.resolve("projectionFlipY"),this.viewPos=new Float32Array(3),this.viewPosId=s.resolve("view_position"),this.nearClipId=s.resolve("camera_near"),this.farClipId=s.resolve("camera_far"),this.cameraParamsId=s.resolve("camera_params"),this.tbnBasis=s.resolve("tbnBasis"),this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.modelMatrixId=s.resolve("matrix_model"),this.normalMatrixId=s.resolve("matrix_normal"),this.poseMatrixId=s.resolve("matrix_pose[0]"),this.boneTextureId=s.resolve("texture_poseMap"),this.boneTextureSizeId=s.resolve("texture_poseMapSize"),this.morphWeightsA=s.resolve("morph_weights_a"),this.morphWeightsB=s.resolve("morph_weights_b"),this.morphPositionTex=s.resolve("morphPositionTex"),this.morphNormalTex=s.resolve("morphNormalTex"),this.morphTexParams=s.resolve("morph_tex_params"),this.alphaTestId=s.resolve("alpha_ref"),this.opacityMapId=s.resolve("texture_opacityMap"),this.ambientId=s.resolve("light_globalAmbient"),this.exposureId=s.resolve("exposure"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.twoSidedLightingNegScaleFactorId=s.resolve("twoSidedLightingNegScaleFactor"),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4),this.viewUniformFormat=null,this.viewBindGroupFormat=null}destroy(){this._shadowRenderer.destroy(),this._shadowRenderer=null,this._cookieRenderer.destroy(),this._cookieRenderer=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist;if(t.zdist2&&e.zdist2)return t.zdist2-e.zdist2}return e._key[0]-t._key[0]}sortCompareMesh(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist}return Gd=t._key[0],Hd=e._key[0],Gd===Hd&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Hd-Gd}depthSortCompare(t,e){return Gd=t._key[1],Hd=e._key[1],Gd===Hd&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Hd-Gd}updateCameraFrustum(t){if(t.xr&&t.xr.views.length){const e=t.xr.views[0];return Ed.mul2(e.projMat,e.viewOffMat),void t.frustum.setFromMat4(Ed)}if(Rd=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(Rd,0),t.calculateTransform)t.calculateTransform(Cd,0);else{const e=t._node.getPosition(),s=t._node.getRotation();Cd.setTRS(e,s,at.ONE),this.viewInvId.setValue(Cd.data)}Ad.copy(Cd).invert(),Ed.mul2(Rd,Ad),t.frustum.setFromMat4(Ed)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Kc([new Yc("matrix_viewProjection",14)]),this.viewBindGroupFormat=new Zc(this.device,[new $c("view",3)],[]))}setCamera(t,e,s,i=null){let n,a=1;if(t.xr&&t.xr.session){const e=t._node.parent;e&&(n=e.getWorldTransform());const s=t.xr.views;a=s.length;for(let i=0;i<a;i++){const a=s[i];e?(a.viewInvOffMat.mul2(n,a.viewInvMat),a.viewOffMat.copy(a.viewInvOffMat).invert()):(a.viewInvOffMat.copy(a.viewInvMat),a.viewOffMat.copy(a.viewMat)),a.viewMat3.setFromMat4(a.viewOffMat),a.projViewOffMat.mul2(a.projMat,a.viewOffMat),a.position[0]=a.viewInvOffMat.data[12],a.position[1]=a.viewInvOffMat.data[13],a.position[2]=a.viewInvOffMat.data[14],t.frustum.setFromMat4(a.projViewOffMat)}}else{if(Rd=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(Rd,0),this.projId.setValue(Rd.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data),t.calculateTransform)t.calculateTransform(Cd,0);else{const e=t._node.getPosition(),s=t._node.getRotation();Cd.setTRS(e,s,at.ONE)}this.viewInvId.setValue(Cd.data),Ad.copy(Cd).invert(),this.viewId.setValue(Ad.data),Pd.setFromMat4(Ad),this.viewId3.setValue(Pd.data),Ed.mul2(Rd,Ad),e&&e.flipY?(Id.mul2(Ld,Ed),Dd.mul2(Ld,t.getProjectionMatrixSkybox()),this.viewProjId.setValue(Id.data),this.projSkyboxId.setValue(Dd.data)):(this.viewProjId.setValue(Ed.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data)),this.flipYId.setValue(null!=e&&e.flipY?-1:1),this.dispatchViewPos(t._node.getPosition()),t.frustum.setFromMat4(Ed)}this.tbnBasis.setValue(e&&e.flipY?-1:1),this.nearClipId.setValue(t._nearClip),this.farClipId.setValue(t._farClip);const r=t._nearClip,o=t._farClip;this.cameraParams[0]=1/o,this.cameraParams[1]=o,this.cameraParams[2]=.5*(1-o/r),this.cameraParams[3]=.5*(1+o/r),this.cameraParamsId.setValue(this.cameraParams),this.clearView(t,e,s,!1),this.device.supportsUniformBuffers&&this.setupViewUniformBuffers(i,a)}setupViewUniformBuffers(t,e){if(t){const s=this.device;for(;t.viewBindGroups.length<e;){const e=new qc(s,this.viewUniformFormat);t.viewUniformBuffers.push(e);const i=new Qc(s,this.viewBindGroupFormat);t.viewBindGroups.push(i)}const i=t.viewUniformBuffers[0];i.set("matrix_viewProjection",this.viewProjId.value),i.update();const n=t.viewBindGroups[0];n.setUniformBuffer("view",i),n.update(),s.setBindGroup(0,n)}}clearView(t,e,s,i){const n=this.device;n.setRenderTarget(e),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0));const a=e?e.width:n.width,r=e?e.height:n.height,o=t.rect;let h=Math.floor(o.x*a),l=Math.floor(o.y*r),c=Math.floor(o.z*a),d=Math.floor(o.w*r);if(n.setViewport(h,l,c,d),t._scissorRectClear){const e=t.scissorRect;h=Math.floor(e.x*a),l=Math.floor(e.y*r),c=Math.floor(e.z*a),d=Math.floor(e.w*r)}if(n.setScissor(h,l,c,d),s){const e=t._clearOptions;n.clear(e||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?1:0)|(t._clearDepthBuffer?2:0)|(t._clearStencilBuffer?4:0),stencil:t._clearStencil})}}dispatchGlobalLights(t){if(this.ambientColor[0]=t.ambientLight.r,this.ambientColor[1]=t.ambientLight.g,this.ambientColor[2]=t.ambientLight.b,t.gammaCorrection)for(let t=0;t<3;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(t.exposure),t.skyboxModel&&this.skyboxIntensityId.setValue(t.skyboxIntensity)}_resolveLight(t,e){const s="light"+e;this.lightColorId[e]=t.resolve(s+"_color"),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(s+"_direction"),this.lightShadowMapId[e]=t.resolve(s+"_shadowMap"),this.lightShadowMatrixId[e]=t.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[e]=t.resolve(s+"_shadowParams"),this.lightRadiusId[e]=t.resolve(s+"_radius"),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(s+"_position"),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(s+"_halfWidth"),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(s+"_halfHeight"),this.lightInAngleId[e]=t.resolve(s+"_innerConeAngle"),this.lightOutAngleId[e]=t.resolve(s+"_outerConeAngle"),this.lightCookieId[e]=t.resolve(s+"_cookie"),this.lightCookieIntId[e]=t.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[e]=t.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[e]=t.resolve(s+"_cookieOffset"),this.shadowMatrixPaletteId[e]=t.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[e]=t.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[e]=t.resolve(s+"_shadowCascadeCount")}setLTCDirectionalLight(t,e,s,i,n){this.lightPos[e][0]=i.x-s.x*n,this.lightPos[e][1]=i.y-s.y*n,this.lightPos[e][2]=i.z-s.z*n,this.lightPosId[e].setValue(this.lightPos[e]);const a=t.transformVector(new at(-.5,0,0));this.lightWidth[e][0]=a.x*n,this.lightWidth[e][1]=a.y*n,this.lightWidth[e][2]=a.z*n,this.lightWidthId[e].setValue(this.lightWidth[e]);const r=t.transformVector(new at(0,0,.5));this.lightHeight[e][0]=r.x*n,this.lightHeight[e][1]=r.y*n,this.lightHeight[e][2]=r.z*n,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchDirectLights(t,e,s,i){let n=0;const a=this.device.scope;for(let r=0;r<t.length;r++){if(!(t[r].mask&s))continue;const o=t[r],h=o._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(a,n),this.lightColorId[n].setValue(e.gammaCorrection?o._linearFinalColor:o._finalColor),h.getY(o._direction).mulScalar(-1),o._direction.normalize(),this.lightDir[n][0]=o._direction.x,this.lightDir[n][1]=o._direction.y,this.lightDir[n][2]=o._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),0!==o.shape&&this.setLTCDirectionalLight(h,n,o._direction,i._node.getPosition(),i.farClip),o.castShadows){const t=o.getRenderData(i,0),e=o._getUniformBiasValues(t);this.lightShadowMapId[n].setValue(t.shadowBuffer),this.lightShadowMatrixId[n].setValue(t.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(o._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(o._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(o.numCascades);const s=o._shadowRenderParams;s.length=3,s[0]=o._shadowResolution,s[1]=e.normalBias,s[2]=e.bias,this.lightShadowParamsId[n].setValue(s)}n++}return n}setLTCPositionalLight(t,e){const s=t.transformVector(new at(-.5,0,0));this.lightWidth[e][0]=s.x,this.lightWidth[e][1]=s.y,this.lightWidth[e][2]=s.z,this.lightWidthId[e].setValue(this.lightWidth[e]);const i=t.transformVector(new at(0,0,.5));this.lightHeight[e][0]=i.x,this.lightHeight[e][1]=i.y,this.lightHeight[e][2]=i.z,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchOmniLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer),this.lightShadowMatrixId[i].setValue(t.shadowMatrix.data);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n)}if(s._cookie){if(!s.castShadows){const t=$o.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(t.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(t,e,s,i,n){let a=i;const r=this.device.scope,o=t[1],h=o.length;for(let t=0;t<h;t++){const i=o[t];i.mask&s&&(i.isStatic||(this.dispatchOmniLight(e,r,i,a),a++))}let l=0;if(n){let t=n[l];for(;t&&1===t._type;)this.dispatchOmniLight(e,r,t,a),a++,l++,t=n[l]}const c=t[2],d=c.length;for(let t=0;t<d;t++){const i=c[t];i.mask&s&&(i.isStatic||(this.dispatchSpotLight(e,r,i,a),a++))}if(n){let t=n[l];for(;t&&2===t._type;)this.dispatchSpotLight(e,r,t,a),a++,l++,t=n[l]}}cull(t,e,s){let i=0;const n=e.length,a=t.cullingMask||4294967295;if(!t.frustumCulling){for(let t=0;t<n;t++){const n=e[t];(n.visible||n.command)&&(n.mask&&0==(n.mask&a)||(s[i]=n,i++,n.visibleThisFrame=!0))}return i}for(let r=0;r<n;r++){const n=e[r];if(n.command)s[i]=n,i++,n.visibleThisFrame=!0;else{if(!n.visible)continue;let e=!0;if(n.mask&&0==(n.mask&a))continue;n.cull&&(e=n._isVisible(t)),e&&(s[i]=n,i++,n.visibleThisFrame=!0)}}return i}cullLights(t,e){const s=this.scene.clusteredLightingEnabled;for(let i=0;i<e.length;i++){const n=e[i];if(n.enabled&&0!==n._type)if(n.getBoundingSphere(Bd),t.frustum.containsSphere(Bd)){n.visibleThisFrame=!0;const e=t.getScreenSize(Bd);n.maxScreenSize=Math.max(n.maxScreenSize,e)}else s||n.castShadows&&!n.shadowMap&&(n.visibleThisFrame=!0)}}updateCpuSkinMatrices(t){Xd++;const e=t.length;if(0!==e)for(let s=0;s<e;s++){const e=t[s].skinInstance;e&&(e.updateMatrices(t[s].node,Xd),e._dirty=!0)}}updateGpuSkinMatrices(t){const e=t.length;for(let s=0;s<e;s++){if(!t[s].visibleThisFrame)continue;const e=t[s].skinInstance;e&&e._dirty&&(e.updateMatrixPalette(t[s].node,Xd),e._dirty=!1)}}updateMorphing(t){const e=t.length;for(let s=0;s<e;s++){const e=t[s].morphInstance;e&&e._dirty&&t[s].visibleThisFrame&&e.update()}}setBaseConstants(t,e){t.setCullMode(e.cull),e.opacityMap&&(this.opacityMapId.setValue(e.opacityMap),this.alphaTestId.setValue(e.alphaTest))}setSkinning(t,e,s){e.skinInstance&&(this._skinDrawCalls++,t.supportsBoneTextures?(Ud=e.skinInstance.boneTexture,this.boneTextureId.setValue(Ud),zd[0]=Ud.width,zd[1]=Ud.height,zd[2]=1/Ud.width,zd[3]=1/Ud.height,this.boneTextureSizeId.setValue(zd)):this.poseMatrixId.setValue(e.skinInstance.matrixPalette))}drawInstance(t,e,s,i,n){Vd=e.instancingData,Vd?Vd.count>0&&(this._instancedDrawCalls++,t.setVertexBuffer(Vd.vertexBuffer),t.draw(s.primitive[i],Vd.count)):(Nd=e.node.worldTransform,this.modelMatrixId.setValue(Nd.data),n&&(Wd=e.node.normalMatrix,e.node._dirtyNormal&&(Nd.invertTo3x3(Wd),Wd.transpose(),e.node._dirtyNormal=!1),this.normalMatrixId.setValue(Wd.data)),t.draw(s.primitive[i]))}drawInstance2(t,e,s,i){Vd=e.instancingData,Vd?Vd.count>0&&(this._instancedDrawCalls++,t.draw(s.primitive[i],Vd.count,!0)):t.draw(s.primitive[i],void 0,!0)}renderShadows(t,e){const s=this.scene.clusteredLightingEnabled;for(let i=0;i<t.length;i++){const n=t[i];if(s&&0!==n._type){if(!n.atlasViewportAllocated)continue;n.atlasSlotUpdated&&0===n.shadowUpdateMode&&(n.shadowUpdateMode=1)}this._shadowRenderer.render(n,e)}}renderCookies(t){const e=this.lightTextureAtlas.cookieRenderTarget;for(let s=0;s<t.length;s++){const i=t[s];i.atlasViewportAllocated&&(i.atlasSlotUpdated&&this._cookieRenderer.render(i,e))}}updateShader(t,e,s,i,n){t.material._scene=this.scene,t.material._dirtyBlend&&(this.scene.layers._dirtyBlend=!0),t.material.updateShader(this.device,this.scene,e,s,i,n),t._shader[i]=t.material.shader}setCullMode(t,e,s){const i=s.material;let n=0;if(t){let t=1;if(i.cull>0&&i.cull<3){s.flipFaces&&(t*=-1),e&&(t*=-1);const i=s.node.worldTransform;i.getX(Od),i.getY(Fd),i.getZ(kd),Od.cross(Od,Fd),Od.dot(kd)<0&&(t*=-1)}n=t<0?2===i.cull?1:2:i.cull}if(this.device.setCullMode(n),0===n&&0===i.cull){const t=s.node.worldTransform;t.getX(Od),t.getY(Fd),t.getZ(kd),Od.cross(Od,Fd),Od.dot(kd)<0?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1)}}setVertexBuffers(t,e){t.setVertexBuffer(e.vertexBuffer)}setMorphing(t,e){if(e)if(e.morph.useTextureMorph)t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams);else{for(let s=0;s<e._activeVertexBuffers.length;s++){const i=e._activeVertexBuffers[s];if(i){const e="ATTR"+(s+8);i.format.elements[0].name=e,i.format.elements[0].scopeId=t.scope.resolve(e),i.format.update(),t.setVertexBuffer(i)}}this.morphWeightsA.setValue(e._shaderMorphWeightsA),this.morphWeightsB.setValue(e._shaderMorphWeightsB)}}dispatchViewPos(t){const e=this.viewPos;e[0]=t.x,e[1]=t.y,e[2]=t.z,this.viewPosId.setValue(e)}renderForwardPrepareMaterials(t,e,s,i,n,a,r){const o=(t,e,s)=>{qd.drawCalls.push(t),qd.isNewMaterial.push(e),qd.lightMaskChanged.push(s)};qd.drawCalls.length=0,qd.isNewMaterial.length=0,qd.lightMaskChanged.length=0;const h=this.device,l=this.scene,c=a?a._lightHash:0;let d,u,p,m=null;for(let t=0;t<s;t++){const s=e[t];if(!n||!s.mask||n&s.mask)if(s.command)o(s,!1,!1);else{s.material||(s.material=Dh(h));const t=s.material,e=s._shaderDefs,n=s.mask;if(t&&t===m&&e!==d&&(m=null),(s.isStatic||u)&&(m=null),t!==m&&(this._materialSwitches++,t.dirty&&(t.updateUniforms(h,l),t.dirty=!1),!s._shader[r]||s._shaderDefs!==e||s._lightHash!==c)){if(s.isStatic)this.updateShader(s,e,s._staticLightList,r,i);else{const n=r+"_"+e+"_"+c;s._shader[r]=t.variants[n],s._shader[r]||(this.updateShader(s,e,null,r,i),t.variants[n]=s._shader[r])}s._shaderDefs=e,s._lightHash=c}o(s,t!==m,!m||n!==p),m=t,d=e,p=n,u=s.isStatic}}return qd}renderForward(t,e,s,i,n,a,r,o,h){const l=this.device,c=this.scene,d=1<<n,u=this.renderForwardPrepareMaterials(t,e,s,i,a,o,n),p=u.drawCalls.length;for(let e=0;e<p;e++){const s=u.drawCalls[e];if(s.command)s.command();else{const a=u.isNewMaterial[e],o=u.lightMaskChanged[e],m=s.material;s._shaderDefs;const f=s.mask;if(a){const e=s._shader[n];if(!e.failed&&l.setShader(e),m.setParameters(l),o){const e=this.dispatchDirectLights(i[0],c,f,t);this.dispatchLocalLights(i,c,f,e,s._staticLightList)}this.alphaTestId.setValue(m.alphaTest),l.setBlending(m.blend),m.blend&&(m.separateAlphaBlend?(l.setBlendFunctionSeparate(m.blendSrc,m.blendDst,m.blendSrcAlpha,m.blendDstAlpha),l.setBlendEquationSeparate(m.blendEquation,m.blendAlphaEquation)):(l.setBlendFunction(m.blendSrc,m.blendDst),l.setBlendEquation(m.blendEquation))),l.setColorWrite(m.redWrite,m.greenWrite,m.blueWrite,m.alphaWrite),l.setDepthWrite(m.depthWrite),m.depthWrite&&!m.depthTest?(l.setDepthFunc(7),l.setDepthTest(!0)):(l.setDepthFunc(m.depthFunc),l.setDepthTest(m.depthTest)),l.setAlphaToCoverage(m.alphaToCoverage),m.depthBias||m.slopeDepthBias?(l.setDepthBias(!0),l.setDepthBiasValues(m.depthBias,m.slopeDepthBias)):l.setDepthBias(!1)}this.setCullMode(t._cullFaces,h,s);const _=s.stencilFront||m.stencilFront,g=s.stencilBack||m.stencilBack;_||g?(l.setStencilTest(!0),_===g?(l.setStencilFunc(_.func,_.ref,_.readMask),l.setStencilOperation(_.fail,_.zfail,_.zpass,_.writeMask)):(_?(l.setStencilFuncFront(_.func,_.ref,_.readMask),l.setStencilOperationFront(_.fail,_.zfail,_.zpass,_.writeMask)):(l.setStencilFuncFront(7,0,255),l.setStencilOperationFront(0,0,0,255)),g?(l.setStencilFuncBack(g.func,g.ref,g.readMask),l.setStencilOperationBack(g.fail,g.zfail,g.zpass,g.writeMask)):(l.setStencilFuncBack(7,0,255),l.setStencilOperationBack(0,0,0,255)))):l.setStencilTest(!1);const y=s.mesh;s.setParameters(l,d),this.setVertexBuffers(l,y),this.setMorphing(l,s.morphInstance),this.setSkinning(l,s,m);const v=s.renderStyle;if(l.setIndexBuffer(y.indexBuffer[v]),r&&r(s,e),t.xr&&t.xr.session&&t.xr.views.length){const e=t.xr.views;for(let t=0;t<e.length;t++){const i=e[t];l.setViewport(i.viewport.x,i.viewport.y,i.viewport.z,i.viewport.w),this.projId.setValue(i.projMat.data),this.projSkyboxId.setValue(i.projMat.data),this.viewId.setValue(i.viewOffMat.data),this.viewInvId.setValue(i.viewInvOffMat.data),this.viewId3.setValue(i.viewMat3.data),this.viewProjId.setValue(i.projViewOffMat.data),this.viewPosId.setValue(i.position),0===t?this.drawInstance(l,s,y,v,!0):this.drawInstance2(l,s,y,v),this._forwardDrawCalls++}}else this.drawInstance(l,s,y,v,!0),this._forwardDrawCalls++;e<p-1&&!u.isNewMaterial[e+1]&&m.setParameters(l,s.parameters)}}qd.length=0}updateShaders(t,e){const s=t.length;for(let i=0;i<s;i++){const s=t[i].material;if(s&&!jd.has(s)&&(jd.add(s),s.updateShader!==Fh.prototype.updateShader)){if(e&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants(),s.shader=null}}jd.clear()}beginFrame(t,e){const s=t._meshInstances,i=this.scene;if(i.updateShaders||e){const t=!i.updateShaders&&e;this.updateShaders(s,t),i.updateShaders=!1,i._shaderVersion++}this.updateCpuSkinMatrices(s);const n=s.length;for(let t=0;t<n;t++)s[t].visibleThisFrame=!1;const a=t._lights,r=a.length;for(let t=0;t<r;t++)a[t].beginFrame()}updateLayerComposition(t,e){const s=t.layerList.length;for(let e=0;e<s;e++)t.layerList[e]._postRenderCounter=0;const i=this.scene,n=i._shaderVersion;for(let e=0;e<s;e++){const s=t.layerList[e];s._shaderVersion=n,s._preRenderCalledForCameras=0,s._postRenderCalledForCameras=0;const a=t.subLayerList[e];s._postRenderCounter|=a?2:1,s._postRenderCounterMax=s._postRenderCounter;for(let t=0;t<s.cameras.length;t++)s.instances.prepare(t);s._needsStaticPrepare&&s._staticLightHash&&!this.scene.clusteredLightingEnabled&&(s._staticPrepareDone&&(Td.revert(s.opaqueMeshInstances),Td.revert(s.transparentMeshInstances)),Td.prepare(this.device,i,s.opaqueMeshInstances,s._lights),Td.prepare(this.device,i,s.transparentMeshInstances,s._lights),t._dirty=!0,i.updateShaders=!0,s._needsStaticPrepare=!1,s._staticPrepareDone=!0)}return t._update(this.device,e)}gpuUpdate(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t)}setSceneConstants(){const t=this.scene;if(this.dispatchGlobalLights(t),"none"!==t.fog){if(this.fogColor[0]=t.fogColor.r,this.fogColor[1]=t.fogColor.g,this.fogColor[2]=t.fogColor.b,t.gammaCorrection)for(let t=0;t<3;t++)this.fogColor[t]=Math.pow(this.fogColor[t],2.2);this.fogColorId.setValue(this.fogColor),"linear"===t.fog?(this.fogStartId.setValue(t.fogStart),this.fogEndId.setValue(t.fogEnd)):this.fogDensityId.setValue(t.fogDensity)}const e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize)}updateLightStats(t,e){}cullShadowmaps(t){for(let e=0;e<t._lights.length;e++){const s=t._lights[e];if(0!==s._type&&s.visibleThisFrame&&s.castShadows&&0!==s.shadowUpdateMode){const i=t._lightCompositionData[e].shadowCastersList;this._shadowRenderer.cullLocal(s,i)}}const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.directionalLightsIndices.length;for(let e=0;e<n;e++){const s=i.directionalLightsIndices[e],n=t._lights[s],a=t._lightCompositionData[s].shadowCastersList;this._shadowRenderer.cullDirectional(n,a,i.camera.camera)}}}cullComposition(t){const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.layerIndex,a=t.layerList[n];if(!a.enabled||!t.subLayerEnabled[n])continue;const r=t.subLayerList[n],o=i.cameraIndex,h=a.cameras[o];if(h){h.frameUpdate(i.renderTarget),i.firstCameraUse&&(this.updateCameraFrustum(h.camera),this._camerasRendered++),this.cullLights(h.camera,a._lights);const t=a.instances,e=r?t.visibleTransparent[o]:t.visibleOpaque[o];if(!e.done){a.onPreCull&&a.onPreCull(o);const t=r?a.transparentMeshInstances:a.opaqueMeshInstances;e.length=this.cull(h.camera,t,e.list),e.done=!0,a.onPostCull&&a.onPostCull(o)}}}this.cullShadowmaps(t)}updateLightTextureAtlas(t){this.lightTextureAtlas.update(t._splitLights[2],t._splitLights[1],this.scene.lighting)}updateClusters(t){for(let e=0;e<t._worldClusters.length;e++){t._worldClusters[e].update(t._lights,this.scene.gammaCorrection,this.scene.lighting)}}buildFrameGraph(t,e){t.reset(),this.update(e);const s=this.scene.clusteredLightingEnabled;if(s){this.updateLightTextureAtlas(e);const s=new Md(null,(()=>{this.scene.lighting.cookiesEnabled&&(this.renderCookies(e._splitLights[2]),this.renderCookies(e._splitLights[1]))}));t.add(s)}const i=new Md(null,(()=>{(!s||s&&this.scene.lighting.shadowsEnabled)&&(this.renderShadows(e._splitLights[2]),this.renderShadows(e._splitLights[1])),s&&this.updateClusters(e)}));t.add(i);let n=0,a=!0,r=null;const o=e._renderActions;for(let s=n;s<o.length;s++){const i=o[s],h=e.layerList[i.layerIndex],l=h.cameras[i.cameraIndex],c=1===h.id&&(l.renderSceneColorMap||l.renderSceneDepthMap);if(i.hasDirectionalShadowLights&&l){const s=new Md(null,(()=>{this.renderPassDirectionalShadows(i,e)}));t.add(s)}a&&(a=!1,n=s,r=i.renderTarget);const d=o[s+1],u=!!d&&1===e.layerList[d.layerIndex].id&&(l.renderSceneColorMap||l.renderSceneDepthMap);if(!d||d.renderTarget!=r||d.hasDirectionalShadowLights||u||c){const o={start:n,end:s},h=new Md(r,(()=>{this.renderPassRenderActions(e,o)}));if(t.add(h),i.triggerPostprocess&&null!=l&&l.onPostprocessing){const s=new Md(null,(()=>{this.renderPassPostprocessing(i,e)}));t.add(s)}a=!0}}}update(t){const e=this.scene.clusteredLightingEnabled;this.clustersDebugRendered=!1,this.initViewBindGroupFormat(),this.scene._updateSkybox(this.device);const s=this.updateLayerComposition(t,e),i=0!=(2&s);this.updateLightStats(t,s),this.beginFrame(t,i),this.setSceneConstants(),this.cullComposition(t),this.gpuUpdate(t._meshInstances)}renderPassDirectionalShadows(t,e){const s=e.layerList[t.layerIndex].cameras[t.cameraIndex];this.renderShadows(t.directionalLights,s.camera)}renderPassPostprocessing(t,e){e.layerList[t.layerIndex].cameras[t.cameraIndex].onPostprocessing()}renderPassRenderActions(t,e){const s=t._renderActions;for(let i=e.start;i<=e.end;i++)this.renderRenderAction(t,s[i])}renderRenderAction(t,e){const s=this.scene.clusteredLightingEnabled,i=this.device,n=e.layerIndex,a=t.layerList[n],r=t.subLayerList[n],o=e.cameraIndex,h=a.cameras[o];if(a.enabled&&t.subLayerEnabled[n]){if(h&&e.firstCameraUse&&h.onPreRender&&h.onPreRender(),!r&&a.onPreRenderOpaque?a.onPreRenderOpaque(o):r&&a.onPreRenderTransparent&&a.onPreRenderTransparent(o),a._preRenderCalledForCameras&1<<o||(a.onPreRender&&a.onPreRender(o),a._preRenderCalledForCameras|=1<<o),h){var l;if(e.clearColor||e.clearDepth||e.clearStencil){const t=h.camera._clearColorBuffer,s=h.camera._clearDepthBuffer,i=h.camera._clearStencilBuffer;h.camera._clearColorBuffer=e.clearColor,h.camera._clearDepthBuffer=e.clearDepth,h.camera._clearStencilBuffer=e.clearStencil,this.clearView(h.camera,e.renderTarget,!0,!0),h.camera._clearColorBuffer=t,h.camera._clearDepthBuffer=s,h.camera._clearStencilBuffer=i}a._sortVisible(r,h.camera.node,o);const t=a.instances,n=r?t.visibleTransparent[o]:t.visibleOpaque[o];this.scene.immediate.onPreRenderLayer(a,n,r),this.scene._activeCamera=h.camera,this.setCamera(h.camera,e.renderTarget,!1,e),s&&e.lightClusters&&(e.lightClusters.activate(this.lightTextureAtlas),this.clustersDebugRendered||this.scene.lighting.debugLayer!==a.id||(this.clustersDebugRendered=!0));const c=!!(h.camera._flipFaces^(null==e||null==(l=e.renderTarget)?void 0:l.flipY)),d=this._forwardDrawCalls;this.renderForward(h.camera,n.list,n.length,a._splitLights,a.shaderPass,a.cullingMask,a.onDrawCall,a,c),a._forwardDrawCalls+=this._forwardDrawCalls-d,i.updateEnd(),i.setColorWrite(!0,!0,!0,!0),i.setStencilTest(!1),i.setAlphaToCoverage(!1),i.setDepthBias(!1),e.lastCameraUse&&h.onPostRender&&h.onPostRender()}!r&&a.onPostRenderOpaque?a.onPostRenderOpaque(o):r&&a.onPostRenderTransparent&&a.onPostRenderTransparent(o),!a.onPostRender||a._postRenderCalledForCameras&1<<o||(a._postRenderCounter&=~(r?2:1),0===a._postRenderCounter&&(a.onPostRender(o),a._postRenderCalledForCameras|=1<<o,a._postRenderCounter=a._postRenderCounterMax))}}}let Kd,$d,Zd,Qd;const Jd=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){return Kd=t._key[0],$d=e._key[0],Kd===$d&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:$d-Kd},function(t,e){return e.zdist-t.zdist},function(t,e){return t.zdist-e.zdist}];function tu(t,e){return e.key-t.key}let eu=0;class su{constructor(){this.list=[],this.length=0,this.done=!1}}class iu{constructor(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}prepare(t){this.visibleOpaque[t]||(this.visibleOpaque[t]=new su),this.visibleTransparent[t]||(this.visibleTransparent[t]=new su),this.visibleOpaque[t].done=!1,this.visibleTransparent[t].done=!1}delete(t){t<this.visibleOpaque.length&&this.visibleOpaque.splice(t,1),t<this.visibleTransparent.length&&this.visibleTransparent.splice(t,1)}}class nu{constructor(t={}){void 0!==t.id?(this.id=t.id,eu=Math.max(this.id+1,eu)):this.id=eu++,this.name=t.name,this._enabled=void 0===t.enabled||t.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=void 0===t.opaqueSortMode?2:t.opaqueSortMode,this.transparentSortMode=void 0===t.transparentSortMode?3:t.transparentSortMode,t.renderTarget&&(this.renderTarget=t.renderTarget),this.shaderPass=void 0===t.shaderPass?0:t.shaderPass,this.passThrough=void 0!==t.passThrough&&t.passThrough,this._clearColorBuffer=!!t.clearColorBuffer&&t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer&&t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer&&t.clearStencilBuffer,this.onPreCull=t.onPreCull,this.onPreRender=t.onPreRender,this.onPreRenderOpaque=t.onPreRenderOpaque,this.onPreRenderTransparent=t.onPreRenderTransparent,this.onPostCull=t.onPostCull,this.onPostRender=t.onPostRender,this.onPostRenderOpaque=t.onPostRenderOpaque,this.onPostRenderTransparent=t.onPostRenderTransparent,this.onDrawCall=t.onDrawCall,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=t.layerReference,this.instances=t.layerReference?t.layerReference.instances:new iu,this.cullingMask=t.cullingMask?t.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}set renderTarget(t){this._renderTarget=t,this._dirtyCameras=!0}get renderTarget(){return this._renderTarget}set enabled(t){t!==this._enabled&&(this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyCameras=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyCameras=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyCameras=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(t,e){const s=this._shaderVersion,i=this.shadowCasters;for(let n=0;n<t.length;n++){const a=t[n],r=a.material,o=3===r.blendType?this.opaqueMeshInstances:this.transparentMeshInstances;this.opaqueMeshInstances.indexOf(a)<0&&this.transparentMeshInstances.indexOf(a)<0&&o.push(a),!e&&a.castShadow&&i.indexOf(a)<0&&i.push(a),!this.passThrough&&s>=0&&r._shaderVersion!==s&&(r.updateShader!==Fh.prototype.updateShader&&(r.clearVariants(),r.shader=null),r._shaderVersion=s)}this.passThrough||(this._dirty=!0)}removeMeshInstanceFromArray(t,e){let s=-1,i=0;const n=e.length;for(let a=0;a<n;a++){const n=e[a];if(n===t){s=a,i=1;break}if(n._staticSource===t)s<0&&(s=a),i++;else if(s>=0)break}s>=0&&e.splice(s,i)}removeMeshInstances(t,e){const s=this.opaqueMeshInstances,i=this.transparentMeshInstances,n=this.shadowCasters;for(let a=0;a<t.length;a++){const r=t[a];if(this.removeMeshInstanceFromArray(r,s),this.removeMeshInstanceFromArray(r,i),!e){const t=n.indexOf(r);t>=0&&n.splice(t,1)}}this._dirty=!0}clearMeshInstances(t){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!t&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,t||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),0!==e.type&&this._clusteredLightsSet.add(e),this._lights.push(e),this._dirtyLights=!0,this._generateLightHash())}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),0!==e.type&&this._clusteredLightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this._dirtyLights=!0,this._generateLightHash())}clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0}addShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=t[s];i.castShadow&&(e.indexOf(i)<0&&e.push(i))}this._dirtyLights=!0}removeShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=e.indexOf(t[s]);i>=0&&e.splice(i,1)}this._dirtyLights=!0}_generateLightHash(){if(this._lights.length>0){this._lights.sort(tu);let t="",e="";for(let s=0;s<this._lights.length;s++)this._lights[s].isStatic?e+=this._lights[s].key:t+=this._lights[s].key;0===t.length?this._lightHash=0:this._lightHash=Gr(t),0===e.length?this._staticLightHash=0:this._staticLightHash=Gr(e)}else this._lightHash=0,this._staticLightHash=0}addCamera(t){this.cameras.indexOf(t)>=0||(this.cameras.push(t),this._dirtyCameras=!0)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this._dirtyCameras=!0,this.instances.delete(e))}clearCameras(){this.cameras.length=0,this._dirtyCameras=!0}_calculateSortDistances(t,e,s,i){for(let n=0;n<e;n++){const e=t[n];if(e.command)continue;if(e.layer<=2)continue;if(e.calculateSortDistance){e.zdist=e.calculateSortDistance(e,s,i);continue}const a=e.aabb.center,r=a.x-s.x,o=a.y-s.y,h=a.z-s.z;e.zdist=r*i.x+o*i.y+h*i.z}}_sortVisible(t,e,s){const i=this.instances,n=t?this.transparentSortMode:this.opaqueSortMode;if(0===n)return;const a=t?i.visibleTransparent[s]:i.visibleOpaque[s];5===n?(Zd=e.getPosition(),Qd=e.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,a.length,Zd,Qd),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback)):(3!==n&&4!==n||(Zd=e.getPosition(),Qd=e.forward,this._calculateSortDistances(a.list,a.length,Zd,Qd)),a.list.length!==a.length&&(a.list.length=a.length),a.list.sort(Jd[n]))}}const au=function(t,e){if(t.size!==e.size)return!1;for(const s of t)if(!e.has(s))return!1;return!0},ru=(t,e)=>t.priority-e.priority,ou=t=>t.sort(ru);class hu{constructor(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[],this.viewUniformBuffers=[],this.viewBindGroups=[]}destroy(){this.viewUniformBuffers.forEach((t=>t.destroy())),this.viewUniformBuffers.length=0,this.viewBindGroups.forEach((t=>t.destroy())),this.viewBindGroups.length=0}get hasDirectionalShadowLights(){return this.directionalLights.length>0}reset(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0}collectDirectionalLights(t,e,s){this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0;for(let i=0;i<e.length;i++){const n=e[i];if(n.castShadows)for(let e=0;e<t.length;e++)if(t[e]._splitLights[0].indexOf(n)>=0&&!this.directionalLightsSet.has(n)){this.directionalLightsSet.add(n),this.directionalLights.push(n);const t=s.indexOf(n);this.directionalLightsIndices.push(t)}}}}class lu{constructor(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}clearShadowCasters(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0}addShadowCasters(t){for(let e=0;e<t.length;e++){const s=t[e];this.shadowCastersSet.has(s)||(this.shadowCastersSet.add(s),this.shadowCastersList.push(s))}}}const cu=new Set,du=[];class uu extends _{constructor(t="Untitled"){super(),this.name=t,this.logRenderActions=!1,this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirty=!1,this._dirtyBlend=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._meshInstances=[],this._meshInstancesSet=new Set,this._lights=[],this._lightsMap=new Map,this._lightCompositionData=[],this._splitLights=[[],[],[]],this.cameras=[],this._renderActions=[],this._worldClusters=[],this._emptyWorldClusters=null}destroy(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach((t=>{t.destroy()})),this._worldClusters=null,this._renderActions.forEach((t=>t.destroy())),this._renderActions=null}getEmptyWorldClusters(t){return this._emptyWorldClusters||(this._emptyWorldClusters=new Xc(t),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1,null)),this._emptyWorldClusters}_splitLightsArray(t){const e=t._lights;t._splitLights[0].length=0,t._splitLights[1].length=0,t._splitLights[2].length=0;for(let s=0;s<e.length;s++){const i=e[s];i.enabled&&t._splitLights[i._type].push(i)}}_update(t,e=!1){const s=this.layerList.length;let i=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(let t=0;t<s;t++){const e=this.layerList[t];e._dirty&&(this._dirty=!0),e._dirtyLights&&(this._dirtyLights=!0),e._dirtyCameras&&(this._dirtyCameras=!0)}function n(t,e,s){let i=!1;const n=s.length;for(let a=0;a<n;a++){const n=s[a];if(!e.has(n)){e.add(n),t.push(n);const s=n.material;s&&s._dirtyBlend&&(i=!0,s._dirtyBlend=!1)}}return i}if(this._dirty){i|=1,this._meshInstances.length=0,this._meshInstancesSet.clear();for(let t=0;t<s;t++){const e=this.layerList[t];e.passThrough||(this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,e.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,e.transparentMeshInstances)||this._dirtyBlend),e._dirty=!1}this._dirty=!1}function a(t,e,s){for(let n=0;n<e.length;){var i;(null==(i=e[n].material)?void 0:i.transparent)===s?(t.push(e[n]),e[n]=e[e.length-1],e.length--):n++}}if(this._dirtyBlend){i|=8;for(let t=0;t<s;t++){const e=this.layerList[t];e.passThrough||(a(e.opaqueMeshInstances,e.transparentMeshInstances,!1),a(e.transparentMeshInstances,e.opaqueMeshInstances,!0))}this._dirtyBlend=!1}if(this._dirtyLights&&(i|=2,this._dirtyLights=!1,this.updateLights()),i&&this.updateShadowCasters(),this._dirtyCameras||2&i){this._dirtyCameras=!1,i|=4,this.cameras.length=0;for(let t=0;t<s;t++){const e=this.layerList[t];e._dirtyCameras=!1;for(let t=0;t<e.cameras.length;t++){const s=e.cameras[t];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&ou(this.cameras);const n=[];let a=0;for(let t=0;t<this.cameras.length;t++){const e=this.cameras[t];n.length=0;let i=!0;const r=a;let o=null,h=!1;for(let t=0;t<s;t++){const s=this.layerList[t];if(s&&s.cameras.length>0&&e.layers.indexOf(s.id)>=0){n.push(s),h||s.id!==e.disablePostEffectsLayer||(h=!0,o&&(o.triggerPostprocess=!0));const r=s.cameras.indexOf(e);r>=0&&(o=this.addRenderAction(this._renderActions,a,s,t,r,i,h),a++,i=!1)}}r<a&&(this._renderActions[r].collectDirectionalLights(n,this._splitLights[0],this._lights),o.lastCameraUse=!0),!h&&o&&(o.triggerPostprocess=!0),e.renderTarget&&e.postEffectsEnabled&&this.propagateRenderTarget(r-1,e)}for(let t=a;t<this._renderActions.length;t++)this._renderActions[t].destroy();this._renderActions.length=a,e&&this.allocateLightClusters(t)}return(2&i||4&i)&&this._logRenderActions(),i}updateShadowCasters(){const t=this._lights.length;for(let e=0;e<t;e++)this._lightCompositionData[e].clearShadowCasters();const e=this.layerList.length;for(let t=0;t<e;t++){const e=this.layerList[t];if(!cu.has(e)){cu.add(e);const t=e._lights;for(let s=0;s<t.length;s++)if(t[s].castShadows){const i=this._lightsMap.get(t[s]);this._lightCompositionData[i].addShadowCasters(e.shadowCasters)}}}cu.clear()}updateLights(){this._lights.length=0,this._lightsMap.clear();const t=this.layerList.length;for(let e=0;e<t;e++){const t=this.layerList[e];if(!cu.has(t)){cu.add(t);const e=t._lights;for(let t=0;t<e.length;t++){const s=e[t];let i=this._lightsMap.get(s);if(void 0===i){i=this._lights.length,this._lightsMap.set(s,i),this._lights.push(s);let t=this._lightCompositionData[i];t||(t=new lu,this._lightCompositionData[i]=t)}}}this._splitLightsArray(t),t._dirtyLights=!1}cu.clear(),this._splitLightsArray(this);const e=this._lights.length;this._lightCompositionData.length=e}findCompatibleCluster(t,e){for(let s=0;s<e;s++){const e=this._renderActions[s],i=this.layerList[e.layerIndex];if(t===i)return e.lightClusters;if(e.lightClusters&&au(t._clusteredLightsSet,i._clusteredLightsSet))return e.lightClusters}return null}allocateLightClusters(t){du.push(...this._worldClusters),this._worldClusters.length=0;const e=this._renderActions.length;for(let s=0;s<e;s++){const e=this._renderActions[s],i=this.layerList[e.layerIndex];if(i._clusteredLightsSet.size){if((this.subLayerList[e.layerIndex]?i.transparentMeshInstances:i.opaqueMeshInstances).length){let n=this.findCompatibleCluster(i,s);n||(du.length&&(n=du.pop()),n||(n=new Xc(t)),n.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(n)),e.lightClusters=n}}e.lightClusters||(e.lightClusters=this.getEmptyWorldClusters(t))}du.forEach((t=>{t.destroy()})),du.length=0}addRenderAction(t,e,s,i,n,a,r){let o=t[e];o||(o=t[e]=new hu);let h=s.renderTarget;const l=s.cameras[n];l&&l.renderTarget&&1!==s.id&&(h=l.renderTarget);let c=!1;for(let s=e-1;s>=0;s--)if(t[s].camera===l&&t[s].renderTarget===h){c=!0;break}const d=a||!c;let u=!!d&&l.clearColorBuffer,p=!!d&&l.clearDepthBuffer,m=!!d&&l.clearStencilBuffer;return u|=s.clearColorBuffer,p|=s.clearDepthBuffer,m|=s.clearStencilBuffer,r&&l.postEffectsEnabled&&(h=null),o.reset(),o.triggerPostprocess=!1,o.layerIndex=i,o.cameraIndex=n,o.camera=l,o.renderTarget=h,o.clearColor=u,o.clearDepth=p,o.clearStencil=m,o.firstCameraUse=a,o.lastCameraUse=!1,o}propagateRenderTarget(t,e){for(let s=t;s>=0;s--){const t=this._renderActions[s],i=this.layerList[t.layerIndex];if(t.renderTarget&&1!==i.id)break;if(1===i.id)continue;const n=null==t?void 0:t.camera.camera;if(n&&(!e.camera.rect.equals(n.rect)||!e.camera.scissorRect.equals(n.scissorRect)))break;t.renderTarget=e.renderTarget}}_logRenderActions(){}_isLayerAdded(t){return this.layerList.indexOf(t)>=0}_isSublayerAdded(t,e){for(let s=0;s<this.layerList.length;s++)if(this.layerList[s]===t&&this.subLayerList[s]===e)return!0;return!1}push(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insert(t,e){if(this._isLayerAdded(t))return;this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(e,s-1),this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}remove(t){let e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",t);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1)}pushOpaque(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertOpaque(t,e){if(this._isSublayerAdded(t,!1))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeOpaque(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&!this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}pushTransparent(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertTransparent(t,e){if(this._isSublayerAdded(t,!0))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeTransparent(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}_getSublayerIndex(t,e){let s=this.layerList.indexOf(t);if(s<0)return-1;if(this.subLayerList[s]!==e){if(s=this.layerList.indexOf(t,s+1),s<0)return-1;if(this.subLayerList[s]!==e)return-1}return s}getOpaqueIndex(t){return this._getSublayerIndex(t,!1)}getTransparentIndex(t){return this._getSublayerIndex(t,!0)}getLayerById(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].id===t)return this.layerList[e];return null}getLayerByName(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].name===t)return this.layerList[e];return null}_updateOpaqueOrder(t,e){for(let s=t;s<=e;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(t,e){for(let s=t;s<=e;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(t,e,s){let i=-1,n=-1;for(let e=0,n=t.length;e<n;e++){const n=t[e];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}for(let t=0,i=e.length;t<i;t++){const i=e[t];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)}sortOpaqueLayers(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)}}const pu=new at,mu=new at,fu=new at,_u={bias:0,normalBias:0},gu={r:0,g:1,b:2,a:3},yu=[[new ht(0,0,1,1)],[new ht(0,0,.5,.5),new ht(0,.5,.5,.5)],[new ht(0,0,.5,.5),new ht(0,.5,.5,.5),new ht(.5,0,.5,.5)],[new ht(0,0,.5,.5),new ht(0,.5,.5,.5),new ht(.5,0,.5,.5),new ht(.5,.5,.5,.5)]];let vu=0;class xu{constructor(t,e,s,i){this.light=i,this.camera=e,this.shadowCamera=Sd.createShadowCamera(t,i._shadowType,i._type,s),this.shadowMatrix=new mt,this.shadowViewport=new ht(0,0,1,1),this.shadowScissor=new ht(0,0,1,1),this.face=s,this.visibleCasters=[]}get shadowBuffer(){const t=this.shadowCamera.renderTarget;if(t){const e=this.light;return 1===e._type?t.colorBuffer:e._isPcf&&e.device.webgl2?t.depthBuffer:t.colorBuffer}return null}}class bu{constructor(t){this.device=t,this.id=vu++,this._type=0,this._color=new et(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=0,this._finalColor=new Float32Array([.8,.8,.8]);const e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]),this._position=new at(0,0,0),this._direction=new at(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowMap=null,this._shadowRenderParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=2,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0}destroy(){this._destroyShadowMap(),this._renderData=null}set numCascades(t){this.cascades&&this.numCascades==t||(this.cascades=yu[t-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get shadowMap(){return this._shadowMap}get numShadowFaces(){const t=this._type;return 0===t?this.numCascades:1===t?6:1}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get type(){return this._type}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set shadowType(t){if(this._shadowType===t)return;const e=this.device;1===this._type&&(t=0),4!==t||e.webgl2||(t=0),3!==t||e.textureFloatRenderable||(t=2),2!==t||e.textureHalfFloatRenderable||(t=1),this._isVsm=t>=1&&t<=3,this._isPcf=4===t||0===t,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get enabled(){return this._enabled}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this.mask&&0!==this.mask}set shadowResolution(t){this._shadowResolution!==t&&(t=1===this._type?Math.min(t,this.device.maxCubeMapSize):Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180))}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._outerConeAngleCos=Math.cos(t*Math.PI/180))}get outerConeAngle(){return this._outerConeAngle}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}get intensity(){return this._intensity}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new mt),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new ht(0,0,1,1)),this._atlasViewport}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let i=0;i<s;i++)t+=e}this._cookieChannel=t,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new ot,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new ht(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){this._renderData&&(this._renderData.length=0),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}getRenderData(t,e){for(let s=0;s<this._renderData.length;s++){const i=this._renderData[s];if(i.camera===t&&i.face===e)return i}const s=new xu(this.device,t,e,this);return this._renderData.push(s),s}clone(){const t=new bu(this.device);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.shape=this._shape,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case 1:_u.bias=this.shadowBias,_u.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?_u.bias=-2e-4:(_u.bias=20*this.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(_u.bias*=-100)),_u.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?_u.bias=-2e-4:(_u.bias=this.shadowBias/e*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(_u.bias*=-100)),_u.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias}return _u}getColor(){return this._color}getBoundingSphere(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=Math.cos(s*q.DEG_TO_RAD),n=this._node;pu.copy(n.up),pu.mulScalar(.5*-e*i),pu.add(n.getPosition()),t.center=pu,mu.copy(n.up),mu.mulScalar(-e),fu.copy(n.right),fu.mulScalar(Math.sin(s*q.DEG_TO_RAD)*e),mu.add(fu),t.radius=.5*mu.length()}else 1===this._type&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*q.DEG_TO_RAD)*e);t.center.set(0,.5*-e,0),t.halfExtents.set(n,.5*e,n),t.setFromTransformedAabb(t,i.getWorldTransform(),!0)}else 1===this._type&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateFinalColor(){const t=this._color,e=t.r,s=t.g,i=t.b,n=this._intensity,a=this._finalColor,r=this._linearFinalColor;a[0]=e*n,a[1]=s*n,a[2]=i*n,n>=1?(r[0]=Math.pow(e,2.2)*n,r[1]=Math.pow(s,2.2)*n,r[2]=Math.pow(i,2.2)*n):(r[0]=Math.pow(a[0],2.2),r[1]=Math.pow(a[1],2.2),r[2]=Math.pow(a[2],2.2))}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}updateShadow(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)}layersDirty(){var t;null!=(t=this._scene)&&t.layers&&(this._scene.layers._dirtyLights=!0)}updateKey(){let t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|gu[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8;3===this._cookieChannel.length&&(t|=gu[this._cookieChannel.charAt(1)]<<16,t|=gu[this._cookieChannel.charAt(2)]<<14),t!==this.key&&null!==this._scene&&this.layersDirty(),this.key=t}}class Su{constructor(t,e,s){this._maxTextureSize=e,this._supportsAreaLights=t,this._dirtyLightsFnc=s,this._areaLightsEnabled=!1,this._cells=new at(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this.debugLayer=void 0}set cells(t){this._cells.copy(t)}get cells(){return this._cells}set maxLightsPerCell(t){this._maxLightsPerCell=q.clamp(t,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(t){this._cookieAtlasResolution=q.clamp(t,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(t){this._shadowAtlasResolution=q.clamp(t,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(t){this._shadowType!==t&&(this._shadowType=t,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(t){this._cookiesEnabled!==t&&(this._cookiesEnabled=t,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(t){this._supportsAreaLights&&this._areaLightsEnabled!==t&&(this._areaLightsEnabled=t,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const wu=new Tt;class Tu{constructor(t,e){this.scene=t,this.light=e,this.store(),e.numCascades=1,0!==e.type&&(e._node.getWorldTransform(),e.getBoundingSphere(wu),this.lightBounds=new bt,this.lightBounds.center.copy(wu.center),this.lightBounds.halfExtents.set(wu.radius,wu.radius,wu.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const t=this.light;t.mask=this.mask,t.shadowUpdateMode=this.shadowUpdateMode,t.enabled=this.enabled,t.intensity=this.intensity,t._node.setLocalRotation(this.rotation),t.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap()}endBake(t){const e=this.light;e.enabled=!1,e.shadowMap&&(e.shadowMap.cached&&t.add(e,e.shadowMap),e.shadowMap=null)}}const Mu=new ot;class Cu extends Tu{get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(t,e){const s=this.light;if(s._node.setLocalRotation(this.rotation),t>0){const i=s.bakeArea;hh(Mu,t,e),Mu.mulScalar(.5*i),s._node.rotateLocal(Mu.x,0,Mu.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/e,1/i)}}class Au{constructor(t){this.renderPasses=[],this.device=t}add(t){this.renderPasses.push(t)}reset(){this.renderPasses.length=0}render(){const t=this.renderPasses;for(let e=0;e<t.length;e++){t[e].execute()}}}class Pu{constructor(t,e){this.texture0=t,this.texture1=e}destroy(){var t,e;null==(t=this.texture0)||t.destroy(),null==(e=this.texture1)||e.destroy()}}const Eu=new Xr;class Ru{static createTexture(t,e,s,i=""){return new Mo(t,{width:s,height:s,format:e,addressU:1,addressV:1,type:"default",magFilter:1,minFilter:0,anisotropy:1,name:`AreaLightLUT${i}`})}static applyTextures(t,e,s){Eu.remove(t),Eu.get(t,(()=>new Pu(e,e===s?null:s))),t.scope.resolve("areaLightsLutTex1").setValue(e),t.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(t){const e=Ru.createTexture(t,7,2,"placeholder");e.lock().fill(0),e.unlock(),Ru.applyTextures(t,e,e)}static set(t,e){function s(t,e,s){const i=Ru.createTexture(t,s,64);return i.lock().set(e),i.unlock(),i.upload(),i}function i(t,e,s){const i=t.length,n=new Float32Array(i);for(let a=0;a<i;a++){const i=a%4;n[a]=(t[a]+e[i])*s[i]}return n}function n(t){const e=t.length,s=new Uint16Array(e),i=So.float2Half;for(let n=0;n<e;n++)s[n]=i(t[n]);return s}function a(t){const e=t.length,s=new Uint8ClampedArray(e);for(let i=0;i<e;i++)s[i]=255*t[i];return s}const r=new Int16Array(e,0,2),o=r[0],h=r[1];if(0!==o||1!==h);else{const r=new Float32Array(e,4,16384),o=new Float32Array(e,65540,16384);let h,l;const c=t.areaLightLutFormat;if(14===c)h=r,l=o;else if(12===c)h=n(r),l=n(o);else{const t=[-.306897,0,0,0],e=[1.442787,1,1,1];h=a(i(r,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),l=a(i(o,t,e))}const d=s(t,h,c),u=s(t,l,c);Ru.applyTextures(t,d,u)}}}class Lu extends Yl{constructor(t,e){super(),this.device=e||$l().graphicsDevice,this._targets=t,this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=Lu.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=Lu.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=Lu.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=Lu.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_initTextureBased(){const t=[],e=[];for(let s=0;s<this._targets.length;s++){const i=this._targets[s];i.options.deltaPositions&&(t.push(i.options.deltaPositions),e.push({target:i,name:"texturePositions"})),i.options.deltaNormals&&(t.push(i.options.deltaNormals),e.push({target:i,name:"textureNormals"}))}const s=[],i=[];let n=1;const a=t[0].length;for(let e=0;e<a;e+=3){let a=!1;for(let s=0;s<t.length;s++){const i=t[s];if(0!==i[e]||0!==i[e+1]||0!==i[e+2]){a=!0;break}}a?(s.push(n+.2),i.push(e/3),n++):s.push(.2)}const r=Math.min(this.device.maxTextureSize,4096);let o=Math.ceil(Math.sqrt(n));o=Math.min(o,r);const h=Math.ceil(n/o);if(h>r)return!1;this.morphTextureWidth=o,this.morphTextureHeight=h;let l=!1,c=3;const d=So.float2Half;this._textureFormat===Lu.FORMAT_HALF_FLOAT&&(l=!0,c=4);const u=this.morphTextureWidth*this.morphTextureHeight*c,p=l?new Uint16Array(u):new Float32Array(u);for(let s=0;s<t.length;s++){const n=t[s];for(let t=0;t<i.length;t++){const e=i[t];l?(p[t*c+c]=d(n[3*e]),p[t*c+c+1]=d(n[3*e+1]),p[t*c+c+2]=d(n[3*e+2])):(p[t*c+c]=n[3*e],p[t*c+c+1]=n[3*e+1],p[t*c+c+2]=n[3*e+2])}const a=e[s].target,r=this._textureFormat===Lu.FORMAT_FLOAT?13:12;a._setTexture(e[s].name,this._createTexture("MorphTarget",r,p))}const m=[{semantic:"ATTR15",components:1,type:6}];return this.vertexBufferIds=new Wr(this.device,new Hr(this.device,m),s.length,0,new Float32Array(s)),!0}destroy(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_calculateAabb(){const t=new at,e=new at;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;t.min(i.getMin()),e.max(i.getMax())}this.aabb=new bt,this.aabb.setMinMax(t,e)}_createTexture(t,e,s){const i=new Mo(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t});return s&&(i.lock().set(s),i.unlock()),i}}Lu.FORMAT_FLOAT=0,Lu.FORMAT_HALF_FLOAT=1;class Iu{constructor(t){this.morph=t,t.incRefCount(),this.device=t.device,this.meshInstance=null,this._weights=[];for(let e=0;e<t._targets.length;e++)this.setWeight(e,t._targets[e].defaultWeight);if(this._activeTargets=[],t.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const e=(e,s)=>{const i=t._renderTextureFormat===Lu.FORMAT_FLOAT?14:12;return this[s]=t._createTexture(e,i),new al({colorBuffer:this[s],depth:!1})};t.morphPositions&&(this.rtPositions=e("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=e("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight,1/t.morphTextureWidth,1/t.morphTextureHeight]);for(let t=0;t<this.maxSubmitCount;t++)this["morphBlendTex"+t]=this.device.scope.resolve("morphBlendTex"+t);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.meshInstance=null,this.shader=null;const t=this.morph;t&&(this.morph=null,t.decRefCount(),t.refCount<1&&t.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new Iu(this.morph)}getWeight(t){return this._weights[t]}setWeight(t,e){this._weights[t]=e,this._dirty=!0}_getFragmentShader(t){let e="";t>0&&(e+="varying vec2 uv0;\nuniform highp float morphFactor["+t+"];\n");for(let s=0;s<t;s++)e+="uniform highp sampler2D morphBlendTex"+s+";\n";e+="void main (void) {\n\t\thighp vec4 color = vec4(0, 0, 0, 1);\n";for(let s=0;s<t;s++)e+="\t\tcolor.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+", uv0).xyz;\n";return e+="\t\tgl_FragColor = color;\n}\n",e}_getShader(t){let e=this.shaderCache[t];if(!e){const s=this._getFragmentShader(t);e=co(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}\n\t\t",s,"textureMorph"+t),this.shaderCache[t]=e}return e}_updateTextureRenderTarget(t,e){const s=this.device,i=(e,i)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlending(i),i&&(s.setBlendFunction(1,1),s.setBlendEquation(0));const n=this._getShader(e);Yr(s,t,n,void 0,void 0,i)};let n=0,a=!1;const r=this._activeTargets.length;for(let t=0;t<r;t++){const s=this._activeTargets[t],r=s.target[e];r&&(this["morphBlendTex"+n].setValue(r),this._shaderMorphWeights[n]=s.weight,n++,n>=this.maxSubmitCount&&(i(n,a),n=0,a=!0))}(n>0||0===r&&!this.zeroTextures)&&i(n,a)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)}_updateVertexMorph(){const t=this.maxSubmitCount;for(let e=0;e<t;e++)this._shaderMorphWeights[e]=0,this._activeVertexBuffers[e]=null;let e=0,s=this.morph.morphPositions?4:0;for(let t=0;t<this._activeTargets.length;t++){const i=this._activeTargets[t].target;i._vertexBufferPositions&&(this._activeVertexBuffers[e]=i._vertexBufferPositions,this._shaderMorphWeights[e]=this._activeTargets[t].weight,e++),i._vertexBufferNormals&&(this._activeVertexBuffers[s]=i._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[t].weight,s++)}}update(){this._dirty=!1;const t=this.morph._targets;let e=0;for(let s=0;s<t.length;s++){const i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=e&&(this._activeTargets[e]={});const n=this._activeTargets[e++];n.absWeight=i,n.weight=this.getWeight(s),n.target=t[s]}}this._activeTargets.length=e;const s=this.morph.maxActiveTargets;this._activeTargets.length>s&&(this._activeTargets.sort((function(t,e){return t.absWeight<e.absWeight?1:e.absWeight<t.absWeight?-1:0})),this._activeTargets.length=s),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class Du{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(t){this.graph=t}getCameras(){return this.cameras}setCameras(t){this.cameras=t}getLights(){return this.lights}setLights(t){this.lights=t}getMaterials(){const t=[];for(let e=0;e<this.meshInstances.length;e++){const s=this.meshInstances[e];-1===t.indexOf(s.material)&&t.push(s.material)}return t}clone(){const t=[],e=[],s=function s(i){const n=i.clone();t.push(i),e.push(n);for(let t=0;t<i._children.length;t++)n.addChild(s(i._children[t]));return n}(this.graph),i=[],n=[],a=[];for(let t=0;t<this.skinInstances.length;t++){const e=this.skinInstances[t].skin,i=new xc(e),a=[];for(let t=0;t<e.boneNames.length;t++){const i=e.boneNames[t],n=s.findByName(i);a.push(n)}i.bones=a,n.push(i)}for(let t=0;t<this.morphInstances.length;t++){const e=this.morphInstances[t].morph,s=new Iu(e);a.push(s)}for(let s=0;s<this.meshInstances.length;s++){const r=this.meshInstances[s],o=t.indexOf(r.node),h=new Ec(r.mesh,r.material,e[o]);if(r.skinInstance){const t=this.skinInstances.indexOf(r.skinInstance);h.skinInstance=n[t]}if(r.morphInstance){const t=this.morphInstances.indexOf(r.morphInstance);h.morphInstance=a[t]}i.push(h)}const r=new Du;return r.graph=s,r.meshInstances=i,r.skinInstances=n,r.morphInstances=a,r.getGraph().syncHierarchy(),r}destroy(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].destroy();this.meshInstances.length=0}generateWireframe(){Ec._prepareRenderStyleForArray(this.meshInstances,1)}}const Ou=new qo;Ou.worldTransform=mt.IDENTITY,Ou._dirtyWorld=Ou._dirtyNormal=!1;class Fu{constructor(t,e,s){this.material=e,this.layer=s,this.positions=[],this.colors=[],this.mesh=new ec(t),this.meshInstance=null}addLines(t,e){const s=this.positions,i=t.length;for(let e=0;e<i;e++){const i=t[e];s.push(i.x,i.y,i.z)}const n=this.colors;if(e.length)for(let t=0;t<i;t++){const s=e[t];n.push(s.r,s.g,s.b,s.a)}else for(let t=0;t<i;t++)n.push(e.r,e.g,e.b,e.a)}addLinesArrays(t,e){const s=this.positions;for(let e=0;e<t.length;e+=3)s.push(t[e],t[e+1],t[e+2]);const i=this.colors;if(e.length)for(let t=0;t<e.length;t+=4)i.push(e[t],e[t+1],e[t+2],e[t+3]);else{const s=t.length/3;for(let t=0;t<s;t++)i.push(e.r,e.g,e.b,e.a)}}onPreRender(t,e){this.positions.length>0&&this.material.transparent===e&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new Ec(this.mesh,this.material,Ou)),this.positions.length=0,this.colors.length=0,t.list.push(this.meshInstance),t.length++)}}class ku{constructor(t){this.device=t,this.map=new Map}getBatch(t,e){let s=this.map.get(t);return s||(s=new Fu(this.device,t,e),this.map.set(t,s)),s}onPreRender(t,e){this.map.forEach((s=>{s.onPreRender(t,e)}))}}const Bu=[];class zu{constructor(t){this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(t){const e=new _c;return e.vertexColors=!0,e.blend=!0,e.blendType=2,e.depthTest=t,e.update(),e}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(t,e){let s=this.batchesMap.get(t);s||(s=new ku(this.device),this.batchesMap.set(t,s)),this.allBatches.add(s);const i=e?this.materialDepth:this.materialNoDepth;return s.getBatch(i,t)}static getTextureVS(){return"\n\t\t\t\t\t\tattribute vec2 aPosition;\n\t\t\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\t\t\tgl_Position = matrix_model * vec4(aPosition, 0, 1);\n\t\t\t\t\t\t\t\tuv0 = aPosition.xy + 0.5;\n\t\t\t\t\t\t}\n\t\t\t\t"}getTextureShader(){if(!this.textureShader){const t={attributes:{aPosition:"POSITION"},vshader:zu.getTextureVS(),fshader:"\n\t\t\t\t\t\t\t\t\t\tprecision lowp float;\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tuniform sampler2D colorMap;\n\t\t\t\t\t\t\t\t\t\tvoid main (void) {\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t"};this.textureShader=new $r(this.device,t)}return this.textureShader}getDepthTextureShader(){if(!this.depthTextureShader){const t=this.device.webgl2?"#define GL2":"",e={attributes:{aPosition:"POSITION"},vshader:zu.getTextureVS(),fshader:`\n\t\t\t\t\t\t\t\t\t\tprecision ${this.device.precision} float;\n\t\t\t\t\t\t\t\t\t\t${t}\n\t\t\t\t\t\t\t\t\t\t${Zr.screenDepthPS}\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\t\t\t\t\t\t\t\tfloat depth = getLinearScreenDepth(uv0) * camera_params.x;\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(vec3(depth), 1.0);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t`};this.depthTextureShader=new $r(this.device,e)}return this.depthTextureShader}getQuadMesh(){return this.quadMesh||(this.quadMesh=new ec(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(t,e,s,i,n){if(!i){const n=this.getGraphNode(e);i=new Ec(s,t,n)}let a=this.layerMeshInstances.get(n);a||(a=[],this.layerMeshInstances.set(n,a)),a.push(i)}drawWireAlignedBox(t,e,s,i,n){Bu.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z);this.getBatch(n,i).addLinesArrays(Bu,s),Bu.length=0}drawWireSphere(t,e,s,i,n,a){const r=2*Math.PI/i;let o=0;for(let s=0;s<i;s++){const s=Math.sin(o),i=Math.cos(o);o+=r;const n=Math.sin(o),a=Math.cos(o);Bu.push(t.x+e*s,t.y,t.z+e*i),Bu.push(t.x+e*n,t.y,t.z+e*a),Bu.push(t.x+e*s,t.y+e*i,t.z),Bu.push(t.x+e*n,t.y+e*a,t.z),Bu.push(t.x,t.y+e*s,t.z+e*i),Bu.push(t.x,t.y+e*n,t.z+e*a)}this.getBatch(a,n).addLinesArrays(Bu,s),Bu.length=0}getGraphNode(t){const e=new qo;return e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e}onPreRenderLayer(t,e,s){if(this.batchesMap.forEach(((i,n)=>{n===t&&i.onPreRender(e,s)})),!this.updatedLayers.has(t)){this.updatedLayers.add(t);const s=this.layerMeshInstances.get(t);if(s){for(let t=0;t<s.length;t++)e.list[e.length+t]=s[t];e.length+=s.length,s.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}class Uu extends _{constructor(t){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new et(0,0,0),this.exposure=1,this.fogColor=new et(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.root=null,this.device=t||$l().graphicsDevice,this._gravity=new at(0,-9.8,0),this._layers=null,this._fog="none",this._gammaCorrection=1,this._toneMapping=0,this._skyboxCubeMap=null,this._prefilteredCubemaps=[null,null,null,null,null,null],this._envAtlas=null,this._internalEnvAtlas=null,this.skyboxModel=null,this._skyboxIntensity=1,this._skyboxMip=0,this._skyboxRotation=new ft,this._skyboxRotationMat3=null,this._skyboxRotationMat4=null,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!1,this._lightingParams=new Su(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this._layers._dirtyLights=!0})),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this._models=[],this.immediate=new zu(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=q.clamp(Math.floor(t),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=q.clamp(t,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(t){!this._clusteredLightingEnabled||t?this._clusteredLightingEnabled=t:console.error("Turning off enabled clustered lighting is not currently supported")}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set drawCalls(t){}get drawCalls(){let t=this.layers._meshInstances;return t.length||(this.layers._update(this.device,this.clusteredLightingEnabled),t=this.layers._meshInstances),t}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,this.updateShaders=!0)}get envAtlas(){return this._envAtlas}set fog(t){t!==this._fog&&(this._fog=t,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(t){t!==this._gammaCorrection&&(this._gammaCorrection=t,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}get layers(){return this._layers}get lighting(){return this._lightingParams}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=t[n]||null;e[n]!==a&&(e[n]=a,s=!0),i=i&&!!e[n]}s&&(this._resetSkyboxModel(),i?(this._internalEnvAtlas=Lh.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas||(this.envAtlas=this._internalEnvAtlas)):this._internalEnvAtlas&&(this._envAtlas===this._internalEnvAtlas&&(this.envAtlas=null),this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null))}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSkyboxModel())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSkyboxModel())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSkyboxModel())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(t){this._skyboxRotation.equals(t)||(this._skyboxRotation.copy(t),this._resetSkyboxModel())}get skyboxRotation(){return this._skyboxRotation}set toneMapping(t){t!==this._toneMapping&&(this._toneMapping=t,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSkyboxModel(),this.root=null,this.off()}drawLine(t,e,s=et.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([t,e],[s,s])}drawLines(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(t,e)}drawLineArrays(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(t,e)}applySettings(t){const e=t.physics,s=t.render;this._gravity.set(e.gravity[0],e.gravity[1],e.gravity[2]),this.ambientLight.set(s.global_ambient[0],s.global_ambient[1],s.global_ambient[2]),this._fog=s.fog,this.fogColor.set(s.fog_color[0],s.fog_color[1],s.fog_color[2]),this.fogStart=s.fog_start,this.fogEnd=s.fog_end,this.fogDensity=s.fog_density,this._gammaCorrection=s.gamma_correction,this._toneMapping=s.tonemapping,this.lightmapSizeMultiplier=s.lightmapSizeMultiplier,this.lightmapMaxResolution=s.lightmapMaxResolution,this.lightmapMode=s.lightmapMode,this.exposure=s.exposure,this._skyboxIntensity=void 0===s.skyboxIntensity?1:s.skyboxIntensity,this._skyboxMip=void 0===s.skyboxMip?0:s.skyboxMip,s.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(s.skyboxRotation[0],s.skyboxRotation[1],s.skyboxRotation[2]),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((t=>{s.hasOwnProperty(t)&&(this[t]=s[t])})),this._resetSkyboxModel()}_getSkyboxTex(){const t=this._prefilteredCubemaps;if(this._skyboxMip){return t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap}return this._skyboxCubeMap||t[0]||this._envAtlas}_updateSkybox(t){if(this.skyboxModel)return;const e=this._getSkyboxTex();if(!e)return;const s=new Fh,i=this;s.updateShader=function(s,n,a,r,o){const h=t.getProgramLibrary();e.cubemap?this.shader=h.getProgram("skybox",{type:"cubemap",rgbm:"rgbm"===e.type,hdr:"rgbm"===e.type||14===e.format,useIntensity:1!==i.skyboxIntensity,mip:e.fixCubemapSeams?i.skyboxMip:0,fixSeams:e.fixCubemapSeams,gamma:1===o?i.gammaCorrection?3:0:i.gammaCorrection,toneMapping:1===o?0:i.toneMapping}):this.shader=h.getProgram("skybox",{type:"envAtlas",encoding:e.encoding,useIntensity:1!==i.skyboxIntensity,gamma:1===o?i.gammaCorrection?3:0:i.gammaCorrection,toneMapping:1===o?0:i.toneMapping})},s.updateShader(),e.cubemap?s.setParameter("texture_cubeMap",e):(s.setParameter("texture_envAtlas",e),s.setParameter("mipLevel",this._skyboxMip)),this.skyboxRotation.equals(ft.IDENTITY)?s.setParameter("cubeMapRotationMatrix",rt.IDENTITY.data):(this._skyboxRotationMat4||(this._skyboxRotationMat4=new mt),this._skyboxRotationMat3||(this._skyboxRotationMat3=new rt),this._skyboxRotationMat4.setTRS(at.ZERO,this._skyboxRotation,at.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3),s.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data)),s.cull=2,s.depthWrite=!1;const n=this.layers.getLayerById(2);if(n){const i=new qo("Skybox"),a=mc(t),r=new Ec(a,s,i);r.cull=!1,r._noDepthDrawGl1=!0,r.pick=!1;const o=new Du;o.graph=i,o.meshInstances=[r],this.skyboxModel=o,n.addMeshInstances(o.meshInstances),this.skyLayer=n,this.fire("set:skybox",e)}}_resetSkyboxModel(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.prefilteredCubemaps=[null,null,null,null,null,null])}addModel(t){if(this.containsModel(t))return;const e=this.layers.getLayerById(0);e&&(e.addMeshInstances(t.meshInstances),this._models.push(t))}addShadowCaster(t){const e=this.layers.getLayerById(0);e&&e.addShadowCasters(t.meshInstances)}removeModel(t){const e=this._models.indexOf(t);if(-1!==e){const s=this.layers.getLayerById(0);if(!s)return;s.removeMeshInstances(t.meshInstances),this._models.splice(e,1)}}removeShadowCasters(t){const e=this.layers.getLayerById(0);e&&e.removeShadowCasters(t.meshInstances)}containsModel(t){return this._models.indexOf(t)>=0}getModels(t){return this._models}}class Vu{constructor(t){this._blobUrls={};for(let e=0,s=t.length;e<s;e++)t[e].url&&(this._blobUrls[t[e].name]=t[e].url)}hasBlobUrl(t){return!!this._blobUrls[t]}getBlobUrl(t){return this._blobUrls[t]}destroy(){for(const t in this._blobUrls)URL.revokeObjectURL(this._blobUrls[t]);this._blobUrls=null}}let Nu;function Wu(t){let e,s;if("undefined"!=typeof TextDecoder)try{e=new TextDecoder("utf-8"),s=new TextDecoder("windows-1252")}catch(t){console.warn("TextDecoder not supported - pc.Untar module will not work")}else console.warn("TextDecoder not supported - pc.Untar module will not work");function i(t){this._fields=t}function n(t){this._arrayBuffer=t||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}i.parse=function(t,s,n){const a=new Uint8Array(t,s,n);let r=0;const o=[];for(;r<n;){let i;for(i=r;i<n&&32!==a[i];i++);if(i>=n)throw new Error("Invalid PAX header data format.");const h=parseInt(e.decode(new Uint8Array(t,s+r,i-r)),10),l=e.decode(new Uint8Array(t,s+i+1,h-(i-r)-2)).split("=");if(2!==l.length)throw new Error("Invalid PAX header data format.");0===l[1].length&&(l[1]=null),o.push({name:l[0],value:l[1]}),r+=h}return new i(o)},i.prototype.applyHeader=function(t){for(let e=0;e<this._fields.length;e++){let s=this._fields[e].name;const i=this._fields[e].value;"path"===s&&(s="name"),null===i?delete t[s]:t[s]=i}},t||(Nu=n),n.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},n.prototype._readNextFile=function(){const e=new DataView(this._arrayBuffer,this._bytesRead,512),n=s.decode(e);this._bytesRead+=512;let a=n.substring(0,100).replace(/\0/g,"");const r=n.substring(257,263),o=parseInt(n.substring(124,136),8),h=n.substring(156,157),l=this._bytesRead;let c=null,d=!1;switch(h){case"0":case"":if(d=!0,!t){const t=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+o)]);c=URL.createObjectURL(t)}break;case"g":this._globalPaxHeader=i.parse(this._arrayBuffer,this._bytesRead,o);break;case"x":this._paxHeader=i.parse(this._arrayBuffer,this._bytesRead,o)}this._bytesRead+=o;const u=o%512;if(0!==u&&(this._bytesRead+=512-u),!d)return null;if(-1!==r.indexOf("ustar")){const t=n.substring(345,500).replace(/\0/g,"");t.length>0&&(a=t.trim()+a.trim())}const p={name:a,start:l,size:o,url:c};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(p),this._paxHeader&&(this._paxHeader.applyHeader(p),this._paxHeader=null),p},n.prototype.untar=function(t){if(!e)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];const s=[];for(;this._hasNext();){const e=this._readNextFile();e&&(t&&e.name&&(e.name=t+e.name),s.push(e))}return s},t&&(self.onmessage=function(t){const e=t.data.id;try{const s=new n(t.data.arrayBuffer).untar(t.data.prefix);postMessage({id:e,files:s,arrayBuffer:t.data.arrayBuffer},[t.data.arrayBuffer])}catch(t){postMessage({id:e,error:t.toString()})}})}let Gu=null;class Hu{constructor(t){this._requestId=0,this._pendingRequests={},this._filenamePrefix=t,this._worker=new Worker(function(){if(!Gu){const t="("+Wu.toString()+")(true)\n\n",e=new Blob([t],{type:"application/javascript"});Gu=URL.createObjectURL(e)}return Gu}()),this._worker.addEventListener("message",this._onMessage.bind(this))}_onMessage(t){const e=t.data.id;if(!this._pendingRequests[e])return;const s=this._pendingRequests[e];if(delete this._pendingRequests[e],t.data.error)s(t.data.error);else{const e=t.data.arrayBuffer;for(let s=0,i=t.data.files.length;s<i;s++){const i=t.data.files[s],n=new Blob([e.slice(i.start,i.start+i.size)]);i.url=URL.createObjectURL(n)}s(null,t.data.files)}}untar(t,e){const s=this._requestId++;this._pendingRequests[s]=e,this._worker.postMessage({id:s,prefix:this._filenamePrefix,arrayBuffer:t},[t])}hasPendingRequests(){return Object.keys(this._pendingRequests).length>0}destroy(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)}}Wu();class Xu{constructor(t){this.handlerType="bundle",this._assets=t.assets,this._worker=null,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this;Y.get(t.load,{responseType:j.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(i,n){if(i)e("Error loading bundle resource "+t.original+": "+i);else try{s._untar(n,e)}catch(s){e("Error loading bundle resource "+t.original+": "+s)}}))}_untar(t,e){const s=this;if(L.workers)s._worker||(s._worker=new Hu(s._assets.prefix)),s._worker.untar(t,(function(t,i){e(t,i),s._worker.hasPendingRequests()||(s._worker.destroy(),s._worker=null)}));else{const i=new Nu(t).untar(s._assets.prefix);e(null,i)}}open(t,e){return new Vu(e)}patch(t,e){}}class qu{constructor(t){this._handlers={},this._requests={},this._cache={},this._app=t}addHandler(t,e){this._handlers[t]=e,e._loader=this}removeHandler(t){delete this._handlers[t]}getHandler(t){return this._handlers[t]}load(t,e,s,i){const n=this._handlers[e];if(!n){return void s(`No handler for asset type: '${e}' when loading [${t}]`)}if(!t)return void this._loadNull(n,s,i);const a=t+e;if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const e=this,r=function(t,s){t?e._onFailure(a,t):n.load(s,(function(t,r,o){if(e._requests[a])if(t)e._onFailure(a,t);else try{e._onSuccess(a,n.open(s.original,r,i),o)}catch(t){e._onFailure(a,t)}}),i)},o=t.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(o)){if(!this._app.bundles.canLoadUrl(o))return void r(`Bundle for ${t} not loaded yet`);this._app.bundles.loadUrl(o,(function(t,e){r(t,{load:e,original:o})}))}else r(null,{load:t,original:i&&i.file.filename||t})}}_loadNull(t,e,s){t.load(null,(function(i,n,a){if(i)e(i);else try{e(null,t.open(null,n,s),a)}catch(t){e(t)}}),s)}_onSuccess(t,e,s){this._cache[t]=e;for(let i=0;i<this._requests[t].length;i++)this._requests[t][i](null,e,s);delete this._requests[t]}_onFailure(t,e){if(console.error(e),this._requests[t]){for(let s=0;s<this._requests[t].length;s++)this._requests[t][s](e);delete this._requests[t]}}open(t,e){const s=this._handlers[t];return s?s.open(null,e):(console.warn("No resource handler found for: "+t),e)}patch(t,e){const s=this._handlers[t.type];s?s.patch&&s.patch(t,e):console.warn("No resource handler found for: "+t.type)}clearCache(t,e){delete this._cache[t+e]}getFromCache(t,e){if(this._cache[t+e])return this._cache[t+e]}enableRetry(t=5){t=Math.max(0,t)||0;for(const e in this._handlers)this._handlers[e].maxRetries=t}disableRetry(){for(const t in this._handlers)this._handlers[t].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}const ju={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Yu={};function Ku(t,e){for(let s=0,i=t.length;s<i;s++)Yu[t[s]]=e}function $u(t){const e=t.indexOf("-");return-1!==e?t.substring(0,e):t}function Zu(t,e){if(e[t])return t;let s=ju[t];if(s&&e[s])return s;const i=$u(t);return s=ju[i],e[s]?s:e[i]?i:"en-US"}Ku(["ja","ko","th","vi","zh","id"],(function(t){return 0})),Ku(["fa","hi"],(function(t){return t>=0&&t<=1?0:1})),Ku(["fr","pt"],(function(t){return t>=0&&t<2?0:1})),Ku(["da"],(function(t){return 1===t||!Number.isInteger(t)&&t>=0&&t<=1?0:1})),Ku(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(function(t){return 1===t?0:1})),Ku(["ru","uk"],(function(t){if(Number.isInteger(t)){const e=t%10,s=t%100;if(1===e&&11!==s)return 0;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(0===e||e>=5&&e<=9||s>=11&&s<=14)return 2}return 3})),Ku(["pl"],(function(t){if(Number.isInteger(t)){if(1===t)return 0;const e=t%10,s=t%100;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||s>=12&&s<=14)return 2}return 3})),Ku(["ar"],(function(t){if(0===t)return 0;if(1===t)return 1;if(2===t)return 2;if(Number.isInteger(t)){const e=t%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5}));const Qu=Yu[$u("en-US")];function Ju(t){return Yu[t]||Qu}const tp=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i"),ep="animation",sp="audio",ip="image",np="json",ap="model",rp="material",op="text",hp="texture",lp="cubemap",cp="shader",dp="css",up="html",pp="script",mp="container";class fp{constructor(t,e,s,i,n,a){this.url=t||"",this.filename=e||"",this.hash=void 0===s?null:s,this.size=void 0===i?null:i,this.opt=void 0===n?null:n,this.contents=a||null}equals(t){return this.url===t.url&&this.filename===t.filename&&this.hash===t.hash&&this.size===t.size&&this.opt===t.opt&&this.contents===t.contents}}let _p=-1;const gp={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},yp=["pvr","dxt","etc2","etc1","basis"];class vp extends _{constructor(t,e,s,i,n){super(),this._id=_p--,this.name=t||"",this.type=e,this.tags=new U(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(t){this._id=t}get id(){return this._id}set file(t){if(t&&t.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var e,s;const i=(null==(e=this.registry)||null==(s=e._loader)?void 0:s._app)||$l(),n=null==i?void 0:i.graphicsDevice;if(n)for(let e=0,s=yp.length;e<s;e++){const s=yp[e];if(t.variants[s]&&n[gp[s]]){t=t.variants[s];break}if(i.enableBundles){const t=i.bundles.listBundlesForAsset(this);if(t&&t.find((t=>{var e;return null==t||null==(e=t.file)?void 0:e.variants[s]})))break}}}const i=this._file,n=t?new fp(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!n!=!!i||n&&!n.equals(i))&&(this._file=n,this.fire("change",this,"file",n,i),this.reload())}get file(){return this._file}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resource(){return this._resources[0]}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get resources(){return this._resources}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;if(this.registry&&this.registry.prefix&&!tp.test(e)&&(e=this.registry.prefix+e),"script"!==this.type&&t.hash){const s=-1!==e.indexOf("?")?"&":"?";e+=s+"t="+t.hash}return e}getAbsoluteUrl(t){if(t.startsWith("blob:")||t.startsWith("data:"))return t;const e=v.getDirectory(this.file.url);return v.join(e,t)}getLocalizedAssetId(t){return t=Zu(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.resource?t.call(e,this):this.once("load",(function(s){t.call(e,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const t=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e){const s=t[e];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(t,e,s,i=0){var n;null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{e(null,s.file.contents)})):Y.get(t,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},e)}}class xp{constructor(t=null){this._index={},this._key=t}addItem(t){const e=t.tags._list;for(const s of e)this.add(s,t)}removeItem(t){const e=t.tags._list;for(const s of e)this.remove(s,t)}add(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))}remove(t,e){if(!this._index[t])return;if(this._key&&!this._index[t].keys[e[this._key]])return;const s=this._index[t].list.indexOf(e);-1!==s&&(this._index[t].list.splice(s,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}find(t){const e={},s=[];let i,n,a,r,o;const h=(t,e)=>this._index[t].list.length-this._index[e].list.length;for(let l=0;l<t.length;l++){if(n=t[l],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let t=0;t<n.length;t++)if(!this._index[n[t]]){o=!0;break}if(o)continue;a=n.slice(0).sort(h),r=a.slice(1),1===r.length&&(r=r[0]);for(let t=0;t<this._index[a[0]].list.length;t++)i=this._index[a[0]].list[t],(this._key?!e[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(r)&&(this._key&&(e[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let t=0;t<this._index[n].list.length;t++)i=this._index[n].list[t],this._key?e[i[this._key]]||(e[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class bp{constructor(t){this.handlerType="script",this._app=t,this._scripts={},this._cache={}}static _push(t){Tp.legacy&&bp._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):bp._types.push(t)}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this;Tp.app=this._app,this._loadScript(t.load,((t,i,n)=>{if(t)e(t);else if(Tp.legacy){let t=null;bp._types.length&&(t=bp._types.pop()),t?this._scripts[i]=t:t=null,e(null,t,n)}else{const t={};for(let e=0;e<bp._types.length;e++)t[bp._types[e].name]=bp._types[e];bp._types.length=0,e(null,t,n),delete s._loader._cache[i+"script"]}}))}open(t,e){return e}patch(t,e){}_loadScript(t,e){const s=document.head,i=document.createElement("script");this._cache[t]=i,i.async=!1,i.addEventListener("error",(function(t){e(`Script: ${t.target.src} failed to load`)}),!1);let n=!1;i.onload=i.onreadystatechange=function(){n||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(n=!0,e(null,t,i))},i.src=t,s.appendChild(i)}}bp._types=[];let Sp=!1,wp=!1;const Tp={app:null,create:function(t,e){if(!Sp)return;const s=e(Tp.app);s._pcScriptName=t,bp._push(s),this.fire("created",t,e)},attribute:function(t,e,s,i){},createLoadingScreen:function(t){if(wp)return;wp=!0;t($l())}};Object.defineProperty(Tp,"legacy",{get:function(){return Sp},set:function(t){Sp=t}}),g.attach(Tp);class Mp extends _{constructor(t){super(),this._loader=t,this._assets=[],this._cache={},this._names={},this._tags=new xp("_id"),this._urls={},this.prefix=null}list(t){return t=t||{},this._assets.filter((e=>{let s=!0;return void 0!==t.preload&&(s=e.preload===t.preload),s}))}add(t){const e=this._assets.push(t)-1;let s;this._cache[t.id]=e,this._names[t.name]||(this._names[t.name]=[]),this._names[t.name].push(e),t.file&&(s=t.file.url,this._urls[s]=e),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire("add:"+t.id,t),s&&this.fire("add:url:"+s,t),t.preload&&this.load(t)}remove(t){const e=this._cache[t.id],s=t.file?t.file.url:null;if(void 0!==e){this._assets.splice(e,1),delete this._cache[t.id],this._names={},this._urls=[];for(let t=0,e=this._assets.length;t<e;t++){const e=this._assets[t];this._cache[e.id]=t,this._names[e.name]||(this._names[e.name]=[]),this._names[e.name].push(t),e.file&&(this._urls[e.file.url]=t)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire("remove:"+t.id,t),s&&this.fire("remove:url:"+s,t),!0}return!1}get(t){const e=this._cache[t];return this._assets[e]}getByUrl(t){const e=this._urls[t];return this._assets[e]}load(t){if(t.loading||t.loaded)return;const e=t.file,s=s=>{s instanceof Array?t.resources=s:t.resource=s,this._loader.patch(t,this),this.fire("load",t),this.fire("load:"+t.id,t),e&&e.url&&this.fire("load:url:"+e.url,t),t.fire("load",t)},i=(e,i,n)=>{if(t.loaded=!0,t.loading=!1,e)this.fire("error",e,t),this.fire("error:"+t.id,e,t),t.fire("error",e,t);else{if(!Tp.legacy&&"script"===t.type){const e=this._loader.getHandler("script");e._cache[t.id]&&e._cache[t.id].parentNode===document.head&&document.head.removeChild(e._cache[t.id]),e._cache[t.id]=n}s(i)}};if(e||"cubemap"===t.type)this.fire("load:start",t),this.fire("load:"+t.id+":start",t),t.loading=!0,this._loader.load(t.getFileUrl(),t.type,i,t);else{const e=this._loader.open(t.type,t.data);t.loaded=!0,s(e)}}loadFromUrl(t,e,s){this.loadFromUrlAndFilename(t,null,e,s)}loadFromUrlAndFilename(t,e,s,i){const n=v.getBasename(e||t),a={filename:e||n,url:t};let r=this.getByUrl(t);if(r){if(r.loaded)return void i(r.loadFromUrlError||null,r)}else r=new vp(n,s,a),this.add(r);const o=t=>{t.once("load",(t=>{"material"===s?this._loadTextures(t,((e,s)=>{i(e,t)})):i(null,t)})),t.once("error",(e=>{e&&(this.loadFromUrlError=e),i(e,t)})),this.load(t)};r.resource?i(null,r):"model"===s?this._loadModel(r,o):o(r)}_loadModel(t,e){const s=t.getFileUrl(),i=v.getExtension(s);if(".json"===i||".glb"===i){const n=v.getDirectory(s),a=v.getBasename(s),r=v.join(n,a.replace(i,".mapping.json"));this._loader.load(r,"json",((s,i)=>{s?(t.data={mapping:[]},e(t)):this._loadMaterials(t,i,((s,n)=>{t.data=i,e(t)}))}))}else e(t)}_loadMaterials(t,e,s){const i=[];let n=0;const a=(t,e)=>{this._loadTextures(e,((t,a)=>{i.push(e),i.length===n&&s(null,i)}))};for(let s=0;s<e.mapping.length;s++){const i=e.mapping[s].path;if(i){n++;const e=t.getAbsoluteUrl(i);this.loadFromUrl(e,"material",a)}}0===n&&s(null,i)}_loadTextures(t,e){const s=[];let i=0;const n=t.data;if("path"!==n.mappingFormat)return void e(null,s);const a=(t,n)=>{t&&console.error(t),s.push(n),s.length===i&&e(null,s)},r=Vh;for(let e=0;e<r.length;e++){const s=n[r[e]];if(s&&"string"==typeof s){i++;const e=t.getAbsoluteUrl(s);this.loadFromUrl(e,"texture",a)}}0===i&&e(null,s)}findAll(t,e){const s=this._names[t];if(s){const t=s.map((t=>this._assets[t]));return e?t.filter((t=>t.type===e)):t}return[]}_onTagAdd(t,e){this._tags.add(t,e)}_onTagRemove(t,e){this._tags.remove(t,e)}findByTag(){return this._tags.find(arguments)}filter(t){return this._assets.filter((e=>t(e)))}find(t,e){const s=this.findAll(t,e);return s.length>0?s[0]:null}}class Cp{constructor(t){this._assets=t,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}_onAssetAdded(t){if("bundle"===t.type){this._bundleAssets[t.id]=t,this._registerBundleEventListeners(t.id);for(let e=0,s=t.data.assets.length;e<s;e++)this._indexAssetInBundle(t.data.assets[e],t)}else this._assetsInBundles[t.id]&&this._indexAssetFileUrls(t)}_registerBundleEventListeners(t){this._assets.on("load:"+t,this._onBundleLoaded,this),this._assets.on("error:"+t,this._onBundleError,this)}_unregisterBundleEventListeners(t){this._assets.off("load:"+t,this._onBundleLoaded,this),this._assets.off("error:"+t,this._onBundleError,this)}_indexAssetInBundle(t,e){if(this._assetsInBundles[t]){const s=this._assetsInBundles[t];-1===s.indexOf(e)&&s.push(e)}else this._assetsInBundles[t]=[e];const s=this._assets.get(t);s&&this._indexAssetFileUrls(s)}_indexAssetFileUrls(t){const e=this._getAssetFileUrls(t);if(e)for(let s=0,i=e.length;s<i;s++){const i=e[s];this._urlsInBundles[i]=this._assetsInBundles[t.id]}}_getAssetFileUrls(t){let e=t.getFileUrl();if(!e)return null;e=this._normalizeUrl(e);const s=[e];if("font"===t.type){const i=t.data.info.maps.length;for(let t=1;t<i;t++)s.push(e.replace(".png",t+".png"))}return s}_normalizeUrl(t){return t&&t.split("?")[0]}_onAssetRemoved(t){if("bundle"===t.type){delete this._bundleAssets[t.id],this._unregisterBundleEventListeners(t.id);for(const e in this._assetsInBundles){const s=this._assetsInBundles[e],i=s.indexOf(t);if(-1!==i&&(s.splice(i,1),!s.length)){delete this._assetsInBundles[e];for(const t in this._urlsInBundles)this._urlsInBundles[t]===s&&delete this._urlsInBundles[t]}}this._onBundleError(`Bundle ${t.id} was removed`,t)}else if(this._assetsInBundles[t.id]){delete this._assetsInBundles[t.id];const e=this._getAssetFileUrls(t);for(let t=0,s=e.length;t<s;t++)delete this._urlsInBundles[e[t]]}}_onBundleLoaded(t){t.resource?requestAnimationFrame((()=>{if(this._fileRequests)for(const e in this._fileRequests){const s=this._urlsInBundles[e];if(!s||-1===s.indexOf(t))continue;const i=decodeURIComponent(e);let n=null;t.resource.hasBlobUrl(i)||(n=`Bundle ${t.id} does not contain URL ${e}`);const a=this._fileRequests[e];for(let e=0,s=a.length;e<s;e++)n?a[e](n):a[e](null,t.resource.getBlobUrl(i));delete this._fileRequests[e]}})):this._onBundleError(`Bundle ${t.id} failed to load`,t)}_onBundleError(t,e){for(const e in this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(e)){const s=this._fileRequests[e];for(let e=0,i=s.length;e<i;e++)s[e](t);delete this._fileRequests[e]}}}_findLoadedOrLoadingBundleForUrl(t){const e=this._urlsInBundles[t];if(!e)return null;const s=e.length;for(let t=0;t<s;t++)if(e[t].loaded&&e[t].resource)return e[t];for(let t=0;t<s;t++)if(e[t].loading)return e[t];return null}listBundlesForAsset(t){return this._assetsInBundles[t.id]||null}list(){const t=[];for(const e in this._bundleAssets)t.push(this._bundleAssets[e]);return t}hasUrl(t){return!!this._urlsInBundles[t]}canLoadUrl(t){return!!this._findLoadedOrLoadingBundleForUrl(t)}loadUrl(t,e){const s=this._findLoadedOrLoadingBundleForUrl(t);if(s)if(s.loaded){const i=decodeURIComponent(t);if(!s.resource.hasBlobUrl(i))return void e(`Bundle ${s.id} does not contain URL ${t}`);e(null,s.resource.getBlobUrl(i))}else this._fileRequests.hasOwnProperty(t)?this._fileRequests[t].push(e):this._fileRequests[t]=[e];else e(`URL ${t} not found in any bundles`)}destroy(){this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this);for(const t in this._bundleAssets)this._unregisterBundleEventListeners(t);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null}}const Ap=["x","y","z","w"],Pp=[void 0,void 0,ot,at,ht];function Ep(t,e,s,i){switch(e.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const t=parseInt(s,10);return isNaN(t)?null:t}return"boolean"==typeof s?0+s:null;case"json":{const i={};if(Array.isArray(e.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<e.schema.length;n++){const a=e.schema[n];if(a.name)if(a.array){i[a.name]=[];const e=Array.isArray(s[a.name])?s[a.name]:[];for(let s=0;s<e.length;s++)i[a.name].push(Ep(t,a,e[s]))}else{const e=s.hasOwnProperty(a.name)?s[a.name]:a.default;i[a.name]=Ep(t,a,e)}}}return i}case"asset":return s instanceof vp?s:"number"==typeof s?t.assets.get(s)||null:"string"==typeof s&&t.assets.get(parseInt(s,10))||null;case"entity":return s instanceof qo?s:"string"==typeof s?t.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof et)return i instanceof et?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;return i||(i=new et),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}return"string"==typeof s&&/#([0-9abcdef]{2}){3,4}/i.test(s)?(i||(i=new et),i.fromString(s),i):null;case"vec2":case"vec3":case"vec4":{const t=parseInt(e.type.slice(3),10),n=Pp[t];if(s instanceof n)return i instanceof n?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length===t){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;i||(i=new n);for(let e=0;e<t;e++)i[Ap[e]]=s[e];return i}return null}case"curve":if(s){let t;if(s instanceof it||s instanceof nt)t=s.clone();else{t=new(s.keys[0]instanceof Array?nt:it)(s.keys),t.type=s.type}return t}}return s}class Rp{constructor(t){this.scriptType=t,this.index={}}add(t,e){this.index[t]||Rp.reservedNames.has(t)||(this.index[t]=e,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(s){const i="attr",n="attr:"+t,a=this.__attributes[t];let r=a;if(a&&"json"!==e.type&&a.clone&&(this._callbacks.attr||this._callbacks[n])&&(r=a.clone()),e.array){if(this.__attributes[t]=[],s)for(let i=0,n=s.length;i<n;i++)this.__attributes[t].push(Ep(this.app,e,s[i],a?a[i]:null))}else this.__attributes[t]=Ep(this.app,e,s,a);this.fire(i,t,this.__attributes[t],r),this.fire(n,this.__attributes[t],r)}}))}remove(t){return!!this.index[t]&&(delete this.index[t],delete this.scriptType.prototype[t],!0)}has(t){return!!this.index[t]}get(t){return this.index[t]||null}}Rp.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);class Lp extends _{constructor(t,e){super(),this.system=void 0,this.entity=void 0,this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(t,e,s){this.fire("set_"+t,t,e,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(t,e){e.forEach((function(e){const s="object"==typeof e?e.name:e;Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(t){const e=this.data,i=e[s];e[s]=t,this.fire("set",s,i,t)},configurable:!0})})),t._accessorsBuilt=!0}buildAccessors(t){Lp._buildAccessors(this,t)}onSetEnabled(t,e,s){e!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}}class Ip extends Lp{constructor(t,e){super(t,e),this._scripts=[],this._updateList=new z({sortBy:"__executionOrder"}),this._postUpdateList=new z({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get enabled(){return this._enabled}set scripts(t){this._scriptsData=t;for(const e in t){if(!t.hasOwnProperty(e))continue;const s=this._scriptsIndex[e];if(s){if("boolean"==typeof t[e].enabled&&(s.enabled=!!t[e].enabled),"object"==typeof t[e].attributes)for(const i in t[e].attributes)if(!Rp.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const t=this.system.app.scripts.get(e);t&&t.attributes.add(i,{})}s[i]=t[e].attributes[i]}}else console.log(this.order)}}get scripts(){return this._scripts}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,Ip.scriptMethods.postInitialize))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e.enabled=e._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const e=this.scripts[t];e&&this.destroy(e.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(t){for(let e=0;e<t;e++){const t=this._destroyedScripts[e];this._removeScriptInstance(t)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++)this.scripts[t].__initializeAttributes()}_scriptMethod(t,e,s){t[e](s)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let e=0,s=t.length;e<s;e++){const s=t[e];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,Ip.scriptMethods.initialize))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,Ip.scriptMethods.update,t)}this._endLooping(s)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,Ip.scriptMethods.postUpdate,t)}this._endLooping(s)}_insertScriptInstance(t,e,s){-1===e?(this._scripts.push(t),t.__executionOrder=s,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,s+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return-1===e||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let s=t;s<e;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(t,e,s,i,n,a){if(t.array){const t=s.length;if(!t)return;const r=s.slice();for(let e=0;e<t;e++){const t=r[e]instanceof tm?r[e].getGuid():r[e];a[t]&&(r[e]=i?a[t].getGuid():a[t])}n[e]=r}else{if(s instanceof tm)s=s.getGuid();else if("string"!=typeof s)return;a[s]&&(n[e]=a[s])}}has(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;const e=t,s=e.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof e}get(t){if("string"==typeof t){const e=this._scriptsIndex[t];return e?e.instance:null}if(!t)return null;const e=t,s=e.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof e?n:null}create(t,e={}){const s=this;let i=t,n=t;if("string"==typeof i?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const t=new i({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes}),a=this._scripts.length;let r=-1;return"number"==typeof e.ind&&-1!==e.ind&&a>e.ind&&(r=e.ind),this._insertScriptInstance(t,r,a),this._scriptsIndex[n]={instance:t,onSwap:function(){s.swap(n)}},this[n]=t,e.preloading||t.__initializeAttributes(),this.fire("create",n,t),this.fire("create:"+n,t),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,Ip.scriptMethods.initialize)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,Ip.scriptMethods.postInitialize))),t}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const t=this._removeScriptInstance(n);t>=0&&this._resetExecutionOrder(t,this._scripts.length)}return this.system.app.scripts.off("swap:"+e,i.onSwap),delete this[e],this.fire("destroy",e,n||null),this.fire("destroy:"+e,n||null),n&&n.fire("destroy"),!0}swap(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(!i||!i.instance)return!1;const n=i.instance,a=this._scripts.indexOf(n),r=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!r.swap&&(r.__initializeAttributes(),this._scripts[a]=r,this._scriptsIndex[e].instance=r,this[e]=r,r.__executionOrder=a,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),r.update&&this._updateList.insert(r),r.postUpdate&&this._postUpdateList.insert(r),this._scriptMethod(r,Ip.scriptMethods.swap,n),this.fire("swap",e,r),this.fire("swap:"+e,r),!0)}resolveDuplicatedEntityReferenceProperties(t,e){const s=this.entity.script;for(const i in t._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const a=t._scriptsIndex[i];if(!a||!a.instance)continue;const r=s[i].__attributesRaw,o=s[i].__attributes;if(!r&&!o)continue;const h=!!r,l=a.instance.__attributes;for(const t in l){if(!l[t])continue;const s=n.attributes.get(t);if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,t,l[t],h,r||o,e);else if("json"===s.type&&Array.isArray(s.schema)){const i=l[t],n=r?r[t]:o[t];for(let t=0;t<s.schema.length;t++){const a=s.schema[t];if("entity"===a.type)if(s.array)for(let t=0;t<i.length;t++)this._resolveEntityScriptAttribute(a,a.name,i[t][a.name],h,n[t],e);else this._resolveEntityScriptAttribute(a,a.name,i[a.name],h,n,e)}}}}}move(t,e){const s=this._scripts.length;if(e>=s||e<0)return!1;let i=t,n=t;"string"!=typeof n?n=t.__name:i=null;const a=this._scriptsIndex[n];if(!a||!a.instance)return!1;const r=a.instance;if(i&&!(r instanceof i))return!1;const o=this._scripts.indexOf(r);return-1!==o&&o!==e&&(this._scripts.splice(e,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,r,e,o),this.fire("move:"+n,r,e,o),!0)}}Ip.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};const Dp=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class Op extends _{constructor(t){super(),this.app=void 0,this.entity=void 0,this._enabled=void 0,this._enabledOld=void 0,this._initialized=void 0,this._postInitialized=void 0,this.__destroyed=void 0,this.__attributes=void 0,this.__attributesRaw=void 0,this.__scriptType=void 0,this.__executionOrder=void 0,this.initScriptType(t)}set enabled(t){this._enabled=!!t,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,Ip.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,Ip.scriptMethods.postInitialize)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScriptType(t){const e=this.constructor;this.app=t.app,this.entity=t.entity,this._enabled="boolean"!=typeof t.enabled||t.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=t.attributes||{},this.__scriptType=e,this.__executionOrder=-1}static __getScriptName(t){if("function"!=typeof t)return;if("name"in Function.prototype)return t.name;if(t===Function||t===Function.prototype.constructor)return"Function";const e=(""+t).match(Dp);return e?e[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new Rp(this)),this.__attributes}__initializeAttributes(t){if(t||this.__attributesRaw){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(t){for(const e in t)t.hasOwnProperty(e)&&(this.prototype[e]=t[e])}}Op.__name=null;class Fp extends _{constructor(t){super(),this.app=t,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(t){const e=t.__name;return this._scripts.hasOwnProperty(e)?(setTimeout((()=>{if(t.prototype.swap){const s=this._scripts[e],i=this._list.indexOf(s);this._list[i]=t,this._scripts[e]=t,this.fire("swap",e,t),this.fire("swap:"+e,t)}else console.warn(`script registry already has '${e}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[e]=t,this._list.push(t),this.fire("add",e,t),this.fire("add:"+e,t),setTimeout((()=>{if(!this._scripts.hasOwnProperty(e))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const t=this.app.systems.script._components;let s;const i=[],n=[];for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const n=t.items[t.loopIndex];if(n._scriptsIndex[e]&&n._scriptsIndex[e].awaiting){n._scriptsData&&n._scriptsData[e]&&(s=n._scriptsData[e].attributes);const t=n.create(e,{preloading:!0,ind:n._scriptsIndex[e].ind,attributes:s});t&&i.push(t)}}for(let t=0;t<i.length;t++)i[t].__initializeAttributes();for(let t=0;t<i.length;t++)i[t].enabled&&(i[t]._initialized=!0,n.push(i[t]),i[t].initialize&&i[t].initialize());for(let t=0;t<n.length;t++)n[t].enabled&&!n[t]._postInitialized&&(n[t]._postInitialized=!0,n[t].postInitialize&&n[t].postInitialize())})),!0)}remove(t){let e=t,s=t;if("string"!=typeof s?s=e.__name:e=this.get(s),this.get(s)!==e)return!1;delete this._scripts[s];const i=this._list.indexOf(e);return this._list.splice(i,1),this.fire("remove",s,e),this.fire("remove:"+s,e),!0}get(t){return this._scripts[t]||null}has(t){if("string"==typeof t)return this._scripts.hasOwnProperty(t);if(!t)return!1;const e=t.__name;return this._scripts[e]===t}list(){return this._list}}class kp{_validate(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==t.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let e=0,s=t.data.length;e<s;e++){const s=t.data[e];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${e}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${e}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${e}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${e}].messages" field`)}}parse(t){return t.data}}class Bp extends _{constructor(t){super(),this.locale="en-US",this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new kp}set assets(t){const e={};for(let s=0,i=t.length;s<i;s++){e[t[s]instanceof vp?t[s].id:t[s]]=!0}let s=this._assets.length;for(;s--;){const t=this._assets[s];if(!e[t]){this._app.assets.off("add:"+t,this._onAssetAdd,this);const e=this._app.assets.get(t);e&&this._onAssetRemove(e),this._assets.splice(s,1)}}for(const t in e){const e=parseInt(t,10);if(-1!==this._assets.indexOf(e))continue;this._assets.push(e);const s=this._app.assets.get(e);s?this._onAssetAdd(s):this._app.assets.once("add:"+e,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(t){if(this._locale===t)return;let e=$u(t);if("in"===e&&(e="id",t=function(t,e){const s=t.indexOf("-");return-1!==s?e+t.substring(s):e}(t,e),this._locale===t))return;const s=this._locale;this._locale=t,this._lang=e,this._pluralFn=Ju(this._lang),this.fire("set:locale",t,s)}get locale(){return this._locale}static findAvailableLocale(t,e){return Zu(t,e)}findAvailableLocale(t){if(this._translations[t])return t;const e=$u(t);return this._findFallbackLocale(t,e)}getText(t,e){let s,i=t;e||(e=this._locale,s=this._lang);let n=this._translations[e];return n||(s||(s=$u(e)),e=this._findFallbackLocale(e,s),n=this._translations[e]),n&&n.hasOwnProperty(t)&&(i=n[t],Array.isArray(i)&&(i=i[0]),null==i&&(i=t)),i}getPluralText(t,e,s){let i,n,a=t;s?(i=$u(s),n=Ju(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let r=this._translations[s];if(r||(i=$u(s=this._findFallbackLocale(s,i)),n=Ju(i),r=this._translations[s]),r&&r[t]&&n){const s=n(e);a=r[t][s],null==a&&(a=t)}return a}addData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};const t=$u(i);this._availableLangs[t]||(this._availableLangs[t]=i)}Object.assign(this._translations[i],n),this.fire("data:add",i,n)}}removeData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=this._translations[i];if(!n)continue;const a=s.messages;for(const t in a)delete n[t];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[$u(i)]),this.fire("data:remove",i,a)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(t,e){let s=ju[t];return s&&this._translations[s]?s:(s=ju[e],s&&this._translations[s]?s:(s=this._availableLangs[e],s&&this._translations[s]?s:"en-US"))}_onAssetAdd(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)}_onAssetLoad(t){this.addData(t.resource)}_onAssetChange(t){t.resource&&this.addData(t.resource)}_onAssetRemove(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once("add:"+t.id,this._onAssetAdd,this)}_onAssetUnload(t){t.resource&&this.removeData(t.resource)}}class zp extends _{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(t){const e=t.id;if(this[e])throw new Error(`ComponentSystem name '${e}' already registered or not allowed`);this[e]=t,this.list.push(t)}remove(t){const e=t.id;if(!this[e])throw new Error(`No ComponentSystem named '${e}' registered`);delete this[e];const s=this.list.indexOf(this[e]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let t=0;t<this.list.length;t++)this.list[t].destroy()}}class Up{constructor(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=t._shaderStats,this.vram=t._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return $l().scene._stats}get lightmapper(){var t;return null==(t=$l().lightmapper)?void 0:t.stats}get batcher(){const t=$l()._batcher;return t?t._stats:null}}class Vp{constructor(t,e){this.name=t,this.url=e,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}get loaded(){return!!this.data}get loading(){return this._loading}}class Np{constructor(t){this._app=t,this._list=[],this._index={},this._urlIndex={}}destroy(){this._app=null}list(){return this._list}add(t,e){if(this._index.hasOwnProperty(t))return!1;const s=new Vp(t,e),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null}findByUrl(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null}remove(t){if(this._index.hasOwnProperty(t)){const e=this._index[t];let s=this._list[e];delete this._urlIndex[s.url],delete this._index[t],this._list.splice(e,1);for(let t=0;t<this._list.length;t++)s=this._list[t],this._index[s.name]=t,this._urlIndex[s.url]=t}}_loadSceneData(t,e,s){let i=t;if(t instanceof Vp?i=t.url:(t=this.findByUrl(i))||(t=new Vp("Untitled",i)),!t.url)return void s("URL or SceneRegistryItem is null when loading a scene");if(t.loaded)return void s(null,t);const n=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!tp.test(i)&&(i=v.join(this._app.assets.prefix,i)),t._onLoadedCallbacks.push(s),t._loading||n.load(i,(function(s,i){t.data=i,t._loading=!1;for(let e=0;e<t._onLoadedCallbacks.length;e++)t._onLoadedCallbacks[e](s,t);e||(t.data=null),t._onLoadedCallbacks.length=0})),t._loading=!0}loadSceneData(t,e){this._loadSceneData(t,!0,e)}unloadSceneData(t){"string"==typeof t&&(t=this.findByUrl(t)),t&&(t.data=null)}loadSceneHierarchy(t,e){const s=this,i=this._app.loader.getHandler("hierarchy");this._loadSceneData(t,!1,(function(t,n){if(t)return void(e&&e(t));const a=n.url,r=n.data;s._app._preloadScripts(r,(function(){s._app.systems.script.preloading=!0;const n=i.open(a,r);s._app.systems.script.preloading=!1,s._app.loader.clearCache(a,"hierarchy"),s._app.root.addChild(n),s._app.systems.fire("initialize",n),s._app.systems.fire("postInitialize",n),s._app.systems.fire("postPostInitialize",n),e&&e(t,n)}))}))}loadSceneSettings(t,e){const s=this;this._loadSceneData(t,!1,(function(t,i){t?e&&e(t):(s._app.applySceneSettings(i.data.settings),e&&e(null))}))}loadScene(t,e){const s=this,i=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!tp.test(t)&&(t=v.join(this._app.assets.prefix,t)),i.load(t,(function(n,a){if(n)e&&e(n);else{const n=function(){s._app.systems.script.preloading=!0;const n=i.open(t,a),r=s.findByUrl(t);r&&!r.loaded&&(r.data=a),s._app.systems.script.preloading=!1,s._app.loader.clearCache(t,"scene"),s._app.loader.patch({resource:n,type:"scene"},s._app.assets),s._app.root.addChild(n.root),s._app.systems.rigidbody&&"undefined"!=typeof Ammo&&s._app.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)};s._app._preloadScripts(a,n)}}))}}class Wp{constructor(t){this.application=t,this.device=t.graphicsDevice,this.clearOptions=null,this.layer=null,this.colorFormat=this.device.defaultFramebufferAlpha?7:6,this.device.webgl2?this.initWebGl2():this.initWebGl1()}allocateTexture(t,e,s,i,n){return new Mo(t,{name:e,format:s,width:t.width,height:t.height,mipmaps:n,minFilter:i?0:n?5:1,magFilter:i?0:1,addressU:1,addressV:1})}allocateRenderTarget(t,e,s,i,n,a){const r=a?["uSceneDepthMap","uDepthMap"]:["uSceneColorMap","texture_grabPass"],o=this.allocateTexture(e,r[0],s,i,n);return r.forEach((t=>e.scope.resolve(t).setValue(o))),t?(t.destroyFrameBuffers(),i?t._depthBuffer=o:t._colorBuffer=o):t=new al({name:"renderTargetSceneGrab",colorBuffer:i?null:o,depthBuffer:i?o:null,depth:!i,stencil:e.supportsStencil,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}initWebGl2(){const t=this.application,e=this;this.layer=new nu({enabled:!1,name:"Depth",id:1,onDisable:function(){e.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=null,e.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPreRenderOpaque:function(s){const i=t.graphicsDevice,n=t.scene.layers.cameras[s];if(n.renderSceneColorMap){var a,r;(null==(a=this.colorRenderTarget)?void 0:a.width)===i.width&&(null==(r=this.colorRenderTarget)?void 0:r.height)===i.height||(e.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=e.allocateRenderTarget(this.colorRenderTarget,i,this.colorFormat,!1,!0,!1)),i.copyRenderTarget(i.renderTarget,this.colorRenderTarget,!0,!1),i.activeTexture(i.maxCombinedTextures-1);const t=this.colorRenderTarget.colorBuffer;i.bindTexture(t),i.gl.generateMipmap(t.impl._glTarget)}var o,h;n.renderSceneDepthMap&&((null==(o=this.depthRenderTarget)?void 0:o.width)===i.width&&(null==(h=this.depthRenderTarget)?void 0:h.height)===i.height||(e.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=e.allocateRenderTarget(this.depthRenderTarget,i,17,!0,!1,!0)),i.copyRenderTarget(i.renderTarget,this.depthRenderTarget,!1,!0))},onPostRenderOpaque:function(t){}})}initWebGl1(){const t=this.application,e=this;this.clearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3},this.layer=new nu({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){this.depthRenderTarget=new al({name:"depthRenderTarget-webgl1",depth:!0,stencil:t.graphicsDevice.supportsStencil,autoResolve:!1,graphicsDevice:t.graphicsDevice}),this.renderTarget=this.depthRenderTarget},onDisable:function(){this.depthRenderTarget.destroyTextureBuffers(),this.renderTarget=null,e.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPostCull:function(s){const i=t.graphicsDevice;if(t.scene.layers.cameras[s].renderSceneDepthMap){this.depthRenderTarget.depthBuffer&&this.depthRenderTarget.width===i.width&&this.depthRenderTarget.height===i.height||(this.depthRenderTarget.destroyTextureBuffers(),this.depthRenderTarget=e.allocateRenderTarget(this.depthRenderTarget,i,7,!1,!1,!0));const n=this.instances.visibleOpaque[s],a=n.list,r=t.scene.layers,o=r.subLayerEnabled,h=r.subLayerList,l=t.scene.layers.getLayerById(0).renderTarget,c=this.cameras[s];let d=0;const u=r.layerList;for(let t=0;t<u.length;t++){const e=u[t];if(e===this)break;if(e.renderTarget!==l||!e.enabled||!o[t])continue;const s=e.cameras.indexOf(c);if(s<0)continue;let i=h[t]?e.instances.visibleTransparent[s]:e.instances.visibleOpaque[s];const n=i.length;i=i.list;for(let t=0;t<n;t++){const e=i[t];e.material&&e.material.depthWrite&&!e._noDepthDrawGl1&&(a[d]=e,d++)}}n.length=d}},onPreRenderOpaque:function(s){const i=t.graphicsDevice;if(t.scene.layers.cameras[s].renderSceneColorMap){var n,a;(null==(n=this.colorRenderTarget)?void 0:n.width)===i.width&&(null==(a=this.colorRenderTarget)?void 0:a.height)===i.height||(e.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=e.allocateRenderTarget(this.colorRenderTarget,i,this.colorFormat,!1,!1,!1));const t=this.colorRenderTarget._colorBuffer;t.impl._glTexture||t.impl.initialize(i,t),i.bindTexture(t);const s=i.gl;s.copyTexImage2D(s.TEXTURE_2D,0,t.impl._glFormat,0,0,i.width,i.height,0),t._needsUpload=!1,t._needsMipmapsUpload=!1}this.oldClear=this.cameras[s].camera._clearOptions,this.cameras[s].camera._clearOptions=e.clearOptions},onDrawCall:function(){t.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(e){if(t.scene.layers.cameras[e].renderSceneDepthMap){this.instances.visibleOpaque[e].length=0}this.depthRenderTarget&&(this.cameras[e].camera._clearOptions=this.oldClear)}})}patch(t){t.onEnable=this.layer.onEnable,t.onDisable=this.layer.onDisable,t.onPreRenderOpaque=this.layer.onPreRenderOpaque,t.onPostRenderOpaque=this.layer.onPostRenderOpaque,t.shaderPass=this.layer.shaderPass,t.onPostCull=this.layer.onPostCull,t.onDrawCall=this.layer.onDrawCall}}const Gp="NONE",Hp="FILL_WINDOW",Xp="KEEP_ASPECT",qp="AUTO",jp="FIXED";class Yp{constructor(t){this.length=t,this.count=0}inc(){this.count++}done(){return this.count===this.length}}let Kp=null;class $p extends _{constructor(t){super(),$p._applications[t.id]=this,Zl(this),Kp=this,this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=Tp.legacy,this._librariesLoaded=!1,this._fillMode="KEEP_ASPECT",this._resolutionMode="FIXED",this._allowResize=!0,this.context=this}init(t){this.graphicsDevice=t.graphicsDevice,this._initDefaultMaterial(),this.stats=new Up(this.graphicsDevice),this._soundManager=t.soundManager,this.loader=new qu(this),ih.init(this.graphicsDevice),this._entityIndex={},this.scene=new Uu(this.graphicsDevice),this._registerSceneImmediate(this.scene),this.root=new tm,this.root._enabledInHierarchy=!0,this.assets=new Mp(this.loader),t.assetPrefix&&(this.assets.prefix=t.assetPrefix),this.bundles=new Cp(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=t.scriptsOrder||[],this.scripts=new Fp(this),this.i18n=new Bp(this),this.scenes=new Np(this);const e=this;this.defaultLayerWorld=new nu({name:"World",id:0}),this.sceneGrab=new Wp(this),this.defaultLayerDepth=this.sceneGrab.layer,this.defaultLayerSkybox=new nu({enabled:!0,name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new nu({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),this.defaultLayerImmediate=new nu({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});const s=new uu("default");s.pushOpaque(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerDepth),s.pushOpaque(this.defaultLayerSkybox),s.pushTransparent(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerUi),this.scene.layers=s,this.scene.on("set:layers",(function(t,s){const i=s.layerList;let n;for(let t=0;t<i.length;t++)switch(n=i[t],n.id){case 1:e.sceneGrab.patch(n);break;case 4:n.passThrough=e.defaultLayerUi.passThrough;break;case 3:n.passThrough=e.defaultLayerImmediate.passThrough}})),Ru.createPlaceholder(this.graphicsDevice),this.renderer=new Yd(this.graphicsDevice),this.renderer.scene=this.scene,this.frameGraph=new Au(this.graphicsDevice),this.lightmapper=null,t.lightmapper&&(this.lightmapper=new t.lightmapper(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),this._batcher=null,t.batchManager&&(this._batcher=new t.batchManager(this.graphicsDevice,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=t.keyboard||null,this.mouse=t.mouse||null,this.touch=t.touch||null,this.gamepads=t.gamepads||null,this.elementInput=t.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.xr=t.xr?new t.xr(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=t.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new Xu(this)),t.resourceHandlers.forEach((t=>{const e=new t(this);this.loader.addHandler(e.handlerType,e)})),this.systems=new zp,t.componentSystems.forEach((t=>{this.systems.add(new t(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Qp(this)}static getApplication(t){return t?$p._applications[t]:$l()}_initDefaultMaterial(){const t=new Xh;t.name="Default Material",t.shadingModel=1,function(t,e){Ih.get(t,(()=>e))}(this.graphicsDevice,t)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(t,e){Y.get(t,((t,s)=>{if(t)return void e(t);const i=s.application_properties,n=s.scenes,a=s.assets;this._parseApplicationProperties(i,(t=>{this._parseScenes(n),this._parseAssets(a),e(t||null)}))}))}preload(t){this.fire("preload:start");const e=this.assets.list({preload:!0}),s=new Yp(e.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),t())},a=e.length;if(s.length){const t=t=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()},i=(t,e)=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()};for(let r=0;r<e.length;r++)e[r].loaded?(s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()):(e[r].once("load",t),e[r].once("error",i),this.assets.load(e[r]))}else n()}_preloadScripts(t,e){if(!Tp.legacy)return void e();this.systems.script.preloading=!0;const s=this._getScriptReferences(t),i=s.length,n=new Yp(i),a=/^http(s)?:\/\//;if(i){const t=(t,s)=>{t&&console.error(t),n.inc(),n.done()&&(this.systems.script.preloading=!1,e())};for(let e=0;e<i;e++){let i=s[e];!a.test(i.toLowerCase())&&this._scriptPrefix&&(i=v.join(self._scriptPrefix,s[e])),this.loader.load(i,"script",t)}}else this.systems.script.preloading=!1,e()}_handleAreaLightDataProperty(t){const e=this.assets.get(t);e?this.setAreaLightLuts(e):this.assets.once("add:"+t,this.setAreaLightLuts,this)}_parseApplicationProperties(t,e){if("number"==typeof t.maxAssetRetries&&t.maxAssetRetries>0&&this.loader.enableRetry(t.maxAssetRetries),t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){const e=new uu("application"),s={};for(const e in t.layers){const i=t.layers[e];i.id=parseInt(e,10),i.enabled=1!==i.id,s[e]=new nu(i)}for(let i=0,n=t.layerOrder.length;i<n;i++){const n=t.layerOrder[i],a=s[n.layer];a&&(n.transparent?e.pushTransparent(a):e.pushOpaque(a),e.subLayerEnabled[i]=n.enabled)}this.scene.layers=e}if(t.batchGroups){const e=this.batcher;if(e)for(let s=0,i=t.batchGroups.length;s<i;s++){const i=t.batchGroups[s];e.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers)}}t.i18nAssets&&(this.i18n.assets=t.i18nAssets),t.areaLightDataAsset&&this._handleAreaLightDataProperty(t.areaLightDataAsset),this._loadLibraries(t.libraries,e)}_loadLibraries(t,e){const s=t.length;let i=s;const n=/^http(s)?:\/\//;if(s){const a=(t,s)=>{i--,t?e(t):0===i&&(this.onLibrariesLoaded(),e(null))};for(let e=0;e<s;++e){let s=t[e];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=v.join(this._scriptPrefix,s)),this.loader.load(s,"script",a)}}else this.onLibrariesLoaded(),e(null)}_parseScenes(t){if(t)for(let e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)}_parseAssets(t){const e=[],s={},i={};if(Tp.legacy){if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const s in t)i[s]||e.push(t[s])}else{for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];t[n]&&(s[n]=!0,e.push(t[n]))}if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const n in t)s[n]||i[n]||e.push(t[n])}for(let t=0;t<e.length;t++){const s=e[t],i=new vp(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(const t in s.i18n)i.addLocalizedAssetId(t,s.i18n[t]);this.assets.add(i)}}_getScriptReferences(t){let e=[];t.settings.priority_scripts&&(e=t.settings.priority_scripts);const s=[],i={};for(let t=0;t<e.length;t++)s.push(e[t]),i[e[t]]=!0;const n=t.entities;for(const t in n){if(!n[t].components.script)continue;const e=n[t].components.script.scripts;for(let t=0;t<e.length;t++)i[e[t].url]||(s.push(e[t].url),i[e[t].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:V(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(t){this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(t){this.frame++,this.graphicsDevice.updateClientRect(),Tp.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",t),this.systems.fire("animationUpdate",t),this.systems.fire("postUpdate",t),this.fire("update",t),this.inputUpdate(t)}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(t){this.renderer.buildFrameGraph(this.frameGraph,t),this.frameGraph.render()}_fillFrameStatsBasic(t,e,s){const i=this.stats.frame;i.dt=e,i.ms=s,t>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=t+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let t=this.stats.frame;t.cameras=this.renderer._camerasRendered,t.materials=this.renderer._materialSwitches,t.shaders=this.graphicsDevice._shaderSwitchesPerFrame,t.shadowMapUpdates=this.renderer._shadowMapUpdates,t.shadowMapTime=this.renderer._shadowMapTime,t.depthMapTime=this.renderer._depthMapTime,t.forwardTime=this.renderer._forwardTime;const e=this.graphicsDevice._primsPerFrame;t.triangles=e[4]/3+Math.max(e[5]-2,0)+Math.max(e[6]-2,0),t.cullTime=this.renderer._cullTime,t.sortTime=this.renderer._sortTime,t.skinTime=this.renderer._skinTime,t.morphTime=this.renderer._morphTime,t.lightClusters=this.renderer._lightClusters,t.lightClustersTime=this.renderer._lightClustersTime,t.otherPrimitives=0;for(let s=0;s<e.length;s++)s<4&&(t.otherPrimitives+=e[s]),e[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,t=this.stats.drawCalls,t.forward=this.renderer._forwardDrawCalls,t.culled=this.renderer._numDrawCallsCulled,t.depth=0,t.shadow=this.renderer._shadowDrawCalls,t.skinned=this.renderer._skinDrawCalls,t.immediate=0,t.instanced=0,t.removedByInstancing=0,t.misc=t.total-(t.forward+t.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,t=this.stats.particles,t.updatesPerFrame=t._updatesPerFrame,t.frameTime=t._frameTime,t._updatesPerFrame=0,t._frameTime=0}setCanvasFillMode(t,e,s){this._fillMode=t,this.resizeCanvas(e,s)}setCanvasResolution(t,e,s){this._resolutionMode=t,"AUTO"===t&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(t,e){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if("KEEP_ASPECT"===this._fillMode){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?e=(t=s)/n:t=(e=i)*n}else"FILL_WINDOW"===this._fillMode&&(t=s,e=i);return this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=e+"px",this.updateCanvasSize(),{width:t,height:e}}updateCanvasSize(){var t;if(this._allowResize&&(null==(t=this.xr)||!t.active)&&"AUTO"===this._resolutionMode){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(t){let e;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const e=t.physics.gravity;this.systems.rigidbody.gravity.set(e[0],e[1],e[2])}this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox),e?this.setSkybox(e):this.assets.once("add:"+t.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(t){if(t){const e=this.graphicsDevice;t.ready((t=>{Ru.set(e,t.resource)})),this.assets.load(t)}}setSkybox(t){if(t!==this._skyboxAsset){const e=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=t,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){this.lightmapper&&this.lightmapper.bake(null,this.scene.lightmapMode)}_firstBatch(){this.batcher.generate()}_processTimestamp(t){return t}drawLine(t,e,s,i,n){this.scene.drawLine(t,e,s,i,n)}drawLines(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(t,e,s,i)}drawLineArrays(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(t,e,s,i)}drawWireSphere(t,e,s=et.WHITE,i=20,n=!0,a=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(t,e,s,i,n,a)}drawWireAlignedBox(t,e,s=et.WHITE,i=!0,n=this.scene.defaultDrawLayer){this.scene.immediate.drawWireAlignedBox(t,e,s,i,n)}drawMeshInstance(t,e=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,t,e)}drawMesh(t,e,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,s,t,null,i)}drawQuad(t,e,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,t,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(t,e,s,i,n,a,r=this.scene.defaultDrawLayer){const o=new mt;o.setTRS(new at(t,e,0),ft.IDENTITY,new at(s,i,0)),a||((a=new Fh).setParameter("colorMap",n),a.shader=this.scene.immediate.getTextureShader(),a.update()),this.drawQuad(o,a,r)}drawDepthTexture(t,e,s,i,n=this.scene.defaultDrawLayer){const a=new Fh;a.shader=this.scene.immediate.getDepthTextureShader(),a.update(),this.drawTexture(t,e,s,i,null,a,n)}destroy(){var t;if(this._inFrameUpdate)return void(this._destroyRequested=!0);const e=this.graphicsDevice.canvas.id;this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const s=this.assets.list();for(let t=0;t<s.length;t++)s[t].unload(),s[t].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;for(const t in this.loader.getHandler("script")._cache){const e=this.loader.getHandler("script")._cache[t],s=e.parentNode;s&&s.removeChild(e)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(t=this.lightmapper)||t.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==this||this.xr.end(),null==this||this.xr.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),Tp.app=null,$p._applications[e]=null,$l()===this&&Zl(null)}getEntityFromIndex(t){return this._entityIndex[t]}_registerSceneImmediate(t){this.on("postrender",t.immediate.onPostRender,t.immediate)}}$p._applications={};const Zp={},Qp=function(t){const e=t;let s;return function(t,i){var n;if(!e.graphicsDevice)return;Zl(e),s&&(window.cancelAnimationFrame(s),s=null),Kp=e;const a=e._processTimestamp(t)||V(),r=a-(e._time||a);let o=r/1e3;if(o=q.clamp(o,0,e.maxDeltaTime),o*=e.timeScale,e._time=a,s=null!=(n=e.xr)&&n.session?e.xr.session.requestAnimationFrame(e.tick):L.browser?window.requestAnimationFrame(e.tick):null,!e.graphicsDevice.contextLost){var h;if(e._fillFrameStatsBasic(a,o,r),e._inFrameUpdate=!0,e.fire("frameupdate",r),i)null==(h=e.xr)||h.update(i),e.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer;else e.graphicsDevice.defaultFramebuffer=null;e.update(o),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.updateCanvasSize(),e.render(),e.renderNextFrame=!1),Zp.timestamp=V(),Zp.target=e,e.fire("frameend",Zp),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy()}}},Jp=[];class tm extends qo{constructor(t,e){if(super(t),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,t instanceof $p&&(e=t),!e&&!(e=$p.getApplication()))throw new Error("Couldn't find current application");this._app=e}addComponent(t,e){const s=this._app.systems[t];return s?this.c[t]?null:s.addComponent(this,e):null}removeComponent(t){const e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)}findComponent(t){const e=this.findOne((function(e){return e.c&&e.c[t]}));return e&&e.c[t]}findComponents(t){return this.find((function(e){return e.c&&e.c[t]})).map((function(e){return e.c[t]}))}getGuid(){return this._guid||this.setGuid(y.create()),this._guid}setGuid(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this}_notifyHierarchyStateChanged(t,e){let s=!1;t===this&&0===Jp.length&&(s=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&Jp.push(t);const i=t._children;for(let t=0,s=i.length;t<s;t++)i[t]._enabled&&this._notifyHierarchyStateChanged(i[t],e);if(t._beingEnabled=!1,s){for(let t=0;t<Jp.length;t++)Jp[t]._onHierarchyStatePostChanged();Jp.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const e=this.c;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];i.enabled&&(t?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const t=this.c;for(const e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()}findByGuid(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null}destroy(){this._destroying=!0;for(const t in this.c)this.c[t].enabled=!1;for(const t in this.c)this.c[t].system.removeComponent(this);this._parent&&this._parent.removeChild(this);const t=this._children;let e=t.shift();for(;e;)e instanceof tm&&e.destroy(),e._parent=null,e=t.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,em(this,this,e,t),e}_cloneRecursively(t){const e=new tm(this._app);super._cloneInternal(e);for(const t in this.c){this.c[t].system.cloneComponent(this,e)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof tm){const s=i._cloneRecursively(t);e.addChild(s),t[i.getGuid()]=s}}return e}}function em(t,e,s,i){if(e instanceof tm){const n=e.c;for(const e in n){const a=n[e],r=a.system.getPropertiesOfType("entity");for(let n=0,o=r.length;n<o;n++){const o=r[n].name,h=a[o];if(!!t.findByGuid(h)){const t=i[h].getGuid();t&&(s.c[e][o]=t)}}}n.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const a=e.children.filter((function(t){return t instanceof tm})),r=s.children.filter((function(t){return t instanceof tm}));for(let e=0,s=a.length;e<s;e++)em(t,a[e],r[e],i)}}const sm=new at;class im extends Tu{constructor(t){const e=new tm("AmbientLight");e.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:et.WHITE,intensity:1,bakeDir:!1}),super(t,e.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(t,e){lh(sm,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(sm.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/e,1/s)}}class nm{constructor(t,e=null){this.node=t,this.component=t.render||t.model,e=e||this.component.meshInstances,this.store(),this.meshInstances=e,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}class am{constructor(t){this.device=t,this.shaderDilate=co(t,Zr.fullscreenQuadVS,Zr.dilatePS,"lmDilate"),this.constantTexSource=t.scope.resolve("source"),this.constantPixelOffset=t.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(t){this.constantTexSource.setValue(t)}prepare(t,e){this.pixelOffset[0]=1/t,this.pixelOffset[1]=1/e,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(t,e){this.shaderDenoise||(this.shaderDenoise=co(this.device,Zr.fullscreenQuadVS,Zr.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=t,this.sigmas[1]=e,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(t,e)}evaluateDenoiseUniforms(t,e){function s(t,e){return.39894*Math.exp(-.5*t*t/(e*e))/e}this.kernel=this.kernel||new Float32Array(15);const i=this.kernel,n=Math.floor(7);for(let e=0;e<=n;++e){const a=s(e,t);i[n+e]=a,i[n-e]=a}this.constantKernel.setValue(this.kernel);const a=1/s(0,e);this.bZnorm.setValue(a)}}const rm=new at;class om{constructor(t,e,s,i,n){this.device=t,this.root=e,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i._shadowRenderer.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new et,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){Sc.decRef(this.blackTex),this.blackTex=null,Sc.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null}initBake(t){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new am(t),this.constantBakeDir=t.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new Mo(this.device,{width:4,height:4,format:7,type:"rgbm",name:"lightmapBlack"}),Sc.incRef(this.blackTex);const e=new Ro;e.clearColor.set(0,0,0,0),e.clearColorBuffer=!0,e.clearDepthBuffer=!1,e.clearStencilBuffer=!1,e.frustumCulling=!1,e.projection=1,e.aspectRatio=1,e.node=new qo,this.camera=e}if(this.scene.clusteredLightingEnabled){const e=new Su(t.supportsAreaLights,t.maxTextureSize,(()=>{}));this.lightingParams=e;const s=this.scene.lighting;e.shadowsEnabled=s.shadowsEnabled,e.shadowAtlasResolution=s.shadowAtlasResolution,e.cookiesEnabled=s.cookiesEnabled,e.cookieAtlasResolution=s.cookieAtlasResolution,e.areaLightsEnabled=s.areaLightsEnabled,e.cells=new at(3,3,3),e.maxLightsPerCell=4,this.worldClusters=new Xc(t),this.worldClusters.name="ClusterLightmapper"}}finishBake(t){function e(t){Sc.decRef(t.colorBuffer),t.destroy()}this.materials=[],this.renderTargets.forEach((t=>{e(t)})),this.renderTargets.clear(),t.forEach((t=>{t.renderTargets.forEach((t=>{e(t)})),t.renderTargets.length=0})),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(t,e,s,i){const n=new Xh;if(n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.transformVS="#define UV1LAYOUT\n"+Zr.transformVS,0===s){let t=Zr.bakeLmEndPS;i?t=`\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(${e.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight += vec3(${e.ambientBakeOcclusionBrightness.toFixed(1)});\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = saturate(dDiffuseLight);\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight *= dAmbientLight;\n\t\t\t\t\t\t\t\t`+t:(n.ambient=new et(0,0,0),n.ambientTint=!0),n.chunks.endPS=t,n.lightMap=this.blackTex}else n.chunks.basePS=Zr.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",n.chunks.endPS=Zr.bakeDirLmEndPS;return n.chunks.outputAlphaPS="\n",n.chunks.outputAlphaOpaquePS="\n",n.chunks.outputAlphaPremulPS="\n",n.cull=0,n.forceUv1=!0,n.update(),n.updateShader(t,e),n}createMaterials(t,e,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(t,e,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,e,0,!0),this.ambientAOMaterial.onUpdateShader=function(t){return t.lightMapWithoutAmbient=!0,t.separateAmbient=!0,t})}createTexture(t,e,s){return new Mo(this.device,{width:t,height:t,format:7,mipmaps:!1,type:e,minFilter:0,magFilter:0,addressU:1,addressV:1,name:s})}collectModels(t,e,s){var i,n,a;if(!t.enabled)return;let r;if(null!=(i=t.model)&&i.model&&null!=(n=t.model)&&n.enabled&&(s&&s.push(new nm(t)),t.model.lightmapped&&e&&(r=t.model.model.meshInstances)),null!=(a=t.render)&&a.enabled&&(s&&s.push(new nm(t)),t.render.lightmapped&&e&&(r=t.render.meshInstances)),r){let s=!0;for(let t=0;t<r.length;t++)if(!r[t].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let i=0;i<r.length;i++){const n=r[i].mesh;this._tempSet.has(n)?e.push(new nm(t,[r[i]])):s.push(r[i]),this._tempSet.add(n)}this._tempSet.clear(),s.length>0&&e.push(new nm(t,s))}}for(let i=0;i<t._children.length;i++)this.collectModels(t._children[i],e,s)}prepareShadowCasters(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const i=t[s].meshInstances;for(let t=0;t<i.length;t++)i[t].visibleThisFrame=!0,e.push(i[t])}}return e}updateTransforms(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;for(let t=0;t<s.length;t++)s[t].node.getWorldTransform()}}calculateLightmapSize(t){let e;const s=this.scene.lightmapSizeMultiplier||16,i=rm;let n,a;t.model?(a=t.model.lightmapSizeMultiplier,t.model.asset?(e=this.assets.get(t.model.asset).data,e.area&&(n=e.area)):t.model._area&&(e=t.model,e._area&&(n=e._area))):t.render&&(a=t.render.lightmapSizeMultiplier,"asset"!==t.render.type&&t.render._area&&(e=t.render,e._area&&(n=e._area)));const r={x:1,y:1,z:1,uv:1};n&&(r.x=n.x,r.y=n.y,r.z=n.z,r.uv=n.uv);const o=a||1;r.x*=o,r.y*=o,r.z*=o;const h=t.render||t.model,l=this.computeNodeBounds(h.meshInstances);i.copy(l.halfExtents);let c=r.x*i.y*i.z+r.y*i.x*i.z+r.z*i.x*i.y;c/=r.uv,c=Math.sqrt(c);return Math.min(q.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmapping(t,e,s,i){for(let n=0;n<t.length;n++){const a=t[n],r=a.meshInstances;for(let t=0;t<r.length;t++){const n=r[t];if(n.setLightmapped(e),e){i&&(n._shaderDefs|=i),n.mask=2;for(let t=0;t<s;t++){const e=a.renderTargets[t].colorBuffer;e.minFilter=1,e.magFilter=1,n.setRealtimeLightmap(Ec.lightmapParamNames[t],e)}}}}}bake(t,e=1){const s=this.device,i=V();this.scene._updateSkybox(s),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,a=s._renderTargetCreationTime,r=s._shaderStats.compileTime,o=[],h=[];if(t){for(let e=0;e<t.length;e++)this.collectModels(t[e],o,null);this.collectModels(this.root,null,h)}else this.collectModels(this.root,o,h);if(o.length>0){const t=1===e?2:1;this.setLightmapping(o,!1,t),this.initBake(s),this.bakeInternal(t,o,h);let i=64;1===e&&(i|=128),this.scene.ambientBake&&(i|=8192),this.setLightmapping(o,!0,t,i),this.finishBake(o)}const l=V();this.stats.totalRenderTime=l-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-r,this.stats.fboTime=s._renderTargetCreationTime-a,this.stats.lightmapCount=o.length}allocateTextures(t,e){for(let s=0;s<t.length;s++){const i=t[s],n=this.calculateLightmapSize(i.node);for(let t=0;t<e;t++){const e=this.createTexture(n,"default","lightmapper_lightmap_"+s);Sc.incRef(e),i.renderTargets[t]=new al({colorBuffer:e,depth:!1})}if(!this.renderTargets.has(n)){const t=this.createTexture(n,"default","lightmapper_temp_lightmap_"+n);Sc.incRef(t),this.renderTargets.set(n,new al({colorBuffer:t,depth:!1}))}}}prepareLightsToBake(t,e,s){if(this.scene.ambientBake){const t=new im(this.scene);s.push(t)}const i=t._lights;for(let t=0;t<i.length;t++){const n=i[t],a=new Cu(this.scene,n);e.push(a),n.enabled&&0!=(4&n.mask)&&(n.isStatic=!1,n.mask=4294967295,n.shadowUpdateMode=0===n.type?2:1,s.push(a))}s.sort()}restoreLights(t){for(let e=0;e<t.length;e++)t[e].restore()}setupScene(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog="none",this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)}computeNodeBounds(t){const e=new bt;if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}computeNodesBounds(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;t[e].bounds=this.computeNodeBounds(s)}}computeBounds(t){const e=new bt;for(let s=0;s<t.length;s++){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}backupMaterials(t){for(let e=0;e<t.length;e++)this.materials[e]=t[e].material}restoreMaterials(t){for(let e=0;e<t.length;e++)t[e].material=this.materials[e]}lightCameraPrepare(t,e){const s=e.light;let i;if(2===s.type){i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)}return i}lightCameraPrepareAndCull(t,e,s,i){const n=t.light;let a=!0;if(0===n.type){rm.copy(i.center),rm.y+=i.halfExtents.y,this.camera.node.setPosition(rm),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;const t=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=t}else t.lightBounds.intersects(e.bounds)||(a=!1);if(2===n.type){let t=!1;const i=e.meshInstances;for(let e=0;e<i.length;e++)if(i[e]._isVisible(s)){t=!0;break}t||(a=!1)}return a}setupLightArray(t,e){t[0].length=0,t[1].length=0,t[2].length=0,t[e.type][0]=e,e.visibleThisFrame=!0}renderShadowMap(t,e,s,i){const n=i.light;return!t&&n.castShadows&&(n.shadowMap||this.scene.clusteredLightingEnabled||(n.shadowMap=this.shadowMapCache.get(this.device,n)),0===n.type?this.renderer._shadowRenderer.cullDirectional(n,e,this.camera):this.renderer._shadowRenderer.cullLocal(n,e),this.renderer.renderShadows(s[n.type],this.camera)),!0}postprocessTextures(t,e,s){const i=this.lightmapFilters.shaderDilate,n=this.scene.lightmapFilterEnabled;n&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness);for(let a=0;a<e.length;a++){const r=e[a];for(let e=0;e<s;e++){const s=r.renderTargets[e],a=s.colorBuffer,o=this.renderTargets.get(a.width),h=o.colorBuffer;this.lightmapFilters.prepare(a.width,a.height);for(let r=0;r<1;r++){this.lightmapFilters.setSourceTexture(a);Yr(t,o,n&&0===e&&0===r?this.lightmapFilters.shaderDenoise:i),this.lightmapFilters.setSourceTexture(h),Yr(t,s,i)}}}}bakeInternal(t,e,s){const i=this.scene,n=this.device,a=i.clusteredLightingEnabled;this.createMaterials(n,i,t),this.setupScene(),i.layers._update(),this.computeNodesBounds(e),this.allocateTextures(e,t);const r=[],o=[];this.prepareLightsToBake(i.layers,r,o),this.updateTransforms(s);const h=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(h),this.renderer.gpuUpdate(h);const l=this.computeBounds(h);let c,d,u,p;for(c=0;c<e.length;c++){for(u=e[c].meshInstances,d=0;d<u.length;d++)p=u[d],p.setLightmapped(!1),p.mask=4,p.setRealtimeLightmap(Ec.lightmapParamNames[0],p.material.lightMap?p.material.lightMap:this.blackTex),p.setRealtimeLightmap(Ec.lightmapParamNames[1],this.blackTex)}for(d=0;d<o.length;d++)o[d].light.enabled=!1;const m=[[],[],[]];let f,_,g=!1;for(c=0;c<o.length;c++){const s=o[c],r=s instanceof im;let y=s.numVirtualLights;t>1&&y>1&&s.light.bakeDir&&(y=1);for(let o=0;o<y;o++){y>1&&s.prepareVirtualLight(o,y),s.startBake();let c=!1;const v=this.lightCameraPrepare(n,s);for(_=0;_<e.length;_++){const x=e[_];u=x.meshInstances;if(this.lightCameraPrepareAndCull(s,x,v,l)){if(this.setupLightArray(m,s.light),a&&this.renderer.lightTextureAtlas.update(m[2],m[1],this.lightingParams),c=this.renderShadowMap(c,h,m,s),a){const t=m[2].concat(m[1]);this.worldClusters.update(t,this.scene.gammaCorrection,this.lightingParams)}for(this.backupMaterials(u),f=0;f<t&&!(f>0&&o>0)&&!(r&&f>0);f++){const t=x.renderTargets[f],e=x.renderTargets[f].colorBuffer.width,h=this.renderTargets.get(e),l=h.colorBuffer;0===f?g=i.updateShaders:g&&(i.updateShaders=!0);let c=this.passMaterials[f];if(r){o+1===y&&0===f&&(c=this.ambientAOMaterial)}for(d=0;d<u.length;d++)u[d].material=c;for(this.renderer.updateShaders(u),this.renderer.setCamera(this.camera,h,!0),1===f&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),a&&this.worldClusters.activate(this.renderer.lightTextureAtlas),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,u,u.length,m,1),n.updateEnd(),x.renderTargets[f]=h,this.renderTargets.set(e,t),d=0;d<u.length;d++)p=u[d],p.setRealtimeLightmap(Ec.lightmapParamNames[f],l),p._shaderDefs|=64}this.restoreMaterials(u)}}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,e,t),_=0;_<s.length;_++)s[_].restore();this.restoreLights(r),this.restoreScene(),a||this.shadowMapCache.clear()}}class hm{constructor(t){2===arguments.length&&(t=arguments[1]),this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this.aabb=t.aabb,this.aabb||(this.aabb=new bt,t.deltaPositions&&this.aabb.compute(t.deltaPositions)),this.deltaPositions=t.deltaPositions}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}_postInit(){this.options=null}_initVertexBuffers(t){const e=this.options;this._vertexBufferPositions=this._createVertexBuffer(t,e.deltaPositions,e.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(t,e.deltaNormals,e.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(t,e,s=6){if(e){return new Wr(t,new Hr(t,[{semantic:"ATTR0",components:3,type:s}]),e.length/3,0,e)}return null}_setTexture(t,e){this[t]=e}destroy(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}}let lm,cm=1;const dm=new mt,um=new mt,pm=new at,mm=new at,fm=new at,_m=new at,gm=new at,ym=new at,vm=new at,xm=new at,bm=new at,Sm=new at,wm=new at,Tm=new at,Mm=new at;function Cm(t){return t-Math.floor(t)}function Am(t){return Math.max(Math.min(t,1),0)}function Pm(t,e){return t-e*Math.floor(t/e)}function Em(t){let e=Cm(t),s=Cm(255*t);return e-=s/255,s-=s/255,[e,s]}class Rm{constructor(t){this._emitter=t}calcSpawnPosition(t,e,s,i,n){const a=this._emitter,r=Math.random(),o=Math.random(),h=Math.random(),l=Math.random();if(a.useCpu&&(t[4*n+0+2*a.numParticlesPot*4]=r,t[4*n+1+2*a.numParticlesPot*4]=o,t[4*n+2+2*a.numParticlesPot*4]=h),mm.x=r-.5,mm.y=o-.5,mm.z=h-.5,0===a.emitterShape){const t=Math.max(Math.abs(mm.x),Math.max(Math.abs(mm.y),Math.abs(mm.z))),n=t+(.5-t)*s[0],r=t+(.5-t)*s[1],o=t+(.5-t)*s[2];mm.x=n*(t===Math.abs(mm.x)?Math.sign(mm.x):2*mm.x),mm.y=r*(t===Math.abs(mm.y)?Math.sign(mm.y):2*mm.y),mm.z=o*(t===Math.abs(mm.z)?Math.sign(mm.z):2*mm.z),a.localSpace?pm.copy(e.transformPoint(mm)):pm.copy(i).add(e.transformPoint(mm))}else{mm.normalize();const t=0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius,e=l*(1-t)+t;a.localSpace?pm.copy(mm.mulScalar(e*a.emitterRadius)):pm.copy(i).add(mm.mulScalar(e*a.emitterRadius))}let c=-q.lerp(a.rate,a.rate2,r)*n;if(a.pack8){const e=(pm.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,s=(pm.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,i=(pm.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5;let o=q.lerp(a.startAngle*q.DEG_TO_RAD,a.startAngle2*q.DEG_TO_RAD,r);o=o%(2*Math.PI)/(2*Math.PI);const h=Em(e);t[4*n]=h[0],t[4*n+1]=h[1];const l=Em(s);t[4*n+2]=l[0],t[4*n+3]=l[1];const d=Em(i);t[4*n+0+4*a.numParticlesPot]=d[0],t[4*n+1+4*a.numParticlesPot]=d[1];const u=Em(o);t[4*n+2+4*a.numParticlesPot]=u[0],t[4*n+3+4*a.numParticlesPot]=u[1];const p=1;t[4*n+3+4*a.numParticlesPot*2]=p;const m=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2));c=(c+m)/(m+(a.lifetime+1));const f=function(t){let e=Cm(t),s=Cm(255*t),i=Cm(65025*t),n=Cm(160581375*t);return e-=s/255,s-=i/255,i-=n/255,n-=n/255,[e,s,i,n]}(c);t[4*n+0+4*a.numParticlesPot*3]=f[0],t[4*n+1+4*a.numParticlesPot*3]=f[1],t[4*n+2+4*a.numParticlesPot*3]=f[2],t[4*n+3+4*a.numParticlesPot*3]=f[3]}else t[4*n]=pm.x,t[4*n+1]=pm.y,t[4*n+2]=pm.z,t[4*n+3]=q.lerp(a.startAngle*q.DEG_TO_RAD,a.startAngle2*q.DEG_TO_RAD,r),t[4*n+3+4*a.numParticlesPot]=c}update(t,e,s,i,n,a,r,o){let h,l,c;const d=this._emitter;if(d.meshInstance.node){const t=d.meshInstance.node.worldTransform;for(let e=0;e<12;e++)dm.data[e]=t.data[e];um.copy(dm),um.invert(),lm=d.meshInstance.node.localScale,cm=Math.max(Math.max(lm.x,lm.y),lm.z)}a=null===d.meshInstance.node||d.localSpace?at.ZERO:d.meshInstance.node.getPosition();const u=d.camera?d.camera._node.getPosition():at.ZERO,p=d.useMesh?17:15;let m,f,_,g,y,v,x,b,S;const w=d.precision-1;for(let e=0;e<d.numParticles;e++){const T=Math.floor(d.vbCPU[e*d.numParticleVerts*(d.useMesh?6:4)+3]),M=s[4*T+0+2*d.numParticlesPot*4];fm.x=M,fm.y=s[4*T+1+2*d.numParticlesPot*4],fm.z=s[4*T+2+2*d.numParticlesPot*4];const C=d.rate+(d.rate2-d.rate)*M,A=d.lifetime;let P=s[4*T+3+4*d.numParticlesPot]+r;const E=Am(P/A);let R=0,L=0;const I=0;(P-r<=0||P>=A)&&this.calcSpawnPosition(s,i,n,a,T);let D=P>0&&P<A;D&&(c=E*w,m=Math.floor(c),f=Math.ceil(c),c%=1,h=d.qRotSpeed[m],l=d.qRotSpeed[f],_=h+(l-h)*c,h=d.qRotSpeed2[m],l=d.qRotSpeed2[f],g=h+(l-h)*c,h=d.qScale[m],l=d.qScale[f],R=h+(l-h)*c,h=d.qScale2[m],l=d.qScale2[f],y=h+(l-h)*c,h=d.qAlpha[m],l=d.qAlpha[f],v=h+(l-h)*c,h=d.qAlpha2[m],l=d.qAlpha2[f],x=h+(l-h)*c,h=d.qRadialSpeed[m],l=d.qRadialSpeed[f],b=h+(l-h)*c,h=d.qRadialSpeed2[m],l=d.qRadialSpeed2[f],S=h+(l-h)*c,b+=100*M%1*(S-b),_m.x=s[4*T],_m.y=s[4*T+1],_m.z=s[4*T+2],d.localSpace?bm.copy(_m):bm.copy(_m).sub(a),bm.normalize().mulScalar(b),m*=3,f*=3,h=d.qLocalVelocity[m],l=d.qLocalVelocity[f],ym.x=h+(l-h)*c,h=d.qLocalVelocity[m+1],l=d.qLocalVelocity[f+1],ym.y=h+(l-h)*c,h=d.qLocalVelocity[m+2],l=d.qLocalVelocity[f+2],ym.z=h+(l-h)*c,h=d.qLocalVelocity2[m],l=d.qLocalVelocity2[f],xm.x=h+(l-h)*c,h=d.qLocalVelocity2[m+1],l=d.qLocalVelocity2[f+1],xm.y=h+(l-h)*c,h=d.qLocalVelocity2[m+2],l=d.qLocalVelocity2[f+2],xm.z=h+(l-h)*c,h=d.qVelocity[m],l=d.qVelocity[f],gm.x=h+(l-h)*c,h=d.qVelocity[m+1],l=d.qVelocity[f+1],gm.y=h+(l-h)*c,h=d.qVelocity[m+2],l=d.qVelocity[f+2],gm.z=h+(l-h)*c,h=d.qVelocity2[m],l=d.qVelocity2[f],vm.x=h+(l-h)*c,h=d.qVelocity2[m+1],l=d.qVelocity2[f+1],vm.y=h+(l-h)*c,h=d.qVelocity2[m+2],l=d.qVelocity2[f+2],vm.z=h+(l-h)*c,ym.x+=(xm.x-ym.x)*fm.x,ym.y+=(xm.y-ym.y)*fm.y,ym.z+=(xm.z-ym.z)*fm.z,d.initialVelocity>0&&(1===d.emitterShape?(mm.copy(fm).mulScalar(2).sub(at.ONE).normalize(),ym.add(mm.mulScalar(d.initialVelocity))):ym.add(at.FORWARD.mulScalar(d.initialVelocity))),gm.x+=(vm.x-gm.x)*fm.x,gm.y+=(vm.y-gm.y)*fm.y,gm.z+=(vm.z-gm.z)*fm.z,_+=(g-_)*fm.y,R=(R+1e4*M%1*(y-R))*cm,L=1e3*M%1*(x-v),d.meshInstance.node&&(d.localSpace?(ym.x/=lm.x,ym.y/=lm.y,ym.z/=lm.z):dm.transformPoint(ym,ym)),d.localSpace?(um.transformPoint(gm,gm),ym.add(gm).add(bm)):(ym.add(gm.mul(lm)),ym.add(bm.mul(lm))),Tm.copy(ym),Sm.copy(_m).add(ym.mulScalar(r)),wm.copy(Sm),s[4*T]=wm.x,s[4*T+1]=wm.y,s[4*T+2]=wm.z,s[4*T+3]+=_*r,d.wrap&&d.wrapBounds&&(d.localSpace||wm.sub(a),wm.x=Pm(wm.x,d.wrapBounds.x)-.5*d.wrapBounds.x,wm.y=Pm(wm.y,d.wrapBounds.y)-.5*d.wrapBounds.y,wm.z=Pm(wm.z,d.wrapBounds.z)-.5*d.wrapBounds.z,d.localSpace||wm.add(a)),d.sort>0&&(1===d.sort?(Mm.copy(wm).sub(u),d.particleDistance[T]=-(Mm.x*Mm.x+Mm.y*Mm.y+Mm.z*Mm.z)):2===d.sort?d.particleDistance[T]=P:3===d.sort&&(d.particleDistance[T]=-P))),o?P<0&&(s[4*T+3+2*d.numParticlesPot*4]=-1):(P>=A&&(P-=Math.max(A,(d.numParticles-1)*C),s[4*T+3+2*d.numParticlesPot*4]=d.loop?1:-1),P<0&&d.loop&&(s[4*T+3+2*d.numParticlesPot*4]=1)),s[4*T+3+2*d.numParticlesPot*4]<0&&(D=!1),s[4*T+3+4*d.numParticlesPot]=P;for(let i=0;i<d.numParticleVerts;i++){const n=(e*d.numParticleVerts+i)*(d.useMesh?6:4);let a=d.vbCPU[n],r=d.vbCPU[n+1],o=d.vbCPU[n+2];D||(a=r=o=0);const h=e*d.numParticleVerts*p+i*p;t[h]=wm.x,t[h+1]=wm.y,t[h+2]=wm.z,t[h+3]=E,t[h+4]=d.alignToMotion?I:s[4*T+3],t[h+5]=R,t[h+6]=L,t[h+7]=Tm.x,t[h+8]=a,t[h+9]=r,t[h+10]=o,t[h+11]=Tm.y,t[h+12]=T,t[h+13]=Tm.z,t[h+14]=d.vbCPU[n+3],d.useMesh&&(t[h+15]=d.vbCPU[n+4],t[h+16]=d.vbCPU[n+5])}}if(d.sort>0&&d.camera){const t=d.useMesh?6:4,s=d.particleDistance;for(let i=0;i<d.numParticles;i++)e[i][0]=i,e[i][1]=s[Math.floor(d.vbCPU[i*d.numParticleVerts*t+3])];d.vbOld.set(d.vbCPU),e.sort((function(t,e){return t[1]-e[1]}));for(let s=0;s<d.numParticles;s++){const i=e[s][0]*d.numParticleVerts*t,n=s*d.numParticleVerts*t;for(let e=0;e<d.numParticleVerts*t;e++)d.vbCPU[n+e]=d.vbOld[i+e]}}}}const Lm=new rt,Im=new rt,Dm=new rt;class Om{constructor(t,e){this._emitter=t,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=e.scope.resolve("particleTexIN"),this.constantParticleTexOUT=e.scope.resolve("particleTexOUT"),this.constantEmitterPos=e.scope.resolve("emitterPos"),this.constantEmitterScale=e.scope.resolve("emitterScale"),this.constantSpawnBounds=e.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=e.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=e.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=e.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=e.scope.resolve("initialVelocity"),this.constantFrameRandom=e.scope.resolve("frameRandom"),this.constantDelta=e.scope.resolve("delta"),this.constantRate=e.scope.resolve("rate"),this.constantRateDiv=e.scope.resolve("rateDiv"),this.constantLifetime=e.scope.resolve("lifetime"),this.constantGraphSampleSize=e.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=e.scope.resolve("graphNumSamples"),this.constantInternalTex0=e.scope.resolve("internalTex0"),this.constantInternalTex1=e.scope.resolve("internalTex1"),this.constantInternalTex2=e.scope.resolve("internalTex2"),this.constantInternalTex3=e.scope.resolve("internalTex3"),this.constantEmitterMatrix=e.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=e.scope.resolve("emitterMatrixInv"),this.constantNumParticles=e.scope.resolve("numParticles"),this.constantNumParticlesPot=e.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=e.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=e.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=e.scope.resolve("rotSpeedDivMult"),this.constantSeed=e.scope.resolve("seed"),this.constantStartAngle=e.scope.resolve("startAngle"),this.constantStartAngle2=e.scope.resolve("startAngle2"),this.constantOutBoundsMul=e.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=e.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=e.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=e.scope.resolve("inBoundsCenter"),this.constantMaxVel=e.scope.resolve("maxVel"),this.constantFaceTangent=e.scope.resolve("faceTangent"),this.constantFaceBinorm=e.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(t,e,s,i,n){const a=this._emitter;t.setBlending(!1),t.setColorWrite(!0,!0,!0,!0),t.setCullMode(0),t.setDepthTest(!1),t.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);const r=a.meshInstance.node,o=null===r?at.ONE:r.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let t=a.maxVel*Math.max(Math.max(o.x,o.y),o.z);t=Math.max(t,1),this.constantMaxVel.setValue(t)}const h=null===r||a.localSpace?at.ZERO:r.getPosition(),l=null===r?mt.IDENTITY:r.getWorldTransform();0===a.emitterShape?(Lm.setFromMat4(e),this.constantSpawnBounds.setValue(Lm.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),Im.setFromMat4(l),l.invertTo3x3(Dm),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*q.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*q.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(Im.data),this.constantEmitterMatrixInv.setValue(Dm.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);let c=a.swapTex?a.particleTexOUT:a.particleTexIN;c=a.beenReset?a.particleTexStart:c;const d=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(c),Yr(t,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,n?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",c),a.material.setParameter("particleTexIN",d),a.beenReset=!1,a.swapTex=!a.swapTex,t.setDepthTest(!0),t.setDepthWrite(!0),a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds()}}const Fm=[[-1,-1],[1,-1],[1,1],[-1,1]];function km(t,e,s,i,n=14,a,r){let o=0;r&&7===n&&(o=1);const h=new Mo(t,{width:e,height:s,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ParticleSystemTexture"}),l=h.lock();if(7===n){const t=new Uint8Array(i.length);for(let e=0;e<i.length;e++)t[e]=i[e]*a*255;i=t}return l.set(i),h.unlock(),h}function Bm(t){return Math.max(Math.min(t,1),0)}const zm=new it([0,0,1,0]),Um=new it([0,1,1,1]),Vm=new nt([0,0,1,0],[0,0,1,0],[0,0,1,0]),Nm=new nt([0,1,1,1],[0,1,1,1],[0,1,1,1]);let Wm=2;const Gm=new Float32Array(3),Hm=new mt,Xm=new at,qm=new at,jm=new at;let Ym,Km;function $m(t,e){void 0!==Km[t]&&null!==Km[t]?Ym[t]=Km[t]:Ym[t]=e}function Zm(t,e,s){return(255*t<<16|255*e<<8|255*s)/(1<<24)}function Qm(t,e){const s=t.length/3,i=new Array(4*s);for(let n=0;n<s;n++)i[4*n]=t[3*n],i[4*n+1]=t[3*n+1],i[4*n+2]=t[3*n+2],i[4*n+3]=Zm(e[3*n],e[3*n+1],e[3*n+2]);return i}function Jm(t,e){const s=e.length,i=t.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++){const a=Math.abs(t[n*s+i]);e[i]=Math.max(e[i],a)}}function tf(t,e,s){const i=function(t,e){const s=new Float32Array(t.length);for(let i=0;i<t.length;i++)s[i]=t[i]-e[i];return s}(e,t);return Jm(i,s),function(t,e){const s=e.length,i=t.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++)t[n*s+i]/=0===e[i]?1:e[i],t[n*s+i]*=.5,t[n*s+i]+=.5}(i,s),i}const ef=new Xr;class sf{constructor(t,e){this.graphicsDevice=t;const s=t;this.precision=32,this._addTimeTime=0,Ym=this,Km=e,$m("numParticles",1),this.numParticles>t.maxTextureSize&&(this.numParticles=t.maxTextureSize),$m("rate",1),$m("rate2",this.rate),$m("lifetime",50),$m("emitterExtents",new at(0,0,0)),$m("emitterExtentsInner",new at(0,0,0)),$m("emitterRadius",0),$m("emitterRadiusInner",0),$m("emitterShape",0),$m("initialVelocity",1),$m("wrap",!1),$m("localSpace",!1),$m("screenSpace",!1),$m("wrapBounds",null),$m("colorMap",this.defaultParamTexture),$m("normalMap",null),$m("loop",!0),$m("preWarm",!1),$m("sort",0),$m("mode",0),$m("scene",null),$m("lighting",!1),$m("halfLambert",!1),$m("intensity",1),$m("stretch",0),$m("alignToMotion",!1),$m("depthSoftening",0),$m("mesh",null),$m("particleNormal",new at(0,1,0)),$m("orientation",0),$m("depthWrite",!1),$m("noFog",!1),$m("blendType",2),$m("node",null),$m("startAngle",0),$m("startAngle2",this.startAngle),$m("animTilesX",1),$m("animTilesY",1),$m("animStartFrame",0),$m("animNumFrames",1),$m("animNumAnimations",1),$m("animIndex",0),$m("randomizeAnimIndex",!1),$m("animSpeed",1),$m("animLoop",!0),this._gpuUpdater=new Om(this,s),this._cpuUpdater=new Rm(this),this.constantLightCube=s.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),$m("colorGraph",Nm),$m("colorGraph2",this.colorGraph),$m("scaleGraph",Um),$m("scaleGraph2",this.scaleGraph),$m("alphaGraph",Um),$m("alphaGraph2",this.alphaGraph),$m("localVelocityGraph",Vm),$m("localVelocityGraph2",this.localVelocityGraph),$m("velocityGraph",Vm),$m("velocityGraph2",this.velocityGraph),$m("rotationSpeedGraph",zm),$m("rotationSpeedGraph2",this.rotationSpeedGraph),$m("radialSpeedGraph",zm),$m("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=new Array(6),this.lightCubeDir[0]=new at(-1,0,0),this.lightCubeDir[1]=new at(1,0,0),this.lightCubeDir[2]=new at(0,-1,0),this.lightCubeDir[3]=new at(0,1,0),this.lightCubeDir[4]=new at(0,0,-1),this.lightCubeDir[5]=new at(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!t.supportsGpuParticles,this.pack8=!0,this.localBounds=new bt,this.worldBoundsNoTrail=new bt,this.worldBoundsTrail=[new bt,new bt],this.worldBounds=new bt,this.worldBoundsSize=new at,this.prevWorldBoundsSize=new at,this.prevWorldBoundsCenter=new at,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new at,this.worldBoundsAdd=new at,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return ef.get(this.graphicsDevice,(()=>{const t=16,e=new Float32Array(1024);for(let s=0;s<t;s++)for(let i=0;i<t;i++){const n=i+1-8.5,a=s+1-8.5,r=Bm(1-Bm(Math.sqrt(n*n+a*a)/t)-.5),o=s*t+i;e[4*o]=1,e[4*o+1]=1,e[4*o+2]=1,e[4*o+3]=r}const s=km(this.graphicsDevice,t,t,e,7,1,!0);return s.minFilter=1,s.magFilter=1,s}))}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let t=!1;t=0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):!(this.emitterRadius===this.prevEmitterRadius),t&&this.calculateLocalBounds()}const t=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,t),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const e=this.simTimeTotal;e>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=e+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,t),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,t)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?mt.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let t=Number.MAX_VALUE,e=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,r=0,o=0;const h=this.lifetime/this.precision,l=[this.qVelocity,this.qVelocity2],c=[this.qLocalVelocity,this.qLocalVelocity2],d=[0,0],u=[0,0],p=[0,0],m=[0,0],f=[0,0];let _,g,y;for(let v=0;v<this.precision+1;v++){const x=Math.min(v,this.precision-1);for(let r=0;r<2;r++)_=c[r][3*x+0]*h+d[r],g=c[r][3*x+1]*h+u[r],y=c[r][3*x+2]*h+p[r],t=Math.min(_,t),e=Math.min(g,e),s=Math.min(y,s),i=Math.max(_,i),n=Math.max(g,n),a=Math.max(y,a),d[r]=_,u[r]=g,p[r]=y;for(let t=0;t<2;t++)f[t]+=h*Math.sqrt(l[t][3*x+0]*l[t][3*x+0]+l[t][3*x+1]*l[t][3*x+1]+l[t][3*x+2]*l[t][3*x+2]);m[0]+=this.qRadialSpeed[x]*h,m[1]+=this.qRadialSpeed2[x]*h,r=Math.max(r,Math.max(Math.abs(m[0]),Math.abs(m[1]))),o=Math.max(o,this.qScale[x])}0===this.emitterShape?(_=.5*this.emitterExtents.x,g=.5*this.emitterExtents.y,y=.5*this.emitterExtents.z):(_=this.emitterRadius,g=this.emitterRadius,y=this.emitterRadius);const v=Math.max(f[0],f[1]);qm.x=t-o-_-r-v,qm.y=e-o-g-r-v,qm.z=s-o-y-r-v,jm.x=i+o+_+r+v,jm.y=n+o+g+r+v,jm.z=a+o+y+r+v,this.localBounds.setMinMax(qm,jm)}rebuild(){const t=this.graphicsDevice;if(null===this.colorMap&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||t.maxVertexTextures<=1||t.fragmentUniformsCount<64||t.forceCpuParticles||!t.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,Wm=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh){this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)}this.numParticlesPot=q.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?mt.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let t=0;t<this.numParticles;t++)this.vbToSort[t]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Wm*4);const e=null===this.node||this.localSpace?at.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?Hm.setTRS(at.ZERO,ft.IDENTITY,this.spawnBounds):Hm.setTRS(at.ZERO,this.node.getRotation(),Xm.copy(this.spawnBounds).mul(this.node.localScale)),Gm[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Gm[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Gm[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let t=0;t<this.numParticles;t++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Hm,Gm,e,t),this.useCpu&&(this.particleTex[4*t+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Wm*4);for(let t=0;t<this.particleTexStart.length;t++)this.particleTexStart[t]=this.particleTex[t];this.useCpu||(this.pack8?(this.particleTexIN=km(t,this.numParticlesPot,Wm,this.particleTex,7,1,!1),this.particleTexOUT=km(t,this.numParticlesPot,Wm,this.particleTex,7,1,!1),this.particleTexStart=km(t,this.numParticlesPot,Wm,this.particleTexStart,7,1,!1)):(this.particleTexIN=km(t,this.numParticlesPot,Wm,this.particleTex),this.particleTexOUT=km(t,this.numParticlesPot,Wm,this.particleTex),this.particleTexStart=km(t,this.numParticlesPot,Wm,this.particleTexStart)),this.rtParticleTexIN=new al({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new al({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?"#define LOCAL_SPACE\n":"")+Zr.particleUpdaterInitPS+(this.pack8?Zr.particleInputRgba8PS+Zr.particleOutputRgba8PS:Zr.particleInputFloatPS+Zr.particleOutputFloatPS)+(0===this.emitterShape?Zr.particleUpdaterAABBPS:Zr.particleUpdaterSpherePS)+Zr.particleUpdaterStartPS,i=s+Zr.particleUpdaterRespawnPS+Zr.particleUpdaterEndPS,n=s+Zr.particleUpdaterNoRespawnPS+Zr.particleUpdaterEndPS,a=s+Zr.particleUpdaterOnStopPS+Zr.particleUpdaterEndPS,r=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=co(t,Zr.fullscreenQuadVS,i,"fsQuad0"+r),this.shaderParticleUpdateNoRespawn=co(t,Zr.fullscreenQuadVS,n,"fsQuad1"+r),this.shaderParticleUpdateOnStop=co(t,Zr.fullscreenQuadVS,a,"fsQuad2"+r),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const o=new ec(t);o.vertexBuffer=this.vertexBuffer,o.indexBuffer[0]=this.indexBuffer,o.primitive[0].type=4,o.primitive[0].base=0,o.primitive[0].count=this.numParticles*this.numParticleIndices,o.primitive[0].indexed=!0,this.material=new Fh,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const h=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new Ec(o,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=h,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){const t=this.precision,e=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t);for(let e=0;e<t;e++)this.qRotSpeed[e]*=q.DEG_TO_RAD,this.qRotSpeed2[e]*=q.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=tf(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=tf(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=tf(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=tf(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=tf(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=tf(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=tf(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const t=[0,0,0];Jm(this.qVelocity,t);const e=[0,0,0];Jm(this.qVelocity2,e);const s=[0,0,0];Jm(this.qLocalVelocity,s);const i=[0,0,0];Jm(this.qLocalVelocity2,i);const n=[0];Jm(this.qRadialSpeed,n);const a=[0];Jm(this.qRadialSpeed2,a);let r=Math.max(t[0],e[0]);r=Math.max(r,t[1]),r=Math.max(r,e[1]),r=Math.max(r,t[2]),r=Math.max(r,e[2]);let o=Math.max(s[0],i[0]);o=Math.max(o,s[1]),o=Math.max(o,i[1]),o=Math.max(o,s[2]),o=Math.max(o,i[2]);const h=Math.max(n[0],a[0]);this.maxVel=r+o+h}this.useCpu||(this.internalTex0=km(e,t,1,Qm(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=km(e,t,1,Qm(this.qVelocity,this.qVelocityDiv)),this.internalTex2=km(e,t,1,function(t,e,s,i,n){const a=new Array(4*t.length);for(let r=0;r<t.length;r++)a[4*r]=t[r],a[4*r+1]=e[r],a[4*r+2]=0,a[4*r+3]=Zm(s[r],i[r],n[r]);return a}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=km(e,t,1,function(t,e){const s=new Array(4*t.length);for(let i=0;i<t.length;i++)s[4*i]=t[i],s[4*i+1]=e[i],s[4*i+2]=0,s[4*i+3]=0;return s}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=km(e,t,1,function(t,e){const s=new Array(4*e.length);for(let i=0;i<e.length;i++)s[4*i]=t[3*i],s[4*i+1]=t[3*i+1],s[4*i+2]=t[3*i+2],s[4*i+3]=e[i];return s}(this.qColor,this.qAlpha),7,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const t=this.graphicsDevice.getProgramLibrary(),e=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=e?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const e=this.emitter.inTools,s=t.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!e&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation});this.shader=s},this.material.updateShader()}resetMaterial(){const t=this.material;t.setParameter("stretch",this.stretch),this._isAnimated()&&(t.setParameter("animTexTilesParams",this.animTilesParams),t.setParameter("animTexParams",this.animParams),t.setParameter("animTexIndexParams",this.animIndexParams)),t.setParameter("colorMult",this.intensity),this.useCpu||(t.setParameter("internalTex0",this.internalTex0),t.setParameter("internalTex1",this.internalTex1),t.setParameter("internalTex2",this.internalTex2),t.setParameter("internalTex3",this.internalTex3)),t.setParameter("colorParam",this.colorParam),t.setParameter("numParticles",this.numParticles),t.setParameter("numParticlesPot",this.numParticlesPot),t.setParameter("lifetime",this.lifetime),t.setParameter("rate",this.rate),t.setParameter("rateDiv",this.rate2-this.rate),t.setParameter("seed",this.seed),t.setParameter("scaleDivMult",this.scaleUMax[0]),t.setParameter("alphaDivMult",this.alphaUMax[0]),t.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),t.setParameter("graphNumSamples",this.precision),t.setParameter("graphSampleSize",1/this.precision),t.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),t.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),t.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),t.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,t.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&t.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&t.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&t.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(t.cull=0),this._compParticleFaceParams()}_compParticleFaceParams(){let t,e;if(0===this.orientation)t=new Float32Array([1,0,0]),e=new Float32Array([0,0,1]);else{let s;if(1===this.orientation)s=this.particleNormal.normalize();else{s=(null===this.node?mt.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize()}const i=new at(1,0,0);1===Math.abs(i.dot(s))&&i.set(0,0,1);const n=(new at).cross(s,i).normalize();i.cross(n,s).normalize(),t=new Float32Array([i.x,i.y,i.z]),e=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",t),this.material.setParameter("faceBinorm",e)}_allocate(t){const e=t*this.numParticleVerts,s=t*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==e){if(this.useCpu){const t=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}],i=new Hr(this.graphicsDevice,t);this.vertexBuffer=new Wr(this.graphicsDevice,i,e,1),this.indexBuffer=new ll(this.graphicsDevice,1,s)}else{const t=[{semantic:"ATTR0",components:4,type:6}];this.useMesh&&t.push({semantic:"ATTR1",components:2,type:6});const i=new Hr(this.graphicsDevice,t);this.vertexBuffer=new Wr(this.graphicsDevice,i,e,1),this.indexBuffer=new ll(this.graphicsDevice,1,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,a,r;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),a=n.length/this.mesh.vertexBuffer.numVertices;for(let t=0;t<this.mesh.vertexBuffer.format.elements.length;t++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[t].name){r=this.mesh.vertexBuffer.format.elements[t].offset/4;break}}for(let t=0;t<e;t++){const e=Math.floor(t/this.numParticleVerts);if(this.useMesh){const s=t%this.numParticleVerts;i[6*t]=n[s*a],i[6*t+1]=n[s*a+1],i[6*t+2]=n[s*a+2],i[6*t+3]=e,i[6*t+4]=n[s*a+r+0],i[6*t+5]=1-n[s*a+r+1]}else{const s=t%4;i[4*t]=Fm[s][0],i[4*t+1]=Fm[s][1],i[4*t+2]=0,i[4*t+3]=e}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let o=0;const h=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let e=0;e<t;e++)if(this.useMesh)for(let t=0;t<this.numParticleIndices;t++)h[e*this.numParticleIndices+t]=n[t]+e*this.numParticleVerts;else{const t=4*e;h[o++]=t,h[o++]=t+1,h[o++]=t+2,h[o++]=t,h[o++]=t+2,h[o++]=t+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const t=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=t,this.preWarm&&this.prewarm(this.lifetime)}prewarm(t){const e=t/this.lifetime,s=Math.min(Math.floor(e*this.precision),this.precision),i=t/s;for(let t=0;t<s;t++)this.addTime(i,!1)}resetTime(){this.endTime=function(t){const e=Math.max(t.rate,t.rate2)*t.numParticles+t.lifetime;return Date.now()+1e3*e}(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(t,e){const s=this.graphicsDevice;if(this.simTimeTotal+=t,this.calculateWorldBounds(),this._isAnimated()){const t=this.animTilesParams;t[0]=1/this.animTilesX,t[1]=1/this.animTilesY;const e=this.animParams;e[0]=this.animStartFrame,e[1]=this.animNumFrames*this.animSpeed,e[2]=this.animNumFrames-1,e[3]=this.animNumAnimations-1;const s=this.animIndexParams;s[0]=this.animIndex,s[1]=this.randomizeAnimIndex}let i;this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(Gm[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Gm[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Gm[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Hm.setTRS(at.ZERO,ft.IDENTITY,this.emitterExtents):Hm.setTRS(at.ZERO,this.meshInstance.node.getRotation(),Xm.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));const n=null===this.meshInstance.node?at.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){const s=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(s,this.vbToSort,this.particleTex,Hm,Gm,i,t,e)}else this._gpuUpdater.update(s,Hm,Gm,t,e);this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}const nf=new Set,af={depth:1,flags:2};class rf{constructor(t,e,s){t instanceof il&&(t=$l()),this.app=t,this.device=t.graphicsDevice,this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.mapping=[],this.cameraEntity=null,this.layer=null,this.layerComp=null,this.initLayerComposition(),this._renderTarget=null;const i=this.device;this.clearDepthCommand=new Pc(0,0,(function(){i.clear(af)})),this.width=0,this.height=0,this.resize(e,s)}getSelection(t,e,s,i){const n=this.device;if("object"==typeof t){const n=t;t=n.x,e=n.y,s=n.width,i=n.height}else e=this.renderTarget.height-(e+(i||1));t=Math.floor(t),e=Math.floor(e),s=Math.floor(Math.max(s||1,1)),i=Math.floor(Math.max(i||1,1));const a=n.renderTarget;n.setRenderTarget(this.renderTarget),n.updateBegin();const r=new Uint8Array(4*s*i);n.readPixels(t,e,s,i,r),n.updateEnd(),n.setRenderTarget(a);const o=this.mapping;for(let t=0;t<s*i;t++){const e=r[4*t+0]<<16|r[4*t+1]<<8|r[4*t+2];16777215!==e&&nf.add(o[e])}const h=[];return nf.forEach((t=>h.push(t))),nf.clear(),h}allocateRenderTarget(){const t=new Mo(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new al({colorBuffer:t,depth:!0})}releaseRenderTarget(){this.cameraEntity.camera.renderTarget=null,this._renderTarget&&(this._renderTarget._colorBuffer.destroy(),this._renderTarget.destroy(),this._renderTarget=null)}initLayerComposition(){const t=this.device,e=this,s=t.scope.resolve("uColor");this.cameraEntity=new tm,this.cameraEntity.addComponent("camera"),this.layer=new nu({name:"Picker",shaderPass:18,opaqueSortMode:0,onDrawCall:function(i,n){e.pickColor[0]=(n>>16&255)/255,e.pickColor[1]=(n>>8&255)/255,e.pickColor[2]=(255&n)/255,s.setValue(e.pickColor),t.setBlending(!1),e.mapping[n]=i}}),this.layer.addCamera(this.cameraEntity.camera),this.layerComp=new uu("picker"),this.layerComp.pushOpaque(this.layer)}prepare(t,e,s){t instanceof Ro&&(t=t.node.camera),s instanceof nu&&(s=[s]),this.layer.clearMeshInstances();const i=this.layer.opaqueMeshInstances,n=e.layers.layerList,a=e.layers.subLayerEnabled,r=e.layers.subLayerList;for(let e=0;e<n.length;e++){const o=n[e];if(!(s&&s.indexOf(o)<0)&&(o.enabled&&a[e])){if(o.cameras.indexOf(t)>=0){o._clearDepthBuffer&&i.push(this.clearDepthCommand);const t=r[e]?o.instances.transparentMeshInstances:o.instances.opaqueMeshInstances;for(let e=0;e<t.length;e++){const s=t[e];s.pick&&i.push(s)}}}}this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.updateCamera(t),this.mapping.length=0,this.app.renderComposition(this.layerComp)}updateCamera(t){this.cameraEntity.copy(t.entity),this.cameraEntity.name="PickerCamera";const e=this.cameraEntity.camera;e.copy(t),e.clearColorBuffer=!0,e.clearDepthBuffer=!0,e.clearStencilBuffer=!0,e.clearColor=et.WHITE,e.renderTarget=this.renderTarget,this.layer.clearCameras(),this.layer.addCamera(e),e.layers=[this.layer.id]}resize(t,e){this.width=Math.floor(t),this.height=Math.floor(e)}}class of{constructor(t,e,s){this.device=t,this.inverseBindPose=e,this.boneNames=s}}const hf=[0,0,1,0,0,1,0,0,1,0,0,1],lf=[0,1,3,2,3,1];class cf extends _{constructor(t,e){super(),this._device=t,this._pixelsPerUnit=e&&void 0!==e.pixelsPerUnit?e.pixelsPerUnit:1,this._renderMode=e&&void 0!==e.renderMode?e.renderMode:0,this._atlas=e&&void 0!==e.atlas?e.atlas:null,this._frameKeys=e&&void 0!==e.frameKeys?e.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(t){this._frameKeys=t,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",t)}get frameKeys(){return this._frameKeys}set atlas(t){t!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=t,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",t))}get atlas(){return this._atlas}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,this.fire("set:pixelsPerUnit",t),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(t){if(this._renderMode===t)return;const e=this._renderMode;this._renderMode=t,this.fire("set:renderMode",t),0!==e&&0!==t||this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){const t=this._meshes.length;for(let e=0;e<t;e++){const t=this._meshes[e];t&&t.destroy()}const e=this._frameKeys.length;this._meshes=new Array(e);const s=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(let t=0;t<e;t++){const e=this._atlas.frames[this._frameKeys[t]];this._meshes[t]=e?s.call(this,e):null}this.fire("set:meshes")}_createSimpleMesh(t){const e=t.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=e.z/this._pixelsPerUnit,a=e.w/this._pixelsPerUnit,r=t.pivot.x,o=t.pivot.y,h=[-r*n,-o*a,0,(1-r)*n,-o*a,0,(1-r)*n,(1-o)*a,0,-r*n,(1-o)*a,0],l=e.x/s,c=1-e.y/i,d=(e.x+e.z)/s,u=1-(e.y+e.w)/i,p=[l,c,d,c,d,u,l,u];return ac(this._device,h,{uvs:p,normals:hf,indices:lf})}_create9SliceMesh(){const t=ot.ONE,e=[],s=[],i=[],n=[];let a=0;for(let r=0;r<=3;r++){const o=0===r||3===r?0:1;for(let h=0;h<=3;h++){const l=-t.x+2*t.x*(r<=1?0:3)/3,c=0,d=-(-t.y+2*t.y*(h<=1?0:3)/3),u=0===h||3===h?0:1;e.push(-l,c,d),s.push(0,1,0),i.push(o,u),r<3&&h<3&&(n.push(a+3+1,a+1,a),n.push(a+3+1,a+3+2,a+1)),a++}}const r={normals:s,uvs:i,indices:n};return ac(this._device,e,r)}_onSetFrames(t){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(t,e){const s=this._frameKeys.indexOf(t);s<0||(e?0===this.renderMode&&(this._meshes[s]=this._createSimpleMesh(e)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(t){const e=this._frameKeys.indexOf(t);e<0||(this._meshes[e]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const t of this._meshes)t&&t.destroy();this._meshes.length=0}}class df{constructor(t){this.func=void 0===t.func?7:t.func,this.ref=t.ref||0,this.readMask=void 0===t.readMask?255:t.readMask,this.writeMask=void 0===t.writeMask?255:t.writeMask,this.fail=t.fail||0,this.zfail=t.zfail||0,this.zpass=t.zpass||0}clone(){return new df({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})}}class uf extends _{constructor(){super(),this._texture=null,this._frames=null}set texture(t){this._texture=t,this.fire("set:texture",t)}get texture(){return this._texture}set frames(t){this._frames=t,this.fire("set:frames",t)}get frames(){return this._frames}setFrame(t,e){let s=this._frames[t];s?(s.rect.copy(e.rect),s.pivot.copy(e.pivot),s.border.copy(e.border)):(s={rect:e.rect.clone(),pivot:e.pivot.clone(),border:e.border.clone()},this._frames[t]=s),this.fire("set:frame",t.toString(),s)}removeFrame(t){const e=this._frames[t];e&&(delete this._frames[t],this.fire("remove:frame",t.toString(),e))}destroy(){this._texture&&this._texture.destroy()}}class pf{constructor(t,e,s,i){this.time=t,this.position=e,this.rotation=s,this.scale=i}}class mf{constructor(){this._name="",this._keys=[]}}class ff{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(t){return this._nodeDict[t]}addNode(t){this._nodes.push(t),this._nodeDict[t._name]=t}get nodes(){return this._nodes}}class _f{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new ft,this._pos=new at,this._scale=new at,this._targetNode=null}getTarget(){return this._targetNode}setTarget(t){this._targetNode=t}}class gf{constructor(t){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const e=t=>{const s=new _f;s._name=t.name,this._interpolatedKeys.push(s),this._interpolatedKeyDict[t.name]=s,this._currKeyIndices[t.name]=0;for(let s=0;s<t._children.length;s++)e(t._children[s])};e(t)}set animation(t){this._animation=t,this.currentTime=0}get animation(){return this._animation}set currentTime(t){this._time=t;const e=this._interpolatedKeys.length;for(let t=0;t<e;t++){const e=this._interpolatedKeys[t]._name;this._currKeyIndices[e]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(t){if(null!==this._animation){const e=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=t,this._time>s){this._time=this.looping?0:s;for(let t=0;t<e.length;t++){const s=e[t]._name;this._currKeyIndices[s]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let t=0;t<e.length;t++){const s=e[t],i=s._name;this._currKeyIndices[i]=s._keys.length-2}}const i=t>=0?1:-1;for(let t=0;t<e.length;t++){const s=e[t],n=s._name,a=s._keys,r=this._interpolatedKeyDict[n];if(void 0===r)continue;let o=!1;if(1!==a.length)for(let t=this._currKeyIndices[n];t<a.length-1&&t>=0;t+=i){const e=a[t],s=a[t+1];if(e.time<=this._time&&s.time>=this._time){const i=(this._time-e.time)/(s.time-e.time);r._pos.lerp(e.position,s.position,i),r._quat.slerp(e.rotation,s.rotation,i),r._scale.lerp(e.scale,s.scale,i),r._written=!0,this._currKeyIndices[n]=t,o=!0;break}}(1===a.length||!o&&0===this._time&&this.looping)&&(r._pos.copy(a[0].position),r._quat.copy(a[0].rotation),r._scale.copy(a[0].scale),r._written=!0)}}}blend(t,e,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const i=t._interpolatedKeys[n],a=e._interpolatedKeys[n],r=this._interpolatedKeys[n];i._written&&a._written?(r._quat.slerp(i._quat,e._interpolatedKeys[n]._quat,s),r._pos.lerp(i._pos,e._interpolatedKeys[n]._pos,s),r._scale.lerp(i._scale,a._scale,s),r._written=!0):i._written?(r._quat.copy(i._quat),r._pos.copy(i._pos),r._scale.copy(i._scale),r._written=!0):a._written&&(r._quat.copy(a._quat),r._pos.copy(a._pos),r._scale.copy(a._scale),r._written=!0)}}setGraph(t){if(this.graph=t,t)for(let e=0;e<this._interpolatedKeys.length;e++){const s=this._interpolatedKeys[e],i=t.findByName(s._name);this._interpolatedKeys[e].setTarget(i)}else for(let t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)}updateGraph(){if(this.graph)for(let t=0;t<this._interpolatedKeys.length;t++){const e=this._interpolatedKeys[t];if(e._written){const t=e.getTarget();t.localPosition.copy(e._pos),t.localRotation.copy(e._quat),t.localScale.copy(e._scale),t._dirtyLocal||t._dirtifyLocal(),e._written=!1}}}}const yf=0,vf=1,xf=2;class bf{static joinPath(t,e){e=e||".";return t.map((function(t){return t.replace(/\\/g,"\\\\").replace(new RegExp("\\"+e,"g"),"\\"+e)})).join(e)}static splitPath(t,e){e=e||".";const s=[];let i="",n=0;for(;n<t.length;){let a=t[n++];"\\"===a&&n<t.length?(a=t[n++],i+="\\"===a||a===e?a:"\\"+a):a===e?(s.push(i),i=""):i+=a}return i.length>0&&s.push(i),s}static encode(t,e,s){return`${Array.isArray(t)?t.join("/"):t}/${e}/${Array.isArray(s)?s.join("/"):s}`}resolve(t){return null}unresolve(t){}update(t){}}function Sf(){return Sf=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t},Sf.apply(this,arguments)}class wf{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(t,e){if(t<this._left||t>=this._right){const s=e.length;if(s)if(t<e[0])this._left=-1/0,this._right=e[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(t>=e[s-1])this._left=e[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(t,e);this._left=e[s],this._right=e[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(t-this._left)*this._recip,this._hermite.valid=!1}_findKey(t,e){let s=0;for(;t>=e[s+1];)s++;return s}eval(t,e,s){const i=s._data,n=s._components,a=this._p0*n;if(0===e)for(let e=0;e<n;++e)t[e]=i[a+e];else{const s=this._t,r=this._p1*n;switch(e){case 1:for(let e=0;e<n;++e)t[e]=q.lerp(i[a+e],i[r+e],s);break;case 2:{const e=this._hermite;if(!e.valid){const t=s*s,i=s+s,n=1-s,a=n*n;e.valid=!0,e.p0=(1+i)*a,e.m0=s*a,e.p1=t*(3-i),e.m1=t*(s-1)}const a=(3*this._p0+1)*n,r=(3*this._p0+2)*n,o=(3*this._p1+1)*n,h=(3*this._p1+0)*n;for(let s=0;s<n;++s)t[s]=e.p0*i[a+s]+e.m0*i[r+s]*this._len+e.p1*i[o+s]+e.m1*i[h+s]*this._len;break}}}}}class Tf{constructor(t){this._name=t.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let e=0;e<t._inputs.length;++e)this._cache[e]=new wf;const e=t._curves,s=t._outputs;for(let t=0;t<e.length;++t){const i=s[e[t]._output],n=[];for(let t=0;t<i._components;++t)n[t]=0;this._results[t]=n}}}class Mf{constructor(t,e,s,i,n,a){for(this._name=t.name,this._track=t,this._snapshot=new Tf(t),this._playing=i,this._time=e,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this._eventCursor=0;this._track.events[this._eventCursor]&&this._track.events[this._eventCursor].time<this.time;)this._eventCursor++}set name(t){this._name=t}get name(){return this._name}get track(){return this._track}get snapshot(){return this._snapshot}set time(t){this._time=t}get time(){return this._time}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}set blendWeight(t){this._blendWeight=t}get blendWeight(){return this._blendWeight}set blendOrder(t){this._blendOrder=t}get blendOrder(){return this._blendOrder}set eventCursor(t){this._eventCursor=t}get eventCursor(){return this._eventCursor}activeEventsForFrame(t,e){let s;for(0===t&&(this.eventCursor=0),e>this.track.duration&&(s=e-this.track.duration,e=this.track.duration);this.track.events[this.eventCursor]&&this.track.events[this.eventCursor].time>=t&&(e===this.track.duration?this.track.events[this.eventCursor].time<=e:this.track.events[this.eventCursor].time<e);){const t=this.track.events[this.eventCursor];this._eventHandler.fire(t.name,Sf({track:this.track},t)),this.eventCursor++}Number.isFinite(s)&&this.activeEventsForFrame(0,s)}_update(t){if(this._playing){let e=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(e,e+i*t),e+=i*t,i>=0?e>s&&(n?e=e%s||0:(e=this._track.duration,this.pause())):e<0&&(n?e=s+(e%s||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}class Cf{constructor(t,e,s,i){this._paths=t,this._input=e,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class Af{constructor(t,e){this._components=t,this._data=e}get components(){return this._components}get data(){return this._data}}const Pf="NONE",Ef="PREV_STATE",Rf="NEXT_STATE",Lf="PREV_STATE_NEXT_STATE",If="NEXT_STATE_PREV_STATE",Df="GREATER_THAN",Of="LESS_THAN",Ff="GREATER_THAN_EQUAL_TO",kf="LESS_THAN_EQUAL_TO",Bf="EQUAL_TO",zf="NOT_EQUAL_TO",Uf="INTEGER",Vf="FLOAT",Nf="BOOLEAN",Wf="TRIGGER",Gf="1D",Hf="2D_DIRECTIONAL",Xf="2D_CARTESIAN",qf="DIRECT",jf="START",Yf="END",Kf="ANY",$f=["START","END","ANY"],Zf="OVERWRITE",Qf="ADDITIVE";class Jf{constructor(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=e===Jf.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(t){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[t]?0:this._normalizeWeights?this.weights[t]/this.totalWeight:q.clamp(this.weights[t],0,1)}_layerBlendType(t){return this._component.layers[t].blendType}setMask(t,e){this.mask[t]=e,this._normalizeWeights&&("OVERWRITE"===this._component.layers[t].blendType&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1}updateValue(t,e){if(0===this.counter&&(t_._set(this.value,Jf.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||t_._blend(this.value,this.baseValue,1,this.valueType)),this.mask[t]&&0!==this.getWeight(t)){if("ADDITIVE"!==this._layerBlendType(t)||this._normalizeWeights)t_._blend(this.value,e,this.getWeight(t),this.valueType);else if(this.valueType===Jf.TYPE_QUAT){const s=Jf.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=Jf.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=Jf.q3.set(e[0],e[1],e[2],e[3]),a=i.invert().mul(n);a.slerp(ft.IDENTITY,a,this.getWeight(t)),s.mul(a),Jf.quatArr[0]=s.x,Jf.quatArr[1]=s.y,Jf.quatArr[2]=s.z,Jf.quatArr[3]=s.w,t_._set(this.value,Jf.quatArr,this.valueType)}else Jf.vecArr[0]=e[0]-this.baseValue[0],Jf.vecArr[1]=e[1]-this.baseValue[1],Jf.vecArr[2]=e[2]-this.baseValue[2],t_._blend(this.value,Jf.vecArr,this.getWeight(t),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this._normalizeWeights||this.setter(this.baseValue)}}Jf.TYPE_QUAT="quaternion",Jf.TYPE_VEC3="vector3",Jf.q1=new ft,Jf.q2=new ft,Jf.q3=new ft,Jf.quatArr=[0,0,0,1],Jf.vecArr=[0,0,0],Jf.IDENTITY_QUAT_ARR=[0,0,0,1];class t_{constructor(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}static _dot(t,e){const s=t.length;let i=0;for(let n=0;n<s;++n)i+=t[n]*e[n];return i}static _normalize(t){let e=t_._dot(t,t);if(e>0){e=1/Math.sqrt(e);const s=t.length;for(let i=0;i<s;++i)t[i]*=e}}static _set(t,e,s){const i=t.length;if("quaternion"===s){let s=t_._dot(e,e);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)t[n]=e[n]*s}else for(let s=0;s<i;++s)t[s]=e[s]}static _blendVec(t,e,s,i){const n=i?1:1-s,a=t.length;for(let i=0;i<a;++i)t[i]=t[i]*n+e[i]*s}static _blendQuat(t,e,s,i){const n=t.length,a=i?1:1-s;t_._dot(t,e)<0&&(s=-s);for(let i=0;i<n;++i)t[i]=t[i]*a+e[i]*s;i||t_._normalize(t)}static _blend(t,e,s,i,n){"quaternion"===i?t_._blendQuat(t,e,s,n):t_._blendVec(t,e,s,n)}static _stableSort(t,e){const s=t.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(e(t[n],t[i])){const e=t[i];t[i]=t[n],t[n]=e}}addClip(t){const e=this._targets,s=this._binder,i=t.track.curves,n=t.snapshot,a=[],r=[];for(let t=0;t<i.length;++t){const o=i[t].paths;for(let i=0;i<o.length;++i){const h=o[i],l=s.resolve(h);let c=e[l&&l.targetPath||null];if(!c&&l){c={target:l,value:[],curves:0,blendCounter:0};for(let t=0;t<c.target.components;++t)c.value.push(0);if(e[l.targetPath]=c,s.animComponent){if(!s.animComponent.targets[l.targetPath]){let t;t="localRotation"===l.targetPath.substring(l.targetPath.length-13)?Jf.TYPE_QUAT:Jf.TYPE_VEC3,s.animComponent.targets[l.targetPath]=new Jf(s.animComponent,t)}s.animComponent.targets[l.targetPath].layerCounter++,s.animComponent.targets[l.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,a.push(n._results[t]),r.push(c))}}this._clips.push(t),this._inputs.push(a),this._outputs.push(r)}removeClip(t){const e=this._targets,s=this._binder,i=this._clips,n=i[t].track.curves;for(let t=0;t<n.length;++t){const i=n[t].paths;for(let t=0;t<i.length;++t){const n=i[t],a=this._binder.resolve(n);a&&(a.curves--,0===a.curves&&(s.unresolve(n),delete e[a.targetPath],s.animComponent&&s.animComponent.targets[a.targetPath].layerCounter--))}}i.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}findClip(t){const e=this._clips;for(let s=0;s<e.length;++s){const i=e[s];if(i.name===t)return i}return null}rebind(){this._binder.rebind(),this._targets={};const t=[...this.clips];this.removeClips(),t.forEach((t=>{this.addClip(t)}))}assignMask(t){return this._binder.assignMask(t)}update(t){const e=this._clips,s=e.map((function(t,e){return e}));t_._stableSort(s,(function(t,s){return e[t].blendOrder<e[s].blendOrder}));for(let i=0;i<s.length;++i){const n=s[i],a=e[n],r=this._inputs[n],o=this._outputs[n],h=a.blendWeight;let l,c,d;if(h>0&&a._update(t),h>=1)for(let t=0;t<r.length;++t)l=r[t],c=o[t],d=c.value,t_._set(d,l,c.target.type),c.blendCounter++;else if(h>0)for(let t=0;t<r.length;++t)l=r[t],c=o[t],d=c.value,0===c.blendCounter?t_._set(d,l,c.target.type):t_._blend(d,l,h,c.target.type),c.blendCounter++}const i=this._targets,n=this._binder;for(const t in i)if(i.hasOwnProperty(t)){const e=i[t];if(n.animComponent&&e.target.isTransform){const s=n.animComponent.targets[t];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=t,s.baseValue=e.target.get(),s.setter=e.target.set),s.updateValue(n.layerIndex,e.value),s.counter++}else e.target.set(e.value);e.blendCounter=0}n.update(t)}}class e_{constructor(t,e,s,i){t.set?(this._set=t.set,this._get=t.get):this._set=t,this._type=e,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class s_{constructor(t){this._events=[...t],this._events.sort(((t,e)=>t.time-e.time))}get events(){return this._events}}class i_{constructor(t,e,s,i,n,a=new s_([])){this._name=t,this._duration=e,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=a}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(t){this._animEvents=t}get events(){return this._animEvents.events}eval(t,e){e._time=t;const s=this._inputs,i=this._outputs,n=this._curves,a=e._cache,r=e._results;for(let e=0;e<s.length;++e)a[e].update(t,s[e]._data);for(let t=0;t<n.length;++t){const e=n[t],s=i[e._output],o=r[t];a[e._input].eval(o,e._interpolation,s)}}}class n_{constructor(t){if(this._isPathInMask=(t,e)=>{const s=this._mask[t];return!!s&&!!(s.children||e&&!1!==s.value)},this.graph=t,!t)return;this._mask=null;const e={};!function t(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e])}(t),this.nodes=e,this.targetCache={};const s=function(t){let e,s=t;for(;s&&!(s instanceof tm);)s=s.parent;return s&&(s.render?e=s.render.meshInstances:s.model&&(e=s.model.meshInstances)),e};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(t){const e=t.localPosition;return n_.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localPosition")},localRotation:function(t){const e=t.localRotation;return n_.createAnimTarget((function(t){e.set(...t)}),"quaternion",4,t,"localRotation")},localScale:function(t){const e=t.localScale;return n_.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localScale")},weights:function(t){const e=s(t);if(e){const s=[];for(let i=0;i<e.length;++i)e[i].node.name===t.name&&e[i].morphInstance&&s.push(e[i].morphInstance);if(s.length>0){const e=function(t){for(let e=0;e<t.length;++e)for(let i=0;i<s.length;i++)s[i].setWeight(e,t[e])};return n_.createAnimTarget(e,"vector",s[0].morph._targets.length,t,"weights")}}return null},materialTexture:(t,e)=>{const i=s(t);if(i){let s;for(let e=0;e<i.length;++e)if(i[e].node.name===t.name){s=i[e];break}if(s){const i=t=>{const i=this.animComponent.system.app.assets.get(t[0]);i&&i.resource&&"texture"===i.type&&(s.material[e]=i.resource,s.material.update())};return n_.createAnimTarget(i,"vector",1,t,"materialTexture","material")}}return null}}}_isPathActive(t){if(!this._mask)return!0;const e=[t.entityPath[0],this.graph.name];for(let s=0;s<e.length;++s){let i=e[s];if(this._isPathInMask(i,1===t.entityPath.length))return!0;for(let e=1;e<t.entityPath.length;e++)if(i+="/"+t.entityPath[e],this._isPathInMask(i,e===t.entityPath.length-1))return!0}return!1}findNode(t){if(!this._isPathActive(t))return null;let e;return this.graph&&(e=this.graph.findByPath(t.entityPath)),e||(e=this.nodes[t.entityPath[t.entityPath.length-1]||""]),e}static createAnimTarget(t,e,s,i,n,a){const r=bf.encode(i.path,a||"entity",n);return new e_(t,e,s,r)}resolve(t){const e=bf.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;const i=this.findNode(t);if(!i)return null;const n=this.handlers[t.propertyPath];return n?(s=n(i),s?(this.targetCache[e]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(t){if("graph"!==t.component)return;const e=this.nodes[t.entityPath[t.entityPath.length-1]||""];if(this.nodeCounts[e.path]--,0===this.nodeCounts[e.path]){const t=this.activeNodes,s=t.indexOf(e.node),i=t.length;s<i-1&&(t[s]=t[i-1]),t.pop()}}update(t){const e=this.activeNodes;for(let t=0;t<e.length;++t)e[t]._dirtifyLocal()}assignMask(t){return t!==this._mask&&(this._mask=t,!0)}}class a_{constructor(t,e,s,i,n=1){this._state=t,this._parent=e,this._name=s,Array.isArray(i)?(this._point=new ot(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(t){this._weight=t}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const t=this._state.totalWeight;return 0===t?0:this.weight/t}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(t){this._weightedSpeed=t}get weightedSpeed(){return this._weightedSpeed}set animTrack(t){this._animTrack=t}get animTrack(){return this._animTrack}}class r_ extends a_{constructor(t,e,s,i,n,a,r,o,h){super(t,e,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=h,this._syncAnimations=!1!==r,this._pointCache={};for(let e=0;e<a.length;e++){const i=a[e];i.children?this._children.push(o(i.type,this,null,s,1,i.parameter?[i.parameter]:i.parameters,i.children,o,h)):this._children.push(new a_(t,this,i.name,i.point,i.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(t){for(let e=0;e<this._children.length;e++)if(this._children[e].name===t)return this._children[e];return null}updateParameterValues(){let t=!0;for(let e=0;e<this._parameterValues.length;e++){const s=this._findParameter(this._parameters[e]).value;this._parameterValues[e]!==s&&(this._parameterValues[e]=s,t=!1)}return t}getNodeWeightedDuration(t){return this._children[t].animTrack.duration/this._children[t].speedMultiplier*this._children[t].weight}getNodeCount(){let t=0;for(let e=0;e<this._children.length;e++){this._children[e].constructor===r_?t+=this._children[e].getNodeCount():t++}return t}}class o_ extends r_{constructor(t,e,s,i,n,a,r,o,h){a.sort(((t,e)=>t.point-e.point)),super(t,e,s,i,n,a,r,o,h)}calculateWeights(){if(this.updateParameterValues())return;let t=0;this._children[0].weight=0;for(let e=0;e<this._children.length;e++){const s=this._children[e];if(e!==this._children.length-1){const t=this._children[e+1];if(s.point===t.point)s.weight=.5,t.weight=.5;else if(q.between(this._parameterValues[0],s.point,t.point,!0)){const e=Math.abs(s.point-t.point),i=(e-Math.abs(s.point-this._parameterValues[0]))/e;s.weight=i,t.weight=1-i}else t.weight=0}this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let e=0;e<this._children.length;e++){const s=this._children[e];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t}}}class h_ extends r_{pointDistanceCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;h_._p.set(...this._parameterValues),t=0,e=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;h_._pip.set(h_._p.x,h_._p.y).sub(n);let a=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(s===t)continue;const e=this.pointDistanceCache(s,t),i=q.clamp(1-h_._pip.dot(e)/e.lengthSq(),0,1);i<a&&(a=i)}i.weight=a,t+=a,this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}h_._p=new ot,h_._pip=new ot;class l_ extends r_{pointCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=new ot((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),2*ot.angleRad(this._children[t].point,this._children[e].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;l_._p.set(...this._parameterValues);const s=l_._p.length();t=0,e=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],a=n.point,r=n.pointLength;let o=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(i===t)continue;const e=this.pointCache(i,t),n=this._children[t].pointLength;l_._pip.set((s-r)/((n+r)/2),2*ot.angleRad(a,l_._p));const h=q.clamp(1-Math.abs(l_._pip.dot(e)/e.lengthSq()),0,1);h<o&&(o=h)}n.weight=o,t+=o,this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.weight=i._weight/t,this._syncAnimations){const s=i.animTrack.duration/e*t;i.weightedSpeed=i.absoluteSpeed*s}}}}l_._p=new ot,l_._pip=new ot;class c_ extends r_{calculateWeights(){if(this.updateParameterValues())return;let t=0,e=0;for(let s=0;s<this._children.length;s++)if(t+=Math.max(this._parameterValues[s],0),this._syncAnimations){const t=this._children[s];e+=t.animTrack.duration/t.absoluteSpeed*t.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);t?(i.weight=n/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class d_{constructor(t,e,s,i,n){this._controller=t,this._name=e,this._animations={},this._animationList=[],this._speed=s||1,this._loop=void 0===i||i;const a=this._controller.findParameter.bind(this._controller);this._blendTree=n?this._createTree(n.type,this,null,e,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,a):new a_(this,null,e,1,s)}_createTree(t,e,s,i,n,a,r,o,h,l){switch(t){case"1D":return new o_(e,s,i,n,a,r,o,h,l);case"2D_CARTESIAN":return new h_(e,s,i,n,a,r,o,h,l);case"2D_DIRECTIONAL":return new l_(e,s,i,n,a,r,o,h,l);case"DIRECT":return new c_(e,s,i,n,a,r,o,h,l)}}_getNodeFromPath(t){let e=this._blendTree;for(let s=1;s<t.length;s++)e=e.getChild(t[s]);return e}addAnimation(t,e){const s=t.join("."),i=this._animationList.findIndex((function(t){return t.path===s}));if(i>=0)this._animationList[i].animTrack=e;else{const s=this._getNodeFromPath(t);s.animTrack=e,this._animationList.push(s)}}get name(){return this._name}set animations(t){this._animationList=t}get animations(){return this._animationList}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==a_?this._blendTree.getNodeCount():1}get playable(){return-1!==$f.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const t=this.name+"."+this.animations[0].animTrack.name,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}get totalWeight(){let t=0;for(let e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}get timelineDuration(){let t=0;for(let e=0;e<this.animations.length;e++){const s=this.animations[e];s.animTrack.duration>t&&(t=s.animTrack.duration)}return t}}class u_{constructor({from:t,to:e,time:s=0,priority:i=0,conditions:n=[],exitTime:a=null,transitionOffset:r=null,interruptionSource:o="NONE"}){this._from=t,this._to=e,this._time=s,this._priority=i,this._conditions=n,this._exitTime=a,this._transitionOffset=r,this._interruptionSource=o}get from(){return this._from}set to(t){this._to=t}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class p_{constructor(t,e,s,i,n,a,r){this._animEvaluator=t,this._states={},this._stateNames=[],this._eventHandler=a,this._consumedTriggers=r;for(let t=0;t<e.length;t++)this._states[e[t].name]=new d_(this,e[t].name,e[t].speed,e[t].loop,e[t].blendTree),this._stateNames.push(e[t].name);this._transitions=s.map((t=>new u_(Sf({},t)))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=i,this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._activate=n,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource="NONE",this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(t){this._activeStateName=t}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(t){this._previousStateName=t}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let t=!0;for(let e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}set playing(t){this._playing=t}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if("START"===this.activeStateName||"END"===this.activeStateName)return 0;let t=0;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this._animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(t=Math.max(t,s.track.duration))}return t}set activeStateCurrentTime(t){this._timeInStateBefore=t,this._timeInState=t;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this.animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(s.time=t)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(t){return this._animEvaluator.assignMask(t)}_findState(t){return this._states[t]}_getActiveStateProgressForTime(t){if("START"===this.activeStateName||"END"===this.activeStateName||"ANY"===this.activeStateName)return 1;const e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?t/e.track.duration:null}_findTransitionsFromState(t){let e=this._findTransitionsFromStateCache[t];return e||(e=this._transitions.filter((function(e){return e.from===t})),ou(e),this._findTransitionsFromStateCache[t]=e),e}_findTransitionsBetweenStates(t,e){let s=this._findTransitionsBetweenStatesCache[t+"->"+e];return s||(s=this._transitions.filter((function(s){return s.from===t&&s.to===e})),ou(s),this._findTransitionsBetweenStatesCache[t+"->"+e]=s),s}_transitionHasConditionsMet(t){const e=t.conditions;for(let t=0;t<e.length;t++){const s=e[t],i=this.findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(i.value>s.value))return!1;break;case"LESS_THAN":if(!(i.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(i.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(i.value<=s.value))return!1;break;case"EQUAL_TO":if(i.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(i.value===s.value)return!1}}return!0}_findTransition(t,e){let s=[];if(t&&e)s=s.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState("ANY"))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));if(s=s.filter((t=>{if(t.to===this.activeStateName)return!1;if(t.hasExitTime){let e=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(t.exitTime<1&&this.activeState.loop&&(e-=Math.floor(e),s-=Math.floor(s)),!(t.exitTime>e&&t.exitTime<=s))return null}return this._transitionHasConditionsMet(t)})),s.length>0){const t=s[0];if("END"===t.to){const e=this._findTransitionsFromState("START")[0];t.to=e.to}return t}return null}updateStateFromTransition(t){let e,s,i;this.previousState=t.from?this.activeStateName:null,this.activeState=t.to;for(let e=0;e<t.conditions.length;e++){const s=t.conditions[e];"TRIGGER"===this.findParameter(s.parameterName).type&&this._consumedTriggers.add(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const t=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-t:this._transitionPreviousStates[n].weight=t:this._transitionPreviousStates[n].weight=1,e=this._findState(this._transitionPreviousStates[n].name);for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name+".previous."+n),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+n),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;const n=this.activeState,a=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;let r=0,o=0;if(a){const e=n.timelineDuration*t.transitionOffset;r=e,o=e}this._timeInState=r,this._timeInStateBefore=o;for(let e=0;e<n.animations.length;e++){if(i=this._animEvaluator.findClip(n.animations[e].name),i)i.reset();else{const t=Number.isFinite(n.animations[e].speed)?n.animations[e].speed:n.speed;i=new Mf(n.animations[e].animTrack,this._timeInState,t,!0,n.loop,this._eventHandler),i.name=n.animations[e].name,this._animEvaluator.addClip(i)}if(t.time>0?i.blendWeight=0:i.blendWeight=n.animations[e].normalizedWeight,i.play(),a)i.time=n.timelineDuration*t.transitionOffset;else{const t=n.speed>=0?0:this.activeStateDuration;i.time=t}}}_transitionToState(t){if(!this._findState(t))return;let e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new u_({from:null,to:t})),this.updateStateFromTransition(e)}assignAnimation(t,e,s,i){const n=t.split(".");let a=this._findState(n[0]);a||(a=new d_(this,n[0],1),this._states[n[0]]=a,this._stateNames.push(n[0])),a.addAnimation(n,e),void 0!==s&&(a.speed=s),void 0!==i&&(a.loop=i),!this._playing&&this._activate&&this.playable&&this.play()}removeNodeAnimations(t){if(-1!==$f.indexOf(t))return!1;const e=this._findState(t);return!!e&&(e.animations=[],!0)}play(t){t&&this._transitionToState(t),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(t){if(!this._playing)return;let e,s,i;this._timeInStateBefore=this._timeInState,this._timeInState+=t;const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){const t=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){e=this._findState(this._transitionPreviousStates[n].name);const a=this._transitionPreviousStates[n].weight;for(let r=0;r<e.animations.length;r++)s=e.animations[r],i=this._animEvaluator.findClip(s.name+".previous."+n),i&&(i.blendWeight=(1-t)*s.normalizedWeight*a)}e=this.activeState;for(let i=0;i<e.animations.length;i++)s=e.animations[i],this._animEvaluator.findClip(s.name).blendWeight=t*s.normalizedWeight}else{this._isTransitioning=!1;const t=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let e=0;e<n-t;e++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==a_){e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(t)}findParameter(t){return this._parameters[t]}}class m_{constructor(t){if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(const e in t.layers){const s=t.layers[e],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let e=0;e<s.states.length;e++)i.states.push(t.states[s.states[e]]);for(let e=0;e<s.transitions.length;e++){const n=t.transitions[s.transitions[e]];if(n.conditions&&!Array.isArray(n.conditions)){const t=Object.keys(n.conditions),e=[];for(let s=0;s<t.length;s++){const i=n.conditions[t[s]];i.parameterName&&e.push(i)}n.conditions=e}Number.isInteger(n.from)&&(n.from=t.states[n.from].name),Number.isInteger(n.to)&&(n.to=t.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const e in t.parameters){const s=t.parameters[e];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}const f_="msdf",__="bitmap";class g_{constructor(t,e){this.type=e&&e.type||"msdf",this.em=1,this.textures=t,this.intensity=0,this._data=null,this.data=e}set data(t){if(this._data=t,t&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const t in this._data.chars)this._data.chars[t].map=0}get data(){return this._data}}class y_ extends _{constructor(t,e={}){super(),this.type="bitmap",this.app=t,this.intensity=0,this.fontWeight=e.fontWeight||"normal",this.fontSize=parseInt(e.fontSize,10),this.glyphSize=this.fontSize,this.fontName=e.fontName||"Arial",this.color=e.color||new et(1,1,1),this.padding=e.padding||0;const s=e.width>4096?4096:e.width||512,i=e.height>4096?4096:e.height||512,n=document.createElement("canvas");n.height=i,n.width=s;const a=new Mo(this.app.graphicsDevice,{name:"font",format:7,minFilter:5,magFilter:1,addressU:1,addressV:1,mipmaps:!0});a.setSource(n),this.textures=[a],this.chars="",this.data={}}createTextures(t){const e=this._normalizeCharsSet(t);if(e.length===this.chars.length){for(let t=0;t<e.length;t++)if(e[t]!==this.chars[t])return void this._renderAtlas(e)}else this._renderAtlas(e)}updateTextures(t){const e=this._normalizeCharsSet(t),s=[];for(let t=0;t<e.length;t++){const i=e[t];this.data.chars[i]||s.push(i)}s.length>0&&this._renderAtlas(this.chars.concat(s))}destroy(){for(let t=0;t<this.textures.length;t++)this.textures[t].destroy();this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.textures=null,this.type=null,this.fontWeight=null}_getAndClearContext(t,e){const s=t.width,i=t.height,n=t.getContext("2d",{alpha:!0});return n.clearRect(0,0,s,i),n.fillStyle=e,n.fillRect(0,0,s,i),n}_colorToRgbString(t,e){let s;const i=Math.round(255*t.r),n=Math.round(255*t.g),a=Math.round(255*t.b);return s=e?`rgba(${i}, ${n}, ${a}, ${t.a})`:`rgb(${i}, ${n}, ${a})`,s}renderCharacter(t,e,s,i,n){t.fillStyle=n,t.fillText(e,s,i)}_renderAtlas(t){this.chars=t;let e=1,s=this.textures[e-1].getSource();const i=s.width,n=s.height,a=this._colorToRgbString(this.color,!1),r=this.color.a;this.color.a=1/255;const o=this._colorToRgbString(this.color,!0);this.color.a=r;const h="center",l="alphabetic";let c=this._getAndClearContext(s,o);c.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,c.textAlign=h,c.textBaseline=l,this.data=this._createJson(this.chars,this.fontName,i,n);const d=F.getSymbols(this.chars.join("")),u=this.textures.length;let p=0,m=0;const f={};for(let t=0;t<d.length;t++){const e=d[t];f[e]=this._getTextMetrics(e),p=Math.max(p,f[e].height),m=Math.max(m,f[e].descent)}this.glyphSize=Math.max(this.glyphSize,p);const _=this.glyphSize+2*this.padding,g=this.glyphSize+2*this.padding,y=this.glyphSize/2+this.padding,v=g-m-this.padding;let x=0,b=0;for(let t=0;t<d.length;t++){const r=d[t],p=F.getCodePoint(d[t]);let S=this.fontSize;c.font=this.fontWeight+" "+S.toString()+"px "+this.fontName,c.textAlign=h,c.textBaseline=l;let w=c.measureText(r).width;w>S&&(S=this.fontSize*this.fontSize/w,c.font=this.fontWeight+" "+S.toString()+"px "+this.fontName,w=this.fontSize),this.renderCharacter(c,r,x+y,b+v,a);const T=this.padding+(this.glyphSize-w)/2,M=-this.padding+f[r].descent-m,C=w;if(this._addChar(this.data,r,p,x,b,_,g,T,M,C,e-1,i,n),x+=_,x+_>i&&(x=0,b+=g,b+g>n))if(this.textures[e-1].upload(),e++,b=0,e>u){s=document.createElement("canvas"),s.height=n,s.width=i,c=this._getAndClearContext(s,o);const t=new Mo(this.app.graphicsDevice,{format:7,mipmaps:!0,name:"font-atlas"});t.setSource(s),t.minFilter=5,t.magFilter=1,t.addressU=1,t.addressV=1,this.textures.push(t)}else s=this.textures[e-1].getSource(),c=this._getAndClearContext(s,o)}if(this.textures[e-1].upload(),e<u){for(let t=e;t<u;t++)this.textures[t].destroy();this.textures.splice(e)}this.fire("render")}_createJson(t,e,s,i){return{version:3,intensity:this.intensity,info:{face:e,width:s,height:i,maps:[{width:s,height:i}]},chars:{}}}_addChar(t,e,s,i,n,a,r,o,h,l,c,d,u){t.info.maps.length<c+1&&t.info.maps.push({width:d,height:u});const p=this.fontSize/32;t.chars[e]={id:s,letter:e,x:i,y:n,width:a,height:r,xadvance:l/p,xoffset:o/p,yoffset:(h+this.padding)/p,scale:p,range:1,map:c,bounds:[0,0,a/p,r/p]}}_normalizeCharsSet(t){const e=this.app.systems.element.getUnicodeConverter();e&&(t=e(t));const s={},i=F.getSymbols(t);for(let t=0;t<i.length;t++){const e=i[t];s[e]||(s[e]=e)}return Object.keys(s).sort()}_getTextMetrics(t){const e=document.createElement("span");e.id="content-span",e.innerHTML=t;const s=document.createElement("div");s.id="content-block",s.style.display="inline-block",s.style.width="1px",s.style.height="0px";const i=document.createElement("div");i.appendChild(e),i.appendChild(s),i.style.font=this.fontSize+"px "+this.fontName;document.body.appendChild(i);let n=-1,a=-1,r=-1;try{s.style["vertical-align"]="baseline",n=s.offsetTop-e.offsetTop,s.style["vertical-align"]="bottom",r=s.offsetTop-e.offsetTop,a=r-n}finally{document.body.removeChild(i)}return{ascent:n,descent:a,height:r}}}const v_="linear",x_="inverse",b_="exponential";function S_(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}class w_{constructor(t,e,s={}){if(this.volume=void 0===s.volume?1:s.volume,this.loop=void 0!==s.loop&&s.loop,this.pitch=void 0===s.pitch?1:s.pitch,this.sound=e,this.paused=!1,this.suspended=!1,this.manager=t,this.source=null,S_()){this.startTime=0,this.startOffset=0;const e=t.context;this.gain=e.createGain()}else e.audio&&(this.source=e.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(t){this.loop=t,this.source&&(this.source.loop=t)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(t){t=q.clamp(t,0,1),this.volume=t,this.gain&&(this.gain.gain.value=t*this.manager.volume)}setPitch(t){this.pitch=t,this.source&&(this.source.playbackRate.value=t)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const t=this.manager.context;this.sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}S_()||Object.assign(w_.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(t){t=q.clamp(t,0,1),this.volume=t,this.source&&(this.source.volume=t*this.manager.volume)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate=t)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});class T_ extends w_{constructor(t,e,s){super(t,e,s),this.position=new at,this.velocity=new at,S_()?this.panner=t.context.createPanner():(this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel="inverse")}getPosition(){return this.position}setPosition(t){this.position.copy(t);const e=this.panner;"positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z)}getVelocity(){return this.velocity}setVelocity(t){this.velocity.copy(t)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(t){this.panner.maxDistance=t}getMinDistance(){return this.panner.refDistance}setMinDistance(t){this.panner.refDistance=t}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(t){this.panner.rolloffFactor=t}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(t){this.panner.distanceModel=t}_createSource(){const t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!S_()){let t=new at;const e=function(e,s,i,n,a,r){t=t.sub2(e,s);const o=t.length();if(o<i)return 1;if(o>n)return 0;let h=0;return"linear"===r?h=1-a*(o-i)/(n-i):"inverse"===r?h=i/(i+a*(o-i)):"exponential"===r&&(h=Math.pow(o/i,-a)),q.clamp(h,0,1)};Object.assign(T_.prototype,{setPosition:function(t){if(this.position.copy(t),this.source){const t=this.manager.listener.getPosition(),s=e(t,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.getVolume();this.source.volume=i*s}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}class M_{constructor(t){this._manager=t,this.position=new at,this.velocity=new at,this.orientation=new mt}getPosition(){return this.position}setPosition(t){this.position.copy(t);const e=this.listener;e&&("positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z))}getVelocity(){return this.velocity}setVelocity(t){}setOrientation(t){this.orientation.copy(t);const e=this.listener;if(e){const s=t.data;"forwardX"in e?(e.forwardX.value=-s[8],e.forwardY.value=-s[9],e.forwardZ.value=-s[10],e.upX.value=s[4],e.upY.value=s[5],e.upZ.value=s[6]):e.setOrientation&&e.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){const t=this._manager.context;return t?t.listener:null}}const C_=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","pointerup","touchend","keydown","keyup"];class A_ extends _{constructor(t){super(),this._context=null,this._state="not created",this._forceWebAudioApi=t.forceWebAudioApi,this._resumeContext=null,this._resumeContextAttached=!1,this._unlock=null,this._unlockAttached=!1,(S_()||this._forceWebAudioApi)&&this._addAudioContextUserInteractionListeners(),this.listener=new M_(this),this._volume=1,this.suspended=!1}set volume(t){t=q.clamp(t,0,1),this._volume=t,this.fire("volumechange",t)}get volume(){return this._volume}get context(){return this._context||(S_()||this._forceWebAudioApi)&&("undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext),this._context&&(this._state=this._context.state,this._context.onstatechange=()=>{this._context&&("interrupted"!==this._state&&"suspended"!==this._state||this._safelyResumeContext(),this._state=this._context.state)})),this._context}suspend(){this.suspended=!0,this.fire("suspend")}resume(){this.suspended=!1,this.fire("resume"),!this.context||"interrupted"!==this._state&&"suspended"!==this._state||this._safelyResumeContext()}destroy(){this._resumeContext&&this._resumeContextAttached&&C_.forEach((t=>{window.removeEventListener(t,this._resumeContext)})),this._unlock&&this._unlockAttached&&window.removeEventListener("touchend",this._unlock),this.fire("destroy"),this._context&&this._context.close&&(this._context.close(),this._context=null)}playSound(t,e={}){let s=null;return w_&&(s=new w_(this,t,e),s.play()),s}playSound3d(t,e,s={}){let i=null;return T_&&(i=new T_(this,t,s),i.setPosition(e),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_safelyResumeContext(){this._context&&this._context.resume().then((()=>{"running"!==this._context.state&&this._addAudioContextUserInteractionListeners()})).catch((()=>{this._addAudioContextUserInteractionListeners()}))}_addAudioContextUserInteractionListeners(){this._resumeContext||(this._resumeContext=()=>{this.context&&"running"!==this.context.state?this.context.resume():(C_.forEach((t=>{window.removeEventListener(t,this._resumeContext)})),this._resumeContextAttached=!1)}),this._resumeContextAttached||(C_.forEach((t=>{window.addEventListener(t,this._resumeContext)})),this._resumeContextAttached=!0),L.ios&&(this._unlock||(this._unlock=()=>{window.removeEventListener("touchend",this._unlock),this._unlockAttached=!1;const t=this.context;if(t){const e=t.createBuffer(1,1,44100),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect()}}),this._unlockAttached||(window.addEventListener("touchend",this._unlock),this._unlockAttached=!0))}}class P_{constructor(t){this.audio=void 0,this.buffer=void 0,t instanceof Audio?this.audio=t:this.buffer=t}get duration(){let t=0;return this.buffer?t=this.buffer.duration:this.audio&&(t=this.audio.duration),t||0}}function E_(t,e){return t%e||0}class R_ extends _{constructor(t,e,s){super(),this.source=null,this._manager=t,this._volume=void 0!==s.volume?q.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._sound=e,this._state=2,this._suspended=!1,this._suspendEndEvent=0,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,S_()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(t){if(!(t<0))if(0===this._state){const e=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=t,this.play(),this._suspendInstanceEvents=e}else this._startOffset=t,this._currentTime=t}get currentTime(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0}set duration(t){this._duration=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}get duration(){return this._sound?this._duration?E_(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return 1===this._state}get isPlaying(){return 0===this._state}get isStopped(){return 2===this._state}get isSuspended(){return this._suspended}set loop(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(t){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(t){this._sound=t,2!==this._state?this.stop():this._createSource()}get sound(){return this._sound}set startTime(t){this._startTime=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}get startTime(){return this._startTime}set volume(t){t=q.clamp(t,0,1),this._volume=t,this.gain&&(this.gain.gain.value=t*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){this._suspendEndEvent>0?this._suspendEndEvent--:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){2!==this._state&&this.stop(),this.source||this._createSource();let t=E_(this._startOffset,this.duration);return t=E_(this._startTime+t,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=t,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0}pause(){return this._playWhenLoaded=!1,!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)}resume(){if(1!==this._state)return!1;this.source||this._createSource();let t=this.currentTime;return null!==this._startOffset&&(t=E_(this._startOffset,this.duration),t=E_(this._startTime+t,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=t,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0}stop(){return this._playWhenLoaded=!1,!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)}setExternalNodes(t,e){if(!t)return void console.error("The firstNode must be a valid Audio Node");e||(e=t);const s=this._manager.context.destination;this._firstNode!==t&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=t,this._connectorNode.connect(t)),this._lastNode!==e&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=e,this._lastNode.connect(s))}clearExternalNodes(){const t=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(t),this._lastNode=null),this._connectorNode.connect(t)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;const t=this._manager.context;return this._sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=E_(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,E_(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=E_((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}S_()||(Object.assign(R_.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let t=E_(this._startOffset,this.duration);t=E_(this._startTime+t,this._sound.duration),this._startOffset=null,this.source.currentTime=t},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>E_(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=E_(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(R_.prototype,"volume",{get:function(){return this._volume},set:function(t){t=q.clamp(t,0,1),this._volume=t,this.source&&(this.source.volume=t*this._manager.volume)}}),Object.defineProperty(R_.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(R_.prototype,"sound",{get:function(){return this._sound},set:function(t){this.stop(),this._sound=t}}),Object.defineProperty(R_.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(t){t<0||(this._startOffset=t,this.source&&this._isReady&&(this.source.currentTime=E_(this._startTime+E_(t,this.duration),this._sound.duration),this._startOffset=null))}}));class L_ extends R_{constructor(t,e,s={}){super(t,e,s),this._position=new at,this._velocity=new at,s.position&&(this.position=s.position),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:"linear"}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(t){this._position.copy(t);const e=this.panner;"positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z)}get position(){return this._position}set velocity(t){this._velocity.copy(t)}get velocity(){return this._velocity}set maxDistance(t){this.panner.maxDistance=t}get maxDistance(){return this.panner.maxDistance}set refDistance(t){this.panner.refDistance=t}get refDistance(){return this.panner.refDistance}set rollOffFactor(t){this.panner.rolloffFactor=t}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(t){this.panner.distanceModel=t}get distanceModel(){return this.panner.distanceModel}}if(!S_()){let t=new at;const e=function(e,s,i,n,a,r){t=t.sub2(e,s);const o=t.length();if(o<i)return 1;if(o>n)return 0;let h=0;return"linear"===r?h=1-a*(o-i)/(n-i):"inverse"===r?h=i/(i+a*(o-i)):"exponential"===r&&(h=Math.pow(o/i,-a)),q.clamp(h,0,1)};Object.defineProperty(L_.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){const t=this._manager.listener.getPosition(),s=e(t,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*s*this._manager.volume}}}),Object.defineProperty(L_.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(L_.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(L_.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(L_.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}function I_(){const t=0,e=1,s=2,i=3,n=8,a=9,r=10,o=11,h=12,l=13,c=14,d=16,u={astc:r,dxt:s,etc1:t,etc2:t,pvr:n,atc:o,none:c},p={astc:r,dxt:i,etc1:d,etc2:e,pvr:a,atc:h,none:d},m=21,f=22,_=23,g=8,y=10,v=26,x=27,b=28,S=29,w=30,T=7,M=3,C=5,A=(u,p)=>{switch(u){case t:return p.formats.etc1?m:f;case e:return _;case s:return g;case i:return y;case n:return v;case a:return x;case r:return b;case o:return S;case h:return w;case l:return T;case c:return M;case d:return C}},P=t=>{const e=function(t,e){const s=t*(2/255)-1,i=e*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))};for(let s=0;s<t.length;s+=4){const i=t[s+3],n=t[s+1];t[s+0]=i,t[s+2]=e(i,n),t[s+3]=255}return t},E=t=>{const e=new Uint16Array(t.length/4);for(let s=0;s<t.length;s+=4){const i=t[s+0],n=t[s+1],a=t[s+2];e[s/4]=(248&i)<<8|(252&n)<<3|a>>3}return e},R=()=>"undefined"!=typeof performance?performance.now():0;let L,I,D;const O=(t,e,s)=>{if(s){if(t.formats.astc)return"astc"}else if(e){if(t.formats.etc2)return"etc2"}else if(t.formats.etc1||t.formats.etc2)return"etc1";return(e=>{for(let s=0;s<e.length;++s){const i=e[s];if(t.formats[i])return i}return"none"})(e?D:I)},F=(l,c,d,u)=>{switch(d){case t:case e:return!0;case s:case i:return 0==(3&l)&&0==(3&c);case n:case a:return((t,e)=>0==(t&t-1)&&0==(e&e-1))(l,c)&&(l===c||u);case r:case o:case h:return!0}},k=(t,e,s)=>s.isKTX2?((t,e,s)=>{if(!L.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const i=R(),n=new L.KTX2File(new Uint8Array(e)),a=n.getWidth(),r=n.getHeight(),o=n.getLevels(),h=!!n.getHasAlpha(),m=n.isUASTC&&n.isUASTC();if(!a||!r||!o)throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${a} height=${r} levels=${o}`);const f=O(s.deviceDetails,h,m),_=!!s.isGGGR&&"pvr"===f;let g,y;if(_?g=l:(g=h?p[f]:u[f],F(a,r,g,s.deviceDetails.webgl2)||(g=h?l:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const v=[];for(let e=0;e<o;++e){const s=n.getImageTranscodedSizeInBytes(e,0,0,g),i=new Uint8Array(s);if(!n.transcodeImage(i,e,0,0,g,0,-1,-1))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const a=g===c||g===d;v.push(a?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),_)for(g=c,y=0;y<v.length;++y)v[y]=E(P(v[y]));return{format:A(g,s.deviceDetails),width:a,height:r,levels:v,cubemap:!1,transcodeTime:R()-i,url:t,unswizzledGGGR:_}})(t,e,s):((t,e,s)=>{const i=R(),n=new L.BasisFile(new Uint8Array(e)),a=n.getImageWidth(0,0),r=n.getImageHeight(0,0),o=n.getNumImages(),h=n.getNumLevels(0),m=!!n.getHasAlpha(),f=n.isUASTC&&n.isUASTC();if(!(a&&r&&o&&h))throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${a} height=${r} images=${o} levels=${h}`);const _=O(s.deviceDetails,m,f),g=!!s.isGGGR&&"pvr"===_;let y,v;if(g?y=l:(y=m?p[_]:u[_],F(a,r,y,s.deviceDetails.webgl2)||(y=m?l:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const x=[];for(let e=0;e<h;++e){const s=n.getImageTranscodedSizeInBytes(0,e,y),i=new Uint8Array(s);if(!n.transcodeImage(i,0,e,y,0,0))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const a=y===c||y===d;x.push(a?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),g)for(y=c,v=0;v<x.length;++v)x[v]=E(P(x[v]));return{format:A(y,s.deviceDetails),width:a,height:r,levels:x,cubemap:!1,transcodeTime:R()-i,url:t,unswizzledGGGR:g}})(t,e,s),B=(t,e,s)=>{try{const i=k(t,e,s);i.levels=i.levels.map((t=>t.buffer)),self.postMessage({url:t,data:i},i.levels)}catch(e){self.postMessage({url:t,err:e},null)}},z=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":((t,e)=>{self.importScripts(t.basisUrl),self.BASIS(t.module?{instantiateWasm:(e,s)=>(WebAssembly.instantiate(t.module,e).then((t=>{s(t)})).catch((t=>{console.error("instantiate failed + "+t)})),{})}:null).then((s=>{s.initializeBasis(),L=s,I=t.rgbPriority,D=t.rgbaPriority,e(null)}))})(e.config,(()=>{for(let t=0;t<z.length;++t)B(z[t].url,z[t].data,z[t].options);z.length=0}));break;case"transcode":L?B(e.url,e.data,e.options):z.push(e)}}}const D_=t=>({astc:!!t.extCompressedTextureASTC,atc:!!t.extCompressedTextureATC,dxt:!!t.extCompressedTextureS3TC,etc1:!!t.extCompressedTextureETC1,etc2:!!t.extCompressedTextureETC,pvr:!!t.extCompressedTexturePVRTC});class O_{constructor(t,e,s){this.queue=t,this.worker=new Worker(e.workerUrl),this.worker.addEventListener("message",(t=>{const e=t.data;this.queue.handleResponse(e.url,e.err,e.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:e}),this.eager=s}run(t){const e=[];t.data instanceof ArrayBuffer&&e.push(t.data),this.worker.postMessage({type:"transcode",url:t.url,format:t.format,data:t.data,options:t.options},e),this.eager&&this.queue.enqueueClient(this)}}const F_=["etc1","etc2","astc","dxt","pvr","atc"],k_=["astc","dxt","etc2","pvr","atc"],B_=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(t,e,s,i){if(this.callbacks.hasOwnProperty(t))this.callbacks[t].push(s);else{this.callbacks[t]=[s];const n={url:t,data:e,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(t){this.queue.length>0?t.run(this.queue.shift()):this.clients.push(t)}handleResponse(t,e,s){const i=this.callbacks[t];if(e)for(let t=0;t<i.length;++t)i[t](e);else{3===s.format||5===s.format?s.levels=s.levels.map((function(t){return new Uint16Array(t)})):s.levels=s.levels.map((function(t){return new Uint8Array(t)}));for(let t=0;t<i.length;++t)i[t](null,s)}delete this.callbacks[t]}};let z_=null,U_=!1;function V_(t){if(!U_){if(t){if(t.lazyInit)return void(z_=t)}else t=z_||{};if(!t.glueUrl||!t.wasmUrl||!t.fallbackUrl){const e=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find((function(t){return"BASIS"===t.moduleName}));if(e){const s=window.ASSET_PREFIX||"";t.glueUrl||(t.glueUrl=s+e.glueUrl),t.wasmUrl||(t.wasmUrl=s+e.wasmUrl),t.fallbackUrl||(t.fallbackUrl=s+e.fallbackUrl)}}if(t.glueUrl||t.wasmUrl||t.fallbackUrl){U_=!0;const e=Math.max(1,Math.min(16,t.numWorkers||1)),s=1===t.numWorkers||!t.hasOwnProperty("eagerWorkers")||t.eagerWorkers;t.rgbPriority=t.rgbPriority||F_,t.rgbaPriority=t.rgbaPriority||k_,t.maxRetries=t.hasOwnProperty("maxRetries")?t.maxRetries:5,((t,e)=>{const s=()=>{const t="("+I_.toString()+")()\n\n";return new Blob([t],{type:"application/javascript"})},i=(i,n)=>{e(null,{workerUrl:URL.createObjectURL(s()),basisUrl:URL.createObjectURL(i),module:n,rgbPriority:t.rgbPriority,rgbaPriority:t.rgbaPriority})},n={responseType:"blob",retry:t.maxRetries>0,maxRetries:t.maxRetries};if(t.glueUrl&&t.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})()){let s=null,a=null;Y.get(t.glueUrl,n,((t,n)=>{t?e(t):a?i(n,a):s=n}));const r=fetch(t.wasmUrl),o=()=>{r.then((t=>t.arrayBuffer())).then((t=>WebAssembly.compile(t))).then((t=>{s?i(s,t):a=t})).catch((t=>{e(t,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(r).then((t=>{s?i(s,t):a=t})).catch((t=>{o()})):o()}else Y.get(t.fallbackUrl,n,((t,s)=>{t?e(t,null):i(s,null)}))})(t,((t,i)=>{if(t)console.error(`failed to initialize basis worker: ${t}`);else for(let t=0;t<e;++t)B_.enqueueClient(new O_(B_,i,s))}))}}}let N_=null;function W_(t,e,s,i,n){return V_(),N_||(N_={webgl2:t.webgl2,formats:D_(t)}),B_.enqueueJob(e,s,i,{deviceDetails:N_,isGGGR:!(null==n||!n.isGGGR),isKTX2:!(null==n||!n.isKTX2)}),U_}class G_{constructor(t){this.handlerType="animclip",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=j.ResponseType.JSON),Y.get(t.load,s,(function(s,i){s?e(`Error loading animation clip resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){const s=e.name,i=e.duration,n=e.inputs.map((function(t){return new Af(1,t)})),a=e.outputs.map((function(t){return new Af(t.components,t.data)})),r=e.curves.map((function(t){return new Cf([t.path],t.inputIndex,t.outputIndex,t.interpolation)}));return new i_(s,i,n,a,r)}patch(t,e){}}class H_{constructor(t){this.handlerType="animstategraph",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=j.ResponseType.JSON),Y.get(t.load,s,(function(s,i){s?e(`Error loading animation state graph resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return new m_(e)}patch(t,e){}}class X_ extends _{constructor(){super(),this._meshes=null}set meshes(t){this.decRefMeshes(),this._meshes=t,this.incRefMeshes(),this.fire("set:meshes",t)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++){const t=this._meshes[e];t&&(t.decRefCount(),t.refCount<1&&(t.destroy(),this._meshes[e]=null))}}}incRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++)this._meshes[e]&&this._meshes[e].incRefCount()}}}class q_ extends Yl{constructor(t,e){super(),this.skin=t,this.skinInstance=e}}class j_{static createCachedSkinInstance(t,e,s){let i=j_.getCachedSkinInstance(t,e);return i||(i=new xc(t),i.resolve(e,s),j_.addCachedSkinInstance(t,e,i)),i}static getCachedSkinInstance(t,e){let s=null;const i=j_._skinInstanceCache.get(e);if(i){const e=i.find((e=>e.skin===t));e&&(e.incRefCount(),s=e.skinInstance)}return s}static addCachedSkinInstance(t,e,s){let i=j_._skinInstanceCache.get(e);i||(i=[],j_._skinInstanceCache.set(e,i));let n=i.find((e=>e.skin===t));n||(n=new q_(t,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(t){if(t){const e=t.rootBone;if(e){const s=j_._skinInstanceCache.get(e);if(s){const i=s.findIndex((e=>e.skinInstance===t));if(i>=0){const n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||j_._skinInstanceCache.delete(e),t&&(t.destroy(),n.skinInstance=null))}}}}}}j_._skinInstanceCache=new Map;class Y_{constructor(t,e,s,i){const n=function(t,i,n){const a=Y_.createAsset(e.name,t,i,n);return s.add(a),a},a=[];for(let e=0;e<t.renders.length;++e)a.push(n("render",t.renders[e],e));const r=[];for(let e=0;e<t.materials.length;++e)r.push(n("material",t.materials[e],e));const o=[];for(let e=0;e<t.animations.length;++e)o.push(n("animation",t.animations[e],e));this.data=t,this._model=null,this._assetName=e.name,this._assets=s,this._defaultMaterial=i,this.renders=a,this.materials=r,this.textures=t.textures,this.animations=o}get model(){if(!this._model){const t=Y_.createModel(this.data,this._defaultMaterial),e=Y_.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,i){const n=new vp(t+"/"+e+"/"+i,e,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(t){const e=new tm;return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],i=function(t,i,n,a,r,o){const h=void 0===n.materialIndex?e:a[n.materialIndex],l=new Ec(n,h);return n.morph&&(l.morphInstance=new Iu(n.morph)),o.hasOwnProperty("skin")&&s.push({meshInstance:l,rootBone:t,entity:i}),l},n=(e,s,a)=>{const r=new tm;s._cloneInternal(r),e||(e=r);let o=null,h=null;for(let t=0;t<a.nodes.length;t++){if(a.nodes[t]===s){const s=a.gltf.nodes[t];if(s.hasOwnProperty("mesh")){const t=a.renders[s.mesh].meshes;h=this.renders[s.mesh];for(var l=0;l<t.length;l++){const n=t[l];if(n){const t=i(e,r,n,a.materials,a.skins,s);o||(o=[]),o.push(t)}}}if(a.lights){const t=a.lights.get(s);t&&r.addChild(t.clone())}if(a.cameras){const t=a.cameras.get(s);t&&t.camera.system.cloneComponent(t,r)}}}o&&(r.addComponent("render",Object.assign({type:"asset",meshInstances:o,rootBone:e},t)),r.render.assignAsset(h));const c=s.children;for(let t=0;t<c.length;t++){const s=n(e,c[t],a);r.addChild(s)}return r},a=[];for(const t of this.data.scenes)a.push(n(null,t,this.data));return s.forEach((t=>{t.meshInstance.skinInstance=j_.createCachedSkinInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity)})),Y_.createSceneHierarchy(a,"Entity")}static createSceneHierarchy(t,e){let s=null;if(1===t.length)s=t[0];else{s=new e("SceneGroup");for(const e of t)s.addChild(e)}return s}static createModel(t,e){const s=function(t,s,i,n,a,r,o){const h=void 0===s.materialIndex?e:a[s.materialIndex],l=new Ec(s,h,r);if(s.morph){const e=new Iu(s.morph);l.morphInstance=e,t.morphInstances.push(e)}if(o.hasOwnProperty("skin")){const e=o.skin,a=i[e];s.skin=a;const r=n[e];l.skinInstance=r,t.skinInstances.push(r)}t.meshInstances.push(l)},i=new Du,n=[];for(const e of t.skins){const t=new xc(e);t.bones=e.bones,n.push(t)}i.graph=Y_.createSceneHierarchy(t.scenes,"GraphNode");for(let e=0;e<t.nodes.length;e++){const r=t.nodes[e];if(r.root===i.graph){const o=t.gltf.nodes[e];if(o.hasOwnProperty("mesh")){const e=t.renders[o.mesh].meshes;for(var a=0;a<e.length;a++){const h=e[a];h&&s(i,h,t.skins,n,t.materials,r,o)}}}}return i}destroy(){const t=this._assets,e=function(e){t.remove(e),e.unload()},s=function(t){t.forEach((function(t){e(t)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class K_{constructor(t){this.gltf=t,this.nodes=null,this.scenes=null,this.animations=null,this.textures=null,this.materials=null,this.renders=null,this.skins=null,this.lights=null,this.cameras=null}destroy(){this.renders&&this.renders.forEach((t=>{t.meshes=null}))}}const $_=function(t){return/^data:.*,.*$/i.test(t)},Z_=function(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},Q_=function(t){switch(t){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},J_=function(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},tg={POSITION:"POSITION",NORMAL:"NORMAL",TANGENT:"TANGENT",COLOR_0:"COLOR",JOINTS_0:"BLENDINDICES",WEIGHTS_0:"BLENDWEIGHT",TEXCOORD_0:"TEXCOORD0",TEXCOORD_1:"TEXCOORD1",TEXCOORD_2:"TEXCOORD2",TEXCOORD_3:"TEXCOORD3",TEXCOORD_4:"TEXCOORD4",TEXCOORD_5:"TEXCOORD5",TEXCOORD_6:"TEXCOORD6",TEXCOORD_7:"TEXCOORD7"},eg=function(t,e,s){const i=(t=>{switch(t){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})(s),n=e.length;for(let s=0;s<n;++s)t[s]=i(e[s]);return t},sg=function t(e,s,i=!1){const n=Z_(e.type),a=function(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}}(e.componentType);if(!a)return null;const r=s[e.bufferView];let o;if(e.sparse){const i=e.sparse,r={count:i.count,type:"SCALAR"},h=t(Object.assign(r,i.indices),s,!0),l={count:i.count,type:e.scalar,componentType:e.componentType},c=t(Object.assign(l,i.values),s,!0);if(e.hasOwnProperty("bufferView")){o=t({bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type},s,!0).slice()}else o=new a(e.count*n);for(let t=0;t<i.count;++t){const e=h[t];for(let s=0;s<n;++s)o[e*n+s]=c[t*n+s]}}else if(i&&r.hasOwnProperty("byteStride")){const t=n*a.BYTES_PER_ELEMENT,s=new ArrayBuffer(e.count*t),i=new Uint8Array(s);let h=0;for(let s=0;s<e.count;++s){let n=(e.byteOffset||0)+s*r.byteStride;for(let e=0;e<t;++e)i[h++]=r[n++]}o=new a(s)}else o=new a(r.buffer,r.byteOffset+(e.byteOffset||0),e.count*n);return o},ig=function(t,e){const s=sg(t,e,!0);if(s instanceof Float32Array||!t.normalized)return s;const i=new Float32Array(s.length);return eg(i,s,Q_(t.componentType)),i},ng=function(t){let e=t.min,s=t.max;if(!e||!s)return null;if(t.normalized){const i=Q_(t.componentType);e=eg([],e,i),s=eg([],s,i)}return new bt(new at(.5*(s[0]+e[0]),.5*(s[1]+e[1]),.5*(s[2]+e[2])),new at(.5*(s[0]-e[0]),.5*(s[1]-e[1]),.5*(s[2]-e[2])))},ag=function(t,e){const s=t.POSITION;if(!s||3!==s.components)return;let i;if(s.size!==s.stride){const t=s.stride/kr[s.type],e=new Fr[s.type](s.buffer,s.offset,s.count*t);i=new Fr[s.type](3*s.count);for(let n=0;n<s.count;++n)i[3*n+0]=e[n*t+0],i[3*n+1]=e[n*t+1],i[3*n+2]=e[n*t+2]}else i=new Fr[s.type](s.buffer,s.offset,3*s.count);const n=s.count;e||(e=function(t){const e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e}(n));const a=ic(i,e),r=new Float32Array(a.length);r.set(a),t.NORMAL={buffer:r.buffer,size:12,offset:0,stride:12,count:n,components:3,type:6}},rg=function(t){const e=new vp(t.name+"_clone",t.type,t.file,t.data,t.options);return e.loaded=!0,e.resource=function(t){const e=new Mo(t.device,t);return e._levels=function(t){const e=[];for(let s=0;s<t._levels.length;++s){let i=[];if(t.cubemap)for(let e=0;e<6;++e)i.push(t._levels[s][e]);else i=t._levels[s];e.push(i)}return e}(t),e}(t.resource),t.registry.add(e),e},og=function(t,e,s){const i=e.POSITION;if(!i)return null;const n=i.count,a=[];for(const t in e)e.hasOwnProperty(t)&&a.push({semantic:t,components:e[t].components,type:e[t].type,normalize:!!e[t].normalize});const r=["POSITION","NORMAL","TANGENT","COLOR","BLENDINDICES","BLENDWEIGHT","TEXCOORD0","TEXCOORD1"];let o,h,l,c,d,u;a.sort((function(t,e){const s=r.indexOf(t.semantic),i=r.indexOf(e.semantic);return s<i?-1:i<s?1:0}));const p=new Hr(t,a);let m=!0;for(o=0;o<p.elements.length;++o)if(d=p.elements[o],c=e[d.name],u=c.offset-i.offset,c.buffer!==i.buffer||c.stride!==d.stride||c.size!==d.size||u!==d.offset){m=!1;break}const f=new Wr(t,p,n,0),_=f.lock(),g=new Uint32Array(_);let y;if(m)y=new Uint32Array(i.buffer,i.offset,n*f.format.size/4),g.set(y);else{let t,s;for(o=0;o<f.format.elements.length;++o){d=f.format.elements[o],t=d.stride/4,c=e[d.name],s=c.stride/4,y=new Uint32Array(c.buffer,c.offset,(c.count-1)*s+(c.size+3)/4);let i=0,a=d.offset/4;const r=Math.floor((c.size+3)/4);for(h=0;h<n;++h){for(l=0;l<r;++l)g[a+l]=y[i+l];i+=s,a+=t}}}return s&&function(t){let e,s;const i=[],n=[],a=[];for(e=0;e<t.format.elements.length;++e){const s=t.format.elements[e];if("TEXCOORD0"===s.name||"TEXCOORD1"===s.name)switch(s.dataType){case 6:i.push({offset:s.offset/4+1,stride:s.stride/4});break;case 3:n.push({offset:s.offset/2+1,stride:s.stride/2});break;case 1:a.push({offset:s.offset+1,stride:s.stride})}}const r=function(i,n,a){const r=new n(t.storage);for(e=0;e<i.length;++e){let n=i[e].offset;const o=i[e].stride;for(s=0;s<t.numVertices;++s)r[n]=a-r[n],n+=o}};i.length>0&&r(i,Float32Array,1),n.length>0&&r(n,Uint16Array,65535),a.length>0&&r(a,Uint8Array,255)}(f),f.unlock(),f},hg=new mt,lg=new at,cg=function(t,e,s,i,n,a,r){const o=[];return e.primitives.forEach((function(h){let l,c,d,u=null,p=!0;if(h.hasOwnProperty("extensions")){const e=h.extensions;if(e.hasOwnProperty("KHR_draco_mesh_compression")){const s=window.DracoDecoderModule;if(s){const r=e.KHR_draco_mesh_compression;if(r.hasOwnProperty("attributes")){const e=i[r.bufferView],o=new s.DecoderBuffer;o.Init(e,e.length);const h=new s.Decoder,m=h.GetEncodedGeometryType(o);let f,_;switch(m){case s.POINT_CLOUD:l=0,f=new s.PointCloud,_=h.DecodeBufferToPointCloud(o,f);break;case s.TRIANGULAR_MESH:l=4,f=new s.Mesh,_=h.DecodeBufferToMesh(o,f);case s.INVALID_GEOMETRY_TYPE:}if(!_||!_.ok()||0==f.ptr)return void n("Failed to decode draco compressed asset: "+(_?_.error_msg():"Mesh asset - invalid draco compressed geometry type: "+m));const g=f.num_faces();if(m===s.TRIANGULAR_MESH){const t=f.num_points()>65535;d=3*g;const e=d*(t?4:2),i=s._malloc(e);t?(h.GetTrianglesUInt32Array(f,e,i),u=new Uint32Array(s.HEAPU32.buffer,i,d).slice()):(h.GetTrianglesUInt16Array(f,e,i),u=new Uint16Array(s.HEAPU16.buffer,i,d).slice()),s._free(i)}c=function(t,e,s,i,n,a,r){const o=e.num_points(),h=function(t,s){const a=i.GetAttributeByUniqueId(e,t),r=o*a.num_components();let h,l,c,d;switch(a.data_type()){case n.DT_UINT8:d=1,c=1,h=n._malloc(r*c),i.GetAttributeDataArrayForAllPoints(e,a,n.DT_UINT8,r*c,h),l=new Uint8Array(n.HEAPU8.buffer,h,r).slice();break;case n.DT_UINT16:d=3,c=2,h=n._malloc(r*c),i.GetAttributeDataArrayForAllPoints(e,a,n.DT_UINT16,r*c,h),l=new Uint16Array(n.HEAPU16.buffer,h,r).slice();break;case n.DT_FLOAT32:default:d=6,c=4,h=n._malloc(r*c),i.GetAttributeDataArrayForAllPoints(e,a,n.DT_FLOAT32,r*c,h),l=new Float32Array(n.HEAPF32.buffer,h,r).slice()}return n._free(h),{values:l,numComponents:a.num_components(),componentSizeInBytes:c,storageType:d,normalized:"COLOR"===s&&1===d||a.normalized()}},l={},c=s.attributes;for(const t in c)if(c.hasOwnProperty(t)&&tg.hasOwnProperty(t)){const e=tg[t],s=h(c[t],e),i=s.numComponents*s.componentSizeInBytes;l[e]={values:s.values,buffer:s.values.buffer,size:i,offset:0,stride:i,count:o,components:s.numComponents,type:s.storageType,normalize:s.normalized}}return l.hasOwnProperty("NORMAL")||ag(l,a),og(t,l,r)}(t,f,r,h,s,u,a),s.destroy(f),s.destroy(h),s.destroy(o),p=!1}}}}c||(u=h.hasOwnProperty("indices")?sg(s[h.indices],i,!0):null,c=function(t,e,s,i,n,a,r){const o={},h=[];for(const t in e)e.hasOwnProperty(t)&&tg.hasOwnProperty(t)&&(o[t]=e[t],h.push(t+":"+e[t]));h.sort();const l=h.join();let c=r[l];if(!c){const h={};for(const t in o){const s=i[e[t]],a=sg(s,n),r=n[s.bufferView],o=tg[t],l=Z_(s.type)*J_(s.componentType),c=r.hasOwnProperty("byteStride")?r.byteStride:l;h[o]={buffer:a.buffer,size:l,offset:a.byteOffset,stride:c,count:s.count,components:Z_(s.type),type:Q_(s.componentType),normalize:s.normalized}}h.hasOwnProperty("NORMAL")||ag(h,s),c=og(t,h,a),r[l]=c}return c}(t,h.attributes,u,s,i,a,r),l=function(t){if(!t.hasOwnProperty("mode"))return 4;switch(t.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}}(h));let m=null;if(c){if(m=new ec(t),m.vertexBuffer=c,m.primitive[0].type=l,m.primitive[0].base=0,m.primitive[0].indexed=null!==u,null!==u){let e;e=u instanceof Uint8Array?0:u instanceof Uint16Array?1:2,2!==e||t.extUintElement||(e=1,u=new Uint16Array(u));const s=new ll(t,e,u.length,0,u);m.indexBuffer[0]=s,m.primitive[0].count=u.length}else m.primitive[0].count=c.numVertices;m.materialIndex=h.material;let n=s[h.attributes.POSITION];if(m.aabb=ng(n),p&&h.hasOwnProperty("targets")){const a=[];h.targets.forEach((function(t,r){const o={};t.hasOwnProperty("POSITION")&&(n=s[t.POSITION],o.deltaPositions=ig(n,i),o.deltaPositionsType=6,o.aabb=ng(n)),t.hasOwnProperty("NORMAL")&&(n=s[t.NORMAL],o.deltaNormals=ig(n,i),o.deltaNormalsType=6),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?o.name=e.extras.targetNames[r]:o.name=r.toString(10),e.hasOwnProperty("weights")&&(o.defaultWeight=e.weights[r]),a.push(new hm(o))})),m.morph=new Lu(a,t)}}o.push(m)})),o},dg=function(t,e,s){const i=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","\t\tdGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tdGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","\t\tdGlossiness *= texture2D(texture_glossMap, $UV, textureBias).$CH;","#endif","","#ifdef MAPVERTEX","\t\tdGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tdGlossiness = 1.0 - dGlossiness;","","\t\tdGlossiness += 0.0000001;","}"].join("\n"),n=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","\t\tdSpecularity = vec3(1.0);","","\t\t#ifdef MAPCOLOR","\t\t\t\tdSpecularity *= material_specular;","\t\t#endif","","\t\t#ifdef MAPTEXTURE","\t\t\t\tvec3 srgb = texture2D(texture_specularMap, $UV, textureBias).$CH;","\t\t\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","\t\t#endif","","\t\t#ifdef MAPVERTEX","\t\t\t\tdSpecularity *= saturate(vVertexColor.$VC);","\t\t#endif","}"].join("\n"),a=["#ifdef MAPFLOAT","uniform float material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_clearCoatGlossMap;","#endif","","void getClearCoatGlossiness() {","\t\tccGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tccGlossiness *= material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV, textureBias).$CH;","#endif","","#ifdef MAPVERTEX","\t\tccGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tccGlossiness = 1.0 - ccGlossiness;","","\t\tccGlossiness += 0.0000001;","}"].join("\n"),r=[0,0],o=[1,1],h=function(t,e,s){var i;let n;const a=t.texCoord;if(a)for(n=0;n<s.length;++n)e[s[n]+"MapUv"]=a;const h=null==(i=t.extensions)?void 0:i.KHR_texture_transform;if(h){const t=h.offset||r,i=h.scale||o,a=h.rotation?-h.rotation*q.RAD_TO_DEG:0,l=new ot(i[0],i[1]),c=new ot(t[0],1-i[1]-t[1]);for(n=0;n<s.length;++n)e[`${s[n]}MapTiling`]=l,e[`${s[n]}MapOffset`]=c,e[`${s[n]}MapRotation`]=a}},l=new Xh;let c,d;if(l.occludeSpecular=!0,l.diffuseTint=!0,l.diffuseVertexColor=!0,l.specularTint=!0,l.specularVertexColor=!0,t.hasOwnProperty("name")&&(l.name=t.name),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){const s=t.extensions.KHR_materials_pbrSpecularGlossiness;if(s.hasOwnProperty("diffuseFactor")?(c=s.diffuseFactor,l.diffuse.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2)),l.opacity=c[3]):(l.diffuse.set(1,1,1),l.opacity=1),s.hasOwnProperty("diffuseTexture")){const t=s.diffuseTexture;d=e[t.index],l.diffuseMap=d,l.diffuseMapChannel="rgb",l.opacityMap=d,l.opacityMapChannel="a",h(t,l,["diffuse","opacity"])}if(l.useMetalness=!1,s.hasOwnProperty("specularFactor")?(c=s.specularFactor,l.specular.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2))):l.specular.set(1,1,1),s.hasOwnProperty("glossinessFactor")?l.shininess=100*s.glossinessFactor:l.shininess=100,s.hasOwnProperty("specularGlossinessTexture")){const t=s.specularGlossinessTexture;l.specularMap=l.glossMap=e[t.index],l.specularMapChannel="rgb",l.glossMapChannel="a",h(t,l,["gloss","metalness"])}l.chunks.specularPS=n}else if(t.hasOwnProperty("pbrMetallicRoughness")){const s=t.pbrMetallicRoughness;if(s.hasOwnProperty("baseColorFactor")?(c=s.baseColorFactor,l.diffuse.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2)),l.opacity=c[3]):(l.diffuse.set(1,1,1),l.opacity=1),s.hasOwnProperty("baseColorTexture")){const t=s.baseColorTexture;d=e[t.index],l.diffuseMap=d,l.diffuseMapChannel="rgb",l.opacityMap=d,l.opacityMapChannel="a",h(t,l,["diffuse","opacity"])}if(l.useMetalness=!0,s.hasOwnProperty("metallicFactor")?l.metalness=s.metallicFactor:l.metalness=1,s.hasOwnProperty("roughnessFactor")?l.shininess=100*s.roughnessFactor:l.shininess=100,s.hasOwnProperty("metallicRoughnessTexture")){const t=s.metallicRoughnessTexture;l.metalnessMap=l.glossMap=e[t.index],l.metalnessMapChannel="b",l.glossMapChannel="g",h(t,l,["gloss","metalness"])}l.chunks.glossPS=i}if(t.hasOwnProperty("normalTexture")){const s=t.normalTexture;l.normalMap=e[s.index],h(s,l,["normal"]),s.hasOwnProperty("scale")&&(l.bumpiness=s.scale)}if(t.hasOwnProperty("occlusionTexture")){const s=t.occlusionTexture;l.aoMap=e[s.index],l.aoMapChannel="r",h(s,l,["ao"])}if(t.hasOwnProperty("emissiveFactor")?(c=t.emissiveFactor,l.emissive.set(Math.pow(c[0],1/2.2),Math.pow(c[1],1/2.2),Math.pow(c[2],1/2.2)),l.emissiveTint=!0):(l.emissive.set(0,0,0),l.emissiveTint=!1),t.hasOwnProperty("emissiveTexture")){const s=t.emissiveTexture;l.emissiveMap=e[s.index],h(s,l,["emissive"])}if(t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":l.blendType=3,t.hasOwnProperty("alphaCutoff")?l.alphaTest=t.alphaCutoff:l.alphaTest=.5;break;case"BLEND":l.blendType=2,l.depthWrite=!1;break;default:l.blendType=3}else l.blendType=3;if(t.hasOwnProperty("doubleSided")?(l.twoSidedLighting=t.doubleSided,l.cull=t.doubleSided?0:1):(l.twoSidedLighting=!1,l.cull=1),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_clearcoat")){const s=t.extensions.KHR_materials_clearcoat;if(s.hasOwnProperty("clearcoatFactor")?l.clearCoat=.25*s.clearcoatFactor:l.clearCoat=0,s.hasOwnProperty("clearcoatTexture")){const t=s.clearcoatTexture;l.clearCoatMap=e[t.index],l.clearCoatMapChannel="r",h(t,l,["clearCoat"])}if(s.hasOwnProperty("clearcoatRoughnessFactor")?l.clearCoatGlossiness=s.clearcoatRoughnessFactor:l.clearCoatGlossiness=0,s.hasOwnProperty("clearcoatRoughnessTexture")){const t=s.clearcoatRoughnessTexture;l.clearCoatGlossMap=e[t.index],l.clearCoatGlossMapChannel="g",h(t,l,["clearCoatGloss"])}if(s.hasOwnProperty("clearcoatNormalTexture")){const t=s.clearcoatNormalTexture;l.clearCoatNormalMap=e[t.index],h(t,l,["clearCoatNormal"]),t.hasOwnProperty("scale")&&(l.clearCoatBumpiness=t.scale)}l.chunks.clearCoatGlossPS=a}return t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_unlit")&&(l.useLighting=!1,l.emissive.copy(l.diffuse),l.emissiveTint=l.diffuseTint,l.emissiveMap=l.diffuseMap,l.emissiveMapUv=l.diffuseMapUv,l.emissiveMapTiling.copy(l.diffuseMapTiling),l.emissiveMapOffset.copy(l.diffuseMapOffset),l.emissiveMapChannel=l.diffuseMapChannel,l.emissiveVertexColor=l.diffuseVertexColor,l.emissiveVertexColorChannel=l.diffuseVertexColorChannel,l.diffuse.set(0,0,0),l.diffuseTint=!1,l.diffuseMap=null,l.diffuseVertexColor=!1),l.update(),l},ug=function(t,e){const s=new qo;if(t.hasOwnProperty("name")&&t.name.length>0?s.name=t.name:s.name="node_"+e,t.hasOwnProperty("matrix")&&(hg.data.set(t.matrix),hg.getTranslation(lg),s.setLocalPosition(lg),hg.getEulerAngles(lg),s.setLocalEulerAngles(lg),hg.getScale(lg),s.setLocalScale(lg)),t.hasOwnProperty("rotation")){const e=t.rotation;s.setLocalRotation(e[0],e[1],e[2],e[3])}if(t.hasOwnProperty("translation")){const e=t.translation;s.setLocalPosition(e[0],e[1],e[2])}if(t.hasOwnProperty("scale")){const e=t.scale;s.setLocalScale(e[0],e[1],e[2])}return s},pg=function(t,e){const s="orthographic"===t.type?1:0,i=1===s?t.orthographic:t.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*q.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));const a=new tm(t.name);return a.addComponent("camera",n),a},mg=function(t,e){const s={enabled:!1,type:"point"===t.type?"omni":t.type,color:t.hasOwnProperty("color")?new et(t.color):et.WHITE,range:t.hasOwnProperty("range")?t.range:9999,falloffMode:1,intensity:t.hasOwnProperty("intensity")?q.clamp(t.intensity,0,2):1};t.hasOwnProperty("spot")&&(s.innerConeAngle=t.spot.hasOwnProperty("innerConeAngle")?t.spot.innerConeAngle*q.RAD_TO_DEG:0,s.outerConeAngle=t.spot.hasOwnProperty("outerConeAngle")?t.spot.outerConeAngle*q.RAD_TO_DEG:Math.PI/4);const i=new tm(e.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},fg=function(t,e,s,i){if(!e.hasOwnProperty("skins")||0===e.skins.length)return[];const n=new Map;return e.skins.map((function(a){return function(t,e,s,i,n,a){let r,o,h;const l=e.joints,c=l.length,d=[];if(e.hasOwnProperty("inverseBindMatrices")){const t=e.inverseBindMatrices,n=sg(s[t],i,!0),a=[];for(r=0;r<c;r++){for(o=0;o<16;o++)a[o]=n[16*r+o];h=new mt,h.set(a),d.push(h)}}else for(r=0;r<c;r++)h=new mt,d.push(h);const u=[];for(r=0;r<c;r++)u[r]=n[l[r]].name;const p=u.join("#");let m=a.get(p);return m||(m=new of(t,d,u),a.set(p,m)),m}(t,a,e.accessors,i,s,n)}))},_g=function(t,e,s,i){if(!t.hasOwnProperty("animations")||0===t.animations.length)return[];const n=i&&i.animation&&i.animation.preprocess,a=i&&i.animation&&i.animation.postprocess;return t.animations.map((function(i,r){n&&n(i);const o=function(t,e,s,i,n){const a=function(t){return new Af(Z_(t.type),ig(t,i))},r={STEP:0,LINEAR:1,CUBICSPLINE:2},o={},h=[],l={},c=[],d=[];let u;for(u=0;u<t.samplers.length;++u){const e=t.samplers[u];o.hasOwnProperty(e.input)||(o[e.input]=h.length,h.push(a(s[e.input]))),l.hasOwnProperty(e.output)||(l[e.output]=c.length,c.push(a(s[e.output])));const i=e.hasOwnProperty("interpolation")&&r.hasOwnProperty(e.interpolation)?r[e.interpolation]:1;d.push(new Cf([],o[e.input],l[e.output],i))}const p=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"},f=t=>{const e=[];for(;t;)e.unshift(t.name),t=t.parent;return e};for(u=0;u<t.channels.length;++u){const e=t.channels[u],s=e.target,i=d[e.sampler],a=f(n[s.node]);i._paths.push({entityPath:a,component:"graph",propertyPath:[m[s.path]]}),s.path.startsWith("rotation")&&2!==i.interpolation?p.push(i.output):s.path.startsWith("weights")&&(c[i.output]._components=c[i.output].data.length/h[i.input].data.length)}p.sort();let _,g=null;for(u=0;u<p.length;++u){const t=p[u];if(0===u||t!==g){if(_=c[t],4===_.components){const t=_.data,e=t.length-4;for(let s=0;s<e;s+=4)t[s+0]*t[s+4]+t[s+1]*t[s+5]+t[s+2]*t[s+6]+t[s+3]*t[s+7]<0&&(t[s+4]*=-1,t[s+5]*=-1,t[s+6]*=-1,t[s+7]*=-1)}g=t}}let y=0;for(u=0;u<h.length;u++)_=h[u]._data,y=Math.max(y,0===_.length?0:_[_.length-1]);return new i_(t.hasOwnProperty("name")?t.name:"animation_"+e,y,h,c,d)}(i,r,t.accessors,s,e);return a&&a(i,o),o}))},gg=function(t,e,s,i,n,a){const r=n&&n.global&&n.global.preprocess,o=n&&n.global&&n.global.postprocess;r&&r(e);const h=e.asset&&"PlayCanvas"===e.asset.generator,l=function(t,e){if(!t.hasOwnProperty("nodes")||0===t.nodes.length)return[];const s=e&&e.node&&e.node.preprocess,i=e&&e.node&&e.node.process||ug,n=e&&e.node&&e.node.postprocess,a=t.nodes.map((function(t,e){s&&s(t);const a=i(t,e);return n&&n(t,a),a}));for(let e=0;e<t.nodes.length;++e){const s=t.nodes[e];if(s.hasOwnProperty("children")){const t=a[e],i={};for(let e=0;e<s.children.length;++e){const n=a[s.children[e]];n.parent||(i.hasOwnProperty(n.name)?n.name+=i[n.name]++:i[n.name]=1,t.addChild(n))}}}return a}(e,n),c=function(t,e){var s;const i=[],n=t.scenes.length;if(1===n&&1===(null==(s=t.scenes[0].nodes)?void 0:s.length)){const s=t.scenes[0].nodes[0];i.push(e[s])}else for(let s=0;s<n;s++){const n=t.scenes[s];if(n.nodes){const t=new qo(n.name);for(let s=0;s<n.nodes.length;s++){const i=e[n.nodes[s]];t.addChild(i)}i.push(t)}}return i}(e,l),d=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const n=t.extensions.KHR_lights_punctual.lights;if(n.length){const a=s&&s.light&&s.light.preprocess,r=s&&s.light&&s.light.process||mg,o=s&&s.light&&s.light.postprocess;t.nodes.forEach((function(t,s){if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("light")){const h=t.extensions.KHR_lights_punctual.light,l=n[h];if(l){a&&a(l);const n=r(l,e[s]);o&&o(l,n),n&&(i||(i=new Map),i.set(t,n))}}}))}}return i}(e,l,n),u=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("cameras")&&t.cameras.length>0){const n=s&&s.camera&&s.camera.preprocess,a=s&&s.camera&&s.camera.process||pg,r=s&&s.camera&&s.camera.postprocess;t.nodes.forEach((function(s,o){if(s.hasOwnProperty("camera")){const h=t.cameras[s.camera];if(h){n&&n(h);const t=a(h,e[o]);r&&r(h,t),t&&(i||(i=new Map),i.set(s,t))}}}))}return i}(e,l,n),p=_g(e,l,s,n),m=function(t,e,s,i){if(!t.hasOwnProperty("materials")||0===t.materials.length)return[];const n=s&&s.material&&s.material.preprocess,a=s&&s.material&&s.material.process||dg,r=s&&s.material&&s.material.postprocess;return t.materials.map((function(t){n&&n(t);const s=a(t,e,i);return r&&r(t,s),s}))}(e,i.map((function(t){return t.resource})),n,h),f=function(t,e,s,i,n){if(!e.hasOwnProperty("meshes")||0===e.meshes.length||!e.hasOwnProperty("accessors")||0===e.accessors.length||!e.hasOwnProperty("bufferViews")||0===e.bufferViews.length)return[];const a={};return e.meshes.map((function(r){return cg(t,r,e.accessors,s,i,n,a)}))}(t,e,s,a,h),_=fg(t,e,l,s),g=[];for(let t=0;t<f.length;t++)g[t]=new X_,g[t].meshes=f[t];!function(t,e,s){t.nodes.forEach((t=>{t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")&&e[t.mesh].meshes.forEach((e=>{e.skin=s[t.skin]}))}))}(e,g,_);const y=new K_(e);y.nodes=l,y.scenes=c,y.animations=p,y.textures=i,y.materials=m,y.renders=g,y.skins=_,y.lights=d,y.cameras=u,o&&o(e,y),a(null,y)};let yg=0;const vg=function(t,e,s,i,n,a,r){const o=a&&a.image&&a.image.preprocess,h=a&&a.image&&a.image.processAsync||function(t,e){e(null,null)},l=a&&a.image&&a.image.postprocess,c=function(e){l&&l(t,e),r(null,e)},d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=function(e,s,i,a){const o=(t.name||"gltf-texture")+"-"+yg++,h={url:e||o};if(s&&(h.contents=s.slice(0).buffer),i){const t=d[i];t&&(h.filename=h.url+"."+t)}const l=new vp(o,"texture",h,null,a);l.on("load",c),l.on("error",r),n.add(l),n.load(l)};o&&o(t),h(t,(function(n,a){var o;n?r(n):a?c(a):t.hasOwnProperty("uri")?$_(t.uri)?u(t.uri,null,(o=t.uri).substring(o.indexOf(":")+1,o.indexOf(";")),null):u(v.join(i,t.uri),null,null,{crossOrigin:"anonymous"}):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?u(null,s[t.bufferView],t.mimeType,null):r("Invalid image found in gltf (neither uri or bufferView found). index="+e)}))},xg=function(t,e){const s=JSON.parse(function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t[s]);return decodeURIComponent(escape(e))}(t));s.asset&&s.asset.version&&parseFloat(s.asset.version)<2?e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`):e(null,s)},bg=function(t,e,s){t&&t.toLowerCase().endsWith(".glb")?function(t,e){const s=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),a=s.getUint32(8,!0);if(1179937895!==i)return void e("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));if(2!==n)return void e("Invalid version number found in glb header. Expected 2, found "+n);if(a<=0||a>s.byteLength)return void e("Invalid length found in glb header. Found "+a);const r=[];let o=12;for(;o<a;){const t=s.getUint32(o,!0);if(o+t+8>s.byteLength)throw new Error("Invalid chunk length found in glb. Found "+t);const e=s.getUint32(o+4,!0),i=new Uint8Array(s.buffer,s.byteOffset+o+8,t);r.push({length:t,type:e,data:i}),o+=t+8}1===r.length||2===r.length?1313821514===r[0].type?r.length>1&&5130562!==r[1].type?e("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+r[1].type.toString(16)):e(null,{gltfChunk:r[0].data,binaryChunk:2===r.length?r[1].data:null}):e("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+r[0].type.toString(16)):e("Invalid number of chunks found in glb file.")}(e,s):s(null,{gltfChunk:e,binaryChunk:null})},Sg=function(t,e,s,i){const n=[],a=s&&s.bufferView&&s.bufferView.preprocess,r=s&&s.bufferView&&s.bufferView.processAsync||function(t,e,s){s(null,null)},o=s&&s.bufferView&&s.bufferView.postprocess;let h=t.bufferViews?t.bufferViews.length:0;if(!h)return void i(null,null);const l=function(e,s){const a=t.bufferViews[e];a.hasOwnProperty("byteStride")&&(s.byteStride=a.byteStride),n[e]=s,o&&o(a,s),0==--h&&i(null,n)};for(let s=0;s<t.bufferViews.length;++s){const n=t.bufferViews[s];a&&a(n),r(n,e,function(t,s,n,a){if(n)i(n);else if(a)l(t,a);else{const i=e[s.buffer],n=new Uint8Array(i.buffer,i.byteOffset+(s.byteOffset||0),s.byteLength);l(t,n)}}.bind(null,s,n))}};class wg{static parseAsync(t,e,s,i,n,a,r){bg(t,s,(function(t,s){t?r(t):xg(s.gltfChunk,(function(t,o){t?r(t):function(t,e,s,i,n){const a=[];if(!t.buffers||0===t.buffers.length)return void n(null,a);const r=i&&i.buffer&&i.buffer.preprocess,o=i&&i.buffer&&i.buffer.processAsync||function(t,e){e(null,null)},h=i&&i.buffer&&i.buffer.postprocess;let l=t.buffers.length;const c=function(e,s){a[e]=s,h&&h(t.buffers[e],s),0==--l&&n(null,a)};for(let i=0;i<t.buffers.length;++i){const a=t.buffers[i];r&&r(a),o(a,function(t,i,a,r){if(a)n(a);else if(r)c(t,new Uint8Array(r));else if(i.hasOwnProperty("uri"))if($_(i.uri)){const e=atob(i.uri.split(",")[1]),s=new Uint8Array(e.length);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);c(t,s)}else Y.get(v.join(s,i.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(t,e,s){e?n(e):c(t,new Uint8Array(s))}.bind(null,t));else c(t,e)}.bind(null,i,a))}}(o,s.binaryChunk,e,a,(function(t,s){t?r(t):Sg(o,s,a,(function(t,s){t?r(t):function(t,e,s,i,n,a){if(!t.hasOwnProperty("images")||0===t.images.length||!t.hasOwnProperty("textures")||0===t.textures.length)return void a(null,[]);const r=n&&n.texture&&n.texture.preprocess,o=n&&n.texture&&n.texture.processAsync||function(t,e,s){s(null,null)},h=n&&n.texture&&n.texture.postprocess,l=[],c=[];let d=t.textures.length;const u=function(e,s){if(c[s]||(c[s]=[]),c[s].push(e),0==--d){const e=[];c.forEach((function(s,i){s.forEach((function(s,n){const a=0===n?l[i]:rg(l[i]);!function(t,e){const s=function(t,e){switch(t){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return e}},i=function(t,e){switch(t){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return e}};t&&(e=e||{},t.minFilter=s(e.minFilter,5),t.magFilter=s(e.magFilter,1),t.addressU=i(e.wrapS,0),t.addressV=i(e.wrapT,0))}(a.resource,(t.samplers||[])[t.textures[s].sampler]),e[s]=a,h&&h(t.textures[s],a)}))})),a(null,e)}};for(let h=0;h<t.textures.length;++h){const c=t.textures[h];r&&r(c),o(c,t.images,function(r,o,h,c){var d,p;if(h)a(h);else if(null==c&&void 0===(c=null==o||null==(d=o.extensions)||null==(p=d.KHR_texture_basisu)?void 0:p.source)&&(c=o.source),l[c])u(r,c);else{const o=t.images[c];vg(o,r,e,s,i,n,(function(t,e){t?a(t):(l[c]=e,u(r,c))}))}}.bind(null,h,c))}}(o,s,e,n,a,(function(t,e){t?r(t):gg(i,o,s,e,a,r)}))}))}))}))}))}static parse(t,e,s,i){let n=null;return i=i||{},bg(t,e,(function(t,e){t?console.error(t):xg(e.gltfChunk,(function(t,a){t?console.error(t):Sg(a,[e.binaryChunk],i,(function(t,e){t?console.error(t):gg(s,a,e,[],i,(function(t,e){t?console.error(t):n=e}))}))}))})),n}constructor(t,e,s){this._device=t,this._assets=e,this._defaultMaterial=dg({name:"defaultGlbMaterial"},[]),this.maxRetries=s}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}load(t,e,s){vp.fetchArrayBuffer(t.load,((i,n)=>{i?e(i):wg.parseAsync(this._getUrlWithoutParams(t.original),v.extractPath(t.load),n,this._device,s.registry,s.options,((t,i)=>{t?e(t):e(null,new Y_(i,s,this._assets,this._defaultMaterial))}))}),s,this.maxRetries)}open(t,e,s){return e}patch(t,e){}}class Tg{constructor(t){this.handlerType="animation",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(".glb"===v.getExtension(t.original).toLowerCase()?s.responseType=j.ResponseType.ARRAY_BUFFER:s.responseType=j.ResponseType.JSON),Y.get(t.load,s,(function(s,i){s?e(`Error loading animation resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){if(".glb"===v.getExtension(t).toLowerCase()){const t=wg.parse("filename.glb",e,null);if(t){const e=t.animations;return t.destroy(),e}return null}return this["_parseAnimationV"+e.animation.version](e)}patch(t,e){}_parseAnimationV3(t){const e=t.animation,s=new ff;s.name=e.name,s.duration=e.duration;for(let t=0;t<e.nodes.length;t++){const i=new mf,n=e.nodes[t];i._name=n.name;for(let t=0;t<n.keys.length;t++){const e=n.keys[t],s=e.time,a=e.pos,r=e.rot,o=e.scale,h=new at(a[0],a[1],a[2]),l=(new ft).setFromEulerAngles(r[0],r[1],r[2]),c=new at(o[0],o[1],o[2]),d=new pf(s,h,l,c);i._keys.push(d)}s.addNode(i)}return s}_parseAnimationV4(t){const e=t.animation,s=new ff;s.name=e.name,s.duration=e.duration;for(let t=0;t<e.nodes.length;t++){const i=new mf,n=e.nodes[t];i._name=n.name;const a=n.defaults.p,r=n.defaults.r,o=n.defaults.s;for(let t=0;t<n.keys.length;t++){const e=n.keys[t],s=e.t,h=a||e.p,l=r||e.r,c=o||e.s,d=new at(h[0],h[1],h[2]),u=(new ft).setFromEulerAngles(l[0],l[1],l[2]),p=new at(c[0],c[1],c[2]),m=new pf(s,d,u,p);i._keys.push(m)}s.addNode(i)}return s}}const Mg=function(){if("undefined"==typeof window)return!1;const t=window.navigator.userAgent,e=t.indexOf("MSIE ");if(e>0)return parseInt(t.substring(e+5,t.indexOf(".",e)),10);if(t.indexOf("Trident/")>0){const e=t.indexOf("rv:");return parseInt(t.substring(e+3,t.indexOf(".",e)),10)}return!1}(),Cg=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"];class Ag{constructor(t){this.handlerType="audio",this.manager=t.soundManager,this.maxRetries=0}_isSupported(t){const e=v.getExtension(t);return Cg.indexOf(e)>-1}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=function(t){e(null,new P_(t))},i=function(s){let i="Error loading audio url: "+t.original;s&&(i+=": "+(s.message||s)),console.warn(i),e(i)};if(this._createSound){if(!this._isSupported(t.original))return void i(`Audio format for ${t.original} not supported`);this._createSound(t.load,s,i)}else i(null)}open(t,e){return e}patch(t,e){}_createSound(t,e,s){if(S_()){const i=this.manager;if(!i.context)return void s("Audio manager has no audio context");const n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.startsWith("blob:")||t.startsWith("data:"))&&(n.responseType=j.ResponseType.ARRAY_BUFFER),Y.get(t,n,(function(t,n){t?s(t):i.context.decodeAudioData(n,e,s)}))}else{let i=null;try{i=new Audio}catch(t){return void s("No support for Audio element")}Mg&&document.body.appendChild(i);const n=function t(){i.removeEventListener("canplaythrough",t),Mg&&document.body.removeChild(i),e(i)};i.onerror=function(){i.onerror=null,Mg&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",n),i.src=t}}}class Pg{constructor(t){this.handlerType="binary",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),Y.get(t.load,{responseType:j.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading binary resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class Eg{instantiateModelEntity(t){return null}instantiateRenderEntity(t){return null}}class Rg{constructor(t){this.handlerType="container",this.glbParser=new wg(t.graphicsDevice,t.assets,0),this.parsers={}}set maxRetries(t){this.glbParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.glbParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=t?v.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".",""):null;return this.parsers[e]||this.glbParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return this._getParser(t).open(t,e,s)}patch(t,e){}}class Lg{constructor(t){this.handlerType="css",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading css resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}function Ig(t){const e=document.createElement("style");return e.type="text/css",e.styleSheet?e.styleSheet.cssText=t:e.appendChild(document.createTextNode(t)),e}class Dg{constructor(t){this.handlerType="cubemap",this._device=t.graphicsDevice,this._registry=t.assets,this._loader=t.loader}load(t,e,s){this.loadAssets(s,e)}open(t,e,s){return s?s.resource:null}patch(t,e){this.loadAssets(t,(function(s,i){s&&(e.fire("error",t),e.fire("error:"+t.id,s,t),t.fire("error",t))}))}getAssetIds(t){const e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(let s=0;s<6;++s)e[s+1]=t.data.textures[s];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e}compareAssetIds(t,e){return t&&e?parseInt(t,10)===t||"string"==typeof t?t===e:t.url===e.url:null!==t==(null!==e)}update(t,e,s){const i=t.data||{},n=t._handlerState.assets,a=t._resources;let r,o,h;const l=[null,null,null,null,null,null,null],c=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?"rgbm":"default":null};if(t.loaded&&s[0]===n[0])l[1]=a[1]||null,l[2]=a[2]||null,l[3]=a[3]||null,l[4]=a[4]||null,l[5]=a[5]||null,l[6]=a[6]||null;else if(s[0])for(r=s[0].resource,h=0;h<6;++h)l[h+1]=new Mo(this._device,{name:t.name+"_prelitCubemap"+(r.width>>h),cubemap:!0,type:c()||r.type,width:r.width>>h,height:r.height>>h,format:r.format,levels:[r._levels[h]],fixCubemapSeams:!0,addressU:1,addressV:1,mipmaps:0===h});const d=s.slice(1);if(t.loaded&&this.cmpArrays(d,n.slice(1)))l[0]=a[0]||null;else if(-1===d.indexOf(null)){const e=d.map((function(t){return t.resource})),n=[];for(o=0;o<e[0]._levels.length;++o)n.push(e.map((function(t){return t._levels[o]})));const a=e[0].format,r=new Mo(this._device,{name:t.name+"_faces",cubemap:!0,type:c()||e[0].type,width:e[0].width,height:e[0].height,format:6===a?7:a,levels:n,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:e[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:e[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!s[0]});l[0]=r}if(!this.cmpArrays(l,a))for(t.resources=l,t._handlerState.assetIds=e,t._handlerState.assets=s,h=0;h<a.length;++h)null!==a[h]&&-1===l.indexOf(a[h])&&a[h].destroy();for(h=0;h<n.length;++h)null!==n[h]&&-1===s.indexOf(n[h])&&n[h].unload()}cmpArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}resolveId(t){const e=parseInt(t,10);return e===t||e.toString()===t?e:t}loadAssets(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(t),n=[null,null,null,null,null,null,null],a=t._handlerState.assetIds,r=t._handlerState.assets,o=s._registry;let h=7;const l=function(a,r){n[a]=r,h--,0===h&&(s.update(t,i,n),e(null,t.resources))},c=function(t,s,i){e(s)},d=function(t,e){e.loaded?l(t,e):(o.once("load:"+e.id,l.bind(s,t)),o.once("error:"+e.id,c.bind(s,t)),e.loading||o.load(e))};let u;for(let e=0;e<7;++e){const n=this.resolveId(i[e]);if(n)if(s.compareAssetIds(n,a[e]))l(e,r[e]);else if(parseInt(n,10)===n)u=o.get(n),u?d(e,u):setTimeout(function(t,e){const s=o.get(e);s?d(t,s):c(0,"failed to find dependent cubemap asset="+e)}.bind(null,e,n));else{const i="string"==typeof n?{url:n,filename:n}:n;u=new vp(t.name+"_part_"+e,"texture",i),o.add(u),o.once("load:"+u.id,l.bind(s,e)),o.once("error:"+u.id,c.bind(s,e)),o.load(u)}else l(e,null)}}}class Og{constructor(){this.handlerType="folder"}load(t,e){e(null,null)}open(t,e){return e}}function Fg(t){return t.version<3&&(t.version<2&&(t.info.maps=t.info.maps||[{width:t.info.width,height:t.info.height}]),t.chars=Object.keys(t.chars||{}).reduce((function(e,s){const i=t.chars[s],n=void 0!==i.letter?i.letter:F.fromCodePoint(s);return t.version<2&&(i.map=i.map||0),e[n]=i,e}),{}),t.version=3),t}class kg{constructor(t){this.handlerType="font",this._loader=t.loader,this.maxRetries=0}load(t,e,s){"string"==typeof t&&(t={load:t,original:t});const i=this;".json"===v.getExtension(t.original)?Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,n){if(s)e(`Error loading font resource: ${t.original} [${s}]`);else{const s=Fg(n);i._loadTextures(t.load.replace(".json",".png"),s,(function(t,i){if(t)return e(t);e(null,{data:s,textures:i})}))}})):(s&&s.data&&(s.data=Fg(s.data)),this._loadTextures(t.load,s&&s.data,e))}_loadTextures(t,e,s){const i=e.info.maps.length;let n=0,a=null;const r=new Array(i),o=this._loader,h=function(e){const h=function(t,o){if(!a){if(t)return a=t,s(t);o.upload(),r[e]=o,n++,n===i&&s(null,r)}};0===e?o.load(t,"texture",h):o.load(t.replace(".png",e+".png"),"texture",h)};for(let t=0;t<i;t++)h(t)}open(t,e,s){let i;return i=e.textures?new g_(e.textures,e.data):new g_(e,null),i}patch(t,e){const s=t.resource;!s.data&&t.data?s.data=t.data:!t.data&&s.data&&(t.data=s.data),t.data&&(t.data=Fg(t.data))}}const Bg=function(t,e,s){const i=s.singleVecs;let n,a;const r=e.___1;r||(n=s.tripleVecs,a=e.___2);let o=r?r[0]:n[a];t.setLocalPosition(i[o],i[o+1],i[o+2]),o=r?r[1]:n[a+1],t.setLocalEulerAngles(i[o],i[o+1],i[o+2]),o=r?r[2]:n[a+2],t.setLocalScale(i[o],i[o+1],i[o+2])},zg=function(t,e){const s=t.charCodeAt(0)-e.fieldFirstCode;return e.fieldArray[s]},Ug=function(t,e){let s=0;for(let i=0;i<t.length;i++)s=s*e.fieldCodeBase+t.charCodeAt(i)-e.fieldFirstCode;return e.fieldArray[s]};class Vg{constructor(t,e){this._node=t,this._data=e}run(){const t=Object.prototype.toString.call(this._node);return"[object Object]"===t?this._handleMap():"[object Array]"===t?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={};Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(t){let e=t;const s=t.length;1===s?e=zg(t,this._data):2===s&&(e=Ug(t,this._data)),this._result[e]=new Vg(this._node[t],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(t){const e=new Vg(t,this._data).run();this._result.push(e)}}class Ng{constructor(t,e){this._app=t,this._isTemplate=e}parse(t){const e={};let s=null;const i=t.compressedFormat;i&&!t.entDecompressed&&(t.entDecompressed=!0,t.entities=new Vg(t.entities,i).run());for(const n in t.entities){const a=t.entities[n],r=this._createEntity(a,i);e[n]=r,null===a.parent&&(s=r)}for(const s in t.entities){const i=e[s],n=t.entities[s].children,a=n.length;for(let t=0;t<a;t++){const s=e[n[t]];s&&i.addChild(s)}}return this._openComponentData(s,t.entities),s}_createEntity(t,e){const s=new tm(t.name,this._app);if(s.setGuid(t.resource_id),this._setPosRotScale(s,t,e),s._enabled=void 0===t.enabled||t.enabled,this._isTemplate?s._template=!0:s._enabledInHierarchy=s._enabled,s.template=t.template,t.tags)for(let e=0;e<t.tags.length;e++)s.tags.add(t.tags[e]);return t.labels&&t.labels.forEach((function(t){s.addLabel(t)})),s}_setPosRotScale(t,e,s){if(s)Bg(t,e,s);else{const s=e.position,i=e.rotation,n=e.scale;t.setLocalPosition(s[0],s[1],s[2]),t.setLocalEulerAngles(i[0],i[1],i[2]),t.setLocalScale(n[0],n[1],n[2])}}_openComponentData(t,e){const s=this._app.systems.list;let i=s.length;const n=e[t.getGuid()];for(let e=0;e<i;e++){const i=s[e],a=n.components[i.id];a&&i.addComponent(t,a)}i=n.children.length;const a=t._children;for(let t=0;t<i;t++)a[t]=this._openComponentData(a[t],e);return t}}const Wg=function(t,e,s){"string"==typeof t&&(t={load:t,original:t}),Y.get(t.load,{retry:e>0,maxRetries:e},(function(e,i){if(e){let i="Error while loading scene JSON "+t.original;e.message?(i+=": "+e.message,e.stack&&(i+="\n"+e.stack)):i+=": "+e,s(i)}else s(e,i)}))};class Gg{constructor(t){this.handlerType="hierarchy",this._app=t,this.maxRetries=0}load(t,e){Wg(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const s=new Ng(this._app,!1).parse(e);return this._app.systems.script.preloading=!1,s}}class Hg{constructor(t){this.handlerType="html",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading html resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class Xg{constructor(t){this.handlerType="json",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=j.ResponseType.JSON),Y.get(t.load,s,(function(s,i){s?e(`Error loading JSON resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class qg{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),depthFunc:this._createEnumValidator([0,1,2,3,4,5,6,7]),shadingModel:this._createEnumValidator([0,1])}}setInvalid(t,e){this.valid=!1,this.removeInvalid&&delete e[t]}validate(t){const e=Uh,s="path"===t.mappingFormat;for(const i in t){const n=e[i];if(n)if(n.startsWith("enum")){const e=n.split(":")[1];this.enumValidators[e]&&(this.enumValidators[e](t[i])||this.setInvalid(i,t))}else if("number"===n)"number"!=typeof t[i]&&this.setInvalid(i,t);else if("boolean"===n)"boolean"!=typeof t[i]&&this.setInvalid(i,t);else if("string"===n)"string"!=typeof t[i]&&this.setInvalid(i,t);else if("vec2"===n)t[i]instanceof Array&&2===t[i].length||this.setInvalid(i,t);else if("rgb"===n)t[i]instanceof Array&&3===t[i].length||this.setInvalid(i,t);else if("texture"===n)s?"string"!=typeof t[i]&&null!==t[i]&&(t[i]instanceof Mo||this.setInvalid(i,t)):"number"!=typeof t[i]&&null!==t[i]&&(t[i]instanceof Mo||this.setInvalid(i,t));else if("boundingbox"===n)t[i].center&&t[i].center instanceof Array&&3===t[i].center.length||this.setInvalid(i,t),t[i].halfExtents&&t[i].halfExtents instanceof Array&&3===t[i].halfExtents.length||this.setInvalid(i,t);else if("cubemap"===n)"number"!=typeof t[i]&&null!==t[i]&&void 0!==t[i]&&(t[i]instanceof Mo&&t[i].cubemap||this.setInvalid(i,t));else if("chunks"===n){const e=Object.keys(t[i]);for(let s=0;s<e.length;s++)"string"!=typeof t[i][e[s]]&&this.setInvalid(e[s],t[i])}else console.error("Unknown material type: "+n);else this.valid=!1}return t.validated=!0,this.valid}_createEnumValidator(t){return function(e){return t.indexOf(e)>=0}}}class jg{constructor(){this._validator=null}parse(t){const e=this.migrate(t),s=this._validate(e),i=new Xh;return this.initialize(i,s),i}initialize(t,e){e.validated||(e=this._validate(e)),e.chunks&&(t.chunks=Sf({},e.chunks));for(const s in e){const i=Uh[s],n=e[s];if("vec2"===i)t[s]=new ot(n[0],n[1]);else if("rgb"===i)t[s]=new et(n[0],n[1],n[2]);else if("texture"===i)n instanceof Mo?t[s]=n:t[s]instanceof Mo&&"number"==typeof n&&n>0||(t[s]=null);else if("cubemap"===i)n instanceof Mo?t[s]=n:t[s]instanceof Mo&&"number"==typeof n&&n>0||(t[s]=null),"cubeMap"!==s||n||(t.prefilteredCubemaps=null);else if("boundingbox"===i){const e=new at(n.center[0],n.center[1],n.center[2]),i=new at(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);t[s]=new bt(e,i)}else t[s]=e[s]}t.update()}migrate(t){let e;void 0===t.shadingModel&&("blinn"===t.shader?t.shadingModel=1:t.shadingModel=0),t.shader&&delete t.shader,t.mapping_format&&(t.mappingFormat=t.mapping_format,delete t.mapping_format);const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(e=0;e<s.length;e++){const i=s[e][0],n=s[e][1];void 0!==t[i]&&void 0===t[n]&&(t[n]=t[i],delete t[i])}const i=["fresnelFactor","shadowSampleType"];for(e=0;e<i.length;e++){const s=i[e];t.hasOwnProperty(s)&&delete t[s]}return t}_validate(t){return t.validated||(this._validator||(this._validator=new qg),this._validator.validate(t)),t}}class Yg{constructor(t,e,s,i,n){this.propertyName=t,this.parent=e,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)}_onAdd(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)}_onRemove(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null}_onUnload(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)}}const Kg={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};class $g{constructor(t){this.handlerType="material",this._assets=t.assets,this._device=t.graphicsDevice,this._placeholderTextures=null,this._parser=new jg,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e&&e(`Error loading material: ${t.original} [${s}]`):e&&(i._engine=!0,e(null,i))}))}open(t,e){const s=this._parser.parse(e);return e._engine&&(s._data=e,delete e._engine),s}_createPlaceholders(){this._placeholderTextures={};const t={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(const e in t){if(!t.hasOwnProperty(e))continue;this._placeholderTextures[e]=new Mo(this._device,{width:2,height:2,format:7,name:"material_placeholder"});const s=this._placeholderTextures[e].lock();for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[4*i+n]=t[e][n];this._placeholderTextures[e].unlock()}}patch(t,e){t.resource._data&&(t._data=t.resource._data,delete t.resource._data),t.data.name=t.name,t.resource.name=t.name,this._bindAndAssignAssets(t,e),t.off("unload",this._onAssetUnload,this),t.on("unload",this._onAssetUnload,this)}_onAssetUnload(t){delete t.data.parameters,delete t.data.chunks,delete t.data.name}_assignTexture(t,e,s){e.resource[t]=s}_getPlaceholderTexture(t){this._placeholderTextures||this._createPlaceholders();const e=Kg[t];return this._placeholderTextures[e]}_assignPlaceholderTexture(t,e){e.resource[t]=this._getPlaceholderTexture(t)}_onTextureLoad(t,e,s){this._assignTexture(t,e,s.resource),e.resource.update()}_onTextureAdd(t,e,s){this._assets.load(s)}_onTextureRemoveOrUnload(t,e,s){const i=e.resource;i&&e.resource[t]===s.resource&&(this._assignPlaceholderTexture(t,e),i.update())}_assignCubemap(t,e,s){e.resource[t]=s[0],"cubeMap"===t&&(e.resource.prefilteredCubemaps=s.slice(1))}_onCubemapLoad(t,e,s){this._assignCubemap(t,e,s.resources),this._parser.initialize(e.resource,e.data)}_onCubemapAdd(t,e,s){0===e.data.shadingModel&&(e.loadFaces=!0),this._assets.load(s)}_onCubemapRemoveOrUnload(t,e,s){const i=e.resource;e.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(t,e,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(t,e){const s=this._parser.migrate(t.data),i=t.resource,n="path"===s.mappingFormat,a=Vh;let r,o,h;for(r=0;r<a.length;r++){o=a[r],h=i._assetReferences[o];const l=s[o],c=i[o],d=c===this._getPlaceholderTexture(o),u=s.validated;!l||c&&u&&!d?h&&(n?h.url=null:h.id=null):(h||(h=new Yg(o,t,e,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[o]=h),n?h.url=t.getAbsoluteUrl(l):h.id=l,h.asset&&(h.asset.resource?this._assignTexture(o,t,h.asset.resource):this._assignPlaceholderTexture(o,t),e.load(h.asset)))}const l=Nh;for(r=0;r<l.length;r++)o=l[r],h=i._assetReferences[o],s[o]&&!t.data.prefilteredCubeMap128&&(h||(h=new Yg(o,t,e,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[o]=h),n?h.url=s[o]:h.id=s[o],h.asset&&(h.asset.loaded&&this._assignCubemap(o,t,h.asset.resources),e.load(h.asset)));this._parser.initialize(i,s)}}class Zg{constructor(t,e){this._device=t,this._defaultMaterial=e}parse(t){const e=wg.parse("filename.glb",t,this._device);if(e){const t=Y_.createModel(e,this._defaultMaterial);return e.destroy(),t}return null}}class Qg{constructor(){this.index=0,this.boneIndices=[0,0,0,0]}}class Jg{constructor(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}addVertex(t,e,s){let i=-1;if(void 0!==this.indexMap[e])i=this.indexMap[e],this.indices.push(i);else{for(let i=0;i<4;i++){if(0===s.blendWeight.data[4*e+i])continue;const n=s.blendIndices.data[4*t.index+i];t.boneIndices[i]=this.getBoneRemap(n)}i=this.vertices.length,this.indices.push(i),this.vertices.push(t),this.indexMap[e]=i}}addPrimitive(t,e,s,i){const n=[];let a=0;const r=t.length;for(let e=0;e<r;e++){const i=t[e].index;for(let t=0;t<4;t++)if(s.blendWeight.data[4*i+t]>0){const e=s.blendIndices.data[4*i+t];let r=!0;for(let t=0;t<a;t++)if(n[t]===e){r=!1;break}if(r){n[a]=e;a+=-1===this.getBoneRemap(e)?1:0}}}if(this.boneIndices.length+a>i)return!1;for(let t=0;t<a;t++)this.boneIndices.push(n[t]);for(let i=0;i<r;i++)this.addVertex(t[i],e[i],s);return!0}getBoneRemap(t){for(let e=0;e<this.boneIndices.length;e++)if(this.boneIndices[e]===t)return e;return-1}}function ty(t,e,s){let i,n,a,r;!function(t){const e=t.vertices,s=t.skins,i=t.meshes,n=t.meshInstances;for(let t=0;t<i.length;t++)i[t].vertices=e[i[t].vertices],void 0!==i[t].skin&&(i[t].skin=s[i[t].skin]);for(let t=0;t<n.length;t++)n[t].mesh=i[n[t].mesh]}(t);const o=t.vertices,h=t.skins;let l;const c=t.meshes,d=t.meshInstances,u=function(t){const e=new Qg;return e.index=t,e};for(i=h.length-1;i>=0;i--)if(h[i].boneNames.length>s){const t=h.splice(i,1)[0],p=[];for(n=0;n<c.length;n++)c[n].skin===t&&p.push(c[n]);for(n=0;n<p.length;n++)r=c.indexOf(p[n]),-1!==r&&c.splice(r,1);if(0===p.length)throw new Error("partitionSkin: There should be at least one mesh that references a skin");const m=p[0].vertices;for(n=1;n<p.length;n++)if(p[n].vertices!==m)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");let f;const _=[],g=[],y=[];let v=0;for(n=0;n<p.length;n++){l=p[n];const t=l.indices;for(let e=l.base;e<l.base+l.count;){r=t[e++],g[0]=u(r),y[0]=r,r=t[e++],g[1]=u(r),y[1]=r,r=t[e++],g[2]=u(r),y[2]=r;let i=!1;for(let t=v;t<_.length;t++)if(f=_[t],f.addPrimitive(g,y,m,s)){i=!0;break}i||(f=new Jg,f.originalMesh=l,f.addPrimitive(g,y,m,s),_.push(f))}v=_.length}const x=[],b=[];for(n=0;n<_.length;n++)if(f=_[n],f.vertices.length&&f.indices.length){const t=x.length,e=f.vertices.length,s=b.length,i=f.indices.length;let a,r;for(f.partition=n,f.vertexStart=t,f.vertexCount=e,f.indexStart=s,f.indexCount=i,a=0,r=t;a<e;)x[r++]=f.vertices[a++];for(a=0,r=s;a<i;)b[r++]=f.indices[a++]+t}const S=[];for(n=0;n<_.length;n++){f=_[n];const e=[],s=[];for(a=0;a<f.boneIndices.length;a++)e.push(t.inverseBindMatrices[f.boneIndices[a]]),s.push(t.boneNames[f.boneIndices[a]]);const i={inverseBindMatrices:e,boneNames:s};S.push(i),h.push(i)}let w,T,M,C;const A={};for(T in m)A[T]={components:m[T].components,data:[],type:m[T].type};for(T in m)if("blendIndices"===T){const t=A[T].data;for(n=0;n<x.length;n++){const e=x[n].boneIndices;t.push(e[0],e[1],e[2],e[3])}}else for(w=m[T],M=w.data,C=w.components,n=0;n<x.length;n++)for(r=x[n].index,a=0;a<C;a++)A[T].data.push(M[r*C+a]);for(o[o.indexOf(m)]=A,n=0;n<_.length;n++)for(f=_[n],l={aabb:{min:[0,0,0],max:[0,0,0]},vertices:A,skin:S[n],indices:b.splice(0,f.indexCount),type:"triangles",base:0,count:f.indexCount},c.push(l),a=d.length-1;a>=0;a--)d[a].mesh===f.originalMesh&&(d.push({mesh:l,node:d[a].node}),e&&e.push({material:e[a].material,path:e[a].path}));for(n=0;n<_.length;n++)for(f=_[n],a=d.length-1;a>=0;a--)d[a].mesh===f.originalMesh&&(d.splice(a,1),e&&e.splice(a,1))}!function(t){const e=t.vertices,s=t.skins,i=t.meshes,n=t.meshInstances;for(let t=0;t<i.length;t++)i[t].vertices=e.indexOf(i[t].vertices),void 0!==i[t].skin&&(i[t].skin=s.indexOf(i[t].skin));for(let t=0;t<n.length;t++)n[t].mesh=i.indexOf(n[t].mesh)}(t)}const ey={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},sy={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};class iy{constructor(t,e){this._device=t,this._defaultMaterial=e}parse(t){const e=t.model;if(!e)return null;if(e.version<=1)return null;const s=this._parseNodes(t),i=this._parseSkins(t,s),n=this._parseVertexBuffers(t),a=this._parseIndexBuffers(t,n),r=this._parseMorphs(t,s,n),o=this._parseMeshes(t,i.skins,r.morphs,n,a.buffer,a.data),h=this._parseMeshInstances(t,s,o,i.skins,i.instances,r.morphs,r.instances),l=new Du;return l.graph=s[0],l.meshInstances=h,l.skinInstances=i.instances,l.morphInstances=r.instances,l.getGraph().syncHierarchy(),l}_parseNodes(t){const e=t.model,s=[];let i;for(i=0;i<e.nodes.length;i++){const t=e.nodes[i],n=new qo(t.name);n.setLocalPosition(t.position[0],t.position[1],t.position[2]),n.setLocalEulerAngles(t.rotation[0],t.rotation[1],t.rotation[2]),n.setLocalScale(t.scale[0],t.scale[1],t.scale[2]),n.scaleCompensation=!!t.scaleCompensation,s.push(n)}for(i=1;i<e.parents.length;i++)s[e.parents[i]].addChild(s[i]);return s}_parseSkins(t,e){const s=t.model,i=[],n=[];let a,r;if(!this._device.supportsBoneTextures&&s.skins.length>0){ty(s,null,this._device.getBoneLimit())}for(a=0;a<s.skins.length;a++){const t=s.skins[a],o=[];for(r=0;r<t.inverseBindMatrices.length;r++){const e=t.inverseBindMatrices[r];o[r]=(new mt).set(e)}const h=new of(this._device,o,t.boneNames);i.push(h);const l=new xc(h),c=[];for(r=0;r<h.boneNames.length;r++){const t=h.boneNames[r],s=e[0].findByName(t);c.push(s)}l.bones=c,n.push(l)}return{skins:i,instances:n}}_getMorphVertexCount(t,e,s){for(let i=0;i<t.meshes.length;i++){const n=t.meshes[i];if(n.morph===e){return s[n.vertices].numVertices}}}_parseMorphs(t,e,s){const i=t.model,n=[],a=[];let r,o,h,l,c,d;if(i.morphs){const t=function(t,e,s){const i=new Float32Array(3*s);for(let s=0;s<e.length;s++){const n=3*e[s];i[n]=t[3*s],i[n+1]=t[3*s+1],i[n+2]=t[3*s+2]}return i};for(r=0;r<i.morphs.length;r++){for(l=i.morphs[r].targets,d=[],h=this._getMorphVertexCount(i,r,s),o=0;o<l.length;o++){const e=l[o].aabb,s=e.min,i=e.max,n=new bt(new at(.5*(i[0]+s[0]),.5*(i[1]+s[1]),.5*(i[2]+s[2])),new at(.5*(i[0]-s[0]),.5*(i[1]-s[1]),.5*(i[2]-s[2]))),a=l[o].indices;let r=l[o].deltaPositions,u=l[o].deltaNormals;a&&(r=t(r,a,h),u=t(u,a,h)),c=new hm({deltaPositions:r,deltaNormals:u,name:l[o].name,aabb:n}),d.push(c)}const e=new Lu(d,this._device);n.push(e);const u=new Iu(e);a.push(u)}}return{morphs:n,instances:a}}_parseVertexBuffers(t){const e=t.model,s=[],i={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"};for(let t=0;t<e.vertices.length;t++){const n=e.vertices[t],a=[];for(const t in n){const e=n[t];a.push({semantic:i[t],components:e.components,type:sy[e.type],normalize:"COLOR"===i[t]})}const r=new Hr(this._device,a),o=n.position.data.length/n.position.components,h=new Wr(this._device,r,o),l=new wl(h);for(let t=0;t<o;t++){for(const e in n){const s=n[e];switch(s.components){case 1:l.element[i[e]].set(s.data[t]);break;case 2:l.element[i[e]].set(s.data[2*t],1-s.data[2*t+1]);break;case 3:l.element[i[e]].set(s.data[3*t],s.data[3*t+1],s.data[3*t+2]);break;case 4:l.element[i[e]].set(s.data[4*t],s.data[4*t+1],s.data[4*t+2],s.data[4*t+3])}}l.next()}l.end(),s.push(h)}return s}_parseIndexBuffers(t,e){const s=t.model;let i,n=null,a=null,r=0;for(i=0;i<s.meshes.length;i++){const t=s.meshes[i];void 0!==t.indices&&(r+=t.indices.length)}let o=0;for(i=0;i<e.length;i++)o=Math.max(o,e[i].numVertices);return r>0&&(o>65535&&this._device.extUintElement?(n=new ll(this._device,2,r),a=new Uint32Array(n.lock())):(n=new ll(this._device,1,r),a=new Uint16Array(n.lock()))),{buffer:n,data:a}}_parseMeshes(t,e,s,i,n,a){const r=t.model,o=[];let h=0;for(let t=0;t<r.meshes.length;t++){const l=r.meshes[t],c=l.aabb,d=c.min,u=c.max,p=new bt(new at(.5*(u[0]+d[0]),.5*(u[1]+d[1]),.5*(u[2]+d[2])),new at(.5*(u[0]-d[0]),.5*(u[1]-d[1]),.5*(u[2]-d[2]))),m=void 0!==l.indices,f=new ec(this._device);f.vertexBuffer=i[l.vertices],f.indexBuffer[0]=m?n:null,f.primitive[0].type=ey[l.type],f.primitive[0].base=m?l.base+h:l.base,f.primitive[0].count=l.count,f.primitive[0].indexed=m,f.skin=void 0!==l.skin?e[l.skin]:null,f.morph=void 0!==l.morph?s[l.morph]:null,f.aabb=p,m&&(a.set(l.indices,h),h+=l.indices.length),o.push(f)}return null!==n&&n.unlock(),o}_parseMeshInstances(t,e,s,i,n,a,r){const o=t.model,h=[];let l;for(l=0;l<o.meshInstances.length;l++){const t=o.meshInstances[l],c=e[t.node],d=s[t.mesh],u=new Ec(d,this._defaultMaterial,c);if(d.skin){const t=i.indexOf(d.skin);u.skinInstance=n[t]}if(d.morph){const t=a.indexOf(d.morph);u.morphInstance=r[t]}h.push(u)}return h}}class ny{constructor(t){this.handlerType="model",this._device=t.graphicsDevice,this._parsers=[],this._defaultMaterial=Dh(this._device),this.maxRetries=0,this.addParser(new iy(this._device,this._defaultMaterial),(function(t,e){return".json"===v.getExtension(t)})),this.addParser(new Zg(this._device,this._defaultMaterial),(function(t,e){return".glb"===v.getExtension(t)}))}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(".glb"===v.getExtension(t.original).toLowerCase()?s.responseType=j.ResponseType.ARRAY_BUFFER:s.responseType=j.ResponseType.JSON),Y.get(t.load,s,(function(s,i){e&&(s?e(`Error loading model: ${t.original} [${s}]`):e(null,i))}))}open(t,e){for(let s=0;s<this._parsers.length;s++){const i=this._parsers[s];if(i.decider(t,e))return i.parser.parse(e)}return null}patch(t,e){if(!t.resource)return;const s=t.data,i=this;t.resource.meshInstances.forEach((function(n,a){if(s.mapping){const r=function t(s){s.resource?n.material=s.resource:(s.once("load",t),e.load(s)),s.once("remove",(function(t){n.material===t.resource&&(n.material=i._defaultMaterial)}))};if(!s.mapping[a])return void(n.material=i._defaultMaterial);const o=s.mapping[a].material,h=s.mapping[a].path;let l;if(void 0!==o)o?(l=e.get(o),l?r(l):e.once("add:"+o,r)):n.material=i._defaultMaterial;else if(h){const i=t.getAbsoluteUrl(s.mapping[a].path);l=e.getByUrl(i),l?r(l):e.once("add:url:"+i,r)}}}))}addParser(t,e){this._parsers.push({parser:t,decider:e})}}function ay(t){const e=this;if(!e.resource)return;const s=t.resource,i=s.renders&&s.renders[e.data.renderIndex];i&&(e.resource.meshes=i.resource.meshes)}function ry(t){const e=this;e.registry.off("load:"+t.id,ay,e),e.registry.on("load:"+t.id,ay,e),e.registry.off("remove:"+t.id,oy,e),e.registry.once("remove:"+t.id,oy,e),t.resource?ay.call(e,t):e.registry.load(t)}function oy(t){const e=this;e.registry.off("load:"+t.id,ay,e),e.resource&&e.resource.destroy()}class hy{constructor(t){this.handlerType="render",this._registry=t.assets}load(t,e,s){}open(t,e){return new X_}patch(t,e){if(!t.data.containerAsset)return;const s=e.get(t.data.containerAsset);s?ry.call(t,s):e.once("add:"+t.data.containerAsset,ry,t)}}class ly{load(t,e,s){throw new Error("not implemented")}open(t,e,s){throw new Error("not implemented")}patch(t,e){}}class cy{constructor(t){this.handlerType="scene",this._app=t,this.maxRetries=0}load(t,e){Wg(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const s=new Ng(this._app,!1).parse(e),i=this._app.scene;return i.root=s,this._app.applySceneSettings(e.settings),this._app.systems.script.preloading=!1,i}patch(t,e){}}class dy{constructor(t){this._app=t,this.maxRetries=0}load(t,e){Wg(t,this.maxRetries,e)}open(t,e){return e.settings}}class uy{constructor(t){this.handlerType="shader",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading shader resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}function py(t){const e=this;e.resource&&(e.resource.atlas=t.resource)}function my(t){this.registry.load(t)}class fy{constructor(t){this.handlerType="sprite",this._assets=t.assets,this._device=t.graphicsDevice,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),".json"===v.getExtension(t.original)&&Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(t,s){t?e(t):e(null,s)}))}open(t,e){const s=new cf(this._device);return t&&(s.__data=e),s}patch(t,e){const s=t.resource;if(s.__data&&(t.data.pixelsPerUnit=s.__data.pixelsPerUnit,t.data.renderMode=s.__data.renderMode,t.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=e.getByUrl(s.__data.textureAtlasAsset);i?t.data.textureAtlasAsset=i.id:console.warn("Could not find textureatlas with url: "+s.__data.textureAtlasAsset)}s.startUpdate(),s.renderMode=t.data.renderMode,s.pixelsPerUnit=t.data.pixelsPerUnit,s.frameKeys=t.data.frameKeys,this._updateAtlas(t),s.endUpdate(),t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_updateAtlas(t){const e=t.resource;if(!t.data.textureAtlasAsset)return void(e.atlas=null);this._assets.off("load:"+t.data.textureAtlasAsset,py,t),this._assets.on("load:"+t.data.textureAtlasAsset,py,t);const s=this._assets.get(t.data.textureAtlasAsset);s&&s.resource?e.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+t.data.textureAtlasAsset,my,t),this._assets.on("add:"+t.data.textureAtlasAsset,my,t))}_onAssetChange(t,e,s,i){"data"===e&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,py,t),this._assets.off("add:"+i.textureAtlasAsset,my,t))}}class _y{constructor(t,e){this._app=t,this._data=e,this._templateRoot=null}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const t=new Ng(this._app,!0);this._templateRoot=t.parse(this._data)}}class gy{constructor(t){this.handlerType="template",this._app=t,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};Y.get(t.load,s,(function(s,i){s?e("Error requesting template: "+t.original):e(s,i)}))}open(t,e){return new _y(this._app,e)}}class yy{constructor(t){this.handlerType="text",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading text resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class vy{constructor(t,e){this.device=e,this.maxRetries=0}load(t,e,s){const i=this.device;vp.fetchArrayBuffer(t.load,((n,a)=>{n?e(n):(n=>{var a,r,o;W_(i,t.load,n,e,{isGGGR:0!=(8&(null==s||null==(a=s.file)||null==(r=a.variants)||null==(o=r.basis)?void 0:o.opt))})||e(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`)})(a)}),s,this.maxRetries)}open(t,e,s){const i=new Mo(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}}class xy{constructor(t){this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.useImageBitmap=!1}load(t,e,s){var i;const n=!(null==s||null==(i=s.file)||!i.contents);n&&(t={load:URL.createObjectURL(new Blob([s.file.contents])),original:t.original});const a=(s,i)=>{n&&URL.revokeObjectURL(t.load),e(s,i)};let r;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?r=s.options.crossOrigin:tp.test(t.load)&&(r=this.crossOrigin),this.useImageBitmap?this._loadImageBitmap(t.load,t.original,r,a):this._loadImage(t.load,t.original,r,a)}open(t,e,s){const i=v.getExtension(t).toLowerCase(),n=".jpg"===i||".jpeg"===i?6:7,a=new Mo(s,{name:t,width:e.width,height:e.height,format:n});return a.setSource(e),a}_loadImage(t,e,s,i){const n=new Image;s&&(n.crossOrigin=s);let a=0;const r=this.maxRetries;let o;n.onload=function(){i(null,n)},n.onerror=function(){if(!o)if(r>0&&++a<=r){const s=100*Math.pow(2,a);console.log(`Error loading Texture from: '${e}' - Retrying in ${s}ms...`);const i=t.indexOf("?")>=0?"&":"?";o=setTimeout((function(){n.src=t+i+"retry="+Date.now(),o=null}),s)}else i(`Error loading Texture from: '${e}'`)},n.src=t}_loadImageBitmap(t,e,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Y.get(t,n,(function(t,e){t?i(t):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(t){i(null,t)})).catch((function(t){i(t)}))}))}}const by=[1481919403,3140563232,169478669],Sy={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12};class wy{constructor(t){this.maxRetries=0}load(t,e,s){vp.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new Mo(s,{name:t,addressU:i.cubemap?1:0,addressV:i.cubemap?1:0,width:i.width,height:i.height,format:i.format,cubemap:i.cubemap,levels:i.levels});return n.upload(),n}parse(t){const e=new Uint32Array(t);if(by[0]!==e[0]||by[1]!==e[1]||by[2]!==e[2])return null;const s={endianness:e[3],glType:e[4],glTypeSize:e[5],glFormat:e[6],glInternalFormat:e[7],glBaseInternalFormat:e[8],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const i=Sy[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4;const a=s.numberOfFaces>1,r=[];for(let c=0;c<(s.numberOfMipmapLevels||1);c++){const s=e[n++];a&&r.push([]);const d=a?r[c]:r;for(let e=0;e<(a?6:1);++e)d.push((o=t,h=4*n,l=s,18===i?new Uint32Array(o,h,l/4):new Uint8Array(o,h,l))),n+=s+3>>2}var o,h,l;return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:r,cubemap:a}}}const Ty=166;class My{constructor(t,e){this.maxRetries=0,this.device=e}load(t,e,s){vp.fetchArrayBuffer(t.load,((i,n)=>{i?e(i,n):this.parse(n,t,e,s)}),s,this.maxRetries)}open(t,e,s){const i=new Mo(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}parse(t,e,s,i){const n=new B(t),a=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==a[0]||540160187!==a[1]||218765834!==a[2])return null;const r={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},h=[];for(let t=0;t<Math.max(1,r.levelCount);++t)h.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);const l=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===r.supercompressionScheme||l===Ty){var c,d,u;W_(this.device,e.load,t,s,{isGGGR:0!=(8&(null==i||null==(c=i.file)||null==(d=c.variants)||null==(u=d.basis)?void 0:u.opt)),isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class Cy{constructor(t){this.maxRetries=0}load(t,e,s){vp.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=new Uint32Array(e,0,32),n=i[4],a=i[3],r=Math.max(i[7],1),o=4===i[20],h=i[21],l=i[22],c=65024===i[28],d=827611204,u=825438800,p=825439312;let m,f=!1,_=!1,g=!1,y=!1,v=null,x=1;if(o?h===d?(v=8,f=!0):894720068===h?(v=10,f=!0):113===h?(v=12,x=2):116===h?(v=14,x=4):826496069===h?(v=21,f=!0,_=!0):h===u||825504336===h?(v=h===u?24:25,f=!0,g=!0):h!==p&&825504848!==h||(v=h===p?26:27,f=!0,y=!0):32===l&&(v=7),!v)return m=new Mo(s,{width:4,height:4,format:6,name:"dds-legacy-empty"}),m;m=new Mo(s,{name:t,addressU:c?1:0,addressV:c?1:0,width:n,height:a,format:v,cubemap:c,mipmaps:r>1});let b=128;const S=c?6:1;let w;const T=h===d?8:16;let M,C,A;for(let t=0;t<S;t++){let s=n,i=a;for(let n=0;n<r;n++){f?_?w=Math.floor((s+3)/4)*Math.floor((i+3)/4)*8:g?w=Math.max(s,16)*Math.max(i,8)/4:y?w=Math.max(s,8)*Math.max(i,8)/2:(M=Math.floor((s+4-1)/4),C=Math.floor((i+4-1)/4),A=M*C,w=A*T):w=s*i*4;const a=14===v?new Float32Array(e,b,w):12===v?new Uint16Array(e,b,w):new Uint8Array(e,b,w);c?(m._levels[n]||(m._levels[n]=[]),m._levels[n][t]=a):m._levels[n]=a,b+=w*x,s=Math.max(.5*s,1),i=Math.max(.5*i,1)}}return m.upload(),m}}class Ay{constructor(t){this.maxRetries=0}load(t,e,s){vp.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new Mo(s,{name:t,addressU:0,addressV:1,minFilter:2,magFilter:0,width:i.width,height:i.height,levels:i.levels,format:7,type:"rgbe",mipmaps:!1});return n.upload(),n}parse(t){const e=new B(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const t=e.readLine();if(0===t.length)break;{const e=t.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const i=e.readLine().split(" ");if(4!==i.length)return null;const n=parseInt(i[1],10),a=parseInt(i[3],10),r=this._readPixels(e,a,n,"-Y"===i[0]);return r?{width:a,height:n,levels:[r]}:null}_readPixels(t,e,s,i){if(e<8||e>32767)return this._readPixelsFlat(t,e,s);const n=[0,0,0,0];if(t.readArray(n),2!==n[0]||2!==n[1]||0!=(128&n[2]))return t.skip(-4),this._readPixelsFlat(t,e,s);const a=new ArrayBuffer(e*s*4),r=new Uint8Array(a);let o,h,l,c,d,u,p=i?0:4*e*(s-1);for(h=0;h<s;++h){if(h&&t.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(c=0;c<4;++c)for(o=0;o<e;)if(d=t.readU8(),d>128){if(d-=128,o+d>e)return null;for(u=t.readU8(),l=0;l<d;++l)r[p+c+4*o++]=u}else{if(0===d||o+d>e)return null;for(l=0;l<d;++l)r[p+c+4*o++]=t.readU8()}p+=4*e*(i?1:-1)}return r}_readPixelsFlat(t,e,s){return t.remainingBytes===e*s*4?new Uint8Array(t.arraybuffer,t.offset):null}}const Py={repeat:0,clamp:1,mirror:2},Ey={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Ry={default:"default",rgbm:"rgbm",rgbe:"rgbe",swizzleGGGR:"swizzleGGGR"};class Ly{load(t,e,s){throw new Error("not implemented")}open(t,e,s){throw new Error("not implemented")}}class Iy{constructor(t){this.handlerType="texture";const e=t.assets,s=t.graphicsDevice;this._device=s,this._assets=e,this._loader=t.loader,this.imgParser=new xy(e),this.parsers={dds:new Cy(e),ktx:new wy(e),ktx2:new My(e,s),basis:new vy(e,s),hdr:new Ay(e)}}set crossOrigin(t){this.imgParser.crossOrigin=t}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(t){this.imgParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=v.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.imgParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){if(!t)return;let i=this._getParser(t).open(t,e,this._device);return null===i?i=new Mo(this._device,{width:4,height:4,format:6}):(!function(t){const e=Math.log2(Math.max(t._width,t._height))+1;if(7!==t._format&&14!==t._format||t._volume||t._compressed||1===t._levels.length||t._levels.length===e||(s=t._cubemap?t._levels[0][0]:t._levels[0])instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement)return;var s;const i=function(t,e,s){const i=Math.max(1,t>>1),n=Math.max(1,e>>1),a=new s.constructor(i*n*4),r=Math.floor(t/i),o=Math.floor(e/n),h=r*o;for(let e=0;e<n;++e)for(let n=0;n<i;++n)for(let l=0;l<4;++l){let c=0;for(let i=0;i<o;++i)for(let a=0;a<r;++a)c+=s[4*(n*r+a+(e*o+i)*t)+l];a[4*(n+e*i)+l]=c/h}return a};for(let s=t._levels.length;s<e;++s){const e=Math.max(1,t._width>>s-1),n=Math.max(1,t._height>>s-1);if(t._cubemap){const a=[];for(let r=0;r<6;++r)a.push(i(e,n,t._levels[s-1][r]));t._levels.push(a)}else t._levels.push(i(e,n,t._levels[s-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(i),e.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),i}patch(t,e){const s=t.resource;if(!s)return;t.name&&t.name.length>0&&(s.name=t.name);const i=t.data;i.hasOwnProperty("minfilter")&&(s.minFilter=Ey[i.minfilter]),i.hasOwnProperty("magfilter")&&(s.magFilter=Ey[i.magfilter]),s.cubemap||(i.hasOwnProperty("addressu")&&(s.addressU=Py[i.addressu]),i.hasOwnProperty("addressv")&&(s.addressV=Py[i.addressv])),i.hasOwnProperty("mipmaps")&&(s.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(s.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(s.flipY=!!i.flipY),i.hasOwnProperty("type")?s.type=Ry[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?s.type="rgbm":t.file&&0!=(8&t.file.opt)&&(s.type="swizzleGGGR")}}const Dy={repeat:0,clamp:1,mirror:2},Oy={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Fy=/^data\.frames\.(\d+)$/;class ky{constructor(t){this.handlerType="textureatlas",this._loader=t.loader,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this,i=this._loader.getHandler("texture");if(".json"!==v.getExtension(t.original))return i.load(t,e);Y.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(i,n){if(i)e(i);else{const i=t.original.replace(".json",".png");s._loader.load(i,"texture",(function(t,s){t?e(t):e(null,{data:n,texture:s})}))}}))}open(t,e){const s=new uf;if(e.texture&&e.data)s.texture=e.texture,s.__data=e.data;else{const i=this._loader.getHandler("texture").open(t,e);if(!i)return null;s.texture=i}return s}patch(t,e){t.resource.__data&&(void 0!==t.resource.__data.minfilter&&(t.data.minfilter=t.resource.__data.minfilter),void 0!==t.resource.__data.magfilter&&(t.data.magfilter=t.resource.__data.magfilter),void 0!==t.resource.__data.addressu&&(t.data.addressu=t.resource.__data.addressu),void 0!==t.resource.__data.addressv&&(t.data.addressv=t.resource.__data.addressv),void 0!==t.resource.__data.mipmaps&&(t.data.mipmaps=t.resource.__data.mipmaps),void 0!==t.resource.__data.anisotropy&&(t.data.anisotropy=t.resource.__data.anisotropy),void 0!==t.resource.__data.rgbm&&(t.data.rgbm=!!t.resource.__data.rgbm),t.data.frames=t.resource.__data.frames,delete t.resource.__data);const s=t.resource.texture;if(s&&(s.name=t.name,t.data.hasOwnProperty("minfilter")&&s.minFilter!==Oy[t.data.minfilter]&&(s.minFilter=Oy[t.data.minfilter]),t.data.hasOwnProperty("magfilter")&&s.magFilter!==Oy[t.data.magfilter]&&(s.magFilter=Oy[t.data.magfilter]),t.data.hasOwnProperty("addressu")&&s.addressU!==Dy[t.data.addressu]&&(s.addressU=Dy[t.data.addressu]),t.data.hasOwnProperty("addressv")&&s.addressV!==Dy[t.data.addressv]&&(s.addressV=Dy[t.data.addressv]),t.data.hasOwnProperty("mipmaps")&&s.mipmaps!==t.data.mipmaps&&(s.mipmaps=t.data.mipmaps),t.data.hasOwnProperty("anisotropy")&&s.anisotropy!==t.data.anisotropy&&(s.anisotropy=t.data.anisotropy),t.data.hasOwnProperty("rgbm"))){const e=t.data.rgbm?"rgbm":"default";s.type!==e&&(s.type=e)}t.resource.texture=s;const i={};for(const e in t.data.frames){const s=t.data.frames[e];i[e]={rect:new ht(s.rect),pivot:new ot(s.pivot),border:new ht(s.border)}}t.resource.frames=i,t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_onAssetChange(t,e,s){let i;if("data"===e||"data.frames"===e){const e={};for(const t in s.frames)i=s.frames[t],e[t]={rect:new ht(i.rect),pivot:new ot(i.pivot),border:new ht(i.border)};t.resource.frames=e}else{const n=e.match(Fy);if(n){const e=n[1];s?(t.resource.frames[e]?(i=t.resource.frames[e],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):t.resource.frames[e]={rect:new ht(s.rect),pivot:new ot(s.pivot),border:new ht(s.border)},t.resource.fire("set:frame",e,t.resource.frames[e])):t.resource.frames[e]&&(delete t.resource.frames[e],t.resource.fire("remove:frame",e))}}}}class By extends _{constructor(t,e){super(),this._assets=new Set,this._loadingAssets=new Set,this._waitingAssets=new Set,this._registry=e,this._loading=!1,this._loaded=!1,this._failed=[],t.forEach((t=>{if(t instanceof vp)t.registry||(t.registry=e),this._assets.add(t);else{const s=e.get(t);s?this._assets.add(s):this._waitForAsset(t)}}))}destroy(){const t=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach((function(e){t._registry.off("add:"+e,this._onAddAsset)})),this.off("progress"),this.off("load")}_assetHasDependencies(t){var e;return"model"===t.type&&(null==(e=t.file)?void 0:e.url)&&t.file.url&&t.file.url.match(/.json$/g)}load(t,e){if(this._loading)return;this._loading=!0,this._callback=t,this._scope=e,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);let s=!1;this._assets.forEach((t=>{t.loaded||(s=!0,this._assetHasDependencies(t)&&this._registry.loadFromUrl(t.file.url,t.type,((e,s)=>{e?this._onError(e,t):this._onLoad(t)})),this._loadingAssets.add(t),this._registry.add(t))})),this._loadingAssets.forEach((t=>{this._assetHasDependencies(t)||this._registry.load(t)})),s||0!==this._waitingAssets.size||this.fire("load",Array.from(this._assets))}ready(t,e=this){this._loaded?t.call(e,Array.from(this._assets)):this.once("load",(function(s){t.call(e,s)}))}_loadingComplete(){this._loaded||(this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))))}_onLoad(t){this._loadingAssets.has(t)&&(this.fire("progress",t),this._loadingAssets.delete(t)),0===this._loadingAssets.size&&setTimeout((()=>{this._loadingComplete(this._failed)}),0)}_onError(t,e){this._loadingAssets.has(e)&&(this._failed.push(e),this._loadingAssets.delete(e)),0===this._loadingAssets.size&&setTimeout((()=>{this._loadingComplete(this._failed)}),0)}_onAddAsset(t){this._waitingAssets.delete(t),this._assets.add(t),t.loaded||(this._loadingAssets.add(t),this._registry.load(t))}_waitForAsset(t){this._waitingAssets.add(t),this._registry.once("add:"+t,this._onAddAsset,this)}}class zy extends _{constructor(t){super(),this._app=t,t.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(t){const e=t instanceof vp?t.id:t;this._defaultAsset!==e&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=e,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(t){const e=t instanceof vp?t.id:t;if(this._localizedAsset!==e&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=e,this._localizedAsset)){this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}}get localizedAsset(){return this._localizedAsset}set autoLoad(t){this._autoLoad!==t&&(this._autoLoad=t,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(t){this._disableLocalization!==t&&(this._disableLocalization=t,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const t=this._app.assets.get(this._defaultAsset);t?this._onDefaultAssetAdd(t):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const t=this._app.assets.get(this._defaultAsset);t&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleRemove,this),t.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(t){this._defaultAsset===t.id&&(t.on("add:localized",this._onLocaleAdd,this),t.on("remove:localized",this._onLocaleRemove,this),t.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(t){this._defaultAsset===t.id&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const t=this._app.assets.get(this._localizedAsset);t&&(t.on("load",this._onLocalizedAssetLoad,this),t.on("change",this._onLocalizedAssetChange,this),t.on("remove",this._onLocalizedAssetRemove,this),t.resource?this._onLocalizedAssetLoad(t):this._app.assets.load(t))}_unbindLocalizedAsset(){const t=this._app.assets.get(this._localizedAsset);t&&(t.off("load",this._onLocalizedAssetLoad,this),t.off("change",this._onLocalizedAssetChange,this),t.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(t){this._localizedAsset===t.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(t){this.fire("load",t)}_onLocalizedAssetChange(t,e,s,i){this.fire("change",t,e,s,i)}_onLocalizedAssetRemove(t){this._localizedAsset===t.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",t)}_onLocaleAdd(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onLocaleRemove(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onSetLocale(t){if(!this._defaultAsset)return void(this.localizedAsset=null);const e=this._app.assets.get(this._defaultAsset);if(!e||this._disableLocalization)return void(this.localizedAsset=this._defaultAsset);const s=e.getLocalizedAssetId(t);this.localizedAsset=s||this._defaultAsset}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const Uy=new Set(["system","entity","create","destroy","swap","move","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","has","get","on","off","fire","once","hasEvent"]);function Vy(t,e){if(Tp.legacy)return null;if(Uy.has(t))throw new Error(`script name: '${t}' is reserved, please change script name`);const s=function(t){_.prototype.initEventHandler.call(this),Op.prototype.initScriptType.call(this,t)};return(s.prototype=Object.create(Op.prototype)).constructor=s,s.extend=Op.extend,s.attributes=new Rp(s),Wy(s,t,e),s}const Ny={};function Wy(t,e,s){if(t.legacy)return;if("function"!=typeof t)throw new Error(`script class: '${t}' must be a constructor function (i.e. class).`);if(!(t.prototype instanceof Op))throw new Error(`script class: '${Op.__getScriptName(t)}' does not extend pc.ScriptType.`);if(e=e||t.__name||Op.__getScriptName(t),Uy.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);t.__name=e;(s?s.scripts:$p.getApplication().scripts).add(t),bp._push(t)}Rp.reservedNames.forEach(((t,e,s)=>{Ny[t]=1})),Vy.reservedAttributes=Ny;const Gy="mouse",Hy="keyboard",Xy="gamepad",qy="mousex",jy="mousey",Yy="padlx",Ky="padly",$y="padrx",Zy="padry",Qy="key",Jy="keydown",tv="keyup",ev="mousedown",sv="mousemove",iv="mouseup",nv="mousewheel",av="touchstart",rv="touchend",ov="touchmove",hv="touchcancel",lv="select",cv="selectstart",dv="selectend",uv=8,pv=9,mv=13,fv=13,_v=16,gv=17,yv=18,vv=19,xv=20,bv=27,Sv=32,wv=33,Tv=34,Mv=35,Cv=36,Av=37,Pv=38,Ev=39,Rv=40,Lv=44,Iv=45,Dv=46,Ov=48,Fv=49,kv=50,Bv=51,zv=52,Uv=53,Vv=54,Nv=55,Wv=56,Gv=57,Hv=59,Xv=61,qv=65,jv=66,Yv=67,Kv=68,$v=69,Zv=70,Qv=71,Jv=72,tx=73,ex=74,sx=75,ix=76,nx=77,ax=78,rx=79,ox=80,hx=81,lx=82,cx=83,dx=84,ux=85,px=86,mx=87,fx=88,_x=89,gx=90,yx=91,vx=93,xx=96,bx=97,Sx=98,wx=99,Tx=100,Mx=101,Cx=102,Ax=103,Px=104,Ex=105,Rx=106,Lx=107,Ix=108,Dx=109,Ox=110,Fx=111,kx=112,Bx=113,zx=114,Ux=115,Vx=116,Nx=117,Wx=118,Gx=119,Hx=120,Xx=121,qx=122,jx=123,Yx=188,Kx=190,$x=191,Zx=219,Qx=220,Jx=221,tb=224,eb=-1,sb=0,ib=1,nb=2,ab=0,rb=1,ob=2,hb=3,lb=0,cb=1,db=2,ub=3,pb=4,mb=5,fb=6,_b=7,gb=8,yb=9,vb=10,xb=11,bb=12,Sb=13,wb=14,Tb=15,Mb=16,Cb=0,Ab=1,Pb=2,Eb=3;class Rb{constructor(t,e){e?(this.key=e.keyCode,this.element=e.target,this.event=e):(this.key=null,this.element=null,this.event=null)}}const Lb=new Rb;function Ib(t){return Lb.key=t.keyCode,Lb.element=t.target,Lb.event=t,Lb}function Db(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t}const Ob={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class Fb extends _{constructor(t,e={}){super(),this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),this._keymap={},this._lastmap={},t&&this.attach(t),this.preventDefault=e.preventDefault||!1,this.stopPropagation=e.stopPropagation||!1}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(t){t=Db(t);const e=Ob[t.toString()];if(e)return e;let s=t.toString(16).toUpperCase();const i=s.length;for(let t=0;t<4-i;t++)s="0"+s;return"U+"+s}_handleKeyDown(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);this._keymap[s]=!0,this.fire("keydown",Ib(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyUp(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);delete this._keymap[s],this.fire("keyup",Ib(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyPress(t){this.fire("keypress",Ib(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const t in this._lastmap)delete this._lastmap[t];for(const t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])}isPressed(t){const e=Db(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]}wasPressed(t){const e=Db(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(t){const e=Db(t),s=this.toKeyIdentifier(e);return!this._keymap[s]&&!!this._lastmap[s]}}function kb(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class Bb{constructor(t,e){let s={x:0,y:0};if(e){if(e instanceof Bb)throw Error("Expected MouseEvent");s=t._getTargetCoords(e)}else e={};if(s)this.x=s.x,this.y=s.y;else{if(!kb())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1)),kb()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),"mousedown"===e.type||"mouseup"===e.type?this.button=e.button:this.button=-1,this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.event=e}}class zb extends _{constructor(t){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this._target=null,this._attached=!1,this.attach(t)}static isPointerLocked(){return kb()}attach(t){if(this._target=t,this._attached)return;this._attached=!0;const e=!!L.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const t=!!L.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(t,e){if(!document.body.requestPointerLock)return void(e&&e());const s=()=>{t(),document.removeEventListener("pointerlockchange",s)},i=()=>{e(),document.removeEventListener("pointerlockerror",i)};t&&document.addEventListener("pointerlockchange",s,!1),e&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(t){if(!document.exitPointerLock)return;const e=()=>{t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(t){return this._buttons[t]}wasPressed(t){return this._buttons[t]&&!this._lastbuttons[t]}wasReleased(t){return!this._buttons[t]&&this._lastbuttons[t]}_handleUp(t){this._buttons[t.button]=!1;const e=new Bb(this,t);e.event&&this.fire("mouseup",e)}_handleDown(t){this._buttons[t.button]=!0;const e=new Bb(this,t);e.event&&this.fire("mousedown",e)}_handleMove(t){const e=new Bb(this,t);e.event&&(this.fire("mousemove",e),this._lastX=e.x,this._lastY=e.y)}_handleWheel(t){const e=new Bb(this,t);e.event&&this.fire("mousewheel",e)}_getTargetCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);return t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?null:{x:t.clientX-s,y:t.clientY-i}}}class Ub{constructor(t,e={}){this._keyboard=e.keyboard||null,this._mouse=e.mouse||null,this._gamepads=e.gamepads||null,this._element=null,this._actions={},this._axes={},this._axesValues={},t&&this.attach(t)}attach(t){this._element=t,this._keyboard&&this._keyboard.attach(t),this._mouse&&this._mouse.attach(t)}detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null}disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()}enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()}update(t){this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={};for(const t in this._axes)this._axesValues[t]=[]}registerKeys(t,e){if(this._keyboard||this._enableKeyboard(),this._actions[t])throw new Error(`Action: ${t} already registered`);if(void 0===e)throw new Error("Invalid button");e.length||(e=[e]),this._actions[t]?this._actions[t].push({type:"keyboard",keys:e}):this._actions[t]=[{type:"keyboard",keys:e}]}registerMouse(t,e){if(this._mouse||this._enableMouse(),void 0===e)throw new Error("Invalid button");this._actions[t]?this._actions[t].push({type:"mouse",button:e}):this._actions[t]=[{type:"mouse",button:-e}]}registerPadButton(t,e,s){if(void 0===s)throw new Error("Invalid button");this._actions[t]?this._actions[t].push({type:"gamepad",button:s,pad:e}):this._actions[t]=[{type:"gamepad",button:s,pad:e}]}registerAxis(t){const e=t.name;this._axes[e]||(this._axes[e]=[]);const s=this._axes[e].push(e);(t=t||{}).pad=t.pad||0;const i=function(i,n,a,r){switch(n){case"mousex":i._mouse.on("mousemove",(function(t){i._axesValues[e][s]=t.dx/10}));break;case"mousey":i._mouse.on("mousemove",(function(t){i._axesValues[e][s]=t.dy/10}));break;case"key":i._axes[e].push((function(){return i._keyboard.isPressed(r)?a:0}));break;case"padrx":i._axes[e].push((function(){return i._gamepads.getAxis(t.pad,2)}));break;case"padry":i._axes[e].push((function(){return i._gamepads.getAxis(t.pad,3)}));break;case"padlx":i._axes[e].push((function(){return i._gamepads.getAxis(t.pad,0)}));break;case"padly":i._axes[e].push((function(){return i._gamepads.getAxis(t.pad,1)}));break;default:throw new Error("Unknown axis")}};i(this,t.positive,1,t.positiveKey),(t.negativeKey||t.negative!==t.positive)&&i(this,t.negative,-1,t.negativeKey)}isPressed(t){if(!this._actions[t])return!1;const e=this._actions[t].length;for(let s=0;s<e;++s){const e=this._actions[t][s];switch(e.type){case"keyboard":if(this._keyboard){const t=e.keys.length;for(let s=0;s<t;s++)if(this._keyboard.isPressed(e.keys[s]))return!0}break;case"mouse":if(this._mouse&&this._mouse.isPressed(e.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.isPressed(e.pad,e.button))return!0}}return!1}wasPressed(t){if(!this._actions[t])return!1;const e=this._actions[t].length;for(let s=0;s<e;++s){const e=this._actions[t][s];switch(e.type){case"keyboard":if(this._keyboard){const t=e.keys.length;for(let s=0;s<t;s++)if(this._keyboard.wasPressed(e.keys[s]))return!0}break;case"mouse":if(this._mouse&&this._mouse.wasPressed(e.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.wasPressed(e.pad,e.button))return!0}}return!1}getAxis(t){let e=0;if(this._axes[t]){const s=this._axes[t].length;for(let i=0;i<s;i++)if("function"===p(this._axes[t][i])){const s=this._axes[t][i]();Math.abs(s)>Math.abs(e)&&(e=s)}else this._axesValues[t]&&Math.abs(this._axesValues[t][i])>Math.abs(e)&&(e=this._axesValues[t][i])}return e}_enableMouse(){if(this._mouse=new zb,!this._element)throw new Error("Controller must be attached to an Element");this._mouse.attach(this._element)}_enableKeyboard(){if(this._keyboard=new Fb,!this._element)throw new Error("Controller must be attached to an Element");this._keyboard.attach(this._element)}}let Vb,Nb;const Wb=new at,Gb=new at,Hb=new si,Xb=new si,qb=new si;Hb.end=new at,Xb.end=new at,qb.end=new at;const jb=new at,Yb=new at,Kb=new at,$b=new at,Zb=new at,Qb=new at,Jb=new at,tS=new at,eS=new at,sS=new at,iS=new at,nS=new at,aS=new at,rS=new at,oS=new at,hS=new at,lS=new at,cS=new at,dS=new at,uS=new at,pS=new ht;function mS(t,e,s){return iS.cross(t,e).dot(s)}class fS{constructor(t,e,s){this.event=t,this.element=e,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class _S extends fS{constructor(t,e,s,i,n,a,r){super(t,e,s),this.x=i,this.y=n,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.button=t.button,zb.isPointerLocked()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=i-a,this.dy=n-r),this.wheelDelta=0,"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1))}}class gS extends fS{constructor(t,e,s,i,n,a){super(t,e,s),this.touches=t.touches,this.changedTouches=t.changedTouches,this.x=i,this.y=n,this.touch=a}}class yS extends fS{constructor(t,e,s,i){super(t,e,s),this.inputSource=i}}class vS{constructor(t,e){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!e||!1!==e.useMouse,this._useTouch=!e||!1!==e.useTouch,this._useXr=!e||!1!==e.useXr,this._selectEventsAttached=!1,L.touch&&(this._clickedEntities={}),this.attach(t)}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set app(t){this._app=t}get app(){return this._app||$l()}attach(t){this._attached&&(this._attached=!1,this.detach()),this._target=t,this._attached=!0;const e=!!L.passiveEvents&&{passive:!0};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)),this._useTouch&&L.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,e),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const t=!!L.passiveEvents&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,t),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(t){-1===this._elements.indexOf(t)&&this._elements.push(t)}removeElement(t){const e=this._elements.indexOf(t);-1!==e&&this._elements.splice(e,1)}_handleUp(t){this._enabled&&(zb.isPointerLocked()||(this._calcMouseCoords(t),null!==Vb&&this._onElementMouseEvent("mouseup",t)))}_handleDown(t){this._enabled&&(zb.isPointerLocked()||(this._calcMouseCoords(t),null!==Vb&&this._onElementMouseEvent("mousedown",t)))}_handleMove(t){this._enabled&&(this._calcMouseCoords(t),null!==Vb&&(this._onElementMouseEvent("mousemove",t),this._lastX=Vb,this._lastY=Nb))}_handleWheel(t){this._enabled&&(this._calcMouseCoords(t),null!==Vb&&this._onElementMouseEvent("mousewheel",t))}_determineTouchedElements(t){const e={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const n=s[i];let a=0;const r=t.changedTouches.length;for(let s=0;s<r;s++){if(e[t.changedTouches[s].identifier]){a++;continue}const i=this._calcTouchCoords(t.changedTouches[s]),r=this._getTargetElement(n,i.x,i.y);r&&(a++,e[t.changedTouches[s].identifier]={element:r,camera:n,x:i.x,y:i.y})}if(a===r)break}return e}_handleTouchStart(t){if(!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=e[i.identifier],a=this._touchedElements[i.identifier];!n||a&&n.element===a.element||(this._fireEvent(t.type,new gS(t,n.element,n.camera,n.x,n.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!1)}for(const t in e)this._touchedElements[t]=e[t]}_handleTouchEnd(t){if(!this._enabled)return;const e=this.app.systems.camera.cameras;for(const t in this._clickedEntities)delete this._clickedEntities[t];for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=this._touchedElements[i.identifier];if(!n)continue;const a=n.element,r=n.camera,o=n.x,h=n.y;if(delete this._touchedElements[i.identifier],delete this._touchesForWhichTouchLeaveHasFired[i.identifier],this._fireEvent(t.type,new gS(t,a,r,o,h,i)),0===t.touches.length){const s=this._calcTouchCoords(i);for(let n=e.length-1;n>=0;n--){this._getTargetElement(e[n],s.x,s.y)===a&&(this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new gS(t,a,r,o,h,i)),this._clickedEntities[a.entity.getGuid()]=!0))}}}}_handleTouchMove(t){if(t.preventDefault(),!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=e[i.identifier],a=this._touchedElements[i.identifier];if(a){const e=this._calcTouchCoords(i);n&&n.element===a.element||this._touchesForWhichTouchLeaveHasFired[i.identifier]||(this._fireEvent("touchleave",new gS(t,a.element,a.camera,e.x,e.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!0),this._fireEvent("touchmove",new gS(t,a.element,a.camera,e.x,e.y,i))}}}_onElementMouseEvent(t,e){let s;const i=this._hoveredElement;this._hoveredElement=null;const n=this.app.systems.camera.cameras;let a;for(let t=n.length-1;t>=0&&(a=n[t],s=this._getTargetElement(a,Vb,Nb),!s);t--);s&&(this._fireEvent(t,new _S(e,s,a,Vb,Nb,this._lastX,this._lastY)),this._hoveredElement=s,"mousedown"===t&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new _S(e,i,a,Vb,Nb,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new _S(e,this._hoveredElement,a,Vb,Nb,this._lastX,this._lastY))),"mouseup"===t&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new _S(e,this._hoveredElement,a,Vb,Nb,this._lastX,this._lastY))):this._pressedElement=null)}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const t=this.app.xr.input.inputSources;for(let e=0;e<t.length;e++)this._onElementSelectEvent("selectmove",t[e],null)}_onXrInputRemove(t){const e=this._selectedElements[t.id];e&&(t._elementEntity=null,this._fireEvent("selectleave",new yS(null,e,null,t))),delete this._selectedElements[t.id],delete this._selectedPressedElements[t.id]}_onSelectStart(t,e){this._enabled&&this._onElementSelectEvent("selectstart",t,e)}_onSelectEnd(t,e){this._enabled&&this._onElementSelectEvent("selectend",t,e)}_onElementSelectEvent(t,e,s){let i;const n=this._selectedElements[e.id];let a;const r=this.app.systems.camera.cameras;let o;if(e.elementInput){qb.set(e.getOrigin(),e.getDirection());for(let t=r.length-1;t>=0&&(o=r[t],i=this._getTargetElementByRay(qb,o),!i);t--);}e._elementEntity=i||null,i?(this._selectedElements[e.id]=i,a=i):delete this._selectedElements[e.id],n!==a&&(n&&this._fireEvent("selectleave",new yS(s,n,o,e)),a&&this._fireEvent("selectenter",new yS(s,a,o,e))),"selectstart"===t&&(this._selectedPressedElements[e.id]=a,a&&this._fireEvent("selectstart",new yS(s,a,o,e)));const h=this._selectedPressedElements[e.id];!e.elementInput&&h&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new yS(s,n,o,e))),"selectend"===t&&e.elementInput&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new yS(s,n,o,e)),h&&h===n&&this._fireEvent("click",new yS(s,h,o,e)))}_fireEvent(t,e){let s=e.element;for(;s.fire(t,e),!e._stopPropagation&&s.entity.parent&&(s=s.entity.parent.element,s););}_calcMouseCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?(Vb=null,Nb=null):(Vb=t.clientX-s,Nb=t.clientY-i)}_calcTouchCoords(t){let e=0,s=0,i=t.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do{e+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:t.pageX-e,y:t.pageY-s}}_sortElements(t,e){const s=this.app.scene.layers.sortTransparentLayers(t.layers,e.layers);return 0!==s?s:t.screen&&!e.screen?-1:!t.screen&&e.screen?1:t.screen||e.screen?t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?-1:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?1:e.drawOrder-t.drawOrder:0}_getTargetElement(t,e,s){let i,n,a=null,r=1/0;this._elements.sort(this._sortHandler);for(let o=0,h=this._elements.length;o<h;o++){const h=this._elements[o];if(h.screen&&h.screen.screen.screenSpace){if(void 0===i&&(i=this._calculateRayScreen(e,s,t,Hb)?Hb:null),!i)continue;if(this._checkElement(i,h,!0)>=0){a=h;break}}else{if(void 0===n&&(n=this._calculateRay3d(e,s,t,Xb)?Xb:null),!n)continue;const i=this._checkElement(n,h,!1);if(i>=0&&(i<r&&(a=h,r=i),h.screen)){a=h;break}}}return a}_getTargetElementByRay(t,e){let s=null;Hb.origin.copy(t.origin),Hb.direction.copy(t.direction),Hb.end.copy(Hb.direction).mulScalar(2*e.farClip).add(Hb.origin),this._elements.sort(this._sortHandler);for(let t=0,e=this._elements.length;t<e;t++){const e=this._elements[t];if((!e.screen||!e.screen.screen.screenSpace)&&this._checkElement(Hb,e,!1)>=0){s=e;break}}return s}_buildHitCorners(t,e,s,i,n){let a=e;if(t.entity&&t.entity.button){const e=t.entity.button.hitPadding||pS;aS.copy(t.entity.up),rS.copy(aS).mulScalar(-1),hS.copy(t.entity.right),oS.copy(hS).mulScalar(-1),aS.mulScalar(e.w*i),rS.mulScalar(e.y*i),hS.mulScalar(e.z*s),oS.mulScalar(e.x*s),lS.copy(a[0]).add(rS).add(oS),cS.copy(a[1]).add(rS).add(hS),dS.copy(a[2]).add(aS).add(hS),uS.copy(a[3]).add(aS).add(oS),a=[lS,cS,dS,uS]}if(s<0){const t=a[2].x,e=a[0].x;a[0].x=t,a[1].x=e,a[2].x=e,a[3].x=t}if(i<0){const t=a[2].y,e=a[0].y;a[0].y=t,a[1].y=t,a[2].y=e,a[3].y=e}if(n<0){const t=a[2].x,e=a[2].y,s=a[2].z;a[2].x=a[0].x,a[2].y=a[0].y,a[2].z=a[0].z,a[0].x=t,a[0].y=e,a[0].z=s}return a}_calculateScaleToScreen(t){let e=t.entity;const s=t.screen.screen.scale;for(nS.set(s,s,s);e&&!e.screen;)nS.mul(e.getLocalScale()),e=e.parent;return nS}_calculateScaleToWorld(t){let e=t.entity;for(nS.set(1,1,1);e;)nS.mul(e.getLocalScale()),e=e.parent;return nS}_calculateRayScreen(t,e,s,i){const n=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=h+r,c=(1-s.rect.y)*a,d=c-o;let u=t*n/this._target.clientWidth,p=e*a/this._target.clientHeight;return u>=h&&u<=l&&p<=c&&p>=d&&(u=n*(u-h)/r,p=a*(p-d)/o,p=a-p,i.origin.set(u,p,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0)}_calculateRay3d(t,e,s,i){const n=this._target.clientWidth,a=this._target.clientHeight,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=h+r,c=(1-s.rect.y)*a,d=c-o;let u=t,p=e;return t>=h&&t<=l&&e<=c&&p>=d&&(u=n*(u-h)/r,p=a*(p-d)/o,s.screenToWorld(u,p,s.nearClip,Wb),s.screenToWorld(u,p,s.farClip,Gb),i.origin.copy(Wb),i.direction.set(0,0,-1),i.end.copy(Gb),!0)}_checkElement(t,e,s){if(e.maskedBy&&this._checkElement(t,e.maskedBy.element,s)<0)return-1;let i;i=s?this._calculateScaleToScreen(e):this._calculateScaleToWorld(e);const n=this._buildHitCorners(e,s?e.screenCorners:e.worldCorners,i.x,i.y,i.z);return function(t,e,s){jb.sub2(e,t),Yb.sub2(s[0],t),Kb.sub2(s[1],t),$b.sub2(s[2],t),Qb.cross($b,jb);let i,n,a=Yb.dot(Qb);if(a>=0){if(i=-Kb.dot(Qb),i<0)return-1;if(n=mS(jb,Kb,Yb),n<0)return-1;const t=1/(i+a+n);Jb.copy(s[0]).mulScalar(i*t),tS.copy(s[1]).mulScalar(a*t),eS.copy(s[2]).mulScalar(n*t),sS.copy(Jb).add(tS).add(eS)}else{if(Zb.sub2(s[3],t),i=Zb.dot(Qb),i<0)return-1;if(n=mS(jb,Yb,Zb),n<0)return-1;a=-a;const e=1/(i+a+n);Jb.copy(s[0]).mulScalar(i*e),tS.copy(s[3]).mulScalar(a*e),eS.copy(s[2]).mulScalar(n*e),sS.copy(Jb).add(tS).add(eS)}return jb.sub2(s[0],s[2]).lengthSq()<1e-8||jb.sub2(s[1],s[3]).lengthSq()<1e-8?-1:sS.sub(t).lengthSq()}(t.origin,t.end,n)}}const xS={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},bS={"Product: 0268":"PS3"};class SS{constructor(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads,this.current=[],this.previous=[],this.deadZone=.25}update(){for(let t=0,e=this.current.length;t<e;t++){const e=this.current[t].pad.buttons,s=e.length;for(let i=0;i<s;i++)void 0===this.previous[t]&&(this.previous[t]=[]),this.previous[t][i]=e[i].pressed}this.poll(this.current)}poll(t=[]){if(t.length>0&&(t.length=0),this.gamepadsSupported){const e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads();for(let s=0,i=e.length;s<i;s++)e[s]&&t.push({map:this.getMap(e[s]),pad:e[s]})}return t}getMap(t){for(const e in bS)if(t.id.indexOf(e)>=0)return xS[bS[e]];return xS.DEFAULT}isPressed(t,e){if(!this.current[t])return!1;const s=this.current[t].map.buttons[e];return this.current[t].pad.buttons[pc[s]].pressed}wasPressed(t,e){if(!this.current[t])return!1;const s=this.current[t].map.buttons[e],i=pc[s];return this.current[t].pad.buttons[i].pressed&&!(this.previous[t]&&this.previous[t][i])}wasReleased(t,e){if(!this.current[t])return!1;const s=this.current[t].map.buttons[e],i=pc[s];return!this.current[t].pad.buttons[i].pressed&&this.previous[t]&&this.previous[t][i]}getAxis(t,e){if(!this.current[t])return 0;const s=this.current[t].map.axes[e];let i=this.current[t].pad.axes[pc[s]];return Math.abs(i)<this.deadZone&&(i=0),i}}function wS(t){let e=0,s=0,i=t.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do{e+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:t.pageX-e,y:t.pageY-s}}class TS{constructor(t){const e=wS(t);this.id=t.identifier,this.x=e.x,this.y=e.y,this.target=t.target,this.touch=t}}class MS{constructor(t,e){if(this.element=e.target,this.event=e,this.touches=[],this.changedTouches=[],e){for(let t=0,s=e.touches.length;t<s;t++)this.touches.push(new TS(e.touches[t]));for(let t=0,s=e.changedTouches.length;t<s;t++)this.changedTouches.push(new TS(e.changedTouches[t]))}}getTouchById(t,e){for(let s=0,i=e.length;s<i;s++)if(e[s].id===t)return e[s];return null}}class CS extends _{constructor(t){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t)}attach(t){this._element&&this.detach(),this._element=t;const e=!!L.passiveEvents&&{passive:!0};this._element.addEventListener("touchstart",this._startHandler,e),this._element.addEventListener("touchend",this._endHandler,e),this._element.addEventListener("touchmove",this._moveHandler,e),this._element.addEventListener("touchcancel",this._cancelHandler,e)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(t){this.fire("touchstart",new MS(this,t))}_handleTouchEnd(t){this.fire("touchend",new MS(this,t))}_handleTouchMove(t){t.preventDefault(),this.fire("touchmove",new MS(this,t))}_handleTouchCancel(t){this.fire("touchcancel",new MS(this,t))}}class AS{constructor(){this.elementInput=void 0,this.keyboard=void 0,this.mouse=void 0,this.touch=void 0,this.gamepads=void 0,this.scriptPrefix=void 0,this.assetPrefix=void 0,this.scriptsOrder=void 0,this.soundManager=void 0,this.graphicsDevice=void 0,this.lightmapper=void 0,this.batchManager=void 0,this.xr=void 0,this.componentSystems=[],this.resourceHandlers=[]}}class PS extends _{constructor(t){super(),this.app=t,this.store={},this.schema=[]}addComponent(t,e={}){const s=new this.ComponentType(this,t),i=new this.DataType;return this.store[t.getGuid()]={entity:t,data:i},t[this.id]=s,t.c[this.id]=s,this.initializeComponentData(s,e,[]),this.fire("add",t,s),s}removeComponent(t){const e=this.store[t.getGuid()],s=t.c[this.id];this.fire("beforeremove",t,s),delete this.store[t.getGuid()],t[this.id]=void 0,delete t.c[this.id],this.fire("remove",t,e.data)}cloneComponent(t,e){const s=this.store[t.getGuid()];return this.addComponent(e,s.data)}initializeComponentData(t,e={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let a,r;"object"==typeof n?(a=n.name,r=n.type):(a=n,r=void 0);let o=e[a];void 0!==o?(void 0!==r&&(o=ES(o,r)),t[a]=o):t[a]=t.data[a]}t.enabled&&t.entity.enabled&&t.onEnable()}getPropertiesOfType(t){const e=[];return(this.schema||[]).forEach((function(s){s&&"object"==typeof s&&s.type===t&&e.push(s)})),e}destroy(){this.off()}}function ES(t,e){if(!t)return t;switch(e){case"rgb":return t instanceof et?t.clone():new et(t[0],t[1],t[2]);case"rgba":return t instanceof et?t.clone():new et(t[0],t[1],t[2],t[3]);case"vec2":return t instanceof ot?t.clone():new ot(t[0],t[1]);case"vec3":return t instanceof at?t.clone():new at(t[0],t[1],t[2]);case"vec4":return t instanceof ht?t.clone():new ht(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error("Could not convert unhandled type: "+e)}}class RS extends Lp{constructor(t,e){super(t,e),this._animations={},this._assets=[],this._loop=!0,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=!1,this.blendSpeed=0,this.activate=!0,this.speed=1}set animations(t){this._animations=t,this.onSetAnimations()}get animations(){return this._animations}set assets(t){const e=this._assets;if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t]){const s=this.system.app.assets.get(e[t]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);const t=this.animationsIndex[s.id];this.currAnim===t&&this._stopCurrentAnimation(),delete this.animations[t],delete this.animationsIndex[s.id]}}this._assets=t;const s=t.map((t=>t instanceof vp?t.id:t));this.loadAnimationAssets(s)}get assets(){return this._assets}set currentTime(t){if(this.skeleton&&(this.skeleton.currentTime=t,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){const e=this.animEvaluator.clips;for(let s=0;s<e.length;++s)e[s].time=t}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){const t=this.animEvaluator.clips;if(t.length>0)return t[t.length-1].time}return 0}get duration(){return this.animations[this.currAnim].duration}set loop(t){if(this._loop=t,this.skeleton&&(this.skeleton.looping=t),this.animEvaluator)for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].loop=t}get loop(){return this._loop}play(t,e=0){if(this.enabled&&this.entity.enabled&&this.animations[t]){if(this.prevAnim=this.currAnim,this.currAnim=t,this.model){this.skeleton||this.animEvaluator||this._createAnimationController();const t=this.animations[this.prevAnim],s=this.animations[this.currAnim];if(this.blending=e>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/e),this.skeleton&&(this.blending?(this.fromSkel.animation=t,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=s):this.skeleton.animation=s),this.animEvaluator){const t=this.animEvaluator;if(this.blending)for(;t.clips.length>1;)t.removeClip(0);else this.animEvaluator.removeClips();const e=new Mf(this.animations[this.currAnim],0,1,!0,this.loop);e.name=this.currAnim,e.blendWeight=this.blending?0:1,e.reset(),this.animEvaluator.addClip(e)}}this.playing=!0}}getAnimation(t){return this.animations[t]}setModel(t){t!==this.model&&(this._resetAnimationController(),this.model=t,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))}onSetAnimations(){const t=this.entity.model;if(t){const e=t.model;e&&e!==this.model&&this.setModel(e)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){const t=Object.keys(this._animations);t.length>0&&this.play(t[0])}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}_createAnimationController(){const t=this.model,e=this.animations;let s=!1,i=!1;for(const t in e)if(e.hasOwnProperty(t)){e[t].constructor===i_?i=!0:s=!0}const n=t.getGraph();s?(this.fromSkel=new gf(n),this.toSkel=new gf(n),this.skeleton=new gf(n),this.skeleton.looping=this.loop,this.skeleton.setGraph(n)):i&&(this.animEvaluator=new t_(new n_(this.entity)))}loadAnimationAssets(t){if(!t||!t.length)return;const e=this.system.app.assets,s=t=>{if(t.resources.length>1)for(let e=0;e<t.resources.length;e++)this.animations[t.resources[e].name]=t.resources[e],this.animationsIndex[t.id]=t.resources[e].name;else this.animations[t.name]=t.resource,this.animationsIndex[t.id]=t.name;this.animations=this.animations},i=t=>{t.off("change",this.onAssetChanged,this),t.on("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this),t.resource?s(t):(t.once("load",s,this),this.enabled&&this.entity.enabled&&e.load(t))};for(let s=0,n=t.length;s<n;s++){const n=e.get(t[s]);n?i(n):e.on("add:"+t[s],i)}}onAssetChanged(t,e,s,i){if("resource"===e||"resources"===e)if("resources"===e&&s&&0===s.length&&(s=null),s){let e=!1;if(s.length>1){if(i&&i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name];else delete this.animations[t.name];e=!1;for(let t=0;t<s.length;t++)this.animations[s[t].name]=s[t],e||this.currAnim!==s[t].name||this.playing&&this.enabled&&this.entity.enabled&&(e=!0,this.play(s[t].name));e||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name];this.animations[t.name]=s[0]||s,e=!1,this.currAnim===t.name&&this.playing&&this.enabled&&this.entity.enabled&&(e=!0,this.play(t.name)),e||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[t.id]=t.name}else{if(i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name],this.currAnim===i[t].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}onAssetRemoved(t){if(t.off("remove",this.onAssetRemoved,this),this.animations){if(t.resources.length>1)for(let e=0;e<t.resources.length;e++)delete this.animations[t.resources[e].name],this.currAnim===t.resources[e].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}}onEnable(){super.onEnable();const t=this.assets,e=this.system.app.assets;if(t)for(let s=0,i=t.length;s<i;s++){let i=t[s];i instanceof vp||(i=e.get(i)),i&&!i.resource&&e.load(i)}if(this.activate&&!this.currAnim){const t=Object.keys(this.animations);t.length>0&&this.play(t[0])}}onBeforeRemove(){for(let t=0;t<this.assets.length;t++){let e=this.assets[t];"number"==typeof e&&(e=this.system.app.assets.get(e)),e&&(e.off("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}update(t){if(this.blending&&(this.blend+=t*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){const e=this.skeleton;if(null!==e&&null!==this.model){if(this.blending)e.blend(this.fromSkel,this.toSkel,this.blend);else{const s=t*this.speed;e.addTime(s),(this.speed>0&&e._time===e.animation.duration&&!this.loop||this.speed<0&&0===e._time&&!this.loop)&&(this.playing=!1)}this.blending&&1===this.blend&&(e.animation=this.toSkel.animation),e.updateGraph()}}const e=this.animEvaluator;if(e){for(let t=0;t<e.clips.length;++t){const s=e.clips[t];s.speed=this.speed,this.playing?s.resume():s.pause()}this.blending&&e.clips.length>1&&(e.clips[1].blendWeight=this.blend),e.update(t)}this.blending&&1===this.blend&&(this.blending=!1)}}class LS{constructor(){this.enabled=!0}}const IS=["enabled"];class DS extends PS{constructor(t){super(t),this.id="animation",this.ComponentType=RS,this.DataType=LS,this.schema=IS,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){for(const s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);super.initializeComponentData(t,e,IS)}cloneComponent(t,e){this.addComponent(e,{}),e.animation.assets=t.animation.assets.slice(),e.animation.speed=t.animation.speed,e.animation.loop=t.animation.loop,e.animation.activate=t.animation.activate,e.animation.enabled=t.animation.enabled;const s={},i=t.animation.animations;for(const t in i)i.hasOwnProperty(t)&&(s[t]=i[t]);e.animation.animations=s;const n={},a=t.animation.animationsIndex;for(const t in a)a.hasOwnProperty(t)&&(n[t]=a[t]);return e.animation.animationsIndex=n,e.animation}onBeforeRemove(t,e){e.onBeforeRemove()}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(t)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(RS.prototype,IS);const OS=new ot,FS=new at,kS=new ht,BS=new et,zS=new ft;class US extends n_{constructor(t,e,s,i,n){super(e),this.animComponent=t,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(t){return t[0]}static _packBoolean(t){return!!t[0]}static _packVec2(t){return OS.x=t[0],OS.y=t[1],OS}static _packVec3(t){return FS.x=t[0],FS.y=t[1],FS.z=t[2],FS}static _packVec4(t){return kS.x=t[0],kS.y=t[1],kS.z=t[2],kS.w=t[3],kS}static _packColor(t){return BS.r=t[0],BS.g=t[1],BS.b=t[2],BS.a=t[3],BS}static _packQuat(t){return zS.x=t[0],zS.y=t[1],zS.z=t[2],zS.w=t[3],zS}resolve(t){const e=bf.encode(t.entityPath,t.component,t.propertyPath);let s,i,n,a=this.targetCache[e];if(a)return a;switch(t.component){case"entity":s=this._getEntityFromHierarchy(t.entityPath),n=bf.encode(s.path,"entity",t.propertyPath),i=s;break;case"graph":if(i=this.findNode(t),!i)return null;n=bf.encode(i.path,"graph",t.propertyPath);break;default:if(s=this._getEntityFromHierarchy(t.entityPath),i=s.findComponent(t.component),!i)return null;n=bf.encode(s.path,t.component,t.propertyPath)}return a=this._createAnimTargetForProperty(i,t.propertyPath,n),this.targetCache[e]=a,a}update(t){const e=this.activeNodes;if(e)for(let t=0;t<e.length;t++)e[t]._dirtifyLocal()}_getEntityFromHierarchy(t){if(!this.animComponent.entity.name===t[0])return null;const e=this.animComponent.entity;return 1===t.length?e:e._parent.findByPath(t)}_resolvePath(t,e,s){const i=e.length-(s?0:1);for(let s=0;s<i;s++)t=t[e[s]];return t}_setter(t,e,s){const i=this._resolvePath(t,e),n=e[e.length-1],a="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[a]){let t=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();t=[t.x,t.y,t.z,t.w];const e=i[a].bind(i);return{set:t=>{e(s(t))},get:()=>t}}const r=i[n];if("object"==typeof r&&r.hasOwnProperty("copy"))return function(t){r.copy(s(t))};if(-1!==[ot,at,ht,et,ft].indexOf(i.constructor)&&e.length>1){const a=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,r=e[e.length-2];return function(t){i[n]=s(t),a[r]=i}}return function(t){i[n]=s(t)}}_createAnimTargetForProperty(t,e,s){if(this.handlers&&"weights"===e[0])return this.handlers.weights(t);if(this.handlers&&"material"===e[0]&&2===e.length){const s=e[1];if(s.endsWith("Map"))return this.handlers.materialTexture(t,s)}const i=this._resolvePath(t,e,!0);if(void 0===i)return null;let n,a,r;if("number"==typeof i)n=this._setter(t,e,US._packFloat),a="vector",r=1;else if("boolean"==typeof i)n=this._setter(t,e,US._packBoolean),a="vector",r=1;else if("object"==typeof i)switch(i.constructor){case ot:n=this._setter(t,e,US._packVec2),a="vector",r=2;break;case at:n=this._setter(t,e,US._packVec3),a="vector",r=3;break;case ht:n=this._setter(t,e,US._packVec4),a="vector",r=4;break;case et:n=this._setter(t,e,US._packColor),a="vector",r=4;break;case ft:n=this._setter(t,e,US._packQuat),a="quaternion",r=4;break;default:return null}return-1!==e.indexOf("material")?new e_((function(e){n(e),t.material.update()}),a,r,s):new e_(n,a,r,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const t={};!function e(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])}(this.graph),this.nodes=t}}class VS{constructor(t,e,s,i=1,n="OVERWRITE",a=!0){this._name=t,this._controller=e,this._component=s,this._weight=i,this._blendType=n,this._normalizedWeight=a,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0}get name(){return this._name}set playing(t){this._controller.playing=t}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(t){const e=this._controller,s=e.playing;e.playing=!0,e.activeStateCurrentTime=t,s||e.update(0),e.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(t){this._weight=t,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(t){t!==this._blendType&&(this._blendType=t,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}get mask(){return this._mask}play(t){this._controller.play(t)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(t){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=q.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=t):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(t)}blendToWeight(t,e){this._startingWeight=this.weight,this._targetWeight=t,this._blendTime=Math.max(0,e),this._blendTimeElapsed=0}assignMask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}assignAnimation(t,e,s,i){e.constructor===i_&&(this._controller.assignAnimation(t,e,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new u_({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)}getAnimationAsset(t){return this._component.animationAssets[`${this.name}:${t}`]}transition(t,e=0,s=null){this._controller.updateStateFromTransition(new u_({from:this._controller.activeStateName,to:t,time:e,transitionOffset:s}))}}class NS extends Lp{constructor(t,e){super(t,e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(t){if(null===t)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let e,s;t instanceof vp?(e=t.id,s=this.system.app.assets.get(e),s||(this.system.app.assets.add(t),s=this.system.app.assets.get(e))):(e=t,s=this.system.app.assets.get(e)),s&&this._stateGraphAsset!==e&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(t=>{this._stateGraph=t.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=e)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(t){this._normalizeWeights=t,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(t){this._animationAssets=t,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(t){this._speed=t}get speed(){return this._speed}set activate(t){this._activate=t}get activate(){return this._activate}set playing(t){this._playing=t}get playing(){return this._playing}set rootBone(t){if("string"==typeof t){const e=this.entity.root.findByGuid(t);this._rootBone=e}else this._rootBone=t instanceof tm?t:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(t){this._stateGraph=t}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(t){this._layerIndices=t}get layerIndices(){return this._layerIndices}set parameters(t){this._parameters=t}get parameters(){return this._parameters}set targets(t){this._targets=t}get targets(){return this._targets}get playable(){for(let t=0;t<this._layers.length;t++)if(!this._layers[t].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(t){const e=this.animationAssets,s=this.layers.map((t=>t.mask));this.removeStateGraph(),this._stateGraph=new m_(t._data),this.loadStateGraph(this._stateGraph),this.animationAssets=e,this.loadAnimationAssets(),this.layers.forEach(((t,e)=>{t.mask=s[e]})),this.rebind()}dirtifyTargets(){const t=Object.values(this._targets);for(let e=0;e<t.length;e++)t[e].dirty=!0}_addLayer({name:t,states:e,transitions:s,weight:i,mask:n,blendType:a}){let r;r=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,h=new US(this,r,t,n,o),l=new t_(h),c=new p_(l,e,s,this._parameters,this._activate,this,this._consumedTriggers);return this._layers.push(new VS(t,c,this,i,a)),this._layerIndices[t]=o,this._layers[o]}addLayer(t,e,s,i){const n=this.findAnimationLayer(t);if(n)return n;return this._addLayer({name:t,states:[{name:"START",speed:1}],transitions:[],weight:e,mask:s,blendType:i})}loadStateGraph(t){this._stateGraph=t,this._parameters={};const e=Object.keys(t.parameters);for(let s=0;s<e.length;s++){const i=e[s];this._parameters[i]={type:t.parameters[i].type,value:t.parameters[i].value}}this._layers=[];for(let e=0;e<t.layers.length;e++){const s=t.layers[e];this._addLayer.bind(this)(Sf({},s))}this.setupAnimationAssets()}setupAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t],s=e.name;for(let t=0;t<e.states.length;t++){const i=e.states[t];if(-1===$f.indexOf(i)){const t=s+":"+i;this._animationAssets[t]||(this._animationAssets[t]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t];for(let t=0;t<e.states.length;t++){const s=e.states[t];if(-1!==$f.indexOf(s))continue;const i=this._animationAssets[e.name+":"+s];if(!i||!i.asset){this.removeNodeAnimations(s,e.name);continue}const n=i.asset,a=this.system.app.assets.get(n);a&&(a.resource?this.onAnimationAssetLoaded(e.name,s,a):(a.once("load",function(t,e){return function(s){this.onAnimationAssetLoaded(t,e,s)}.bind(this)}.bind(this)(e.name,s)),this.system.app.assets.load(a)))}}}onAnimationAssetLoaded(t,e,s){const i=s.resource;s.data.events&&(i.events=new s_(Object.values(s.data.events))),this.findAnimationLayer(t).assignAnimation(e,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._parameters=Object.assign({},this._stateGraph.parameters);for(let t=0;t<this._layers.length;t++){const e=this._layers[t].playing;this._layers[t].reset(),this._layers[t].playing=e}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((t=>{this._targets[t].unbind()}))}rebind(){this._targets={};for(let t=0;t<this._layers.length;t++)this._layers[t].rebind()}findAnimationLayer(t){const e=this._layerIndices[t];return this._layers[e]||null}addAnimationState(t,e,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new m_({layers:[{name:n,states:[{name:"START",speed:1},{name:t,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}}));const a=this.findAnimationLayer(n);var r;a?a.assignAnimation(t,e,s,i):null==(r=this.addLayer(n))||r.assignAnimation(t,e,s,i)}assignAnimation(t,e,s,i=1,n=!0){if(!this._stateGraph&&-1===t.indexOf("."))return this.loadStateGraph(new m_({layers:[{name:"Base",states:[{name:"START",speed:1},{name:t,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}})),void this.baseLayer.assignAnimation(t,e);const a=s?this.findAnimationLayer(s):this.baseLayer;a&&a.assignAnimation(t,e,i,n)}removeNodeAnimations(t,e){const s=e?this.findAnimationLayer(e):this.baseLayer;s&&s.removeNodeAnimations(t)}getParameterValue(t,e){const s=this._parameters[t];if(s&&s.type===e)return s.value}setParameterValue(t,e,s){const i=this._parameters[t];i&&i.type===e&&(i.value=s)}getFloat(t){return this.getParameterValue(t,"FLOAT")}setFloat(t,e){this.setParameterValue(t,"FLOAT",e)}getInteger(t){return this.getParameterValue(t,"INTEGER")}setInteger(t,e){"number"==typeof e&&e%1==0&&this.setParameterValue(t,"INTEGER",e)}getBoolean(t){return this.getParameterValue(t,"BOOLEAN")}setBoolean(t,e){this.setParameterValue(t,"BOOLEAN",!!e)}getTrigger(t){return this.getParameterValue(t,"TRIGGER")}setTrigger(t,e=!1){this.setParameterValue(t,"TRIGGER",!0),e&&this._consumedTriggers.add(t)}resetTrigger(t){this.setParameterValue(t,"TRIGGER",!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(t){for(let e=0;e<this.layers.length;e++)this.layers[e].update(t*this.speed);this._consumedTriggers.forEach((t=>{this.parameters[t].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone.getGuid()]?this.rootBone=e[t.rootBone.getGuid()]:this.rebind()}}class WS{constructor(){this.enabled=!0}}const GS=["enabled"];class HS extends PS{constructor(t){super(t),this.id="anim",this.ComponentType=NS,this.DataType=WS,this.schema=GS,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,GS);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach((s=>{i.includes(s)||(t[s]=e[s])})),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers?e.layers.forEach(((e,s)=>{e._controller.states.forEach((i=>{e._controller._states[i]._animationList.forEach((e=>{t.layers[s].assignAnimation(e.name,e.animTrack)}))}))})):e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach((s=>{if(t.layers[s]){const i=e.masks[s].mask,n={};Object.keys(i).forEach((t=>{n[decodeURI(t)]=i[t]})),t.layers[s].mask=n}}))}onAnimationUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(t)}}cloneComponent(t,e){let s;t.anim.rootBone&&t.anim.rootBone!==t||(s={},t.anim.layers.forEach(((t,i)=>{if(t.mask){const n={};Object.keys(t.mask).forEach((s=>{const i=s.split("/");i.shift();const a=[e.name,...i].join("/");n[a]=t.mask[s]})),s[i]={mask:n}}})));const i={stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters,normalizeWeights:t.anim.normalizeWeights,masks:s};return this.addComponent(e,i)}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}Lp._buildAccessors(NS.prototype,GS);class XS extends Lp{constructor(t,e){super(t,e)}setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class qS{constructor(){this.enabled=!0}}const jS=["enabled"];class YS extends PS{constructor(t){super(t),this.id="audiolistener",this.ComponentType=XS,this.DataType=qS,this.schema=jS,this.manager=t.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["enabled"],super.initializeComponentData(t,e,s)}onUpdate(t){if(this.current){const t=this.current.getPosition();this.manager.listener.setPosition(t);const e=this.current.getWorldTransform();this.manager.listener.setOrientation(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(XS.prototype,jS);class KS extends Lp{constructor(t,e){super(t,e),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(t){if(!this.enabled||!this.entity.enabled)return;let e;this.channel&&this.stop();const s=this.data;if(s.sources[t])if(s["3d"]){const i=this.entity.getPosition();e=this.system.manager.playSound3d(s.sources[t],i,s),s.currentSource=t,s.channel=e}else e=this.system.manager.playSound(s.sources[t],s),s.currentSource=t,s.channel=e}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(t,e,s){const i=[],n=s.length;if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t]){const s=this.system.app.assets.get(e[t]);s&&(s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this),this.currentSource===s.name&&this.stop())}if(n)for(let t=0;t<n;t++)e.indexOf(s[t])<0&&(s[t]instanceof vp?i.push(s[t].id):i.push(s[t]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(t,e,s,i){if("resource"===e){this.data.sources&&(this.data.sources[t.name]=s,this.data.currentSource===t.name&&this.channel&&(this.channel.paused?(this.play(t.name),this.pause()):this.play(t.name)))}}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.sources[t.name]&&(delete this.data.sources[t.name],this.data.currentSource===t.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(t,e,s){e!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(t,e,s){e!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(t,e,s){e!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(t,e,s){e!==s&&this.channel instanceof T_&&this.channel.setMaxDistance(s)}onSetMinDistance(t,e,s){e!==s&&this.channel instanceof T_&&this.channel.setMinDistance(s)}onSetRollOffFactor(t,e,s){e!==s&&this.channel instanceof T_&&this.channel.setRollOffFactor(s)}onSetDistanceModel(t,e,s){e!==s&&this.channel instanceof T_&&this.channel.setDistanceModel(s)}onSet3d(t,e,s){if(e!==s&&this.system.initialized&&this.currentSource){let t=!1,e=!1;this.channel&&(t=this.channel.paused,e=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=t,this.channel.suspended=e)}}onEnable(){const t=this.data.assets;if(t){const e=this.system.app.assets;for(let s=0,i=t.length;s<i;s++){let i=t[s];i instanceof vp||(i=e.get(i)),i&&!i.resource&&e.load(i)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(t){const e=t.map((t=>this.system.app.assets.get(t))),s={};let i=null,n=e.length;const a=t=>{n--},r=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};e.forEach(((e,o)=>{e?(i=i||e.name,e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.off("error",a,this),e.on("error",a,this),e.ready((t=>{s[t.name]=t.resource,n--,0===n&&r()})),!e.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)):(n--,0===n&&r(),this.system.app.assets.on("add:"+t[o],(t=>{t.ready((t=>{this.data.sources[t.name]=t.resource})),t.resource||this.system.app.assets.load(t)})))}))}}class $S{constructor(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel="inverse",this.paused=!0,this.sources={},this.currentSource=null,this.channel=null}}const ZS=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"];class QS extends PS{constructor(t){super(t),this.id="audiosource",this.ComponentType=KS,this.DataType=$S,this.schema=ZS,this.manager=t.soundManager,this.initialized=!1,this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){s=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],super.initializeComponentData(t,e,s),t.paused=!(t.enabled&&t.activate)}onInitialize(t){t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate&&t.audiosource.play(t.audiosource.currentSource);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof tm&&this.onInitialize(e[t]);this.initialized=!0}onUpdate(t){const e=this.store;for(const t in e)if(e.hasOwnProperty(t)){const s=e[t],i=s.entity,n=s.data;if(n.enabled&&i.enabled&&n.channel instanceof T_){const t=i.getPosition();n.channel.setPosition(t)}}}onRemove(t,e){e.channel&&(e.channel.stop(),e.channel=null)}setVolume(t){this.manager.setVolume(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(KS.prototype,ZS);class JS extends _{constructor(t,e,s){if(super(),!(t&&t instanceof Lp))throw new Error("The parentComponent argument is required and must be a Component");if(!e||"string"!=typeof e)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._entityPropertyName=e,this._entity=null,this._app=t.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(t,e){const s=this._parseEventListenerConfig(t,"external",this._parentComponent),i=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(t,e,s){return Object.keys(t).map((function(i,n){const a=i.split("#"),r=a[0],o=a[1],h=t[i];if(2!==a.length||"string"!=typeof r||0===r.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+i+"`");if("function"!=typeof h)throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:e+"_"+n+"_"+i,sourceName:r,eventName:o,callback:h,scope:s}}),this)}_toggleLifecycleListeners(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),this._app.systems[t]("postPostInitialize",this._updateEntityReference,this),this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);const e=[];for(let t=0;t<this._eventListenerConfigs.length;++t){const s=this._eventListenerConfigs[t],i=this._app.systems[s.sourceName];i&&(-1===e.indexOf(i)&&e.push(i),i&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),i&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(let s=0;s<e.length;++s)e[s][t]("add",this._onComponentAdd,this),e[s][t]("beforeremove",this._onComponentRemove,this)}_onSetEntity(t,e,s){if(s instanceof tm)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");e!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let t,e=this._parentComponent.data[this._entityPropertyName];if(e instanceof tm)t=e,e=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=e;else{const s=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(s)&&e?s.findByGuid(e):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(t){for(const e in this._entity.c)this._callGainOrLoseListener(e,t)}_callGainOrLoseListener(t,e){if(this._entity.c.hasOwnProperty(t)&&e[t]){const s=e[t];s.callback.call(s.scope)}}_toggleEntityListeners(t,e){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(t,this._eventListenerConfigs[s],e)}_toggleComponentListeners(t,e,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===e&&this._safeToggleListener(t,n,s)}}_safeToggleListener(t,e,s){const i="on"===t;if(i&&this._listenerStatusFlags[e.id])return;const n=this._getEventSource(e.sourceName,s);n&&(n[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=i)}_getEventSource(t,e){if("entity"===t)return this._entity;const s=this._entity[t];return s||(e||console.warn("Entity has no component with name "+t),null)}_onEntityDestroy(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(t){return!(!this._entity||!this._entity.c)&&!!this._entity.c[t]}get entity(){return this._entity}}const tw=0,ew=1,sw="group",iw="image",nw="text",aw="stretch",rw="contain",ow="cover",hw="DEFAULT",lw="HOVER",cw="PRESSED",dw="INACTIVE",uw={};uw[hw]="_defaultTint",uw[lw]="hoverTint",uw[cw]="pressedTint",uw[dw]="inactiveTint";const pw={};pw[hw]="_defaultSpriteAsset",pw[lw]="hoverSpriteAsset",pw[cw]="pressedSpriteAsset",pw[dw]="inactiveSpriteAsset";const mw={};mw[hw]="_defaultSpriteFrame",mw[lw]="hoverSpriteFrame",mw[cw]="pressedSpriteFrame",mw[dw]="inactiveSpriteFrame";class fw extends Lp{constructor(t,e){super(t,e),this._visualState=hw,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new et(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new JS(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",t)}_toggleLifecycleListeners(t,e){this[t]("set_active",this._onSetActive,this),this[t]("set_transitionMode",this._onSetTransitionMode,this),this[t]("set_hoverTint",this._onSetTransitionValue,this),this[t]("set_pressedTint",this._onSetTransitionValue,this),this[t]("set_inactiveTint",this._onSetTransitionValue,this),this[t]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[t]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[t]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[t]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(t,e,s){e!==s&&this._updateVisualState()}_onSetTransitionMode(t,e,s){e!==s&&(this._cancelTween(),this._resetToDefaultVisualState(e),this._forceReapplyVisualState())}_onSetTransitionValue(t,e,s){e!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(t){this.entity===t&&this._toggleHitElementListeners("off")}_onElementComponentAdd(t){this.entity===t&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(t){if(this.entity.element){const e="on"===t;if(e&&this._hasHitElementListeners)return;this.entity.element[t]("mouseenter",this._onMouseEnter,this),this.entity.element[t]("mouseleave",this._onMouseLeave,this),this.entity.element[t]("mousedown",this._onMouseDown,this),this.entity.element[t]("mouseup",this._onMouseUp,this),this.entity.element[t]("touchstart",this._onTouchStart,this),this.entity.element[t]("touchend",this._onTouchEnd,this),this.entity.element[t]("touchleave",this._onTouchLeave,this),this.entity.element[t]("touchcancel",this._onTouchCancel,this),this.entity.element[t]("selectstart",this._onSelectStart,this),this.entity.element[t]("selectend",this._onSelectEnd,this),this.entity.element[t]("selectenter",this._onSelectEnter,this),this.entity.element[t]("selectleave",this._onSelectLeave,this),this.entity.element[t]("click",this._onClick,this),this._hasHitElementListeners=e}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const t=this._imageReference.entity.element;"group"!==t.type&&(this._storeDefaultColor(t.color),this._storeDefaultOpacity(t.opacity),this._storeDefaultSpriteAsset(t.spriteAsset),this._storeDefaultSpriteFrame(t.spriteFrame))}}_storeDefaultColor(t){this._defaultTint.r=t.r,this._defaultTint.g=t.g,this._defaultTint.b=t.b}_storeDefaultOpacity(t){this._defaultTint.a=t}_storeDefaultSpriteAsset(t){this._defaultSpriteAsset=t}_storeDefaultSpriteFrame(t){this._defaultSpriteFrame=t}_onSetColor(t){this._isApplyingTint||(this._storeDefaultColor(t),this._forceReapplyVisualState())}_onSetOpacity(t){this._isApplyingTint||(this._storeDefaultOpacity(t),this._forceReapplyVisualState())}_onSetSpriteAsset(t){this._isApplyingSprite||(this._storeDefaultSpriteAsset(t),this._forceReapplyVisualState())}_onSetSpriteFrame(t){this._isApplyingSprite||(this._storeDefaultSpriteFrame(t),this._forceReapplyVisualState())}_onMouseEnter(t){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",t)}_onMouseLeave(t){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",t)}_onMouseDown(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",t)}_onMouseUp(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",t)}_onTouchStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",t)}_onTouchEnd(t){t.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",t)}_onTouchLeave(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",t)}_onTouchCancel(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",t)}_onSelectStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",t)}_onSelectEnd(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",t)}_onSelectEnter(t){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",t)}_onSelectLeave(t){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",t)}_onClick(t){this._fireIfActive("click",t)}_fireIfActive(t,e){this.data.active&&this.fire(t,e)}_updateVisualState(t){const e=this._visualState,s=this._determineVisualState();if((e!==s||t)&&this.enabled)switch(this._visualState=s,e===lw&&this._fireIfActive("hoverend"),e===cw&&this._fireIfActive("pressedend"),s===lw&&this._fireIfActive("hoverstart"),s===cw&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:{const t=this[uw[this._visualState]];this._applyTint(t);break}case 1:{const t=pw[this._visualState],e=mw[this._visualState],s=this[t],i=this[e];this._applySprite(s,i);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(t){if(this._imageReference.hasComponent("element"))switch(t){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}}_determineVisualState(){return this.active?this._isPressed?cw:this._isHovering?lw:hw:dw}_applySprite(t,e){e=e||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==t&&(this._imageReference.entity.element.spriteAsset=t),this._imageReference.entity.element.spriteFrame!==e&&(this._imageReference.entity.element.spriteFrame=e),this._isApplyingSprite=!1)}_applyTint(t){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(t):this._applyTintWithTween(t)}_applyTintImmediately(t){if(!t||!this._imageReference.hasComponent("element")||"group"===this._imageReference.entity.element.type)return;const e=_w(t);this._isApplyingTint=!0,e.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=e),this._imageReference.entity.element.opacity!=t.a&&(this._imageReference.entity.element.opacity=t.a),this._isApplyingTint=!1}_applyTintWithTween(t){if(!t||!this._imageReference.hasComponent("element")||"group"===this._imageReference.entity.element.type)return;const e=_w(t),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;e.equals(s)&&t.a==i||(this._tweenInfo={startTime:V(),from:new et(s.r,s.g,s.b,i),to:t.clone(),lerpColor:new et})}_updateTintTween(){const t=V()-this._tweenInfo.startTime;let e=0===this.fadeDuration?1:t/this.fadeDuration;if(e=q.clamp(e,0,1),Math.abs(e-1)>1e-5){const t=this._tweenInfo.lerpColor;t.lerp(this._tweenInfo.from,this._tweenInfo.to,e),this._applyTintImmediately(new et(t.r,t.g,t.b,t.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}function _w(t){return new et(t.r,t.g,t.b)}class gw{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new ht,this.transitionMode=0,this.hoverTint=new et(.75,.75,.75),this.pressedTint=new et(.5,.5,.5),this.inactiveTint=new et(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const yw=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class vw extends PS{constructor(t){super(t),this.id="button",this.ComponentType=fw,this.DataType=gw,this.schema=yw,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,yw)}onUpdate(t){const e=this.store;for(const t in e){const s=e[t].entity,i=s.button;i.enabled&&s.enabled&&i.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(fw.prototype,yw);class xw extends Lp{constructor(t,e){super(t,e),this._compoundParent=null,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(t,e,s){e!==s&&this.system.changeType(this,e,s)}onSetHalfExtents(t,e,s){const i=this.data.type;this.data.initialized&&"box"===i&&this.system.recreatePhysicalShapes(this)}onSetRadius(t,e,s){const i=this.data.type;!this.data.initialized||"sphere"!==i&&"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetHeight(t,e,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAxis(t,e,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&t.off("remove",this.onAssetRemoved,this)}if(s){s instanceof vp&&(this.data.asset=s.id);const t=i.get(this.data.asset);t&&(t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&t.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof vp&&(this.data.renderAsset=s.id);const t=i.get(this.data.renderAsset);t&&(t.off("remove",this.onRenderAssetRemoved,this),t.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(t,e,s){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(t,e,s){this.onSetModel(t,e,s)}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.asset===t.id&&(this.asset=null)}onRenderAssetRemoved(t){t.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===t.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(t){const e=this.data.shape,s=e.getNumChildShapes();for(let i=0;i<s;i++){if(e.getChildShape(i).ptr===t.ptr)return i}return null}_onInsert(t){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let t=this.entity.parent;for(;t;){if(t.collision&&"compound"===t.collision.type){0===t.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}}}_updateCompound(){const t=this.entity;if(t._dirtyWorld){let e=t._dirtyLocal,s=t;for(;s&&!e&&(!s.collision||s.collision!==this._compoundParent);)s._dirtyLocal&&(e=!0),s=s.parent;if(e){t.forEach(this.system.implementations.compound._updateEachDescendantTransform,t);const e=this._compoundParent.entity.rigidbody;e&&e.activate()}}}onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const t=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(t&&(!t.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else{const t=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(t,this.data.shape),Ammo.destroy(t),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}class bw{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new at(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const Sw="static",ww="dynamic",Tw="kinematic",Mw=1,Cw=2,Aw=4,Pw=1,Ew=2,Rw=3,Lw=4,Iw=5,Dw=0,Ow=1,Fw=1,kw=2,Bw=4,zw=8,Uw=16,Vw=32,Nw=64,Ww=128,Gw=256,Hw=512,Xw=1024,qw=2048,jw=4096,Yw=8192,Kw=16384,$w=0,Zw=65535,Qw=2,Jw=65533,tT=65529;let eT,sT,iT;class nT{constructor(t,e,s){this.entity=e.entity,this.component=e,this.app=t,"undefined"==typeof Ammo||eT||(eT=new Ammo.btVector3,sT=new Ammo.btQuaternion,iT=new Ammo.btTransform),this.initialize(s)}initialize(t){const e=this.entity,s=t.shape;if(s&&"undefined"!=typeof Ammo){e.trigger&&e.trigger.destroy();const t=1,i=e.getPosition(),n=e.getRotation();eT.setValue(i.x,i.y,i.z),sT.setValue(n.x,n.y,n.z,n.w),iT.setOrigin(eT),iT.setRotation(sT);const a=this.app.systems.rigidbody.createBody(t,s,iT);a.setRestitution(0),a.setFriction(0),a.setDamping(0,0),eT.setValue(0,0,0),a.setLinearFactor(eT),a.setAngularFactor(eT),a.setCollisionFlags(4|a.getCollisionFlags()),a.entity=e,this.body=a,this.component.enabled&&e.enabled&&this.enable()}}destroy(){const t=this.body;t&&(this.disable(),this.app.systems.rigidbody.destroyBody(t))}_getEntityTransform(t){const e=this.entity.getPosition(),s=this.entity.getRotation();eT.setValue(e.x,e.y,e.z),sT.setValue(s.x,s.y,s.z,s.w),t.setOrigin(eT),t.setRotation(sT)}updateTransform(){this._getEntityTransform(iT);const t=this.body;t.setWorldTransform(iT),t.activate()}enable(){const t=this.body;if(!t)return;const e=this.app.systems;e.rigidbody.addBody(t,16,65517),e.rigidbody._triggers.push(this),t.forceActivationState(1),this.updateTransform()}disable(){const t=this.body;if(!t)return;const e=this.app.systems,s=e.rigidbody._triggers.indexOf(this);s>-1&&e.rigidbody._triggers.splice(s,1),e.rigidbody.removeBody(t),t.forceActivationState(5)}}const aT=new mt,rT=new at,oT=new ft,hT=new qo,lT=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"];class cT{constructor(t){this.system=t}beforeInitialize(t,e){e.shape=null,e.model=new Du,e.model.graph=new qo}afterInitialize(t,e){this.recreatePhysicalShapes(t),t.data.initialized=!0}reset(t,e){this.beforeInitialize(t,e),this.afterInitialize(t,e)}recreatePhysicalShapes(t){const e=t.entity,s=t.data;if("undefined"!=typeof Ammo){e.trigger&&(e.trigger.destroy(),delete e.trigger),s.shape&&(t._compoundParent&&(this.system._removeCompoundChild(t._compoundParent,s.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),Ammo.destroy(s.shape),s.shape=null),s.shape=this.createPhysicalShape(t.entity,s);const i=!t._compoundParent;if("compound"!==s.type||t._compoundParent&&t!==t._compoundParent){if("compound"!==s.type&&(t._compoundParent&&t===t._compoundParent&&e.forEach(this.system.implementations.compound._updateEachDescendant,t),!t.rigidbody)){t._compoundParent=null;let s=e.parent;for(;s;){if(s.collision&&"compound"===s.collision.type){t._compoundParent=s.collision;break}s=s.parent}}}else t._compoundParent=t,e.forEach(this._addEachDescendant,t);t._compoundParent&&t!==t._compoundParent&&(i&&0===t._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t._compoundParent):(this.system.updateCompoundChildTransform(e),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate())),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):t._compoundParent||(e.trigger?e.trigger.initialize(s):e.trigger=new nT(this.system.app,t,s))}}createPhysicalShape(t,e){}updateTransform(t,e,s,i){t.entity.trigger&&t.entity.trigger.updateTransform()}beforeRemove(t,e){e.data.shape&&(e._compoundParent&&!e._compoundParent.entity._destroying&&(this.system._removeCompoundChild(e._compoundParent,e.data.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),e._compoundParent=null,Ammo.destroy(e.data.shape),e.data.shape=null)}remove(t,e){const s=this.system.app;t.rigidbody&&t.rigidbody.body&&t.rigidbody.disableSimulation(),t.trigger&&(t.trigger.destroy(),delete t.trigger),s.scene.containsModel(e.model)&&(s.root.removeChild(e.model.graph),s.scene.removeModel(e.model))}clone(t,e){const s=this.system.store[t.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],radius:s.data.radius,axis:s.data.axis,height:s.data.height,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render};return this.system.addComponent(e,i)}}class dT extends cT{createPhysicalShape(t,e){if("undefined"!=typeof Ammo){const t=e.halfExtents,s=new Ammo.btVector3(t?t.x:.5,t?t.y:.5,t?t.z:.5),i=new Ammo.btBoxShape(s);return Ammo.destroy(s),i}}}class uT extends cT{createPhysicalShape(t,e){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(e.radius)}}class pT extends cT{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=e.radius||.5,n=Math.max((e.height||2)-2*i,0);let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btCapsuleShapeX(i,n);break;case 1:a=new Ammo.btCapsuleShape(i,n);break;case 2:a=new Ammo.btCapsuleShapeZ(i,n)}return a}}class mT extends cT{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=void 0!==e.radius?e.radius:.5,n=void 0!==e.height?e.height:1;let a=null,r=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btVector3(.5*n,i,i),r=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(i,.5*n,i),r=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(i,i,.5*n),r=new Ammo.btCylinderShapeZ(a)}return a&&Ammo.destroy(a),r}}class fT extends cT{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=void 0!==e.radius?e.radius:.5,n=void 0!==e.height?e.height:1;let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btConeShapeX(i,n);break;case 1:a=new Ammo.btConeShape(i,n);break;case 2:a=new Ammo.btConeShapeZ(i,n)}return a}}class _T extends cT{beforeInitialize(t,e){}createAmmoMesh(t,e,s){let i;if(this.system._triMeshCache[t.id])i=this.system._triMeshCache[t.id];else{const e=t.vertexBuffer,s=e.getFormat();let n,a;for(let t=0;t<s.elements.length;t++){const i=s.elements[t];if("POSITION"===i.name){a=new Float32Array(e.lock(),i.offset),n=i.stride/4;break}}const r=[];t.getIndices(r);const o=t.primitive[0].count/3,h=new Ammo.btVector3,l=new Ammo.btVector3,c=new Ammo.btVector3;let d,u,p;const m=t.primitive[0].base;i=new Ammo.btTriangleMesh,this.system._triMeshCache[t.id]=i;for(let t=0;t<o;t++)d=r[m+3*t]*n,u=r[m+3*t+1]*n,p=r[m+3*t+2]*n,h.setValue(a[d],a[d+1],a[d+2]),l.setValue(a[u],a[u+1],a[u+2]),c.setValue(a[p],a[p+1],a[p+2]),i.addTriangle(h,l,c,!0);Ammo.destroy(h),Ammo.destroy(l),Ammo.destroy(c)}const n=new Ammo.btBvhTriangleMeshShape(i,!0),a=this.system._getNodeScaling(e);n.setLocalScaling(a),Ammo.destroy(a);const r=this.system._getNodeTransform(e);s.addChildShape(r,n),Ammo.destroy(r)}createPhysicalShape(t,e){if("undefined"!=typeof Ammo&&(e.model||e.render)){const s=new Ammo.btCompoundShape;if(e.model){const t=e.model.meshInstances;for(let e=0;e<t.length;e++)this.createAmmoMesh(t[e].mesh,t[e].node,s)}else if(e.render){const t=e.render.meshes;for(let e=0;e<t.length;e++)this.createAmmoMesh(t[e],hT,s)}const i=t.getWorldTransform().getScale(),n=new Ammo.btVector3(i.x,i.y,i.z);return s.setLocalScaling(n),Ammo.destroy(n),s}}recreatePhysicalShapes(t){const e=t.data;(e.renderAsset||e.asset)&&t.enabled&&t.entity.enabled?this.loadAsset(t,e.renderAsset||e.asset,e.renderAsset?"render":"model"):this.doRecreatePhysicalShape(t)}loadAsset(t,e,s){const i=t.data,n=this.system.app.assets,a=n.get(e);a?(a.ready((e=>{i[s]=e.resource,this.doRecreatePhysicalShape(t)})),n.load(a)):n.once("add:"+e,(e=>{e.ready((e=>{i[s]=e.resource,this.doRecreatePhysicalShape(t)})),n.load(e)}))}doRecreatePhysicalShape(t){const e=t.entity,s=t.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(e,s),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):e.trigger?e.trigger.initialize(s):e.trigger=new nT(this.system.app,t,s)):(this.beforeRemove(e,t),this.remove(e,s))}updateTransform(t,e,s,i){if(t.shape){const e=t.entity.getWorldTransform().getScale(),s=t.shape.getLocalScaling();e.x===s.x()&&e.y===s.y()&&e.z===s.z()||this.doRecreatePhysicalShape(t)}super.updateTransform(t,e,s,i)}destroyShape(t){if(!t.shape)return;const e=t.shape.getNumChildShapes();for(let s=0;s<e;s++){const e=t.shape.getChildShape(s);Ammo.destroy(e)}Ammo.destroy(t.shape),t.shape=null}remove(t,e){this.destroyShape(e),super.remove(t,e)}}class gT extends cT{createPhysicalShape(t,e){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape}_addEachDescendant(t){t.collision&&!t.rigidbody&&(t.collision._compoundParent=this,t!==this.entity&&t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendant(t){t.collision&&t.collision._compoundParent===this&&(t.collision._compoundParent=null,t===this.entity||t.rigidbody||t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendantTransform(t){t.collision&&t.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(t)}}class yT extends PS{constructor(t){super(t),this.id="collision",this.ComponentType=xw,this.DataType=bw,this.schema=lT,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){const i={};for(let t=0,n=(s=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"]).length;t<n;t++){const n=s[t];i[n]=e[n]}let n;e.hasOwnProperty("asset")?(n=s.indexOf("model"),-1!==n&&s.splice(n,1),n=s.indexOf("render"),-1!==n&&s.splice(n,1)):e.hasOwnProperty("model")&&(n=s.indexOf("asset"),-1!==n&&s.splice(n,1)),i.type||(i.type=t.data.type),t.data.type=i.type,i.halfExtents&&Array.isArray(i.halfExtents)&&(i.halfExtents=new at(i.halfExtents[0],i.halfExtents[1],i.halfExtents[2]));const a=this._createImplementation(i.type);a.beforeInitialize(t,i),super.initializeComponentData(t,i,s),a.afterInitialize(t,i)}_createImplementation(t){if(void 0===this.implementations[t]){let e;switch(t){case"box":e=new dT(this);break;case"sphere":e=new uT(this);break;case"capsule":e=new pT(this);break;case"cylinder":e=new mT(this);break;case"cone":e=new fT(this);break;case"mesh":e=new _T(this);break;case"compound":e=new gT(this)}this.implementations[t]=e}return this.implementations[t]}_getImplementation(t){return this.implementations[t.collision.data.type]}cloneComponent(t,e){return this._getImplementation(t).clone(t,e)}onBeforeRemove(t,e){this.implementations[e.data.type].beforeRemove(t,e),e.onBeforeRemove()}onRemove(t,e){this.implementations[e.type].remove(t,e)}updateCompoundChildTransform(t){if(this._removeCompoundChild(t.collision._compoundParent,t.collision.data.shape),t.enabled&&t.collision.enabled){const e=this._getNodeTransform(t,t.collision._compoundParent.entity);t.collision._compoundParent.shape.addChildShape(e,t.collision.data.shape),Ammo.destroy(e)}}_removeCompoundChild(t,e){if(t.shape.removeChildShape)t.shape.removeChildShape(e);else{const s=t._getCompoundChildShapeIndex(e);null!==s&&t.shape.removeChildShapeByIndex(s)}}onTransformChanged(t,e,s,i){this.implementations[t.data.type].updateTransform(t,e,s,i)}changeType(t,e,s){this.implementations[e].beforeRemove(t.entity,t),this.implementations[e].remove(t.entity,t.data),this._createImplementation(s).reset(t,t.data)}recreatePhysicalShapes(t){this.implementations[t.data.type].recreatePhysicalShapes(t)}_calculateNodeRelativeTransform(t,e){if(t===e){const e=t.getWorldTransform().getScale();aT.setScale(e.x,e.y,e.z)}else this._calculateNodeRelativeTransform(t.parent,e),aT.mul(t.getLocalTransform())}_getNodeScaling(t){const e=t.getWorldTransform().getScale();return new Ammo.btVector3(e.x,e.y,e.z)}_getNodeTransform(t,e){let s,i;e?(this._calculateNodeRelativeTransform(t,e),s=rT,i=oT,aT.getTranslation(s),i.setFromMat4(aT)):(s=t.getPosition(),i=t.getRotation());const n=new Ammo.btTransform;n.setIdentity();const a=n.getOrigin();a.setValue(s.x,s.y,s.z);const r=new Ammo.btQuaternion;return r.setValue(i.x,i.y,i.z,i.w),n.setRotation(r),Ammo.destroy(r),Ammo.destroy(a),n}destroy(){for(const t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null,super.destroy()}}Lp._buildAccessors(xw.prototype,lT);class vT{constructor(t,e,s){this._entity=t,this._element=t.element,this.model=new Du,this.node=new qo,this.model.graph=this.node,this.mesh=e,this.meshInstance=new Ec(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+t.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(t){this.meshInstance&&(this.mesh=t,this.meshInstance.mesh=t,this.meshInstance.visible=!!t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=t),this.forceUpdateAabb())}setMask(t){if(this.meshInstance){if(t){this.unmaskMeshInstance=new Ec(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const t in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data)}else{const t=this.model.meshInstances.indexOf(this.unmaskMeshInstance);t>=0&&this.model.meshInstances.splice(t,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(t){this.meshInstance&&(this.meshInstance.material=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=t))}setParameter(t,e){this.meshInstance&&(this.meshInstance.setParameter(t,e),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(t,e))}deleteParameter(t){this.meshInstance&&(this.meshInstance.deleteParameter(t),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(t))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const t=function t(e){let s;const i=e.children,n=i.length;if(n){for(let t=0;t<n;t++)i[t].element&&(s=i[t]);if(!s)return null;const e=t(s);return e||s}return null};if(this.unmaskMeshInstance){const e=t(this._entity);e&&e.element?this.unmaskMeshInstance.drawOrder=e.element.drawOrder+e.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(t){this.meshInstance&&(this.meshInstance.drawOrder=t)}setCull(t){if(!this.meshInstance)return;const e=this._element;let s=null;t&&e._isScreenCulled()&&(s=function(t){return e.isVisibleForCamera(t)}),this.meshInstance.cull=t,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=t,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(t){this.meshInstance&&(this.meshInstance.screenSpace=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=t))}setLayer(t){this.meshInstance&&(this.meshInstance.layer=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=t))}forceUpdateAabb(t){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(t){this.meshInstance&&(this.meshInstance._updateAabbFunc=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=t))}}class xT{constructor(t){this._element=t,this._entity=t.entity,this._system=t.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new ht(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new ot,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new ht,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new ht,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new vT(this._entity,this._defaultMesh,this._material),this._color=new et(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(t){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onScreenChange(t,e){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(t){this._renderable.setDrawOrder(t),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",(function(){this._renderable.setUnmaskDrawOrder()}),this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)}_use9Slicing(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)}_updateMaterial(t){const e=!!this._mask,s=!(!this.sprite||1!==this.sprite.renderMode),i=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(t,e,s,i)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(t),this._renderable.setLayer(t?0:15))}_createMesh(){const t=this._element,e=t.calculatedWidth,s=t.calculatedHeight,i=this._rect,n=new ArrayBuffer(128),a=new Float32Array(n);a[5]=1,a[6]=i.x,a[7]=1-i.y,a[8]=e,a[13]=1,a[14]=i.x+i.z,a[15]=1-i.y,a[16]=e,a[17]=s,a[21]=1,a[22]=i.x+i.z,a[23]=1-(i.y+i.w),a[25]=s,a[29]=1,a[30]=i.x,a[31]=1-(i.y+i.w);const r=[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}],o=this._system.app.graphicsDevice,h=new Hr(o,r),l=new Wr(o,h,4,0,n),c=new ec(o);return c.vertexBuffer=l,c.primitive[0].type=6,c.primitive[0].base=0,c.primitive[0].count=4,c.primitive[0].indexed=!1,c.aabb.setMinMax(at.ZERO,new at(e,s,0)),this._updateMesh(c),c}_updateMesh(t){const e=this._element;let s=e.calculatedWidth,i=e.calculatedHeight;if("stretch"!==e.fitMode&&this._targetAspectRatio>0){const t=e.calculatedWidth/e.calculatedHeight;"contain"===e.fitMode&&t>this._targetAspectRatio||"cover"===e.fitMode&&t<this._targetAspectRatio?s=e.calculatedHeight*this._targetAspectRatio:i=e.calculatedWidth/this._targetAspectRatio}const n=e._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){const n=t.vertexBuffer,a=new Float32Array(n.lock()),r=e.pivot.x,o=e.pivot.y;a[0]=0-r*s,a[1]=0-o*i,a[8]=s-r*s,a[9]=0-o*i,a[16]=s-r*s,a[17]=i-o*i,a[24]=0-r*s,a[25]=i-o*i;let h=1,l=1,c=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];t&&(c=t.rect,h=this._sprite.atlas.texture.width,l=this._sprite.atlas.texture.height)}a[6]=c.x/h,a[7]=1-c.y/l,a[14]=(c.x+c.z)/h,a[15]=1-c.y/l,a[22]=(c.x+c.z)/h,a[23]=1-(c.y+c.w)/l,a[30]=c.x/h,a[31]=1-(c.y+c.w)/l,n.unlock();const d=new at(0-r*s,0-o*i,0),u=new at(s-r*s,i-o*i,0);t.aabb.setMinMax(d,u),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else{const t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],n=2/t.rect.z,a=2/t.rect.w;this._innerOffset.set(t.border.x*n,t.border.y*a,t.border.z*n,t.border.w*a);const r=this.sprite.atlas.texture;this._atlasRect.set(t.rect.x/r.width,t.rect.y/r.height,t.rect.z/r.width,t.rect.w/r.height);const o=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,h=t.rect.z/o,l=t.rect.w/o;this._outerScale.set(Math.max(s,this._innerOffset.x*h),Math.max(i,this._innerOffset.y*l));let c=h,d=l;this._outerScale.x/=h,this._outerScale.y/=l,c*=q.clamp(s/(this._innerOffset.x*h),1e-4,1),d*=q.clamp(i/(this._innerOffset.y*l),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(c,d,1),this._renderable.node.setLocalPosition((.5-e.pivot.x)*s,(.5-e.pivot.y)*i,0))}this._meshDirty=!1}_updateSprite(){let t=!1,e=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){e=this._sprite.meshes[this.spriteFrame],t=1===this._sprite.renderMode||2===this._sprite.renderMode;const s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(null==s?void 0:s.rect.w)>0&&(this._targetAspectRatio=s.rect.z/s.rect.w)}this.mesh=t?e:this._defaultMesh,this.refreshMesh()}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._renderable.node.getWorldTransform()),t}_toggleMask(){this._element._dirtifyMask();const t=this._element._isScreenSpace();this._updateMaterial(t),this._renderable.setMask(!!this._mask)}_onMaterialLoad(t){this.material=t.resource}_onMaterialAdded(t){this._system.app.assets.off("add:"+t.id,this._onMaterialAdded,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_bindMaterialAsset(t){this._entity.enabled&&(t.on("load",this._onMaterialLoad,this),t.on("change",this._onMaterialChange,this),t.on("remove",this._onMaterialRemove,this),t.resource?this._onMaterialLoad(t):this._system.app.assets.load(t))}_unbindMaterialAsset(t){t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(t){this._system.app.assets.off("add:"+t.id,this._onTextureAdded,this),this._textureAsset===t.id&&this._bindTextureAsset(t)}_bindTextureAsset(t){this._entity.enabled&&(t.on("load",this._onTextureLoad,this),t.on("change",this._onTextureChange,this),t.on("remove",this._onTextureRemove,this),t.resource?this._onTextureLoad(t):this._system.app.assets.load(t))}_unbindTextureAsset(t){t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this)}_onTextureLoad(t){this.texture=t.resource}_onTextureChange(t){}_onTextureRemove(t){}_onSpriteAssetAdded(t){this._system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){this._entity.enabled&&(t.on("load",this._onSpriteAssetLoad,this),t.on("change",this._onSpriteAssetChange,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._system.app.assets.load(t))}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("change",this._onSpriteAssetChange,this),t.off("remove",this._onSpriteAssetRemove,this),t.data.textureAtlasAsset&&this._system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(t&&t.resource)if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset;if(e){const t=this._system.app.assets;t.off("load:"+e,this._onTextureAtlasLoad,this),t.once("load:"+e,this._onTextureAtlasLoad,this)}}else this.sprite=null}_onSpriteAssetChange(t){this._onSpriteAssetLoad(t)}_onSpriteAssetRemove(t){}_bindSprite(t){t.on("set:meshes",this._onSpriteMeshesChange,this),t.on("set:pixelsPerUnit",this._onSpritePpuChange,this),t.on("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(t){t.off("set:meshes",this._onSpriteMeshesChange,this),t.off("set:pixelsPerUnit",this._onSpritePpuChange,this),t.off("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=q.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof vp?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._system.app.assets.get(e))}onEnable(){if(this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);t&&t.resource!==this._material&&this._bindMaterialAsset(t)}if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==this._texture&&this._bindTextureAsset(t)}if(this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==this._sprite&&this._bindSpriteAsset(t)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(t){this._renderable.meshInstance.stencilFront=t,this._renderable.meshInstance.stencilBack=t;let e=0;if(this._element.maskedBy&&(e=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const t=new df({ref:e+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=t,this._renderable.unmaskMeshInstance.stencilBack=t}}set color(t){const e=t.r,s=t.g,i=t.b;this._color.r===e&&this._color.g===s&&this._color.b===i||(this._color.r=e,this._color.g=s,this._color.b=i,this._colorUniform[0]=e,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(t){t!==this._color.a&&(this._color.a=t,this._renderable.setParameter("material_opacity",t)),this._element&&this._element.fire("set:opacity",t)}get opacity(){return this._color.a}set rect(t){let e,s,i,n;t instanceof ht?(e=t.x,s=t.y,i=t.z,n=t.w):(e=t[0],s=t[1],i=t[2],n=t[3]),e===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w||(this._rect.set(e,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}set material(t){if(this._material!==t){if(!t){const e=this._element._isScreenSpace();t=this.mask?e?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}this._material=t,t&&(this._renderable.setMaterial(t),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof vp&&(s=t.id),this._materialAsset!==s){if(this._materialAsset){e.off("add:"+this._materialAsset,this._onMaterialAdded,this);const t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}if(this._materialAsset=s,this._materialAsset){const t=e.get(this._materialAsset);t?this._bindMaterialAsset(t):(this.material=null,e.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this.material=null}}get materialAsset(){return this._materialAsset}set texture(t){if(this._texture!==t){if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==t&&(this.textureAsset=null)}if(this._texture=t,t){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a);const t=this._texture.width/this._texture.height;t!=this._targetAspectRatio&&(this._targetAspectRatio=t,"stretch"!==this._element.fitMode&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,"stretch"!==this._element.fitMode&&this.refreshMesh()}}get texture(){return this._texture}set textureAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof vp&&(s=t.id),this._textureAsset!==s){if(this._textureAsset){e.off("add:"+this._textureAsset,this._onTextureAdded,this);const t=e.get(this._textureAsset);t&&(t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const t=e.get(this._textureAsset);t?this._bindTextureAsset(t):(this.texture=null,e.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof vp&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){e.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const t=e.get(this._spriteAsset);t&&this._unbindSpriteAsset(t)}if(this._spriteAsset=s,this._spriteAsset){const t=e.get(this._spriteAsset);t?this._bindSpriteAsset(t):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(t){if(this._sprite!==t){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==t&&(this.spriteAsset=null)}this._sprite=t,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=q.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(t){const e=this._spriteFrame;this._sprite?this._spriteFrame=q.clamp(t,0,this._sprite.frameKeys.length-1):this._spriteFrame=t,this._spriteFrame!==e&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",t)}get spriteFrame(){return this._spriteFrame}set mesh(t){this._renderable.setMesh(t),this._defaultMesh===t?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(t){this._mask!==t&&(this._mask=t,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}const bT=/[A-Z|a-z|0-9|_|-|/]/;class ST{constructor(t){this._symbols=t,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let t=this._read();for(;8===t;)t=this._read();return 0!==t&&1!==t&&(this._last=this._index),t}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const t=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let e=this.read(),s="";for(;s+=(s.length>0?"\n":"")+t[e]+" '"+this.buf().join("")+"'",0!==e&&1!==e;)e=this.read();return s}_read(){return this._buf=[],this._eof()?0:"text"===this._mode?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?2:0;case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":if(this._next(),"["===this._cur)this._store();else this._output("\\");break;default:this._store()}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}}_whitespace(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}}_identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(t){return 1===t.length&&null!==t.match(bT)}_eof(){return null===this._cur}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(t){this._buf.push(t)}}class wT{constructor(t){this._scanner=new ST(t),this._error=null}parse(t,e){for(;;){switch(this._scanner.read()){case 0:return!0;case 1:default:return!1;case 2:Array.prototype.push.apply(t,this._scanner.buf());break;case 3:if(!this._parseTag(t,e))return!1}}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(t,e){let s=this._scanner.read();if(7!==s)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if("/"===i[0]){for(let n=e.length-1;n>=0;--n)if(i==="/"+e[n].name&&null===e[n].end)return e[n].end=t.length,s=this._scanner.read(),4===s||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:t.length,end:null};if(s=this._scanner.read(),5===s){if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case 4:return e.push(n),!0;case 7:{const t=this._scanner.buf().join("");if(s=this._scanner.read(),5!==s)return this._error="expected equals",!1;if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;const e=this._scanner.buf().join("");n.attributes[t]=e;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function TT(t,e){for(const s in e){if(!e.hasOwnProperty(s))continue;const i=e[s];i instanceof Object?(t.hasOwnProperty(s)||(t[s]={}),TT(t[s],e[s])):t[s]=i}}function MT(t){if(0===t.length)return null;const e={};for(let s=0;s<t.length;++s){const i=t[s],n={};n[i.name]={value:i.value,attributes:i.attributes},TT(e,n)}return e}function CT(t){const e=new wT(t),s=[],i=[];if(!e.parse(s,i))return console.warn(e.error()),{symbols:t,tags:null};const n=i.find((function(t){return null===t.end}));if(n)return console.warn(`Markup error: found unclosed tag='${n.name}'`),{symbols:t,tags:null};const a=function(t,e){if(0===t.length)return null;const s={};for(let e=0;e<t.length;++e){const i=t[e];s.hasOwnProperty(i.start)?null===s[i.start].open?s[i.start].open=[i]:s[i.start].open.push(i):s[i.start]={open:[i],close:null},s.hasOwnProperty(i.end)?null===s[i.end].close?s[i.end].close=[i]:s[i.end].close.push(i):s[i.end]={open:null,close:[i]}}let i=[];function n(t){i=i.filter((function(e){return void 0===t.find((function(t){return t===e}))}))}function a(t){for(let e=0;e<t.length;++e)i.push(t[e])}const r=Object.keys(s).sort((function(t,e){return t-e})),o=[];for(let t=0;t<r.length;++t){const e=s[r[t]];null!==e.close&&n(e.close),null!==e.open&&a(e.open),o.push({start:r[t],tags:MT(i)})}const h=[];let l=null;for(let t=0;t<o.length;++t){const e=o[t];for(;h.length<e.start;)h.push(l?l.tags:null);l=e}for(;h.length<e;)h.push(null);return h}(i,s.length);return{symbols:s,tags:a}}class AT{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null}}const PT=/^[\r\n]$/,ET=/^[ \t]$/,RT=/^[ \t\-]|[\u200b]$/,LT=/^[a-z0-9]$/i,IT=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,DT=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,OT=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],FT={width:0,height:0,xadvance:0,xoffset:0,yoffset:0};class kT{constructor(t){this._element=t,this._system=t.system,this._entity=t.entity,this._text="",this._symbols=[],this._colorPalette=[],this._symbolColors=null,this._i18nKey=null,this._fontAsset=new zy(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new et(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new ot(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new qo,this._model=new Du,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new bt,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new et(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new et(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new ot(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),t.on("resize",this._onParentResize,this),t.on("set:screen",this._onScreenChange,this),t.on("screen:set:screenspace",this._onScreenSpaceChange,this),t.on("set:draworder",this._onDrawOrderChange,this),t.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(t,e){this._noResize||this._font&&this._updateText()}_onScreenChange(t){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onDrawOrderChange(t){if(this._drawOrder=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++)this._model.meshInstances[e].drawOrder=t}_onPivotChange(t){this._font&&this._updateText()}_onLocaleSet(t){if(this._i18nKey){if(this.fontAsset){const t=this._system.app.assets.get(this.fontAsset);t&&t.resource&&t.resource===this._font||(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(t,e){this._i18nKey&&e[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(t){if(this.unicodeConverter){const e=this._system.getUnicodeConverter();e?t=e(t):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==t&&(this._font&&this._updateText(t),this._text=t)}_updateText(t){let e;if(void 0===t&&(t=this._text),this._symbols=F.getSymbols(t.normalize?t.normalize("NFC"):t),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){const t=class{static evaluate(t){return CT(t)}}.evaluate(this._symbols);this._symbols=t.symbols,e=t.tags}if(this._rtlReorder){const t=this._system.app.systems.element.getRtlReorder();if(t){const s=t(this._symbols);this._rtl=s.rtl,this._symbols=s.mapping.map((function(t){return this._symbols[t]}),this),e&&(e=s.mapping.map((function(t){return e[t]})))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;if(e){const t={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],t[this._color.toString(!1).toLowerCase()]=0;for(let s=0,i=this._symbols.length;s<i;++s){const i=e[s];let n=0;if(i&&i.color&&i.color.value){const e=i.color.value;if(7===e.length&&"#"===e[0]){const s=e.substring(1).toLowerCase();t.hasOwnProperty(s)?n=t[s]:/^([0-9a-f]{2}){3}$/.test(s)&&(n=this._colorPalette.length/3,t[s]=n,this._colorPalette.push(parseInt(s.substring(0,2),16)),this._colorPalette.push(parseInt(s.substring(2,4),16)),this._colorPalette.push(parseInt(s.substring(4,6),16)))}}this._symbolColors.push(n)}}else this._colorPalette=[],this._symbolColors=null;const s=this._calculateCharsPerTexture();let i=!1;const n=this._element,a=n._isScreenSpace(),r=n._isScreenCulled(),o=function(t){return n.isVisibleForCamera(t)};for(let t=0,e=this._meshInfo.length;t<e;t++){const e=s[t]||0,h=this._meshInfo[t];if(h.count!==e){if(i||(n.removeModelFromLayers(this._model),i=!0),h.count=e,h.positions.length=h.normals.length=3*e*4,h.indices.length=3*e*2,h.uvs.length=2*e*4,h.colors.length=4*e*4,h.meshInstance&&this._removeMeshInstance(h.meshInstance),0===e){h.meshInstance=null;continue}for(let t=0;t<e;t++)h.indices[3*t*2+0]=4*t,h.indices[3*t*2+1]=4*t+1,h.indices[3*t*2+2]=4*t+3,h.indices[3*t*2+3]=4*t+2,h.indices[3*t*2+4]=4*t+3,h.indices[3*t*2+5]=4*t+1,h.normals[4*t*3+0]=0,h.normals[4*t*3+1]=0,h.normals[4*t*3+2]=-1,h.normals[4*t*3+3]=0,h.normals[4*t*3+4]=0,h.normals[4*t*3+5]=-1,h.normals[4*t*3+6]=0,h.normals[4*t*3+7]=0,h.normals[4*t*3+8]=-1,h.normals[4*t*3+9]=0,h.normals[4*t*3+10]=0,h.normals[4*t*3+11]=-1;const s=ac(this._system.app.graphicsDevice,h.positions,{uvs:h.uvs,normals:h.normals,colors:h.colors,indices:h.indices}),l=new Ec(s,this._material,this._node);l.name="Text Element: "+this._entity.name,l.castShadow=!1,l.receiveShadow=!1,l.cull=!a,l.screenSpace=a,l.drawOrder=this._drawOrder,r&&(l.cull=!0,l.isVisibleFunc=o),this._setTextureParams(l,this._font.textures[t]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),l.setParameter("material_emissive",this._colorUniform),l.setParameter("material_opacity",this._color.a),l.setParameter("font_sdfIntensity",this._font.intensity),l.setParameter("font_pxrange",this._getPxRange(this._font)),l.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,l.setParameter("outline_color",this._outlineColorUniform),l.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,l.setParameter("shadow_color",this._shadowColorUniform);const c=-this._font.data.info.maps[t].width/this._font.data.info.maps[t].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=c*this._shadowOffsetScale*this._shadowOffset.y,l.setParameter("shadow_offset",this._shadowOffsetUniform),h.meshInstance=l,this._model.meshInstances.push(l)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),i&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(t){t.destroy();const e=this._model.meshInstances.indexOf(t);-1!==e&&this._model.meshInstances.splice(e,1)}_setMaterial(t){if(this._material=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++){this._model.meshInstances[e].material=t}}_updateMaterial(t){const e=this._element,s=e._isScreenCulled(),i=function(t){return e.isVisibleForCamera(t)},n=this._font&&"msdf"===this._font.type;if(this._material=this._system.getTextElementMaterial(t,n),this._model)for(let e=0,n=this._model.meshInstances.length;e<n;e++){const n=this._model.meshInstances[e];n.cull=!t,n.material=this._material,n.screenSpace=t,s?(n.cull=!0,n.isVisibleFunc=i):n.isVisibleFunc=null}}_isWordBoundary(t){return RT.test(t)}_isValidNextChar(t){return null!==t&&!DT.test(t)}_isNextCJKBoundary(t,e){return IT.test(t)&&(RT.test(e)||LT.test(e))}_isNextCJKWholeWord(t){return IT.test(t)}_updateMeshes(){const t=this._font.data,e=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const a=this._symbols.length;let r=0,o=0,h=0,l=0,c=1,d=0,u=0,p=0,m=0,f=0,_=0;const g=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let y=this._element.calculatedWidth;(this.autoWidth&&!g||!this._wrapLines)&&(y=Number.POSITIVE_INFINITY);let v,x,b,S,w=0,T=0;function M(t,s,i){e._lineWidths.push(Math.abs(i));const n=p>s?s+1:p,a=p>s?p+1:s,h=t.slice(n,a);if(_){let t=h.length;for(;t--&&_>0;)PT.test(h[t])&&(h.splice(t,1),_--)}e._lineContents.push(h.join("")),r=0,o-=e._scaledLineHeight,c++,m=0,f=0,_=0,d=0,p=s}let C=!0;for(;C;){C=!1,this._scaledLineHeight=n?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],r=0,o=0,h=0,l=0,c=1,d=0,u=0,p=0,m=0,f=0,_=0;const e=this._fontSize/32;w=this._fontMinY*e,T=this._fontMaxY*e;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].quad=0,this._meshInfo[t].lines={};let g=255,A=255,P=255;for(let n=0;n<a;n++){v=this._symbols[n],S=n+1>=a?null:this._symbols[n+1];if(PT.test(v)){_++,(!this._wrapLines||this._maxLines<0||c<this._maxLines)&&(M(this._symbols,n,l),u=n+1,p=n+1);continue}let E,R,L=0,I=0,D=0,O=1;if(x=t.chars[v],!x)if(-1!==OT.indexOf(v))x=FT;else if(t.chars[" "])x=t.chars[" "];else for(const e in t.chars){x=t.chars[e];break}if(x){let t=0;if(f>0){const e=this._font.data.kerning;if(e){const s=e[F.getCodePoint(this._symbols[n-1])||0];s&&(t=s[F.getCodePoint(this._symbols[n])||0]||0)}}E=x.scale||1,R=(x.width+x.height)/2,O=e*R/E,D=(x.xadvance+t)*e,L=(x.xoffset-t)*e,I=x.yoffset*e}else console.error(`Couldn't substitute missing character: '${v}'`);const k=ET.test(v),B=this._meshInfo[x&&x.map||0],z=r+this._spacing*D;if(z>y&&f>0&&!k&&(this._maxLines<0||c<this._maxLines)){if(0!==m){const e=Math.max(n-u,0);if(this._meshInfo.length<=1)B.lines[c-1]-=e,B.quad-=e;else{const e=n;for(let s=u;s<e;s++){const e=this._symbols[s],i=t.chars[e],n=this._meshInfo[i&&i.map||0];n.lines[c-1]-=1,n.quad-=1}}n-=e+1,M(this._symbols,u,d);continue}u=n,M(this._symbols,n,l)}b=B.quad,B.lines[c-1]=b;let U=r-L,V=U+O;const N=o-I,W=N+O;if(this._rtl){const t=O-L-this._spacing*D-L;U-=t,V-=t}let G;if(B.positions[4*b*3+0]=U,B.positions[4*b*3+1]=N,B.positions[4*b*3+2]=h,B.positions[4*b*3+3]=V,B.positions[4*b*3+4]=N,B.positions[4*b*3+5]=h,B.positions[4*b*3+6]=V,B.positions[4*b*3+7]=W,B.positions[4*b*3+8]=h,B.positions[4*b*3+9]=U,B.positions[4*b*3+10]=W,B.positions[4*b*3+11]=h,this.width=Math.max(this.width,z),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(G=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),G=q.clamp(G,s,i),G!==this._element.fontSize)){this._fontSize=G,C=!0;break}if(this.height=Math.max(this.height,T-(o+w)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(G=q.clamp(this._fontSize-1,s,i),G!==this._element.fontSize)){this._fontSize=G,C=!0;break}r+=this._spacing*D,k||(l=r),(this._isWordBoundary(v)||this._isValidNextChar(S)&&(this._isNextCJKBoundary(v,S)||this._isNextCJKWholeWord(S)))&&(m++,d=l,u=n+1),f++;const H=this._getUv(v);if(B.uvs[4*b*2+0]=H[0],B.uvs[4*b*2+1]=1-H[1],B.uvs[4*b*2+2]=H[2],B.uvs[4*b*2+3]=1-H[1],B.uvs[4*b*2+4]=H[2],B.uvs[4*b*2+5]=1-H[3],B.uvs[4*b*2+6]=H[0],B.uvs[4*b*2+7]=1-H[3],this._symbolColors){const t=3*this._symbolColors[n];g=this._colorPalette[t],A=this._colorPalette[t+1],P=this._colorPalette[t+2]}B.colors[4*b*4+0]=g,B.colors[4*b*4+1]=A,B.colors[4*b*4+2]=P,B.colors[4*b*4+3]=255,B.colors[4*b*4+4]=g,B.colors[4*b*4+5]=A,B.colors[4*b*4+6]=P,B.colors[4*b*4+7]=255,B.colors[4*b*4+8]=g,B.colors[4*b*4+9]=A,B.colors[4*b*4+10]=P,B.colors[4*b*4+11]=255,B.colors[4*b*4+12]=g,B.colors[4*b*4+13]=A,B.colors[4*b*4+14]=P,B.colors[4*b*4+15]=255,B.quad++}C||p<a&&M(this._symbols,a,r)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const A=this._element.pivot.x,P=this._element.pivot.y,E=this._alignment.x,R=this._alignment.y;for(let t=0;t<this._meshInfo.length;t++){if(0===this._meshInfo[t].count)continue;let e=0;for(const s in this._meshInfo[t].lines){const i=this._meshInfo[t].lines[s],n=this._lineWidths[parseInt(s,10)],a=-A*this._element.calculatedWidth+E*(this._element.calculatedWidth-n)*(this._rtl?-1:1),r=(1-P)*this._element.calculatedHeight-T-(1-R)*(this._element.calculatedHeight-this.height);for(let s=e;s<=i;s++)this._meshInfo[t].positions[4*s*3]+=a,this._meshInfo[t].positions[4*s*3+3]+=a,this._meshInfo[t].positions[4*s*3+6]+=a,this._meshInfo[t].positions[4*s*3+9]+=a,this._meshInfo[t].positions[4*s*3+1]+=r,this._meshInfo[t].positions[4*s*3+4]+=r,this._meshInfo[t].positions[4*s*3+7]+=r,this._meshInfo[t].positions[4*s*3+10]+=r;if(this._rtl)for(let s=e;s<=i;s++){const e=4*s*3;for(let s=0;s<4;++s)this._meshInfo[t].positions[e+3*s]=this._element.calculatedWidth-this._meshInfo[t].positions[e+3*s]+2*a;const i=this._meshInfo[t].positions[e+3],n=this._meshInfo[t].positions[e+6];this._meshInfo[t].positions[e+3]=this._meshInfo[t].positions[e+0],this._meshInfo[t].positions[e+6]=this._meshInfo[t].positions[e+9],this._meshInfo[t].positions[e+0]=i,this._meshInfo[t].positions[e+9]=n}e=i+1}const s=4*this._meshInfo[t].count,i=4*this._meshInfo[t].quad,n=new wl(this._meshInfo[t].meshInstance.mesh.vertexBuffer);for(let e=0;e<s;e++)e>=i?(n.element.POSITION.set(0,0,0),n.element.TEXCOORD0.set(0,0),n.element.COLOR.set(0,0,0,0)):(n.element.POSITION.set(this._meshInfo[t].positions[3*e+0],this._meshInfo[t].positions[3*e+1],this._meshInfo[t].positions[3*e+2]),n.element.TEXCOORD0.set(this._meshInfo[t].uvs[2*e+0],this._meshInfo[t].uvs[2*e+1]),n.element.COLOR.set(this._meshInfo[t].colors[4*e+0],this._meshInfo[t].colors[4*e+1],this._meshInfo[t].colors[4*e+2],this._meshInfo[t].colors[4*e+3])),n.next();n.end(),this._meshInfo[t].meshInstance.mesh.aabb.compute(this._meshInfo[t].positions),this._meshInfo[t].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(t){this.font!==t.resource&&(this.font=t.resource)}_onFontChange(t,e,s,i){if("data"===e){this._font.data=s;const t=this._font.data.info.maps.length;for(let e=0;e<t;e++){if(!this._meshInfo[e])continue;const t=this._meshInfo[e].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[e].width))}}}_onFontRemove(t){}_setTextureParams(t,e){this._font&&("msdf"===this._font.type?(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap"),t.setParameter("texture_msdfMap",e)):"bitmap"===this._font.type&&(t.deleteParameter("texture_msdfMap"),t.setParameter("texture_emissiveMap",e),t.setParameter("texture_opacityMap",e)))}_getPxRange(t){const e=Object.keys(this._font.data.chars);for(let t=0;t<e.length;t++){const s=this._font.data.chars[e[t]];if(s.range)return(s.scale||1)*s.range}return 2}_getUv(t){const e=this._font.data;if(!e.chars[t]){const t=" ";return e.chars[t]?this._getUv(t):[0,0,0,0]}const s=e.chars[t].map,i=e.info.maps[s].width,n=e.info.maps[s].height,a=e.chars[t].x,r=e.chars[t].y,o=a,h=r,l=a+e.chars[t].width,c=r-e.chars[t].height,d=1-e.chars[t].height/n;return[o/i,d-h/n,l/i,d-c/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(t){if(this._model){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].stencilFront=t,e[s].stencilBack=t}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(t){const e={};void 0===t&&(t=this._symbols.length);for(let s=0,i=t;s<i;s++){const t=this._symbols[s];let i=this._font.data.chars[t];i||(i=this._font.data.chars[" "],i||(i=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const n=i.map;e[n]?e[n]++:e[n]=1}return e}_updateRenderRange(){const t=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),e=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const i=t[s]||0,n=e[s]||0,a=this._meshInfo[s].meshInstance;if(a){const t=a.mesh;t&&(t.primitive[0].base=3*i*2,t.primitive[0].count=3*(n-i)*2)}}}set text(t){this._i18nKey=null;const e=null!=t&&t.toString()||"";this._setText(e)}get text(){return this._text}set key(t){const e=null!==t?t.toString():null;this._i18nKey!==e&&(this._i18nKey=e,e?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(t){const e=t.r,s=t.g,i=t.b;if(this._color.r!==e||this._color.g!==s||this._color.b!==i)if(this._color.r=e,this._color.g=s,this._color.b=i,this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("material_emissive",this._colorUniform)}}this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(t){if(this._color.a!==t&&(this._color.a=t,this._model))for(let e=0,s=this._model.meshInstances.length;e<s;e++){this._model.meshInstances[e].setParameter("material_opacity",t)}this._element&&this._element.fire("set:opacity",t)}get opacity(){return this._color.a}set lineHeight(t){const e=this._lineHeight;this._lineHeight=t,this._scaledLineHeight=t,e!==t&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(t){const e=this._wrapLines;this._wrapLines=t,e!==t&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(t){const e=this._spacing;this._spacing=t,e!==t&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(t){const e=this._fontSize;this._fontSize=t,this._originalFontSize=t,e!==t&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(t){this._fontAsset.defaultAsset=t}get fontAsset(){return this._fontAsset.localizedAsset}set font(t){let e;if(this._font&&(e=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=t,this._fontMinY=0,this._fontMaxY=0,!t)return;const s=this._font.data;for(const t in s.chars){const e=s.chars[t];e.bounds&&(this._fontMinY=Math.min(this._fontMinY,e.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,e.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset){this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null)}if(t.type!==e){const t=this._element._isScreenSpace();this._updateMaterial(t)}for(let t=0,e=this._font.textures.length;t<e;t++)if(this._meshInfo[t]){const e=this._meshInfo[t].meshInstance;e&&(e.setParameter("font_sdfIntensity",this._font.intensity),e.setParameter("font_pxrange",this._getPxRange(this._font)),e.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._setTextureParams(e,this._font.textures[t]))}else this._meshInfo[t]=new AT;let i=!1;for(let t=this._font.textures.length;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[t].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(t){t instanceof ot?this._alignment.set(t.x,t.y):this._alignment.set(t[0],t[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(t){const e=this._autoWidth;if(this._autoWidth=t,t&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),e!==t){const t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;t!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(t){const e=this._autoHeight;if(this._autoHeight=t,t&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),e!==t){const t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;t!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(t){this._rtlReorder!==t&&(this._rtlReorder=t,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(t){this._unicodeConverter!==t&&(this._unicodeConverter=t,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let t=!1;for(let e=0;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(t?this._aabb.add(this._meshInfo[e].meshInstance.aabb):(this._aabb.copy(this._meshInfo[e].meshInstance.aabb),t=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(t){const e=t instanceof et?t.r:t[0],s=t instanceof et?t.g:t[1],i=t instanceof et?t.b:t[2],n=t instanceof et?t.a:t[3];if((this._outlineColor.r!==e||this._outlineColor.g!==s||this._outlineColor.b!==i||this._outlineColor.a!==n)&&(this._outlineColor.r=e,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,this._model)){this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("outline_color",this._outlineColorUniform)}}}get outlineColor(){return this._outlineColor}set outlineThickness(t){const e=this._outlineThickness;if(this._outlineThickness=t,e!==t&&this._font&&this._model)for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}get outlineThickness(){return this._outlineThickness}set shadowColor(t){const e=t instanceof et?t.r:t[0],s=t instanceof et?t.g:t[1],i=t instanceof et?t.b:t[2],n=t instanceof et?t.a:t[3];if((this._shadowColor.r!==e||this._shadowColor.g!==s||this._shadowColor.b!==i||this._shadowColor.a!==n)&&(this._shadowColor.r=e,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,this._model)){this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("shadow_color",this._shadowColorUniform)}}}get shadowColor(){return this._shadowColor}set shadowOffset(t){const e=t instanceof ot?t.x:t[0],s=t instanceof ot?t.y:t[1];if((this._shadowOffset.x!==e||this._shadowOffset.y!==s)&&(this._shadowOffset.set(e,s),this._font&&this._model))for(let t=0,e=this._model.meshInstances.length;t<e;t++){const e=-this._font.data.info.maps[t].width/this._font.data.info.maps[t].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=e*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[t].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(t){this._minFontSize!==t&&(this._minFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(t){this._maxFontSize!==t&&(this._maxFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(t){this._autoFitWidth!==t&&(this._autoFitWidth=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(t){this._autoFitHeight!==t&&(this._autoFitHeight=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(t){this._maxLines!==t&&(null===t&&-1===this._maxLines||(this._maxLines=null===t?-1:t,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(t){t=!!t,this._enableMarkup!==t&&(this._enableMarkup=t,this.font&&this._updateText())}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return null===this._symbolColors?null:this._symbolColors.map((function(t){return this._colorPalette.slice(3*t,3*t+3)}),this)}get rtl(){return this._rtl}set rangeStart(t){(t=Math.max(0,Math.min(t,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=t,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(t){(t=Math.max(this._rangeStart,Math.min(t,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=t,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const BT=new at,zT=new mt,UT=new at,VT=new at,NT=new mt,WT=new mt,GT=new mt,HT=new mt;class XT extends Lp{constructor(t,e){super(t,e),this._beingInitialized=!1,this._anchor=new ht,this._localAnchor=new ht,this._pivot=new ot,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new ht(0,0,-32,-32),this._modelTransform=new mt,this._screenToWorld=new mt,this._anchorTransform=new mt,this._anchorDirty=!0,this._parentWorldTransform=new mt,this._screenTransform=new mt,this._screenCorners=[new at,new at,new at,new at],this._canvasCorners=[new ot,new ot,new ot,new ot],this._worldCorners=[new at,new at,new at,new at],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type="group",this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode="stretch",this._useInput=!1,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(t){t instanceof ht?this._anchor.set(t.x,t.y,t.z,t.w):this._anchor.set(t[0],t[1],t[2],t[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(t){if(this._batchGroupId!==t){var e,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(e=this.system.app.batcher)||e.remove(yc.ELEMENT,this.batchGroupId,this.entity);if(this.entity.enabled&&t>=0)null==(s=this.system.app.batcher)||s.insert(yc.ELEMENT,t,this.entity);t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=t}}get batchGroupId(){return this._batchGroupId}set bottom(t){this._margin.y=t;const e=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+t;this._setHeight(s-i),e.y=t+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(e)}get bottom(){return this._margin.y}set calculatedWidth(t){this._setCalculatedWidth(t,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(t){this._setCalculatedHeight(t,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const t=this.system.app.graphicsDevice,e=this.screenCorners,s=t.canvas.clientWidth/t.width,i=t.canvas.clientHeight/t.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(e[n].x*s,(t.height-e[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(t){let e=0;this.screen&&(e=this.screen.screen.priority),t>16777215&&(t=16777215),this._drawOrder=(e<<24)+t,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(t){this._height=t,this._hasSplitAnchorsY||this._setCalculatedHeight(t,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(t){if(this._addedModels.length)for(let t=0;t<this._layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this._layers[t]);if(e)for(let t=0;t<this._addedModels.length;t++)e.removeMeshInstances(this._addedModels[t].meshInstances)}if(this._layers=t,this.enabled&&this.entity.enabled&&this._addedModels.length)for(let t=0;t<this._layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this._layers[t]);if(e)for(let t=0;t<this._addedModels.length;t++)e.addMeshInstances(this._addedModels[t].meshInstances)}}get layers(){return this._layers}set left(t){this._margin.x=t;const e=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+t;this._setWidth(s-i),e.x=t+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(e)}get left(){return this._margin.x}set margin(t){this._margin.copy(t),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(t){const e=this._pivot.x,s=this._pivot.y;t instanceof ot?this._pivot.set(t.x,t.y):this._pivot.set(t[0],t[1]);const i=this._margin.x+this._margin.z,n=this._pivot.x-e;this._margin.x+=i*n,this._margin.z-=i*n;const a=this._margin.y+this._margin.w,r=this._pivot.y-s;this._margin.y+=a*r,this._margin.w-=a*r,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}get pivot(){return this._pivot}set right(t){this._margin.z=t;const e=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-t;this._setWidth(i-s),e.x=this._localAnchor.z-this._localAnchor.x-t-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(e)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const t=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const e=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),e&&this._screenCorners[s].mulScalar(this.screen.screen.scale),t&&this._screenCorners[s].add(t);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(t){this._margin.w=t;const e=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-t;this._setHeight(i-s),e.y=this._localAnchor.w-this._localAnchor.y-t-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(e)}get top(){return this._margin.w}set type(t){t!==this._type&&(this._type=t,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===t?this._image=new xT(this):"text"===t&&(this._text=new kT(this)))}get type(){return this._type}set useInput(t){this._useInput!==t&&(this._useInput=t,this.system.app.elementInput?t?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",t))}get useInput(){return this._useInput}set fitMode(t){this._fitMode=t,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}get fitMode(){return this._fitMode}set width(t){this._width=t,this._hasSplitAnchorsX||this._setCalculatedWidth(t,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const t=this.screenCorners;if(!this.screen.screen.screenSpace){NT.copy(this.screen.screen._screenMatrix),NT.data[13]=-NT.data[13],NT.mul2(this.screen.getWorldTransform(),NT);for(let e=0;e<4;e++)NT.transformPoint(t[e],this._worldCorners[e])}}else{const t=this.entity.getLocalPosition();NT.setTranslate(-t.x,-t.y,-t.z),WT.setTRS(at.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),GT.setTranslate(t.x,t.y,t.z);const e=this.entity.parent?this.entity.parent:this.entity;HT.copy(e.getWorldTransform()),HT.mul(GT).mul(WT).mul(NT),UT.set(t.x-this.pivot.x*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),HT.transformPoint(UT,this._worldCorners[0]),UT.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),HT.transformPoint(UT,this._worldCorners[1]),UT.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),HT.transformPoint(UT,this._worldCorners[2]),UT.set(t.x-this.pivot.x*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),HT.transformPoint(UT,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=tm.prototype._sync,this.entity.setPosition=tm.prototype.setPosition,this.entity.setLocalPosition=tm.prototype.setLocalPosition}_setPosition(t,e,s){if(!this.element.screen)return tm.prototype.setPosition.call(this,t,e,s);t instanceof at?BT.copy(t):BT.set(t,e,s),this.getWorldTransform(),zT.copy(this.element._screenToWorld).invert(),zT.transformPoint(BT,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(t,e,s){t instanceof at?this.localPosition.copy(t):this.localPosition.set(t,e,s);const i=this.element,n=this.localPosition,a=i._pivot;i._margin.x=n.x-i._calculatedWidth*a.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*a.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const t=this.element,e=t.screen;if(e){if(t._anchorDirty){let s=0,i=0,n=0,a=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,a=this._parent.element.pivot.y;else{const t=e.screen.resolution;s=t.x/e.screen.scale,i=t.y/e.screen.scale}t._anchorTransform.setTranslate(s*(t.anchor.x-n),-i*(a-t.anchor.y),0),t._anchorDirty=!1,t._calculateLocalAnchors()}t._sizeDirty&&t._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const e=this.localPosition,s=t._pivot;t._margin.x=e.x-t._calculatedWidth*s.x,t._margin.z=t._localAnchor.z-t._localAnchor.x-t._calculatedWidth-t._margin.x,t._margin.y=e.y-t._calculatedHeight*s.y,t._margin.w=t._localAnchor.w-t._localAnchor.y-t._calculatedHeight-t._margin.y,this._dirtyLocal=!1}if(!e)return this._dirtyWorld&&(t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0),tm.prototype._sync.call(this);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?t._screenToWorld.mul2(this._parent.element._modelTransform,t._anchorTransform):t._screenToWorld.copy(t._anchorTransform),t._modelTransform.mul2(t._screenToWorld,this.localTransform),e){t._screenToWorld.mul2(e.screen._screenMatrix,t._screenToWorld),e.screen.screenSpace||t._screenToWorld.mul2(e.worldTransform,t._screenToWorld),this.worldTransform.mul2(t._screenToWorld,this.localTransform);const s=t._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==e&&(NT.setTRS(at.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,NT));const n=UT;n.set(0,0,this.localPosition.z);const a=VT;a.set(t._absLeft+t._pivot.x*t.calculatedWidth,t._absBottom+t._pivot.y*t.calculatedHeight,0),NT.setTranslate(-a.x,-a.y,-a.z),WT.setTRS(n,this.getLocalRotation(),this.getLocalScale()),GT.setTranslate(a.x,a.y,a.z),t._screenTransform.mul2(t._parentWorldTransform,GT).mul(WT).mul(NT),t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0}else this.worldTransform.copy(t._modelTransform);this._dirtyWorld=!1}}_onInsert(t){const e=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(e.screen),this._dirtifyMask()}_dirtifyMask(){let t=this.entity;for(;t;){const e=t.parent;if((null===e||e.screen)&&t.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const e=this.system._prerender.indexOf(this.entity);e>=0&&this.system._prerender.splice(e,1);this.system._prerender.indexOf(t)<0&&this.system._prerender.push(t)}t=e}}_onPrerender(){for(let t=0;t<this.system._prerender.length;t++){const e=this.system._prerender[t];if(e.element){const t=1;e.element.syncMask(t)}}this.system._prerender.length=0}_bindScreen(t){t._bindElement(this)}_unbindScreen(t){t._unbindElement(this)}_updateScreen(t){this.screen&&this.screen!==t&&this._unbindScreen(this.screen.screen);const e=this.screen;this.screen=t,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,e),this._anchorDirty=!0;const s=this.entity.children;for(let e=0,i=s.length;e<i;e++)s[e].element&&s[e].element._updateScreen(t);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(t){const e=this._parseUpToScreen();this._updateMask(e.mask,t)}_setMaskedBy(t){const e=this._image||this._text;if(t){const s=t.element._image._maskRef,i=new df({ref:s,func:2});e&&e._setStencil&&e._setStencil(i),this._maskedBy=t}else e&&e._setStencil&&e._setStencil(null),this._maskedBy=null}_updateMask(t,e){if(t){if(this._setMaskedBy(t),this.mask){const s=t.element._image._maskRef,i=new df({ref:s,func:2,zpass:3});this._image._setStencil(i),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}else{if(this._setMaskedBy(null),this.mask){const s=new df({ref:e,func:7,zpass:2});this._image._setStencil(s),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}}_parseUpToScreen(){const t={screen:null,mask:null};let e=this.entity._parent;for(;e&&!e.screen;)e.element&&e.element.mask&&(t.mask||(t.mask=e)),e=e.parent;return e&&e.screen&&(t.screen=e),t}_onScreenResize(t){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",t)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let t=1e3,e=1e3;const s=this.entity._parent;if(s&&s.element)t=s.element.calculatedWidth,e=s.element.calculatedHeight;else if(this.screen){const s=this.screen.screen.resolution,i=this.screen.screen.scale;t=s.x/i,e=s.y/i}this._localAnchor.set(this._anchor.x*t,this._anchor.y*e,this._anchor.z*t,this._anchor.w*e)}getOffsetPosition(t,e){const s=this.entity.getLocalPosition().clone();return s.x+=t,s.y+=e,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(t,e){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||(this._image?t.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(t){this.layers.indexOf(t.id)<0||(this._image?t.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.removeMeshInstances(this._text._model.meshInstances))}onEnable(){var t;(this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(t=this.system.app.batcher)||t.insert(yc.ELEMENT,this.batchGroupId,this.entity));this.fire("enableelement")}onDisable(){var t;(this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0)&&(null==(t=this.system.app.batcher)||t.remove(yc.ELEMENT,this.batchGroupId,this.entity));this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(t,e){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;t?this._setWidth(s):this._setCalculatedWidth(s,!1),e?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(t){this._width=t,this._setCalculatedWidth(t,!1),this.fire("set:width",this._width)}_setHeight(t){this._height=t,this._setCalculatedHeight(t,!1),this.fire("set:height",this._height)}_setCalculatedWidth(t,e){if(!(Math.abs(t-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=t,this.entity._dirtifyLocal(),e){const t=this.entity.getLocalPosition(),e=this._pivot;this._margin.x=t.x-this._calculatedWidth*e.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(t,e){if(!(Math.abs(t-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=t,this.entity._dirtifyLocal(),e){const t=this.entity.getLocalPosition(),e=this._pivot;this._margin.y=t.y-this._calculatedHeight*e.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const t=this.entity._children;for(let e=0,s=t.length;e<s;e++)t[e].element&&(t[e].element._anchorDirty=!0,t[e].element._sizeDirty=!0)}addModelToLayers(t){this._addedModels.push(t);for(let e=0;e<this.layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.addMeshInstances(t.meshInstances)}}removeModelFromLayers(t){const e=this._addedModels.indexOf(t);e>=0&&this._addedModels.splice(e,1);for(let e=0;e<this.layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.removeMeshInstances(t.meshInstances)}}getMaskOffset(){const t=this.system.app.frame;this._offsetReadAt!==t&&(this._maskOffset=.5,this._offsetReadAt=t);const e=this._maskOffset;return this._maskOffset-=.001,e}isVisibleForCamera(t){let e,s,i,n;if(this.maskedBy){const t=this.maskedBy.element.screenCorners;e=Math.min(Math.min(t[0].x,t[1].x),Math.min(t[2].x,t[3].x)),s=Math.max(Math.max(t[0].x,t[1].x),Math.max(t[2].x,t[3].x)),n=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y)),i=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y))}else{const a=this.system.app.graphicsDevice.width,r=this.system.app.graphicsDevice.height,o=t._rect.z*a,h=t._rect.w*r;e=t._rect.x*a,s=e+o,i=(1-t._rect.y)*r,n=i-h}const a=this.screenCorners,r=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x)),o=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x)),h=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y)),l=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y));return!(o<e||r>s||h>i||l<n)}_isScreenSpace(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace}_isScreenCulled(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}_dirtyBatch(){var t;-1!==this.batchGroupId&&(null==(t=this.system.app.batcher)||t.markGroupDirty(this.batchGroupId))}}function qT(t){Object.defineProperty(XT.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?(this._text[t]!==e&&this._dirtyBatch(),this._text[t]=e):this._image&&(this._image[t]!==e&&this._dirtyBatch(),this._image[t]=e)}})}qT("fontSize"),qT("minFontSize"),qT("maxFontSize"),qT("maxLines"),qT("autoFitWidth"),qT("autoFitHeight"),qT("color"),qT("font"),qT("fontAsset"),qT("spacing"),qT("lineHeight"),qT("wrapLines"),qT("lines"),qT("alignment"),qT("autoWidth"),qT("autoHeight"),qT("rtlReorder"),qT("unicodeConverter"),qT("text"),qT("key"),qT("texture"),qT("textureAsset"),qT("material"),qT("materialAsset"),qT("sprite"),qT("spriteAsset"),qT("spriteFrame"),qT("pixelsPerUnit"),qT("opacity"),qT("rect"),qT("mask"),qT("outlineColor"),qT("outlineThickness"),qT("shadowColor"),qT("shadowOffset"),qT("enableMarkup"),qT("rangeStart"),qT("rangeEnd");class jT{constructor(){this.enabled=!0}}const YT=["enabled"];class KT extends PS{constructor(t){super(t),this.id="element",this.ComponentType=XT,this.DataType=jT,this.schema=YT,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new Mo(t.graphicsDevice,{width:1,height:1,format:7,name:"element-system"});const e=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,e.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this.defaultTextMaterial=null,this.defaultBitmapTextMaterial=null,this.defaultScreenSpaceTextMaterial=null,this.defaultScreenSpaceBitmapTextMaterial=null,this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(t,e,s){t._beingInitialized=!0,void 0!==e.anchor&&(e.anchor instanceof ht?t.anchor.copy(e.anchor):t.anchor.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),void 0!==e.pivot&&(e.pivot instanceof ot?t.pivot.copy(e.pivot):t.pivot.set(e.pivot[0],e.pivot[1]));const i=Math.abs(t.anchor.x-t.anchor.z)>.001,n=Math.abs(t.anchor.y-t.anchor.w)>.001;let a,r=!1;void 0!==e.margin&&(e.margin instanceof ht?t.margin.copy(e.margin):t._margin.set(e.margin[0],e.margin[1],e.margin[2],e.margin[3]),r=!0),void 0!==e.left&&(t._margin.x=e.left,r=!0),void 0!==e.bottom&&(t._margin.y=e.bottom,r=!0),void 0!==e.right&&(t._margin.z=e.right,r=!0),void 0!==e.top&&(t._margin.w=e.top,r=!0),r&&(t.margin=t._margin);let o=!1;void 0===e.width||i?i&&(o=!0):t.width=e.width,void 0===e.height||n?n&&(o=!0):t.height=e.height,o&&(t.anchor=t.anchor),void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.useInput&&(t.useInput=e.useInput),void 0!==e.fitMode&&(t.fitMode=e.fitMode),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),void 0!==e.type&&(t.type=e.type),"image"===t.type?(void 0!==e.rect&&(t.rect=e.rect),void 0!==e.color&&(a=e.color,a instanceof et||(a=new et(e.color[0],e.color[1],e.color[2])),t.color=a),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.textureAsset&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.spriteFrame&&(t.spriteFrame=e.spriteFrame),void 0!==e.pixelsPerUnit&&null!==e.pixelsPerUnit&&(t.pixelsPerUnit=e.pixelsPerUnit),void 0!==e.materialAsset&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),void 0!==e.mask&&(t.mask=e.mask)):"text"===t.type&&(void 0!==e.autoWidth&&(t.autoWidth=e.autoWidth),void 0!==e.autoHeight&&(t.autoHeight=e.autoHeight),void 0!==e.rtlReorder&&(t.rtlReorder=e.rtlReorder),void 0!==e.unicodeConverter&&(t.unicodeConverter=e.unicodeConverter),null!==e.text&&void 0!==e.text?t.text=e.text:null!==e.key&&void 0!==e.key&&(t.key=e.key),void 0!==e.color&&(a=e.color,a instanceof et||(a=new et(a[0],a[1],a[2])),t.color=a),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.spacing&&(t.spacing=e.spacing),void 0!==e.fontSize&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),void 0!==e.lineHeight&&(t.lineHeight=e.lineHeight),void 0!==e.maxLines&&(t.maxLines=e.maxLines),void 0!==e.wrapLines&&(t.wrapLines=e.wrapLines),void 0!==e.minFontSize&&(t.minFontSize=e.minFontSize),void 0!==e.maxFontSize&&(t.maxFontSize=e.maxFontSize),e.autoFitWidth&&(t.autoFitWidth=e.autoFitWidth),e.autoFitHeight&&(t.autoFitHeight=e.autoFitHeight),void 0!==e.fontAsset&&(t.fontAsset=e.fontAsset),void 0!==e.font&&(t.font=e.font),void 0!==e.alignment&&(t.alignment=e.alignment),void 0!==e.outlineColor&&(t.outlineColor=e.outlineColor),void 0!==e.outlineThickness&&(t.outlineThickness=e.outlineThickness),void 0!==e.shadowColor&&(t.shadowColor=e.shadowColor),void 0!==e.shadowOffset&&(t.shadowOffset=e.shadowOffset),void 0!==e.enableMarkup&&(t.enableMarkup=e.enableMarkup));const h=t._parseUpToScreen();h.screen&&t._updateScreen(h.screen),super.initializeComponentData(t,e,s),t._beingInitialized=!1,"image"===t.type&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)}onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,fitMode:s.fitMode,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return void 0!==s.key&&null!==s.key?i.key=s.key:i.text=s.text,this.addComponent(e,i)}getTextElementMaterial(t,e){return t?e?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new Xh,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new Xh,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):e?(this.defaultTextMaterial||(this.defaultTextMaterial=new Xh,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new Xh,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)}_createBaseImageMaterial(){const t=new Xh;return t.diffuse.set(0,0,0),t.emissive.set(.5,.5,.5),t.emissiveMap=this._defaultTexture,t.emissiveTint=!0,t.opacityMap=this._defaultTexture,t.opacityMapChannel="a",t.opacityTint=!0,t.opacity=0,t.useLighting=!1,t.useGammaTonemap=!1,t.useFog=!1,t.useSkybox=!1,t.blendType=4,t.depthWrite=!1,t}getImageElementMaterial(t,e,s,i){return t?e?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):e?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(t){this._unicodeConverter=t}registerRtlReorder(t){this._rtlReorder=t}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}Lp._buildAccessors(XT.prototype,YT);const $T="free",ZT="limited",QT="locked",JT=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class tM extends Lp{constructor(t,e){super(t,e),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX="locked",this._linearLimitsX=new ot(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY="locked",this._linearLimitsY=new ot(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ="locked",this._linearLimitsZ=new ot(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX="locked",this._angularLimitsX=new ot(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY="locked",this._angularLimitsY=new ot(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ="locked",this._angularLimitsZ=new ot(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(t){this._destroyConstraint(),this._entityA=t,this._createConstraint()}get entityA(){return this._entityA}set entityB(t){this._destroyConstraint(),this._entityB=t,this._createConstraint()}get entityB(){return this._entityB}set breakForce(t){this._constraint&&this._breakForce!==t&&(this._constraint.setBreakingImpulseThreshold(t),this._breakForce=t)}get breakForce(){return this._breakForce}set enableCollision(t){this._destroyConstraint(),this._enableCollision=t,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(t){this._angularLimitsX.equals(t)||(this._angularLimitsX.copy(t),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(t){this._angularMotionX!==t&&(this._angularMotionX=t,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(t){this._angularLimitsY.equals(t)||(this._angularLimitsY.copy(t),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(t){this._angularMotionY!==t&&(this._angularMotionY=t,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(t){this._angularLimitsZ.equals(t)||(this._angularLimitsZ.copy(t),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(t){this._angularMotionZ!==t&&(this._angularMotionZ=t,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(t){this._linearLimitsX.equals(t)||(this._linearLimitsX.copy(t),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(t){this._linearMotionX!==t&&(this._linearMotionX=t,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(t){this._linearLimitsY.equals(t)||(this._linearLimitsY.copy(t),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(t){this._linearMotionY!==t&&(this._linearMotionY=t,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(t){this._linearLimitsZ.equals(t)||(this._linearLimitsZ.copy(t),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(t){this._linearMotionZ!==t&&(this._linearMotionZ=t,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(t,e){const s=t.getTranslation(),i=new ft;i.setFromMat4(t);const n=new Ammo.btVector3(s.x,s.y,s.z),a=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);e.setOrigin(n),e.setRotation(a),Ammo.destroy(n),Ammo.destroy(a)}_updateAngularLimits(){const t=this._constraint;if(t){let e,s,i,n,a,r;"limited"===this._angularMotionX?(e=this._angularLimitsX.x*q.DEG_TO_RAD,n=this._angularLimitsX.y*q.DEG_TO_RAD):"free"===this._angularMotionX?(e=1,n=0):e=n=0,"limited"===this._angularMotionY?(s=this._angularLimitsY.x*q.DEG_TO_RAD,a=this._angularLimitsY.y*q.DEG_TO_RAD):"free"===this._angularMotionY?(s=1,a=0):s=a=0,"limited"===this._angularMotionZ?(i=this._angularLimitsZ.x*q.DEG_TO_RAD,r=this._angularLimitsZ.y*q.DEG_TO_RAD):"free"===this._angularMotionZ?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(e,s,i);t.setAngularLowerLimit(o),o.setValue(n,a,r),t.setAngularUpperLimit(o),Ammo.destroy(o)}}_updateLinearLimits(){const t=this._constraint;if(t){let e,s,i,n,a,r;"limited"===this._linearMotionX?(e=this._linearLimitsX.x,n=this._linearLimitsX.y):"free"===this._linearMotionX?(e=1,n=0):e=n=0,"limited"===this._linearMotionY?(s=this._linearLimitsY.x,a=this._linearLimitsY.y):"free"===this._linearMotionY?(s=1,a=0):s=a=0,"limited"===this._linearMotionZ?(i=this._linearLimitsZ.x,r=this._linearLimitsZ.y):"free"===this._linearMotionZ?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(e,s,i);t.setLinearLowerLimit(o),o.setValue(n,a,r),t.setLinearUpperLimit(o),Ammo.destroy(o)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const t=new mt,e=this._entityA.rigidbody.body;e.activate();const s=this.entity.getWorldTransform(),i=this._entityA.getWorldTransform().clone().invert();t.mul2(i,s);const n=new Ammo.btTransform;if(this._convertTransform(t,n),this._entityB&&this._entityB.rigidbody){const i=this._entityB.rigidbody.body;i.activate();const a=this._entityB.getWorldTransform().clone().invert();t.mul2(a,s);const r=new Ammo.btTransform;this._convertTransform(t,r),this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,i,n,r,!this._enableCollision),Ammo.destroy(r)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,n,!this._enableCollision);Ammo.destroy(n);const a=["X","Y","Z","X","Y","Z"];for(let t=0;t<6;t++){const e=t<3?"_linear":"_angular";this._constraint.enableSpring(t,this[e+"Spring"+a[t]]),this._constraint.setDamping(t,this[e+"Damping"+a[t]]),this._constraint.setEquilibriumPoint(t,this[e+"Equilibrium"+a[t]]),this._constraint.setStiffness(t,this[e+"Stiffness"+a[t]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits();this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){if(this._constraint){this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null}}initFromData(t){for(const e of JT)t.hasOwnProperty(e)&&(t[e]instanceof ot?this["_"+e].copy(t[e]):this["_"+e]=t[e]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(t,e,s){}_onBeforeRemove(){this.fire("remove")}}const eM={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach((t=>{["Damping","Equilibrium","Spring","Stiffness"].forEach((e=>{["X","Y","Z"].forEach((s=>{const i=t+e+s,n="_"+i;let a="linear"===t?0:3;"Y"===s&&(a+=1),"Z"===s&&(a+=2),Object.defineProperty(tM.prototype,i,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this._constraint[eM[e]](a,t))}})}))}))}));class sM{constructor(){this.enabled=!0}}const iM=["enabled"];class nM extends PS{constructor(t){super(t),this.id="joint",this.app=t,this.ComponentType=tM,this.DataType=sM,this.schema=iM}initializeComponentData(t,e,s){t.initFromData(e)}}Lp._buildAccessors(tM.prototype,iM);class aM extends Lp{constructor(t,e){super(t,e),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}set minWidth(t){t!==this._minWidth&&(this._minWidth=t,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(t){t!==this._minHeight&&(this._minHeight=t,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(t){t!==this._maxWidth&&(this._maxWidth=t,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(t){t!==this._maxHeight&&(this._maxHeight=t,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(t){t!==this._fitWidthProportion&&(this._fitWidthProportion=t,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(t){t!==this._fitHeightProportion&&(this._fitHeightProportion=t,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(t){t!==this._excludeFromLayout&&(this._excludeFromLayout=t,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}}class rM{constructor(){this.enabled=!0}}const oM=["enabled"];class hM extends PS{constructor(t){super(t),this.id="layoutchild",this.ComponentType=aM,this.DataType=rM,this.schema=oM}initializeComponentData(t,e,s){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.minWidth&&(t.minWidth=e.minWidth),void 0!==e.minHeight&&(t.minHeight=e.minHeight),void 0!==e.maxWidth&&(t.maxWidth=e.maxWidth),void 0!==e.maxHeight&&(t.maxHeight=e.maxHeight),void 0!==e.fitWidthProportion&&(t.fitWidthProportion=e.fitWidthProportion),void 0!==e.fitHeightProportion&&(t.fitHeightProportion=e.fitHeightProportion),void 0!==e.excludeFromLayout&&(t.excludeFromLayout=e.excludeFromLayout),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutchild;return this.addComponent(e,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}Lp._buildAccessors(aM.prototype,oM);const lM=0,cM=1,dM=2,uM=3,pM={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},mM={0:1,1:0},fM={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},_M="NONE",gM="APPLY_STRETCHING",yM="APPLY_SHRINKING",vM=new ot;function xM(t){let e;const s=pM[t],i=pM[mM[t]];function n(t,e){return-e[s.size]*t.pivot[s.axis]}function a(t,e){return-e[i.size]*t.pivot[i.axis]}function r(t,e){return e[s.size]*(1-t.pivot[s.axis])}function o(t){const e=t.entity.layoutchild;return!e||!e.enabled||!e.excludeFromLayout}function h(t,e,s){switch(t){case 0:return _M;case 1:return e<s?gM:_M;case 2:return e>=s?yM:_M;case 3:return e<s?gM:yM;default:throw new Error(`Unrecognized fitting mode: ${t}`)}}function l(t,s){return _(t,s.size)+(t.length-1)*e.spacing[s.axis]}function c(t,e,s){const i=y(t,s.maxSize),n=g(t,s.fittingProportion),a=b(n,i);let r=vM[s.axis]-e;for(let e=0;e<t.length;++e){const o=i[e],h=u(o,r,n,a),l=t[o][s.size]+h,c=t[o][s.maxSize],d=Math.min(l,c);t[o][s.size]=d;r-=h-Math.max(l-d,0)}}function d(t,e,s){const i=y(t,s.minSize,!0),n=function(t){if(1===t.length)return[1];const e=[],s=t.length;for(let i=0;i<s;++i)e.push((1-t[i])/(s-1));return e}(g(t,s.fittingProportion)),a=b(n,i);let r=e-vM[s.axis];for(let e=0;e<t.length;++e){const o=i[e],h=u(o,r,n,a),l=t[o][s.size]-h,c=t[o][s.minSize],d=Math.max(l,c);t[o][s.size]=d;r-=h-Math.max(d-l,0)}}function u(t,e,s,i){const n=s[t],a=i[t];return Math.abs(n)<1e-5&&Math.abs(a)<1e-5?e:e*n/a}function p(t){const e=[];for(let s=0;s<t.length;++s){const i=t[s],n=Math.max(m(i,"minWidth"),0),a=Math.max(m(i,"minHeight"),0),r=Math.max(m(i,"maxWidth"),n),o=Math.max(m(i,"maxHeight"),a),h=f(m(i,"width"),n,r),l=f(m(i,"height"),a,o),c=m(i,"fitWidthProportion"),d=m(i,"fitHeightProportion");e.push({minWidth:n,minHeight:a,maxWidth:r,maxHeight:o,width:h,height:l,fitWidthProportion:c,fitHeightProportion:d})}return e}function m(t,e){const s=t.entity.layoutchild;return s&&s.enabled&&void 0!==s[e]&&null!==s[e]?s[e]:void 0!==t[e]?t[e]:fM[e]}function f(t,e,s){return Math.min(Math.max(t,e),s)}function _(t,e){return t.reduce((function(t,s){return t+s[e]}),0)}function g(t,e){const s=_(t,e),i=[],n=t.length;if(0===s)for(let t=0;t<n;++t)i.push(1/n);else for(let a=0;a<n;++a)i.push(t[a][e]/s);return i}function y(t,e,s){return t.forEach(v),t.slice().sort((function(t,i){return s?i[e]-t[e]:t[e]-i[e]})).map(x)}function v(t,e){t.index=e}function x(t){return t.index}function b(t,e){const s=[];s[e[t.length-1]]=t[e[t.length-1]];for(let i=t.length-2;i>=0;--i)s[e[i]]=s[e[i+1]]+t[e[i]];return s}return function(t,u){t=t.filter(o),e=u,vM.x=e.containerSize.x-e.padding.x-e.padding.z,vM.y=e.containerSize.y-e.padding.y-e.padding.w,function(t){for(let e=0;e<t.length;++e){const s=t[e],i=s.anchor;0===i.x&&0===i.y&&0===i.z&&0===i.w||(s.anchor=ht.ZERO)}}(t);const m=function(t){const s=0===e.orientation&&e.reverseX||1===e.orientation&&e.reverseY,i=0===e.orientation&&e.reverseY||1===e.orientation&&e.reverseX;if(s)for(let e=0;e<t.length;++e)s&&t[e].reverse();i&&t.reverse();return t}(function(t){if(!e.wrap)return[t];const i=[[]],n=p(t);let a=0;const r=2===e[s.fitting];for(let o=0;o<t.length;++o){i[i.length-1].length>0&&(a+=e.spacing[s.axis]);const h=n[o][s.size];a+=h,!r&&a>vM[s.axis]&&0!==i[i.length-1].length&&(a=h,i.push([])),i[i.length-1].push(t[o]),r&&a>vM[s.axis]&&o!==t.length-1&&(a=0,i.push([]))}return i}(t)),f=function(t,s){const n=[],a=[];for(let e=0;e<t.length;++e){const r=t[e];r.largestElement=null,r.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let t=0;t<r.length;++t){const n=s[e][t];n[i.size]>r.largestSize[i.size]&&(r.largestElement=r[t],r.largestSize=n)}n.push(r.largestElement),a.push(r.largestSize)}const r=l(a,i),o=h(e[i.fitting],r,vM[i.axis]);o===gM?c(a,r,i):o===yM&&d(a,r,i);for(let n=0;n<t.length;++n){const a=t[n];for(let r=0;r<a.length;++r){const o=s[n][r],l=o[i.size],c=1===t.length?vM[i.axis]:a.largestSize[i.size],d=h(e[i.fitting],l,c);d===gM?o[i.size]=Math.min(c,o[i.maxSize]):d===yM&&(o[i.size]=Math.max(c,o[i.minSize]))}}return s}(m,function(t){const i=[];for(let n=0;n<t.length;++n){const a=p(t[n]),r=l(a,s),o=h(e[s.fitting],r,vM[s.axis]);o===gM?c(a,r,s):o===yM&&d(a,r,s),i.push(a)}return i}(m)),_=function(t,o){const h={};h[s.axis]=0,h[i.axis]=0,t[s.size]=Number.NEGATIVE_INFINITY;const l=[];for(let c=0;c<t.length;++c){const d=t[c];if(0===d.length){l.push([]);continue}const u=[],p=o[c];for(let t=0;t<d.length;++t){const o=d[t],l=p[t];h[i.axis]-=a(o,l),h[s.axis]-=n(o,l),u[t]={},u[t][s.axis]=h[s.axis],u[t][i.axis]=h[i.axis],h[i.axis]+=a(o,l),h[s.axis]+=r(o,l)+e.spacing[s.axis]}d[s.size]=h[s.axis]-e.spacing[s.axis],d[i.size]=d.largestSize[i.size],t[s.size]=Math.max(t[s.size],d[s.size]),h[s.axis]=0,h[i.axis]+=d[i.size]+e.spacing[i.axis],l.push(u)}return t[i.size]=h[i.axis]-e.spacing[i.axis],l}(m,f);return function(t,n,a){const r=e.alignment[s.axis],o=e.alignment[i.axis],h=e.padding[s.axis],l=e.padding[i.axis];for(let c=0;c<t.length;++c){const d=t[c],u=n[c],p=a[c],m=(vM[s.axis]-d[s.size])*r+h,f=(vM[i.axis]-t[i.size])*o+l;for(let t=0;t<d.length;++t){const n=(d[i.size]-u[t][i.size])*e.alignment[i.axis];p[t][s.axis]+=m,p[t][i.axis]+=f+n}}}(m,f,_),function(t,n,a){for(let r=0;r<t.length;++r){const o=t[r],h=n[r],l=a[r];for(let t=0;t<o.length;++t){const n=o[t];n[s.calculatedSize]=h[t][s.size],n[i.calculatedSize]=h[t][i.size],0===e.orientation?n.entity.setLocalPosition(l[t][s.axis],l[t][i.axis],n.entity.getLocalPosition().z):n.entity.setLocalPosition(l[t][i.axis],l[t][s.axis],n.entity.getLocalPosition().z)}}}(m,f,_),function(t){const s=t.width,i=t.height,n=(vM.x-s)*e.alignment.x+e.padding.x,a=(vM.y-i)*e.alignment.y+e.padding.y;return{bounds:new ht(n,a,s,i)}}(m)}}const bM={};bM[0]=xM(0),bM[1]=xM(1);class SM{calculateLayout(t,e){const s=bM[e.orientation];if(s)return s(t,e);throw new Error("Unrecognized orientation value: "+e.orientation)}}function wM(t){return t.element}function TM(t){return t.enabled&&t.element&&t.element.enabled}class MM extends Lp{constructor(t,e){super(t,e),this._orientation=0,this._reverseX=!1,this._reverseY=!0,this._alignment=new ot(0,1),this._padding=new ht,this._spacing=new ot,this._widthFitting=0,this._heightFitting=0,this._wrap=!1,this._layoutCalculator=new SM,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach((t=>{this._listenForReflowEvents(t,"on")})),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),t.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),t.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(t){t!==this._orientation&&(this._orientation=t,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(t){t!==this._reverseX&&(this._reverseX=t,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(t){t!==this._reverseY&&(this._reverseY=t,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(t){t.equals(this._alignment)||(this._alignment.copy(t),this._scheduleReflow())}get alignment(){return this._alignment}set padding(t){t.equals(this._padding)||(this._padding.copy(t),this._scheduleReflow())}get padding(){return this._padding}set spacing(t){t.equals(this._spacing)||(this._spacing.copy(t),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(t){t!==this._widthFitting&&(this._widthFitting=t,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(t){t!==this._heightFitting&&(this._heightFitting=t,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(t){t!==this._wrap&&(this._wrap=t,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(t){return t===this.entity||-1!==this.entity.children.indexOf(t)}_listenForReflowEvents(t,e){t.element&&(t.element[e]("enableelement",this._scheduleReflow,this),t.element[e]("disableelement",this._scheduleReflow,this),t.element[e]("resize",this._scheduleReflow,this),t.element[e]("set:pivot",this._scheduleReflow,this)),t.layoutchild&&(t.layoutchild[e]("set_enabled",this._scheduleReflow,this),t.layoutchild[e]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"off"),this._scheduleReflow())}_onChildInsert(t){this._listenForReflowEvents(t,"on"),this._scheduleReflow()}_onChildRemove(t){this._listenForReflowEvents(t,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const t=wM(this.entity),e=this.entity.children.filter(TM).map(wM);if(!t||0===e.length)return;const s=Math.max(t.calculatedWidth,0),i=Math.max(t.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new ot(s,i)};this._isPerformingReflow=!0;const a=this._layoutCalculator.calculateLayout(e,n);this._isPerformingReflow=!1,this.fire("reflow",a)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach((t=>{this._listenForReflowEvents(t,"off")})),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}class CM{constructor(){this.enabled=!0}}const AM=["enabled"];class PM extends PS{constructor(t){super(t),this.id="layoutgroup",this.ComponentType=MM,this.DataType=CM,this.schema=AM,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e,s){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.orientation&&(t.orientation=e.orientation),void 0!==e.reverseX&&(t.reverseX=e.reverseX),void 0!==e.reverseY&&(t.reverseY=e.reverseY),void 0!==e.alignment&&(t.alignment=Array.isArray(e.alignment)?new ot(e.alignment):e.alignment),void 0!==e.padding&&(t.padding=Array.isArray(e.padding)?new ht(e.padding):e.padding),void 0!==e.spacing&&(t.spacing=Array.isArray(e.spacing)?new ot(e.spacing):e.spacing),void 0!==e.widthFitting&&(t.widthFitting=e.widthFitting),void 0!==e.heightFitting&&(t.heightFitting=e.heightFitting),void 0!==e.wrap&&(t.wrap=e.wrap),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutgroup;return this.addComponent(e,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(t){-1===this._reflowQueue.indexOf(t)&&this._reflowQueue.push(t)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(0===this._reflowQueue.length)return;let t=0;for(;this._reflowQueue.length>0;){const e=this._reflowQueue.slice();this._reflowQueue.length=0,e.sort((function(t,e){return t.entity.graphDepth-e.entity.graphDepth}));for(let t=0;t<e.length;++t)e[t].reflow();if(++t>=100){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}Lp._buildAccessors(MM.prototype,AM);class EM extends Lp{constructor(t,e){super(t,e),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=void 0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(t){this._model&&(this._model.meshInstances=t)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(t){if(this._customAabb=t,this._model){const t=this._model.meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(t){if(this._type!==t)if(this._area=null,this._type=t,"asset"===t)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{const e=fc(this.system.app.graphicsDevice,t);this._area=e.area;const s=e.mesh,i=new qo,n=new Du;n.graph=i,n.meshInstances=[new Ec(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(t){const e=this.system.app.assets;let s=t;if(t instanceof vp&&(s=t.id),this._asset!==s){if(this._asset){e.off("add:"+this._asset,this._onModelAssetAdded,this);const t=e.get(this._asset);t&&this._unbindModelAsset(t)}if(this._asset=s,this._asset){const t=e.get(this._asset);t?this._bindModelAsset(t):(this.model=null,e.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(t){if(this._model!==t&&(!t||!t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let e=0;e<t.length;e++)t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(t){if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows===t)return;const e=this._model;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e.meshInstances)}const n=e.meshInstances;for(let e=0;e<n.length;e++)n[e].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e.meshInstances)}}this._castShadows=t}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model)){const e=this._model.meshInstances;for(let s=0,i=e.length;s<i;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(t){if(this._isStatic!==t&&(this._isStatic=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++){e[s].isStatic=t}}}get isStatic(){return this._isStatic}set layers(t){const e=this.system.app.scene.layers;if(this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(t){if(this._batchGroupId!==t){var e,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(e=this.system.app.batcher)||e.remove(yc.MODEL,this.batchGroupId,this.entity);if(this.entity.enabled&&t>=0)null==(s=this.system.app.batcher)||s.insert(yc.MODEL,t,this.entity);t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=t}}get batchGroupId(){return this._batchGroupId}set materialAsset(t){let e=t;t instanceof vp&&(e=t.id);const s=this.system.app.assets;if(e!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const t=s.get(this._materialAsset);t&&this._unbindMaterialAsset(t)}if(this._materialAsset=e,this._materialAsset){const t=s.get(this._materialAsset);t?this._bindMaterialAsset(t):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}get material(){return this._material}set mapping(t){if("asset"!==this._type)return;if(this._unsetMaterialEvents(),t||(t={}),this._mapping=t,!this._model)return;const e=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let s=0,a=e.length;s<a;s++)if(void 0!==t[s])t[s]?(n=this.system.app.assets.get(t[s]),this._loadAndSetMeshInstanceMaterial(n,e[s],s)):e[s].material=this.system.defaultMaterial;else if(i)if(i[s]&&(i[s].material||i[s].path)){if(void 0!==i[s].material)n=this.system.app.assets.get(i[s].material);else if(void 0!==i[s].path){const t=this._getMaterialAssetUrl(i[s].path);t&&(n=this.system.app.assets.getByUrl(t))}this._loadAndSetMeshInstanceMaterial(n,e[s],s)}else e[s].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this.meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.meshInstances)}_setMaterialEvent(t,e,s,i){const n=e+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][n]={id:s,handler:i}}_unsetMaterialEvents(){const t=this.system.app.assets,e=this._materialEvents;if(e){for(let s=0,i=e.length;s<i;s++){if(!e[s])continue;const i=e[s];for(const e in i)t.off(e,i[e].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(t){let e=null;if(isNaN(parseInt(t,10))){if(this.asset){const s=this._getMaterialAssetUrl(t);s&&(e=this.system.app.assets.getByUrl(s))}}else e=this.system.app.assets.get(t);return e}_getMaterialAssetUrl(t){if(!this.asset)return null;const e=this.system.app.assets.get(this.asset);return e?e.getAbsoluteUrl(t):null}_loadAndSetMeshInstanceMaterial(t,e,s){const i=this.system.app.assets;t&&(t.resource?(e.material=t.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))):(this._setMaterialEvent(s,"load",t.id,(function(i){e.material=i.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&i.load(t)))}onEnable(){const t=this.system.app,e=t.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=t.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=t.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const e in this._mapping)this._mapping[e]&&(i=this._getAssetByIdOrPath(this._mapping[e]),i&&!i.resource&&t.assets.load(i));var n;this._batchGroupId>=0&&(null==(n=t.batcher)||n.insert(yc.MODEL,this.batchGroupId,this.entity))}onDisable(){const t=this.system.app,e=t.scene;var s;(e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(s=t.batcher)||s.remove(yc.MODEL,this.batchGroupId,this.entity));this._model&&this.removeModelFromLayers()}hide(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!1}}show(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!0}}_bindMaterialAsset(t){if(t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMaterialAsset(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(t){this.system.app.assets.off("add:"+t.id,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_onMaterialAssetLoad(t){this._setMaterial(t.resource)}_onMaterialAssetUnload(t){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(t){this._onMaterialAssetUnload(t)}_onMaterialAssetChange(t){}_bindModelAsset(t){if(this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindModelAsset(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(t){this.system.app.assets.off("add:"+t.id,this._onModelAssetAdded,this),t.id===this._asset&&this._bindModelAsset(t)}_onModelAssetLoad(t){this.model=t.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(t){this.model=null}_onModelAssetChange(t,e,s,i){"data"===e&&(this.mapping=this._mapping)}_onModelAssetRemove(t){this.model=null}_setMaterial(t){if(this._material===t)return;this._material=t;const e=this._model;if(e&&"asset"!==this._type){const s=e.meshInstances;for(let e=0,i=s.length;e<i;e++)s[e].material=t}}}class RM{constructor(){this.enabled=!0}}const LM=["enabled"];class IM extends PS{constructor(t){super(t),this.id="model",this.ComponentType=EM,this.DataType=RM,this.schema=LM,this.defaultMaterial=Dh(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new bt(new at(e.aabbCenter),new at(e.aabbHalfExtents))),super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s={type:t.model.type,asset:t.model.asset,castShadows:t.model.castShadows,receiveShadows:t.model.receiveShadows,castShadowsLightmap:t.model.castShadowsLightmap,lightmapped:t.model.lightmapped,lightmapSizeMultiplier:t.model.lightmapSizeMultiplier,isStatic:t.model.isStatic,enabled:t.model.enabled,layers:t.model.layers,batchGroupId:t.model.batchGroupId,mapping:m({},t.model.mapping)};let i=t.model.materialAsset;i instanceof vp||null==i||(i=this.app.assets.get(i));const n=t.model.material;n&&n!==this.defaultMaterial&&i&&n!==i.resource||(s.materialAsset=i);const a=this.addComponent(e,s);if(t.model.model&&"asset"===t.model.type&&!t.model.asset&&(a.model=t.model.model.clone(),a._clonedModel=!0),s.materialAsset||(a.material=n),t.model.model){const e=t.model.model.meshInstances,s=a.model.meshInstances;for(let t=0;t<e.length;t++)s[t].mask=e[t].mask,s[t].material=e[t].material,s[t].layer=e[t].layer,s[t].receiveShadow=e[t].receiveShadow}return t.model.customAabb&&(a.customAabb=t.model.customAabb.clone()),a}onRemove(t,e){e.onRemove()}}Lp._buildAccessors(EM.prototype,LM);const DM=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],OM=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],FM=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],kM=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let BM;class zM extends Lp{constructor(t,e){super(t,e),this._requestedDepth=!1,this._drawOrder=0,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),DM.forEach((t=>{this.on(`set_${t}`,this.onSetSimpleProperty,this)})),OM.forEach((t=>{this.on(`set_${t}`,this.onSetComplexProperty,this)})),FM.forEach((t=>{this.on(`set_${t}`,this.onSetGraphProperty,this)}))}set drawOrder(t){this._drawOrder=t,this.emitter&&(this.emitter.drawOrder=t)}get drawOrder(){return this._drawOrder}addMeshInstanceToLayers(){if(this.emitter)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&(e.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=e)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(t,e,s){if(this.emitter){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeMeshInstances([this.emitter.meshInstance])}if(this.enabled&&this.entity.enabled)for(let t=0;t<s.length;t++){const e=this.system.app.scene.layers.getLayerById(s[t]);e&&e.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(t,e){this.addMeshInstanceToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){if(!this.emitter)return;this.layers.indexOf(t.id)<0||t.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(t){if(!this.emitter)return;this.layers.indexOf(t.id)<0||t.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(t){if(t.on("load",this._onColorMapAssetLoad,this),t.on("unload",this._onColorMapAssetUnload,this),t.on("remove",this._onColorMapAssetRemove,this),t.on("change",this._onColorMapAssetChange,this),t.resource)this._onColorMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindColorMapAsset(t){t.off("load",this._onColorMapAssetLoad,this),t.off("unload",this._onColorMapAssetUnload,this),t.off("remove",this._onColorMapAssetRemove,this),t.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(t){this.colorMap=t.resource}_onColorMapAssetUnload(t){this.colorMap=null}_onColorMapAssetRemove(t){this._onColorMapAssetUnload(t)}_onColorMapAssetChange(t){}onSetColorMapAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindColorMapAsset(t)}if(s){s instanceof vp&&(this.data.colorMapAsset=s.id,s=s.id);const t=i.get(s);t?this._bindColorMapAsset(t):i.once("add:"+s,(t=>{this._bindColorMapAsset(t)}))}else this.colorMap=null}_bindNormalMapAsset(t){if(t.on("load",this._onNormalMapAssetLoad,this),t.on("unload",this._onNormalMapAssetUnload,this),t.on("remove",this._onNormalMapAssetRemove,this),t.on("change",this._onNormalMapAssetChange,this),t.resource)this._onNormalMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindNormalMapAsset(t){t.off("load",this._onNormalMapAssetLoad,this),t.off("unload",this._onNormalMapAssetUnload,this),t.off("remove",this._onNormalMapAssetRemove,this),t.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(t){this.normalMap=t.resource}_onNormalMapAssetUnload(t){this.normalMap=null}_onNormalMapAssetRemove(t){this._onNormalMapAssetUnload(t)}_onNormalMapAssetChange(t){}onSetNormalMapAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindNormalMapAsset(t)}if(s){s instanceof vp&&(this.data.normalMapAsset=s.id,s=s.id);const t=i.get(s);t?this._bindNormalMapAsset(t):i.once("add:"+s,(t=>{this._bindNormalMapAsset(t)}))}else this.normalMap=null}_bindMeshAsset(t){if(t.on("load",this._onMeshAssetLoad,this),t.on("unload",this._onMeshAssetUnload,this),t.on("remove",this._onMeshAssetRemove,this),t.on("change",this._onMeshAssetChange,this),t.resource)this._onMeshAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMeshAsset(t){t.off("load",this._onMeshAssetLoad,this),t.off("unload",this._onMeshAssetUnload,this),t.off("remove",this._onMeshAssetRemove,this),t.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(t){this._onMeshChanged(t.resource)}_onMeshAssetUnload(t){this.mesh=null}_onMeshAssetRemove(t){this._onMeshAssetUnload(t)}_onMeshAssetChange(t){}onSetMeshAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindMeshAsset(t)}if(s){s instanceof vp&&(this.data.meshAsset=s.id,s=s.id);const t=i.get(s);t&&this._bindMeshAsset(t)}else this._onMeshChanged(null)}onSetMesh(t,e,s){!s||s instanceof vp||"number"==typeof s?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(t){!t||t instanceof ec||(t=t.meshInstances[0]?t.meshInstances[0].mesh:null),this.data.mesh=t,this.emitter&&(this.emitter.mesh=t,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindRenderAsset(t)}if(s){s instanceof vp&&(this.data.renderAsset=s.id,s=s.id);const t=i.get(s);t&&this._bindRenderAsset(t)}else this._onRenderChanged(null)}_bindRenderAsset(t){if(t.on("load",this._onRenderAssetLoad,this),t.on("unload",this._onRenderAssetUnload,this),t.on("remove",this._onRenderAssetRemove,this),t.resource)this._onRenderAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindRenderAsset(t){t.off("load",this._onRenderAssetLoad,this),t.off("unload",this._onRenderAssetUnload,this),t.off("remove",this._onRenderAssetRemove,this),t.resource&&t.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(t){this._onRenderChanged(t.resource)}_onRenderAssetUnload(t){this._onRenderChanged(null)}_onRenderAssetRemove(t){this._onRenderAssetUnload(t)}_onRenderChanged(t){t?(t.off("set:meshes",this._onRenderSetMeshes,this),t.on("set:meshes",this._onRenderSetMeshes,this),t.meshes&&this._onRenderSetMeshes(t.meshes)):this._onMeshChanged(null)}_onRenderSetMeshes(t){this._onMeshChanged(t&&t[0])}onSetLoop(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetTime())}onSetBlendType(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(BM||(BM=this.system.app.scene.layers.getLayerById(1)),BM&&(BM.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&BM&&(BM.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(t,e,s){e!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[t]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[t]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial())}onSetComplexProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const t=this.data;for(let e=0,s=kM.length;e<s;e++){let s=t[kM[e]];if(s){if(!(s instanceof vp)){if(!(parseInt(s,10)>=0))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}if(!this.emitter){let e=t.mesh;e instanceof ec||(e=null),this.emitter=new sf(this.system.app.graphicsDevice,{numParticles:t.numParticles,emitterExtents:t.emitterExtents,emitterExtentsInner:t.emitterExtentsInner,emitterRadius:t.emitterRadius,emitterRadiusInner:t.emitterRadiusInner,emitterShape:t.emitterShape,initialVelocity:t.initialVelocity,wrap:t.wrap,localSpace:t.localSpace,screenSpace:t.screenSpace,wrapBounds:t.wrapBounds,lifetime:t.lifetime,rate:t.rate,rate2:t.rate2,orientation:t.orientation,particleNormal:t.particleNormal,animTilesX:t.animTilesX,animTilesY:t.animTilesY,animStartFrame:t.animStartFrame,animNumFrames:t.animNumFrames,animNumAnimations:t.animNumAnimations,animIndex:t.animIndex,randomizeAnimIndex:t.randomizeAnimIndex,animSpeed:t.animSpeed,animLoop:t.animLoop,startAngle:t.startAngle,startAngle2:t.startAngle2,scaleGraph:t.scaleGraph,scaleGraph2:t.scaleGraph2,colorGraph:t.colorGraph,colorGraph2:t.colorGraph2,alphaGraph:t.alphaGraph,alphaGraph2:t.alphaGraph2,localVelocityGraph:t.localVelocityGraph,localVelocityGraph2:t.localVelocityGraph2,velocityGraph:t.velocityGraph,velocityGraph2:t.velocityGraph2,rotationSpeedGraph:t.rotationSpeedGraph,rotationSpeedGraph2:t.rotationSpeedGraph2,radialSpeedGraph:t.radialSpeedGraph,radialSpeedGraph2:t.radialSpeedGraph2,colorMap:t.colorMap,normalMap:t.normalMap,loop:t.loop,preWarm:t.preWarm,sort:t.sort,stretch:t.stretch,alignToMotion:t.alignToMotion,lighting:t.lighting,halfLambert:t.halfLambert,intensity:t.intensity,depthSoftening:t.depthSoftening,scene:this.system.app.scene,mesh:e,depthWrite:t.depthWrite,noFog:t.noFog,node:this.entity,blendType:t.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,t.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&t.depthSoftening&&this._requestDepth()}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let t=0;t<kM.length;t++){const e=kM[t];this.data[e]&&(this[e]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)}rebuild(){const t=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity),this.enabled=t}}class UM{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new at,this.emitterExtentsInner=new at,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrapBounds=new at,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=0,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=0,this.particleNormal=new at(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]}}const VM=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class NM extends PS{constructor(t){super(t),this.id="particlesystem",this.ComponentType=zM,this.DataType=UM,this.schema=VM,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i={};s=[];const n=this.propertyTypes;(e.mesh instanceof vp||"number"==typeof e.mesh)&&(e.meshAsset=e.mesh,delete e.mesh);for(const t in e){if(e.hasOwnProperty(t)&&(s.push(t),i[t]=e[t]),"vec3"===n[t])Array.isArray(i[t])&&(i[t]=new at(i[t][0],i[t][1],i[t][2]));else if("curve"===n[t]){if(!(i[t]instanceof it)){const e=i[t].type;i[t]=new it(i[t].keys),i[t].type=e}}else if("curveset"===n[t]&&!(i[t]instanceof nt)){const e=i[t].type;i[t]=new nt(i[t].keys),i[t].type=e}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(t,i,s)}cloneComponent(t,e){const s=t.particlesystem.data,i=this.schema,n={};for(let t=0,e=i.length;t<e;t++){const e=i[t];let a=s[e];a instanceof at||a instanceof it||a instanceof nt?(a=a.clone(),n[e]=a):"layers"===e?n.layers=s.layers.slice(0):null!=a&&(n[e]=a)}return this.addComponent(e,n)}onUpdate(t){const e=this.store;let s;const i=this.app.stats.particles;for(const n in e)if(e.hasOwnProperty(n)){const a=e[n],r=a.entity,o=a.data;if(o.enabled&&r.enabled){const e=r.particlesystem.emitter;if(!e.meshInstance.visible)continue;if(e.lighting){const t=o.layers;let s;for(let i=0;i<t.length;i++){const n=this.app.scene.layers.getLayerById(t[i]);if(!n)continue;n._lightCube||(n._lightCube=new Float32Array(18)),s=n._lightCube;for(let t=0;t<6;t++)s[3*t]=this.app.scene.ambientLight.r,s[3*t+1]=this.app.scene.ambientLight.g,s[3*t+2]=this.app.scene.ambientLight.b;const a=n._splitLights[0];for(let t=0;t<a.length;t++)for(let i=0;i<6;i++){const n=Math.max(e.lightCubeDir[i].dot(a[t]._direction),0)*a[t]._intensity;s[3*i]+=a[t]._color.r*n,s[3*i+1]+=a[t]._color.g*n,s[3*i+2]+=a[t]._color.b*n}}e.constantLightCube.setValue(s)}if(!o.paused){if(e.simTime+=t,e.simTime>e.fixedTimeStep&&(s=Math.floor(e.simTime/e.fixedTimeStep),e.simTime-=s*e.fixedTimeStep),s){s=Math.min(s,e.maxSubSteps);for(let t=0;t<s;t++)e.addTime(e.fixedTimeStep,!1);i._updatesPerFrame+=s,i._frameTime+=e._addTimeTime,e._addTimeTime=0}e.finishFrame()}}}}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(zM.prototype,VM);class WM extends Lp{constructor(t,e){super(t,e),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=[],this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._rootBone=new JS(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new Yg("asset",this,t.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,Ec._prepareRenderStyleForArray(this._meshInstances,t))}get renderStyle(){return this._renderStyle}set customAabb(t){this._customAabb=t;const e=this._meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),"asset"!==t)){let e=this._material;e&&e!==this.system.defaultMaterial||(e=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=fc(this.system.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new Ec(s.mesh,e||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const t=this._meshInstances;for(let e=0;e<t.length;e++)t[e].node||(t[e].node=this.entity),t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].renderStyle=this._renderStyle,t[e].setLightmapped(this._lightmapped),t[e].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows!==t){const e=this._meshInstances;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=i.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e)}for(let s=0;s<e.length;s++)e[s].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e)}}this._castShadows=t}}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(t){if(this._isStatic!==t){this._isStatic=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].isStatic=t}}get isStatic(){return this._isStatic}set layers(t){const e=this.system.app.scene.layers;let s;if(this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(t){if(this._batchGroupId!==t){var e,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(e=this.system.app.batcher)||e.remove(yc.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&t>=0)null==(s=this.system.app.batcher)||s.insert(yc.RENDER,t,this.entity);t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=t}}get batchGroupId(){return this._batchGroupId}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&"asset"!==this._type))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get material(){return this._material}set materialAssets(t=[]){if(this._materialReferences.length>t.length){for(let e=t.length;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(let e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new Yg(e,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){const s=t[e]instanceof vp?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((function(t){return t.id}))}set asset(t){const e=t instanceof vp?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(t){const e=t instanceof vp?t.id:t;this._assetReference.id=e}_onSetRootBone(t){t&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(let e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}addToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){const t=this.system.app,e=t.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].asset&&this.system.app.assets.load(this._materialReferences[t].asset);var i;this._batchGroupId>=0&&(null==(i=t.batcher)||i.insert(yc.RENDER,this.batchGroupId,this.entity))}onDisable(){const t=this.system.app,e=t.scene;var s;(e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(s=t.batcher)||s.remove(yc.RENDER,this.batchGroupId,this.entity));this.removeFromLayers()}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;t.off("set:meshes",this._onSetMeshes,this),t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(t){this._cloneMeshes(t)}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];j_.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof qo)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!s.skinInstance&&(e.skinInstance=j_.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(t){if(t&&t.length){const e=[];for(let s=0;s<t.length;s++){const i=t[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new Ec(i,n||this.system.defaultMaterial,this.entity);e.push(a),i.morph&&(a.morphInstance=new Iu(i.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(t,e){0===t&&(this.material=e)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource),this._updateMainMaterial(t,s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone]&&(this.rootBone=e[t.rootBone]),this._clearSkinInstances()}}class GM{constructor(){this.enabled=!0,this.rootBone=null}}const HM=[{name:"rootBone",type:"entity"},"enabled"],XM=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class qM extends PS{constructor(t){super(t),this.id="render",this.ComponentType=WM,this.DataType=GM,this.schema=HM,this.defaultMaterial=Dh(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let s=0;s<XM.length;s++)e.hasOwnProperty(XM[s])&&(t[XM[s]]=e[XM[s]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new bt(new at(e.aabbCenter),new at(e.aabbHalfExtents))),super.initializeComponentData(t,e,HM)}cloneComponent(t,e){const s={};for(let e=0;e<XM.length;e++)s[XM[e]]=t.render[XM[e]];s.enabled=t.render.enabled,delete s.meshInstances;const i=this.addComponent(e,s),n=t.render.meshInstances,a=n.map((t=>t.mesh));i._onSetMeshes(a);for(let t=0;t<n.length;t++)i.meshInstances[t].material=n[t].material;return t.render.customAabb&&(i.customAabb=t.render.customAabb.clone()),i}onRemove(t,e){e.onRemove()}}Lp._buildAccessors(WM.prototype,HM);class jM{constructor(t,e){this._constructor=t,this._pool=[],this._count=0,this._resize(e)}_resize(t){if(t>this._pool.length)for(let e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}}let YM,KM,$M,ZM,QM,JM,tC;class eC extends Lp{constructor(t,e){super(t,e),this._angularDamping=0,this._angularFactor=new at(1,1,1),this._angularVelocity=new at,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new at(1,1,1),this._linearVelocity=new at,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type="static"}static onLibraryLoaded(){"undefined"==typeof Ammo||YM||(YM=new Ammo.btTransform,KM=new Ammo.btVector3,$M=new Ammo.btVector3,ZM=new Ammo.btQuaternion,QM=new Ammo.btVector3(0,0,0))}set angularDamping(t){this._angularDamping!==t&&(this._angularDamping=t,this._body&&this._body.setDamping(this._linearDamping,t))}get angularDamping(){return this._angularDamping}set angularFactor(t){this._angularFactor.equals(t)||(this._angularFactor.copy(t),this._body&&"dynamic"===this._type&&(KM.setValue(t.x,t.y,t.z),this._body.setAngularFactor(KM)))}get angularFactor(){return this._angularFactor}set angularVelocity(t){this._body&&"dynamic"===this._type&&(this._body.activate(),KM.setValue(t.x,t.y,t.z),this._body.setAngularVelocity(KM),this._angularVelocity.copy(t))}get angularVelocity(){if(this._body&&"dynamic"===this._type){const t=this._body.getAngularVelocity();this._angularVelocity.set(t.x(),t.y(),t.z())}return this._angularVelocity}set body(t){this._body!==t&&(this._body=t,t&&this._simulationEnabled&&t.activate())}get body(){return this._body}set friction(t){this._friction!==t&&(this._friction=t,this._body&&this._body.setFriction(t))}get friction(){return this._friction}set group(t){this._group!==t&&(this._group=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(t){this._linearDamping!==t&&(this._linearDamping=t,this._body&&this._body.setDamping(t,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(t){this._linearFactor.equals(t)||(this._linearFactor.copy(t),this._body&&"dynamic"===this._type&&(KM.setValue(t.x,t.y,t.z),this._body.setLinearFactor(KM)))}get linearFactor(){return this._linearFactor}set linearVelocity(t){this._body&&"dynamic"===this._type&&(this._body.activate(),KM.setValue(t.x,t.y,t.z),this._body.setLinearVelocity(KM),this._linearVelocity.copy(t))}get linearVelocity(){if(this._body&&"dynamic"===this._type){const t=this._body.getLinearVelocity();this._linearVelocity.set(t.x(),t.y(),t.z())}return this._linearVelocity}set mask(t){this._mask!==t&&(this._mask=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(t){if(this._mass!==t&&(this._mass=t,this._body&&"dynamic"===this._type)){const e=this.enabled&&this.entity.enabled;e&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(t,KM),this._body.setMassProps(t,KM),this._body.updateInertiaTensor(),e&&this.enableSimulation()}}get mass(){return this._mass}set restitution(t){this._restitution!==t&&(this._restitution=t,this._body&&this._body.setRestitution(t))}get restitution(){return this._restitution}set rollingFriction(t){this._rollingFriction!==t&&(this._rollingFriction=t,this._body&&this._body.setRollingFriction(t))}get rollingFriction(){return this._rollingFriction}set type(t){if(this._type!==t){switch(this._type=t,this.disableSimulation(),t){case"dynamic":this._group=1,this._mask=65535;break;case"kinematic":this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533}this.createBody()}}get type(){return this._type}createBody(){const t=this.entity;let e;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&this.system.onRemove(t,this);const s="dynamic"===this._type?this._mass:0;this._getEntityTransform(YM);const i=this.system.createBody(s,e,YM);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),"dynamic"===this._type){const t=this._linearFactor;KM.setValue(t.x,t.y,t.z),i.setLinearFactor(KM);const e=this._angularFactor;KM.setValue(e.x,e.y,e.z),i.setAngularFactor(KM)}else"kinematic"===this._type&&(i.setCollisionFlags(2|i.getCollisionFlags()),i.setActivationState(4));i.entity=t,this.body=i,this.enabled&&t.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){const t=this.entity;if(t.collision&&t.collision.enabled&&!this._simulationEnabled){const e=this._body;if(e){switch(this.system.addBody(e,this._group,this._mask),this._type){case"dynamic":this.system._dynamic.push(this),e.forceActivationState(1),this.syncEntityToBody();break;case"kinematic":this.system._kinematic.push(this),e.forceActivationState(4);break;case"static":e.forceActivationState(1),this.syncEntityToBody()}"compound"===t.collision.type&&this.system._compounds.push(t.collision),e.activate(),this._simulationEnabled=!0}}}disableSimulation(){const t=this._body;if(t&&this._simulationEnabled){const e=this.system;let s=e._compounds.indexOf(this.entity.collision);s>-1&&e._compounds.splice(s,1),s=e._dynamic.indexOf(this),s>-1&&e._dynamic.splice(s,1),s=e._kinematic.indexOf(this),s>-1&&e._kinematic.splice(s,1),e.removeBody(t),t.forceActivationState(5),this._simulationEnabled=!1}}applyForce(){let t,e,s,i,n,a;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5]}const r=this._body;r&&(r.activate(),KM.setValue(t,e,s),void 0!==i?($M.setValue(i,n,a),r.applyForce(KM,$M)):r.applyForce(KM,QM))}applyTorque(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),KM.setValue(t,e,s),i.applyTorque(KM))}applyImpulse(){let t,e,s,i,n,a;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5];break;default:return}const r=this._body;r&&(r.activate(),KM.setValue(t,e,s),void 0!==i?($M.setValue(i,n,a),r.applyImpulse(KM,$M)):r.applyImpulse(KM,QM))}applyTorqueImpulse(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),KM.setValue(t,e,s),i.applyTorqueImpulse(KM))}isStatic(){return"static"===this._type}isStaticOrKinematic(){return"static"===this._type||"kinematic"===this._type}isKinematic(){return"kinematic"===this._type}_getEntityTransform(t){const e=this.entity,s=e.getPosition(),i=e.getRotation();KM.setValue(s.x,s.y,s.z),ZM.setValue(i.x,i.y,i.z,i.w),t.setOrigin(KM),t.setRotation(ZM)}syncEntityToBody(){const t=this._body;if(t){if(this._getEntityTransform(YM),t.setWorldTransform(YM),"kinematic"===this._type){const e=t.getMotionState();e&&e.setWorldTransform(YM)}t.activate()}}_updateDynamic(){const t=this._body;if(t.isActive()){const e=t.getMotionState();if(e){e.getWorldTransform(YM);const t=YM.getOrigin(),s=YM.getRotation();this.entity.setPosition(t.x(),t.y(),t.z()),this.entity.setRotation(s.x(),s.y(),s.z(),s.w())}}}_updateKinematic(){const t=this._body.getMotionState();t&&(this._getEntityTransform(YM),t.setWorldTransform(YM))}teleport(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof ft?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}class sC{constructor(){this.enabled=!0}}class iC{constructor(t,e,s){this.entity=t,this.point=e,this.normal=s}}class nC{constructor(t,e,s){0===arguments.length?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new at,this.localPointB=new at,this.pointA=new at,this.pointB=new at,this.normal=new at):(this.a=t,this.b=e,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class aC{constructor(t=new at,e=new at,s=new at,i=new at,n=new at,a=0){this.localPoint=t,this.localPointOther=e,this.point=s,this.pointOther=i,this.normal=n,this.impulse=a}}class rC{constructor(t,e){this.other=t,this.contacts=e}}const oC=["enabled"];class hC extends PS{constructor(t){super(t),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new at(0,-9.81,0),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=t.stats.frame,this.ComponentType=eC,this.DataType=sC,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=oC,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}JM=new Ammo.btVector3,tC=new Ammo.btVector3,eC.onLibraryLoaded(),this.contactPointPool=new jM(aC,1),this.contactResultPool=new jM(rC,1),this.singleContactResultPool=new jM(nC,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const s of i)if(e.hasOwnProperty(s)){const i=e[s];Array.isArray(i)?t[s]=new at(i[0],i[1],i[2]):t[s]=i}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&(e.enabled=!1)}onRemove(t,e){const s=e.body;s&&(this.removeBody(s),this.destroyBody(s),e.body=null)}addBody(t,e,s){void 0!==e&&void 0!==s?this.dynamicsWorld.addRigidBody(t,e,s):this.dynamicsWorld.addRigidBody(t)}removeBody(t){this.dynamicsWorld.removeRigidBody(t)}createBody(t,e,s){const i=new Ammo.btVector3(0,0,0);0!==t&&e.calculateLocalInertia(t,i);const n=new Ammo.btDefaultMotionState(s),a=new Ammo.btRigidBodyConstructionInfo(t,n,e,i),r=new Ammo.btRigidBody(a);return Ammo.destroy(a),Ammo.destroy(i),r}destroyBody(t){const e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)}raycastFirst(t,e){let s=null;JM.setValue(t.x,t.y,t.z),tC.setValue(e.x,e.y,e.z);const i=new Ammo.ClosestRayResultCallback(JM,tC);if(this.dynamicsWorld.rayTest(JM,tC,i),i.hasHit()){const t=i.get_m_collisionObject(),e=Ammo.castObject(t,Ammo.btRigidBody);if(e){const t=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld();if(s=new iC(e.entity,new at(t.x(),t.y(),t.z()),new at(n.x(),n.y(),n.z())),arguments.length>2){(0,arguments[2])(s)}}}return Ammo.destroy(i),s}raycastAll(t,e){const s=[];JM.setValue(t.x,t.y,t.z),tC.setValue(e.x,e.y,e.z);const i=new Ammo.AllHitsRayResultCallback(JM,tC);if(this.dynamicsWorld.rayTest(JM,tC,i),i.hasHit()){const t=i.get_m_collisionObjects(),e=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld(),a=t.size();for(let i=0;i<a;i++){const a=Ammo.castObject(t.at(i),Ammo.btRigidBody);if(a){const t=e.at(i),r=n.at(i),o=new iC(a.entity,new at(t.x(),t.y(),t.z()),new at(r.x(),r.y(),r.z()));s.push(o)}}}return Ammo.destroy(i),s}_storeCollision(t,e){let s=!1;const i=t.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:t},this.collisions[i].others.indexOf(e)<0&&(this.collisions[i].others.push(e),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:t},this.frameCollisions[i].others.push(e),s}_createContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),a=t.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPoint.set(e.x(),e.y(),e.z()),r.localPointOther.set(s.x(),s.y(),s.z()),r.point.set(i.x(),i.y(),i.z()),r.pointOther.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=t.getAppliedImpulse(),r}_createReverseContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),a=t.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPointOther.set(e.x(),e.y(),e.z()),r.localPoint.set(s.x(),s.y(),s.z()),r.pointOther.set(i.x(),i.y(),i.z()),r.point.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=t.getAppliedImpulse(),r}_createSingleContactResult(t,e,s){const i=this.singleContactResultPool.allocate();return i.a=t,i.b=e,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(t,e){const s=this.contactResultPool.allocate();return s.other=t,s.contacts=e,s}_cleanOldCollisions(){for(const t in this.collisions)if(this.collisions.hasOwnProperty(t)){const e=this.frameCollisions[t],s=this.collisions[t],i=s.entity,n=i.collision,a=i.rigidbody,r=s.others;let o=r.length;for(;o--;){const t=r[o];(!e||e.others.indexOf(t)<0)&&(r.splice(o,1),i.trigger?(n&&n.fire("triggerleave",t),t.rigidbody&&t.rigidbody.fire("triggerleave",i)):t.trigger||(a&&a.fire("collisionend",t),n&&n.fire("collisionend",t)))}0===r.length&&delete this.collisions[t]}}_hasContactEvent(t){const e=t.collision;if(e&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))return!0;const s=t.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(t,e){const s=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher(),i=s.getNumManifolds();this.frameCollisions={};for(let t=0;t<i;t++){const e=s.getManifoldByIndexInternal(t),i=e.getBody0(),n=e.getBody1(),a=Ammo.castObject(i,Ammo.btRigidBody),r=Ammo.castObject(n,Ammo.btRigidBody),o=a.entity,h=r.entity;if(!o||!h)continue;const l=a.getCollisionFlags(),c=r.getCollisionFlags(),d=e.getNumContacts(),u=[],p=[];let m;if(d>0)if(4&l||4&c){const t=o.collision&&(o.collision.hasEvent("triggerenter")||o.collision.hasEvent("triggerleave")),e=h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave")),s=o.rigidbody&&(o.rigidbody.hasEvent("triggerenter")||o.rigidbody.hasEvent("triggerleave")),i=h.rigidbody&&(h.rigidbody.hasEvent("triggerenter")||h.rigidbody.hasEvent("triggerleave"));t&&(m=this._storeCollision(o,h),!m||4&c||o.collision.fire("triggerenter",h)),e&&(m=this._storeCollision(h,o),!m||4&l||h.collision.fire("triggerenter",o)),s&&(m||(m=this._storeCollision(h,o)),m&&o.rigidbody.fire("triggerenter",h)),i&&(m||(m=this._storeCollision(o,h)),m&&h.rigidbody.fire("triggerenter",o))}else{const t=this._hasContactEvent(o),s=this._hasContactEvent(h),i=this.hasEvent("contact");if(i||t||s){for(let n=0;n<d;n++){const a=e.getContactPoint(n),r=this._createContactPointFromAmmo(a);if(t||s){u.push(r);const t=this._createReverseContactPointFromAmmo(a);p.push(t)}if(i){const t=this._createSingleContactResult(o,h,r);this.fire("contact",t)}}if(t){const t=this._createContactResult(h,u);m=this._storeCollision(o,h),o.collision&&(o.collision.fire("contact",t),m&&o.collision.fire("collisionstart",t)),o.rigidbody&&(o.rigidbody.fire("contact",t),m&&o.rigidbody.fire("collisionstart",t))}if(s){const t=this._createContactResult(o,p);m=this._storeCollision(h,o),h.collision&&(h.collision.fire("contact",t),m&&h.collision.fire("collisionstart",t)),h.rigidbody&&(h.rigidbody.fire("contact",t),m&&h.rigidbody.fire("collisionstart",t))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(t){let e,s;const i=this.dynamicsWorld.getGravity();i.x()===this.gravity.x&&i.y()===this.gravity.y&&i.z()===this.gravity.z||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(e=0,s=n.length;e<s;e++)n[e].updateTransform();const a=this._compounds;for(e=0,s=a.length;e<s;e++)a[e]._updateCompound();const r=this._kinematic;for(e=0,s=r.length;e<s;e++)r[e]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);const o=this._dynamic;for(e=0,s=o.length;e<s;e++)o[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}Lp._buildAccessors(eC.prototype,oC);const lC="none",cC="blend",dC=new mt;class uC extends Lp{constructor(t,e){super(t,e),this._resolution=new ot(640,320),this._referenceResolution=new ot(640,320),this._scaleMode="none",this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new mt,this._elements=new Set,t.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(t,e){if(!(t instanceof tm))return e;if(t.element){const i=t.element.drawOrder;var s;if(t.element.drawOrder=e++,t.element._batchGroupId>=0&&i!==t.element.drawOrder)null==(s=this.system.app.batcher)||s.markGroupDirty(t.element._batchGroupId)}t.particlesystem&&(t.particlesystem.drawOrder=e++);const i=t.children;for(let t=0;t<i.length;t++)e=this._recurseDrawOrderSync(i[t],e);return e}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const t=this._resolution.x/this.scale,e=this._resolution.y/this.scale,s=t,i=-e;this._screenMatrix.setOrtho(0,s,i,0,1,-1),this._screenSpace||(dC.setScale(.5*t,.5*e,1),this._screenMatrix.mul2(dC,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(t,e){const s=Math.log2(t.x/e.x),i=Math.log2(t.y/e.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(t,e){this._screenSpace&&(this._resolution.set(t,e),this.resolution=this._resolution)}_bindElement(t){this._elements.add(t)}_unbindElement(t){this._elements.delete(t)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach((t=>t._onScreenRemove())),this._elements.clear(),this.off()}set resolution(t){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get resolution(){return this._resolution}set referenceResolution(t){this._referenceResolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get referenceResolution(){return"none"===this._scaleMode?this._resolution:this._referenceResolution}set screenSpace(t){this._screenSpace=t,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach((t=>t._onScreenSpaceChange()))}get screenSpace(){return this._screenSpace}set scaleMode(t){"none"!==t&&"blend"!==t&&(t="none"),this._screenSpace||"none"===t||(t="none"),this._scaleMode=t,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(t){this._scaleBlend=t,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get scaleBlend(){return this._scaleBlend}set priority(t){t>255&&(t=255),this._priority=t}get priority(){return this._priority}}class pC{constructor(){this.enabled=!0}}const mC=["enabled"];class fC extends PS{constructor(t){super(t),this.id="screen",this.ComponentType=uC,this.DataType=pC,this.schema=mC,this.windowResolution=new ot,this._drawOrderSyncQueue=new k,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(t,e,s){void 0!==e.priority&&(t.priority=e.priority),void 0!==e.screenSpace&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,void 0!==e.scaleMode&&(t.scaleMode=e.scaleMode),void 0!==e.scaleBlend&&(t.scaleBlend=e.scaleBlend),void 0!==e.resolution&&(e.resolution instanceof ot?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),void 0!==e.referenceResolution&&(e.referenceResolution instanceof ot?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),super.initializeComponentData(t,e,s)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(t){const e=this.store;for(const s in e)e[s].entity.screen.update&&e[s].entity.screen.update(t)}_onResize(t,e){this.windowResolution.x=t,this.windowResolution.y=e}cloneComponent(t,e){const s=t.screen;return this.addComponent(e,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(t,e){e.onRemove()}processDrawOrderSyncQueue(){const t=this._drawOrderSyncQueue.list();for(let e=0;e<t.length;e++){const s=t[e];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(t,e,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:s})}}Lp._buildAccessors(uC.prototype,mC);class _C extends Lp{constructor(t,e){super(t,e),this.on("set_scripts",this.onSetScripts,this)}send(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[t]&&(n=i[t].instance[e],n))return n.apply(i[t].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(t,e,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(e,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const t=s.map((function(t){return t.url}));if(this._loadFromCache(t))return;this._loadScripts(t)}}_updateScriptAttributes(t,e){let s=!0;if(t.length!==e.length)s=!1;else for(let i=0,n=e.length;i<n;i++)if(t[i].url!==e[i].url){s=!1;break}if(s)for(const t in this.instances)this.instances.hasOwnProperty(t)&&this.system._updateAccessors(this.entity,this.instances[t]);return s}_loadFromCache(t){const e=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,a=t.length;n<a;n++){let a=t[n];i.test(a)||(a=v.join(s,a));const r=this.system.app.loader.getFromCache(a,"script");if(!r)return!1;e.push(r)}for(let s=0,i=e.length;s<i;s++){const i=e[s];if(!0!==i&&(i&&this.entity.script&&!this.entity.script.instances[i._pcScriptName])){const e=new i(this.entity);this.system._preRegisterInstance(this.entity,t[s],i._pcScriptName,e)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(t){let e=t.length;const s=this.system.app._scriptPrefix||"";t.forEach((t=>{let i=null,n=null;t.toLowerCase().startsWith("http://")||t.toLowerCase().startsWith("https://")?(n=t,i=t):(n=t,i=v.join(s,t)),this.system.app.loader.load(i,"script",((t,s)=>{if(e--,t)console.error(t);else if(s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName]){const t=new s(this.entity);this.system._preRegisterInstance(this.entity,n,s._pcScriptName,t)}0===e&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}))}))}}class gC{constructor(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1}}const yC=["enabled","scripts","instances","runInTools"];class vC extends PS{constructor(t){super(t),this.id="script",this.ComponentType=_C,this.DataType=gC,this.schema=yC,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("postInitialize",this.onPostInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.app.systems.on("fixedUpdate",this.onFixedUpdate,this),this.app.systems.on("postUpdate",this.onPostUpdate,this),this.app.systems.on("toolsUpdate",this.onToolsUpdate,this)}initializeComponentData(t,e,s){s=["runInTools","enabled","scripts"],e.scripts&&e.scripts.length&&e.scripts.forEach((function(t){if(t.attributes&&Array.isArray(t.attributes)){const e={};for(let s=0;s<t.attributes.length;s++)e[t.attributes[s].name]=t.attributes[s];t.attributes=e}})),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=this.store[t.getGuid()],i={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled},n=s.data.scripts;for(let t=0,e=n.length;t<e;t++){const e=n[t].attributes;e&&delete n[t].attributes,i.scripts.push(m({},n[t])),e&&(i.scripts[t].attributes=this._cloneAttributes(e),n[t].attributes=e)}return this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&this._disableScriptComponent(e),this._destroyScriptComponent(e)}onInitialize(t){if(this._registerInstances(t),t.enabled){t.script&&t.script.enabled&&this._initializeScriptComponent(t.script);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof tm&&this.onInitialize(e[t])}}onPostInitialize(t){if(t.enabled){t.script&&t.script.enabled&&this._postInitializeScriptComponent(t.script);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof tm&&this.onPostInitialize(e[t])}}_callInstancesMethod(t,e){const s=t.data.instances;for(const t in s)if(s.hasOwnProperty(t)){const i=s[t].instance;i[e]&&i[e]()}}_initializeScriptComponent(t){this._callInstancesMethod(t,"initialize"),t.data.initialized=!0,t.enabled&&t.entity.enabled&&this._enableScriptComponent(t)}_enableScriptComponent(t){this._callInstancesMethod(t,"onEnable")}_disableScriptComponent(t){this._callInstancesMethod(t,"onDisable")}_destroyScriptComponent(t){const e=t.data.instances;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].instance;if(i.destroy&&i.destroy(),i.update){const t=this.instancesWithUpdate.indexOf(i);t>=0&&this.instancesWithUpdate.splice(t,1)}if(i.fixedUpdate){const t=this.instancesWithFixedUpdate.indexOf(i);t>=0&&this.instancesWithFixedUpdate.splice(t,1)}if(i.postUpdate){const t=this.instancesWithPostUpdate.indexOf(i);t>=0&&this.instancesWithPostUpdate.splice(t,1)}if(i.toolsUpdate){const t=this.instancesWithToolsUpdate.indexOf(i);t>=0&&this.instancesWithToolsUpdate.splice(t,1)}t.instances[s].instance===t[s]&&delete t[s],delete t.instances[s]}}_postInitializeScriptComponent(t){this._callInstancesMethod(t,"postInitialize"),t.data.postInitialized=!0}_updateInstances(t,e,s){for(let i=0,n=e.length;i<n;i++){const n=e[i];n&&n.entity&&n.entity.enabled&&n.entity.script.enabled&&n[t](s)}}onUpdate(t){this._updateInstances("update",this.instancesWithUpdate,t)}onFixedUpdate(t){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,t)}onPostUpdate(t){this._updateInstances("postUpdate",this.instancesWithPostUpdate,t)}onToolsUpdate(t){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,t)}broadcast(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.store;for(const n in i)if(i.hasOwnProperty(n)){const a=i[n].data;if(a.instances[t]){const i=a.instances[t].instance[e];i&&i.apply(a.instances[t].instance,s)}}}_preRegisterInstance(t,e,s,i){if(t.script){if(t.script.data._instances=t.script.data._instances||{},t.script.data._instances[s])throw Error(`Script name collision '${s}'. Scripts from '${e}' and '${t.script.data._instances[s].url}' {${t.getGuid()}}`);t.script.data._instances[s]={url:e,name:s,instance:i}}}_registerInstances(t){if(t.script&&t.script.data._instances){t.script.instances=t.script.data._instances;for(const e in t.script.instances){const s=t.script.instances[e],i=s.instance;if(g.attach(i),i.update&&this.instancesWithUpdate.push(i),i.fixedUpdate&&this.instancesWithFixedUpdate.push(i),i.postUpdate&&this.instancesWithPostUpdate.push(i),i.toolsUpdate&&this.instancesWithToolsUpdate.push(i),t.script.scripts&&this._createAccessors(t,s),t.script[e])throw Error(`Script with name '${e}' is already attached to Script Component`);t.script[e]=i}delete t.script.data._instances}const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof tm&&this._registerInstances(e[t])}_cloneAttributes(t){const e={};for(const s in t)if(t.hasOwnProperty(s))if("entity"!==t[s].type)e[s]=m({},t[s]);else{const i=t[s].value;delete t[s].value,e[s]=m({},t[s]),e[s].value=i,t[s].value=i}return e}_createAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const s=t.script.scripts[n];if(s.url===i){const i=s.attributes;if(s.name&&i){for(const t in i)i.hasOwnProperty(t)&&this._createAccessor(i[t],e);t.script.data.attributes[s.name]=this._cloneAttributes(i)}break}}}_createAccessor(t,e){const s=this;t={name:t.name,value:t.value,type:t.type},this._convertAttributeValue(t),Object.defineProperty(e.instance,t.name,{get:function(){return t.value},set:function(i){const n=t.value;t.value=i,s._convertAttributeValue(t),e.instance.fire("set",t.name,n,t.value)},configurable:!0})}_updateAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const s=t.script,a=s.scripts[n];if(a.url===i){const t=a.name,i=a.attributes;if(t){if(i)for(const t in i)i.hasOwnProperty(t)&&this._createAccessor(i[t],e);const n=s.data.attributes[t];if(n)for(const t in n){const s=n[t];t in i?i[t].value!==s.value&&e.instance.onAttributeChanged&&e.instance.onAttributeChanged(s.name,s.value,i[t].value):delete e.instance[s.name]}i?s.data.attributes[t]=this._cloneAttributes(i):delete s.data.attributes[t]}break}}}_convertAttributeValue(t){if("rgb"===t.type||"rgba"===t.type)Array.isArray(t.value)&&(t.value=3===t.value.length?new et(t.value[0],t.value[1],t.value[2]):new et(t.value[0],t.value[1],t.value[2],t.value[3]));else if("vec2"===t.type)Array.isArray(t.value)&&(t.value=new ot(t.value[0],t.value[1]));else if("vec3"===t.type||"vector"===t.type)Array.isArray(t.value)&&(t.value=new at(t.value[0],t.value[1],t.value[2]));else if("vec4"===t.type)Array.isArray(t.value)&&(t.value=new ht(t.value[0],t.value[1],t.value[2],t.value[3]));else if("entity"===t.type)null!==t.value&&"string"==typeof t.value&&(t.value=this.app.root.findByGuid(t.value));else if("curve"===t.type||"colorcurve"===t.type){const e=t.value.keys[0]instanceof Array?nt:it;t.value=new e(t.value.keys),t.value.type=t.value.type}}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("postInitialize",this.onPostInitialize,this),this.app.systems.off("update",this.onUpdate,this),this.app.systems.off("fixedUpdate",this.onFixedUpdate,this),this.app.systems.off("postUpdate",this.onPostUpdate,this),this.app.systems.off("toolsUpdate",this.onToolsUpdate,this)}}Lp._buildAccessors(_C.prototype,yC);const xC=new ot,bC=new at,SC=new at,wC=new at,TC=new at,MC=new at,CC=new ft,AC={x:"y",y:"x"};class PC extends _{constructor(t,e){if(super(),!(t&&t instanceof XT))throw new Error("Element was null or not an ElementComponent");if(e&&"x"!==e&&"y"!==e)throw new Error("Unrecognized axis: "+e);this._element=t,this._app=t.system.app,this._axis=e||null,this._enabled=!0,this._dragScale=new at,this._dragStartMousePosition=new at,this._dragStartHandlePosition=new at,this._deltaMousePosition=new at,this._deltaHandlePosition=new at,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this._element[t]("mousedown",this._onMouseDownOrTouchStart,this),this._element[t]("touchstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(t){const e="on"===t,s=e?"addEventListener":"removeEventListener";this._hasDragListeners&&e||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[t]("mousemove",this._onMove,this),window[s]("mouseup",this._handleMouseUpOrTouchEnd,!1)),L.touch&&(this._app.touch[t]("touchmove",this._onMove,this),window[s]("touchend",this._handleMouseUpOrTouchEnd,!1),window[s]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=e)}_onMouseDownOrTouchStart(t){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=t.camera,this._calculateDragScale();const e=this._screenToLocal(t);e&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(e),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(t){this._determineInputPosition(t),this._chooseRayOriginAndDirection(),TC.copy(this._element.entity.getPosition()),MC.copy(this._element.entity.forward).mulScalar(-1);const e=MC.dot(wC);if(Math.abs(e)>0){const t=TC.sub(SC).dot(MC)/e,s=SC.add(wC.mulScalar(t));return CC.copy(this._element.entity.getRotation()).invert().transformVector(s,s),s.mul(this._dragScale),s}return null}_determineInputPosition(t){const e=this._app.graphicsDevice.maxPixelRatio;void 0!==t.x&&void 0!==t.y?(xC.x=t.x*e,xC.y=t.y*e):t.changedTouches?(xC.x=t.changedTouches[0].x*e,xC.y=t.changedTouches[0].y*e):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(SC.set(xC.x,-xC.y,0),wC.set(0,0,-1)):(bC.copy(this._dragCamera.screenToWorld(xC.x,xC.y,1)),SC.copy(this._dragCamera.entity.getPosition()),wC.copy(bC).sub(SC).normalize())}_calculateDragScale(){let t=this._element.entity.parent;const e=this._element.screen&&this._element.screen.screen,s=e&&e.screenSpace,i=s?e.scale:1,n=this._dragScale;for(n.set(i,i,i);t&&(n.mul(t.getLocalScale()),t=t.parent,!s||!t.screen););n.x=1/n.x,n.y=1/n.y,n.z=1/n.z}_onMove(t){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){const e=this._screenToLocal(t);if(this._dragStartMousePosition&&e){if(this._deltaMousePosition.copy(e).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){const t=this._element.entity.getLocalPosition(),e=AC[this._axis];this._deltaHandlePosition[e]=t[e]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(t){this._enabled=t}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}const EC=0,RC=1,LC=2,IC=0,DC=1,OC=new ot;class FC extends Lp{constructor(t,e){super(t,e),this._viewportReference=new JS(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new JS(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[0]=new JS(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[1]=new JS(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new ot,this._velocity=new at,this._dragStartPosition=new at,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",t),this._toggleElementListeners("on")}_toggleLifecycleListeners(t,e){this[t]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[t]("set_vertical",this._onSetVerticalScrollingEnabled,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(t){if(this.entity.element){if("on"===t&&this._hasElementListeners)return;this.entity.element[t]("resize",this._onSetContentOrViewportSize,this),this.entity.element[t]("mousewheel",this._onMouseWheel,this),this._hasElementListeners="on"===t}}_onElementComponentAdd(t){this.entity===t&&this._toggleElementListeners("on")}_onElementComponentRemove(t){this.entity===t&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new PC(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(t){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(t),this._setVelocityFromContentPositionDelta(t),!this._disabledContentInput)){const e=t.x-this._dragStartPosition.x,s=t.y-this._dragStartPosition.y;(Math.abs(e)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(t){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(t,null)}_onSetVerticalScrollbarValue(t){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,t)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(0)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(1)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)}_onSetScroll(t,e,s){!1!==s&&this._velocity.set(0,0,0);const i=this._updateAxis(t,"x",0),n=this._updateAxis(e,"y",1);(i||n)&&this.fire("set:scroll",this._scroll)}_updateAxis(t,e,s){const i=null!==t&&Math.abs(t-this._scroll[e])>1e-5;return(i||this._isDragging()||0===t)&&(this._scroll[e]=this._determineNewScrollValue(t,e,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(t,e,s){if(!this._getScrollingEnabled(s))return this._scroll[e];switch(this.scrollMode){case 0:return q.clamp(t,0,this._getMaxScrollValue(s));case 1:return this._setVelocityFromOvershoot(t,e,s),t;case 2:return t;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),t}}_syncAll(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)}_syncContentPosition(t){const e=this._getAxis(t),s=this._getSign(t),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[t],a=this._getContentSize(t);if(null!==n&&Math.abs(n-a)>1e-4){const s=this._getMaxOffset(t,n),i=this._getMaxOffset(t,a);this._scroll[e]=0===i?1:q.clamp(this._scroll[e]*s/i,0,1)}const r=this._scroll[e]*this._getMaxOffset(t),o=i.getLocalPosition();o[e]=r*s,i.setLocalPosition(o),this._prevContentSizes[t]=a}}_syncScrollbarPosition(t){const e=this._getAxis(t),s=this._scrollbarReferences[t].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[t]=!0,s.scrollbar.value=this._scroll[e],s.scrollbar.handleSize=this._getScrollbarHandleSize(e,t),this._scrollbarUpdateFlags[t]=!1)}_syncScrollbarEnabledState(t){const e=this._scrollbarReferences[t].entity;if(e){const s=this._getScrollingEnabled(t),i=this._getScrollbarVisibility(t);switch(i){case 0:return void(e.enabled=s);case 1:return void(e.enabled=s&&this._contentIsLargerThanViewport(t));default:console.warn("Unhandled scrollbar visibility:"+i),e.enabled=s}}}_contentIsLargerThanViewport(t){return this._getContentSize(t)>this._getViewportSize(t)}_contentPositionToScrollValue(t){const e=this._getMaxOffset(0),s=this._getMaxOffset(1);return OC.x=0===e?0:t.x/e,OC.y=0===s?0:t.y/-s,OC}_getMaxOffset(t,e){e=void 0===e?this._getContentSize(t):e;const s=this._getViewportSize(t);return e<s?-this._getViewportSize(t):s-e}_getMaxScrollValue(t){return this._contentIsLargerThanViewport(t)?1:0}_getScrollbarHandleSize(t,e){const s=this._getViewportSize(e),i=this._getContentSize(e);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),a=this._toOvershoot(this._scroll[t],e);return 0===a?n:n/(1+Math.abs(a))}_getViewportSize(t){return this._getSize(t,this._viewportReference)}_getContentSize(t){return this._getSize(t,this._contentReference)}_getSize(t,e){return e.entity&&e.entity.element?e.entity.element[this._getCalculatedDimension(t)]:0}_getScrollingEnabled(t){return 0===t?this.horizontal:1===t?this.vertical:void 0}_getScrollbarVisibility(t){return 0===t?this.horizontalScrollbarVisibility:1===t?this.verticalScrollbarVisibility:void 0}_getSign(t){return 0===t?1:-1}_getAxis(t){return 0===t?"x":"y"}_getCalculatedDimension(t){return 0===t?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))}_updateVelocity(){if(!this._isDragging()){if(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const t=this._contentReference.entity.getLocalPosition();t.x+=this._velocity.x,t.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(t),this._setScrollFromContentPosition(t)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(t,e){return Math.abs(this._toOvershoot(this.scroll[t],e))>.001}_toOvershoot(t,e){const s=this._getMaxScrollValue(e);return t<0?t:t>s?t-s:0}_setVelocityFromOvershoot(t,e,s){const i=this._toOvershoot(t,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(i)>0&&(this._velocity[e]=-i/(50*this.bounceAmount+1))}_setVelocityFromContentPositionDelta(t){this._prevContentDragPosition?(this._velocity.sub2(t,this._prevContentDragPosition),this._prevContentDragPosition.copy(t)):(this._velocity.set(0,0,0),this._prevContentDragPosition=t.clone())}_setScrollFromContentPosition(t){let e=this._contentPositionToScrollValue(t);this._isDragging()&&(e=this._applyScrollValueTension(e)),this._onSetScroll(e.x,e.y,!1)}_applyScrollValueTension(t){let e=this._getMaxScrollValue(0),s=this._toOvershoot(t.x,0);return s>0?t.x=e+1*Math.log10(1+s):s<0&&(t.x=-1*Math.log10(1-s)),e=this._getMaxScrollValue(1),s=this._toOvershoot(t.y,1),s>0?t.y=e+1*Math.log10(1+s):s<0&&(t.y=-1*Math.log10(1-s)),t}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(t){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=t),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=t)}_setContentDraggingEnabled(t){this._contentDragHelper&&(this._contentDragHelper.enabled=t)}_onMouseWheel(t){if(this.useMouseWheel){const e=t.event,s=e.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=e.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=q.clamp(this._scroll.x+s,0,this._getMaxScrollValue(0)),a=q.clamp(this._scroll.y+i,0,this._getMaxScrollValue(1));this.scroll=new ot(n,a)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const t=this._disabledContentInputEntities.pop();t.element&&(t.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const t=e=>{e.element&&e.element.useInput&&(this._disabledContentInputEntities.push(e),e.element.useInput=!1);const s=e.children;for(let e=0,i=s.length;e<i;e++)t(s[e])},e=this._contentReference.entity;if(e){const s=e.children;for(let e=0,i=s.length;e<i;e++)t(s[e])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(t){this._onSetScroll(t.x,t.y)}get scroll(){return this._scroll}}class kC{constructor(){this.enabled=!0}}const BC=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}];class zC extends PS{constructor(t){super(t),this.id="scrollview",this.ComponentType=FC,this.DataType=kC,this.schema=BC,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){void 0===e.dragThreshold&&(e.dragThreshold=10),void 0===e.useMouseWheel&&(e.useMouseWheel=!0),void 0===e.mouseWheelSensitivity&&(e.mouseWheelSensitivity=new ot(1,1)),super.initializeComponentData(t,e,BC)}onUpdate(t){const e=this.store;for(const t in e){const s=e[t].entity,i=s.scrollview;i.enabled&&s.enabled&&i.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(FC.prototype,BC);class UC extends Lp{constructor(t,e){super(t,e),this._handleReference=new JS(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this[t]("set_value",this._onSetValue,this),this[t]("set_handleSize",this._onSetHandleSize,this),this[t]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new PC(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(t){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(t[this._getAxis()]))}_onSetValue(t,e,s){Math.abs(s-e)>1e-5&&(this.data.value=q.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(t,e,s){Math.abs(s-e)>1e-5&&(this.data.handleSize=q.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(t,e,s){s!==e&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const t=this._handleReference.entity,e=t&&t.element;if(t){const e=t.getLocalPosition();e[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(e)}e&&(e[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(t){return t*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(t){return t*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return 0===this.orientation?1:-1}_getAxis(){return 0===this.orientation?"x":"y"}_getDimension(){return 0===this.orientation?"width":"height"}_getOppositeDimension(){return 0===this.orientation?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(t){this._handleDragHelper&&(this._handleDragHelper.enabled=t)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}class VC{constructor(){this.enabled=!0}}const NC=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];class WC extends PS{constructor(t){super(t),this.id="scrollbar",this.ComponentType=UC,this.DataType=VC,this.schema=NC,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,NC)}_onRemoveComponent(t,e){e.onRemove()}}Lp._buildAccessors(UC.prototype,NC);const GC={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new at,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class HC extends _{constructor(t,e="Untitled",s={}){super(),this.name=void 0,this.instances=[],this._component=t,this._assets=t.system.app.assets,this._manager=t.system.manager,this.name=e,this._volume=void 0!==s.volume?q.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof vp&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{const e=function(e){const s=t._playWhenLoaded;t.sound=e,s&&t.play()};this.off("load",e),this.once("load",e),this.load()}return t}pause(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].pause()&&(t=!0);return t}resume(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].resume()&&(t=!0);return t}stop(){let t=!1;const e=this.instances;let s=e.length;for(;s--;)e[s].stop(),t=!0;return e.length=0,t}load(){if(!this._hasAsset())return;const t=this._assets.get(this._asset);return t?(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),t.resource?void this.fire("load",t.resource):(t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),void this._assets.load(t))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this))}setExternalNodes(t,e){if(t){if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(t,e)}}else console.error("The firstNode must have a valid AudioNode")}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){let t=null;const e=this._component;let s=null;if(this._hasAsset()){const t=this._assets.get(this._asset);t&&(s=t.resource)}const i=GC;return i.volume=this._volume*e.volume,i.pitch=this._pitch*e.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,e.positional?(i.position.copy(e.entity.getPosition()),i.maxDistance=e.maxDistance,i.refDistance=e.refDistance,i.rollOffFactor=e.rollOffFactor,i.distanceModel=e.distanceModel,t=new L_(this._manager,s,i)):t=new R_(this._manager,s,i),this._firstNode&&t.setExternalNodes(this._firstNode,this._lastNode),t}_onInstancePlay(t){this.fire("play",t),this._component.fire("play",this,t)}_onInstancePause(t){this.fire("pause",t),this._component.fire("pause",this,t)}_onInstanceResume(t){this.fire("resume",t),this._component.fire("resume",this,t)}_onInstanceStop(t){const e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("stop",t),this._component.fire("stop",this,t)}_onInstanceEnd(t){const e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)}_onAssetAdd(t){this.load()}_onAssetLoad(t){this.load()}_onAssetRemoved(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()}updatePosition(t){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].position=t}set asset(t){const e=this._asset;if(e){this._assets.off("add:"+e,this._onAssetAdd,this);const t=this._assets.get(e);t&&t.off("remove",this._onAssetRemoved,this)}this._asset=t,this._asset instanceof vp&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(t){this._autoPlay=!!t}get autoPlay(){return this._autoPlay}set duration(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].duration=this._duration}}get duration(){let t=0;if(this._hasAsset()){const e=this._assets.get(this._asset);t=null!=e&&e.resource?e.resource.duration:0}return null!=this._duration?this._duration%(t||1):t}get isLoaded(){if(this._hasAsset()){const t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}get isPaused(){const t=this.instances,e=t.length;if(0===e)return!1;for(let s=0;s<e;s++)if(!t[s].isPaused)return!1;return!0}get isPlaying(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(t[e].isPlaying)return!0;return!1}get isStopped(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(!t[e].isStopped)return!1;return!0}set loop(t){this._loop=!!t;const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].loop=this._loop}get loop(){return this._loop}set overlap(t){this._overlap=!!t}get overlap(){return this._overlap}set pitch(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].startTime=this._startTime}}get startTime(){return this._startTime}set volume(t){if(this._volume=q.clamp(Number(t)||0,0,1),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].volume=this._volume*this._component.volume}}get volume(){return this._volume}}class XC extends Lp{constructor(t,e){super(t,e),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel="linear",this._slots={},this._playingBeforeDisable={}}_updateSoundInstances(t,e,s){const i=this._slots;for(const n in i){const a=i[n];if(!a.overlap){const i=a.instances;for(let n=0,r=i.length;n<r;n++)i[n][t]=s?a[t]*e:e}}}set distanceModel(t){this._distanceModel=t,this._updateSoundInstances("distanceModel",t,!1)}get distanceModel(){return this._distanceModel}set maxDistance(t){this._maxDistance=t,this._updateSoundInstances("maxDistance",t,!1)}get maxDistance(){return this._maxDistance}set refDistance(t){this._refDistance=t,this._updateSoundInstances("refDistance",t,!1)}get refDistance(){return this._refDistance}set rollOffFactor(t){this._rollOffFactor=t,this._updateSoundInstances("rollOffFactor",t,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(t){this._pitch=t,this._updateSoundInstances("pitch",t,!0)}get pitch(){return this._pitch}set volume(t){this._volume=t,this._updateSoundInstances("volume",t,!0)}get volume(){return this._volume}set positional(t){this._positional=t;const e=this._slots;for(const t in e){const s=e[t];if(!s.overlap){const t=s.instances;for(let e=t.length-1;e>=0;e--){const i=t[e].isPlaying||t[e].isSuspended,n=t[e].currentTime;i&&t[e].stop();const a=s._createInstance();i&&(a.play(),a.currentTime=n),t.push(a)}}}}get positional(){return this._positional}set slots(t){const e=this._slots;if(e)for(const t in e)e[t].stop();const s={};for(const e in t)t[e]instanceof HC?s[t[e].name]=t[e]:t[e].name&&(s[t[e].name]=new HC(this,t[e].name,t[e]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const t=this._slots,e=this._playingBeforeDisable;for(const s in t){const i=t[s];i.autoPlay&&i.isStopped?i.play():e[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const t=this._slots,e={};for(const s in t)t[s].overlap||t[s].isPlaying&&(t[s].pause(),e[s]=!0);this._playingBeforeDisable=e}onRemove(){this.off()}addSlot(t,e){const s=this._slots;if(s[t])return null;const i=new HC(this,t,e);return s[t]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(t){const e=this._slots;e[t]&&(e[t].stop(),delete e[t])}slot(t){return this._slots[t]}play(t){if(!this.enabled||!this.entity.enabled)return null;const e=this._slots[t];return e?e.play():null}pause(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.pause()}else for(const t in e)e[t].pause()}resume(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.isPaused&&s.resume()}else for(const t in e)e[t].resume()}stop(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.stop()}else for(const t in e)e[t].stop()}}class qC{constructor(){this.enabled=!0}}const jC=["enabled"];class YC extends PS{constructor(t){super(t),this.id="sound",this.ComponentType=XC,this.DataType=qC,this.schema=jC,this.manager=t.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(t){this.manager.volume=t}get volume(){return this.manager.volume}get context(){return S_()?this.manager.context:null}initializeComponentData(t,e,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.sound,i=s.slots,n={};for(const t in i){const e=i[t];n[t]={name:e.name,volume:e.volume,pitch:e.pitch,loop:e.loop,duration:e.duration,startTime:e.startTime,overlap:e.overlap,autoPlay:e.autoPlay,asset:e.asset}}const a={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(e,a)}onUpdate(t){const e=this.store;for(const t in e)if(e.hasOwnProperty(t)){const s=e[t].entity;if(s.enabled){const t=s.sound;if(t.enabled&&t.positional){const e=s.getPosition(),i=t.slots;for(const t in i)i[t].updatePosition(e)}}}}onBeforeRemove(t,e){const s=e.slots;for(const t in s)s[t].overlap||s[t].stop();e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(XC.prototype,jC);const KC="simple",$C="animated";class ZC extends _{constructor(t,e){super(),this._component=t,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=e.spriteAsset,this.name=e.name,this.fps=e.fps||0,this.loop=e.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const t=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(t)}return 0}set frame(t){this._setFrame(t);const e=this.fps||Number.MIN_VALUE;this._setTime(this._frame/e)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(t){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=t,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let e;t&&t.atlas?(t.atlas.texture&&(e=this._component._meshInstance,e&&(e.setParameter("texture_emissiveMap",t.atlas.texture),e.setParameter("texture_opacityMap",t.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):(e=this._component._meshInstance,e&&(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap")),this._component._hideModel())}}get sprite(){return this._sprite}set spriteAsset(t){const e=this._component.system.app.assets;let s=t;if(t instanceof vp&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){const t=e.get(this._spriteAsset);t&&this._unbindSpriteAsset(t)}if(this._spriteAsset=s,this._spriteAsset){const t=e.get(this._spriteAsset);t?this._bindSpriteAsset(t):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(t){this._setTime(t),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(t){this._component.system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){t.on("load",this._onSpriteAssetLoad,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._component.system.app.assets.load(t)}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("remove",this._onSpriteAssetRemove,this),t.resource&&t.resource.atlas&&this._component.system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(t.resource)if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+e,this._onTextureAtlasLoad,this),s.once("load:"+e,this._onTextureAtlasLoad,this)}else this.sprite=null}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof vp?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._component.system.app.assets.get(e))}_onSpriteAssetRemove(t){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)}_update(t){if(0===this.fps)return;if(!this._playing||this._paused||!this._sprite)return;const e=this.fps<0?-1:1,s=this._time+t*this._component.speed*e,i=this.duration,n=s>i||s<0;this._setTime(s);let a=this.frame;a=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0,a!==this._frame&&this._setFrame(a),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(t){this._time=t;const e=this.duration;this._time<0?this.loop?this._time=this._time%e+e:this._time=0:this._time>e&&(this.loop?this._time%=e:this._time=e)}_setFrame(t){this._sprite?this._frame=q.clamp(t,0,this._sprite.frameKeys.length-1):this._frame=t,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}class QC extends Lp{constructor(t,e){super(t,e),this._type="simple",this._material=t.defaultMaterial,this._color=new et(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[0],this._outerScale=new ot(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new ht,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new ht,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new qo,this._model=new Du,this._model.graph=this._node,this._meshInstance=null,e.addChild(this._model.graph),this._model._entity=e,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new ZC(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(t){this._type!==t&&(this._type=t,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(t){this._currentClip.frame=t}get frame(){return this._currentClip.frame}set spriteAsset(t){this._defaultClip.spriteAsset=t}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(t){this._currentClip.sprite=t}get sprite(){return this._currentClip.sprite}set material(t){this._material=t,this._meshInstance&&(this._meshInstance.material=t)}get material(){return this._material}set color(t){this._color.r=t.r,this._color.g=t.g,this._color.b=t.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}get color(){return this._color}set opacity(t){this._color.a=t,this._meshInstance&&this._meshInstance.setParameter("material_opacity",t)}get opacity(){return this._color.a}set clips(t){if(t){for(const e in this._clips){let s=!1;for(const i in t)if(t[i].name===e){s=!0,this._clips[e].fps=t[i].fps,this._clips[e].loop=t[i].loop,t[i].hasOwnProperty("sprite")?this._clips[e].sprite=t[i].sprite:t[i].hasOwnProperty("spriteAsset")&&(this._clips[e].spriteAsset=t[i].spriteAsset);break}s||this.removeClip(e)}for(const e in t)this._clips[t[e].name]||this.addClip(t[e]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(const t in this._clips)this.removeClip(t)}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(t){this._speed=t}get speed(){return this._speed}set flipX(t){this._flipX!==t&&(this._flipX=t,this._updateTransform())}get flipX(){return this._flipX}set flipY(t){this._flipY!==t&&(this._flipY=t,this._updateTransform())}get flipY(){return this._flipY}set width(t){t!==this._width&&(this._width=t,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get width(){return this._width}set height(t){t!==this._height&&(this._height=t,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}get height(){return this._height}set batchGroupId(t){if(this._batchGroupId===t)return;const e=this._batchGroupId;var s,i;(this._batchGroupId=t,this.entity.enabled&&e>=0)&&(null==(s=this.system.app.batcher)||s.remove(yc.SPRITE,e,this.entity));this.entity.enabled&&t>=0?null==(i=this.system.app.batcher)||i.insert(yc.SPRITE,t,this.entity):e>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(t){this._autoPlayClip=t instanceof ZC?t.name:t,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(t){this._drawOrder=t,this._meshInstance&&(this._meshInstance.drawOrder=t)}get drawOrder(){return this._drawOrder}set layers(t){this._addedModel&&this._hideModel(),this._layers=t,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){const t=this.system.app,e=t.scene;var s;(e.on("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.on("add",this._onLayerAdded,this),e.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0)&&(null==(s=t.batcher)||s.insert(yc.SPRITE,this._batchGroupId,this.entity))}onDisable(){const t=this.system.app,e=t.scene;var s;(e.off("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.off("add",this._onLayerAdded,this),e.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0)&&(null==(s=t.batcher)||s.remove(yc.SPRITE,this._batchGroupId,this.entity))}onDestroy(){this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const t in this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel)return;if(!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.addMeshInstances(t)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.removeMeshInstances(t)}this._addedModel=!1}_showFrame(t){if(!this.sprite)return;const e=this.sprite.meshes[t];if(!e)return void(this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1));let s;if(s=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new Ec(e,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==e&&(this._meshInstance.mesh=e,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap")),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode)this._meshInstance._updateAabbFunc=null;else{this._meshInstance._updateAabbFunc=this._updateAabbFunc;const e=this.sprite.atlas.frames[this.sprite.frameKeys[t]];if(e){const t=2/e.rect.z,s=2/e.rect.w;this._innerOffset.set(e.border.x*t,e.border.y*s,e.border.z*t,e.border.w*s);const i=this.sprite.atlas.texture;this._atlasRect.set(e.rect.x/i.width,e.rect.y/i.height,e.rect.z/i.width,e.rect.w/i.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}this._updateTransform()}_updateTransform(){let t=this.flipX?-1:1,e=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let n=1,a=1;if(this.sprite.atlas){const t=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];t&&(n=t.rect.z,a=t.rect.w,s=(.5-t.pivot.x)*this._width,i=(.5-t.pivot.y)*this._height)}const r=n/this.sprite.pixelsPerUnit,o=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*r),Math.max(this._height,this._innerOffset.y*o)),t*=r,e*=o,this._outerScale.x/=r,this._outerScale.y/=o,t*=q.clamp(this._width/(this._innerOffset.x*r),1e-4,1),e*=q.clamp(this._height/(this._innerOffset.y*o),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(t,e,1),this._node.setLocalPosition(s,i,0)}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._node.getWorldTransform()),t}_tryAutoPlay(){if(!this._autoPlayClip)return;if("animated"!==this.type)return;const t=this._clips[this._autoPlayClip];!t||t.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(t.name)}_onLayersChanged(t,e){t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(t){this.layers.indexOf(t.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&t.addMeshInstances([this._meshInstance])}_onLayerRemoved(t){if(!this._meshInstance)return;this.layers.indexOf(t.id)<0||t.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeMeshInstances([this._meshInstance])}}addClip(t){const e=new ZC(this,{name:t.name,fps:t.fps,loop:t.loop,spriteAsset:t.spriteAsset});return this._clips[t.name]=e,e.name&&e.name===this._autoPlayClip&&this._tryAutoPlay(),e}removeClip(t){delete this._clips[t]}clip(t){return this._clips[t]}play(t){const e=this._clips[t],s=this._currentClip;return s&&s!==e&&(s._playing=!1),this._currentClip=e,this._currentClip&&(this._currentClip=e,this._currentClip.play()),e}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}class JC{constructor(){this.enabled=!0}}const tA=["enabled"];class eA extends PS{constructor(t){super(t),this.id="sprite",this.ComponentType=QC,this.DataType=JC,this.schema=tA,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(t){this._defaultMaterial=t}get defaultMaterial(){if(!this._defaultMaterial){const t=new Mo(this.app.graphicsDevice,{width:1,height:1,format:7,name:"sprite"}),e=new Uint8Array(t.lock());e[0]=e[1]=e[2]=e[3]=255,t.unlock();const s=new Xh;s.diffuse.set(0,0,0),s.emissive.set(.5,.5,.5),s.emissiveMap=t,s.emissiveMapTint=!0,s.opacityMap=t,s.opacityMapChannel="a",s.opacityTint=!0,s.opacity=0,s.useLighting=!1,s.useGammaTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=4,s.depthWrite=!1,s.pixelSnap=!1,s.cull=0,s.update(),this._defaultTexture=t,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(t){this._default9SlicedMaterialSlicedMode=t}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=1,t.update(),this._default9SlicedMaterialSlicedMode=t}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(t){this._default9SlicedMaterialTiledMode=t}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=2,t.update(),this._default9SlicedMaterialTiledMode=t}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(t,e,s){if(void 0!==e.enabled&&(t.enabled=e.enabled),t.type=e.type,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),void 0!==e.drawOrder&&(t.drawOrder=e.drawOrder),void 0!==e.color&&(e.color instanceof et?t.color.set(e.color.r,e.color.g,e.color.b,void 0!==e.opacity?e.opacity:1):t.color.set(e.color[0],e.color[1],e.color[2],void 0!==e.opacity?e.opacity:1),t.color=t.color),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.flipX&&(t.flipX=e.flipX),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.width&&(t.width=e.width),void 0!==e.height&&(t.height=e.height),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.frame&&(t.frame=e.frame),e.clips)for(const s in e.clips)t.addClip(e.clips[s]);void 0!==e.speed&&(t.speed=e.speed),e.autoPlayClip&&(t.autoPlayClip=e.autoPlayClip),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.sprite;return this.addComponent(e,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];if(i.data.enabled&&i.entity.enabled){const e=i.entity.sprite;e._currentClip&&e._currentClip._update(t)}}}onBeforeRemove(t,e){e.onDestroy()}}Lp._buildAccessors(QC.prototype,tA);class sA extends Lp{constructor(t,e){super(t,e),this._oldState=!0,this._size=new at,this.on("set_enabled",this._onSetEnabled,this)}set size(t){t instanceof at?this._size.copy(t):t instanceof Array&&t.length>=3&&this.size.set(t[0],t[1],t[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(t,e,s){this._checkState()}_checkState(){const t=this.enabled&&this.entity.enabled;t!==this._oldState&&(this._oldState=t,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}class iA{constructor(){this.enabled=!0}}const nA=["enabled"];class aA extends PS{constructor(t){super(t),this.id="zone",this.ComponentType=sA,this.DataType=iA,this.schema=nA,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(t,e,s){t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,e.size&&(e.size instanceof at?t.size.copy(e.size):e.size instanceof Array&&e.size.length>=3&&t.size.set(e.size[0],e.size[1],e.size[2]))}cloneComponent(t,e){const s={size:t.zone.size};return this.addComponent(e,s)}_onBeforeRemove(t,e){e._onBeforeRemove()}}Lp._buildAccessors(sA.prototype,nA);class rA{constructor(t,e){this.effect=t,this.inputTarget=e,this.outputTarget=null,this.name=t.constructor.name}}class oA{constructor(t,e){this.app=t,this.camera=e,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=()=>{this.resizeRenderTargets()},e.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(t,e){const s=this.camera.rect,i=Math.floor(s.z*this.app.graphicsDevice.width*this.renderTargetScale),n=Math.floor(s.w*this.app.graphicsDevice.height*this.renderTargetScale);return new Mo(this.app.graphicsDevice,{name:e,format:t,width:i,height:n,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(t,e){const s=this.app.graphicsDevice,i=e?s.getHdrFormat():7,n=this.camera.entity.name+"-posteffect-"+this.effects.length,a=this._allocateColorBuffer(i,n),r=this.app.graphicsDevice.supportsStencil,o=t?s.samples:1;return new al({colorBuffer:a,depth:t,stencil:r,samples:o})}_resizeOffscreenTarget(t){const e=t.colorBuffer.format,s=t.colorBuffer.name;t.destroyFrameBuffers(),t.destroyTextureBuffers(),t._colorBuffer=this._allocateColorBuffer(e,s)}_destroyOffscreenTarget(t){t.destroyTextureBuffers(),t.destroy()}setRenderTargetScale(t){this.renderTargetScale=t,this.resizeRenderTargets()}addEffect(t){const e=this.effects,s=0===e.length,i=this._createOffscreenTarget(s,t.hdr),n=new rA(t,i);e.push(n),this._sourceTarget=n.inputTarget,e.length>1&&(e[e.length-2].outputTarget=n.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(t){let e=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===t){e=s;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[e].inputTarget),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){const e=this.effects[t].effect;this._newPostEffect!==e&&(e.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let t=null;const e=this.effects.length;if(e)for(let s=0;s<e;s++){const i=this.effects[s];let n=i.outputTarget;s===e-1&&(t=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,t)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(t,e){const s=this.camera.rect,i=this.app.graphicsDevice;this.camera.camera.aspectRatio=i.width*s.z/(i.height*s.w),this.resizeTimeout||(V()-this.resizeLast>100?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))}resizeRenderTargets(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=V();const t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale),s=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale),i=this.effects;for(let t=0,n=i.length;t<n;t++){const n=i[t];n.inputTarget.width===e&&n.inputTarget.height===s||this._resizeOffscreenTarget(n.inputTarget)}}onCameraRectChanged(t,e,s){this.enabled&&this.resizeRenderTargets()}}const hA=[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"scissorRect",readonly:!1}];class lA extends Lp{constructor(t,e){super(t,e),this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._camera=new Ro,this._camera.node=e,this._priority=0,this._disablePostEffectsLayer=4,this._postEffects=new oA(t.app,this)}get camera(){return this._camera}set clearColorBuffer(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}_enableDepthLayer(t){if(this.layers.find((t=>1===t))){const e=this.system.app.scene.layers.getLayerById(1);t?null==e||e.incrementCounter():null==e||e.decrementCounter()}else if(t)return!1;return!0}requestSceneColorMap(t){this._renderSceneColorMap+=t?1:-1,this._enableDepthLayer(t)}get renderSceneColorMap(){return this._renderSceneColorMap>0}requestSceneDepthMap(t){this._renderSceneDepthMap+=t?1:-1,this._enableDepthLayer(t)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}get frustum(){return this._camera.frustum}set layers(t){const e=this._camera.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}if(this._camera.layers=t,this.enabled&&this.entity.enabled)for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}get layers(){return this._camera.layers}get postEffectsEnabled(){return this._postEffects.enabled}get postEffects(){return this._postEffects}set priority(t){this._priority=t,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}get projectionMatrix(){return this._camera.projectionMatrix}set rect(t){this._camera.rect=t,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderTarget(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}get viewMatrix(){return this._camera.viewMatrix}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirtyCameras=!0}screenToWorld(t,e,s,i){const n=this.system.app.graphicsDevice,a=n.clientRect.width,r=n.clientRect.height;return this._camera.screenToWorld(t,e,s,a,r,i)}worldToScreen(t,e){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(t,i,n,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){const t=this.system,e=t.app.scene,s=e.layers;t.addCamera(this),e.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const t=this.system,e=t.app.scene,s=e.layers;this.postEffects.disable(),this.removeCameraFromLayers(),e.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),t.removeCamera(this)}onRemove(){this.onDisable(),this.off()}calculateAspectRatio(t){const e=this.system.app.graphicsDevice,s=t?t.width:e.width,i=t?t.height:e.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(t){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(t))}startXr(t,e,s){this.system.app.xr.start(this,t,e,s)}endXr(t){this._camera.xr?this._camera.xr.end(t):t&&t(new Error("Camera is not in XR"))}copy(t){hA.forEach((e=>{if(!e.readonly){const s=e.name;this[s]=t[s]}})),this.clearColorBuffer=t.clearColorBuffer,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencilBuffer=t.clearStencilBuffer,this.disablePostEffectsLayer=t.disablePostEffectsLayer,this.layers=t.layers,this.priority=t.priority,this.renderTarget=t.renderTarget,this.rect=t.rect}}hA.forEach((function(t){const e=t.name,s={get:function(){return this._camera[e]}};t.readonly||(s.set=function(t){this._camera[e]=t}),Object.defineProperty(lA.prototype,e,s)}));class cA{constructor(){this.enabled=!0}}const dA=["enabled"];class uA extends PS{constructor(t){super(t),this.cameras=[],this.id="camera",this.ComponentType=lA,this.DataType=cA,this.schema=dA,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(let i=0;i<s.length;i++){const n=s[i];if(e.hasOwnProperty(n)){const s=e[n];switch(n){case"rect":case"scissorRect":Array.isArray(s)?t[n]=new ht(s[0],s[1],s[2],s[3]):t[n]=s;break;case"clearColor":Array.isArray(s)?t[n]=new et(s[0],s[1],s[2],s[3]):t[n]=s;break;default:t[n]=s}}}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.camera;return this.addComponent(e,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect})}onBeforeRemove(t,e){this.removeCamera(e)}onUpdate(t){}onAppPrerender(){for(let t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),ou(this.cameras)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),ou(this.cameras))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lp._buildAccessors(lA.prototype,dA);const pA=[],mA=[];class fA extends Lp{constructor(t,e){super(t,e),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.addLight(this)}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeLight(this)}}onLayersChanged(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&t.addLight(this)}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&t.removeLight(this)}refreshProperties(){for(let t=0;t<pA.length;t++){const e=pA[t];this[e]=this[e]}this.enabled&&this.entity.enabled&&this.onEnable()}updateShadow(){this.light.updateShadow()}onCookieAssetSet(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}}function _A(t,e,s,i){const n=fA.prototype;pA.push(t),mA.push(e),Object.defineProperty(n,t,{get:function(){return this.data[t]},set:function(e){const n=this.data,a=n[t];(i||a!==e)&&(n[t]=e,s&&s.call(this,e,a))},configurable:!0})}_A("enabled",!0,(function(t,e){this.onSetEnabled(null,e,t)})),_A("light",null),_A("type","directional",(function(t,e){this.system.changeType(this,e,t),this.refreshProperties()})),_A("color",new et(1,1,1),(function(t,e){this.light.setColor(t)}),!0),_A("intensity",1,(function(t,e){this.light.intensity=t})),_A("shape",0,(function(t,e){this.light.shape=t})),_A("castShadows",!1,(function(t,e){this.light.castShadows=t})),_A("shadowDistance",40,(function(t,e){this.light.shadowDistance=t})),_A("shadowResolution",1024,(function(t,e){this.light.shadowResolution=t})),_A("shadowBias",.05,(function(t,e){this.light.shadowBias=-.01*q.clamp(t,0,1)})),_A("numCascades",1,(function(t,e){this.light.numCascades=q.clamp(Math.floor(t),1,4)})),_A("bakeNumSamples",1,(function(t,e){this.light.bakeNumSamples=q.clamp(Math.floor(t),1,255)})),_A("bakeArea",0,(function(t,e){this.light.bakeArea=q.clamp(t,0,180)})),_A("cascadeDistribution",.5,(function(t,e){this.light.cascadeDistribution=q.clamp(t,0,1)})),_A("normalOffsetBias",0,(function(t,e){this.light.normalOffsetBias=q.clamp(t,0,1)})),_A("range",10,(function(t,e){this.light.attenuationEnd=t})),_A("innerConeAngle",40,(function(t,e){this.light.innerConeAngle=t})),_A("outerConeAngle",45,(function(t,e){this.light.outerConeAngle=t})),_A("falloffMode",0,(function(t,e){this.light.falloffMode=t})),_A("shadowType",0,(function(t,e){this.light.shadowType=t})),_A("vsmBlurSize",11,(function(t,e){this.light.vsmBlurSize=t})),_A("vsmBlurMode",1,(function(t,e){this.light.vsmBlurMode=t})),_A("vsmBias",.0025,(function(t,e){this.light.vsmBias=q.clamp(t,0,1)})),_A("cookieAsset",null,(function(t,e){if(!this._cookieAssetId||!(t instanceof vp&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof vp)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const e=this.system.app.assets.get(t);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),_A("cookie",null,(function(t,e){this.light.cookie=t})),_A("cookieIntensity",1,(function(t,e){this.light.cookieIntensity=q.clamp(t,0,1)})),_A("cookieFalloff",!0,(function(t,e){this.light.cookieFalloff=t})),_A("cookieChannel","rgb",(function(t,e){this.light.cookieChannel=t})),_A("cookieAngle",0,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new ht);let e=1,s=1;this.cookieScale&&(e=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(t*q.DEG_TO_RAD),n=Math.sin(t*q.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),_A("cookieScale",null,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new ht);const e=t.x,s=t.y,i=Math.cos(this.cookieAngle*q.DEG_TO_RAD),n=Math.sin(this.cookieAngle*q.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),_A("cookieOffset",null,(function(t,e){this.light.cookieOffset=t}),!0),_A("shadowUpdateMode",2,(function(t,e){this.light.shadowUpdateMode=t}),!0),_A("mask",1,(function(t,e){this.light.mask=t})),_A("affectDynamic",!0,(function(t,e){t?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()})),_A("affectLightmapped",!1,(function(t,e){t?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))})),_A("bake",!1,(function(t,e){t?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()})),_A("bakeDir",!0,(function(t,e){this.light.bakeDir=t})),_A("isStatic",!1,(function(t,e){this.light.isStatic=t})),_A("layers",[0],(function(t,e){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeLight(this)}for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&this.enabled&&this.entity.enabled&&s.addLight(this)}}));class gA{constructor(){const t=pA,e=mA;for(let s=0;s<t.length;s++){const i=e[s];i&&i.clone?this[t[s]]=i.clone():this[t[s]]=i}}}const yA={directional:0,omni:1,point:1,spot:2};class vA extends PS{constructor(t){super(t),this.id="light",this.ComponentType=fA,this.DataType=gA,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e){const s=pA,i={};for(let t=0,n=s.length;t<n;t++){const n=s[t];i[n]=e[n]}i.type||(i.type=t.data.type),t.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new et(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new ot(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new ot(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=0);const n=new bu(this.app.graphicsDevice);n.type=yA[i.type],n._node=t.entity,n._scene=this.app.scene,t.data.light=n,super.initializeComponentData(t,i,s)}_onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.light,i=[];let n;const a=pA;for(let t=0;t<a.length;t++)n=a[t],"light"!==n&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(e,i)}changeType(t,e,s){e!==s&&(t.light.type=yA[s])}}class xA{constructor(){this.enabled=!0}}let bA=0;class SA extends PS{constructor(t){super(t),this.id="script",this.ComponentType=Ip,this.DataType=xA,this._components=new z({sortBy:"_executionOrder"}),this._enabledComponents=new z({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e){if(t._executionOrder=bA++,this._components.append(t),bA>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(let s=0;s<e.order.length;s++)t.create(e.order[s],{enabled:e.scripts[e.order[s]].enabled,attributes:e.scripts[e.order[s]].attributes,preloading:this.preloading})}}cloneComponent(t,e){const s=[],i={};for(let e=0;e<t.script._scripts.length;e++){const n=t.script._scripts[e],a=n.__scriptType.__name;s.push(a);const r={};for(const t in n.__attributes)r[t]=n.__attributes[t];i[a]={enabled:n._enabled,attributes:r}}for(const e in t.script._scriptsIndex)e.awaiting&&s.splice(e.ind,0,e);const n={enabled:t.script.enabled,order:s,scripts:i};return this.addComponent(e,n)}_resetExecutionOrder(){bA=0;for(let t=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=bA++}_callComponentMethod(t,e,s){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(t){this._callComponentMethod(this._enabledComponents,"_onUpdate",t)}_onPostUpdate(t){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",t)}_addComponentToEnabled(t){this._enabledComponents.insert(t)}_removeComponentFromEnabled(t){this._enabledComponents.remove(t)}_onBeforeRemove(t,e){this._components.items.indexOf(e)>=0&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}const wA="inline",TA="immersive-vr",MA="immersive-ar",CA="viewer",AA="local",PA="local-floor",EA="bounded-floor",RA="unbounded",LA="gaze",IA="screen",DA="tracked-pointer",OA="none",FA="left",kA="right",BA="point",zA="plane",UA="mesh",VA="cpu-optimized",NA="gpu-optimized",WA="luminance-alpha",GA="float32",HA=[],XA=[];class qA extends _{constructor(t,e,s){super(),this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this.manager=t,this._xrHitTestSource=e,this._transient=s}remove(){if(!this._xrHitTestSource)return;const t=this.manager.hitTest.sources,e=t.indexOf(this);-1!==e&&t.splice(e,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(t){if(this._transient){const e=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let t=0;t<e.length;t++){const s=e[t];let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else this.updateHitResults(t.getHitTestResults(this._xrHitTestSource))}updateHitResults(t,e){for(let s=0;s<t.length;s++){const i=t[s].getPose(this.manager._referenceSpace);let n=HA.pop();n||(n=new at),n.copy(i.transform.position);let a=XA.pop();a||(a=new ft),a.copy(i.transform.orientation),this.fire("result",n,a,e),this.manager.hitTest.fire("result",this,n,a,e),HA.push(n),XA.push(a)}}}class jA extends _{constructor(t){super(),this.manager=void 0,this._supported=L.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this.manager=t,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this.manager.type===MA&&(this._session=this.manager.session)}_onSessionEnd(){if(this._session){this._session=null;for(let t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[]}}isAvailable(t,e){let s;return this._supported||(s=new Error("XR HitTest is not supported")),this._session||(s=new Error("XR Session is not started (1)")),this.manager.type!==MA&&(s=new Error("XR HitTest is available only for AR")),!s||(t&&t(s),e&&e.fire("error",s),!1)}start(t={}){if(!this.isAvailable(t.callback,this))return;let e;t.profile||t.spaceType||(t.spaceType="viewer");const s=t.offsetRay;s&&(e=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z),new DOMPoint(s.direction.x,s.direction.y,s.direction.z)));const i=t.callback;t.spaceType?this._session.requestReferenceSpace(t.spaceType).then((s=>{if(!this._session){const t=new Error("XR Session is not started (2)");return i&&i(t),void this.fire("error",t)}this._session.requestHitTestSource({space:s,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!1,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))})).catch((t=>{i&&i(t),this.fire("error",t)})):this._session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!0,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))}_onHitTestSource(t,e,s){if(!this._session){t.cancel();const e=new Error("XR Session is not started (3)");return s&&s(e),void this.fire("error",e)}const i=new qA(this.manager,t,e);this.sources.push(i),s&&s(null,i),this.fire("add",i)}update(t){for(let e=0;e<this.sources.length;e++)this.sources[e].update(t)}get supported(){return this._supported}}class YA{constructor(t,e){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=t,this._hand=e,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const KA=L.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],$A={};for(let t=0;t<KA.length;t++)$A[KA[t]]=!0;class ZA{constructor(t,e,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new mt,this._worldTransform=new mt,this._localPosition=new at,this._localRotation=new ft,this._position=new at,this._rotation=new ft,this._dirtyLocal=!0,this._index=t,this._id=e,this._hand=s,this._finger=i,this._wrist="wrist"===e,this._tip=this._finger&&!!$A[e]}update(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,at.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let QA=[];const JA=new at,tP=new at,eP=new at;L.browser&&window.XRHand&&(QA=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class sP extends _{constructor(t){super(),this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const e=t._xrInputSource.hand;if(this._manager=t._manager,this._inputSource=t,e.get("wrist")){const t=new ZA(0,"wrist",this,null);this._wrist=t,this._joints.push(t),this._jointsById.wrist=t}for(let t=0;t<QA.length;t++){const s=new YA(t,this);for(let i=0;i<QA[t].length;i++){const n=QA[t][i];if(!e.get(n))continue;const a=new ZA(i,n,this,s);this._joints.push(a),this._jointsById[n]=a,a.tip&&(this._tips.push(a),s._tip=a),s._joints.push(a)}}}update(t){const e=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const i=this._joints[s],n=e.hand.get(i._id);if(n){let e;if("hidden"!==t.session.visibilityState&&(e=t.getJointPose(n,this._manager._referenceSpace)),e)i.update(e),i.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],a=this._jointsById["index-finger-tip"],r=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&a&&r&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,a._localPosition,.5);let t=s,e=o;if("left"===this._inputSource.handedness){const s=t;t=e,e=s}JA.sub2(t._localPosition,this._wrist._localPosition),tP.sub2(e._localPosition,this._wrist._localPosition),eP.cross(JA,tP).normalize(),JA.lerp(n._localPosition,r._localPosition,.5),JA.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(eP,JA,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(t){const e=this._fingers[t];return JA.sub2(e.joints[0]._localPosition,e.joints[1]._localPosition).normalize(),tP.sub2(e.joints[2]._localPosition,e.joints[3]._localPosition).normalize(),JA.dot(tP)<-.8}getJointById(t){return this._jointsById[t]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const iP=new ft;let nP=0;class aP extends _{constructor(t,e){super(),this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new si,this._rayLocal=new si,this._grip=!1,this._hand=null,this._localTransform=null,this._worldTransform=null,this._position=new at,this._rotation=new ft,this._localPosition=null,this._localRotation=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++nP,this._manager=t,this._xrInputSource=e,e.hand&&(this._hand=new sP(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(t){if(this._hand)this._hand.update(t);else{if(this._xrInputSource.gripSpace){const e=t.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);e&&(this._grip||(this._grip=!0,this._localTransform=new mt,this._worldTransform=new mt,this._localPosition=new at,this._localRotation=new ft),this._dirtyLocal=!0,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation))}const e=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);e&&(this._dirtyRay=!0,this._rayLocal.origin.copy(e.transform.position),this._rayLocal.direction.set(0,0,-1),iP.copy(e.transform.orientation),iP.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,at.ONE));const t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const t=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(t={}){t.profile=this._xrInputSource.profiles[0];const e=t.callback;t.callback=(t,s)=>{s&&this.onHitTestSourceAdd(s),e&&e(t,s)},this._manager.hitTest.start(t)}onHitTestSourceAdd(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",(function(e,s,i){i===this&&this.fire("hittest:result",t,e,s)}),this),t.once("remove",(function(){this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)}),this)}onHitTestSourceRemove(t){const e=this._hitTestSources.indexOf(t);-1!==e&&this._hitTestSources.splice(e,1)}}class rP extends _{constructor(t){super(),this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.manager=t,this._onInputSourcesChangeEvt=t=>{this._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const t=this.manager.session;t.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),t.addEventListener("select",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("select",t),this.fire("select",e,t)})),t.addEventListener("selectstart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!0,e.fire("selectstart",t),this.fire("selectstart",e,t)})),t.addEventListener("selectend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!1,e.fire("selectend",t),this.fire("selectend",e,t)})),t.addEventListener("squeeze",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("squeeze",t),this.fire("squeeze",e,t)})),t.addEventListener("squeezestart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!0,e.fire("squeezestart",t),this.fire("squeezestart",e,t)})),t.addEventListener("squeezeend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!1,e.fire("squeezeend",t),this.fire("squeezeend",e,t)}));const e=t.inputSources;for(let t=0;t<e.length;t++)this._addInputSource(e[t])}_onSessionEnd(){let t=this._inputSources.length;for(;t--;){const e=this._inputSources[t];this._inputSources.splice(t,1),e.fire("remove"),this.fire("remove",e)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(t){for(let e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(let e=0;e<t.added.length;e++)this._addInputSource(t.added[e])}_getByInputSource(t){for(let e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null}_addInputSource(t){if(this._getByInputSource(t))return;const e=new aP(this.manager,t);this._inputSources.push(e),this.fire("add",e)}_removeInputSource(t){for(let e=0;e<this._inputSources.length;e++){if(this._inputSources[e].inputSource!==t)continue;const s=this._inputSources[e];this._inputSources.splice(e,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(t){for(let e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)}get inputSources(){return this._inputSources}}const oP=new at,hP=new at,lP=new mt,cP=new mt;class dP extends _{constructor(t){super(),this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new ft,this._color=new et,this._sphericalHarmonics=new Float32Array(27),this._manager=t,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let t;this._manager.session||(t=new Error("XR session is not running")),t||this._manager.type===MA||(t=new Error("XR session type is not AR")),t||this._supported||(t=new Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=new Error("light estimation is already requested")),t?this.fire("error",t):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((t=>{const e=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?e&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))})).catch((t=>{this._lightProbeRequested=!1,this.fire("error",t)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(t){if(!this._lightProbe)return;const e=t.getLightEstimate(this._lightProbe);if(!e)return;this._available||(this._available=!0,this.fire("available"));const s=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),oP.copy(s).mulScalar(1/this._intensity),this._color.set(oP.x,oP.y,oP.z),oP.set(0,0,0),hP.copy(e.primaryLightDirection),lP.setLookAt(hP,oP,at.UP),cP.setFromAxisAngle(at.RIGHT,90),lP.mul(cP),this._rotation.setFromMat4(lP),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}class uP extends _{constructor(t,e){super(),this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new at,this._rotation=new ft,this._image=t,this._width=e}get image(){return this._image}set width(t){this._width=t}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((t=>(this._bitmap=t,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}class pP extends _{constructor(t){super(),this._manager=void 0,this._supported=L.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(t,e){if(!this._supported||this._manager.active)return null;const s=new uP(t,e);return this._images.push(s),s}remove(t){if(this._manager.active)return;const e=this._images.indexOf(t);-1!==e&&(t.destroy(),this._images.splice(e,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((t=>{this._available=!0;for(let e=0;e<t.length;e++)this._images[e]._trackable="trackable"===t[e]})).catch((t=>{this._available=!1,this.fire("error",t)}))}_onSessionEnd(){this._available=!1;for(let t=0;t<this._images.length;t++){const e=this._images[t];e._pose=null,e._measuredWidth=0,e._tracking&&(e._tracking=!1,e.fire("untracked"))}}prepareImages(t){this._images.length?Promise.all(this._images.map((function(t){return t.prepare()}))).then((function(e){t(null,e)})).catch((function(e){t(e,null)})):t(null,null)}update(t){if(!this._available)return;const e=t.getImageTrackingResults(),s={};for(let i=0;i<e.length;i++){s[e[i].index]=e[i];const n=this._images[e[i].index];n._emulated="emulated"===e[i].trackingState,n._measuredWidth=e[i].measuredWidthInMeters,n._pose=t.getPose(e[i].imageSpace,this._manager._referenceSpace)}for(let t=0;t<this._images.length;t++)this._images[t]._tracking&&!s[t]?(this._images[t]._tracking=!1,this._images[t].fire("untracked")):!this._images[t]._tracking&&s[t]&&(this._images[t]._tracking=!0,this._images[t].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class mP{constructor(t){this._manager=void 0,this._supported=L.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=t}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(t){this._supported&&!this._manager.active&&(this._root=t)}get root(){return this._root}}class fP extends _{constructor(t){super(),this._manager=void 0,this._available=!1,this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._matrixDirty=!1,this._matrix=new mt,this._emptyBuffer=new Uint8Array(32),this._depthBuffer=null,this._texture=void 0,this._manager=t,this._texture=new Mo(this._manager.app.graphicsDevice,{format:2,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,name:"XRDepthSensing"}),this.supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}destroy(){this._texture.destroy(),this._texture=null}_onSessionStart(){const t=this._manager.session;try{this._usage=t.depthUsage,this._dataFormat=t.depthDataFormat}catch(t){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",t)}}_onSessionEnd(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()}_updateTexture(){const t=this._depthInfoCpu||this._depthInfoGpu;if(t){let e=!1;if(t.width===this._texture.width&&t.height===this._texture.height||(this._texture._width=t.width,this._texture._height=t.height,this._matrixDirty=!0,e=!0),this._depthInfoCpu){const t=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(t),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());e&&this.fire("resize",t.width,t.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())}update(t,e){if(!this._usage)return;let s=null,i=null;if("cpu-optimized"===this._usage&&e?s=t.getDepthInformation(e):"gpu-optimized"===this._usage&&e&&(i=t.getDepthInformation(e)),(this._depthInfoCpu&&!s||!this._depthInfoCpu&&s||this.depthInfoGpu&&!i||!this._depthInfoGpu&&i)&&(this._matrixDirty=!0),this._depthInfoCpu=s,this._depthInfoGpu=i,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;const t=this._depthInfoCpu||this._depthInfoGpu;t?this._matrix.data.set(t.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}!this._depthInfoCpu&&!this._depthInfoGpu||this._available?this._depthInfoCpu||this._depthInfoGpu||!this._available||(this._available=!1,this.fire("unavailable")):(this._available=!0,this.fire("available"))}getDepth(t,e){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(t,e):null}get supported(){return L.browser&&!!window.XRDepthInformation}get available(){return this._available}get usage(){return this._usage}get dataFormat(){return this._dataFormat}get width(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.width||0}get height(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.height||0}get texture(){return this._texture}get uvMatrix(){return this._matrix}get rawValueToMeters(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.rawValueToMeters||0}}let _P=0;class gP extends _{constructor(t,e){super(),this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new at,this._rotation=new ft,this._id=++_P,this._planeDetection=t,this._xrPlane=e,this._lastChangedTime=e.lastChangedTime,this._orientation=e.orientation}destroy(){this.fire("remove")}update(t){const e=this._planeDetection._manager,s=t.getPose(this._xrPlane.planeSpace,e._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}}class yP extends _{constructor(t){super(),this._manager=void 0,this._supported=L.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=null,this._manager=t,this._supported&&this._manager.on("end",this._onSessionEnd,this)}_onSessionEnd(){if(this._planes)for(let t=0;t<this._planes.length;t++)this._planes[t].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))}update(t){let e;if(this._available)e=t.detectedPlanes;else try{e=t.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch(t){return}for(const[t,s]of this._planesIndex)e.has(t)||(this._planesIndex.delete(t),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of e){let e=this._planesIndex.get(s);e?e.update(t):(e=new gP(this,s),this._planesIndex.set(s,e),this._planes.push(e),e.update(t),this.fire("add",e))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class vP extends _{constructor(t){super(),this.app=void 0,this._supported=L.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this._referenceSpace=null,this.depthSensing=void 0,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new at,this._localRotation=new ft,this._depthNear=.1,this._depthFar=1e3,this._width=0,this._height=0,this.app=t,this._available.inline=!1,this._available["immersive-vr"]=!1,this._available[MA]=!1,this.depthSensing=new fP(this),this.domOverlay=new mP(this),this.hitTest=new jA(this),this.imageTracking=new pP(this),this.planeDetection=new yP(this),this.input=new rP(this),this.lightEstimation=new dP(this),this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck())}destroy(){this.depthSensing.destroy(),this.depthSensing=null}start(t,e,s,i){let n=i;if("object"==typeof i&&(n=i.callback),!this._available[e])return void(n&&n(new Error("XR is not available")));if(this._session)return void(n&&n(new Error("XR session is already started")));this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=s,this._setClipPlanes(t.nearClip,t.farClip);const a={requiredFeatures:[s],optionalFeatures:[]};if(e===MA){if(a.optionalFeatures.push("light-estimation"),a.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&a.optionalFeatures.push("image-tracking"),i.planeDetection&&a.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(a.optionalFeatures.push("dom-overlay"),a.domOverlay={root:this.domOverlay.root}),i&&i.depthSensing&&this.depthSensing.supported){a.optionalFeatures.push("depth-sensing");const t=["cpu-optimized"],e=["luminance-alpha"];if(i.depthSensing.usagePreference){const e=t.indexOf(i.depthSensing.usagePreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const t=e.indexOf(i.depthSensing.dataFormatPreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.dataFormatPreference)}a.depthSensing={usagePreference:t,dataFormatPreference:e}}}else"immersive-vr"===e&&a.optionalFeatures.push("hand-tracking");i&&i.optionalFeatures&&(a.optionalFeatures=a.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((t,i)=>{if(t)return n&&n(t),void this.fire("error",t);null!==i&&(a.trackedImages=i),this._onStartOptionsReady(e,s,a,n)})):this._onStartOptionsReady(e,s,a,n)}_onStartOptionsReady(t,e,s,i){navigator.xr.requestSession(t,s).then((t=>{this._onSessionStart(t,e,i)})).catch((t=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(t),this.fire("error",t)}))}end(t){this._session?(t&&this.once("end",t),this._session.end()):t&&t(new Error("XR Session is not initialized"))}isAvailable(t){return this._available[t]}_deviceAvailabilityCheck(){for(const t in this._available)this._sessionSupportCheck(t)}_sessionSupportCheck(t){navigator.xr.isSessionSupported(t).then((e=>{this._available[t]!==e&&(this._available[t]=e,this.fire("available",t,e),this.fire("available:"+t,e))})).catch((t=>{this.fire("error",t)}))}_onSessionStart(t,e,s){let i=!1;this._session=t;const n=()=>{this.fire("visibility:change",t.visibilityState)},a=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},r=()=>{this._camera&&(this._camera.off("set_nearClip",a),this._camera.off("set_farClip",a),this._camera.camera.xr=null,this._camera=null),t.removeEventListener("end",r),t.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this.views=[],this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.tick()};t.addEventListener("end",r),t.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl,{alpha:!0,depth:!0,stencil:!0}),t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),t.requestReferenceSpace(e).then((t=>{this._referenceSpace=t,this.app.tick(),s&&s(null),this.fire("start")})).catch((e=>{i=!0,t.end(),s&&s(e),this.fire("error",e)}))}_setClipPlanes(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}update(t){if(!this._session)return;const e=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;this._width===e&&this._height===s||(this._width=e,this._height=s,this.app.graphicsDevice.setResolution(e,s));const i=t.getViewerPose(this._referenceSpace),n=i?i.views.length:0;if(n>this.views.length)for(let t=0;t<=n-this.views.length;t++){let t=this.viewsPool.pop();t||(t={viewport:new ht,projMat:new mt,viewMat:new mt,viewOffMat:new mt,viewInvMat:new mt,viewInvOffMat:new mt,projViewOffMat:new mt,viewMat3:new rt,position:new Float32Array(3),rotation:new ft}),this.views.push(t)}else if(n<=this.views.length)for(let t=0;t<this.views.length-n;t++)this.viewsPool.push(this.views.pop());if(i){const e=i.transform.position,s=i.transform.orientation;this._localPosition.set(e.x,e.y,e.z),this._localRotation.set(s.x,s.y,s.z,s.w);const n=t.session.renderState.baseLayer;for(let t=0;t<i.views.length;t++){const e=i.views[t],s=this.views[t],a=n.getViewport(e);s.viewport.x=a.x,s.viewport.y=a.y,s.viewport.z=a.width,s.viewport.w=a.height,s.projMat.set(e.projectionMatrix),s.viewMat.set(e.transform.inverse.matrix),s.viewInvMat.set(e.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===MA&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t),this.depthSensing.supported&&this.depthSensing.update(t,i&&i.views[0]),this.imageTracking.supported&&this.imageTracking.update(t),this.planeDetection.supported&&this.planeDetection.update(t)),this.fire("update",t)}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}class xP extends $p{constructor(t,e={}){super(t);const s=new AS;s.graphicsDevice=this.createDevice(t,e),this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=e.elementInput,s.keyboard=e.keyboard,s.mouse=e.mouse,s.touch=e.touch,s.gamepads=e.gamepads,s.scriptPrefix=e.scriptPrefix,s.assetPrefix=e.assetPrefix,s.scriptsOrder=e.scriptsOrder,s.soundManager=new A_(e),s.lightmapper=om,s.batchManager=Uc,s.xr=vP,this.init(s)}createDevice(t,e){return e.graphicsDeviceOptions||(e.graphicsDeviceOptions={}),L.browser&&navigator.xr&&(e.graphicsDeviceOptions.xrCompatible=!0),e.graphicsDeviceOptions.alpha=e.graphicsDeviceOptions.alpha||!1,new jl(t,e.graphicsDeviceOptions)}addComponentSystems(t){t.componentSystems=[hC,yT,nM,DS,HS,IM,qM,uA,vA,Tp.legacy?vC:SA,QS,YC,YS,NM,fC,KT,vw,zC,WC,eA,PM,hM,aA]}addResourceHandles(t){t.resourceHandlers=[hy,Tg,G_,H_,ny,$g,Iy,yy,Xg,Ag,bp,cy,Dg,Hg,Lg,uy,Gg,Og,kg,Pg,ky,fy,gy,Rg]}}const bP={write:function(t){console.log(t)},open:function(){bP.write("Powered by PlayCanvas 1.54.0 8577cfea7")},info:function(t){console.info("INFO:\t\t"+t)},debug:function(t){console.debug("DEBUG:\t "+t)},error:function(t){console.error("ERROR:\t "+t)},warning:function(t){console.warn("WARNING: "+t)},alert:function(t){bP.write("ALERT:\t "+t),alert(t)},assert:function(t,e){!1===t&&bP.write("ASSERT:\t"+e)}};F.endsWith=function(t,e){return t.endsWith(e)},F.startsWith=function(t,e){return t.startsWith(e)};const SP={now:V,Timer:N};function wP(t,e){const s=function(){},i=function(s,i,n,a,r,o,h,l){e.call(this,s,i,n,a,r,o,h,l),t.call(this,s,i,n,a,r,o,h,l)};return i._super=e.prototype,s.prototype=e.prototype,i.prototype=new s,i}function TP(t){return Array.prototype.slice.call(t)}Object.defineProperty(et.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(et.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),q.INV_LOG2=Math.LOG2E,q.intToBytes=q.intToBytes32,q.bytesToInt=q.bytesToInt32,Object.defineProperty(ot.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),ot.prototype.scale=ot.prototype.mulScalar,Object.defineProperty(at.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),at.prototype.scale=at.prototype.mulScalar,Object.defineProperty(ht.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),ht.prototype.scale=ht.prototype.mulScalar;const MP={Aabb:bt,Sphere:Tt,Plane:li};Tt.prototype.intersectRay=Tt.prototype.intersectsRay,ei.prototype.update=function(t,e){const s=new mt;s.mul2(t,e),this.setFromMat4(s)};const CP=0,AP=1,PP=2,EP=3,RP=4,LP=5,IP=6;function DP(t){this.name="UnsupportedBrowserError",this.message=t||""}function OP(t){this.name="ContextCreationError",this.message=t||""}DP.prototype=Error.prototype,OP.prototype=Error.prototype;const FP={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:Yr,programlib:oh,shaderChunks:Zr,ContextCreationError:OP,Device:il,IndexBuffer:ll,ProgramLibrary:sl,RenderTarget:al,ScopeId:fo,Shader:$r,ShaderInput:Nl,Texture:Mo,UnsupportedBrowserError:DP,VertexBuffer:Wr,VertexFormat:Hr,VertexIterator:wl},kP={createFullscreenQuad:Cl,drawFullscreenQuad:Al,PostEffect:Ml,PostEffectQueue:oA};Object.defineProperty(Zr,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+Zr.transformVS}});const BP={"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"};Object.keys(BP).forEach((t=>{Object.defineProperty(Zr,t,{get:function(){return null},set:function(){}})})),Object.defineProperties(al.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(t){}}}),Hr.prototype.update=function(){},Object.defineProperties(Mo.prototype,{rgbm:{get:function(){return"rgbm"===this.type},set:function(t){this.type=t?"rgbm":"default"}},swizzleGGGR:{get:function(){return"swizzleGGGR"===this.type},set:function(t){this.type=t?"swizzleGGGR":"default"}},_glTexture:{get:function(){return this.impl._glTexture}}});const zP=Xh,UP={partitionSkin:ty,procedural:{calculateTangents:nc,createMesh:ac,createTorus:rc,createCylinder:hc,createCapsule:lc,createCone:cc,createSphere:dc,createPlane:uc,createBox:mc},BasicMaterial:_c,Command:Pc,ForwardRenderer:Yd,GraphNode:qo,Material:Fh,Mesh:ec,MeshInstance:Ec,Model:Du,ParticleEmitter:sf,PhongMaterial:Xh,Picker:rf,Projection:{ORTHOGRAPHIC:1,PERSPECTIVE:0},Scene:Uu,Skin:of,SkinInstance:xc};function VP(t,e){Object.defineProperty(Xh.prototype,e,{get:function(){return this[t]},set:function(e){this[t]=e}})}Object.defineProperty(Uu.prototype,"defaultMaterial",{get:function(){return Dh($l().graphicsDevice)}}),["128","64","32","16","8","4"].forEach(((t,e)=>{Object.defineProperty(Uu.prototype,`skyboxPrefiltered${t}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})})),Object.defineProperty(gc.prototype,"model",{get:function(){return null}}),Yd.prototype.renderComposition=function(t){$l().renderComposition(t)},Ec.prototype.syncAabb=function(){},Lu.prototype.getTarget=function(t){return this.targets[t]},qo.prototype._dirtify=function(t){t?this._dirtifyLocal():this._dirtifyWorld()},qo.prototype.addLabel=function(t){this._labels[t]=!0},qo.prototype.getLabels=function(){return Object.keys(this._labels)},qo.prototype.hasLabel=function(t){return!!this._labels[t]},qo.prototype.removeLabel=function(t){delete this._labels[t]},qo.prototype.findByLabel=function(t,e=[]){this.hasLabel(t)&&e.push(this);for(let s=0;s<this._children.length;++s)e=this._children[s].findByLabel(t,e);return e},qo.prototype.getChildren=function(){return this.children},qo.prototype.getName=function(){return this.name},qo.prototype.getPath=function(){return this.path},qo.prototype.getRoot=function(){return this.root},qo.prototype.getParent=function(){return this.parent},qo.prototype.setName=function(t){this.name=t},Fh.prototype.getName=function(){return this.name},Fh.prototype.setName=function(t){this.name=t},Fh.prototype.getShader=function(){return this.shader},Fh.prototype.setShader=function(t){this.shader=t},VP("diffuseTint","diffuseMapTint"),VP("specularTint","specularMapTint"),VP("emissiveTint","emissiveMapTint"),VP("aoVertexColor","aoMapVertexColor"),VP("diffuseVertexColor","diffuseMapVertexColor"),VP("specularVertexColor","specularMapVertexColor"),VP("emissiveVertexColor","emissiveMapVertexColor"),VP("metalnessVertexColor","metalnessMapVertexColor"),VP("glossVertexColor","glossMapVertexColor"),VP("opacityVertexColor","opacityMapVertexColor"),VP("lightVertexColor","lightMapVertexColor");const NP={Animation:ff,Key:pf,Node:mf,Skeleton:gf};ff.prototype.getDuration=function(){return this.duration},ff.prototype.getName=function(){return this.name},ff.prototype.getNodes=function(){return this.nodes},ff.prototype.setDuration=function(t){this.duration=t},ff.prototype.setName=function(t){this.name=t},gf.prototype.getAnimation=function(){return this.animation},gf.prototype.getCurrentTime=function(){return this.currentTime},gf.prototype.getLooping=function(){return this.looping},gf.prototype.getNumNodes=function(){return this.numNodes},gf.prototype.setAnimation=function(t){this.animation=t},gf.prototype.setCurrentTime=function(t){this.currentTime=t},gf.prototype.setLooping=function(t){this.looping=t};const WP={AudioManager:A_,Channel:w_,Channel3d:T_,Listener:M_,Sound:P_};A_.prototype.getListener=function(){return this.listener},A_.prototype.getVolume=function(){return this.volume},A_.prototype.setVolume=function(t){this.volume=t};const GP={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};Mp.prototype.getAssetById=function(t){return this.get(t)},Object.defineProperty(aP.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(aP.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(aP.prototype,"rotation",{get:function(){return this._localRotation}});const HP={getTouchTargetCoords:wS,Controller:Ub,GamePads:SS,Keyboard:Fb,KeyboardEvent:Rb,Mouse:zb,MouseEvent:Bb,Touch:TS,TouchDevice:CS,TouchEvent:MS};Object.defineProperty(vS.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(Bb.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});const XP="static",qP="dynamic",jP="kinematic",YP=1,KP=2,$P=4,ZP=1,QP=2,JP=3,tE=4,eE=5,sE={Application:xP,Component:Lp,ComponentSystem:PS,Entity:tm,FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:"KEEP_ASPECT"},ResolutionMode:{AUTO:"AUTO",FIXED:"FIXED"}};function iE(t,e,s){V_({glueUrl:t,wasmUrl:e,fallbackUrl:s,lazyInit:!0})}function nE(t){}xP.prototype.isFullscreen=function(){return!!document.fullscreenElement},xP.prototype.enableFullscreen=function(t,e,s){t=t||this.graphicsDevice.canvas;const i=function t(){e(),document.removeEventListener("fullscreenchange",t)},n=function t(){s(),document.removeEventListener("fullscreenerror",t)};e&&document.addEventListener("fullscreenchange",i,!1),s&&document.addEventListener("fullscreenerror",n,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s()},xP.prototype.disableFullscreen=function(t){const e=function e(){t(),document.removeEventListener("fullscreenchange",e)};t&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},xP.prototype.getSceneUrl=function(t){const e=this.scenes.find(t);return e?e.url:null},xP.prototype.loadScene=function(t,e){this.scenes.loadScene(t,e)},xP.prototype.loadSceneHierarchy=function(t,e){this.scenes.loadSceneHierarchy(t,e)},xP.prototype.loadSceneSettings=function(t,e){this.scenes.loadSceneSettings(t,e)},xP.prototype.renderMeshInstance=function(t,e){const s=null!=e&&e.layer?e.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(null,null,null,t,s)},xP.prototype.renderMesh=function(t,e,s,i){const n=null!=i&&i.layer?i.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(e,s,t,null,n)},xP.prototype._addLines=function(t,e,s){const i=s&&s.layer?s.layer:this.scene.layers.getLayerById(3),n=!s||void 0===s.depthTest||s.depthTest;this.scene.immediate.getBatch(i,n).addLines(t,e)},xP.prototype.renderLine=function(t,e,s){let i,n=s;const a=arguments[3],r=arguments[4];a instanceof et?(n=a,i="number"==typeof r?1===r?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}:r):"number"==typeof a?(n=s,i=1===a?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):a&&(i=a),this._addLines([t,e],[s,n],i)},xP.prototype.renderLines=function(t,e,s){s?"number"==typeof s&&(s=1===s?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):s={layer:this.scene.layers.getLayerById(3),depthTest:!0};!e.length||t.length===e.length?t.length%2==0?this._addLines(t,e,s):console.error("renderLines: array length is not divisible by 2"):console.error("renderLines: position/color arrays have different lengths")},xP.prototype.enableVr=function(){},Object.defineProperty(lA.prototype,"node",{get:function(){return this.entity}}),Object.defineProperty(fA.prototype,"enable",{get:function(){return this.enabled},set:function(t){this.enabled=t}}),EM.prototype.setVisible=function(t){this.enabled=t},Object.defineProperty(EM.prototype,"aabb",{get:function(){return null},set:function(t){}}),Object.defineProperty(WM.prototype,"aabb",{get:function(){return null},set:function(t){}}),Object.defineProperty(eC.prototype,"bodyType",{get:function(){return this.type},set:function(t){this.type=t}}),eC.prototype.syncBodyToEntity=function(){this._updateDynamic()},hC.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};export{tp as ABSOLUTE_URL,Xy as ACTION_GAMEPAD,Hy as ACTION_KEYBOARD,Gy as ACTION_MOUSE,di as ADDRESS_CLAMP_TO_EDGE,ui as ADDRESS_MIRRORED_REPEAT,ci as ADDRESS_REPEAT,Gf as ANIM_BLEND_1D,Xf as ANIM_BLEND_2D_CARTESIAN,Hf as ANIM_BLEND_2D_DIRECTIONAL,qf as ANIM_BLEND_DIRECT,$f as ANIM_CONTROL_STATES,Bf as ANIM_EQUAL_TO,Df as ANIM_GREATER_THAN,Ff as ANIM_GREATER_THAN_EQUAL_TO,Rf as ANIM_INTERRUPTION_NEXT,If as ANIM_INTERRUPTION_NEXT_PREV,Pf as ANIM_INTERRUPTION_NONE,Ef as ANIM_INTERRUPTION_PREV,Lf as ANIM_INTERRUPTION_PREV_NEXT,Qf as ANIM_LAYER_ADDITIVE,Zf as ANIM_LAYER_OVERWRITE,Of as ANIM_LESS_THAN,kf as ANIM_LESS_THAN_EQUAL_TO,zf as ANIM_NOT_EQUAL_TO,Nf as ANIM_PARAMETER_BOOLEAN,Vf as ANIM_PARAMETER_FLOAT,Uf as ANIM_PARAMETER_INTEGER,Wf as ANIM_PARAMETER_TRIGGER,Kf as ANIM_STATE_ANY,Yf as ANIM_STATE_END,jf as ANIM_STATE_START,$s as ASPECT_AUTO,Zs as ASPECT_MANUAL,ep as ASSET_ANIMATION,sp as ASSET_AUDIO,mp as ASSET_CONTAINER,dp as ASSET_CSS,lp as ASSET_CUBEMAP,up as ASSET_HTML,ip as ASSET_IMAGE,np as ASSET_JSON,rp as ASSET_MATERIAL,ap as ASSET_MODEL,pp as ASSET_SCRIPT,cp as ASSET_SHADER,op as ASSET_TEXT,hp as ASSET_TEXTURE,Qy as AXIS_KEY,qy as AXIS_MOUSE_X,jy as AXIS_MOUSE_Y,Yy as AXIS_PAD_L_X,Ky as AXIS_PAD_L_Y,$y as AXIS_PAD_R_X,Zy as AXIS_PAD_R_Y,bf as AnimBinder,Mf as AnimClip,G_ as AnimClipHandler,NS as AnimComponent,VS as AnimComponentLayer,HS as AnimComponentSystem,p_ as AnimController,Cf as AnimCurve,Af as AnimData,t_ as AnimEvaluator,s_ as AnimEvents,Tf as AnimSnapshot,m_ as AnimStateGraph,H_ as AnimStateGraphHandler,e_ as AnimTarget,i_ as AnimTrack,ff as Animation,RS as AnimationComponent,DS as AnimationComponentSystem,Tg as AnimationHandler,$p as AppBase,xP as Application,vp as Asset,By as AssetListLoader,Yg as AssetReference,Mp as AssetRegistry,Ag as AudioHandler,XS as AudioListenerComponent,YS as AudioListenerComponentSystem,KS as AudioSourceComponent,QS as AudioSourceComponentSystem,Fs as BAKE_COLOR,ks as BAKE_COLORDIR,Or as BINDGROUP_MESH,Dr as BINDGROUP_VIEW,Pi as BLENDEQUATION_ADD,Ii as BLENDEQUATION_MAX,Li as BLENDEQUATION_MIN,Ri as BLENDEQUATION_REVERSE_SUBTRACT,Ei as BLENDEQUATION_SUBTRACT,Ci as BLENDMODE_CONSTANT_ALPHA,Ti as BLENDMODE_CONSTANT_COLOR,Si as BLENDMODE_DST_ALPHA,gi as BLENDMODE_DST_COLOR,mi as BLENDMODE_ONE,Ai as BLENDMODE_ONE_MINUS_CONSTANT_ALPHA,Mi as BLENDMODE_ONE_MINUS_CONSTANT_COLOR,wi as BLENDMODE_ONE_MINUS_DST_ALPHA,yi as BLENDMODE_ONE_MINUS_DST_COLOR,bi as BLENDMODE_ONE_MINUS_SRC_ALPHA,_i as BLENDMODE_ONE_MINUS_SRC_COLOR,vi as BLENDMODE_SRC_ALPHA,xi as BLENDMODE_SRC_ALPHA_SATURATE,fi as BLENDMODE_SRC_COLOR,pi as BLENDMODE_ZERO,Ct as BLEND_ADDITIVE,Lt as BLEND_ADDITIVEALPHA,Ft as BLEND_MAX,Ot as BLEND_MIN,Rt as BLEND_MULTIPLICATIVE,It as BLEND_MULTIPLICATIVE2X,Pt as BLEND_NONE,At as BLEND_NORMAL,Et as BLEND_PREMULTIPLIED,Dt as BLEND_SCREEN,Mt as BLEND_SUBTRACTIVE,_e as BLUR_BOX,ge as BLUR_GAUSSIAN,Cw as BODYFLAG_KINEMATIC_OBJECT,Aw as BODYFLAG_NORESPONSE_OBJECT,Mw as BODYFLAG_STATIC_OBJECT,Ow as BODYGROUP_DEFAULT,Fw as BODYGROUP_DYNAMIC,zw as BODYGROUP_ENGINE_1,Vw as BODYGROUP_ENGINE_2,Nw as BODYGROUP_ENGINE_3,Bw as BODYGROUP_KINEMATIC,Dw as BODYGROUP_NONE,kw as BODYGROUP_STATIC,Uw as BODYGROUP_TRIGGER,Ww as BODYGROUP_USER_1,Gw as BODYGROUP_USER_2,Hw as BODYGROUP_USER_3,Xw as BODYGROUP_USER_4,qw as BODYGROUP_USER_5,jw as BODYGROUP_USER_6,Yw as BODYGROUP_USER_7,Kw as BODYGROUP_USER_8,Zw as BODYMASK_ALL,$w as BODYMASK_NONE,Jw as BODYMASK_NOT_STATIC,tT as BODYMASK_NOT_STATIC_KINEMATIC,Qw as BODYMASK_STATIC,Pw as BODYSTATE_ACTIVE_TAG,Lw as BODYSTATE_DISABLE_DEACTIVATION,Iw as BODYSTATE_DISABLE_SIMULATION,Ew as BODYSTATE_ISLAND_SLEEPING,Rw as BODYSTATE_WANTS_DEACTIVATION,ww as BODYTYPE_DYNAMIC,Tw as BODYTYPE_KINEMATIC,Sw as BODYTYPE_STATIC,Oi as BUFFER_DYNAMIC,ki as BUFFER_GPUDYNAMIC,Di as BUFFER_STATIC,Fi as BUFFER_STREAM,ew as BUTTON_TRANSITION_MODE_SPRITE_CHANGE,tw as BUTTON_TRANSITION_MODE_TINT,_c as BasicMaterial,gc as Batch,yc as BatchGroup,Uc as BatchManager,Pg as BinaryHandler,bt as BoundingBox,Tt as BoundingSphere,Vu as Bundle,Xu as BundleHandler,Cp as BundleRegistry,fw as ButtonComponent,vw as ButtonComponentSystem,Bi as CLEARFLAG_COLOR,zi as CLEARFLAG_DEPTH,Ui as CLEARFLAG_STENCIL,Ks as COMPUPDATED_BLEND,Ys as COMPUPDATED_CAMERAS,qs as COMPUPDATED_INSTANCES,js as COMPUPDATED_LIGHTS,Ni as CUBEFACE_NEGX,Gi as CUBEFACE_NEGY,Xi as CUBEFACE_NEGZ,Vi as CUBEFACE_POSX,Wi as CUBEFACE_POSY,Hi as CUBEFACE_POSZ,Fe as CUBEPROJ_BOX,Oe as CUBEPROJ_NONE,ji as CULLFACE_BACK,Yi as CULLFACE_FRONT,Ki as CULLFACE_FRONTANDBACK,qi as CULLFACE_NONE,Q as CURVE_CARDINAL,Z as CURVE_CATMULL,K as CURVE_LINEAR,$ as CURVE_SMOOTHSTEP,J as CURVE_SPLINE,tt as CURVE_STEP,Ro as Camera,lA as CameraComponent,uA as CameraComponentSystem,y_ as CanvasFont,xw as CollisionComponent,yT as CollisionComponentSystem,et as Color,Pc as Command,Lp as Component,PS as ComponentSystem,zp as ComponentSystemRegistry,aC as ContactPoint,rC as ContactResult,Rg as ContainerHandler,Eg as ContainerResource,OP as ContextCreationError,Ub as Controller,Lg as CssHandler,Dg as CubemapHandler,it as Curve,nt as CurveSet,Ue as DETAILMODE_ADD,Ge as DETAILMODE_MAX,We as DETAILMODE_MIN,ze as DETAILMODE_MUL,Ne as DETAILMODE_OVERLAY,Ve as DETAILMODE_SCREEN,b_ as DISTANCE_EXPONENTIAL,x_ as DISTANCE_INVERSE,v_ as DISTANCE_LINEAR,X as Debug,n_ as DefaultAnimBinder,IP as ELEMENTTYPE_FLOAT32,sw as ELEMENTTYPE_GROUP,iw as ELEMENTTYPE_IMAGE,PP as ELEMENTTYPE_INT16,RP as ELEMENTTYPE_INT32,CP as ELEMENTTYPE_INT8,nw as ELEMENTTYPE_TEXT,EP as ELEMENTTYPE_UINT16,LP as ELEMENTTYPE_UINT32,AP as ELEMENTTYPE_UINT8,Te as EMITTERSHAPE_BOX,Me as EMITTERSHAPE_SPHERE,Jy as EVENT_KEYDOWN,tv as EVENT_KEYUP,ev as EVENT_MOUSEDOWN,sv as EVENT_MOUSEMOVE,iv as EVENT_MOUSEUP,nv as EVENT_MOUSEWHEEL,lv as EVENT_SELECT,dv as EVENT_SELECTEND,cv as EVENT_SELECTSTART,hv as EVENT_TOUCHCANCEL,rv as EVENT_TOUCHEND,ov as EVENT_TOUCHMOVE,av as EVENT_TOUCHSTART,XT as ElementComponent,KT as ElementComponentSystem,PC as ElementDragHelper,vS as ElementInput,fS as ElementInputEvent,_S as ElementMouseEvent,yS as ElementSelectEvent,gS as ElementTouchEvent,tm as Entity,JS as EntityReference,Lh as EnvLighting,_ as EventHandler,Hp as FILLMODE_FILL_WINDOW,Xp as FILLMODE_KEEP_ASPECT,Gp as FILLMODE_NONE,Zi as FILTER_LINEAR,en as FILTER_LINEAR_MIPMAP_LINEAR,tn as FILTER_LINEAR_MIPMAP_NEAREST,$i as FILTER_NEAREST,Ji as FILTER_NEAREST_MIPMAP_LINEAR,Qi as FILTER_NEAREST_MIPMAP_NEAREST,rw as FITMODE_CONTAIN,ow as FITMODE_COVER,aw as FITMODE_STRETCH,uM as FITTING_BOTH,lM as FITTING_NONE,dM as FITTING_SHRINK,cM as FITTING_STRETCH,zt as FOG_EXP,Ut as FOG_EXP2,Bt as FOG_LINEAR,kt as FOG_NONE,__ as FONT_BITMAP,f_ as FONT_MSDF,Vt as FRESNEL_NONE,Nt as FRESNEL_SCHLICK,cn as FUNC_ALWAYS,an as FUNC_EQUAL,on as FUNC_GREATER,ln as FUNC_GREATEREQUAL,nn as FUNC_LESS,rn as FUNC_LESSEQUAL,sn as FUNC_NEVER,hn as FUNC_NOTEQUAL,Og as FolderHandler,g_ as Font,kg as FontHandler,Yd as ForwardRenderer,ei as Frustum,He as GAMMA_NONE,Xe as GAMMA_SRGB,qe as GAMMA_SRGBFAST,je as GAMMA_SRGBHDR,SS as GamePads,qo as GraphNode,il as GraphicsDevice,Gg as HierarchyHandler,Hg as HtmlHandler,j as Http,Bp as I18n,un as INDEXFORMAT_UINT16,pn as INDEXFORMAT_UINT32,dn as INDEXFORMAT_UINT8,xf as INTERPOLATION_CUBIC,vf as INTERPOLATION_LINEAR,yf as INTERPOLATION_STEP,xT as ImageElement,ll as IndexBuffer,k as IndexedList,tM as JointComponent,nM as JointComponentSystem,Xg as JsonHandler,jg as JsonStandardMaterialParser,Ov as KEY_0,Fv as KEY_1,kv as KEY_2,Bv as KEY_3,zv as KEY_4,Uv as KEY_5,Vv as KEY_6,Nv as KEY_7,Wv as KEY_8,Gv as KEY_9,qv as KEY_A,Lx as KEY_ADD,yv as KEY_ALT,jv as KEY_B,uv as KEY_BACKSPACE,Qx as KEY_BACK_SLASH,Yv as KEY_C,xv as KEY_CAPS_LOCK,Jx as KEY_CLOSE_BRACKET,Yx as KEY_COMMA,vx as KEY_CONTEXT_MENU,gv as KEY_CONTROL,Kv as KEY_D,Ox as KEY_DECIMAL,Dv as KEY_DELETE,Fx as KEY_DIVIDE,Rv as KEY_DOWN,$v as KEY_E,Mv as KEY_END,fv as KEY_ENTER,Xv as KEY_EQUAL,bv as KEY_ESCAPE,Zv as KEY_F,kx as KEY_F1,Xx as KEY_F10,qx as KEY_F11,jx as KEY_F12,Bx as KEY_F2,zx as KEY_F3,Ux as KEY_F4,Vx as KEY_F5,Nx as KEY_F6,Wx as KEY_F7,Gx as KEY_F8,Hx as KEY_F9,Qv as KEY_G,Jv as KEY_H,Cv as KEY_HOME,tx as KEY_I,Iv as KEY_INSERT,ex as KEY_J,sx as KEY_K,ix as KEY_L,Av as KEY_LEFT,nx as KEY_M,tb as KEY_META,Rx as KEY_MULTIPLY,ax as KEY_N,xx as KEY_NUMPAD_0,bx as KEY_NUMPAD_1,Sx as KEY_NUMPAD_2,wx as KEY_NUMPAD_3,Tx as KEY_NUMPAD_4,Mx as KEY_NUMPAD_5,Cx as KEY_NUMPAD_6,Ax as KEY_NUMPAD_7,Px as KEY_NUMPAD_8,Ex as KEY_NUMPAD_9,rx as KEY_O,Zx as KEY_OPEN_BRACKET,ox as KEY_P,Tv as KEY_PAGE_DOWN,wv as KEY_PAGE_UP,vv as KEY_PAUSE,Kx as KEY_PERIOD,Lv as KEY_PRINT_SCREEN,hx as KEY_Q,lx as KEY_R,mv as KEY_RETURN,Ev as KEY_RIGHT,cx as KEY_S,Hv as KEY_SEMICOLON,Ix as KEY_SEPARATOR,_v as KEY_SHIFT,$x as KEY_SLASH,Sv as KEY_SPACE,Dx as KEY_SUBTRACT,dx as KEY_T,pv as KEY_TAB,ux as KEY_U,Pv as KEY_UP,px as KEY_V,mx as KEY_W,yx as KEY_WINDOWS,fx as KEY_X,_x as KEY_Y,gx as KEY_Z,pf as Key,Fb as Keyboard,Rb as KeyboardEvent,jt as LAYERID_DEPTH,Kt as LAYERID_IMMEDIATE,Yt as LAYERID_SKYBOX,$t as LAYERID_UI,qt as LAYERID_WORLD,Ht as LAYER_FX,Gt as LAYER_GIZMO,Wt as LAYER_HUD,Xt as LAYER_WORLD,re as LIGHTFALLOFF_INVERSESQUARED,ae as LIGHTFALLOFF_LINEAR,ie as LIGHTSHAPE_DISK,ee as LIGHTSHAPE_PUNCTUAL,se as LIGHTSHAPE_RECT,ne as LIGHTSHAPE_SPHERE,Zt as LIGHTTYPE_DIRECTIONAL,Qt as LIGHTTYPE_OMNI,Jt as LIGHTTYPE_POINT,te as LIGHTTYPE_SPOT,ys as LINEBATCH_GIZMO,gs as LINEBATCH_OVERLAY,_s as LINEBATCH_WORLD,nu as Layer,uu as LayerComposition,SM as LayoutCalculator,aM as LayoutChildComponent,hM as LayoutChildComponentSystem,MM as LayoutGroupComponent,PM as LayoutGroupComponentSystem,bu as Light,fA as LightComponent,vA as LightComponentSystem,Su as LightingParams,om as Lightmapper,zy as LocalizedAsset,Ts as MASK_AFFECT_DYNAMIC,Ms as MASK_AFFECT_LIGHTMAPPED,Cs as MASK_BAKE,$T as MOTION_FREE,ZT as MOTION_LIMITED,QT as MOTION_LOCKED,sb as MOUSEBUTTON_LEFT,ib as MOUSEBUTTON_MIDDLE,eb as MOUSEBUTTON_NONE,nb as MOUSEBUTTON_RIGHT,rt as Mat3,mt as Mat4,Fh as Material,$g as MaterialHandler,ec as Mesh,Ec as MeshInstance,Du as Model,EM as ModelComponent,IM as ModelComponentSystem,ny as ModelHandler,Lu as Morph,Iu as MorphInstance,hm as MorphTarget,zb as Mouse,Bb as MouseEvent,mf as Node,Qs as ORIENTATION_HORIZONTAL,Js as ORIENTATION_VERTICAL,oi as OrientedBox,ab as PAD_1,rb as PAD_2,ob as PAD_3,hb as PAD_4,Sb as PAD_DOWN,lb as PAD_FACE_1,cb as PAD_FACE_2,db as PAD_FACE_3,ub as PAD_FACE_4,wb as PAD_LEFT,pb as PAD_L_SHOULDER_1,fb as PAD_L_SHOULDER_2,vb as PAD_L_STICK_BUTTON,Cb as PAD_L_STICK_X,Ab as PAD_L_STICK_Y,Tb as PAD_RIGHT,mb as PAD_R_SHOULDER_1,_b as PAD_R_SHOULDER_2,xb as PAD_R_STICK_BUTTON,Pb as PAD_R_STICK_X,Eb as PAD_R_STICK_Y,gb as PAD_SELECT,yb as PAD_START,bb as PAD_UP,Mb as PAD_VENDOR,we as PARTICLEMODE_CPU,Se as PARTICLEMODE_GPU,Pe as PARTICLEORIENTATION_EMITTER,Ce as PARTICLEORIENTATION_SCREEN,Ae as PARTICLEORIENTATION_WORLD,ve as PARTICLESORT_DISTANCE,xe as PARTICLESORT_NEWER_FIRST,ye as PARTICLESORT_NONE,be as PARTICLESORT_OLDER_FIRST,In as PIXELFORMAT_111110F,mn as PIXELFORMAT_A8,Wn as PIXELFORMAT_ASTC_4x4,Gn as PIXELFORMAT_ATC_RGB,Hn as PIXELFORMAT_ATC_RGBA,Rn as PIXELFORMAT_DEPTH,Ln as PIXELFORMAT_DEPTHSTENCIL,Sn as PIXELFORMAT_DXT1,wn as PIXELFORMAT_DXT3,Tn as PIXELFORMAT_DXT5,Fn as PIXELFORMAT_ETC1,kn as PIXELFORMAT_ETC2_RGB,Bn as PIXELFORMAT_ETC2_RGBA,fn as PIXELFORMAT_L8,_n as PIXELFORMAT_L8_A8,Un as PIXELFORMAT_PVRTC_2BPP_RGBA_1,zn as PIXELFORMAT_PVRTC_2BPP_RGB_1,Nn as PIXELFORMAT_PVRTC_4BPP_RGBA_1,Vn as PIXELFORMAT_PVRTC_4BPP_RGB_1,En as PIXELFORMAT_R32F,vn as PIXELFORMAT_R4_G4_B4_A4,yn as PIXELFORMAT_R5_G5_B5_A1,gn as PIXELFORMAT_R5_G6_B5,xn as PIXELFORMAT_R8_G8_B8,bn as PIXELFORMAT_R8_G8_B8_A8,Mn as PIXELFORMAT_RGB16F,An as PIXELFORMAT_RGB32F,Cn as PIXELFORMAT_RGBA16F,Pn as PIXELFORMAT_RGBA32F,Dn as PIXELFORMAT_SRGB,On as PIXELFORMAT_SRGBA,jn as PRIMITIVE_LINELOOP,qn as PRIMITIVE_LINES,Yn as PRIMITIVE_LINESTRIP,Xn as PRIMITIVE_POINTS,Kn as PRIMITIVE_TRIANGLES,Zn as PRIMITIVE_TRIFAN,$n as PRIMITIVE_TRISTRIP,Re as PROJECTION_ORTHOGRAPHIC,Ee as PROJECTION_PERSPECTIVE,sf as ParticleEmitter,zM as ParticleSystemComponent,NM as ParticleSystemComponentSystem,zP as PhongMaterial,rf as Picker,li as Plane,Ml as PostEffect,oA as PostEffectQueue,sl as ProgramLibrary,ft as Quat,De as RENDERSTYLE_POINTS,Le as RENDERSTYLE_SOLID,Ie as RENDERSTYLE_WIREFRAME,qp as RESOLUTION_AUTO,jp as RESOLUTION_FIXED,ZP as RIGIDBODY_ACTIVE_TAG,KP as RIGIDBODY_CF_KINEMATIC_OBJECT,$P as RIGIDBODY_CF_NORESPONSE_OBJECT,YP as RIGIDBODY_CF_STATIC_OBJECT,tE as RIGIDBODY_DISABLE_DEACTIVATION,eE as RIGIDBODY_DISABLE_SIMULATION,QP as RIGIDBODY_ISLAND_SLEEPING,qP as RIGIDBODY_TYPE_DYNAMIC,jP as RIGIDBODY_TYPE_KINEMATIC,XP as RIGIDBODY_TYPE_STATIC,JP as RIGIDBODY_WANTS_DEACTIVATION,si as Ray,iC as RaycastResult,B as ReadStream,WM as RenderComponent,qM as RenderComponentSystem,hy as RenderHandler,al as RenderTarget,ly as ResourceHandler,qu as ResourceLoader,eC as RigidBodyComponent,hC as RigidBodyComponentSystem,cC as SCALEMODE_BLEND,lC as SCALEMODE_NONE,IC as SCROLLBAR_VISIBILITY_SHOW_ALWAYS,DC as SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED,RC as SCROLL_MODE_BOUNCE,EC as SCROLL_MODE_CLAMP,LC as SCROLL_MODE_INFINITE,pa as SEMANTIC_ATTR,ma as SEMANTIC_ATTR0,fa as SEMANTIC_ATTR1,Ta as SEMANTIC_ATTR10,Ma as SEMANTIC_ATTR11,Ca as SEMANTIC_ATTR12,Aa as SEMANTIC_ATTR13,Pa as SEMANTIC_ATTR14,Ea as SEMANTIC_ATTR15,_a as SEMANTIC_ATTR2,ga as SEMANTIC_ATTR3,ya as SEMANTIC_ATTR4,va as SEMANTIC_ATTR5,xa as SEMANTIC_ATTR6,ba as SEMANTIC_ATTR7,Sa as SEMANTIC_ATTR8,wa as SEMANTIC_ATTR9,sa as SEMANTIC_BLENDINDICES,ea as SEMANTIC_BLENDWEIGHT,ia as SEMANTIC_COLOR,Jn as SEMANTIC_NORMAL,Qn as SEMANTIC_POSITION,ta as SEMANTIC_TANGENT,na as SEMANTIC_TEXCOORD,aa as SEMANTIC_TEXCOORD0,ra as SEMANTIC_TEXCOORD1,oa as SEMANTIC_TEXCOORD2,ha as SEMANTIC_TEXCOORD3,la as SEMANTIC_TEXCOORD4,ca as SEMANTIC_TEXCOORD5,da as SEMANTIC_TEXCOORD6,ua as SEMANTIC_TEXCOORD7,ls as SHADERDEF_DIRLM,os as SHADERDEF_INSTANCING,hs as SHADERDEF_LM,fs as SHADERDEF_LMAMBIENT,ps as SHADERDEF_MORPH_NORMAL,us as SHADERDEF_MORPH_POSITION,ms as SHADERDEF_MORPH_TEXTURE_BASED,ss as SHADERDEF_NOSHADOW,cs as SHADERDEF_SCREENSPACE,is as SHADERDEF_SKIN,ds as SHADERDEF_TANGENTS,ns as SHADERDEF_UV0,as as SHADERDEF_UV1,rs as SHADERDEF_VCOLOR,Ir as SHADERSTAGE_COMPUTE,Lr as SHADERSTAGE_FRAGMENT,Rr as SHADERSTAGE_VERTEX,Ra as SHADERTAG_MATERIAL,Es as SHADER_DEPTH,As as SHADER_FORWARD,Ps as SHADER_FORWARDHDR,Ls as SHADER_PICK,Rs as SHADER_SHADOW,vs as SHADOWUPDATE_NONE,bs as SHADOWUPDATE_REALTIME,xs as SHADOWUPDATE_THISFRAME,me as SHADOW_COUNT,he as SHADOW_DEPTH,pe as SHADOW_PCF1,oe as SHADOW_PCF3,ue as SHADOW_PCF5,ce as SHADOW_VSM16,de as SHADOW_VSM32,le as SHADOW_VSM8,ws as SORTKEY_DEPTH,Ss as SORTKEY_FORWARD,Gs as SORTMODE_BACK2FRONT,Xs as SORTMODE_CUSTOM,Hs as SORTMODE_FRONT2BACK,Ns as SORTMODE_MANUAL,Ws as SORTMODE_MATERIALMESH,Vs as SORTMODE_NONE,ts as SPECOCC_AO,es as SPECOCC_GLOSSDEPENDENT,Je as SPECOCC_NONE,Be as SPECULAR_BLINN,ke as SPECULAR_PHONG,$C as SPRITETYPE_ANIMATED,KC as SPRITETYPE_SIMPLE,Is as SPRITE_RENDERMODE_SIMPLE,Ds as SPRITE_RENDERMODE_SLICED,Os as SPRITE_RENDERMODE_TILED,ka as STENCILOP_DECREMENT,Ba as STENCILOP_DECREMENTWRAP,Oa as STENCILOP_INCREMENT,Fa as STENCILOP_INCREMENTWRAP,za as STENCILOP_INVERT,La as STENCILOP_KEEP,Da as STENCILOP_REPLACE,Ia as STENCILOP_ZERO,Uu as Scene,cy as SceneHandler,Np as SceneRegistry,Vp as SceneRegistryItem,dy as SceneSettingsHandler,fo as ScopeId,_o as ScopeSpace,uC as ScreenComponent,fC as ScreenComponentSystem,Rp as ScriptAttributes,Ip as ScriptComponent,SA as ScriptComponentSystem,bp as ScriptHandler,_C as ScriptLegacyComponent,vC as ScriptLegacyComponentSystem,Fp as ScriptRegistry,Op as ScriptType,FC as ScrollViewComponent,zC as ScrollViewComponentSystem,UC as ScrollbarComponent,WC as ScrollbarComponentSystem,$r as Shader,uy as ShaderHandler,nC as SingleContactResult,gf as Skeleton,of as Skin,bc as SkinBatchInstance,xc as SkinInstance,z as SortedLoopArray,P_ as Sound,XC as SoundComponent,YC as SoundComponentSystem,R_ as SoundInstance,L_ as SoundInstance3d,A_ as SoundManager,HC as SoundSlot,cf as Sprite,ZC as SpriteAnimationClip,QC as SpriteComponent,eA as SpriteComponentSystem,fy as SpriteHandler,Xh as StandardMaterial,df as StencilParameters,ja as TEXHINT_ASSET,Ya as TEXHINT_LIGHTMAP,Xa as TEXHINT_NONE,qa as TEXHINT_SHADOWMAP,Ua as TEXTURELOCK_READ,Va as TEXTURELOCK_WRITE,$a as TEXTUREPROJECTION_CUBE,Za as TEXTUREPROJECTION_EQUIRECT,Ka as TEXTUREPROJECTION_NONE,Qa as TEXTUREPROJECTION_OCTAHEDRAL,Na as TEXTURETYPE_DEFAULT,Ga as TEXTURETYPE_RGBE,Wa as TEXTURETYPE_RGBM,Ha as TEXTURETYPE_SWIZZLEGGGR,Ze as TONEMAP_ACES,Qe as TONEMAP_ACES2,Ke as TONEMAP_FILMIC,$e as TONEMAP_HEJL,Ye as TONEMAP_LINEAR,ar as TYPE_FLOAT32,er as TYPE_INT16,ir as TYPE_INT32,Ja as TYPE_INT8,sr as TYPE_UINT16,nr as TYPE_UINT32,tr as TYPE_UINT8,U as Tags,_y as Template,gy as TemplateHandler,kT as TextElement,yy as TextHandler,Mo as Texture,uf as TextureAtlas,ky as TextureAtlasHandler,Iy as TextureHandler,Ly as TextureParser,N as Timer,TS as Touch,CS as TouchDevice,MS as TouchEvent,Pl as TransformFeedback,rr as UNIFORMTYPE_BOOL,fr as UNIFORMTYPE_BVEC2,_r as UNIFORMTYPE_BVEC3,gr as UNIFORMTYPE_BVEC4,hr as UNIFORMTYPE_FLOAT,wr as UNIFORMTYPE_FLOATARRAY,or as UNIFORMTYPE_INT,ur as UNIFORMTYPE_IVEC2,pr as UNIFORMTYPE_IVEC3,mr as UNIFORMTYPE_IVEC4,yr as UNIFORMTYPE_MAT2,vr as UNIFORMTYPE_MAT3,xr as UNIFORMTYPE_MAT4,br as UNIFORMTYPE_TEXTURE2D,Tr as UNIFORMTYPE_TEXTURE2D_SHADOW,Cr as UNIFORMTYPE_TEXTURE3D,Sr as UNIFORMTYPE_TEXTURECUBE,Mr as UNIFORMTYPE_TEXTURECUBE_SHADOW,lr as UNIFORMTYPE_VEC2,Ar as UNIFORMTYPE_VEC2ARRAY,cr as UNIFORMTYPE_VEC3,Pr as UNIFORMTYPE_VEC3ARRAY,dr as UNIFORMTYPE_VEC4,Er as UNIFORMTYPE_VEC4ARRAY,H as URI,DP as UnsupportedBrowserError,Bs as VIEW_CENTER,zs as VIEW_LEFT,Us as VIEW_RIGHT,ot as Vec2,at as Vec3,ht as Vec4,Wr as VertexBuffer,Hr as VertexFormat,wl as VertexIterator,jl as WebglGraphicsDevice,Xc as WorldClusters,GA as XRDEPTHSENSINGFORMAT_F32,WA as XRDEPTHSENSINGFORMAT_L8A8,VA as XRDEPTHSENSINGUSAGE_CPU,NA as XRDEPTHSENSINGUSAGE_GPU,FA as XRHAND_LEFT,OA as XRHAND_NONE,kA as XRHAND_RIGHT,EA as XRSPACE_BOUNDEDFLOOR,AA as XRSPACE_LOCAL,PA as XRSPACE_LOCALFLOOR,RA as XRSPACE_UNBOUNDED,CA as XRSPACE_VIEWER,LA as XRTARGETRAY_GAZE,DA as XRTARGETRAY_POINTER,IA as XRTARGETRAY_SCREEN,UA as XRTRACKABLE_MESH,zA as XRTRACKABLE_PLANE,BA as XRTRACKABLE_POINT,MA as XRTYPE_AR,wA as XRTYPE_INLINE,TA as XRTYPE_VR,fP as XrDepthSensing,mP as XrDomOverlay,jA as XrHitTest,qA as XrHitTestSource,pP as XrImageTracking,rP as XrInput,aP as XrInputSource,dP as XrLightEstimation,vP as XrManager,gP as XrPlane,yP as XrPlaneDetection,uP as XrTrackedImage,sA as ZoneComponent,aA as ZoneComponentSystem,NP as anim,Kp as app,c as apps,GP as asset,WP as audio,V_ as basisInitialize,iE as basisSetDownloadConfig,W_ as basisTranscode,ic as calculateNormals,nc as calculateTangents,l as common,h as config,mc as createBox,lc as createCapsule,cc as createCone,hc as createCylinder,ac as createMesh,uc as createPlane,Vy as createScript,lo as createShader,co as createShaderFromCode,dc as createSphere,Ig as createStyle,rc as createTorus,W as createURI,d as data,Al as drawFullscreenQuad,Yr as drawQuadWithShader,Kr as drawTexture,g as events,m as extend,sE as fw,wS as getTouchTargetCoords,FP as gfx,y as guid,Y as http,wP as inherits,HP as input,f as isDefined,bP as log,TP as makeArray,q as math,V as now,v as path,L as platform,kP as posteffect,nE as prefilterCubemap,oh as programlib,Wy as registerScript,Eh as reprojectTexture,o as revision,UP as scene,Tp as script,Vr as semanticToLocation,hl as shFromCubemap,Zr as shaderChunks,fe as shadowTypeToString,MP as shape,F as string,SP as time,p as type,zr as typedArrayIndexFormats,Ur as typedArrayIndexFormatsByteSize,Br as typedArrayToType,Fr as typedArrayTypes,kr as typedArrayTypesByteSize,r as version};
